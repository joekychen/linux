<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6655 › device_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>device_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * File: device_main.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: driver entry for initial, open, close, tx and rx.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Lyndon Chen</span>
<span class="cm"> *</span>
<span class="cm"> * Date: Jan 8, 2003</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *</span>
<span class="cm"> *   vt6655_probe - module initial (insmod) driver entry</span>
<span class="cm"> *   vt6655_remove - module remove entry</span>
<span class="cm"> *   vt6655_init_info - device structure resource allocation function</span>
<span class="cm"> *   device_free_info - device structure resource free function</span>
<span class="cm"> *   device_get_pci_info - get allocated pci io/mem resource</span>
<span class="cm"> *   device_print_info - print out resource</span>
<span class="cm"> *   device_open - allocate dma/descripter resource &amp; initial mac/bbp function</span>
<span class="cm"> *   device_xmit - asynchrous data tx function</span>
<span class="cm"> *   device_intr - interrupt handle function</span>
<span class="cm"> *   device_set_multi - set mac filter</span>
<span class="cm"> *   device_ioctl - ioctl entry</span>
<span class="cm"> *   device_close - shutdown mac/bbp &amp; free dma/descripter resource</span>
<span class="cm"> *   device_rx_srv - rx service function</span>
<span class="cm"> *   device_receive_frame - rx data function</span>
<span class="cm"> *   device_alloc_rx_buf - rx buffer pre-allocated function</span>
<span class="cm"> *   device_alloc_frag_buf - rx fragement pre-allocated function</span>
<span class="cm"> *   device_free_tx_buf - free tx buffer function</span>
<span class="cm"> *   device_free_frag_buf- free de-fragement buffer</span>
<span class="cm"> *   device_dma0_tx_80211- tx 802.11 frame via dma0</span>
<span class="cm"> *   device_dma0_xmit- tx PS bufferred frame via dma0</span>
<span class="cm"> *   device_init_rd0_ring- initial rd dma0 ring</span>
<span class="cm"> *   device_init_rd1_ring- initial rd dma1 ring</span>
<span class="cm"> *   device_init_td0_ring- initial tx dma0 ring buffer</span>
<span class="cm"> *   device_init_td1_ring- initial tx dma1 ring buffer</span>
<span class="cm"> *   device_init_registers- initial MAC &amp; BBP &amp; RF internal registers.</span>
<span class="cm"> *   device_init_rings- initial tx/rx ring buffer</span>
<span class="cm"> *   device_init_defrag_cb- initial &amp; allocate de-fragement buffer.</span>
<span class="cm"> *   device_free_rings- free all allocated ring buffer</span>
<span class="cm"> *   device_tx_srv- tx interrupt service function</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> */</span>
<span class="cp">#undef __NO_VERSION__</span>

<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;card.h&quot;</span>
<span class="cp">#include &quot;channel.h&quot;</span>
<span class="cp">#include &quot;baseband.h&quot;</span>
<span class="cp">#include &quot;mac.h&quot;</span>
<span class="cp">#include &quot;tether.h&quot;</span>
<span class="cp">#include &quot;wmgr.h&quot;</span>
<span class="cp">#include &quot;wctl.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>
<span class="cp">#include &quot;wcmd.h&quot;</span>
<span class="cp">#include &quot;iocmd.h&quot;</span>
<span class="cp">#include &quot;tcrc.h&quot;</span>
<span class="cp">#include &quot;rxtx.h&quot;</span>
<span class="cp">#include &quot;wroute.h&quot;</span>
<span class="cp">#include &quot;bssdb.h&quot;</span>
<span class="cp">#include &quot;hostap.h&quot;</span>
<span class="cp">#include &quot;wpactl.h&quot;</span>
<span class="cp">#include &quot;ioctl.h&quot;</span>
<span class="cp">#include &quot;iwctl.h&quot;</span>
<span class="cp">#include &quot;dpc.h&quot;</span>
<span class="cp">#include &quot;datarate.h&quot;</span>
<span class="cp">#include &quot;rf.h&quot;</span>
<span class="cp">#include &quot;iowpa.h&quot;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define    DEBUG</h1></td><td class="code"><div class="highlight"><pre><span class="cm">/*---------------------  Static Definitions -------------------------*/</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>static int          msglevel                =MSG<em>LEVEL</em>DEBUG;</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span>   <span class="n">MSG_LEVEL_INFO</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><h1>define    PLICE_DEBUG</h1>

<p>Define module options</p></td><td class="code"><div class="highlight"><pre><span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;VIA Networking Technologies, Inc., &lt;lyndonchen@vntek.com.tw&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;VIA Networking Solomon-A/B/G Wireless LAN Adapter Driver&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>PLICE_DEBUG -></p></td><td class="code"><div class="highlight"><pre>	<span class="k">static</span> <span class="kt">int</span> <span class="n">mlme_kill</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>static  struct task<em>struct * mlme</em>task;
PLICE_DEBUG &lt;-</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define DEVICE_PARAM(N,D)</span>
<span class="cm">/*</span>
<span class="cm">        static const int N[MAX_UINTS]=OPTION_DEFAULT;\</span>
<span class="cm">        MODULE_PARM(N, &quot;1-&quot; __MODULE_STRING(MAX_UINTS) &quot;i&quot;);\</span>
<span class="cm">        MODULE_PARM_DESC(N, D);</span>
<span class="cm">*/</span>

<span class="cp">#define RX_DESC_MIN0     16</span>
<span class="cp">#define RX_DESC_MAX0     128</span>
<span class="cp">#define RX_DESC_DEF0     32</span>
<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">RxDescriptors0</span><span class="p">,</span><span class="s">&quot;Number of receive descriptors0&quot;</span><span class="p">);</span>

<span class="cp">#define RX_DESC_MIN1     16</span>
<span class="cp">#define RX_DESC_MAX1     128</span>
<span class="cp">#define RX_DESC_DEF1     32</span>
<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">RxDescriptors1</span><span class="p">,</span><span class="s">&quot;Number of receive descriptors1&quot;</span><span class="p">);</span>

<span class="cp">#define TX_DESC_MIN0     16</span>
<span class="cp">#define TX_DESC_MAX0     128</span>
<span class="cp">#define TX_DESC_DEF0     32</span>
<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">TxDescriptors0</span><span class="p">,</span><span class="s">&quot;Number of transmit descriptors0&quot;</span><span class="p">);</span>

<span class="cp">#define TX_DESC_MIN1     16</span>
<span class="cp">#define TX_DESC_MAX1     128</span>
<span class="cp">#define TX_DESC_DEF1     64</span>
<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">TxDescriptors1</span><span class="p">,</span><span class="s">&quot;Number of transmit descriptors1&quot;</span><span class="p">);</span>


<span class="cp">#define IP_ALIG_DEF     0</span>
<span class="cm">/* IP_byte_align[] is used for IP header unsigned long byte aligned</span>
<span class="cm">   0: indicate the IP header won&#39;t be unsigned long byte aligned.(Default) .</span>
<span class="cm">   1: indicate the IP header will be unsigned long byte aligned.</span>
<span class="cm">      In some environment, the IP header should be unsigned long byte aligned,</span>
<span class="cm">      or the packet will be droped when we receive it. (eg: IPVS)</span>
<span class="cm">*/</span>
<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">IP_byte_align</span><span class="p">,</span><span class="s">&quot;Enable IP header dword aligned&quot;</span><span class="p">);</span>


<span class="cp">#define INT_WORKS_DEF   20</span>
<span class="cp">#define INT_WORKS_MIN   10</span>
<span class="cp">#define INT_WORKS_MAX   64</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">int_works</span><span class="p">,</span><span class="s">&quot;Number of packets per interrupt services&quot;</span><span class="p">);</span>

<span class="cp">#define CHANNEL_MIN     1</span>
<span class="cp">#define CHANNEL_MAX     14</span>
<span class="cp">#define CHANNEL_DEF     6</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">Channel</span><span class="p">,</span> <span class="s">&quot;Channel number&quot;</span><span class="p">);</span>


<span class="cm">/* PreambleType[] is the preamble length used for transmit.</span>
<span class="cm">   0: indicate allows long preamble type</span>
<span class="cm">   1: indicate allows short preamble type</span>
<span class="cm">*/</span>

<span class="cp">#define PREAMBLE_TYPE_DEF     1</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">PreambleType</span><span class="p">,</span> <span class="s">&quot;Preamble Type&quot;</span><span class="p">);</span>


<span class="cp">#define RTS_THRESH_MIN     512</span>
<span class="cp">#define RTS_THRESH_MAX     2347</span>
<span class="cp">#define RTS_THRESH_DEF     2347</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">RTSThreshold</span><span class="p">,</span> <span class="s">&quot;RTS threshold&quot;</span><span class="p">);</span>


<span class="cp">#define FRAG_THRESH_MIN     256</span>
<span class="cp">#define FRAG_THRESH_MAX     2346</span>
<span class="cp">#define FRAG_THRESH_DEF     2346</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">FragThreshold</span><span class="p">,</span> <span class="s">&quot;Fragmentation threshold&quot;</span><span class="p">);</span>


<span class="cp">#define DATA_RATE_MIN     0</span>
<span class="cp">#define DATA_RATE_MAX     13</span>
<span class="cp">#define DATA_RATE_DEF     13</span>
<span class="cm">/* datarate[] index</span>
<span class="cm">   0: indicate 1 Mbps   0x02</span>
<span class="cm">   1: indicate 2 Mbps   0x04</span>
<span class="cm">   2: indicate 5.5 Mbps 0x0B</span>
<span class="cm">   3: indicate 11 Mbps  0x16</span>
<span class="cm">   4: indicate 6 Mbps   0x0c</span>
<span class="cm">   5: indicate 9 Mbps   0x12</span>
<span class="cm">   6: indicate 12 Mbps  0x18</span>
<span class="cm">   7: indicate 18 Mbps  0x24</span>
<span class="cm">   8: indicate 24 Mbps  0x30</span>
<span class="cm">   9: indicate 36 Mbps  0x48</span>
<span class="cm">  10: indicate 48 Mbps  0x60</span>
<span class="cm">  11: indicate 54 Mbps  0x6c</span>
<span class="cm">  12: indicate 72 Mbps  0x90</span>
<span class="cm">  13: indicate auto rate</span>
<span class="cm">*/</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">ConnectionRate</span><span class="p">,</span> <span class="s">&quot;Connection data rate&quot;</span><span class="p">);</span>

<span class="cp">#define OP_MODE_DEF     0</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">OPMode</span><span class="p">,</span> <span class="s">&quot;Infrastruct, adhoc, AP mode &quot;</span><span class="p">);</span>

<span class="cm">/* OpMode[] is used for transmit.</span>
<span class="cm">   0: indicate infrastruct mode used</span>
<span class="cm">   1: indicate adhoc mode used</span>
<span class="cm">   2: indicate AP mode used</span>
<span class="cm">*/</span>


<span class="cm">/* PSMode[]</span>
<span class="cm">   0: indicate disable power saving mode</span>
<span class="cm">   1: indicate enable power saving mode</span>
<span class="cm">*/</span>

<span class="cp">#define PS_MODE_DEF     0</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">PSMode</span><span class="p">,</span> <span class="s">&quot;Power saving mode&quot;</span><span class="p">);</span>


<span class="cp">#define SHORT_RETRY_MIN     0</span>
<span class="cp">#define SHORT_RETRY_MAX     31</span>
<span class="cp">#define SHORT_RETRY_DEF     8</span>


<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">ShortRetryLimit</span><span class="p">,</span> <span class="s">&quot;Short frame retry limits&quot;</span><span class="p">);</span>

<span class="cp">#define LONG_RETRY_MIN     0</span>
<span class="cp">#define LONG_RETRY_MAX     15</span>
<span class="cp">#define LONG_RETRY_DEF     4</span>


<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">LongRetryLimit</span><span class="p">,</span> <span class="s">&quot;long frame retry limits&quot;</span><span class="p">);</span>


<span class="cm">/* BasebandType[] baseband type selected</span>
<span class="cm">   0: indicate 802.11a type</span>
<span class="cm">   1: indicate 802.11b type</span>
<span class="cm">   2: indicate 802.11g type</span>
<span class="cm">*/</span>
<span class="cp">#define BBP_TYPE_MIN     0</span>
<span class="cp">#define BBP_TYPE_MAX     2</span>
<span class="cp">#define BBP_TYPE_DEF     2</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">BasebandType</span><span class="p">,</span> <span class="s">&quot;baseband type&quot;</span><span class="p">);</span>



<span class="cm">/* 80211hEnable[]</span>
<span class="cm">   0: indicate disable 802.11h</span>
<span class="cm">   1: indicate enable 802.11h</span>
<span class="cm">*/</span>

<span class="cp">#define X80211h_MODE_DEF     0</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">b80211hEnable</span><span class="p">,</span> <span class="s">&quot;802.11h mode&quot;</span><span class="p">);</span>

<span class="cm">/* 80211hEnable[]</span>
<span class="cm">   0: indicate disable 802.11h</span>
<span class="cm">   1: indicate enable 802.11h</span>
<span class="cm">*/</span>

<span class="cp">#define DIVERSITY_ANT_DEF     0</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">bDiversityANTEnable</span><span class="p">,</span> <span class="s">&quot;ANT diversity mode&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Static vars definitions</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>          <span class="n">device_nics</span>             <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">PSDevice</span>     <span class="n">pDevice_Infos</span>           <span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">root_device_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="n">CHIP_INFO</span> <span class="n">chip_info_table</span><span class="p">[]</span><span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">VT3253</span><span class="p">,</span>       <span class="s">&quot;VIA Networking Solomon-A/B/G Wireless LAN Adapter &quot;</span><span class="p">,</span>
        <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="n">DEVICE_FLAGS_IP_ALIGN</span><span class="o">|</span><span class="n">DEVICE_FLAGS_TX_ALIGN</span> <span class="p">},</span>
    <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">vt6655_pci_id_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x3253</span><span class="p">),</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="n">chip_info_table</span><span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*---------------------  Static Functions  --------------------------*/</span>


<span class="k">static</span> <span class="kt">int</span>  <span class="n">vt6655_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcid</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">vt6655_init_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">pcid</span><span class="p">,</span> <span class="n">PSDevice</span><span class="o">*</span> <span class="n">ppDevice</span><span class="p">,</span> <span class="n">PCHIP_INFO</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_info</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">device_get_pci_info</span><span class="p">(</span><span class="n">PSDevice</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">pcid</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_print_info</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">device_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init_diversity_timer</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span>  <span class="n">irqreturn_t</span>  <span class="n">device_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>  <span class="kt">void</span><span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">device_notify_reboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">viawget_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcid</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">viawget_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcid</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">device_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">device_notify_reboot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init_rd0_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init_rd1_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init_defrag_cb</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init_td0_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init_td1_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_dma0_tx_80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>2008-0714<Add>by Mike Liu</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">bool</span> <span class="n">device_release_WPADEV</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">ethtool_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">useraddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_rx_srv</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uIdx</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_tx_srv</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uIdx</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">device_alloc_rx_buf</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">PSRxDesc</span> <span class="n">pDesc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init_registers</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">DEVICE_INIT_TYPE</span> <span class="n">InitType</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_tx_buf</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">PSTxDesc</span> <span class="n">pDesc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_td0_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_td1_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_rd0_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_rd1_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_rings</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_frag_buf</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">Config_FileGetParameter</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">source</span><span class="p">);</span>


<span class="cm">/*---------------------  Export Variables  --------------------------*/</span>

<span class="cm">/*---------------------  Export Functions  --------------------------*/</span>



<span class="k">static</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">get_chip_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">chip_info_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chip_info_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chip_id</span><span class="o">==</span><span class="n">chip_id</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">chip_info_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">vt6655_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcid</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="o">=</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pcid</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="n">device_free_info</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">static void</span>
<span class="cm">device_set_int_opt(int *opt, int val, int min, int max, int def,char* name,char* devname) {</span>
<span class="cm">    if (val==-1)</span>
<span class="cm">        *opt=def;</span>
<span class="cm">    else if (val&lt;min || val&gt;max) {</span>
<span class="cm">        DBG_PRT(MSG_LEVEL_INFO, KERN_NOTICE &quot;%s: the value of parameter %s is invalid, the valid range is (%d-%d)\n&quot; ,</span>
<span class="cm">            devname,name, min,max);</span>
<span class="cm">        *opt=def;</span>
<span class="cm">    } else {</span>
<span class="cm">        DBG_PRT(MSG_LEVEL_INFO, KERN_INFO &quot;%s: set value of parameter %s to %d\n&quot;,</span>
<span class="cm">            devname, name, val);</span>
<span class="cm">        *opt=val;</span>
<span class="cm">    }</span>
<span class="cm">}</span>

<span class="cm">static void</span>
<span class="cm">device_set_bool_opt(unsigned int *opt, int val,bool def,u32 flag, char* name,char* devname) {</span>
<span class="cm">    (*opt)&amp;=(~flag);</span>
<span class="cm">    if (val==-1)</span>
<span class="cm">        *opt|=(def ? flag : 0);</span>
<span class="cm">    else if (val&lt;0 || val&gt;1) {</span>
<span class="cm">        DBG_PRT(MSG_LEVEL_INFO, KERN_NOTICE</span>
<span class="cm">            &quot;%s: the value of parameter %s is invalid, the valid range is (0-1)\n&quot;,devname,name);</span>
<span class="cm">        *opt|=(def ? flag : 0);</span>
<span class="cm">    } else {</span>
<span class="cm">        DBG_PRT(MSG_LEVEL_INFO, KERN_NOTICE &quot;%s: set parameter %s to %s\n&quot;,</span>
<span class="cm">            devname,name , val ? &quot;true&quot; : &quot;false&quot;);</span>
<span class="cm">        *opt|=(val ? flag : 0);</span>
<span class="cm">    }</span>
<span class="cm">}</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">device_get_options</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">devname</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">POPTIONS</span> <span class="n">pOpts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">);</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">nRxDescs0</span><span class="o">=</span><span class="n">RX_DESC_DEF0</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">nRxDescs1</span><span class="o">=</span><span class="n">RX_DESC_DEF1</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">TX_DESC_DEF0</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">TX_DESC_DEF1</span><span class="p">;</span>
<span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">|=</span><span class="n">DEVICE_FLAGS_IP_ALIGN</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">int_works</span><span class="o">=</span><span class="n">INT_WORKS_DEF</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">rts_thresh</span><span class="o">=</span><span class="n">RTS_THRESH_DEF</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">frag_thresh</span><span class="o">=</span><span class="n">FRAG_THRESH_DEF</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="o">=</span><span class="n">DATA_RATE_DEF</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">channel_num</span><span class="o">=</span><span class="n">CHANNEL_DEF</span><span class="p">;</span>

<span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">|=</span><span class="n">DEVICE_FLAGS_PREAMBLE_TYPE</span><span class="p">;</span>
<span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">|=</span><span class="n">DEVICE_FLAGS_OP_MODE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>pOpts->flags|=DEVICE<em>FLAGS</em>PS_MODE;</p></td><td class="code"><div class="highlight"><pre>  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">short_retry</span><span class="o">=</span><span class="n">SHORT_RETRY_DEF</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">long_retry</span><span class="o">=</span><span class="n">LONG_RETRY_DEF</span><span class="p">;</span>
  <span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">bbp_type</span><span class="o">=</span><span class="n">BBP_TYPE_DEF</span><span class="p">;</span>
<span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">|=</span><span class="n">DEVICE_FLAGS_80211h_MODE</span><span class="p">;</span>
<span class="n">pOpts</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">|=</span><span class="n">DEVICE_FLAGS_DiversityANT</span><span class="p">;</span>


<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">device_set_options</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyBroadcastAddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abySNAP_RFC1042</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abySNAP_Bridgetunnel</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">};</span>


    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abySNAP_RFC1042</span><span class="p">,</span> <span class="n">abySNAP_RFC1042</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abySNAP_Bridgetunnel</span><span class="p">,</span> <span class="n">abySNAP_Bridgetunnel</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uChannel</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">channel_num</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wRTSThreshold</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">rts_thresh</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wFragmentationThreshold</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">frag_thresh</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortRetryLimit</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">short_retry</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLongRetryLimit</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">long_retry</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wMaxTransmitMSDULifetime</span> <span class="o">=</span> <span class="n">DEFAULT_MSDU_LIFETIME</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortPreamble</span> <span class="o">=</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_PREAMBLE_TYPE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOpMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OP_MODE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ePSMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_PS_MODE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">b11hEnable</span> <span class="o">=</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_80211h_MODE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityRegCtlON</span> <span class="o">=</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_DiversityANT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">data_rate</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&lt;</span> <span class="n">RATE_AUTO</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">bbp_type</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPacketType</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>PLICE_DEBUG-></p></td><td class="code"><div class="highlight"><pre>	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAutoFBCtrl</span> <span class="o">=</span> <span class="n">AUTO_FB_0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>pDevice->byAutoFBCtrl = AUTO<em>FB</em>1;
PLICE_DEBUG&lt;-</p></td><td class="code"><div class="highlight"><pre><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bUpdateBBVGA</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byFOETuning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCTSDuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; uChannel= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; byOpMode= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOpMode</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; ePSMode= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ePSMode</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; wRTSThreshold= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wRTSThreshold</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; byShortRetryLimit= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortRetryLimit</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; byLongRetryLimit= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLongRetryLimit</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; byPreambleType= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; byShortPreamble= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortPreamble</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; uConnectionRate= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; byBBType= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; pDevice-&gt;b11hEnable= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">b11hEnable</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; pDevice-&gt;bDiversityRegCtlON= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityRegCtlON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s_vCompleteCurrentMeasure</span> <span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byResult</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwDuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byRPI0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwRPIs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">255</span><span class="p">;</span>
        <span class="n">dwDuration</span> <span class="o">|=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pCurrMeasureEID</span><span class="o">-&gt;</span><span class="n">sReq</span><span class="p">.</span><span class="n">abyDuration</span><span class="p">));</span>
        <span class="n">dwDuration</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwRPIs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">/=</span> <span class="n">dwDuration</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyRPIs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwRPIs</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
        <span class="n">byRPI0</span> <span class="o">+=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyRPIs</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyRPIs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="n">byRPI0</span><span class="p">);</span>

     <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uNumOfMeasureEIDs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNTWIFIbMeasureReport</span><span class="p">(</span>  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span>
                                <span class="nb">true</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pCurrMeasureEID</span><span class="p">,</span>
                                <span class="n">byResult</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBasicMap</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCCAFraction</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyRPIs</span>
                                <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">VNTWIFIbMeasureReport</span><span class="p">(</span>  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span>
                                <span class="nb">false</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pCurrMeasureEID</span><span class="p">,</span>
                                <span class="n">byResult</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBasicMap</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCCAFraction</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyRPIs</span>
                                <span class="p">);</span>
        <span class="n">CARDbStartMeasure</span> <span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pCurrMeasureEID</span><span class="o">++</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uNumOfMeasureEIDs</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Initialiation of MAC &amp; BBP registers</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">device_init_registers</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">DEVICE_INIT_TYPE</span> <span class="n">InitType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byValue</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byValue1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byCCKPwrdBm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOFDMPwrdBm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">zonetype</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
     <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">MACbShutdown</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">BBvSoftwareReset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">InitType</span> <span class="o">==</span> <span class="n">DEVICE_INIT_COLD</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">InitType</span> <span class="o">==</span> <span class="n">DEVICE_INIT_DXPL</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Do MACbSoftwareReset in MACvInitialize</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MACbSoftwareReset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>force CCK</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCCK</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bAES</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>      <span class="c1">//Only used in 11g type, sync with ERP IE</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bNonERPPresent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span> <span class="o">=</span> <span class="n">RATE_24M</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>

        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRevId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="c1">//Target to IF pin while programming to RF chip.</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>init MAC</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MACvInitialize</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Get Local ID</p></td><td class="code"><div class="highlight"><pre>        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_LOCALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span><span class="p">));</span>

           <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	 <span class="n">SROMvReadAllContents</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">);</span>

           <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Get Channel range</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byMinChannel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byMaxChannel</span> <span class="o">=</span> <span class="n">CB_MAX_CHANNEL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Get Antena</p></td><td class="code"><div class="highlight"><pre>        <span class="n">byValue</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">EEP_OFS_ANTENNA</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byValue</span> <span class="o">&amp;</span> <span class="n">EEP_ANTINV</span><span class="p">)</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>printk("init_register:TxRxAntInv is %d,byValue is %d\n",pDevice->bTxRxAntInv,byValue);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>

        <span class="n">byValue</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">EEP_ANTENNA_AUX</span> <span class="o">|</span> <span class="n">EEP_ANTENNA_MAIN</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byValue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// if not set default is All</span>
            <span class="n">byValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">EEP_ANTENNA_AUX</span> <span class="o">|</span> <span class="n">EEP_ANTENNA_MAIN</span><span class="p">);</span>
<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>printk("init_register:byValue is %d\n",byValue);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulDiversityNValue</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">260</span><span class="p">;</span><span class="c1">//100*SROMbyReadEmbedded(pDevice-&gt;PortOffset, 0x51);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulDiversityMValue</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span><span class="c1">//SROMbyReadEmbedded(pDevice-&gt;PortOffset, 0x52);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTMax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//SROMbyReadEmbedded(pDevice-&gt;PortOffset, 0x53);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTMax2</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="c1">//SROMbyReadEmbedded(pDevice-&gt;PortOffset, 0x54);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulSQ3TH</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//(unsigned long) SROMbyReadEmbedded(pDevice-&gt;PortOffset, 0x55);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTMax3</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span><span class="c1">//SROMbyReadEmbedded(pDevice-&gt;PortOffset, 0x56);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">byValue</span> <span class="o">==</span> <span class="p">(</span><span class="n">EEP_ANTENNA_AUX</span> <span class="o">|</span> <span class="n">EEP_ANTENNA_MAIN</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAntennaCount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwTxAntennaSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwRxAntennaSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_A</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>chester for antenna</p></td><td class="code"><div class="highlight"><pre><span class="n">byValue1</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">EEP_OFS_ANTENNA</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>if (pDevice->bDiversityRegCtlON)</p></td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">((</span><span class="n">byValue1</span><span class="o">&amp;</span><span class="mh">0x08</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span><span class="c1">//SROMbyReadEmbedded(pDevice-&gt;PortOffset, 0x50);</span>
            <span class="k">else</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>printk("aux |main antenna: RxAntennaMode is %d\n",pDevice->byRxAntennaMode);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAntennaCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwTxAntennaSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwRxAntennaSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">byValue</span> <span class="o">&amp;</span> <span class="n">EEP_ANTENNA_AUX</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_A</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_A</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_A</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>printk("init registers: TxAntennaMode is %d\n",pDevice->byTxAntennaMode);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;bDiversityEnable=[%d],NValue=[%d],MValue=[%d],TMax=[%d],TMax2=[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityEnable</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulDiversityNValue</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulDiversityMValue</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTMax</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTMax2</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><h1>ifdef ZoneType_DefaultSetting</h1>

<p>2008-8-4 <add> by chester
zonetype initial</p></td><td class="code"><div class="highlight"><pre> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOriginalZonetype</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">];</span>
 <span class="n">zonetype</span> <span class="o">=</span> <span class="n">Config_FileOperation</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="nb">false</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">zonetype</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>         <span class="c1">//read zonetype file ok!</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">zonetype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span> <span class="o">!=</span><span class="mh">0x00</span><span class="p">)){</span>          <span class="c1">//for USA</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_MAXCHANNEL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0B</span><span class="p">;</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Init Zone Type :USA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
 <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">zonetype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">&amp;&amp;</span>
 	     <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span><span class="o">!=</span><span class="mh">0x01</span><span class="p">)){</span>   <span class="c1">//for Japan</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_MAXCHANNEL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0D</span><span class="p">;</span>
  <span class="p">}</span>
 <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">zonetype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">&amp;&amp;</span>
 	     <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span><span class="o">!=</span><span class="mh">0x02</span><span class="p">)){</span>   <span class="c1">//for Europe</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_MAXCHANNEL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0D</span><span class="p">;</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Init Zone Type :Europe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">else</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">zonetype</span><span class="o">!=</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">])</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;zonetype in file[%02x] mismatch with in EEPROM[%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">zonetype</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]);</span>
   <span class="k">else</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Read Zonetype file success,use default zonetype setting[%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">zonetype</span><span class="p">);</span>
 <span class="p">}</span>
 	<span class="p">}</span>
  <span class="k">else</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Read Zonetype file fail,use default zonetype setting[%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">EEP_OFS_ZONETYPE</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Get RFType</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRFType</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">EEP_OFS_RFTYPE</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRFType</span> <span class="o">&amp;</span> <span class="n">RF_EMU</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>force change RevID for VT3253 emu</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRevId</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRFType</span> <span class="o">&amp;=</span> <span class="n">RF_MASK</span><span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;pDevice-&gt;byRFType = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRFType</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bZoneRegExist</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byZoneType</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;pDevice-&gt;byZoneType = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byZoneType</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Init RF module</p></td><td class="code"><div class="highlight"><pre>        <span class="n">RFbInit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Get Desire Power Value</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurPwr</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCCKPwr</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">EEP_OFS_PWR_CCK</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOFDMPwrG</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">EEP_OFS_PWR_OFDMG</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>byCCKPwrdBm = SROMbyReadEmbedded(pDevice->PortOffset, EEP<em>OFS</em>CCK<em>PWR</em>dBm);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>byOFDMPwrdBm = SROMbyReadEmbedded(pDevice->PortOffset, EEP<em>OFS</em>OFDM<em>PWR</em>dBm);
printk("CCKPwrdBm is 0x%x,byOFDMPwrdBm is 0x%x\n",byCCKPwrdBm,byOFDMPwrdBm);
Load power Table</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">CB_MAX_CHANNEL_24G</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">ii</span> <span class="o">+</span> <span class="n">EEP_OFS_CCK_PWR_TBL</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCCKPwr</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">ii</span> <span class="o">+</span> <span class="n">EEP_OFS_OFDM_PWR_TBL</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOFDMPwrG</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKDefaultPwr</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">byCCKPwrdBm</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMDefaultPwr</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">byOFDMPwrdBm</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>2008-8-4 <add> by chester
recover 12,13 ,14channel for EUROPE by 11 channel</p></td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">ZoneType_Japan</span><span class="p">)</span> <span class="o">||</span>
	        <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">ZoneType_Europe</span><span class="p">))</span><span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOriginalZonetype</span> <span class="o">==</span> <span class="n">ZoneType_USA</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">11</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="mi">14</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	       <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	    <span class="p">}</span>
	  <span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Load OFDM A Power Table</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">CB_MAX_CHANNEL_5G</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//RobertYu:20041224, bug using CB_MAX_CHANNEL</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="n">CB_MAX_CHANNEL_24G</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">ii</span> <span class="o">+</span> <span class="n">EEP_OFS_OFDMA_PWR_TBL</span><span class="p">));</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMDefaultPwr</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="n">CB_MAX_CHANNEL_24G</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">ii</span> <span class="o">+</span> <span class="n">EEP_OFS_OFDMA_PWR_dBm</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">init_channel_table</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span> <span class="o">&gt;</span> <span class="n">REV_ID_VT3253_B1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
            <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MSRCTL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">MSRCTL1_TXPWR</span> <span class="o">|</span> <span class="n">MSRCTL1_CSAPAREN</span><span class="p">));</span>
            <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>use relative tx timeout and 802.11i D4</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MACvWordRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_CFG</span><span class="p">,</span> <span class="p">(</span><span class="n">CFG_TKIPOPT</span> <span class="o">|</span> <span class="n">CFG_NOTXTIMEOUT</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>set performance parameter by registry</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MACvSetShortRetryLimit</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortRetryLimit</span><span class="p">);</span>
        <span class="n">MACvSetLongRetryLimit</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLongRetryLimit</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>reset TSF counter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_TFTCTL</span><span class="p">,</span> <span class="n">TFTCTL_TSFCNTRST</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>enable TSF counter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_TFTCTL</span><span class="p">,</span> <span class="n">TFTCTL_TSFCNTREN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>initialize BBP registers</p></td><td class="code"><div class="highlight"><pre>        <span class="n">BBbVT3253Init</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bUpdateBBVGA</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBBVGA</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span><span class="p">;</span>
            <span class="n">BBvSetVGAGainOffset</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBBVGA</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="p">}</span>
<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>printk("init registers:RxAntennaMode is %x,TxAntennaMode is %x\n",pDevice->byRxAntennaMode,pDevice->byTxAntennaMode);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
        <span class="n">BBvSetRxAntennaMode</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span><span class="p">);</span>
        <span class="n">BBvSetTxAntennaMode</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTxAntennaMode</span><span class="p">);</span>

        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurrentCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>pDevice->NetworkType = Ndis802_11Automode;
Set BB and packet type at the same time.
Set Short Slot Time, xIFS, and RSPINF.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">==</span> <span class="n">RATE_AUTO</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>default G Mode</p></td><td class="code"><div class="highlight"><pre>        <span class="n">VNTWIFIbConfigPhyMode</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">PHY_TYPE_11G</span><span class="p">);</span>
        <span class="n">VNTWIFIbConfigPhyMode</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">PHY_TYPE_AUTO</span><span class="p">);</span>

        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRadioOff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRadioCtl</span> <span class="o">=</span> <span class="n">SROMbyReadEmbedded</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">EEP_OFS_RADIOCTL</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bHWRadioOff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRadioCtl</span> <span class="o">&amp;</span> <span class="n">EEP_RADIOCTL_ENABLE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Get GPIO</p></td><td class="code"><div class="highlight"><pre>            <span class="n">MACvGPIOIn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byGPIO</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>2008-4-14 <add> by chester for led issue</p></td><td class="code"><div class="highlight"><pre> <span class="cp">#ifdef FOR_LED_ON_NOTEBOOK</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byGPIO</span> <span class="o">&amp;</span> <span class="n">GPIO0_DATA</span><span class="p">){</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bHWRadioOff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;}</span>
<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byGPIO</span> <span class="o">&amp;</span> <span class="n">GPIO0_DATA</span><span class="p">)){</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bHWRadioOff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;}</span>

            <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRadioControlOff</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">CARDbRadioPowerOff</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
        <span class="p">}</span>
<span class="k">else</span>  <span class="n">CARDbRadioPowerOn</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
<span class="cp">#else</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byGPIO</span> <span class="o">&amp;</span> <span class="n">GPIO0_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRadioCtl</span> <span class="o">&amp;</span> <span class="n">EEP_RADIOCTL_INV</span><span class="p">))</span> <span class="o">||</span>
                <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byGPIO</span> <span class="o">&amp;</span> <span class="n">GPIO0_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRadioCtl</span> <span class="o">&amp;</span> <span class="n">EEP_RADIOCTL_INV</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bHWRadioOff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bHWRadioOff</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRadioControlOff</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">CARDbRadioPowerOff</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
        <span class="p">}</span>

<span class="cp">#endif</span>
    <span class="p">}</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_PASSIVE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>get Permanent network address</p></td><td class="code"><div class="highlight"><pre>    <span class="n">SROMvReadEtherAddress</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">);</span>
	<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Network address = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>reset Tx pointer</p></td><td class="code"><div class="highlight"><pre>    <span class="n">CARDvSafeResetRx</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>reset Rx pointer</p></td><td class="code"><div class="highlight"><pre>    <span class="n">CARDvSafeResetTx</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="n">REV_ID_VT3253_A1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="n">RCR_WPAERR</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>Turn On Rx DMA</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvReceive0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">MACvReceive1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>start the adapter</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvStart</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>

    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>


<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init_diversity_timer</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">TimerSQ3CallBack</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>

    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">TimerSQ3CallBack</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>

    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">TimerState1CallBack</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="n">device_release_WPADEV</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="n">wpahdr</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>wait<em>queue</em>head<em>t    Set</em>wait;
send device close to wpa_supplicnat layer</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="o">==</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">wpahdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
                 <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIAWGET_DEVICECLOSE_MSG</span><span class="p">;</span>
                 <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">skb_put</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">));</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wpadev</span><span class="p">;</span>
		 <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
                 <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
                 <span class="n">netif_rx</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>wait release WPADEV
   init<em>waitqueue</em>head(&amp;Set<em>wait);
   wait</em>event<em>timeout(Set</em>wait, ((pDevice->wpadev==NULL)&amp;&amp;(pDevice->skb == NULL)),5*HZ);    //1s wait</p></td><td class="code"><div class="highlight"><pre>              <span class="k">while</span><span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="o">==</span><span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
	        <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
                 <span class="n">schedule_timeout</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">20</span><span class="p">);</span>          <span class="c1">//wait 50ms</span>
                 <span class="n">ii</span><span class="o">++</span><span class="p">;</span>
	        <span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">)</span>
		  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
           <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">device_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">ndo_open</span>               <span class="o">=</span> <span class="n">device_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_stop</span>               <span class="o">=</span> <span class="n">device_close</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_do_ioctl</span>           <span class="o">=</span> <span class="n">device_ioctl</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_get_stats</span>          <span class="o">=</span> <span class="n">device_get_stats</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_start_xmit</span>         <span class="o">=</span> <span class="n">device_xmit</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_set_rx_mode</span>	    <span class="o">=</span> <span class="n">device_set_multi</span><span class="p">,</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">vt6655_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcid</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">bool</span> <span class="n">bFirst</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span>  <span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PCHIP_INFO</span>  <span class="n">pChip_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHIP_INFO</span><span class="p">)</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
    <span class="n">PSDevice</span>    <span class="n">pDevice</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">rc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">device_nics</span> <span class="o">++&gt;=</span> <span class="n">MAX_UINTS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="n">DEVICE_NAME</span> <span class="s">&quot;: already found %d NICs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device_nics</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DEVICE_INFO</span><span class="p">));</span>

    <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEVICE_NAME</span> <span class="s">&quot;: allocate net device failed </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Chain it all together
SET<em>MODULE</em>OWNER(dev);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcid</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bFirst</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s Ver. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">DEVICE_FULL_DRV_NAM</span><span class="p">,</span> <span class="n">DEVICE_VERSION</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Copyright (c) 2003 VIA Networking Technologies, Inc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">bFirst</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vt6655_init_info</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pChip_info</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">next_module</span> <span class="o">=</span> <span class="n">root_device_dev</span><span class="p">;</span>
    <span class="n">root_device_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pcid</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">device_free_info</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pcid</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef	DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Before get pci_info memaddr is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">memaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">device_get_pci_info</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pcid</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEVICE_NAME</span> <span class="s">&quot;: Failed to find PCI device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">device_free_info</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#if 1</span>

<span class="cp">#ifdef	DEBUG</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>pci<em>read</em>config<em>byte(pcid, PCI</em>BASE<em>ADDRESS</em>0, &amp;pDevice->byRevId);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;after get pci_info memaddr is %x, io addr is %x,io_size is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">memaddr</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">io_size</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span>			<span class="n">bar</span><span class="p">,</span><span class="n">len</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">address</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_2</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_3</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_4</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_5</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">};</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">address</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>pci<em>write</em>config_dword(pcid,address[i], 0xFFFFFFFF);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bar</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bar %d is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">bar</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bar</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bar %d not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bar</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is IO */</span>

			<span class="n">len</span> <span class="o">=</span> <span class="n">bar</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCI_BASE_ADDRESS_IO_MASK</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IO space:  len in IO %x, BAR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">bar</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;len in MEM %x, BAR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cp">#endif</span>

<span class="cp">#ifdef	DEBUG</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>return  0  ;</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">memaddr</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">io_size</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>pDevice->PortOffset = (unsigned long)ioremap(pDevice->ioaddr &amp; PCI<em>BASE</em>ADDRESS<em>IO</em>MASK, pDevice->io_size);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEVICE_NAME</span> <span class="s">&quot;: Failed to IO remapping ..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
       <span class="n">device_free_info</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span>




    <span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEVICE_NAME</span> <span class="s">&quot;: Failed to find PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">device_free_info</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
<span class="cp">#ifdef	PLICE_DEBUG</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> 	<span class="n">value</span><span class="p">;</span>

	<span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="o">+</span><span class="mh">0x4F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Before write: value is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">value</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>VNSvInPortB(pDevice->PortOffset+0x3F, 0x00);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
	<span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="o">+</span><span class="mh">0x4F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;After write: value is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>



<span class="cp">#ifdef IO_MAP</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>do reset</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACbSoftwareReset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEVICE_NAME</span> <span class="s">&quot;: Failed to access MAC hardware..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">device_free_info</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>initial to reload eeprom</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvInitialize</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">MACvReadEtherAddress</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

    <span class="n">device_get_options</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">device_nics</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="n">device_set_options</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Mask out the options cannot be set to the chip</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">pChip_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Enable the chip specified capbilities</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">flags</span> <span class="o">|</span> <span class="p">(</span><span class="n">pChip_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xFF000000UL</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_80211</span> <span class="o">=</span> <span class="n">device_dma0_tx_80211</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">.</span><span class="n">pAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>

    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span>                <span class="o">=</span> <span class="n">pcid</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">device_netdev_ops</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iwctl_handler_def</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEVICE_NAME</span> <span class="s">&quot; Failed to register netdev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">device_free_info</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>2008-07-21-01<Add>by MikeLiu
register wpadev</p></td><td class="code"><div class="highlight"><pre><span class="cp">#if 0</span><span class="c"></span>
<span class="c">   if(wpa_set_wpadev(pDevice, 1)!=0) {</span>
<span class="c">     printk(&quot;Fail to Register WPADEV?\n&quot;);</span>
<span class="c">        unregister_netdev(pDevice-&gt;dev);</span>
<span class="c">        free_netdev(dev);</span>
<span class="c">   }</span>
<span class="cp">#endif</span>
    <span class="n">device_print_info</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">pDevice</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_print_info</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="o">=</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">get_chip_name</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">));</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: MAC=%pM&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
<span class="cp">#ifdef IO_MAP</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; IO=0x%lx  &quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; IRQ=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; IO=0x%lx Mem=0x%lx &quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; IRQ=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__devinit</span> <span class="nf">vt6655_init_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">pcid</span><span class="p">,</span> <span class="n">PSDevice</span><span class="o">*</span> <span class="n">ppDevice</span><span class="p">,</span>
    <span class="n">PCHIP_INFO</span> <span class="n">pChip_info</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">PSDevice</span> <span class="n">p</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">*</span><span class="n">ppDevice</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DEVICE_INFO</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice_Infos</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pDevice_Infos</span> <span class="o">=*</span><span class="n">ppDevice</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">pDevice_Infos</span><span class="p">;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
            <span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppDevice</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span><span class="n">ppDevice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">(</span><span class="o">*</span><span class="n">ppDevice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pcid</span> <span class="o">=</span> <span class="n">pcid</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">ppDevice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">pChip_info</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">ppDevice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">io_size</span> <span class="o">=</span> <span class="n">pChip_info</span><span class="o">-&gt;</span><span class="n">io_size</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">ppDevice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nTxQueues</span> <span class="o">=</span> <span class="n">pChip_info</span><span class="o">-&gt;</span><span class="n">nTxQueue</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">ppDevice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">multicast_limit</span> <span class="o">=</span><span class="mi">32</span><span class="p">;</span>

    <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">ppDevice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">device_get_pci_info</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">pcid</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">u16</span> <span class="n">pci_cmd</span><span class="p">;</span>
    <span class="n">u8</span>  <span class="n">b</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cis_addr</span><span class="p">;</span>
<span class="cp">#ifdef	PLICE_DEBUG</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pci_config</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> 	<span class="n">value</span> <span class="o">=</span><span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">max_lat</span><span class="o">=</span><span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pci_config</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">PCI_REVISION_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRevId</span><span class="p">);</span>
    <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_ID</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SubSystemID</span><span class="p">);</span>
    <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SubVendorID</span><span class="p">);</span>
    <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pci_cmd</span><span class="p">));</span>

    <span class="n">pci_set_master</span><span class="p">(</span><span class="n">pcid</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">memaddr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef	DEBUG</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>pDevice->ioaddr = pci<em>resource</em>start(pcid, 0);
pDevice->memaddr = pci<em>resource</em>start(pcid,1);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>

    <span class="n">cis_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span> <span class="o">=</span> <span class="n">pcid</span><span class="p">;</span>

    <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
    <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="o">|</span><span class="n">PCI_COMMAND_MASTER</span><span class="p">));</span>

<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>pci<em>read</em>config<em>word(pcid,PCI</em>MAX<em>LAT,&amp;max</em>lat);
printk("max lat is %x,SubSystemID is %x\n",max<em>lat,pDevice->SubSystemID);
for (ii=0;ii&lt;0xFF;ii++)
pci</em>read<em>config</em>word(pcid,PCI<em>MAX</em>LAT,&amp;max<em>lat);
max</em>lat  = 0x20;
pci<em>write</em>config<em>word(pcid,PCI</em>MAX<em>LAT,max</em>lat);
pci<em>read</em>config<em>word(pcid,PCI</em>MAX<em>LAT,&amp;max</em>lat);
printk("max lat is %x\n",max_lat);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="mh">0xFF</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">pci_config</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="mh">0x100</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">,</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">%</span><span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x:&quot;</span><span class="p">,</span><span class="n">pci_config</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x:&quot;</span><span class="p">,</span><span class="n">pci_config</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_info</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span>         <span class="n">ptr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span>  <span class="n">dev</span><span class="o">=</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>2008-0714-01<Add>by chester</p></td><td class="code"><div class="highlight"><pre><span class="n">device_release_WPADEV</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>2008-07-21-01<Add>by MikeLiu
unregister wpadev</p></td><td class="code"><div class="highlight"><pre>   <span class="k">if</span><span class="p">(</span><span class="n">wpa_set_wpadev</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;unregister wpadev fail?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice_Infos</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ptr</span><span class="o">=</span><span class="n">pDevice_Infos</span><span class="p">;</span><span class="n">ptr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ptr</span><span class="o">!=</span><span class="n">pDevice</span><span class="p">);</span><span class="n">ptr</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
            <span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">==</span><span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">==</span><span class="n">pDevice_Infos</span><span class="p">)</span>
            <span class="n">pDevice_Infos</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;info struct not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#ifdef HOSTAP</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
        <span class="n">vt6655_hostap_set_hostapd</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
        <span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">)</span>
        <span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">)</span>
        <span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
        <span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">device_init_rings</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span><span class="o">*</span>   <span class="n">vir_pool</span><span class="p">;</span>


    <span class="cm">/*allocate all RD/TD rings a single pool*/</span>
    <span class="n">vir_pool</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">),</span>
                    <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pool_dma</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">vir_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s : allocate desc dma memory failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">vir_pool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">)</span>
          <span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD0Ring</span> <span class="o">=</span> <span class="n">vir_pool</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD1Ring</span> <span class="o">=</span> <span class="n">vir_pool</span> <span class="o">+</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">);</span>


    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rd0_pool_dma</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pool_dma</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rd1_pool_dma</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rd0_pool_dma</span> <span class="o">+</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx0_bufs</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span> <span class="o">+</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span> <span class="o">+</span>
                    <span class="n">CB_BEACON_BUF_SIZE</span> <span class="o">+</span>
                    <span class="n">CB_MAX_BUF_SIZE</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx0_bufs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: allocate buf dma memory failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">),</span>
            <span class="n">vir_pool</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pool_dma</span>
            <span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx0_bufs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span> <span class="o">+</span>
           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span> <span class="o">+</span>
           <span class="n">CB_BEACON_BUF_SIZE</span> <span class="o">+</span>
           <span class="n">CB_MAX_BUF_SIZE</span>
          <span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">td0_pool_dma</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rd1_pool_dma</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">td1_pool_dma</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">td0_pool_dma</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>vir_pool: pvoid type</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD0Rings</span> <span class="o">=</span> <span class="n">vir_pool</span>
                          <span class="o">+</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span>
                          <span class="o">+</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD1Rings</span> <span class="o">=</span> <span class="n">vir_pool</span>
            <span class="o">+</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">);</span>


    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx1_bufs</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx0_bufs</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span><span class="p">;</span>


    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_beacon_bufs</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx1_bufs</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span><span class="p">;</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pbyTmpBuff</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_beacon_bufs</span> <span class="o">+</span>
            <span class="n">CB_BEACON_BUF_SIZE</span><span class="p">;</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma1</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma0</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span><span class="p">;</span>


    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_beacon_dma</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma1</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span><span class="p">;</span>


    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_rings</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">)</span>
            <span class="p">,</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD0Ring</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pool_dma</span>
        <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx0_bufs</span><span class="p">)</span>
        <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span>
           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span> <span class="o">+</span>
           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">PKT_BUF_SZ</span> <span class="o">+</span>
           <span class="n">CB_BEACON_BUF_SIZE</span> <span class="o">+</span>
           <span class="n">CB_MAX_BUF_SIZE</span><span class="p">,</span>
           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx0_bufs</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma0</span>
        <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_init_rd0_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">dma_addr_t</span>      <span class="n">curr</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rd0_pool_dma</span><span class="p">;</span>
    <span class="n">PSRxDesc</span>        <span class="n">pDesc</span><span class="p">;</span>

    <span class="cm">/* Init the RD0 ring entries */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">,</span> <span class="n">curr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pDesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD0Ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span> <span class="o">=</span> <span class="n">alloc_rd_info</span><span class="p">();</span>
        <span class="n">ASSERT</span><span class="p">(</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_rx_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDesc</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc rx bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD0Ring</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span><span class="p">]);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">curr_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">curr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD0Ring</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rd0_pool_dma</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pCurrRD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD0Ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_init_rd1_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">dma_addr_t</span>      <span class="n">curr</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rd1_pool_dma</span><span class="p">;</span>
    <span class="n">PSRxDesc</span>        <span class="n">pDesc</span><span class="p">;</span>

    <span class="cm">/* Init the RD1 ring entries */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">,</span> <span class="n">curr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pDesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD1Ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span> <span class="o">=</span> <span class="n">alloc_rd_info</span><span class="p">();</span>
        <span class="n">ASSERT</span><span class="p">(</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_rx_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDesc</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc rx bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD1Ring</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span><span class="p">]);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">curr_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">curr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRxDesc</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD1Ring</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rd1_pool_dma</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pCurrRD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD1Ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_init_defrag_cb</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">PSDeFragControlBlock</span> <span class="n">pDeF</span><span class="p">;</span>

    <span class="cm">/* Init the fragment ctl entries */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CB_MAX_RX_FRAG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pDeF</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_frag_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDeF</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc frag bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbDFCB</span> <span class="o">=</span> <span class="n">CB_MAX_RX_FRAG</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeDFCB</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbDFCB</span><span class="p">;</span>
<span class="p">}</span>




<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_rd0_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PSRxDesc</span>        <span class="n">pDesc</span> <span class="o">=&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD0Ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">PDEVICE_RD_INFO</span>  <span class="n">pRDInfo</span> <span class="o">=</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="p">;</span>

        <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span><span class="p">,</span>
           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

        <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

        <span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_rd1_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>


    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nRxDescs1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PSRxDesc</span>        <span class="n">pDesc</span><span class="o">=&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">aRD1Ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">PDEVICE_RD_INFO</span>  <span class="n">pRDInfo</span><span class="o">=</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="p">;</span>

        <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span><span class="p">,</span>
           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

        <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

        <span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_frag_buf</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDeFragControlBlock</span> <span class="n">pDeF</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CB_MAX_RX_FRAG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">pDeF</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
            <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_init_td0_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">dma_addr_t</span>  <span class="n">curr</span><span class="p">;</span>
    <span class="n">PSTxDesc</span>        <span class="n">pDesc</span><span class="p">;</span>

    <span class="n">curr</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">td0_pool_dma</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">curr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pDesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD0Rings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span> <span class="o">=</span> <span class="n">alloc_td_info</span><span class="p">();</span>
        <span class="n">ASSERT</span><span class="p">(</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_TX_ALIGN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx0_bufs</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">PKT_BUF_SZ</span><span class="p">;</span>
            <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf_dma</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">PKT_BUF_SZ</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD0Rings</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">curr_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">curr</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD0Rings</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">td0_pool_dma</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTailTD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apCurrTD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD0Rings</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_init_td1_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">dma_addr_t</span>  <span class="n">curr</span><span class="p">;</span>
    <span class="n">PSTxDesc</span>    <span class="n">pDesc</span><span class="p">;</span>

    <span class="cm">/* Init the TD ring entries */</span>
    <span class="n">curr</span><span class="o">=</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">td1_pool_dma</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">curr</span><span class="o">+=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pDesc</span><span class="o">=&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD1Rings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span> <span class="o">=</span> <span class="n">alloc_td_info</span><span class="p">();</span>
        <span class="n">ASSERT</span><span class="p">(</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_TX_ALIGN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf</span><span class="o">=</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx1_bufs</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">PKT_BUF_SZ</span><span class="p">;</span>
            <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf_dma</span><span class="o">=</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">PKT_BUF_SZ</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD1Rings</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">curr_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
        <span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">curr</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">STxDesc</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD1Rings</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">td1_pool_dma</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTailTD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apCurrTD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD1Rings</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_td0_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PSTxDesc</span>        <span class="n">pDesc</span><span class="o">=&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD0Rings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">PDEVICE_TD_INFO</span>  <span class="n">pTDInfo</span><span class="o">=</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span> <span class="o">!=</span> <span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf_dma</span><span class="p">))</span>
            <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span><span class="p">,</span>
               <span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
            <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

        <span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_td1_ring</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">nTxDescs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PSTxDesc</span>        <span class="n">pDesc</span><span class="o">=&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD1Rings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">PDEVICE_TD_INFO</span>  <span class="n">pTDInfo</span><span class="o">=</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span> <span class="o">!=</span> <span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf_dma</span><span class="p">))</span>
            <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span> <span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span><span class="p">,</span>
               <span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
            <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

        <span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>



<span class="cm">/*-----------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_rx_srv</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uIdx</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSRxDesc</span>    <span class="n">pRD</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">works</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


    <span class="k">for</span> <span class="p">(</span><span class="n">pRD</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pCurrRD</span><span class="p">[</span><span class="n">uIdx</span><span class="p">];</span>
         <span class="n">pRD</span><span class="o">-&gt;</span><span class="n">m_rd0RD0</span><span class="p">.</span><span class="n">f1Owner</span> <span class="o">==</span> <span class="n">OWNED_BY_HOST</span><span class="p">;</span>
         <span class="n">pRD</span> <span class="o">=</span> <span class="n">pRD</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><pre><code>   DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "pDevice-&gt;pCurrRD = %x, works = %d\n", pRD, works);
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">works</span><span class="o">++&gt;</span><span class="mi">15</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">device_receive_frame</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pRD</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_rx_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pRD</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span> <span class="n">KERN_ERR</span>
                    <span class="s">&quot;%s: can not allocate rx buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">pRD</span><span class="o">-&gt;</span><span class="n">m_rd0RD0</span><span class="p">.</span><span class="n">f1Owner</span> <span class="o">=</span> <span class="n">OWNED_BY_NIC</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pCurrRD</span><span class="p">[</span><span class="n">uIdx</span><span class="p">]</span><span class="o">=</span><span class="n">pRD</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">works</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">device_alloc_rx_buf</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">PSRxDesc</span> <span class="n">pRD</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">PDEVICE_RD_INFO</span> <span class="n">pRDInfo</span><span class="o">=</span><span class="n">pRD</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="p">;</span>


    <span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>printk("device<em>alloc</em>rx_buf:skb is %x\n",pRDInfo->skb);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
    <span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
    <span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">),</span>
				      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
    <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pRD</span><span class="o">-&gt;</span><span class="n">m_rd0RD0</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* FIX cast */</span>

    <span class="n">pRD</span><span class="o">-&gt;</span><span class="n">m_rd0RD0</span><span class="p">.</span><span class="n">wResCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
    <span class="n">pRD</span><span class="o">-&gt;</span><span class="n">m_rd0RD0</span><span class="p">.</span><span class="n">f1Owner</span> <span class="o">=</span> <span class="n">OWNED_BY_NIC</span><span class="p">;</span>
    <span class="n">pRD</span><span class="o">-&gt;</span><span class="n">m_rd1RD1</span><span class="p">.</span><span class="n">wReqCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
    <span class="n">pRD</span><span class="o">-&gt;</span><span class="n">buff_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>



<span class="n">bool</span> <span class="nf">device_alloc_frag_buf</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">PSDeFragControlBlock</span> <span class="n">pDeF</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
    <span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_tx_srv</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uIdx</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSTxDesc</span>                 <span class="n">pTD</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bFull</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
    <span class="kt">int</span>                      <span class="n">works</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byTsr0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byTsr1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">uFrameSize</span><span class="p">,</span> <span class="n">uFIFOHeaderSize</span><span class="p">;</span>
    <span class="n">PSTxBufHead</span>              <span class="n">pTxBufHead</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">net_device_stats</span><span class="o">*</span> <span class="n">pStats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span>          <span class="n">skb</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">uNodeIndex</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>             <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>


    <span class="k">for</span> <span class="p">(</span><span class="n">pTD</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTailTD</span><span class="p">[</span><span class="n">uIdx</span><span class="p">];</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">iTDUsed</span><span class="p">[</span><span class="n">uIdx</span><span class="p">]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="n">pTD</span> <span class="o">=</span> <span class="n">pTD</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pTD</span><span class="o">-&gt;</span><span class="n">m_td0TD0</span><span class="p">.</span><span class="n">f1Owner</span> <span class="o">==</span> <span class="n">OWNED_BY_NIC</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">works</span><span class="o">++&gt;</span><span class="mi">15</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="n">byTsr0</span> <span class="o">=</span> <span class="n">pTD</span><span class="o">-&gt;</span><span class="n">m_td0TD0</span><span class="p">.</span><span class="n">byTSR0</span><span class="p">;</span>
        <span class="n">byTsr1</span> <span class="o">=</span> <span class="n">pTD</span><span class="o">-&gt;</span><span class="n">m_td0TD0</span><span class="p">.</span><span class="n">byTSR1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Only the status of first TD in the chain is correct</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pTD</span><span class="o">-&gt;</span><span class="n">m_td1TD1</span><span class="p">.</span><span class="n">byTCR</span> <span class="o">&amp;</span> <span class="n">TCR_STP</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">&amp;</span> <span class="n">TD_FLAGS_NETIF_SKB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">uFIFOHeaderSize</span> <span class="o">=</span> <span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">dwHeaderLength</span><span class="p">;</span>
                <span class="n">uFrameSize</span> <span class="o">=</span> <span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">dwReqCount</span> <span class="o">-</span> <span class="n">uFIFOHeaderSize</span><span class="p">;</span>
                <span class="n">pTxBufHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxBufHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>Update the statistics based on the Transmit status
now, we DO'NT check TSR0_CDH</p></td><td class="code"><div class="highlight"><pre>                <span class="n">STAvUpdateTDStatCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">,</span>
                        <span class="n">byTsr0</span><span class="p">,</span> <span class="n">byTsr1</span><span class="p">,</span>
                        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">uFIFOHeaderSize</span><span class="p">),</span>
                        <span class="n">uFrameSize</span><span class="p">,</span> <span class="n">uIdx</span><span class="p">);</span>


                <span class="n">BSSvUpdateNodeTxCounter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                         <span class="n">byTsr0</span><span class="p">,</span> <span class="n">byTsr1</span><span class="p">,</span>
                         <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">),</span>
                         <span class="n">uFIFOHeaderSize</span>
                         <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byTsr1</span> <span class="o">&amp;</span> <span class="n">TSR1_TERR</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">byTsr0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; Tx[%d] OK but has error. tsr1[%02X] tsr0[%02X].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">uIdx</span><span class="p">,</span> <span class="n">byTsr1</span><span class="p">,</span> <span class="n">byTsr0</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">&amp;</span> <span class="n">FRAGCTL_ENDFRAG</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FRAGCTL_NONFRAG</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">TransmittedFragmentCount</span> <span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">pStats</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
                    <span class="n">pStats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                     <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; Tx[%d] dropped &amp; tsr1[%02X] tsr0[%02X].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">uIdx</span><span class="p">,</span> <span class="n">byTsr1</span><span class="p">,</span> <span class="n">byTsr0</span><span class="p">);</span>
                    <span class="n">pStats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
                    <span class="n">pStats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">&amp;</span> <span class="n">TD_FLAGS_PRIV_SKB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostapd</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;tx call back netif.. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="n">skb</span> <span class="o">=</span> <span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	                <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">;</span>
			<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	                <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>skb->protocol = htons(ETH<em>P</em>802_2);</p></td><td class="code"><div class="highlight"><pre>	                <span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	                <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	            <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">byTsr1</span> <span class="o">&amp;</span> <span class="n">TSR1_TERR</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">&amp;</span> <span class="n">TD_FLAGS_PRIV_SKB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; Tx[%d] fail has error. tsr1[%02X] tsr0[%02X].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">uIdx</span><span class="p">,</span> <span class="n">byTsr1</span><span class="p">,</span> <span class="n">byTsr0</span><span class="p">);</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><pre><code>           DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO" Tx[%d] fail has error. tsr1[%02X] tsr0[%02X].\n",
                     (int)uIdx, byTsr1, byTsr0);
</code></pre></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">&amp;</span> <span class="n">TD_FLAGS_NETIF_SKB</span><span class="p">))</span> <span class="p">{</span>
                    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAID</span><span class="p">;</span>
                    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byMask</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">};</span>

                    <span class="n">skb</span> <span class="o">=</span> <span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>set tx map</p></td><td class="code"><div class="highlight"><pre>                            <span class="n">wAID</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wAID</span><span class="p">;</span>
                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>  <span class="n">byMask</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
                            <span class="n">pTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TD_FLAGS_NETIF_SKB</span><span class="p">);</span>
                            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;tx_srv:tx fail re-queue sta index= %d, QueCnt= %d</span><span class="se">\n</span><span class="s">&quot;</span>
                                    <span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">uNodeIndex</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="p">);</span>
                            <span class="n">pStats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">--</span><span class="p">;</span>
                            <span class="n">pStats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">--</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">device_free_tx_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pTD</span><span class="p">);</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">iTDUsed</span><span class="p">[</span><span class="n">uIdx</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">uIdx</span> <span class="o">==</span> <span class="n">TYPE_AC0DMA</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>RESERV_AC0DMA reserved for relay</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">AVAIL_TD</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uIdx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RESERV_AC0DMA</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bFull</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; AC0DMA is Full = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">iTDUsed</span><span class="p">[</span><span class="n">uIdx</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bFull</span><span class="o">==</span><span class="nb">false</span><span class="p">)){</span>
            <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTailTD</span><span class="p">[</span><span class="n">uIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pTD</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">works</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_error</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_FETALERR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span> <span class="n">KERN_ERR</span>
            <span class="s">&quot;%s: Hardware fatal error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span>
        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">));</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdRunning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">MACbShutdown</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_tx_buf</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">PSTxDesc</span> <span class="n">pDesc</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PDEVICE_TD_INFO</span>  <span class="n">pTDInfo</span><span class="o">=</span><span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="o">=</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>pre-allocated buf_dma can't be unmapped.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span> <span class="o">!=</span> <span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">buf_dma</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
              <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">&amp;</span> <span class="n">TD_FLAGS_NETIF_SKB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

    <span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>PLICE_DEBUG -></p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span>	<span class="nf">InitRxManagementQueue</span><span class="p">(</span><span class="n">PSDevice</span>  <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rxManeQueue</span><span class="p">.</span><span class="n">packet_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rxManeQueue</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rxManeQueue</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>PLICE_DEBUG&lt;-</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>PLICE_DEBUG -></p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">MlmeThread</span><span class="p">(</span>
     <span class="kt">void</span> <span class="o">*</span> <span class="n">Context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	<span class="n">pDevice</span> <span class="o">=</span>  <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">Context</span><span class="p">;</span>
	<span class="n">PSRxMgmtPacket</span>			<span class="n">pRxMgmtPacket</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>int i ;
complete(&amp;pDevice->notify);
printk("Enter MngWorkItem,Queue packet num is %d\n",pDevice->rxManeQueue.packet_num);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>printk("Enter MlmeThread,packet <em>num is %d\n",pDevice->rxManeQueue.packet</em>num);
i = 0;</p></td><td class="code"><div class="highlight"><pre><span class="cp">#if 1</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>printk("DDDD\n");
down(&amp;pDevice->mlme_semaphore);
pRxMgmtPacket =  DeQueue(pDevice);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#if 1</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		 <span class="k">while</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rxManeQueue</span><span class="p">.</span><span class="n">packet_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	 	<span class="p">{</span>
			 <span class="n">pRxMgmtPacket</span> <span class="o">=</span>  <span class="n">DeQueue</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>pDevice;
DequeueManageObject(pDevice->FirstRecvMngList, pDevice->LastRecvMngList);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">vMgrRxManagePacket</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxMgmtPacket</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>printk("packet<em>num is %d\n",pDevice->rxManeQueue.packet</em>num);</p></td><td class="code"><div class="highlight"><pre>		 <span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlme_kill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>udelay(200);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>printk("Before schedule thread jiffies is %x\n",jiffies);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">schedule</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>printk("after schedule thread jiffies is %x\n",jiffies);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">mlme_kill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>printk("i is %d\n",i);</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>

<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span>  <span class="nf">device_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span>    <span class="n">pDevice</span><span class="o">=</span><span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef WPA_SM_Transtatus</span>
    <span class="k">extern</span> <span class="n">SWPAResult</span> <span class="n">wpa_Result</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="n">PKT_BUF_SZ</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_init_rings</span><span class="p">(</span><span class="n">pDevice</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>2008-5-13 <add> by chester</p></td><td class="code"><div class="highlight"><pre>    <span class="n">i</span><span class="o">=</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>printk("DEBUG1\n");</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef WPA_SM_Transtatus</span>
     <span class="n">memset</span><span class="p">(</span><span class="n">wpa_Result</span><span class="p">.</span><span class="n">ifname</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wpa_Result</span><span class="p">.</span><span class="n">ifname</span><span class="p">));</span>
     <span class="n">wpa_Result</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">wpa_Result</span><span class="p">.</span><span class="n">key_mgmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">wpa_Result</span><span class="p">.</span><span class="n">eap_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">wpa_Result</span><span class="p">.</span><span class="n">authenticated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fWPA_Authened</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;call device init rd0 ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">device_init_rd0_ring</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_init_rd1_ring</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_init_defrag_cb</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_init_td0_ring</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_init_td1_ring</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>VNTWIFIvSet11h(pDevice->pMgmt, pDevice->b11hEnable);</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityRegCtlON</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">device_init_diversity_timer</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">vMgrObjectInit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">vMgrTimerInit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>PLICE_DEBUG-></p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef	TASK_LET</span>
	<span class="n">tasklet_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">RxMngWorkItem</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">MngWorkItem</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	THREAD</span>
	<span class="n">InitRxManagementQueue</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
	<span class="n">mlme_kill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mlme_task</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">MlmeThread</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="s">&quot;MLME&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mlme_task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;thread create fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlme_kill</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>



<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	pDevice-&gt;MLMEThr_pid = kernel_thread(MlmeThread, pDevice, CLONE_VM);</span>
<span class="c">	if (pDevice-&gt;MLMEThr_pid &lt;0 )</span>
<span class="c">	{</span>
<span class="c">		printk(&quot;unable start thread MlmeThread\n&quot;);</span>
<span class="c">		return -1;</span>
<span class="c">	}</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>printk("thread id is %d\n",pDevice->MLMEThr<em>pid);
printk("Create thread time is %x\n",jiffies);
wait</em>for_completion(&amp;pDevice->notify);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>if (( SROMbyReadEmbedded(pDevice->PortOffset, EEP<em>OFS</em>RADIOCTL)&amp;0x06)==0x04)
   return -ENOMEM;</p></td><td class="code"><div class="highlight"><pre><span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;call device_init_registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">device_init_registers</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DEVICE_INIT_COLD</span><span class="p">);</span>
    <span class="n">MACvReadEtherAddress</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">device_set_multi</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>Init for Key Management</p></td><td class="code"><div class="highlight"><pre>    <span class="n">KeyvInitTable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">));</span>

	<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
	<span class="cm">/*</span>
<span class="cm">     pDevice-&gt;bwextstep0 = false;</span>
<span class="cm">     pDevice-&gt;bwextstep1 = false;</span>
<span class="cm">     pDevice-&gt;bwextstep2 = false;</span>
<span class="cm">     pDevice-&gt;bwextstep3 = false;</span>
<span class="cm">     */</span>
       <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPASuppWextEnabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>Patch: if WEP key already set by iwconfig but device not yet open</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTransmitKey</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">KeybSetDefaultKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span>
                            <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)),</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">,</span>
                            <span class="nb">NULL</span><span class="p">,</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>
                            <span class="n">KEY_CTL_WEP</span><span class="p">,</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span>
                          <span class="p">);</span>
         <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>printk("DEBUG2\n");</p></td><td class="code"><div class="highlight"><pre><span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;call MACvIntEnable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">MACvIntEnable</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">IMR_MASK_VALUE</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_RUN_AP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
        <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_SSID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span><span class="n">DEVICE_FLAGS_OPENED</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_open success.. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>  <span class="nf">device_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span>  <span class="n">pDevice</span><span class="o">=</span><span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>     <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>PLICE_DEBUG-></p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef	THREAD</span>
	<span class="n">mlme_kill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>PLICE_DEBUG&lt;-
2007-1121-02<Add>by EinsnLiu</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_DISASSOCIATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">mdelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#ifdef TxInSleep</span>
    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span>
    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityRegCtlON</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">);</span>
        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">);</span>
        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cp">#ifdef	TASK_LET</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">RxMngWorkItem</span><span class="p">);</span>
<span class="cp">#endif</span>
     <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdRunning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">MACbShutdown</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">MACbSoftwareReset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">CARDbRadioPowerOff</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
    <span class="n">device_free_td0_ring</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_td1_ring</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_rd0_ring</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_rd1_ring</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_frag_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_rings</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">BSSvClearNodeDBTable</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span><span class="p">(</span><span class="o">~</span><span class="n">DEVICE_FLAGS_OPENED</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>2008-0714-01<Add>by chester</p></td><td class="code"><div class="highlight"><pre><span class="n">device_release_WPADEV</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>PLICE<em>DEBUG->
tasklet</em>kill(&amp;pDevice->RxMngWorkItem);
PLICE_DEBUG&lt;-</p></td><td class="code"><div class="highlight"><pre>    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_close.. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_dma0_tx_80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span><span class="o">=</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbMPDU</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbMPDULen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_dma0_tx_80211</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">AVAIL_TD</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_TXDMA0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_dma0_tx_80211, td0 &lt;=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bStopTx0Pkt</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pbMPDU</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

    <span class="n">vDMA0_tx_80211</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pbMPDU</span><span class="p">,</span> <span class="n">cbMPDULen</span><span class="p">);</span>

    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>



<span class="n">bool</span> <span class="nf">device_dma0_xmit</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="n">PSTxDesc</span>        <span class="n">pHeadTD</span><span class="p">,</span> <span class="n">pLastTD</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbFrameBodySize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uMACfragNum</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byPktType</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">PSKeyItem</span>       <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbHeaderSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
    <span class="n">SKeyItem</span>        <span class="n">STempKey</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>unsigned char byKeyIndex = 0;</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bStopTx0Pkt</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">AVAIL_TD</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_TXDMA0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_dma0_xmit, td0 &lt;=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAssocCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_dma0_xmit, assocCount = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pHeadTD</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apCurrTD</span><span class="p">[</span><span class="n">TYPE_TXDMA0</span><span class="p">];</span>

    <span class="n">pHeadTD</span><span class="o">-&gt;</span><span class="n">m_td1TD1</span><span class="p">.</span><span class="n">byTCR</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCR_EDP</span><span class="o">|</span><span class="n">TCR_STP</span><span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
    <span class="n">cbFrameBodySize</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>802.1H</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cbFrameBodySize</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">uMACfragNum</span> <span class="o">=</span> <span class="n">cbGetFragCount</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span> <span class="n">cbFrameBodySize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">uMACfragNum</span> <span class="o">&gt;</span> <span class="n">AVAIL_TD</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_TXDMA0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">byPktType</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPacketType</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&gt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_11M</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&gt;=</span> <span class="n">RATE_54M</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>preamble type</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortPreamble</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">PREAMBLE_LONG</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dma0: pDevice-&gt;wCurrentRate = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">);</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">&lt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11B</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11A</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11GB</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11GA</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
        <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STempKey</span><span class="p">;</span>
        <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byCipherSuite</span><span class="p">;</span>
        <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwKeyIndex</span><span class="p">;</span>
        <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uWepKeyLength</span><span class="p">;</span>
        <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwTSC47_16</span><span class="p">;</span>
        <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTSC15_0</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>
            <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">abyWepKey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span>
            <span class="p">);</span>
    <span class="p">}</span>
    <span class="n">vGenerateFIFOHeader</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pbyTmpBuff</span><span class="p">,</span> <span class="n">bNeedEncryption</span><span class="p">,</span>
                        <span class="n">cbFrameBodySize</span><span class="p">,</span> <span class="n">TYPE_TXDMA0</span><span class="p">,</span> <span class="n">pHeadTD</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">uMACfragNum</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">cbHeaderSize</span>
                        <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">MACbIsRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_PSCTL</span><span class="p">,</span> <span class="n">PSCTL_PS</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>Disable PS</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MACbPSWakeup</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bPWBitOn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">pLastTD</span> <span class="o">=</span> <span class="n">pHeadTD</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">uMACfragNum</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>Poll Transmit the adapter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">wmb</span><span class="p">();</span>
        <span class="n">pHeadTD</span><span class="o">-&gt;</span><span class="n">m_td0TD0</span><span class="p">.</span><span class="n">f1Owner</span><span class="o">=</span><span class="n">OWNED_BY_NIC</span><span class="p">;</span>
        <span class="n">wmb</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="p">(</span><span class="n">uMACfragNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">pLastTD</span> <span class="o">=</span> <span class="n">pHeadTD</span><span class="p">;</span>
        <span class="n">pHeadTD</span> <span class="o">=</span> <span class="n">pHeadTD</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>Save the information needed by the tx interrupt handler
to complete the Send request</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pLastTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
    <span class="n">pLastTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pLastTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">|=</span> <span class="n">TD_FLAGS_NETIF_SKB</span><span class="p">;</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apCurrTD</span><span class="p">[</span><span class="n">TYPE_TXDMA0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pHeadTD</span><span class="p">;</span>

    <span class="n">MACvTransmit0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>


    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>TYPE_AC0DMA data tx</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>  <span class="nf">device_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="o">=</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="n">PSTxDesc</span>        <span class="n">pHeadTD</span><span class="p">,</span> <span class="n">pLastTD</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byMask</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAID</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uMACfragNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbFrameBodySize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byPktType</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbHeaderSize</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">PSKeyItem</span>       <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">SKeyItem</span>        <span class="n">STempKey</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bTKIP_UseGTK</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bNeedDeAuth</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyBSSID</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bNodeExist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>



    <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bStopDataPkt</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAssocCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
            <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">bNodeExist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">),</span> <span class="n">skb</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>set tx map</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">byMask</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>set tx map</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">wAID</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wAID</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>  <span class="n">byMask</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Set:pMgmt-&gt;abyPSTxMap[%d]= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]);</span>
                    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortPreamble</span><span class="p">;</span>

                <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">PREAMBLE_LONG</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">bNodeExist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">bNodeExist</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;Unknown STA not found in node DB </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
            <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pHeadTD</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apCurrTD</span><span class="p">[</span><span class="n">TYPE_AC0DMA</span><span class="p">];</span>

    <span class="n">pHeadTD</span><span class="o">-&gt;</span><span class="n">m_td1TD1</span><span class="p">.</span><span class="n">byTCR</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCR_EDP</span><span class="o">|</span><span class="n">TCR_STP</span><span class="p">);</span>


    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
    <span class="n">cbFrameBodySize</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>802.1H</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cbFrameBodySize</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>get Transmit key</p></td><td class="code"><div class="highlight"><pre>        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>get pairwise key</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">PAIRWISE_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>get group key</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">GROUP_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">bTKIP_UseGTK</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;Get GTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;Get PTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>

                <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">;</span>  <span class="c1">//TO_DS = 0 and FROM_DS = 0 --&gt; 802.11 MAC Address1</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;IBSS Serach Key: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyBSSID</span><span class="o">+</span><span class="n">ii</span><span class="p">));</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>get pairwise key</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">PAIRWISE_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>get group key</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">GROUP_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;IBSS and KEY is NULL. [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;NOT IBSS and KEY is NULL. [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">bTKIP_UseGTK</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;Get GTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;acdma0: STA index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STempKey</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byCipherSuite</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwKeyIndex</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uWepKeyLength</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwTSC47_16</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTSC15_0</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">abyWepKey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span>
                <span class="p">);</span>
         <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">uMACfragNum</span> <span class="o">=</span> <span class="n">cbGetFragCount</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span> <span class="n">cbFrameBodySize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">uMACfragNum</span> <span class="o">&gt;</span> <span class="n">AVAIL_TD</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_AC0DMA</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;uMACfragNum &gt; AVAIL_TD(TYPE_AC0DMA) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">);</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">==</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uMACfragNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//WEP256 doesn&#39;t support fragment</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">byPktType</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPacketType</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef	PLICE_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Fix Rate: PhyType is %d,ConnectionRate is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">);</span>
<span class="cp">#endif</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&gt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_11M</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&lt;=</span> <span class="n">RATE_6M</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&gt;=</span> <span class="n">RATE_54M</span><span class="p">)</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>

            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byACKRate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>auto rate</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span> <span class="o">==</span> <span class="n">TYPE_PKT_802_1x</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">!=</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byACKRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byACKRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
		<span class="n">VNTWIFIvGetTxRate</span><span class="p">(</span>  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">,</span>
                                <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">),</span>
                                <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byACKRate</span><span class="p">),</span>
                                <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">),</span>
                                <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">));</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">printk(&quot;auto rate:Rate : %d,AckRate:%d,TopCCKRate:%d,TopOFDMRate:%d\n&quot;,</span>
<span class="c">pDevice-&gt;wCurrentRate,pDevice-&gt;byACKRate,</span>
<span class="c">pDevice-&gt;byTopCCKBasicRate,pDevice-&gt;byTopOFDMBasicRate);</span>

<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>

<span class="c">	pDevice-&gt;wCurrentRate = 11;</span>
<span class="c">	pDevice-&gt;byACKRate = 8;</span>
<span class="c">	pDevice-&gt;byTopCCKBasicRate = 3;</span>
<span class="c">	pDevice-&gt;byTopOFDMBasicRate = 8;</span>
<span class="cp">#endif</span>


		<span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO "acdma0: pDevice->wCurrentRate = %d \n", pDevice->wCurrentRate);</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">&lt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11B</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11A</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11GB</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11GA</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><h1>ifdef    PLICE_DEBUG</h1>

<p>printk("FIX RATE:CurrentRate is %d");</p>

<h1>endif</h1></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">bNeedEncryption</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ntohs Pkt Type=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_PKT_802_1x</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Pkt Type=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Don&#39;t Find TX KEY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">bTKIP_UseGTK</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;error: KEY is GTK!!~~</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Find PTK [%lX]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span><span class="p">);</span>
                        <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCntMeasure</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bNeedDeAuth</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">TKIPCounterMeasuresInvoked</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">uNodeIndex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwKeyIndex</span> <span class="o">&amp;</span> <span class="n">PAIRWISE_KEY</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Find PTK [%lX]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span><span class="p">);</span>
                    <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                 <span class="p">}</span>
             <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;return no tx key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>if (skb->len == 98)
{
printk("ping:len is %d\n");
}</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
    <span class="n">vGenerateFIFOHeader</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pbyTmpBuff</span><span class="p">,</span> <span class="n">bNeedEncryption</span><span class="p">,</span>
                        <span class="n">cbFrameBodySize</span><span class="p">,</span> <span class="n">TYPE_AC0DMA</span><span class="p">,</span> <span class="n">pHeadTD</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">uMACfragNum</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">cbHeaderSize</span>
                        <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">MACbIsRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_PSCTL</span><span class="p">,</span> <span class="n">PSCTL_PS</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>Disable PS</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MACbPSWakeup</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bPWBitOn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">pLastTD</span> <span class="o">=</span> <span class="n">pHeadTD</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">uMACfragNum</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>Poll Transmit the adapter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">wmb</span><span class="p">();</span>
        <span class="n">pHeadTD</span><span class="o">-&gt;</span><span class="n">m_td0TD0</span><span class="p">.</span><span class="n">f1Owner</span><span class="o">=</span><span class="n">OWNED_BY_NIC</span><span class="p">;</span>
        <span class="n">wmb</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="n">uMACfragNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pLastTD</span> <span class="o">=</span> <span class="n">pHeadTD</span><span class="p">;</span>
        <span class="n">pHeadTD</span> <span class="o">=</span> <span class="n">pHeadTD</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>Save the information needed by the tx interrupt handler
to complete the Send request</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pLastTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
    <span class="n">pLastTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pLastTD</span><span class="o">-&gt;</span><span class="n">pTDInfo</span><span class="o">-&gt;</span><span class="n">byFlags</span> <span class="o">|=</span> <span class="n">TD_FLAGS_NETIF_SKB</span><span class="p">;</span>
<span class="cp">#ifdef TxInSleep</span>
  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">nTxDataTimeCout</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="c1">//2008-8-21 chester &lt;add&gt; for send null packet</span>
  <span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">AVAIL_TD</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_AC0DMA</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apCurrTD</span><span class="p">[</span><span class="n">TYPE_AC0DMA</span><span class="p">]</span> <span class="o">=</span> <span class="n">pHeadTD</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><h1>ifdef    PLICE_DEBUG</h1></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FixRate:Rate is %d,TxPower is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurPwr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>printk("Auto Rate:Rate is %d,TxPower is %d\n",pDevice->wCurrentRate,pDevice->byCurPwr);</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><h1>endif</h1></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Protocol_Version</span><span class="p">;</span>    <span class="c1">//802.1x Authentication</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Packet_Type</span><span class="p">;</span>           <span class="c1">//802.1x Authentication</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Descriptor_type</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">Key_info</span><span class="p">;</span>
<span class="n">bool</span> <span class="n">bTxeapol_key</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">Protocol_Version</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="p">];</span>
    <span class="n">Packet_Type</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">Descriptor_type</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">Key_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span> <span class="o">==</span> <span class="n">TYPE_PKT_802_1x</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">if</span><span class="p">(((</span><span class="n">Protocol_Version</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span><span class="p">(</span><span class="n">Protocol_Version</span><span class="o">==</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	        <span class="p">(</span><span class="n">Packet_Type</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">//802.1x OR eapol-key challenge frame transfer</span>
                        <span class="n">bTxeapol_key</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span><span class="p">((</span><span class="n">Descriptor_type</span><span class="o">==</span><span class="mi">254</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">Descriptor_type</span><span class="o">==</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>       <span class="c1">//WPA or RSN</span>
                       <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">Key_info</span> <span class="o">&amp;</span> <span class="n">BIT3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>   <span class="c1">//group-key challenge</span>
			   <span class="p">(</span><span class="n">Key_info</span> <span class="o">&amp;</span> <span class="n">BIT8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Key_info</span> <span class="o">&amp;</span> <span class="n">BIT9</span><span class="p">))</span> <span class="p">{</span>    <span class="c1">//send 2/2 key</span>
			  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fWPA_Authened</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			  <span class="k">if</span><span class="p">(</span><span class="n">Descriptor_type</span><span class="o">==</span><span class="mi">254</span><span class="p">)</span>
			      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;WPA &quot;</span><span class="p">);</span>
			  <span class="k">else</span>
			      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;WPA2 &quot;</span><span class="p">);</span>
			  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Authentication completed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
		 <span class="p">}</span>
             <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

    <span class="n">MACvTransmitAC0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO "acdma0:pDevice->apCurrTD= %p\n", pHeadTD);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span>  <span class="n">irqreturn_t</span>  <span class="nf">device_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>  <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="o">=</span><span class="n">dev_instance</span><span class="p">;</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span><span class="o">=</span><span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="kt">int</span>             <span class="n">max_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwMIBCounter</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgPageSel</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span>             <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span>             <span class="n">ii</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>unsigned char byRSSI;</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvReadISR</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dwIsr = 0xffff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/*</span>

<span class="cm">//DIVIDER</span>

<span class="cm">    	if ((pDevice-&gt;dwIsr &amp; ISR_RXDMA0) &amp;&amp;</span>
<span class="cm">        (pDevice-&gt;byLocalID != REV_ID_VT3253_B0) &amp;&amp;</span>
<span class="cm">        (pDevice-&gt;bBSSIDFilter == true)) {</span>

<span class="cm">//DIVIDER</span>
<span class="cm">    }</span>
<span class="cm">    */</span>

    <span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">MACvIntDisable</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>2008-05-21 <mark> by Richardtai, we can't read RSSI here, because no packet bound with RSSI</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_PAGE1SEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgPageSel</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgPageSel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">byOrgPageSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">MACvReadMIBCounter</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwMIBCounter</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div><p>update RSSI
BBbReadEmbeded(pDevice->PortOffset, 0x3E, &amp;byRSSI);
pDevice->uCurrRSSI = byRSSI;</p></td><td class="code"><div class="highlight"><pre>    <span class="n">STAvUpdate802_11Counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span> <span class="p">,</span> <span class="n">dwMIBCounter</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">STAvUpdateIsrStatCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span><span class="p">);</span>
        <span class="n">MACvWriteISR</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_FETALERR</span><span class="p">){</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; ISR_FETALERR </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_SOFTPWRCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_SOFTPWRCTL</span><span class="p">,</span> <span class="n">SOFTPWRCTL_SWPECTI</span><span class="p">);</span>
            <span class="n">device_error</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span> <span class="o">&gt;</span> <span class="n">REV_ID_VT3253_B1</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_MEASURESTART</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>Make sure current page is 0</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOrgChannel</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurrentCh</span><span class="p">;</span>
                <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOrgRCR</span><span class="p">));</span>
                <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="p">(</span><span class="n">RCR_RXALLTYPE</span> <span class="o">|</span> <span class="n">RCR_UNICAST</span> <span class="o">|</span> <span class="n">RCR_BROADCAST</span> <span class="o">|</span> <span class="n">RCR_MULTICAST</span> <span class="o">|</span> <span class="n">RCR_WPAERR</span><span class="p">));</span>
                <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwOrgMAR0</span><span class="p">));</span>
                <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MAR4</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwOrgMAR4</span><span class="p">));</span>
                <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>TBD....
Must do this after doing rx/tx, cause ISR bit is slow
than RD/TD write back
update ISR counter</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">set_channel</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pCurrMeasureEID</span><span class="o">-&gt;</span><span class="n">sReq</span><span class="p">.</span><span class="n">byChannel</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bMeasureInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                    <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_MSRCTL</span><span class="p">,</span> <span class="n">MSRCTL_READY</span><span class="p">);</span>
                    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBasicMap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCCAFraction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwRPIs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>802.11h measure start</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_MSRCTL</span><span class="p">,</span> <span class="n">MSRCTL_EN</span><span class="p">);</span>
                    <span class="n">s_vCompleteCurrentMeasure</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">MEASURE_MODE_INCAPABLE</span><span class="p">);</span>
                    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                    <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_MSRCTL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">MSRCTL1_TXPAUSE</span><span class="p">);</span>
                    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_MEASUREEND</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-133"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-133">&#182;</a></div><p>xxxx
WCMDbFlushCommandQueue(pDevice->pMgmt, true);</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bMeasureInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOrgRCR</span><span class="p">);</span>
                <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwOrgMAR0</span><span class="p">);</span>
                <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MAR4</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwOrgMAR4</span><span class="p">);</span>
                <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MSRBBSTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBasicMap</span> <span class="o">|=</span> <span class="p">(</span><span class="n">byData</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_CCAFRACTION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCCAFraction</span><span class="p">);</span>
                <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MSRCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-134"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-134">&#182;</a></div><p>can not measure because set channel fail
WCMDbResetCommandQueue(pDevice->pMgmt);
clear measure control</p></td><td class="code"><div class="highlight"><pre>                <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_MSRCTL</span><span class="p">,</span> <span class="n">MSRCTL_EN</span><span class="p">);</span>
                <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                <span class="n">set_channel</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOrgChannel</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-135"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-135">&#182;</a></div><p>802.11h measure end</p></td><td class="code"><div class="highlight"><pre>                <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_MSRCTL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">MSRCTL1_TXPAUSE</span><span class="p">);</span>
                <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">MSRCTL_FINISH</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-136"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-136">&#182;</a></div><p>clear measure control</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">s_vCompleteCurrentMeasure</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-137"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-137">&#182;</a></div><p>WCMDbResetCommandQueue(pDevice->pMgmt);</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">s_vCompleteCurrentMeasure</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">MEASURE_MODE_LATE</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_QUIETSTART</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">do</span> <span class="p">{</span>
                    <span class="p">;</span>
                <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">CARDbStartQuiet</span><span class="p">(</span><span class="n">pDevice</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_TBTT</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableFirstQuiet</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byQuietStartCount</span><span class="o">--</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byQuietStartCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableFirstQuiet</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                    <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_MSRCTL</span><span class="p">,</span> <span class="p">(</span><span class="n">MSRCTL_QUIETTXCHK</span> <span class="o">|</span> <span class="n">MSRCTL_QUIETEN</span><span class="p">));</span>
                    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bChannelSwitch</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_INFRASTRUCTURE</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byChannelSwitchCount</span><span class="o">--</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byChannelSwitchCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bChannelSwitch</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="n">set_channel</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byNewChannel</span><span class="p">);</span>
                    <span class="n">VNTWIFIbChannelSwitch</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byNewChannel</span><span class="p">);</span>
                    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                    <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_MSRCTL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">MSRCTL1_TXPAUSE</span><span class="p">);</span>
                    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                    <span class="n">CARDbStartTxPacket</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">PKT_TYPE_802_11_ALL</span><span class="p">);</span>

                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-138"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-138">&#182;</a></div><p>measure success</p></td><td class="code"><div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bUpdateBBVGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrRSSI</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                    <span class="kt">long</span>            <span class="n">ldBm</span><span class="p">;</span>

                    <span class="n">RFvRSSITodBm</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrRSSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ldBm</span><span class="p">);</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">BB_VGA_LEVEL</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ldBm</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ldBmThreshold</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="p">{</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBBVGA</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span> <span class="o">!=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span><span class="o">++</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-139"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-139">&#182;</a></div><p>can not measure because not ready before end of measure time</p></td><td class="code"><div class="highlight"><pre>                            <span class="n">BBvSetVGAGainOffset</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span><span class="p">);</span>
                            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;First RSSI[%d] NewGain[%d] OldGain[%d] Count[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                            <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ldBm</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span> <span class="o">&gt;=</span> <span class="n">BB_VGA_CHANGE_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;RSSI[%d] NewGain[%d] OldGain[%d] Count[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                            <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ldBm</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span><span class="p">);</span>
                            <span class="n">BBvSetVGAGainOffset</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBeaconSent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnablePSMode</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PSbIsNextTBTTWakeUp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">))</span> <span class="p">{</span>

                <span class="n">MACvOneShotTimer1MicroSec</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wIBSSBeaconPeriod</span> <span class="o">-</span> <span class="n">MAKE_BEACON_RESERVED</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span> <span class="o">&amp;&amp;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrATIMWindow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-140"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-140">&#182;</a></div><p>pDevice->bBeaconSent = false;</p></td><td class="code"><div class="highlight"><pre>            <span class="p">}</span>

        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_BNTX</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bIsBeaconBufReadySet</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbBeaconBufReadySetCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                   <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span> <span class="o">--</span><span class="p">;</span>
                   <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bRxPSPoll</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-141"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-141">&#182;</a></div><p>first VGA diff gain</p></td><td class="code"><div class="highlight"><pre>                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMPeriod</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bRxPSPoll</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_RX_PSPOLL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBeaconSent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bChannelSwitch</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byChannelSwitchCount</span><span class="o">--</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byChannelSwitchCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bChannelSwitch</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="n">set_channel</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byNewChannel</span><span class="p">);</span>
                    <span class="n">VNTWIFIbChannelSwitch</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byNewChannel</span><span class="p">);</span>
                    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                    <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_MSRCTL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">MSRCTL1_TXPAUSE</span><span class="p">);</span>
                    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-142"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-142">&#182;</a></div><p>todo adhoc PS mode</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">CARDbStartTxPacket</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">PKT_TYPE_802_11_ALL</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_RXDMA0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">max_count</span> <span class="o">+=</span> <span class="n">device_rx_srv</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_RXDMA0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_RXDMA1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">max_count</span> <span class="o">+=</span> <span class="n">device_rx_srv</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_RXDMA1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_TXDMA0</span><span class="p">){</span>
            <span class="n">max_count</span> <span class="o">+=</span> <span class="n">device_tx_srv</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_TXDMA0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_AC0DMA</span><span class="p">){</span>
            <span class="n">max_count</span> <span class="o">+=</span> <span class="n">device_tx_srv</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_AC0DMA</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_SOFTTIMER</span><span class="p">)</span> <span class="p">{</span>

        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span> <span class="o">&amp;</span> <span class="n">ISR_SOFTTIMER1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bShortSlotTime</span><span class="p">)</span>
                   <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTSLOTTIME</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
               <span class="k">else</span>
                   <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WLAN_SET_CAP_INFO_SHORTSLOTTIME</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="n">bMgrPrepareBeaconToSend</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">);</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCntMeasure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">MACvReadISR</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIsr</span><span class="p">);</span>

        <span class="n">MACvReceive0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
        <span class="n">MACvReceive1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">max_count</span><span class="o">&gt;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sOpts</span><span class="p">.</span><span class="n">int_works</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgPageSel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">MACvIntEnable</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">IMR_MASK_VALUE</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="k">const</span> <span class="n">ethernet_polynomial</span> <span class="o">=</span> <span class="mh">0x04c11db7U</span><span class="p">;</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">ether_crc</span><span class="p">(</span><span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">crc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">current_octet</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">,</span> <span class="n">current_octet</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span>
                <span class="p">((</span><span class="n">crc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">current_octet</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">ethernet_polynomial</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-143"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-143">&#182;</a></div><p>check if mutltcast tx bufferring</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">Config_FileGetParameter</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf1</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">source_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
    <span class="n">strcat</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
    <span class="n">strcat</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">);</span>
    <span class="n">source</span><span class="o">+=</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf1</span><span class="p">);</span>

   <span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">source_len</span><span class="o">-</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf1</span><span class="p">));</span>
 <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Config_FileOperation</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span><span class="n">bool</span> <span class="n">fwrite</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Parameter</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config_path</span> <span class="o">=</span> <span class="n">CONFIG_PATH</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmpbuffer</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">file</span>   <span class="o">*</span><span class="n">filp</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-144"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-144">&#182;</a></div><p>VNTWIFIbSendBeacon(pDevice->pMgmt);</p></td><td class="code"><div class="highlight"><pre>    <span class="kt">int</span> <span class="n">result</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="n">set_fs</span> <span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>

    <span class="cm">/* Can&#39;t do this anymore, so we rely on correct filesystem permissions:</span>

<span class="cm">//DIVIDER</span>
<span class="cm">    oldfsuid=current-&gt;cred-&gt;fsuid;</span>
<span class="cm">    oldfsgid=current-&gt;cred-&gt;fsgid;</span>
<span class="cm">    current-&gt;cred-&gt;fsuid = 0;</span>
<span class="cm">    current-&gt;cred-&gt;fsgid = 0;</span>
<span class="cm">    */</span></pre></div></td></tr>


<tr id="section-145"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-145">&#182;</a></div><p>2008-8-4 <add> by chester</p></td><td class="code"><div class="highlight"><pre>      <span class="n">filp</span> <span class="o">=</span> <span class="n">filp_open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span> <span class="p">{</span>
	     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Config_FileOperation:open file fail?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	     <span class="n">result</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
             <span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	  <span class="p">}</span>

     <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="o">||!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">))</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;file %s cann&#39;t readable or writable?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">config_path</span><span class="p">);</span>
	  <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	  <span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
     	<span class="p">}</span>

<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;allocate mem for file fail?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">printk</span><span class="p">(</span><span class="s">&quot;read file error?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
 <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
 <span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="n">Config_FileGetParameter</span><span class="p">(</span><span class="s">&quot;ZONETYPE&quot;</span><span class="p">,</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="n">buffer</span><span class="p">)</span><span class="o">!=</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;get parameter error?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="s">&quot;USA&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">result</span><span class="o">=</span><span class="n">ZoneType_USA</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="s">&quot;JAPAN&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">result</span><span class="o">=</span><span class="n">ZoneType_Japan</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="s">&quot;EUROPE&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">result</span><span class="o">=</span><span class="n">ZoneType_Europe</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown Zonetype[%s]?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">tmpbuffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="nl">error1:</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">filp_close</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span><span class="nb">NULL</span><span class="p">))</span>
       <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Config_FileOperation:close file fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">error2:</span>
  <span class="n">set_fs</span> <span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">  current-&gt;cred-&gt;fsuid=oldfsuid;</span>
<span class="cm">  current-&gt;cred-&gt;fsgid=oldfsgid;</span>
<span class="cm">  */</span>

  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span>         <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">PSMgmtObject</span>     <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="n">u32</span>              <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>


    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>         <span class="cm">/* Set promiscuous. */</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Promiscuous mode enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="cm">/* Unconditionally log net taps. */</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_MULTICAST</span><span class="o">|</span><span class="n">RCR_BROADCAST</span><span class="o">|</span><span class="n">RCR_UNICAST</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">multicast_limit</span><span class="p">)</span>
        <span class="o">||</span>  <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
        <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_MULTICAST</span><span class="o">|</span><span class="n">RCR_BROADCAST</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">bit_nr</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">;</span>
            <span class="n">mc_filter</span><span class="p">[</span><span class="n">bit_nr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_nr</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RCR_UNICAST</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_MULTICAST</span><span class="o">|</span><span class="n">RCR_BROADCAST</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-146"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-146">&#182;</a></div><p>int oldfsuid=0,oldfsgid=0;</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_MULTICAST</span><span class="o">|</span><span class="n">RCR_BROADCAST</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RCR_UNICAST</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;pDevice-&gt;byRxMode = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">device_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="o">=</span><span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span>  <span class="nf">device_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="n">wrq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span>                 <span class="n">rc</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="n">PSCmdRequest</span>        <span class="n">pReq</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SIOCGIWNAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwname</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWNWID</span>:     <span class="c1">//0x8b03  support</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-147"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-147">&#182;</a></div><p>Make sure a caller can read or write power as root</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWFREQ</span>:
	    <span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-148"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-148">&#182;</a></div><p>open file</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWFREQ</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-149"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-149">&#182;</a></div><p>If AP mode, don't enable RCR_UNICAST. Since hw only compare addr1 with local mac.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWESSID</span>:

		<span class="p">{</span>
			<span class="kt">char</span> <span class="n">essid</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">essid</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
					   <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwessid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">),</span> <span class="n">essid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-150"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-150">&#182;</a></div><p>Set frequency/channel</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWESSID</span>:

		<span class="p">{</span>
			<span class="kt">char</span> <span class="n">essid</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwessid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">),</span> <span class="n">essid</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
						         <span class="n">essid</span><span class="p">,</span>
						         <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWAP</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-151"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-151">&#182;</a></div><p>Get frequency/channel</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWAP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-152"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-152">&#182;</a></div><p>Set desired network name (ESSID)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWNICKN</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWNICKN </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-153"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-153">&#182;</a></div><p>Get current network name (ESSID)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWNICKN</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWNICKN </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-154"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-154">&#182;</a></div><p>Get current Access Point (BSSID)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWRATE</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwrate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-155"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-155">&#182;</a></div><p>Set desired station name</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWRATE</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwrate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-156"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-156">&#182;</a></div><p>Get current station name</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWRTS</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwrts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rts</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-157"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-157">&#182;</a></div><p>Set the desired bit-rate</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWRTS</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwrts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rts</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-158"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-158">&#182;</a></div><p>Get the current bit-rate</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWFRAG</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwfrag</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frag</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-159"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-159">&#182;</a></div><p>Set the desired RTS threshold</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWFRAG</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwfrag</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frag</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-160"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-160">&#182;</a></div><p>Get the current RTS threshold</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWMODE</span>:
    	<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-161"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-161">&#182;</a></div><p>Set the desired fragmentation threshold</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWMODE</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-162"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-162">&#182;</a></div><p>Get the current fragmentation threshold</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWENCODE</span>:
		<span class="p">{</span>
            <span class="kt">char</span> <span class="n">abyKey</span><span class="p">[</span><span class="n">WLAN_WEP232_KEYLEN</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>


				<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">abyKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">abyKey</span><span class="p">,</span>
				                  <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
				                  <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwencode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">),</span> <span class="n">abyKey</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-163"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-163">&#182;</a></div><p>Set mode of operation</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWENCODE</span>:

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">{</span>
		    <span class="kt">char</span> <span class="n">abyKey</span><span class="p">[</span><span class="n">WLAN_WEP232_KEYLEN</span><span class="p">];</span>

		    <span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwencode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">),</span> <span class="n">abyKey</span><span class="p">);</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
						        <span class="n">abyKey</span><span class="p">,</span>
						        <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span><span class="p">))</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-164"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-164">&#182;</a></div><p>Get mode of operation</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWTXPOW</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWTXPOW </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWTXPOW</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWTXPOW </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWRETRY</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwretry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">retry</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWRETRY</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwretry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">retry</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-165"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-165">&#182;</a></div><p>Set WEP keys and mode</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWRANGE</span>:

		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">iw_range</span> <span class="n">range</span><span class="p">;</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwrange</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">range</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">)))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWPOWER</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwpower</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">power</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">SIOCSIWPOWER</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwpower</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">power</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">SIOCGIWSENS</span>:

	    <span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwsens</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sens</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWSENS</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWSENS </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWAPLIST</span>:
	    <span class="p">{</span>
            <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IW_MAX_AP</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">))];</span>

		    <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwaplist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="n">buffer</span><span class="p">);</span>
		        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
					                <span class="n">buffer</span><span class="p">,</span>
					               <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">+</span>  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">)))</span>
				        <span class="p">))</span>
				    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		        <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>


<span class="cp">#ifdef WIRELESS_SPY</span></pre></div></td></tr>


<tr id="section-166"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-166">&#182;</a></div><p>Get the WEP keys and mode</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWSPY</span>:

        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWSPY </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-167"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-167">&#182;</a></div><p>Get the current Tx-Power</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWSPY</span>:

        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWSPY </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#endif </span><span class="c1">// WIRELESS_SPY</span>

	<span class="k">case</span> <span class="n">SIOCGIWPRIV</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWPRIV </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">		if(wrq-&gt;u.data.pointer) {</span>
<span class="cm">			wrq-&gt;u.data.length = sizeof(iwctl_private_args) / sizeof( iwctl_private_args[0]);</span>

<span class="cm">			if(copy_to_user(wrq-&gt;u.data.pointer,</span>
<span class="cm">					(u_char *) iwctl_private_args,</span>
<span class="cm">					sizeof(iwctl_private_args)))</span>
<span class="cm">				rc = -EFAULT;</span>
<span class="cm">		}</span>
<span class="cm">*/</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-168"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-168">&#182;</a></div><p>Get range of parameters</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef  WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
	<span class="k">case</span> <span class="n">SIOCSIWAUTH</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWAUTH </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwauth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">param</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWAUTH</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWAUTH </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwauth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">param</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWGENIE</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWGENIE </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwgenie</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWGENIE</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWGENIE </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwgenie</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWENCODEEXT</span>:
		<span class="p">{</span>
			<span class="kt">char</span> <span class="n">extra</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">)</span><span class="o">+</span><span class="n">MAX_KEY_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWENCODEEXT </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">){</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">)</span><span class="o">+</span><span class="n">MAX_KEY_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">)</span><span class="o">+</span> <span class="n">MAX_KEY_LEN</span><span class="p">)){</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span><span class="p">)){</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwencodeext</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">),</span> <span class="n">extra</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWENCODEEXT</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWENCODEEXT </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwencodeext</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWMLME</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWMLME </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwmlme</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#endif </span><span class="c1">// #ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-169"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-169">&#182;</a></div><p>Set the spy list</p></td><td class="code"><div class="highlight"><pre>    <span class="k">case</span> <span class="n">IOCTL_CMD_TEST</span>:

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
        <span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSCmdRequest</span><span class="p">)</span><span class="n">rq</span><span class="p">;</span>
        <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">wResult</span> <span class="o">=</span> <span class="n">MAGIC_CODE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">IOCTL_CMD_SET</span>:

               <span class="cp">#ifdef SndEvt_ToAPI</span>
                  <span class="k">if</span><span class="p">((((</span><span class="n">PSCmdRequest</span><span class="p">)</span><span class="n">rq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wCmdCode</span> <span class="o">!=</span><span class="n">WLAN_CMD_SET_EVT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span>
	      <span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(((</span><span class="n">PSCmdRequest</span><span class="p">)</span><span class="n">rq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wCmdCode</span> <span class="o">!=</span><span class="n">WLAN_CMD_SET_WPA</span><span class="p">))</span>
	      <span class="cp">#endif</span>
		<span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCmdBusy</span><span class="p">)))</span> <span class="p">{</span>
		    <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	    <span class="p">}</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">private_ioctl</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
        <span class="n">clear_bit</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCmdBusy</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">IOCTL_CMD_HOSTAPD</span>:


	<span class="n">rc</span> <span class="o">=</span> <span class="n">vt6655_hostap_ioctl</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">IOCTL_CMD_WPA</span>:

	<span class="n">rc</span> <span class="o">=</span> <span class="n">wpa_ioctl</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCETHTOOL</span>:
        <span class="k">return</span> <span class="n">ethtool_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-170"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-170">&#182;</a></div><p>Get the spy list</p></td><td class="code"><div class="highlight"><pre>	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Ioctl command not support..%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>


    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCommit</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
           <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
           <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_RUN_AP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
           <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="p">{</span>
           <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Commit the settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
           <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
           <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
           <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
	      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_ACTIVE</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPASuppWextEnabled</span> <span class="o">!=</span><span class="nb">true</span><span class="p">)</span>
	 <span class="cp">#endif</span>
           <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
           <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_SSID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
           <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCommit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ethtool_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">useraddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ethcmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethcmd</span><span class="p">,</span> <span class="n">useraddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ethcmd</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">ethcmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GDRVINFO</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="n">ETHTOOL_GDRVINFO</span><span class="p">};</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">DEVICE_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">version</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">useraddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">vt6655_pci_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">device_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DEVICE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">vt6655_pci_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">vt6655_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">vt6655_remove</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">viawget_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">viawget_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vt6655_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-171"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-171">&#182;</a></div><p>2008-0409-07, <Add> by Einsn Liu</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_driver</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_notifier</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">vt6655_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>


<span class="cp">#ifdef CONFIG_PM</span>
    <span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_notifier</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_driver</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">vt6655_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">vt6655_cleanup_module</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">device_notify_reboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">SYS_DOWN</span>:
    <span class="k">case</span> <span class="n">SYS_HALT</span>:
    <span class="k">case</span> <span class="n">SYS_POWER_OFF</span>:
	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">pci_dev_driver</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">device_driver</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
                    <span class="n">viawget_suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PMSG_HIBERNATE</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">viawget_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcid</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">power_status</span><span class="p">;</span>   <span class="c1">// to silence the compiler</span>

    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="o">=</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pcid</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>  <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>

    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">pci_save_state</span><span class="p">(</span><span class="n">pcid</span><span class="p">);</span>
    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span>
    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeCmdQueue</span> <span class="o">=</span> <span class="n">CMD_Q_SIZE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdDequeueIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdRunning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">MACbShutdown</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">MACvSaveContext</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyMacContext</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
    <span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pcid</span><span class="p">);</span>
    <span class="n">power_status</span> <span class="o">=</span> <span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">viawget_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcid</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>  <span class="n">pDevice</span><span class="o">=</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pcid</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>  <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">power_status</span><span class="p">;</span>   <span class="c1">// to silence the compiler</span>


    <span class="n">power_status</span> <span class="o">=</span> <span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">power_status</span> <span class="o">=</span> <span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pcid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pcid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="n">MACvRestoreContext</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyMacContext</span><span class="p">);</span>
        <span class="n">device_init_registers</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DEVICE_INIT_DXPL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Assoc with BSS</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-172"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-172">&#182;</a></div><p>End Add -- //2008-0409-07, <Add> by Einsn Liu</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_STARTED</span><span class="p">;</span>
           <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_STANDBY</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">);</span>
        <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span>
        <span class="n">MACvIntEnable</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">IMR_MASK_VALUE</span><span class="p">);</span>
        <span class="n">BSSvClearBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span><span class="p">);</span>
        <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_SSID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>


<tr id="section-173"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-173">&#182;</a></div><p>All other calls are currently unsupported</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-174"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-174">&#182;</a></div><p>ret=pci<em>module</em>init(&amp;device<em>driver);
ret = pcie</em>port<em>service</em>register(&amp;device_driver);</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-175"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-175">&#182;</a></div><p>In Adhoc, BSS state set back to started.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
