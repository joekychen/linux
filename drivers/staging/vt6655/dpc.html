<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6655 › dpc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dpc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * File: dpc.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: handle dpc rx functions</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Lyndon Chen</span>
<span class="cm"> *</span>
<span class="cm"> * Date: May 20, 2003</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *      device_receive_frame - Rcv 802.11 frame function</span>
<span class="cm"> *      s_bAPModeRxCtl- AP Rcv frame filer Ctl.</span>
<span class="cm"> *      s_bAPModeRxData- AP Rcv data frame handle</span>
<span class="cm"> *      s_bHandleRxEncryption- Rcv decrypted data via on-fly</span>
<span class="cm"> *      s_bHostWepRxEncryption- Rcv encrypted data via host</span>
<span class="cm"> *      s_byGetRateIdx- get rate index</span>
<span class="cm"> *      s_vGetDASA- get data offset</span>
<span class="cm"> *      s_vProcessRxMACHeader- Rcv 802.11 and translate to 802.3</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;rxtx.h&quot;</span>
<span class="cp">#include &quot;tether.h&quot;</span>
<span class="cp">#include &quot;card.h&quot;</span>
<span class="cp">#include &quot;bssdb.h&quot;</span>
<span class="cp">#include &quot;mac.h&quot;</span>
<span class="cp">#include &quot;baseband.h&quot;</span>
<span class="cp">#include &quot;michael.h&quot;</span>
<span class="cp">#include &quot;tkip.h&quot;</span>
<span class="cp">#include &quot;tcrc.h&quot;</span>
<span class="cp">#include &quot;wctl.h&quot;</span>
<span class="cp">#include &quot;wroute.h&quot;</span>
<span class="cp">#include &quot;hostap.h&quot;</span>
<span class="cp">#include &quot;rf.h&quot;</span>
<span class="cp">#include &quot;iowpa.h&quot;</span>
<span class="cp">#include &quot;aes_ccmp.h&quot;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define    PLICE_DEBUG</h1></td><td class="code"><div class="highlight"><pre><span class="cm">/*---------------------  Static Definitions -------------------------*/</span>

<span class="cm">/*---------------------  Static Classes  ----------------------------*/</span>

<span class="cm">/*---------------------  Static Variables  --------------------------*/</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>static int          msglevel                =MSG<em>LEVEL</em>DEBUG;</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span><span class="n">MSG_LEVEL_INFO</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">acbyRxRate</span><span class="p">[</span><span class="n">MAX_RATE</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">108</span><span class="p">};</span>


<span class="cm">/*---------------------  Static Functions  --------------------------*/</span>

<span class="cm">/*---------------------  Static Definitions -------------------------*/</span>

<span class="cm">/*---------------------  Static Functions  --------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">s_byGetRateIdx</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byRate</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="n">s_vGetDASA</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRxBufferAddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pcbHeaderSize</span><span class="p">,</span>
		<span class="n">PSEthernetHeader</span> <span class="n">psEthHeader</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">s_vProcessRxMACHeader</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRxBufferAddr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbPacketSize</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bIsWEP</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bExtIV</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pcbHeadSize</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">s_bAPModeRxCtl</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyFrame</span><span class="p">,</span>
    <span class="kt">int</span>      <span class="n">iSANodeIndex</span>
    <span class="p">);</span>



<span class="k">static</span> <span class="n">bool</span> <span class="n">s_bAPModeRxData</span> <span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FrameSize</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbHeaderOffset</span><span class="p">,</span>
    <span class="kt">int</span>      <span class="n">iSANodeIndex</span><span class="p">,</span>
    <span class="kt">int</span>      <span class="n">iDANodeIndex</span>
    <span class="p">);</span>


<span class="k">static</span> <span class="n">bool</span> <span class="n">s_bHandleRxEncryption</span><span class="p">(</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyFrame</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FrameSize</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRsr</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyNewRsr</span><span class="p">,</span>
    <span class="n">PSKeyItem</span>   <span class="o">*</span><span class="n">pKeyOut</span><span class="p">,</span>
    <span class="n">bool</span> <span class="o">*</span><span class="n">pbExtIV</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pwRxTSC15_0</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pdwRxTSC47_16</span>
    <span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">s_bHostWepRxEncryption</span><span class="p">(</span>

    <span class="n">PSDevice</span>     <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyFrame</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FrameSize</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRsr</span><span class="p">,</span>
    <span class="n">bool</span> <span class="n">bOnFly</span><span class="p">,</span>
    <span class="n">PSKeyItem</span>    <span class="n">pKey</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyNewRsr</span><span class="p">,</span>
    <span class="n">bool</span> <span class="o">*</span><span class="n">pbExtIV</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pwRxTSC15_0</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pdwRxTSC47_16</span>

    <span class="p">);</span>

<span class="cm">/*---------------------  Export Variables  --------------------------*/</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *    Translate Rcv 802.11 header to 802.3 header with Rx buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice</span>
<span class="cm"> *      dwRxBufferAddr  - Address of Rcv Buffer</span>
<span class="cm"> *      cbPacketSize    - Rcv Packet size</span>
<span class="cm"> *      bIsWEP          - If Rcv with WEP</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      pcbHeaderSize   - 802.11 header size</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: None</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">s_vProcessRxMACHeader</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRxBufferAddr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbPacketSize</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bIsWEP</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bExtIV</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pcbHeadSize</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRxBuffer</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbHeaderSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pwType</span><span class="p">;</span>
    <span class="n">PS802_11Header</span>  <span class="n">pMACHeader</span><span class="p">;</span>
    <span class="kt">int</span>             <span class="n">ii</span><span class="p">;</span>


    <span class="n">pMACHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyRxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>

    <span class="n">s_vGetDASA</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pMACHeader</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbHeaderSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxEthHeader</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bExtIV</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>strip IV&amp;ExtIV , add 8 byte</p></td><td class="code"><div class="highlight"><pre>            <span class="n">cbHeaderSize</span> <span class="o">+=</span> <span class="p">(</span><span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>strip IV , add 4 byte</p></td><td class="code"><div class="highlight"><pre>            <span class="n">cbHeaderSize</span> <span class="o">+=</span> <span class="p">(</span><span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">cbHeaderSize</span> <span class="o">+=</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="n">pbyRxBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyRxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">pbyRxBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abySNAP_Bridgetunnel</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
        <span class="n">cbHeaderSize</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">pbyRxBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abySNAP_RFC1042</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
        <span class="n">cbHeaderSize</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
        <span class="n">pwType</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyRxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pwType</span><span class="o">!=</span> <span class="n">TYPE_PKT_IPX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">pwType</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xF380</span><span class="p">)))</span> <span class="p">{</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">cbHeaderSize</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">pwType</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyRxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bExtIV</span><span class="p">)</span> <span class="p">{</span>
                    <span class="o">*</span><span class="n">pwType</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cbPacketSize</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>    <span class="c1">// 8 is IV&amp;ExtIV</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="o">*</span><span class="n">pwType</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cbPacketSize</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>    <span class="c1">// 4 is IV</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">pwType</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cbPacketSize</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">cbHeaderSize</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">pwType</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyRxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bExtIV</span><span class="p">)</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">pwType</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cbPacketSize</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>    <span class="c1">// 8 is IV&amp;ExtIV</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">pwType</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cbPacketSize</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>    <span class="c1">// 4 is IV</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pwType</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cbPacketSize</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">cbHeaderSize</span> <span class="o">-=</span> <span class="p">(</span><span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">pbyRxBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyRxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span>
        <span class="o">*</span><span class="n">pbyRxBuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span>
        <span class="o">*</span><span class="n">pbyRxBuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxEthHeader</span><span class="p">.</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>

    <span class="o">*</span><span class="n">pcbHeadSize</span> <span class="o">=</span> <span class="n">cbHeaderSize</span><span class="p">;</span>
<span class="p">}</span>




<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">s_byGetRateIdx</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byRate</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byRateIdx</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">byRateIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">byRateIdx</span> <span class="o">&lt;</span><span class="n">MAX_RATE</span> <span class="p">;</span> <span class="n">byRateIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">acbyRxRate</span><span class="p">[</span><span class="n">byRateIdx</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">]</span> <span class="o">==</span> <span class="n">byRate</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">byRateIdx</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">s_vGetDASA</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRxBufferAddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pcbHeaderSize</span><span class="p">,</span>
	<span class="n">PSEthernetHeader</span> <span class="n">psEthHeader</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbHeaderSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PS802_11Header</span>  <span class="n">pMACHeader</span><span class="p">;</span>
    <span class="kt">int</span>             <span class="n">ii</span><span class="p">;</span>

    <span class="n">pMACHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyRxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">&amp;</span> <span class="n">FC_TODS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">&amp;</span> <span class="n">FC_FROMDS</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr1</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
                <span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>IBSS mode</p></td><td class="code"><div class="highlight"><pre>            <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr1</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
                <span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Is AP mode..</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">&amp;</span> <span class="n">FC_FROMDS</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
                <span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr4</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
                <span class="n">cbHeaderSize</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">ETH_ALEN</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
                <span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="o">*</span><span class="n">pcbHeaderSize</span> <span class="o">=</span> <span class="n">cbHeaderSize</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>PLICE_DEBUG -></p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span>	<span class="nf">MngWorkItem</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">Context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSRxMgmtPacket</span>			<span class="n">pRxMgmtPacket</span><span class="p">;</span>
	<span class="n">PSDevice</span>	<span class="n">pDevice</span> <span class="o">=</span>  <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">Context</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>printk("Enter MngWorkItem,Queue packet num is %d\n",pDevice->rxManeQueue.packet_num);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	 <span class="k">while</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rxManeQueue</span><span class="p">.</span><span class="n">packet_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	 <span class="p">{</span>
		 <span class="n">pRxMgmtPacket</span> <span class="o">=</span>  <span class="n">DeQueue</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
        		<span class="n">vMgrRxManagePacket</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxMgmtPacket</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>PLICE_DEBUG&lt;-</p></td><td class="code"><div class="highlight"><pre><span class="n">bool</span>
<span class="nf">device_receive_frame</span> <span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSRxDesc</span> <span class="n">pCurrRD</span>
    <span class="p">)</span>
<span class="p">{</span>

    <span class="n">PDEVICE_RD_INFO</span>  <span class="n">pRDInfo</span> <span class="o">=</span> <span class="n">pCurrRD</span><span class="o">-&gt;</span><span class="n">pRDInfo</span><span class="p">;</span>
<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>printk("device<em>receive</em>frame:pCurrRD is %x,pRDInfo is %x\n",pCurrRD,pCurrRD->pRDInfo);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
    <span class="k">struct</span> <span class="n">net_device_stats</span><span class="o">*</span> <span class="n">pStats</span><span class="o">=&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="n">PSRxMgmtPacket</span>  <span class="n">pRxPacket</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sRxPacket</span><span class="p">);</span>
    <span class="n">PS802_11Header</span>  <span class="n">p802_11Header</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRsr</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyNewRsr</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRSSI</span><span class="p">;</span>
    <span class="n">PQWORD</span>          <span class="n">pqwTSFTime</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pwFrameSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyFrame</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bDeFragRx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bIsWEP</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbHeaderOffset</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FrameSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wEtherType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span>             <span class="n">iSANodeIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span>             <span class="n">iDANodeIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbIVOffset</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bExtIV</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRxSts</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRxRate</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbySQ</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbHeaderSize</span><span class="p">;</span>
    <span class="n">PSKeyItem</span>       <span class="n">pKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wRxTSC15_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwRxTSC47_16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">SKeyItem</span>        <span class="n">STempKey</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>802.11h RPI</p></td><td class="code"><div class="highlight"><pre>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwDuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">long</span>            <span class="n">ldBm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">long</span>            <span class="n">ldBmThreshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PS802_11Header</span> <span class="n">pMACHeader</span><span class="p">;</span>
 <span class="n">bool</span> <span class="n">bRxeapol_key</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"---------- device<em>receive</em>frame---\n");</p></td><td class="code"><div class="highlight"><pre>    <span class="n">skb</span> <span class="o">=</span> <span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>PLICE_DEBUG-></p></td><td class="code"><div class="highlight"><pre><span class="cp">#if 1</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pcid</span><span class="p">,</span> <span class="n">pRDInfo</span><span class="o">-&gt;</span><span class="n">skb_dma</span><span class="p">,</span>
                     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>PLICE_DEBUG&lt;-</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pwFrameSize</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">FrameSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pCurrRD</span><span class="o">-&gt;</span><span class="n">m_rd1RD1</span><span class="p">.</span><span class="n">wReqCount</span><span class="p">)</span> <span class="o">-</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pCurrRD</span><span class="o">-&gt;</span><span class="n">m_rd0RD0</span><span class="p">.</span><span class="n">wResCount</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Max: 2312Payload + 30HD +4CRC + 2Padding + 4Len + 8TSF + 4RSR
Min (ACK): 10HD +4CRC + 2Padding + 4Len + 8TSF + 4RSR</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">FrameSize</span> <span class="o">&gt;</span> <span class="mi">2364</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">FrameSize</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Frame Size error drop this packet.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;---------- WRONG Length 1 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pbyRxSts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
    <span class="n">pbyRxRate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">pbyRsr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">FrameSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">pbyRSSI</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">FrameSize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">pbyNewRsr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">FrameSize</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">pbySQ</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">FrameSize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">pqwTSFTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PQWORD</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">FrameSize</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span>
    <span class="n">pbyFrame</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>get packet size</p></td><td class="code"><div class="highlight"><pre>    <span class="n">FrameSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">pwFrameSize</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">FrameSize</span> <span class="o">&gt;</span> <span class="mi">2346</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">FrameSize</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// Max: 2312Payload + 30HD +4CRC</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Min: 14 bytes ACK</p></td><td class="code"><div class="highlight"><pre>        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;---------- WRONG Length 2 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>PLICE_DEBUG-></p></td><td class="code"><div class="highlight"><pre><span class="cp">#if 1</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>update receive statistic counter</p></td><td class="code"><div class="highlight"><pre>    <span class="n">STAvUpdateRDStatCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">pbyRsr</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">pbyNewRsr</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">pbyRxRate</span><span class="p">,</span>
                            <span class="n">pbyFrame</span><span class="p">,</span>
                            <span class="n">FrameSize</span><span class="p">);</span>

<span class="cp">#endif</span>

  <span class="n">pMACHeader</span><span class="o">=</span><span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>PLICE_DEBUG&lt;-</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bMeasureInProgress</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pbyRsr</span> <span class="o">&amp;</span> <span class="n">RSR_CRCOK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBasicMap</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">dwDuration</span> <span class="o">=</span> <span class="p">(</span><span class="n">FrameSize</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
        <span class="n">dwDuration</span> <span class="o">/=</span> <span class="n">acbyRxRate</span><span class="p">[</span><span class="o">*</span><span class="n">pbyRxRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pbyRxRate</span> <span class="o">&lt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pbyRxSts</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>long preamble</p></td><td class="code"><div class="highlight"><pre>                <span class="n">dwDuration</span> <span class="o">+=</span> <span class="mi">192</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>short preamble</p></td><td class="code"><div class="highlight"><pre>                <span class="n">dwDuration</span> <span class="o">+=</span> <span class="mi">96</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">dwDuration</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">RFvRSSITodBm</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">*</span><span class="n">pbyRSSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ldBm</span><span class="p">);</span>
        <span class="n">ldBmThreshold</span> <span class="o">=</span> <span class="o">-</span><span class="mi">57</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ldBm</span> <span class="o">&gt;</span> <span class="n">ldBmThreshold</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ldBmThreshold</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
            <span class="n">ii</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwRPIs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dwDuration</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">WCTLbIsDuplicate</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sDupRxCache</span><span class="p">),</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">FrameDuplicateCount</span><span class="o">++</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Use for TKIP MIC</p></td><td class="code"><div class="highlight"><pre>    <span class="n">s_vGetDASA</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbHeaderSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxEthHeader</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>filter packet send from myself</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxEthHeader</span><span class="p">.</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_CTL_PSPOLL</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">IS_TYPE_CONTROL</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">p802_11Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyFrame</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>get SA NodeIndex</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">p802_11Header</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">iSANodeIndex</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">ulLastRxJiffer</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s_bAPModeRxCtl</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pbyFrame</span><span class="p">,</span> <span class="n">iSANodeIndex</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">IS_FC_WEP</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">bool</span> <span class="n">bRxDecryOK</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;rx WEP pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">bIsWEP</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">iSANodeIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">pKey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STempKey</span><span class="p">;</span>
            <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">byCipherSuite</span><span class="p">;</span>
            <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">dwKeyIndex</span><span class="p">;</span>
            <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">uWepKeyLength</span><span class="p">;</span>
            <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">dwTSC47_16</span><span class="p">;</span>
            <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">wTSC15_0</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">abyWepKey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span>
                <span class="p">);</span>

            <span class="n">bRxDecryOK</span> <span class="o">=</span> <span class="n">s_bHostWepRxEncryption</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                                <span class="n">pbyFrame</span><span class="p">,</span>
                                                <span class="n">FrameSize</span><span class="p">,</span>
                                                <span class="n">pbyRsr</span><span class="p">,</span>
                                                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">bOnFly</span><span class="p">,</span>
                                                <span class="n">pKey</span><span class="p">,</span>
                                                <span class="n">pbyNewRsr</span><span class="p">,</span>
                                                <span class="o">&amp;</span><span class="n">bExtIV</span><span class="p">,</span>
                                                <span class="o">&amp;</span><span class="n">wRxTSC15_0</span><span class="p">,</span>
                                                <span class="o">&amp;</span><span class="n">dwRxTSC47_16</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">bRxDecryOK</span> <span class="o">=</span> <span class="n">s_bHandleRxEncryption</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                                <span class="n">pbyFrame</span><span class="p">,</span>
                                                <span class="n">FrameSize</span><span class="p">,</span>
                                                <span class="n">pbyRsr</span><span class="p">,</span>
                                                <span class="n">pbyNewRsr</span><span class="p">,</span>
                                                <span class="o">&amp;</span><span class="n">pKey</span><span class="p">,</span>
                                                <span class="o">&amp;</span><span class="n">bExtIV</span><span class="p">,</span>
                                                <span class="o">&amp;</span><span class="n">wRxTSC15_0</span><span class="p">,</span>
                                                <span class="o">&amp;</span><span class="n">dwRxTSC47_16</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">bRxDecryOK</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pbyNewRsr</span> <span class="o">&amp;</span> <span class="n">NEWRSR_DECRYPTOK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ICV Fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">)</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">)</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">)</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2PSK</span><span class="p">))</span> <span class="p">{</span>

                    <span class="k">if</span> <span class="p">((</span><span class="n">pKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">TKIPICVErrors</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">CCMPDecryptErrors</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><pre><code>                 pDevice-&gt;s802_11Counter.WEPICVErrorCount.QuadPart++;
</code></pre></td><td class="code"><div class="highlight"><pre>                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;WEP Func Fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">))</span>
            <span class="n">FrameSize</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>         <span class="c1">// Message Integrity Code</span>
        <span class="k">else</span>
            <span class="n">FrameSize</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>         <span class="c1">// 4 is ICV</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>RX OK</p>

<p>remove the CRC length</p></td><td class="code"><div class="highlight"><pre>    <span class="n">FrameSize</span> <span class="o">-=</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">pbyRsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RSR_ADDRBROAD</span> <span class="o">|</span> <span class="n">RSR_ADDRMULTI</span><span class="p">)))</span> <span class="o">&amp;&amp;</span> <span class="c1">// unicast address</span>
        <span class="p">(</span><span class="n">IS_FRAGMENT_PKT</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">)))</span>
        <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>defragment</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bDeFragRx</span> <span class="o">=</span> <span class="n">WCTLbHandleFragment</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">FrameSize</span><span class="p">,</span> <span class="n">bIsWEP</span><span class="p">,</span> <span class="n">bExtIV</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">ReceivedFragmentCount</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bDeFragRx</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>defrag complete</p></td><td class="code"><div class="highlight"><pre>            <span class="n">skb</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrentDFCBIdx</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
            <span class="n">FrameSize</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrentDFCBIdx</span><span class="p">].</span><span class="n">cbFrameLength</span><span class="p">;</span>

        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Management &amp; Control frame Handle</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">IS_TYPE_DATA</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Handle Control &amp; Manage Frame</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">IS_TYPE_MGMT</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyData1</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyData2</span><span class="p">;</span>

            <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
            <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">FrameSize</span><span class="p">;</span>
            <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">uRSSI</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbyRSSI</span><span class="p">;</span>
            <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">bySQ</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbySQ</span><span class="p">;</span>
            <span class="n">HIDWORD</span><span class="p">(</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">HIDWORD</span><span class="p">(</span><span class="o">*</span><span class="n">pqwTSFTime</span><span class="p">));</span>
            <span class="n">LODWORD</span><span class="p">(</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LODWORD</span><span class="p">(</span><span class="o">*</span><span class="n">pqwTSFTime</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>strip IV</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pbyData1</span> <span class="o">=</span> <span class="n">WLAN_HDR_A3_DATA_PTR</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
                <span class="n">pbyData2</span> <span class="o">=</span> <span class="n">WLAN_HDR_A3_DATA_PTR</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FrameSize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="o">*</span><span class="n">pbyData1</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbyData2</span><span class="p">;</span>
                     <span class="n">pbyData1</span><span class="o">++</span><span class="p">;</span>
                     <span class="n">pbyData2</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxRate</span> <span class="o">=</span> <span class="n">s_byGetRateIdx</span><span class="p">(</span><span class="o">*</span><span class="n">pbyRxRate</span><span class="p">);</span>
            <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxChannel</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pbyRxSts</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>PLICE_DEBUG->
EnQueue(pDevice,pRxPacket);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef	THREAD</span>
		<span class="n">EnQueue</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pRxPacket</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>printk("enque time is %x\n",jiffies);
up(&amp;pDevice->mlme_semaphore);
Enque (pDevice->FirstRecvMngList,pDevice->LastRecvMngList,pMgmt);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#else</span>

<span class="cp">#ifdef	TASK_LET</span>
		<span class="n">EnQueue</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pRxPacket</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">RxMngWorkItem</span><span class="p">);</span>
<span class="cp">#else</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>printk("RxMan\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">vMgrRxManagePacket</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>tasklet_schedule(&amp;pDevice->RxMngWorkItem);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>

<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>PLICE_DEBUG&lt;-
vMgrRxManagePacket((void *)pDevice, pDevice->pMgmt, pRxPacket);
hostap Deamon handle 802.11 management</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostapd</span><span class="p">)</span> <span class="p">{</span>
	            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">;</span>
	            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
                     <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">FrameSize</span><span class="p">);</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
    	        <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
	            <span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	            <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
                <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	        <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Control Frame</p></td><td class="code"><div class="highlight"><pre>        <span class="p">};</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>In AP mode, hw only check addr1(BSSID or RA) if equal to local MAC.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">pbyRsr</span> <span class="o">&amp;</span> <span class="n">RSR_BSSIDOK</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bDeFragRx</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_frag_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrentDFCBIdx</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc more frag bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>discard DATA packet while not associate || BSSID error</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">||</span>
                <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">pbyRsr</span> <span class="o">&amp;</span> <span class="n">RSR_BSSIDOK</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bDeFragRx</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_frag_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrentDFCBIdx</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc more frag bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>mike add:station mode check eapol-key challenge---></p></td><td class="code"><div class="highlight"><pre>   	  <span class="p">{</span>
   	    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Protocol_Version</span><span class="p">;</span>    <span class="c1">//802.1x Authentication</span>
	    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Packet_Type</span><span class="p">;</span>           <span class="c1">//802.1x Authentication</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">)</span>
                  <span class="n">cbIVOffset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
              <span class="k">else</span>
                  <span class="n">cbIVOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="n">wEtherType</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cbIVOffset</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
                          <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cbIVOffset</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	      <span class="n">Protocol_Version</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cbIVOffset</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	      <span class="n">Packet_Type</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cbIVOffset</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	     <span class="k">if</span> <span class="p">(</span><span class="n">wEtherType</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span><span class="p">)</span> <span class="p">{</span>         <span class="c1">//Protocol Type in LLC-Header</span>
                  <span class="k">if</span><span class="p">(((</span><span class="n">Protocol_Version</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span><span class="p">(</span><span class="n">Protocol_Version</span><span class="o">==</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">Packet_Type</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">//802.1x OR eapol-key challenge frame receive</span>
                        <span class="n">bRxeapol_key</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                  <span class="p">}</span>
	      <span class="p">}</span>
   	  <span class="p">}</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>mike add:station mode check eapol-key challenge&lt;---</p></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>Data frame Handle</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnablePSMode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_FC_MOREDATA</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pbyRsr</span> <span class="o">&amp;</span> <span class="n">RSR_ADDROK</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>PSbSendPSPOLL((PSDevice)pDevice);</p></td><td class="code"><div class="highlight"><pre>            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bInTIMWake</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bInTIMWake</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>Now it only supports 802.11g Infrastructure Mode, and support rate must up to 54 Mbps</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityEnable</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">FrameSize</span><span class="o">&gt;</span><span class="mi">50</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_INFRASTRUCTURE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>printk("device<em>receive</em>frame: RxRate is %d\n",*pbyRxRate);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">BBvAntennaDiversity</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">s_byGetRateIdx</span><span class="p">(</span><span class="o">*</span><span class="n">pbyRxRate</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span> <span class="o">!=</span> <span class="n">REV_ID_VT3253_B1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrRSSI</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbyRSSI</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurrSQ</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbySQ</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pbyRSSI</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">RFvRSSITodBm</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">*</span><span class="n">pbyRSSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ldBm</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Moniter if RSSI is too strong.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">byRSSIStatCnt</span><span class="o">++</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">byRSSIStatCnt</span> <span class="o">%=</span> <span class="n">RSSI_STAT_COUNT</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">byRSSIStatCnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">ldBm</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">RSSI_STAT_COUNT</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">ldBmMAX</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ldBm</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnable8021x</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)){</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyMacHdr</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Only 802.1x packet incoming allowed</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">)</span>
            <span class="n">cbIVOffset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">cbIVOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">wEtherType</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cbIVOffset</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
                    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cbIVOffset</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;wEtherType = %04x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wEtherType</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">wEtherType</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>strip IV header(8)</p></td><td class="code"><div class="highlight"><pre>                <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">abyMacHdr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">24</span><span class="p">);</span>
                <span class="n">memcpy</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">cbIVOffset</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">abyMacHdr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">24</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+=</span>  <span class="p">(</span><span class="n">cbIVOffset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span>  <span class="p">(</span><span class="n">cbIVOffset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
            <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">FrameSize</span><span class="p">);</span>
	    <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
            <span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
            <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>check if 802.1x authorized</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">dwFlags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_AUTHORIZED</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">((</span><span class="n">pKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">FrameSize</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>  <span class="c1">//MIC</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><hr />

<p>Soft MIC</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pdwMIC_L</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pdwMIC_R</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwMIC_Priority</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwMICKey0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dwMICKey1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwLocalMIC_L</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwLocalMIC_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="n">wpahdr</span><span class="p">;</span>


            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dwMICKey0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">24</span><span class="p">]));</span>
                <span class="n">dwMICKey1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">28</span><span class="p">]));</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">dwMICKey0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">16</span><span class="p">]));</span>
                    <span class="n">dwMICKey1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">20</span><span class="p">]));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span> <span class="o">&amp;</span> <span class="n">BIT28</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">dwMICKey0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">16</span><span class="p">]));</span>
                    <span class="n">dwMICKey1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">20</span><span class="p">]));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">dwMICKey0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">24</span><span class="p">]));</span>
                    <span class="n">dwMICKey1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">28</span><span class="p">]));</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">MIC_vInit</span><span class="p">(</span><span class="n">dwMICKey0</span><span class="p">,</span> <span class="n">dwMICKey1</span><span class="p">);</span>
            <span class="n">MIC_vAppend</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">12</span><span class="p">);</span>
            <span class="n">dwMIC_Priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">MIC_vAppend</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dwMIC_Priority</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>4 is Rcv buffer header, 24 is MAC Header, and 8 is IV and Ext IV.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">MIC_vAppend</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span>
                        <span class="n">FrameSize</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
            <span class="n">MIC_vGetMIC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwLocalMIC_L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwLocalMIC_R</span><span class="p">);</span>
            <span class="n">MIC_vUnInit</span><span class="p">();</span>

            <span class="n">pdwMIC_L</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">FrameSize</span><span class="p">);</span>
            <span class="n">pdwMIC_R</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">FrameSize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>DBG<em>PRN</em>GRP12(("RxL: %lx, RxR: %lx\n", *pdwMIC<em>L, *pdwMIC</em>R));
DBG<em>PRN</em>GRP12(("LocalL: %lx, LocalR: %lx\n", dwLocalMIC<em>L, dwLocalMIC</em>R));
DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"dwMICKey0= %lx,dwMICKey1= %lx \n", dwMICKey0, dwMICKey1);</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">((</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">pdwMIC_L</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dwLocalMIC_L</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">pdwMIC_R</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dwLocalMIC_R</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRxMICFail</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;MIC comparison is fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRxMICFail</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>pDevice->s802_11Counter.TKIPLocalMICFailures.QuadPart++;</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">TKIPLocalMICFailures</span><span class="o">++</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bDeFragRx</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_frag_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrentDFCBIdx</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc more frag bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>2008-0409-07, <Add> by Einsn Liu</p></td><td class="code"><div class="highlight"><pre>       <span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>send event to wpa_supplicant
if(pDevice->bWPADevEnable == true)</p></td><td class="code"><div class="highlight"><pre>				<span class="p">{</span>
					<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
					<span class="k">struct</span> <span class="n">iw_michaelmicfailure</span> <span class="n">ev</span><span class="p">;</span>
					<span class="kt">int</span> <span class="n">keyidx</span> <span class="o">=</span> <span class="n">pbyFrame</span><span class="p">[</span><span class="n">cbHeaderSize</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span> <span class="c1">//top two-bits</span>
					<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>
					<span class="n">ev</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">keyidx</span> <span class="o">&amp;</span> <span class="n">IW_MICFAILURE_KEY_ID</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
							<span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
								<span class="p">(</span><span class="o">*</span><span class="n">pbyRsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RSR_ADDRBROAD</span> <span class="o">|</span> <span class="n">RSR_ADDRMULTI</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ev</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_MICFAILURE_PAIRWISE</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">ev</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_MICFAILURE_GROUP</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">ev</span><span class="p">.</span><span class="n">src_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">src_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
					<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
					<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
					<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVMICHAELMICFAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>

				<span class="p">}</span>
         <span class="cp">#endif</span>


                <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
                     <span class="n">wpahdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
                     <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                         <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                         <span class="p">(</span><span class="o">*</span><span class="n">pbyRsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RSR_ADDRBROAD</span> <span class="o">|</span> <span class="n">RSR_ADDRMULTI</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>s802<em>11</em>Status.Flags = NDIS<em>802</em>11<em>AUTH</em>REQUEST<em>PAIRWISE</em>ERROR;</p></td><td class="code"><div class="highlight"><pre>                         <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIAWGET_PTK_MIC_MSG</span><span class="p">;</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>s802<em>11</em>Status.Flags = NDIS<em>802</em>11<em>AUTH</em>REQUEST<em>GROUP</em>ERROR;</p></td><td class="code"><div class="highlight"><pre>                         <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIAWGET_GTK_MIC_MSG</span><span class="p">;</span>
                     <span class="p">}</span>
                     <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                     <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                     <span class="n">skb_put</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">));</span>
                     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wpadev</span><span class="p">;</span>
		     <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
                     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
                     <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
                     <span class="n">netif_rx</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
                 <span class="p">}</span>

                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="c1">//---end of SOFT MIC-----------------------------------------------------------------------</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>++++++++++ Reply Counter Check +++++++++++++</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="o">||</span>
                           <span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wLocalTSC15_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwLocalTSC47_16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>       <span class="n">RSC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>endian issues</p></td><td class="code"><div class="highlight"><pre>            <span class="n">RSC</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">KeyRSC</span><span class="p">));</span>
            <span class="n">wLocalTSC15_0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">RSC</span><span class="p">;</span>
            <span class="n">dwLocalTSC47_16</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">RSC</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">);</span>

            <span class="n">RSC</span> <span class="o">=</span> <span class="n">dwRxTSC47_16</span><span class="p">;</span>
            <span class="n">RSC</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
            <span class="n">RSC</span> <span class="o">+=</span> <span class="n">wRxTSC15_0</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">KeyRSC</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">RSC</span><span class="p">,</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">QWORD</span><span class="p">));</span>

            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">.</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                 <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">.</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>check RSC</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">wRxTSC15_0</span> <span class="o">&lt;</span> <span class="n">wLocalTSC15_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                     <span class="p">(</span><span class="n">dwRxTSC47_16</span> <span class="o">&lt;=</span> <span class="n">dwLocalTSC47_16</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                     <span class="o">!</span><span class="p">((</span><span class="n">dwRxTSC47_16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dwLocalTSC47_16</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)))</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;TSC is illegal~~!</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>pDevice->s802_11Counter.TKIPReplays.QuadPart++;</p></td><td class="code"><div class="highlight"><pre>                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">TKIPReplays</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">else</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>pDevice->s802_11Counter.CCMPReplays.QuadPart++;</p></td><td class="code"><div class="highlight"><pre>                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">CCMPReplays</span><span class="o">++</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">bDeFragRx</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_frag_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrentDFCBIdx</span><span class="p">]))</span> <span class="p">{</span>
                            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc more frag bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="c1">// ----- End of Reply Counter Check --------------------------</span>



    <span class="k">if</span> <span class="p">((</span><span class="n">pKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bIsWEP</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><pre><code> pDevice-&gt;s802_11Counter.DecryptSuccessCount.QuadPart++;
</code></pre></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>


    <span class="n">s_vProcessRxMACHeader</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">FrameSize</span><span class="p">,</span> <span class="n">bIsWEP</span><span class="p">,</span> <span class="n">bExtIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbHeaderOffset</span><span class="p">);</span>
    <span class="n">FrameSize</span> <span class="o">-=</span> <span class="n">cbHeaderOffset</span><span class="p">;</span>
    <span class="n">cbHeaderOffset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>        <span class="c1">// 4 is Rcv buffer header</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Null data, framesize = 14</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">FrameSize</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s_bAPModeRxData</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                            <span class="n">skb</span><span class="p">,</span>
                            <span class="n">FrameSize</span><span class="p">,</span>
                            <span class="n">cbHeaderOffset</span><span class="p">,</span>
                            <span class="n">iSANodeIndex</span><span class="p">,</span>
                            <span class="n">iDANodeIndex</span>
                            <span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">bDeFragRx</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_frag_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrentDFCBIdx</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc more frag bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><pre><code>   if(pDevice-&gt;bRxMICFail == false) {
      for (ii =0; ii &lt; 100; ii++)
           printk(" %02x", *(skb-&gt;data + ii));
      printk("\n");
}
</code></pre></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+=</span> <span class="n">cbHeaderOffset</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">cbHeaderOffset</span><span class="p">;</span>
    <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">FrameSize</span><span class="p">);</span>
    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">=</span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>drop frame not met IEEE 802.3</p></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	if (pDevice-&gt;flags &amp; DEVICE_FLAGS_VAL_PKT_LEN) {</span>
<span class="cm">		if ((skb-&gt;protocol==htons(ETH_P_802_3)) &amp;&amp;</span>
<span class="cm">			(skb-&gt;len!=htons(skb-&gt;mac.ethernet-&gt;h_proto))) {</span>
<span class="cm">			pStats-&gt;rx_length_errors++;</span>
<span class="cm">			pStats-&gt;rx_dropped++;</span>
<span class="cm">            if (bDeFragRx) {</span>
<span class="cm">                if (!device_alloc_frag_buf(pDevice, &amp;pDevice-&gt;sRxDFCB[pDevice-&gt;uCurrentDFCBIdx])) {</span>
<span class="cm">                    DBG_PRT(MSG_LEVEL_ERR,KERN_ERR &quot;%s: can not alloc more frag bufs\n&quot;,</span>
<span class="cm">                    pDevice-&gt;dev-&gt;name);</span>
<span class="cm">                }</span>
<span class="cm">            }</span>
<span class="cm">			return false;</span>
<span class="cm">		}</span>
<span class="cm">	}</span>
<span class="cm">*/</span>

    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span><span class="o">=</span><span class="n">CHECKSUM_NONE</span><span class="p">;</span>
    <span class="n">pStats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pStats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
    <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bDeFragRx</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_frag_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrentDFCBIdx</span><span class="p">]))</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc more frag bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">s_bAPModeRxCtl</span> <span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyFrame</span><span class="p">,</span>
    <span class="kt">int</span>      <span class="n">iSANodeIndex</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PS802_11Header</span>      <span class="n">p802_11Header</span><span class="p">;</span>
    <span class="n">CMD_STATUS</span>          <span class="n">Status</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">IS_CTL_PSPOLL</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">IS_TYPE_CONTROL</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">))</span> <span class="p">{</span>

        <span class="n">p802_11Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyFrame</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_TYPE_MGMT</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Data &amp; PS-Poll packet
check frame class</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">iSANodeIndex</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>frame class 3 fliter &amp; checking</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">&lt;</span> <span class="n">NODE_AUTH</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>send deauth notification
reason = (6) class 2 received from nonauth sta</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">vMgrDeAuthenBeginSta</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                         <span class="n">pMgmt</span><span class="p">,</span>
                                         <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">p802_11Header</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">),</span>
                                         <span class="p">(</span><span class="n">WLAN_MGMT_REASON_CLASS2_NONAUTH</span><span class="p">),</span>
                                         <span class="o">&amp;</span><span class="n">Status</span>
                                         <span class="p">);</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dpc: send vMgrDeAuthenBeginSta 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">&lt;</span> <span class="n">NODE_ASSOC</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>send deassoc notification
reason = (7) class 3 received from nonassoc sta</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">vMgrDisassocBeginSta</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                         <span class="n">pMgmt</span><span class="p">,</span>
                                         <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">p802_11Header</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">),</span>
                                         <span class="p">(</span><span class="n">WLAN_MGMT_REASON_CLASS3_NONASSOC</span><span class="p">),</span>
                                         <span class="o">&amp;</span><span class="n">Status</span>
                                         <span class="p">);</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dpc: send vMgrDisassocBeginSta 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>delcare received ps-poll event</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="n">IS_CTL_PSPOLL</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">bRxPSPoll</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_RX_PSPOLL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dpc: WLAN_CMD_RX_PSPOLL 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>check Data PS state
if PW bit off, send out all PS bufferring packets.</p></td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FC_POWERMGT</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">))</span> <span class="p">{</span>
                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">bRxPSPoll</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                            <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_RX_PSPOLL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dpc: WLAN_CMD_RX_PSPOLL 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">IS_FC_POWERMGT</span><span class="p">(</span><span class="n">pbyFrame</span><span class="p">))</span> <span class="p">{</span>
                       <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>Once if STA in PS state, enable multicast bufferring</p></td><td class="code"><div class="highlight"><pre>                       <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bPSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                   <span class="p">}</span>
                   <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>clear all pending PS frame.</p></td><td class="code"><div class="highlight"><pre>                      <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">wEnQueueCnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                          <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                          <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iSANodeIndex</span><span class="p">].</span><span class="n">bRxPSPoll</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                          <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_RX_PSPOLL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                         <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dpc: WLAN_CMD_RX_PSPOLL 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

                      <span class="p">}</span>
                   <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                  <span class="n">vMgrDeAuthenBeginSta</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                       <span class="n">pMgmt</span><span class="p">,</span>
                                       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">p802_11Header</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">),</span>
                                       <span class="p">(</span><span class="n">WLAN_MGMT_REASON_CLASS2_NONAUTH</span><span class="p">),</span>
                                       <span class="o">&amp;</span><span class="n">Status</span>
                                       <span class="p">);</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dpc: send vMgrDeAuthenBeginSta 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;BSSID:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p802_11Header</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">);</span>
			<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;ADDR2:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p802_11Header</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">);</span>
			<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;ADDR1:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p802_11Header</span><span class="o">-&gt;</span><span class="n">abyAddr1</span><span class="p">);</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dpc: wFrameCtl= %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p802_11Header</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="p">);</span>
                    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span><span class="p">));</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;dpc:pDevice-&gt;byRxMode = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="p">);</span>
                    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">s_bHandleRxEncryption</span> <span class="p">(</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyFrame</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FrameSize</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRsr</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyNewRsr</span><span class="p">,</span>
    <span class="n">PSKeyItem</span>   <span class="o">*</span><span class="n">pKeyOut</span><span class="p">,</span>
    <span class="n">bool</span> <span class="o">*</span><span class="n">pbExtIV</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pwRxTSC15_0</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pdwRxTSC47_16</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">PayloadLen</span> <span class="o">=</span> <span class="n">FrameSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyIV</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byKeyIdx</span><span class="p">;</span>
    <span class="n">PSKeyItem</span>       <span class="n">pKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>


    <span class="o">*</span><span class="n">pwRxTSC15_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="n">pdwRxTSC47_16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">pbyIV</span> <span class="o">=</span> <span class="n">pbyFrame</span> <span class="o">+</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">WLAN_GET_FC_TODS</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyFrame</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="n">WLAN_GET_FC_FROMDS</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyFrame</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
         <span class="n">pbyIV</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>             <span class="c1">// 6 is 802.11 address4</span>
         <span class="n">PayloadLen</span> <span class="o">-=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">byKeyIdx</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">);</span>
    <span class="n">byKeyIdx</span> <span class="o">&gt;&gt;=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">KeyIdx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byKeyIdx</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2PSK</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">pbyRsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RSR_ADDRBROAD</span> <span class="o">|</span> <span class="n">RSR_ADDRMULTI</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">!=</span> <span class="n">KEY_CTL_NONE</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>unicast pkt use pairwise key</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;unicast pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">KeybGetKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pKey</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span>
                    <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span>
                    <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;unicast pkt: %d, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byDecMode</span><span class="p">,</span> <span class="n">pKey</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>use group key</p></td><td class="code"><div class="highlight"><pre>            <span class="n">KeybGetKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">byKeyIdx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pKey</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span>
                <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span>
                <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;group pkt: %d, %d, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byKeyIdx</span><span class="p">,</span> <span class="n">byDecMode</span><span class="p">,</span> <span class="n">pKey</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>our WEP only support Default Key</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>use default group key</p></td><td class="code"><div class="highlight"><pre>        <span class="n">KeybGetKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="n">byKeyIdx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pKey</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span>
            <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span>
            <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">pKeyOut</span> <span class="o">=</span> <span class="n">pKey</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;AES:%d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span><span class="p">,</span> <span class="n">byDecMode</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;pKey == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><pre><code>       pDevice-&gt;s802_11Counter.WEPUndecryptableCount.QuadPart++;
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><pre><code>       pDevice-&gt;s802_11Counter.DecryptFailureCount.QuadPart++;
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">!=</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><pre><code>       pDevice-&gt;s802_11Counter.WEPUndecryptableCount.QuadPart++;
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><pre><code>       pDevice-&gt;s802_11Counter.DecryptFailureCount.QuadPart++;
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
        <span class="o">*</span><span class="n">pKeyOut</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>handle WEP</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="n">REV_ID_VT3253_A1</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(((</span><span class="n">PSKeyTable</span><span class="p">)(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">pvKeyTable</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">bSoftWEP</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>Software WEP
1. 3253A
2. WEP 256</p></td><td class="code"><div class="highlight"><pre>            <span class="n">PayloadLen</span> <span class="o">-=</span> <span class="p">(</span><span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">// 24 is 802.11 header,4 is IV, 4 is crc</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">pbyIV</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">);</span>
            <span class="n">rc4_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
            <span class="n">rc4_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pbyIV</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">pbyIV</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ETHbIsBufferCrc32Ok</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">))</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">pbyNewRsr</span> <span class="o">|=</span> <span class="n">NEWRSR_DECRYPTOK</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="o">||</span>
               <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>TKIP/AES</p></td><td class="code"><div class="highlight"><pre>        <span class="n">PayloadLen</span> <span class="o">-=</span> <span class="p">(</span><span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">// 24 is 802.11 header, 8 is IV&amp;ExtIV, 4 is crc</span>
        <span class="o">*</span><span class="n">pdwRxTSC47_16</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyIV</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ExtIV: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">pdwRxTSC47_16</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pwRxTSC15_0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MAKEWORD</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="n">pbyIV</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pwRxTSC15_0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyIV</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;TSC0_15: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pwRxTSC15_0</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="n">REV_ID_VT3253_A1</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>Software TKIP
1. 3253 A</p></td><td class="code"><div class="highlight"><pre>            <span class="n">PS802_11Header</span>  <span class="n">pMACHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyFrame</span><span class="p">);</span>
            <span class="n">TKIPvMixKey</span><span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="o">*</span><span class="n">pwRxTSC15_0</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwRxTSC47_16</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">);</span>
            <span class="n">rc4_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">TKIP_KEY_LEN</span><span class="p">);</span>
            <span class="n">rc4_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pbyIV</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">pbyIV</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ETHbIsBufferCrc32Ok</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">))</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">pbyNewRsr</span> <span class="o">|=</span> <span class="n">NEWRSR_DECRYPTOK</span><span class="p">;</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ICV OK!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ICV FAIL!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;PayloadLen = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="c1">// end of TKIP/AES</span>

    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">*</span><span class="n">pbExtIV</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">s_bHostWepRxEncryption</span> <span class="p">(</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyFrame</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FrameSize</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRsr</span><span class="p">,</span>
    <span class="n">bool</span> <span class="n">bOnFly</span><span class="p">,</span>
    <span class="n">PSKeyItem</span>    <span class="n">pKey</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyNewRsr</span><span class="p">,</span>
    <span class="n">bool</span> <span class="o">*</span><span class="n">pbExtIV</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pwRxTSC15_0</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pdwRxTSC47_16</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">PayloadLen</span> <span class="o">=</span> <span class="n">FrameSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyIV</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byKeyIdx</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
    <span class="n">PS802_11Header</span>  <span class="n">pMACHeader</span><span class="p">;</span>



    <span class="o">*</span><span class="n">pwRxTSC15_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="n">pdwRxTSC47_16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">pbyIV</span> <span class="o">=</span> <span class="n">pbyFrame</span> <span class="o">+</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">WLAN_GET_FC_TODS</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyFrame</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="n">WLAN_GET_FC_FROMDS</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyFrame</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
         <span class="n">pbyIV</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>             <span class="c1">// 6 is 802.11 address4</span>
         <span class="n">PayloadLen</span> <span class="o">-=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">byKeyIdx</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">);</span>
    <span class="n">byKeyIdx</span> <span class="o">&gt;&gt;=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">KeyIdx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byKeyIdx</span><span class="p">);</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span>
        <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span>
        <span class="n">byDecMode</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;AES:%d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span><span class="p">,</span> <span class="n">byDecMode</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">!=</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><pre><code>       pDevice-&gt;s802_11Counter.WEPUndecryptableCount.QuadPart++;
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><pre><code>       pDevice-&gt;s802_11Counter.DecryptFailureCount.QuadPart++;
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>handle WEP</p></td><td class="code"><div class="highlight"><pre>        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;byDecMode == KEY_CTL_WEP </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="n">REV_ID_VT3253_A1</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(((</span><span class="n">PSKeyTable</span><span class="p">)(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">pvKeyTable</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">bSoftWEP</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">bOnFly</span> <span class="o">==</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>Software WEP
1. 3253A
2. WEP 256
3. NotOnFly</p></td><td class="code"><div class="highlight"><pre>            <span class="n">PayloadLen</span> <span class="o">-=</span> <span class="p">(</span><span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">// 24 is 802.11 header,4 is IV, 4 is crc</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">pbyIV</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">);</span>
            <span class="n">rc4_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
            <span class="n">rc4_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pbyIV</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">pbyIV</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ETHbIsBufferCrc32Ok</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">))</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">pbyNewRsr</span> <span class="o">|=</span> <span class="n">NEWRSR_DECRYPTOK</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="o">||</span>
               <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>TKIP/AES</p></td><td class="code"><div class="highlight"><pre>        <span class="n">PayloadLen</span> <span class="o">-=</span> <span class="p">(</span><span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">// 24 is 802.11 header, 8 is IV&amp;ExtIV, 4 is crc</span>
        <span class="o">*</span><span class="n">pdwRxTSC47_16</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyIV</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ExtIV: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">pdwRxTSC47_16</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pwRxTSC15_0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MAKEWORD</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="n">pbyIV</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pwRxTSC15_0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyIV</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;TSC0_15: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pwRxTSC15_0</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="n">REV_ID_VT3253_A1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bOnFly</span> <span class="o">==</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>Software TKIP
1. 3253 A
2. NotOnFly</p></td><td class="code"><div class="highlight"><pre>                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;soft KEY_CTL_TKIP </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">pMACHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyFrame</span><span class="p">);</span>
                <span class="n">TKIPvMixKey</span><span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="o">*</span><span class="n">pwRxTSC15_0</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwRxTSC47_16</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">);</span>
                <span class="n">rc4_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">TKIP_KEY_LEN</span><span class="p">);</span>
                <span class="n">rc4_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pbyIV</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">pbyIV</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ETHbIsBufferCrc32Ok</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">))</span> <span class="p">{</span>
                    <span class="o">*</span><span class="n">pbyNewRsr</span> <span class="o">|=</span> <span class="n">NEWRSR_DECRYPTOK</span><span class="p">;</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ICV OK!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ICV FAIL!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;PayloadLen = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PayloadLen</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">byDecMode</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bOnFly</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>Software CCMP
NotOnFly</p></td><td class="code"><div class="highlight"><pre>                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;soft KEY_CTL_CCMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">AESbGenCCMP</span><span class="p">(</span><span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pbyFrame</span><span class="p">,</span> <span class="n">FrameSize</span><span class="p">))</span> <span class="p">{</span>
                    <span class="o">*</span><span class="n">pbyNewRsr</span> <span class="o">|=</span> <span class="n">NEWRSR_DECRYPTOK</span><span class="p">;</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;CCMP MIC compare OK!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;CCMP MIC fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span><span class="c1">// end of TKIP/AES</span>

    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pbyIV</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">*</span><span class="n">pbExtIV</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="n">bool</span> <span class="nf">s_bAPModeRxData</span> <span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FrameSize</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbHeaderOffset</span><span class="p">,</span>
    <span class="kt">int</span>      <span class="n">iSANodeIndex</span><span class="p">,</span>
    <span class="kt">int</span>      <span class="n">iDANodeIndex</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bRelayAndForward</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bRelayOnly</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byMask</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAID</span><span class="p">;</span>


    <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skbcpy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">FrameSize</span> <span class="o">&gt;</span> <span class="n">CB_MAX_BUF_SIZE</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>check DA</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">cbHeaderOffset</span><span class="p">)))</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span> <span class="p">{</span>

           <span class="n">skbcpy</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>if any node in PS mode, buffer packet until DTIM.</p></td><td class="code"><div class="highlight"><pre>           <span class="k">if</span> <span class="p">(</span><span class="n">skbcpy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;relay multicast no skb available </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="p">}</span>
           <span class="k">else</span> <span class="p">{</span>
               <span class="n">skbcpy</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
               <span class="n">skbcpy</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">FrameSize</span><span class="p">;</span>
               <span class="n">memcpy</span><span class="p">(</span><span class="n">skbcpy</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">cbHeaderOffset</span><span class="p">,</span> <span class="n">FrameSize</span><span class="p">);</span>
               <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">),</span> <span class="n">skbcpy</span><span class="p">);</span>

               <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>set tx map</p></td><td class="code"><div class="highlight"><pre>               <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">byMask</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
           <span class="p">}</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="p">{</span>
           <span class="n">bRelayAndForward</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
       <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>check if relay</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">cbHeaderOffset</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">iDANodeIndex</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iDANodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">&gt;=</span> <span class="n">NODE_ASSOC</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iDANodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>queue this skb until next PS tx, and then release.</p></td><td class="code"><div class="highlight"><pre>	                <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+=</span> <span class="n">cbHeaderOffset</span><span class="p">;</span>
	                <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">cbHeaderOffset</span><span class="p">;</span>
                    <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">FrameSize</span><span class="p">);</span>
                    <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iDANodeIndex</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iDANodeIndex</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="o">++</span><span class="p">;</span>
                    <span class="n">wAID</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">iDANodeIndex</span><span class="p">].</span><span class="n">wAID</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>  <span class="n">byMask</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;relay: index= %d, pMgmt-&gt;abyPSTxMap[%d]= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                               <span class="n">iDANodeIndex</span><span class="p">,</span> <span class="p">(</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]);</span>
                    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">bRelayOnly</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bRelayOnly</span> <span class="o">||</span> <span class="n">bRelayAndForward</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>relay this packet right now</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">bRelayAndForward</span><span class="p">)</span>
            <span class="n">iDANodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAssocCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">iDANodeIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">ROUTEbRelay</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">cbHeaderOffset</span><span class="p">),</span> <span class="n">FrameSize</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">iDANodeIndex</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">bRelayOnly</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>none associate, don't forward</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAssocCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
