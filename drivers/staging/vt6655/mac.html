<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6655 › mac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * File: mac.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose:  MAC routines</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Tevin Chen</span>
<span class="cm"> *</span>
<span class="cm"> * Date: May 21, 1996</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *      MACvReadAllRegs - Read All MAC Registers to buffer</span>
<span class="cm"> *      MACbIsRegBitsOn - Test if All test Bits On</span>
<span class="cm"> *      MACbIsRegBitsOff - Test if All test Bits Off</span>
<span class="cm"> *      MACbIsIntDisable - Test if MAC interrupt disable</span>
<span class="cm"> *      MACbyReadMultiAddr - Read Multicast Address Mask Pattern</span>
<span class="cm"> *      MACvWriteMultiAddr - Write Multicast Address Mask Pattern</span>
<span class="cm"> *      MACvSetMultiAddrByHash - Set Multicast Address Mask by Hash value</span>
<span class="cm"> *      MACvResetMultiAddrByHash - Clear Multicast Address Mask by Hash value</span>
<span class="cm"> *      MACvSetRxThreshold - Set Rx Threshold value</span>
<span class="cm"> *      MACvGetRxThreshold - Get Rx Threshold value</span>
<span class="cm"> *      MACvSetTxThreshold - Set Tx Threshold value</span>
<span class="cm"> *      MACvGetTxThreshold - Get Tx Threshold value</span>
<span class="cm"> *      MACvSetDmaLength - Set Dma Length value</span>
<span class="cm"> *      MACvGetDmaLength - Get Dma Length value</span>
<span class="cm"> *      MACvSetShortRetryLimit - Set 802.11 Short Retry limit</span>
<span class="cm"> *      MACvGetShortRetryLimit - Get 802.11 Short Retry limit</span>
<span class="cm"> *      MACvSetLongRetryLimit - Set 802.11 Long Retry limit</span>
<span class="cm"> *      MACvGetLongRetryLimit - Get 802.11 Long Retry limit</span>
<span class="cm"> *      MACvSetLoopbackMode - Set MAC Loopback Mode</span>
<span class="cm"> *      MACbIsInLoopbackMode - Test if MAC in Loopback mode</span>
<span class="cm"> *      MACvSetPacketFilter - Set MAC Address Filter</span>
<span class="cm"> *      MACvSaveContext - Save Context of MAC Registers</span>
<span class="cm"> *      MACvRestoreContext - Restore Context of MAC Registers</span>
<span class="cm"> *      MACbCompareContext - Compare if values of MAC Registers same as Context</span>
<span class="cm"> *      MACbSoftwareReset - Software Reset MAC</span>
<span class="cm"> *      MACbSafeRxOff - Turn Off MAC Rx</span>
<span class="cm"> *      MACbSafeTxOff - Turn Off MAC Tx</span>
<span class="cm"> *      MACbSafeStop - Stop MAC function</span>
<span class="cm"> *      MACbShutdown - Shut down MAC</span>
<span class="cm"> *      MACvInitialize - Initialize MAC</span>
<span class="cm"> *      MACvSetCurrRxDescAddr - Set Rx Descriptos Address</span>
<span class="cm"> *      MACvSetCurrTx0DescAddr - Set Tx0 Descriptos Address</span>
<span class="cm"> *      MACvSetCurrTx1DescAddr - Set Tx1 Descriptos Address</span>
<span class="cm"> *      MACvTimer0MicroSDelay - Micro Second Delay Loop by MAC</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> *      08-22-2003 Kyle Hsu     :  Porting MAC functions from sim53</span>
<span class="cm"> *      09-03-2003 Bryan YC Fan :  Add MACvClearBusSusInd()&amp; MACvEnableBusSusEn()</span>
<span class="cm"> *      09-18-2003 Jerry Chen   :  Add MACvSetKeyEntry &amp; MACvDisableKeyEntry</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;tmacro.h&quot;</span>
<span class="cp">#include &quot;tether.h&quot;</span>
<span class="cp">#include &quot;mac.h&quot;</span>

<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">TxRate_iwconfig</span><span class="p">;</span><span class="c1">//2008-5-8 &lt;add&gt; by chester</span>
<span class="cm">/*---------------------  Static Definitions -------------------------*/</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>static int          msglevel                =MSG<em>LEVEL</em>DEBUG;</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span><span class="n">MSG_LEVEL_INFO</span><span class="p">;</span>
<span class="cm">/*---------------------  Static Classes  ----------------------------*/</span>

<span class="cm">/*---------------------  Static Variables  --------------------------*/</span>

<span class="cm">/*---------------------  Static Functions  --------------------------*/</span>

<span class="cm">/*---------------------  Export Variables  --------------------------*/</span>

<span class="cm">/*---------------------  Export Functions  --------------------------*/</span>





<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Read All MAC Registers to buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      pbyMacRegs  - buffer to read</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvReadAllRegs</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyMacRegs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>read page0 register</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAC_MAX_CONTEXT_SIZE_PAGE0</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="n">pbyMacRegs</span><span class="p">);</span>
        <span class="n">pbyMacRegs</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>read page1 register</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAC_MAX_CONTEXT_SIZE_PAGE1</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="n">pbyMacRegs</span><span class="p">);</span>
        <span class="n">pbyMacRegs</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Test if all test bits on</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      byRegOfs    - Offset of MAC Register</span>
<span class="cm"> *      byTestBits  - Test bits</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if all test bits On; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbIsRegBitsOn</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byRegOfs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byTestBits</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span>

    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">byRegOfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">byTestBits</span><span class="p">)</span> <span class="o">==</span> <span class="n">byTestBits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Test if all test bits off</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      byRegOfs    - Offset of MAC Register</span>
<span class="cm"> *      byTestBits  - Test bits</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if all test bits Off; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbIsRegBitsOff</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byRegOfs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byTestBits</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span>

    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">byRegOfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">byTestBits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Test if MAC interrupt disable</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if interrupt is disable; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbIsIntDisable</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">;</span>

    <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_IMR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dwData</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Read MAC Multicast Address Mask</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      uByteidx    - Index of Mask</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: Mask Value read</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">MACbyReadMultiAddr</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uByteIdx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span>

    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span> <span class="o">+</span> <span class="n">uByteIdx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">byData</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Write MAC Multicast Address Mask</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      uByteidx    - Index of Mask</span>
<span class="cm"> *      byData      - Mask Value to write</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvWriteMultiAddr</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uByteIdx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span> <span class="o">+</span> <span class="n">uByteIdx</span><span class="p">,</span> <span class="n">byData</span><span class="p">);</span>
    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set this hash index into multicast address register bit</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      byHashIdx   - Hash index to set</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetMultiAddrByHash</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byHashIdx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uByteIdx</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byBitMask</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>calculate byte position</p></td><td class="code"><div class="highlight"><pre>    <span class="n">uByteIdx</span> <span class="o">=</span> <span class="n">byHashIdx</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">uByteIdx</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>calculate bit position</p></td><td class="code"><div class="highlight"><pre>    <span class="n">byBitMask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">byBitMask</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">byHashIdx</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>turn on the bit</p></td><td class="code"><div class="highlight"><pre>    <span class="n">byOrgValue</span> <span class="o">=</span> <span class="n">MACbyReadMultiAddr</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">uByteIdx</span><span class="p">);</span>
    <span class="n">MACvWriteMultiAddr</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">uByteIdx</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">byOrgValue</span> <span class="o">|</span> <span class="n">byBitMask</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Reset this hash index into multicast address register bit</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      byHashIdx   - Hash index to clear</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvResetMultiAddrByHash</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byHashIdx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uByteIdx</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byBitMask</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>calculate byte position</p></td><td class="code"><div class="highlight"><pre>    <span class="n">uByteIdx</span> <span class="o">=</span> <span class="n">byHashIdx</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">uByteIdx</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>calculate bit position</p></td><td class="code"><div class="highlight"><pre>    <span class="n">byBitMask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">byBitMask</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">byHashIdx</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>turn off the bit</p></td><td class="code"><div class="highlight"><pre>    <span class="n">byOrgValue</span> <span class="o">=</span> <span class="n">MACbyReadMultiAddr</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">uByteIdx</span><span class="p">);</span>
    <span class="n">MACvWriteMultiAddr</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">uByteIdx</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">byOrgValue</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">byBitMask</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set Rx Threshold</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      byThreshold - Threshold Value</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetRxThreshold</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byThreshold</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">byThreshold</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>set FCR0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_FCR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgValue</span><span class="p">);</span>
    <span class="n">byOrgValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">byOrgValue</span> <span class="o">&amp;</span> <span class="mh">0xCF</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">byThreshold</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_FCR0</span><span class="p">,</span> <span class="n">byOrgValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Get Rx Threshold</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      pbyThreshold- Threshold Value Get</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvGetRxThreshold</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyThreshold</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>get FCR0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_FCR0</span><span class="p">,</span> <span class="n">pbyThreshold</span><span class="p">);</span>
    <span class="o">*</span><span class="n">pbyThreshold</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pbyThreshold</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set Tx Threshold</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      byThreshold - Threshold Value</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetTxThreshold</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byThreshold</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">byThreshold</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>set FCR0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_FCR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgValue</span><span class="p">);</span>
    <span class="n">byOrgValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">byOrgValue</span> <span class="o">&amp;</span> <span class="mh">0xF3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">byThreshold</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_FCR0</span><span class="p">,</span> <span class="n">byOrgValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Get Tx Threshold</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      pbyThreshold- Threshold Value Get</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvGetTxThreshold</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyThreshold</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>get FCR0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_FCR0</span><span class="p">,</span> <span class="n">pbyThreshold</span><span class="p">);</span>
    <span class="o">*</span><span class="n">pbyThreshold</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pbyThreshold</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set Dma Length</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      byDmaLength - Dma Length Value</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetDmaLength</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byDmaLength</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">byDmaLength</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>set FCR0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_FCR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgValue</span><span class="p">);</span>
    <span class="n">byOrgValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">byOrgValue</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="n">byDmaLength</span><span class="p">;</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_FCR0</span><span class="p">,</span> <span class="n">byOrgValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Get Dma Length</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      pbyDmaLength- Dma Length Value Get</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvGetDmaLength</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyDmaLength</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>get FCR0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_FCR0</span><span class="p">,</span> <span class="n">pbyDmaLength</span><span class="p">);</span>
    <span class="o">*</span><span class="n">pbyDmaLength</span> <span class="o">&amp;=</span> <span class="mh">0x03</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set 802.11 Short Retry Limit</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      byRetryLimit- Retry Limit</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetShortRetryLimit</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byRetryLimit</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>set SRT</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_SRT</span><span class="p">,</span> <span class="n">byRetryLimit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Get 802.11 Short Retry Limit</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      pbyRetryLimit   - Retry Limit Get</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvGetShortRetryLimit</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRetryLimit</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>get SRT</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_SRT</span><span class="p">,</span> <span class="n">pbyRetryLimit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set 802.11 Long Retry Limit</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      byRetryLimit- Retry Limit</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetLongRetryLimit</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byRetryLimit</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>set LRT</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_LRT</span><span class="p">,</span> <span class="n">byRetryLimit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Get 802.11 Long Retry Limit</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      pbyRetryLimit   - Retry Limit Get</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvGetLongRetryLimit</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRetryLimit</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>get LRT</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_LRT</span><span class="p">,</span> <span class="n">pbyRetryLimit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set MAC Loopback mode</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *      byLoopbackMode  - Loopback Mode</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetLoopbackMode</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byLoopbackMode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">byLoopbackMode</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">byLoopbackMode</span> <span class="o">&lt;&lt;=</span> <span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>set TCR</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgValue</span><span class="p">);</span>
    <span class="n">byOrgValue</span> <span class="o">=</span> <span class="n">byOrgValue</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
    <span class="n">byOrgValue</span> <span class="o">=</span> <span class="n">byOrgValue</span> <span class="o">|</span> <span class="n">byLoopbackMode</span><span class="p">;</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TEST</span><span class="p">,</span> <span class="n">byOrgValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Test if MAC in Loopback mode</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if in Loopback mode; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbIsInLoopbackMode</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span>

    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgValue</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgValue</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TEST_LBINT</span> <span class="o">|</span> <span class="n">TEST_LBEXT</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set MAC Address filter</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *      wFilterType     - Filter Type</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetPacketFilter</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wFilterType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOldRCR</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byNewRCR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>if only in DIRECTED mode, multicast-address will set to zero,
but if other mode exist (e.g. PROMISCUOUS), multicast-address
will be open</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">wFilterType</span> <span class="o">&amp;</span> <span class="n">PKT_TYPE_DIRECTED</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>set multicast address to accept none</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="mi">0L</span><span class="p">);</span>
        <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wFilterType</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PKT_TYPE_PROMISCUOUS</span> <span class="o">|</span> <span class="n">PKT_TYPE_ALL_MULTICAST</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>set multicast address to accept all</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span><span class="p">,</span> <span class="mh">0xFFFFFFFFL</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MAR0</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="mh">0xFFFFFFFFL</span><span class="p">);</span>
        <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wFilterType</span> <span class="o">&amp;</span> <span class="n">PKT_TYPE_PROMISCUOUS</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">byNewRCR</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_RXALLTYPE</span> <span class="o">|</span> <span class="n">RCR_UNICAST</span> <span class="o">|</span> <span class="n">RCR_MULTICAST</span> <span class="o">|</span> <span class="n">RCR_BROADCAST</span><span class="p">);</span>

        <span class="n">byNewRCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RCR_BSSID</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wFilterType</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PKT_TYPE_ALL_MULTICAST</span> <span class="o">|</span> <span class="n">PKT_TYPE_MULTICAST</span><span class="p">))</span>
        <span class="n">byNewRCR</span> <span class="o">|=</span> <span class="n">RCR_MULTICAST</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wFilterType</span> <span class="o">&amp;</span> <span class="n">PKT_TYPE_BROADCAST</span><span class="p">)</span>
        <span class="n">byNewRCR</span> <span class="o">|=</span> <span class="n">RCR_BROADCAST</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wFilterType</span> <span class="o">&amp;</span> <span class="n">PKT_TYPE_ERROR_CRC</span><span class="p">)</span>
        <span class="n">byNewRCR</span> <span class="o">|=</span> <span class="n">RCR_ERRCRC</span><span class="p">;</span>

    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">byOldRCR</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byNewRCR</span> <span class="o">!=</span> <span class="n">byOldRCR</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Modify the Receive Command Register</p></td><td class="code"><div class="highlight"><pre>        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="n">byNewRCR</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Save MAC registers to context buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      pbyCxtBuf   - Context buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSaveContext</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyCxtBuf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span>         <span class="n">ii</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>read page0 register</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAC_MAX_CONTEXT_SIZE_PAGE0</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">((</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">ii</span><span class="p">),</span> <span class="p">(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">ii</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>read page1 register</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAC_MAX_CONTEXT_SIZE_PAGE1</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">((</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">ii</span><span class="p">),</span> <span class="p">(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_MAX_CONTEXT_SIZE_PAGE0</span> <span class="o">+</span> <span class="n">ii</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Restore MAC registers from context buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      pbyCxtBuf   - Context buffer</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvRestoreContext</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyCxtBuf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span>         <span class="n">ii</span><span class="p">;</span>

    <span class="n">MACvSelectPage1</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>restore page1</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAC_MAX_CONTEXT_SIZE_PAGE1</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">((</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">ii</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_MAX_CONTEXT_SIZE_PAGE0</span> <span class="o">+</span> <span class="n">ii</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">MACvSelectPage0</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>restore RCR,TCR,IMR...</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="n">MAC_REG_RCR</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAC_REG_ISR</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">ii</span><span class="p">));</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>restore MAC Config.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="n">MAC_REG_LRT</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAC_REG_PAGE1SEL</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">ii</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_CFG</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_CFG</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>restore PS Config.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="n">MAC_REG_PSCFG</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAC_REG_BBREGCTL</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">ii</span><span class="p">));</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>restore CURR<em>RX</em>DESC<em>ADDR, CURR</em>TX<em>DESC</em>ADDR</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMAPTR0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMAPTR0</span><span class="p">));</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMAPTR</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMAPTR</span><span class="p">));</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_BCNDMAPTR</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_BCNDMAPTR</span><span class="p">));</span>


    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR0</span><span class="p">));</span>

    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR1</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR1</span><span class="p">));</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Compare if MAC registers same as context buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      pbyCxtBuf   - Context buffer</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if all values are the same; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbCompareContext</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyCxtBuf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>compare MAC context to determine if this is a power lost init,
return true for power remaining init, return false for power lost init</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>compare CURR<em>RX</em>DESC<em>ADDR, CURR</em>TX<em>DESC</em>ADDR</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMAPTR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dwData</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMAPTR0</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMAPTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dwData</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMAPTR</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dwData</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR0</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dwData</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyCxtBuf</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR1</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Software Reset MAC</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if Reset Success; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbSoftwareReset</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ww</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>turn on HOSTCR<em>SOFTRST, just write 0x01 to reset
MACvRegBitsOn(dwIoBase, MAC</em>REG<em>HOSTCR, HOSTCR</em>SOFTRST);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span><span class="o">+</span> <span class="n">MAC_REG_HOSTCR</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_HOSTCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">HOSTCR_SOFTRST</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      save some important register&#39;s value, then do reset, then restore register&#39;s value</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if success; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbSafeSoftwareReset</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyTmpRegData</span><span class="p">[</span><span class="n">MAC_MAX_CONTEXT_SIZE_PAGE0</span><span class="o">+</span><span class="n">MAC_MAX_CONTEXT_SIZE_PAGE1</span><span class="p">];</span>
    <span class="n">bool</span> <span class="n">bRetVal</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>PATCH....
save some important register's value, then do
reset, then restore register's value</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>save MAC context</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvSaveContext</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">abyTmpRegData</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>do reset</p></td><td class="code"><div class="highlight"><pre>    <span class="n">bRetVal</span> <span class="o">=</span> <span class="n">MACbSoftwareReset</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>BBvSoftwareReset(pDevice->PortOffset);
restore MAC context, except CR0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvRestoreContext</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">abyTmpRegData</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">bRetVal</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Trun Off MAC Rx</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if success; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbSafeRxOff</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ww</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>turn off wow temp for turn off Rx safely</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>Clear RX DMA0,1</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL0</span><span class="p">,</span> <span class="n">DMACTL_CLRRUN</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL1</span><span class="p">,</span> <span class="n">DMACTL_CLRRUN</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dwData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x10)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">dwData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x11</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x11)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>try to safe shutdown RX</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">MAC_REG_HOSTCR</span><span class="p">,</span> <span class="n">HOSTCR_RXON</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>W<em>MAX</em>TIMEOUT is the timeout period</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_HOSTCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">HOSTCR_RXONST</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x12</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x12)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Trun Off MAC Tx</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if success; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbSafeTxOff</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ww</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Clear TX DMA
Tx0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMACTL0</span><span class="p">,</span> <span class="n">DMACTL_CLRRUN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>AC0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMACTL</span><span class="p">,</span> <span class="n">DMACTL_CLRRUN</span><span class="p">);</span>


    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMACTL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">dwData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x20)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMACTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">dwData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x21</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x21)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>try to safe shutdown TX</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">MAC_REG_HOSTCR</span><span class="p">,</span> <span class="n">HOSTCR_TXON</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>W<em>MAX</em>TIMEOUT is the timeout period</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_HOSTCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">HOSTCR_TXONST</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x24</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x24)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Stop MAC function</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if success; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbSafeStop</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">MAC_REG_TCR</span><span class="p">,</span> <span class="n">TCR_AUTOBCNTX</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">MACbSafeRxOff</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0xA1</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; MACbSafeRxOff == false)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">MACbSafeSoftwareReset</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">MACbSafeTxOff</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0xA2</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; MACbSafeTxOff == false)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">MACbSafeSoftwareReset</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">MAC_REG_HOSTCR</span><span class="p">,</span> <span class="n">HOSTCR_MACEN</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Shut Down MAC</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if success; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">MACbShutdown</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>disable MAC IMR</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvIntDisable</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span>
    <span class="n">MACvSetLoopbackMode</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">MAC_LB_INTERNAL</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>stop the adapter</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACbSafeStop</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">MACvSetLoopbackMode</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">MAC_LB_NONE</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">MACvSetLoopbackMode</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">MAC_LB_NONE</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Initialize MAC</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvInitialize</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>clear sticky bits</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvClearStckDS</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>disable force PME-enable</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_PMC1</span><span class="p">,</span> <span class="n">PME_OVR</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>only 3253 A</p></td><td class="code"><div class="highlight"><pre>    <span class="cm">/*</span>
<span class="cm">    MACvPwrEvntDisable(dwIoBase);</span>

<span class="cm">//DIVIDER</span>
<span class="cm">    VNSvOutPortW(dwIoBase + MAC_REG_WAKEUPSR0, 0x0F0F);</span>
<span class="cm">    */</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>clear power status</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACbSoftwareReset</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>do reset</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>issue AUTOLD in EECSR to reload eeprom
MACvRegBitsOn(dwIoBase, MAC<em>REG</em>I2MCSR, I2MCSR<em>AUTOLD);
wait until EEPROM loading complete
while (true) {
   u8 u8Data;
   VNSvInPortB(dwIoBase + MAC</em>REG<em>I2MCSR, &amp;u8Data);
   if ( !(u8Data &amp; I2MCSR</em>AUTOLD))
       break;
}</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TFTCTL</span><span class="p">,</span> <span class="n">TFTCTL_TSFCNTRST</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>reset TSF counter</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TFTCTL</span><span class="p">,</span> <span class="n">TFTCTL_TSFCNTREN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>enable TSF counter</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvSetPacketFilter</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">PKT_TYPE_DIRECTED</span> <span class="o">|</span> <span class="n">PKT_TYPE_BROADCAST</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set the chip with current rx descriptor address</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *      dwCurrDescAddr  - Descriptor Address</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetCurrRx0DescAddr</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwCurrDescAddr</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ww</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgDMACtl</span><span class="p">;</span>

    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgDMACtl</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgDMACtl</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL0</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x13</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR0</span><span class="p">,</span> <span class="n">dwCurrDescAddr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgDMACtl</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL0</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set the chip with current rx descriptor address</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *      dwCurrDescAddr  - Descriptor Address</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetCurrRx1DescAddr</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwCurrDescAddr</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ww</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgDMACtl</span><span class="p">;</span>

    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgDMACtl</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgDMACtl</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL1</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x14</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMAPTR1</span><span class="p">,</span> <span class="n">dwCurrDescAddr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgDMACtl</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_RXDMACTL1</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set the chip with current tx0 descriptor address</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *      dwCurrDescAddr  - Descriptor Address</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetCurrTx0DescAddrEx</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwCurrDescAddr</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ww</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgDMACtl</span><span class="p">;</span>

    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMACTL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgDMACtl</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgDMACtl</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMACTL0</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMACTL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x25</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMAPTR0</span><span class="p">,</span> <span class="n">dwCurrDescAddr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgDMACtl</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMACTL0</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set the chip with current AC0 descriptor address</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *      dwCurrDescAddr  - Descriptor Address</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>set packet filter
receive directed and broadcast address</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">MACvSetCurrAC0DescAddrEx</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwCurrDescAddr</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ww</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgDMACtl</span><span class="p">;</span>

    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMACTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgDMACtl</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgDMACtl</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMACTL</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMACTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x26</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x26)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMAPTR</span><span class="p">,</span> <span class="n">dwCurrDescAddr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byOrgDMACtl</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMACTL</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">MACvSetCurrTXDescAddr</span> <span class="p">(</span><span class="kt">int</span> <span class="n">iTxType</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwCurrDescAddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">iTxType</span> <span class="o">==</span> <span class="n">TYPE_AC0DMA</span><span class="p">){</span>
        <span class="n">MACvSetCurrAC0DescAddrEx</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">dwCurrDescAddr</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">iTxType</span> <span class="o">==</span> <span class="n">TYPE_TXDMA0</span><span class="p">){</span>
        <span class="n">MACvSetCurrTx0DescAddrEx</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">dwCurrDescAddr</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Micro Second Delay via MAC</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      uDelay      - Delay time (timer resolution is 4 us)</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvTimer0MicroSDelay</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uDelay</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byValue</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uu</span><span class="p">,</span><span class="n">ii</span><span class="p">;</span>

    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMCTL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMDATA0</span><span class="p">,</span> <span class="n">uDelay</span><span class="p">);</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMCTL0</span><span class="p">,</span> <span class="p">(</span><span class="n">TMCTL_TMD</span> <span class="o">|</span> <span class="n">TMCTL_TE</span><span class="p">));</span>
    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="mi">66</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// assume max PCI clock is 66Mhz</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">uu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uu</span> <span class="o">&lt;</span> <span class="n">uDelay</span><span class="p">;</span> <span class="n">uu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMCTL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byValue</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">byValue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">byValue</span> <span class="o">&amp;</span> <span class="n">TMCTL_TSUSP</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMCTL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMCTL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Micro Second One shot timer via MAC</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      uDelay      - Delay time</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvOneShotTimer0MicroSec</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uDelayTime</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMCTL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMDATA0</span><span class="p">,</span> <span class="n">uDelayTime</span><span class="p">);</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMCTL0</span><span class="p">,</span> <span class="p">(</span><span class="n">TMCTL_TMD</span> <span class="o">|</span> <span class="n">TMCTL_TE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Micro Second One shot timer via MAC</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase    - Base Address for MAC</span>
<span class="cm"> *      uDelay      - Delay time</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvOneShotTimer1MicroSec</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uDelayTime</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMCTL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMDATA1</span><span class="p">,</span> <span class="n">uDelayTime</span><span class="p">);</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TMCTL1</span><span class="p">,</span> <span class="p">(</span><span class="n">TMCTL_TMD</span> <span class="o">|</span> <span class="n">TMCTL_TE</span><span class="p">));</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">MACvSetMISCFifo</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wOffset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wOffset</span> <span class="o">&gt;</span> <span class="mi">273</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">bool</span> <span class="nf">MACbTxDMAOff</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byData</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">TYPE_TXDMA0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMACTL0</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_TXDMACTL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">TYPE_AC0DMA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMACTL</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">DMACTL_RUN</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_AC0DMACTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byData</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byData</span> <span class="o">&amp;</span> <span class="n">DMACTL_RUN</span><span class="p">))</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x29</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x29)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">MACvClearBusSusInd</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwOrgValue</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ww</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>TxDMA1 = AC0DMA</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_ENCFG</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOrgValue</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">dwOrgValue</span> <span class="o">&amp;</span> <span class="n">EnCFG_BcnSusInd</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>check if BcnSusInd enabled</p></td><td class="code"><div class="highlight"><pre>    <span class="n">dwOrgValue</span> <span class="o">=</span> <span class="n">dwOrgValue</span> <span class="o">|</span> <span class="n">EnCFG_BcnSusClr</span><span class="p">;</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_ENCFG</span><span class="p">,</span> <span class="n">dwOrgValue</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_ENCFG</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOrgValue</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">dwOrgValue</span> <span class="o">&amp;</span> <span class="n">EnCFG_BcnSusInd</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x33</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x33)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">MACvEnableBusSusEn</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwOrgValue</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ww</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Set BcnSusClr</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_CFG</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgValue</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>check if BcnSusInd enabled</p></td><td class="code"><div class="highlight"><pre>    <span class="n">byOrgValue</span> <span class="o">=</span> <span class="n">byOrgValue</span> <span class="o">|</span> <span class="n">CFG_BCNSUSEN</span><span class="p">;</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_ENCFG</span><span class="p">,</span> <span class="n">byOrgValue</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_ENCFG</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOrgValue</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dwOrgValue</span> <span class="o">&amp;</span> <span class="n">EnCFG_BcnSusInd</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x34</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x34)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">MACbFlushSYNCFifo</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ww</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>Set BcnSusEn</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MACCR</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgValue</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>Read MACCR</p></td><td class="code"><div class="highlight"><pre>    <span class="n">byOrgValue</span> <span class="o">=</span> <span class="n">byOrgValue</span> <span class="o">|</span> <span class="n">MACCR_SYNCFLUSH</span><span class="p">;</span>
    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MACCR</span><span class="p">,</span> <span class="n">byOrgValue</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>Set SYNCFLUSH</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MACCR</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgValue</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">byOrgValue</span> <span class="o">&amp;</span> <span class="n">MACCR_SYNCFLUSHOK</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x35</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x33)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">MACbPSWakeup</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byOrgValue</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ww</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Check if SyncFlushOK</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">MACbIsRegBitsOff</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">MAC_REG_PSCTL</span><span class="p">,</span> <span class="n">PSCTL_PS</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Read PSCTL</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">dwIoBase</span><span class="p">,</span> <span class="n">MAC_REG_PSCTL</span><span class="p">,</span> <span class="n">PSCTL_PSEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Disable PS</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ww</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ww</span> <span class="o">&lt;</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">ww</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VNSvInPortB</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_PSCTL</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">byOrgValue</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">byOrgValue</span> <span class="o">&amp;</span> <span class="n">PSCTL_WAKEDONE</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ww</span> <span class="o">==</span> <span class="n">W_MAX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0x36</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; DBG_PORT80(0x33)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set the Key by MISCFIFO</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">MACvSetKeyEntry</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wKeyCtl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uEntryIdx</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uKeyIdx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyAddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pdwKey</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byLocalID</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wOffset</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">;</span>
<span class="kt">int</span>     <span class="n">ii</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;MACvSetKeyEntry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">wOffset</span> <span class="o">=</span> <span class="n">MISCFIFO_KEYETRY0</span><span class="p">;</span>
    <span class="n">wOffset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">uEntryIdx</span> <span class="o">*</span> <span class="n">MISCFIFO_KEYENTRYSIZE</span><span class="p">);</span>

    <span class="n">dwData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">|=</span> <span class="n">wKeyCtl</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">|=</span> <span class="n">MAKEWORD</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pbyAddr</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyAddr</span><span class="o">+</span><span class="mi">5</span><span class="p">));</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;1. wOffset: %d, Data: %lX, KeyCtl:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">,</span> <span class="n">dwData</span><span class="p">,</span> <span class="n">wKeyCtl</span><span class="p">);</span>

    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
    <span class="n">wOffset</span><span class="o">++</span><span class="p">;</span>

    <span class="n">dwData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">|=</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyAddr</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">dwData</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">|=</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyAddr</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">dwData</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">|=</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyAddr</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">dwData</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">|=</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyAddr</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;2. wOffset: %d, Data: %lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>

    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
    <span class="n">wOffset</span><span class="o">++</span><span class="p">;</span>

    <span class="n">wOffset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">uKeyIdx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Check if SyncFlushOK</p></td><td class="code"><div class="highlight"><pre>        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;3.(%d) wOffset: %d, Data: %lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">wOffset</span><span class="o">+</span><span class="n">ii</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwKey</span><span class="p">);</span>
        <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="o">+</span><span class="n">ii</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwKey</span><span class="o">++</span><span class="p">);</span>
        <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Disable the Key Entry by MISCFIFO</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvDisableKeyEntry</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uEntryIdx</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wOffset</span><span class="p">;</span>

    <span class="n">wOffset</span> <span class="o">=</span> <span class="n">MISCFIFO_KEYETRY0</span><span class="p">;</span>
    <span class="n">wOffset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">uEntryIdx</span> <span class="o">*</span> <span class="n">MISCFIFO_KEYENTRYSIZE</span><span class="p">);</span>

    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set the default Key (KeyEntry[10]) by MISCFIFO</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">MACvSetDefaultKeyEntry</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uKeyLen</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uKeyIdx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pdwKey</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byLocalID</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wOffset</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">;</span>
<span class="kt">int</span>     <span class="n">ii</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;MACvSetDefaultKeyEntry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">wOffset</span> <span class="o">=</span> <span class="n">MISCFIFO_KEYETRY0</span><span class="p">;</span>
    <span class="n">wOffset</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">MISCFIFO_KEYENTRYSIZE</span><span class="p">);</span>

    <span class="n">wOffset</span><span class="o">++</span><span class="p">;</span>
    <span class="n">wOffset</span><span class="o">++</span><span class="p">;</span>
    <span class="n">wOffset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">uKeyIdx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>alway push 128 bits</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;(%d) wOffset: %d, Data: %lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">wOffset</span><span class="o">+</span><span class="n">ii</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwKey</span><span class="p">);</span>
        <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="o">+</span><span class="n">ii</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwKey</span><span class="o">++</span><span class="p">);</span>
        <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dwData</span> <span class="o">=</span> <span class="o">*</span><span class="n">pdwKey</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uKeyLen</span> <span class="o">==</span> <span class="n">WLAN_WEP104_KEYLEN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dwData</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;End. wOffset: %d, Data: %lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wOffset</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Enable default Key (KeyEntry[10]) by MISCFIFO</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm">void MACvEnableDefaultKey (unsigned long dwIoBase, unsigned char byLocalID)</span>
<span class="cm">{</span>
<span class="cm">unsigned short wOffset;</span>
<span class="cm">unsigned long dwData;</span>


<span class="cm">    if (byLocalID &lt;= 1)</span>
<span class="cm">        return;</span>

<span class="cm">    wOffset = MISCFIFO_KEYETRY0;</span>
<span class="cm">    wOffset += (10 * MISCFIFO_KEYENTRYSIZE);</span>

<span class="cm">    dwData = 0xC0440000;</span>
<span class="cm">    VNSvOutPortW(dwIoBase + MAC_REG_MISCFFNDEX, wOffset);</span>
<span class="cm">    VNSvOutPortD(dwIoBase + MAC_REG_MISCFFDATA, dwData);</span>
<span class="cm">    VNSvOutPortW(dwIoBase + MAC_REG_MISCFFCTL, MISCFFCTL_WRITE);</span>
<span class="cm">    DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO&quot;MACvEnableDefaultKey: wOffset: %d, Data: %lX\n&quot;, wOffset, dwData);</span>

<span class="cm">}</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Disable default Key (KeyEntry[10]) by MISCFIFO</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvDisableDefaultKey</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wOffset</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">;</span>


    <span class="n">wOffset</span> <span class="o">=</span> <span class="n">MISCFIFO_KEYETRY0</span><span class="p">;</span>
    <span class="n">wOffset</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">MISCFIFO_KEYENTRYSIZE</span><span class="p">);</span>

    <span class="n">dwData</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;MACvDisableDefaultKey: wOffset: %d, Data: %lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set the default TKIP Group Key (KeyEntry[10]) by MISCFIFO</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">MACvSetDefaultTKIPKeyEntry</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uKeyLen</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uKeyIdx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pdwKey</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byLocalID</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wOffset</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">;</span>
<span class="kt">int</span>     <span class="n">ii</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;MACvSetDefaultTKIPKeyEntry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">wOffset</span> <span class="o">=</span> <span class="n">MISCFIFO_KEYETRY0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>alway push 128 bits</p></td><td class="code"><div class="highlight"><pre>    <span class="n">wOffset</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">MISCFIFO_KEYENTRYSIZE</span><span class="p">);</span>

    <span class="n">dwData</span> <span class="o">=</span> <span class="mh">0xC0660000</span><span class="p">;</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
    <span class="n">wOffset</span><span class="o">++</span><span class="p">;</span>

    <span class="n">dwData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
    <span class="n">wOffset</span><span class="o">++</span><span class="p">;</span>

    <span class="n">wOffset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">uKeyIdx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;1. wOffset: %d, Data: %lX, idx:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwKey</span><span class="p">,</span> <span class="n">uKeyIdx</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>Kyle test : change offset from 10 -> 0</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;2.(%d) wOffset: %d, Data: %lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">wOffset</span><span class="o">+</span><span class="n">ii</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwKey</span><span class="p">);</span>
        <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="o">+</span><span class="n">ii</span><span class="p">);</span>
        <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwKey</span><span class="o">++</span><span class="p">);</span>
        <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Set the Key Control by MISCFIFO</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      dwIoBase        - Base Address for MAC</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">MACvSetDefaultKeyCtl</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwIoBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wKeyCtl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uEntryIdx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byLocalID</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wOffset</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dwData</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;MACvSetKeyEntry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">wOffset</span> <span class="o">=</span> <span class="n">MISCFIFO_KEYETRY0</span><span class="p">;</span>
    <span class="n">wOffset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">uEntryIdx</span> <span class="o">*</span> <span class="n">MISCFIFO_KEYENTRYSIZE</span><span class="p">);</span>

    <span class="n">dwData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">|=</span> <span class="n">wKeyCtl</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">dwData</span> <span class="o">|=</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;1. wOffset: %d, Data: %lX, KeyCtl:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">,</span> <span class="n">dwData</span><span class="p">,</span> <span class="n">wKeyCtl</span><span class="p">);</span>

    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFNDEX</span><span class="p">,</span> <span class="n">wOffset</span><span class="p">);</span>
    <span class="n">VNSvOutPortD</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFDATA</span><span class="p">,</span> <span class="n">dwData</span><span class="p">);</span>
    <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">dwIoBase</span> <span class="o">+</span> <span class="n">MAC_REG_MISCFFCTL</span><span class="p">,</span> <span class="n">MISCFFCTL_WRITE</span><span class="p">);</span>

<span class="p">}</span>

</pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>alway push 128 bits</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
