<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6655 › wcmd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wcmd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * File: wcmd.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Handles the management command interface functions</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Lyndon Chen</span>
<span class="cm"> *</span>
<span class="cm"> * Date: May 8, 2003</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *      s_vProbeChannel - Active scan channel</span>
<span class="cm"> *      s_MgrMakeProbeRequest - Make ProbeRequest packet</span>
<span class="cm"> *      CommandTimer - Timer function to handle command</span>
<span class="cm"> *      s_bCommandComplete - Command Complete function</span>
<span class="cm"> *      bScheduleCommand - Push Command and wait Command Scheduler to do</span>
<span class="cm"> *      vCommandTimer- Command call back functions</span>
<span class="cm"> *      vCommandTimerWait- Call back timer</span>
<span class="cm"> *      bClearBSSID_SCAN- Clear BSSID_SCAN cmd in CMD Queue</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ttype.h&quot;</span>
<span class="cp">#include &quot;tmacro.h&quot;</span>
<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;mac.h&quot;</span>
<span class="cp">#include &quot;card.h&quot;</span>
<span class="cp">#include &quot;80211hdr.h&quot;</span>
<span class="cp">#include &quot;wcmd.h&quot;</span>
<span class="cp">#include &quot;wmgr.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>
<span class="cp">#include &quot;wctl.h&quot;</span>
<span class="cp">#include &quot;baseband.h&quot;</span>
<span class="cp">#include &quot;rxtx.h&quot;</span>
<span class="cp">#include &quot;rf.h&quot;</span>
<span class="cp">#include &quot;iowpa.h&quot;</span>
<span class="cp">#include &quot;channel.h&quot;</span>

<span class="cm">/*---------------------  Static Definitions -------------------------*/</span>




<span class="cm">/*---------------------  Static Classes  ----------------------------*/</span>

<span class="cm">/*---------------------  Static Variables  --------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span><span class="n">MSG_LEVEL_INFO</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>static int          msglevel                =MSG<em>LEVEL</em>DEBUG;</p></td><td class="code"><div class="highlight"><pre><span class="cm">/*---------------------  Static Functions  --------------------------*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vProbeChannel</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span>
    <span class="p">);</span>


<span class="k">static</span>
<span class="n">PSTxMgmtPacket</span>
<span class="n">s_MgrMakeProbeRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pScanBSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">);</span>


<span class="k">static</span>
<span class="n">bool</span>
<span class="n">s_bCommandComplete</span> <span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span>
    <span class="p">);</span>

<span class="cm">/*---------------------  Export Variables  --------------------------*/</span>


<span class="cm">/*---------------------  Export Functions  --------------------------*/</span>



<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Stop AdHoc beacon during scan process</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice     - Pointer to the adapter</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">vAdHocBeaconStop</span><span class="p">(</span><span class="n">PSDevice</span>  <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">bool</span> <span class="n">bStop</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * temporarily stop Beacon packet for AdHoc Server</span>
<span class="cm">     * if all of the following coditions are met:</span>
<span class="cm">     *  (1) STA is in AdHoc mode</span>
<span class="cm">     *  (2) VT3253 is programmed as automatic Beacon Transmitting</span>
<span class="cm">     *  (3) One of the following conditions is met</span>
<span class="cm">     *      (3.1) AdHoc channel is in B/G band and the</span>
<span class="cm">     *      current scan channel is in A band</span>
<span class="cm">     *      or</span>
<span class="cm">     *      (3.2) AdHoc channel is in A mode</span>
<span class="cm">     */</span>
    <span class="n">bStop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">&gt;=</span> <span class="n">WMAC_STATE_STARTED</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uIBSSChannel</span> <span class="o">&lt;=</span>  <span class="n">CB_MAX_CHANNEL_24G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
             <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span> <span class="o">&gt;</span> <span class="n">CB_MAX_CHANNEL_24G</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">bStop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uIBSSChannel</span> <span class="o">&gt;</span>  <span class="n">CB_MAX_CHANNEL_24G</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">bStop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bStop</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_TCR</span><span class="p">,</span> <span class="n">TCR_AUTOBCNTX</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="cm">/* vAdHocBeaconStop */</span>


<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Restart AdHoc beacon after scan process complete</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice     - Pointer to the adapter</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">vAdHocBeaconRestart</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * Restart Beacon packet for AdHoc Server</span>
<span class="cm">     * if all of the following coditions are met:</span>
<span class="cm">     *  (1) STA is in AdHoc mode</span>
<span class="cm">     *  (2) VT3253 is programmed as automatic Beacon Transmitting</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">&gt;=</span> <span class="n">WMAC_STATE_STARTED</span><span class="p">))</span>
    <span class="p">{</span>
         <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_TCR</span><span class="p">,</span> <span class="n">TCR_AUTOBCNTX</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>






<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Prepare and send probe request management frames.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    none.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vProbeChannel</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span>
    <span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>1M,   2M,   5M,   11M,  18M,  24M,  36M,  54M</p></td><td class="code"><div class="highlight"><pre>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrSuppRatesG</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WLAN_EID_SUPP_RATES</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrExtSuppRatesG</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WLAN_EID_EXTSUPP_RATES</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">};</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>6M,   9M,   12M,  48M</p></td><td class="code"><div class="highlight"><pre>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrSuppRatesA</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WLAN_EID_SUPP_RATES</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrSuppRatesB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WLAN_EID_SUPP_RATES</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRate</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>  <span class="n">pTxPacket</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pbyRate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">abyCurrSuppRatesA</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pbyRate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">abyCurrSuppRatesB</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pbyRate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">abyCurrSuppRatesG</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>build an assocreq frame and send it</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="n">s_MgrMakeProbeRequest</span>
                <span class="p">(</span>
                  <span class="n">pDevice</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanBSSID</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanSSID</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pbyRate</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">abyCurrExtSuppRatesG</span>
                <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pTxPacket</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Probe request sending fail.. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Probe request is sending.. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>




<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *  Constructs an probe request frame</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    A ptr to Tx frame or NULL on allocation failue</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="n">PSTxMgmtPacket</span>
<span class="nf">s_MgrMakeProbeRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pScanBSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>

    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WLAN_FR_PROBEREQ</span>    <span class="n">sFrame</span><span class="p">;</span>


    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_PROBEREQ_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_PROBEREQ_FR_MAXLEN</span><span class="p">;</span>
    <span class="n">vMgrEncodeProbeRequest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_PROBEREQ</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pScanBSSID</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pScanBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Copy the SSID, pSSID->len=0 indicate broadcast SSID</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">,</span> <span class="n">pSSID</span><span class="p">,</span> <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Copy the extension rate set</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pCurrExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span> <span class="n">pCurrExtSuppRates</span><span class="p">,</span> <span class="n">pCurrExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">pTxPacket</span><span class="p">;</span>
<span class="p">}</span>





<span class="kt">void</span>
<span class="nf">vCommandTimerWait</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MSecond</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>

    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">vCommandTimer</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>RUN_AT :1 msec ~= (HZ/1024)</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">RUN_AT</span><span class="p">((</span><span class="n">MSecond</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>




<span class="kt">void</span>
<span class="nf">vCommandTimer</span> <span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SSID</span>   <span class="n">pItemSSID</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SSID</span>   <span class="n">pItemSSIDCurr</span><span class="p">;</span>
    <span class="n">CMD_STATUS</span>      <span class="n">Status</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byMask</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">};</span>
    <span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">skb</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwDiagRefCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdRunning</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">case</span> <span class="n">WLAN_CMD_SCAN_START</span>:

	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRadioOff</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">OP_MODE_AP</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;eCommandState= WLAN_CMD_SCAN_START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanSSID</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>wait all Data TD complete</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">iTDUsed</span><span class="p">[</span><span class="n">TYPE_AC0DMA</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byMinChannel</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Set Baseband to be more sensitive.</p></td><td class="code"><div class="highlight"><pre>            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span> <span class="o">&gt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byMaxChannel</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanState</span> <span class="o">=</span> <span class="n">WMAC_NO_SCANNING</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Set Baseband's sensitivity back.
Set channel back</p></td><td class="code"><div class="highlight"><pre>                <span class="n">set_channel</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Scanning, set back to channel: [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">OP_MODE_ADHOC</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">OP_MODE_INFRASTRUCTURE</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">vAdHocBeaconRestart</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>2008-8-4 <add> by chester</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_channel_valid</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Invalid channel pMgmt-&gt;uScanChannel = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span><span class="p">);</span>
                    <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>printk("chester-pMgmt->uScanChannel=%d,pDevice->byMaxChannel=%d\n",pMgmt->uScanChannel,pDevice->byMaxChannel);</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span> <span class="o">==</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byMinChannel</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>pMgmt->eScanType = WMAC<em>SCAN</em>ACTIVE;</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanBSSID</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanBSSID</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanBSSID</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanBSSID</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanBSSID</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
                    <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>clear bssid list
BSSvClearBSSList((void *)pDevice, pDevice->bLinkPass);</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanState</span> <span class="o">=</span> <span class="n">WMAC_IS_SCANNING</span><span class="p">;</span>

                <span class="p">}</span>

                <span class="n">vAdHocBeaconStop</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">set_channel</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;SCAN Channel: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;SET SCAN Channel Fail: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">OP_MODE_UNKNOWN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>printk("chester-mxch=%d\n",pDevice->byMaxChannel);
         printk("chester-ch=%d\n",pMgmt->uScanChannel);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>2008-8-4 <modify> by chester</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_channel_valid</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span> <span class="o">&lt;=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byMaxChannel</span> <span class="p">){</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span><span class="o">=</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byMaxChannel</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_SCAN_END</span><span class="p">;</span>

                <span class="p">}</span>


                <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">b11hEnable</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span> <span class="o">&lt;</span> <span class="n">CB_MAX_CHANNEL_24G</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">s_vProbeChannel</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                    <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WCMD_ACTIVE_SCAN_TIME</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                    <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">WCMD_PASSIVE_SCAN_TIME</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

            <span class="p">}</span>

            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_CMD_SCAN_END</span>:</pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Set Baseband's sensitivity back.
Set channel back</p></td><td class="code"><div class="highlight"><pre>            <span class="n">set_channel</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">);</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Scanning, set back to channel: [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">OP_MODE_ADHOC</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">OP_MODE_INFRASTRUCTURE</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanState</span> <span class="o">=</span> <span class="n">WMAC_NO_SCANNING</span><span class="p">;</span>
            <span class="n">vAdHocBeaconRestart</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>2008-0409-07, <Add> by Einsn Liu</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">==</span> <span class="n">WMAC_SCAN_PASSIVE</span><span class="p">)</span>
			<span class="p">{</span><span class="c1">//send scan event to wpa_Supplicant</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
				<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_CMD_DISASSOCIATE_START</span> :
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">!=</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Send Disassociation Packet..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>reason = 8 : disassoc because sta has left</p></td><td class="code"><div class="highlight"><pre>                <span class="n">vMgrDisassocBeginSta</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">Status</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>unlock command busy</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">;</span>
                <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">memset</span><span class="p">(</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><pre><code>           pDevice-&gt;bBeaconBufReady = false;
</code></pre></td><td class="code"><div class="highlight"><pre>            <span class="p">}</span>
            <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_DISASSOCIATE_WAIT</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>wait all Control TD complete</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">iTDUsed</span><span class="p">[</span><span class="n">TYPE_TXDMA0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
                <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; CARDbRadioPowerOff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>2008-09-02  <mark>    by chester
CARDbRadioPowerOff(pDevice);</p></td><td class="code"><div class="highlight"><pre>            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_DISASSOCIATE_WAIT</span> :</pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>wait all Control TD complete</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">iTDUsed</span><span class="p">[</span><span class="n">TYPE_TXDMA0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
                <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>2008-09-02  <mark> by chester
CARDbRadioPowerOff(pDevice);</p></td><td class="code"><div class="highlight"><pre>            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_CMD_SSID_START</span>:
        	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRadioOff</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>printk("chester-currmode=%d\n",pMgmt->eCurrMode);</p></td><td class="code"><div class="highlight"><pre><span class="n">printk</span><span class="p">(</span><span class="s">&quot;chester-abyDesireSSID=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>memcpy(pMgmt->abyAdHocSSID,pMgmt->abyDesireSSID,
((PWLAN<em>IE</em>SSID)pMgmt->abyDesireSSID)->len + WLAN<em>IEHDR</em>LEN);</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">;</span>
            <span class="n">pItemSSIDCurr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">;</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; cmd: desire ssid = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; cmd: curr ssid = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pItemSSIDCurr</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; Cmd pMgmt-&gt;eCurrState == WMAC_STATE_ASSOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; pItemSSID-&gt;len =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; pItemSSIDCurr-&gt;len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pItemSSIDCurr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; desire ssid = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; curr ssid = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pItemSSIDCurr</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span><span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_JOINTED</span><span class="p">)))</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">pItemSSIDCurr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="n">pItemSSIDCurr</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>set initial state</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_STANDBY</span><span class="p">;</span>
            <span class="n">PSvDisablePowerSaving</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="n">BSSvClearNodeDBTable</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

            <span class="n">vMgrJoinBSSBegin</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Status</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>if Infra mode</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_JOINTED</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Call mgr to begin the deauthentication
reason = (3) because sta has left ESS</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span><span class="o">&gt;=</span> <span class="n">WMAC_STATE_AUTH</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">vMgrDeAuthenBeginSta</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">Status</span><span class="p">);</span>
                <span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Call mgr to begin the authentication</p></td><td class="code"><div class="highlight"><pre>                <span class="n">vMgrAuthenBeginSta</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Status</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_AUTHENTICATE_WAIT</span><span class="p">;</span>
                    <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">AUTHENTICATE_TIMEOUT</span><span class="p">);</span>
                    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; Set eCommandState = WLAN_AUTHENTICATE_WAIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>if Adhoc mode</p></td><td class="code"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_JOINTED</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)){</span>
                        <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">bClearBSSID_SCAN</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>start own IBSS</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">vMgrCreateOwnIBSS</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Status</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">){</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; WLAN_CMD_IBSS_CREATE fail ! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="n">BSSvAddMulticastNode</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>if SSID not found</p></td><td class="code"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_STANDBY</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_IBSS_STA</span> <span class="o">||</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AUTO</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>start own IBSS</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">vMgrCreateOwnIBSS</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Status</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">){</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; WLAN_CMD_IBSS_CREATE fail ! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="n">BSSvAddMulticastNode</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)){</span>
                        <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Disconnect SSID none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		  <span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>if(pDevice->bWPASuppWextEnabled == true)</p></td><td class="code"><div class="highlight"><pre>                        <span class="p">{</span>
                  	<span class="k">union</span> <span class="n">iwreq_data</span>  <span class="n">wrqu</span><span class="p">;</span>
                  	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
                          <span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
                  	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wireless_send_event---&gt;SIOCGIWAP(disassociated:vMgrJoinBSSBegin Fail !!)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                  	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                       <span class="p">}</span>
                    <span class="cp">#endif</span>

                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_AUTHENTICATE_WAIT</span> :
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;eCommandState == WLAN_AUTHENTICATE_WAIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_AUTH</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Call mgr to begin the association</p></td><td class="code"><div class="highlight"><pre>                	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;eCurrState == WMAC_STATE_AUTH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">vMgrAssocBeginSta</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Status</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;eCommandState = WLAN_ASSOCIATE_WAIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_ASSOCIATE_WAIT</span><span class="p">;</span>
                    <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">ASSOCIATE_TIMEOUT</span><span class="p">);</span>
                    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">&lt;</span> <span class="n">WMAC_STATE_AUTHPENDING</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">printk</span><span class="p">(</span><span class="s">&quot;WLAN_AUTHENTICATE_WAIT:Authen Fail???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	   <span class="p">}</span>
	   <span class="k">else</span>  <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">){</span>    <span class="c1">//mike add:wait another 2 sec if authenticated_frame delay!</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">++</span><span class="p">;</span>
	       <span class="n">printk</span><span class="p">(</span><span class="s">&quot;WLAN_AUTHENTICATE_WAIT:wait %d times!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span><span class="p">);</span>
	       <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	       <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">AUTHENTICATE_TIMEOUT</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	       <span class="k">return</span><span class="p">;</span>
	   <span class="p">}</span>
	          <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="cp">#if 0</span><span class="c"></span>
<span class="cp">                     #ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>if(pDevice->bWPASuppWextEnabled == true)</p></td><td class="code"><div class="highlight"><pre><span class="c">                        {</span>
<span class="c">                  	union iwreq_data  wrqu;</span>
<span class="c">                  	memset(&amp;wrqu, 0, sizeof (wrqu));</span>
<span class="c">                          wrqu.ap_addr.sa_family = ARPHRD_ETHER;</span>
<span class="c">                  	printk(&quot;wireless_send_event---&gt;SIOCGIWAP(disassociated:AUTHENTICATE_WAIT_timeout)\n&quot;);</span>
<span class="c">                  	wireless_send_event(pDevice-&gt;dev, SIOCGIWAP, &amp;wrqu, NULL);</span>
<span class="c">                       }</span>
<span class="cp">                    #endif</span>
<span class="cp">	         #endif</span>
            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_ASSOCIATE_WAIT</span> :
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;eCurrState == WMAC_STATE_ASSOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ePSMode</span> <span class="o">!=</span> <span class="n">WMAC_POWER_CAM</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">PSvEnablePowerSaving</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">&gt;=</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">KeybRemoveAllKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">bClearBSSID_SCAN</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byFOETuning</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">BBvSetFOE</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                    <span class="n">PSbSendNullPacket</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)){</span>
                    <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                <span class="p">}</span>
	     <span class="cp">#ifdef TxInSleep</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">IsTxDataTrigger</span> <span class="o">!=</span> <span class="nb">false</span><span class="p">)</span>   <span class="p">{</span>    <span class="c1">//TxDataTimer is not triggered at the first time</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>printk("Re-initial TxDataTimer<em>*</em>*\n");</p></td><td class="code"><div class="highlight"><pre>		    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">);</span>
                      <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">);</span>
                      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>
                      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">BSSvSecondTxData</span><span class="p">;</span>
                      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>      <span class="c1">//10s callback</span>
                      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fTxDataInSleep</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">nTxDataTimeCout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="p">}</span>
		 <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>printk("mike:-->First time triger TimerTxData InSleep\n");</p></td><td class="code"><div class="highlight"><pre>		 <span class="p">}</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">IsTxDataTrigger</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">);</span>
             <span class="cp">#endif</span>
            <span class="p">}</span>
		   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">&lt;</span> <span class="n">WMAC_STATE_ASSOCPENDING</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">printk</span><span class="p">(</span><span class="s">&quot;WLAN_ASSOCIATE_WAIT:Association Fail???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	   <span class="p">}</span>
	   <span class="k">else</span>  <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">){</span>    <span class="c1">//mike add:wait another 2 sec if associated_frame delay!</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">++</span><span class="p">;</span>
	       <span class="n">printk</span><span class="p">(</span><span class="s">&quot;WLAN_ASSOCIATE_WAIT:wait %d times!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span><span class="p">);</span>
	       <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	       <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">ASSOCIATE_TIMEOUT</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	       <span class="k">return</span><span class="p">;</span>
	   <span class="p">}</span>
	          <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLinkWaitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cp">#if 0</span><span class="c"></span>
<span class="cp">                     #ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>if(pDevice->bWPASuppWextEnabled == true)</p></td><td class="code"><div class="highlight"><pre><span class="c">                        {</span>
<span class="c">                  	union iwreq_data  wrqu;</span>
<span class="c">                  	memset(&amp;wrqu, 0, sizeof (wrqu));</span>
<span class="c">                          wrqu.ap_addr.sa_family = ARPHRD_ETHER;</span>
<span class="c">                  	printk(&quot;wireless_send_event---&gt;SIOCGIWAP(disassociated:ASSOCIATE_WAIT_timeout)\n&quot;);</span>
<span class="c">                  	wireless_send_event(pDevice-&gt;dev, SIOCGIWAP, &amp;wrqu, NULL);</span>
<span class="c">                       }</span>
<span class="cp">                    #endif</span>
<span class="cp">		#endif</span>

            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_CMD_AP_MODE_START</span> :
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;eCommandState == WLAN_CMD_AP_MODE_START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_STANDBY</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
                    <span class="n">BSSvClearNodeDBTable</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">else</span>
                    <span class="n">BSSvClearNodeDBTable</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

                <span class="n">vMgrCreateOwnIBSS</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Status</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">){</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; vMgrCreateOwnIBSS fail ! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>alway turn off unicast bit</p></td><td class="code"><div class="highlight"><pre>                <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="n">RCR_UNICAST</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RCR_UNICAST</span><span class="p">;</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;wcmd: rx_mode = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="p">);</span>
                <span class="n">BSSvAddMulticastNode</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)){</span>
                    <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_CMD_TX_PSPACKET_START</span> :</pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>DTIM Multicast tx</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bRxPSPoll</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">byMask</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bMoreData</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bMoreData</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_dma0_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Multicast ps tx fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="o">--</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>PS nodes tx</p></td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_NODE_NUM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span> <span class="o">&amp;&amp;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bRxPSPoll</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Index=%d Enqueu Cnt= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                               <span class="n">ii</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="p">);</span>
                    <span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>clear tx map</p></td><td class="code"><div class="highlight"><pre>                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span>
                                    <span class="o">~</span><span class="n">byMask</span><span class="p">[</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">wAID</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bMoreData</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bMoreData</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_dma0_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ii</span><span class="p">))</span> <span class="p">{</span>
                            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;sta ps tx fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="o">--</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>check if sta ps enable, wait next pspoll
if sta ps disable, send all pending buffers.</p></td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span>
                            <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>clear tx map</p></td><td class="code"><div class="highlight"><pre>                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span>
                                    <span class="o">~</span><span class="n">byMask</span><span class="p">[</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">wAID</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Index=%d PS queue clear </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bRxPSPoll</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>


        <span class="k">case</span> <span class="n">WLAN_CMD_RADIO_START</span> :
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;eCommandState == WLAN_CMD_RADIO_START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRadioCmd</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
                <span class="n">CARDbRadioPowerOn</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="n">CARDbRadioPowerOff</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>


        <span class="k">case</span> <span class="n">WLAN_CMD_CHECK_BBSENSITIVITY_CHANGE</span> :</pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"eCommandState == WLAN<em>CMD</em>CHECK<em>BBSENSITIVITY</em>START\n");
wait all TD complete</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">iTDUsed</span><span class="p">[</span><span class="n">TYPE_AC0DMA</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
                <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">iTDUsed</span><span class="p">[</span><span class="n">TYPE_TXDMA0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
                <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span><span class="p">;</span>
            <span class="n">BBvSetVGAGainOffset</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span><span class="p">);</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;SetVGAGainOffset %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span><span class="p">);</span>
            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span> <span class="o">:</span>
            <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

    <span class="p">}</span> <span class="c1">//switch</span>
    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">static</span>
<span class="n">bool</span>
<span class="nf">s_bCommandComplete</span> <span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pSSID</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bRadioCmd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>unsigned short wDeAuthenReason = 0;</p></td><td class="code"><div class="highlight"><pre>    <span class="n">bool</span> <span class="n">bForceSCAN</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>  <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>


    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_IDLE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeCmdQueue</span> <span class="o">==</span> <span class="n">CMD_Q_SIZE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Command Queue Empty</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdRunning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommand</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdDequeueIdx</span><span class="p">].</span><span class="n">eCmd</span><span class="p">;</span>
        <span class="n">pSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdDequeueIdx</span><span class="p">].</span><span class="n">abyCmdDesireSSID</span><span class="p">;</span>
        <span class="n">bRadioCmd</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdDequeueIdx</span><span class="p">].</span><span class="n">bRadioCmd</span><span class="p">;</span>
        <span class="n">bForceSCAN</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdDequeueIdx</span><span class="p">].</span><span class="n">bForceSCAN</span><span class="p">;</span>
        <span class="n">ADD_ONE_WITH_WRAP_AROUND</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdDequeueIdx</span><span class="p">,</span> <span class="n">CMD_Q_SIZE</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeCmdQueue</span><span class="o">++</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdRunning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommand</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">WLAN_CMD_BSSID_SCAN</span>:
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;eCommandState= WLAN_CMD_BSSID_SCAN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_SCAN_START</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uScanChannel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanSSID</span><span class="p">,</span> <span class="n">pSSID</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyScanSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">                if ((bForceSCAN == false) &amp;&amp; (pDevice-&gt;bLinkPass == true)) {</span>
<span class="cm">                    if ((pSSID-&gt;len == ((PWLAN_IE_SSID)pMgmt-&gt;abyCurrSSID)-&gt;len) &amp;&amp;</span>
<span class="cm">                        ( !memcmp(pSSID-&gt;abySSID, ((PWLAN_IE_SSID)pMgmt-&gt;abyCurrSSID)-&gt;abySSID, pSSID-&gt;len))) {</span>
<span class="cm">                        pDevice-&gt;eCommandState = WLAN_CMD_IDLE;</span>
<span class="cm">                    }</span>
<span class="cm">                }</span>
<span class="cm">*/</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">WLAN_CMD_SSID</span>:
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_SSID_START</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">)</span>
                    <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">,</span> <span class="n">pSSID</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;eCommandState= WLAN_CMD_SSID_START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">WLAN_CMD_DISASSOCIATE</span>:
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_DISASSOCIATE_START</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">WLAN_CMD_RX_PSPOLL</span>:
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_TX_PSPACKET_START</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">WLAN_CMD_RUN_AP</span>:
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_AP_MODE_START</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">WLAN_CMD_RADIO</span>:
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_RADIO_START</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRadioCmd</span> <span class="o">=</span> <span class="n">bRadioCmd</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">WLAN_CMD_CHANGE_BBSENSITIVITY</span>:
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_CHECK_BBSENSITIVITY_CHANGE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="nl">default:</span>
                <span class="k">break</span><span class="p">;</span>

        <span class="p">}</span>

        <span class="n">vCommandTimerWait</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>



<span class="n">bool</span> <span class="nf">bScheduleCommand</span> <span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">CMD_CODE</span>    <span class="n">eCommand</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyItem0</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeCmdQueue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">].</span><span class="n">eCmd</span> <span class="o">=</span> <span class="n">eCommand</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">].</span><span class="n">bForceSCAN</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">].</span><span class="n">abyCmdDesireSSID</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pbyItem0</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">eCommand</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">case</span> <span class="n">WLAN_CMD_BSSID_SCAN</span>:
                <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">].</span><span class="n">abyCmdDesireSSID</span><span class="p">,</span>
                         <span class="n">pbyItem0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">].</span><span class="n">bForceSCAN</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">WLAN_CMD_SSID</span>:
                <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">].</span><span class="n">abyCmdDesireSSID</span><span class="p">,</span>
                         <span class="n">pbyItem0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">WLAN_CMD_DISASSOCIATE</span>:
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">].</span><span class="n">bNeedRadioOFF</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyItem0</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">            case WLAN_CMD_DEAUTH:</span>
<span class="cm">                pDevice-&gt;eCmdQueue[pDevice-&gt;uCmdEnqueueIdx].wDeAuthenReason = *((unsigned short *)pbyItem0);</span>
<span class="cm">                break;</span>
<span class="cm">*/</span>

            <span class="k">case</span> <span class="n">WLAN_CMD_RX_PSPOLL</span>:
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">WLAN_CMD_RADIO</span>:
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">].</span><span class="n">bRadioCmd</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyItem0</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">WLAN_CMD_CHANGE_BBSENSITIVITY</span>:
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_CHECK_BBSENSITIVITY_CHANGE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="nl">default:</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">ADD_ONE_WITH_WRAP_AROUND</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">,</span> <span class="n">CMD_Q_SIZE</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeCmdQueue</span><span class="o">--</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdRunning</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s_bCommandComplete</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Clear BSSID_SCAN cmd in CMD Queue</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      hDeviceContext  - Pointer to the adapter</span>
<span class="cm"> *      eCommand        - Command</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: true if success; otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">bClearBSSID_SCAN</span> <span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uCmdDequeueIdx</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdDequeueIdx</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeCmdQueue</span> <span class="o">&lt;</span> <span class="n">CMD_Q_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">uCmdDequeueIdx</span> <span class="o">!=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">CMD_Q_SIZE</span> <span class="o">-</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeCmdQueue</span><span class="p">);</span> <span class="n">ii</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">uCmdDequeueIdx</span><span class="p">].</span><span class="n">eCmd</span> <span class="o">==</span> <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCmdQueue</span><span class="p">[</span><span class="n">uCmdDequeueIdx</span><span class="p">].</span><span class="n">eCmd</span> <span class="o">=</span> <span class="n">WLAN_CMD_IDLE</span><span class="p">;</span>
            <span class="n">ADD_ONE_WITH_WRAP_AROUND</span><span class="p">(</span><span class="n">uCmdDequeueIdx</span><span class="p">,</span> <span class="n">CMD_Q_SIZE</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">uCmdDequeueIdx</span> <span class="o">==</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>mike add:reset command timer</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span>
<span class="nf">vResetCommandTimer</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span>
    <span class="p">)</span>
<span class="p">{</span>
  <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>delete timer</p></td><td class="code"><div class="highlight"><pre>      <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>init timer</p></td><td class="code"><div class="highlight"><pre>      <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">vCommandTimer</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeCmdQueue</span> <span class="o">=</span> <span class="n">CMD_Q_SIZE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdDequeueIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">=</span> <span class="n">WLAN_CMD_IDLE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdRunning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdClear</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef TxInSleep</span>
<span class="kt">void</span>
<span class="nf">BSSvSecondTxData</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span>
    <span class="p">)</span>
<span class="p">{</span>
  <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
  <span class="n">PSMgmtObject</span>  <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">nTxDataTimeCout</span><span class="o">++</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">nTxDataTimeCout</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">)</span>     <span class="c1">//don&#39;t tx data if timer less than 40s</span>
    <span class="p">{</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>printk("mike:%s-->no data Tx not exceed the desired Time as %d\n",<strong>FUNCTION</strong>,
     (int)pDevice->nTxDataTimeCout);</p></td><td class="code"><div class="highlight"><pre>     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>      <span class="c1">//10s callback</span>
     <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  <span class="cp">#if 1</span>
  <span class="k">if</span><span class="p">(((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span><span class="nb">true</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">&lt;</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">))</span> <span class="o">||</span>  <span class="c1">//open &amp;&amp; sharekey linking</span>
      <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fWPA_Authened</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>   <span class="c1">//wpa linking</span>
 <span class="cp">#else</span>
  <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
 <span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>printk("mike:%s-->InSleep Tx Data Procedure\n",<strong>FUNCTION</strong>);</p></td><td class="code"><div class="highlight"><pre>	  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fTxDataInSleep</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">PSbSendNullPacket</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>      <span class="c1">//send null packet</span>
	  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fTxDataInSleep</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  	<span class="p">}</span>
  <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>      <span class="c1">//10s callback</span>
  <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
