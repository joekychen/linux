<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6655 › wmgr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wmgr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * File: wmgr.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Handles the 802.11 management functions</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Lyndon Chen</span>
<span class="cm"> *</span>
<span class="cm"> * Date: May 8, 2002</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *      nsMgrObjectInitial - Initialize Management Objet data structure</span>
<span class="cm"> *      vMgrObjectReset - Reset Management Objet data structure</span>
<span class="cm"> *      vMgrAssocBeginSta - Start associate function</span>
<span class="cm"> *      vMgrReAssocBeginSta - Start reassociate function</span>
<span class="cm"> *      vMgrDisassocBeginSta - Start disassociate function</span>
<span class="cm"> *      s_vMgrRxAssocRequest - Handle Rcv associate_request</span>
<span class="cm"> *      s_vMgrRxAssocResponse - Handle Rcv associate_response</span>
<span class="cm"> *      vMrgAuthenBeginSta - Start authentication function</span>
<span class="cm"> *      vMgrDeAuthenDeginSta - Start deauthentication function</span>
<span class="cm"> *      s_vMgrRxAuthentication - Handle Rcv authentication</span>
<span class="cm"> *      s_vMgrRxAuthenSequence_1 - Handle Rcv authentication sequence 1</span>
<span class="cm"> *      s_vMgrRxAuthenSequence_2 - Handle Rcv authentication sequence 2</span>
<span class="cm"> *      s_vMgrRxAuthenSequence_3 - Handle Rcv authentication sequence 3</span>
<span class="cm"> *      s_vMgrRxAuthenSequence_4 - Handle Rcv authentication sequence 4</span>
<span class="cm"> *      s_vMgrRxDisassociation - Handle Rcv disassociation</span>
<span class="cm"> *      s_vMgrRxBeacon - Handle Rcv Beacon</span>
<span class="cm"> *      vMgrCreateOwnIBSS - Create ad_hoc IBSS or AP BSS</span>
<span class="cm"> *      vMgrJoinBSSBegin - Join BSS function</span>
<span class="cm"> *      s_vMgrSynchBSS - Synch &amp; adopt BSS parameters</span>
<span class="cm"> *      s_MgrMakeBeacon - Create Baecon frame</span>
<span class="cm"> *      s_MgrMakeProbeResponse - Create Probe Response frame</span>
<span class="cm"> *      s_MgrMakeAssocRequest - Create Associate Request frame</span>
<span class="cm"> *      s_MgrMakeReAssocRequest - Create ReAssociate Request frame</span>
<span class="cm"> *      s_vMgrRxProbeResponse - Handle Rcv probe_response</span>
<span class="cm"> *      s_vMrgRxProbeRequest - Handle Rcv probe_request</span>
<span class="cm"> *      bMgrPrepareBeaconToSend - Prepare Beacon frame</span>
<span class="cm"> *      s_vMgrLogStatus - Log 802.11 Status</span>
<span class="cm"> *      vMgrRxManagePacket - Rcv management frame dispatch function</span>
<span class="cm"> *      s_vMgrFormatTIM- Assember TIM field of beacon</span>
<span class="cm"> *      vMgrTimerInit- Initial 1-sec and command call back funtions</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;tmacro.h&quot;</span>
<span class="cp">#include &quot;desc.h&quot;</span>
<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;card.h&quot;</span>
<span class="cp">#include &quot;channel.h&quot;</span>
<span class="cp">#include &quot;80211hdr.h&quot;</span>
<span class="cp">#include &quot;80211mgr.h&quot;</span>
<span class="cp">#include &quot;wmgr.h&quot;</span>
<span class="cp">#include &quot;wcmd.h&quot;</span>
<span class="cp">#include &quot;mac.h&quot;</span>
<span class="cp">#include &quot;bssdb.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>
<span class="cp">#include &quot;datarate.h&quot;</span>
<span class="cp">#include &quot;baseband.h&quot;</span>
<span class="cp">#include &quot;rxtx.h&quot;</span>
<span class="cp">#include &quot;wpa.h&quot;</span>
<span class="cp">#include &quot;rf.h&quot;</span>
<span class="cp">#include &quot;iowpa.h&quot;</span>

<span class="cp">#define	PLICE_DEBUG</span>

<span class="cm">/*---------------------  Static Definitions -------------------------*/</span>



<span class="cm">/*---------------------  Static Classes  ----------------------------*/</span>

<span class="cm">/*---------------------  Static Variables  --------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span><span class="n">MSG_LEVEL_INFO</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>static int          msglevel                =MSG<em>LEVEL</em>DEBUG;</p></td><td class="code"><div class="highlight"><pre><span class="cm">/*---------------------  Static Functions  --------------------------*/</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>2008-8-4 <add> by chester</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">bool</span> <span class="n">ChannelExceedZoneType</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byCurrChannel</span>
    <span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Association/diassociation functions</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="n">PSTxMgmtPacket</span>
<span class="n">s_MgrMakeAssocRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDAddr</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wListenInterval</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pCurrSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxAssocRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="n">PSTxMgmtPacket</span>
<span class="n">s_MgrMakeReAssocRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDAddr</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wListenInterval</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pCurrSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxAssocResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span><span class="p">,</span>
    <span class="n">bool</span> <span class="n">bReAssocType</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxDisassociation</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Authentication/deauthen functions</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxAuthenSequence_1</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_FR_AUTHEN</span> <span class="n">pFrame</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxAuthenSequence_2</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_FR_AUTHEN</span> <span class="n">pFrame</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxAuthenSequence_3</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_FR_AUTHEN</span> <span class="n">pFrame</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxAuthenSequence_4</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_FR_AUTHEN</span> <span class="n">pFrame</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxAuthentication</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxDeauthentication</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Scan functions
probe request/response functions</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxProbeRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxProbeResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>beacon functions</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrRxBeacon</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span><span class="p">,</span>
    <span class="n">bool</span> <span class="n">bInScan</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrFormatTIM</span><span class="p">(</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_IE_TIM</span> <span class="n">pTIM</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="n">PSTxMgmtPacket</span>
<span class="n">s_MgrMakeBeacon</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrBeaconPeriod</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uCurrChannel</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrATIMWinodw</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pCurrSSID</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pCurrBSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrSuppRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Association response</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="n">PSTxMgmtPacket</span>
<span class="n">s_MgrMakeAssocResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocStatus</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocAID</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDstAddr</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrSuppRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>ReAssociation response</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="n">PSTxMgmtPacket</span>
<span class="n">s_MgrMakeReAssocResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocStatus</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocAID</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDstAddr</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrSuppRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Probe response</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="n">PSTxMgmtPacket</span>
<span class="n">s_MgrMakeProbeResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrBeaconPeriod</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uCurrChannel</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrATIMWinodw</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDstAddr</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pCurrSSID</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pCurrBSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrSuppRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byPHYType</span>
    <span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>received status</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrLogStatus</span><span class="p">(</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wStatus</span>
    <span class="p">);</span>


<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vMgrSynchBSS</span> <span class="p">(</span>
    <span class="n">PSDevice</span>      <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uBSSMode</span><span class="p">,</span>
    <span class="n">PKnownBSS</span>     <span class="n">pCurr</span><span class="p">,</span>
    <span class="n">PCMD_STATUS</span>  <span class="n">pStatus</span>
    <span class="p">);</span>


<span class="k">static</span> <span class="n">bool</span>
<span class="n">s_bCipherMatch</span> <span class="p">(</span>
    <span class="n">PKnownBSS</span>                        <span class="n">pBSSNode</span><span class="p">,</span>
    <span class="n">NDIS_802_11_ENCRYPTION_STATUS</span>    <span class="n">EncStatus</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyCCSPK</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyCCSGK</span>
    <span class="p">);</span>

 <span class="k">static</span> <span class="kt">void</span>  <span class="n">Encyption_Rebuild</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PKnownBSS</span> <span class="n">pCurr</span>
 <span class="p">);</span>



<span class="cm">/*---------------------  Export Variables  --------------------------*/</span>


<span class="cm">/*---------------------  Export Functions  --------------------------*/</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Allocates and initializes the Management object.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    Ndis_staus.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span>
<span class="nf">vMgrObjectInit</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>


    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyPSPacketPool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byPSPacketPool</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byMgmtPacketPool</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">WLAN_BSSID_LEN</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NDIS_802_11_ASSOCIATION_INFORMATION</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>memset(pMgmt->abyDesireSSID, 0, WLAN<em>IEHDR</em>LEN + WLAN<em>SSID</em>MAXLEN +1);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_NONE</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_NONE</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wIBSSBeaconPeriod</span> <span class="o">=</span> <span class="n">DEFAULT_IBSS_BI</span><span class="p">;</span>
    <span class="n">BSSvClearBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Initializes timer object</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    Ndis_staus.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span>
<span class="nf">vMgrTimerInit</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>


    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">BSSvSecondCallBack</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>

    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">vCommandTimer</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>

   <span class="cp">#ifdef TxInSleep</span>
    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">BSSvSecondTxData</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>      <span class="c1">//10s callback</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fTxDataInSleep</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">IsTxDataTrigger</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">nTxDataTimeCout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="cp">#endif</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeCmdQueue</span> <span class="o">=</span> <span class="n">CMD_Q_SIZE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdDequeueIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCmdEnqueueIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Reset the management object  structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span>
<span class="nf">vMgrObjectReset</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>         <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_STANDBY</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnablePSMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>TODO: timer</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Start the station association procedure.  Namely, send an</span>
<span class="cm"> *    association request frame to the AP.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="kt">void</span>
<span class="nf">vMgrAssocBeginSta</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PCMD_STATUS</span> <span class="n">pStatus</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>             <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>          <span class="n">pTxPacket</span><span class="p">;</span>


    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_ESS</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_PRIVACY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>always allow receive short preamble
if (pDevice->byPreambleType == 1) {
   pMgmt->wCurrCapInfo |= WLAN<em>SET</em>CAP<em>INFO</em>SHORTPREAMBLE(1);
}</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// at least one.</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>ERP Phy (802.11g) should support short preamble.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CARDbIsShorSlotTime</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTSLOTTIME</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CARDbIsShortPreamble</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">b11hEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SPECTRUMMNG</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="cm">/* build an assocreq frame and send it */</span>
    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="n">s_MgrMakeAssocRequest</span>
                <span class="p">(</span>
                  <span class="n">pDevice</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span>
                <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pTxPacket</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">){</span>
        <span class="cm">/* send the frame */</span>
        <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pStatus</span> <span class="o">==</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_ASSOCPENDING</span><span class="p">;</span>
            <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_RESOURCES</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Start the station re-association procedure.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span>
<span class="nf">vMgrReAssocBeginSta</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PCMD_STATUS</span> <span class="n">pStatus</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>             <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>          <span class="n">pTxPacket</span><span class="p">;</span>



    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_ESS</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_PRIVACY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>if (pDevice->byPreambleType == 1) {
   pMgmt->wCurrCapInfo |= WLAN<em>SET</em>CAP<em>INFO</em>SHORTPREAMBLE(1);
}</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// at least one.</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>ERP Phy (802.11g) should support short preamble.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CARDbIsShorSlotTime</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTSLOTTIME</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CARDbIsShortPreamble</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">b11hEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SPECTRUMMNG</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>


    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="n">s_MgrMakeReAssocRequest</span>
                <span class="p">(</span>
                  <span class="n">pDevice</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span>
                <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pTxPacket</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">){</span>
        <span class="cm">/* send the frame */</span>
        <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pStatus</span> <span class="o">!=</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Reassociation tx failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Reassociation tx sending.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Send an dis-association request frame to the AP.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span>
<span class="nf">vMgrDisassocBeginSta</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">abyDestAddress</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wReason</span><span class="p">,</span>
    <span class="n">PCMD_STATUS</span> <span class="n">pStatus</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>            <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WLAN_FR_DISASSOC</span>    <span class="n">sFrame</span><span class="p">;</span>

    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_DISASSOC_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Setup the sFrame structure</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_DISASSOC_FR_MAXLEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>format fixed field frame structure</p></td><td class="code"><div class="highlight"><pre>    <span class="n">vMgrEncodeDisassociation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Setup the header</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_DISASSOC</span><span class="p">)</span>
        <span class="p">));</span>

    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">abyDestAddress</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Set reason code</p></td><td class="code"><div class="highlight"><pre>    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwReason</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wReason</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>send the frame</p></td><td class="code"><div class="highlight"><pre>    <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pStatus</span> <span class="o">==</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:(AP function)</span>
<span class="cm"> *    Handle incoming station association request frames.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxAssocRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">WLAN_FR_ASSOCREQ</span>    <span class="n">sFrame</span><span class="p">;</span>
    <span class="n">CMD_STATUS</span>          <span class="n">Status</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocAID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">!=</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>node index not found</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uNodeIndex</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>check if node is authenticated
decode the frame</p></td><td class="code"><div class="highlight"><pre>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WLAN_FR_ASSOCREQ</span><span class="p">));</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">abyCurrSuppRates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>

    <span class="n">vMgrDecodeAssocRequest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">&gt;=</span> <span class="n">NODE_AUTH</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">=</span> <span class="n">NODE_ASSOC</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wCapInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wListenInterval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwListenInterval</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span> <span class="o">=</span>
                <span class="n">WLAN_GET_FC_PWRMGT</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Todo: check sta basic rate, if ap can't support, set status code</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
        <span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
                                         <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                         <span class="n">uRateLen</span><span class="p">);</span>
        <span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_EXTSUPP_RATES</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
                                                <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                                                <span class="n">uRateLen</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="n">RATEvParseMaxRate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                           <span class="nb">false</span><span class="p">,</span> <span class="c1">// do not change our basic rate</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxBasicRate</span><span class="p">),</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">),</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wSuppRate</span><span class="p">),</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byTopCCKBasicRate</span><span class="p">),</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byTopOFDMBasicRate</span><span class="p">)</span>
                          <span class="p">);</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>set max tx rate</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span> <span class="o">=</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">;</span>
<span class="cp">#ifdef	PLICE_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RxAssocRequest:wTxDataRate is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Todo: check sta preamble, if ap can't support, set status code</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span> <span class="o">=</span>
                <span class="n">WLAN_GET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortSlotTime</span> <span class="o">=</span>
                <span class="n">WLAN_GET_CAP_INFO_SHORTSLOTTIME</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wAID</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">uNodeIndex</span><span class="p">;</span>
        <span class="n">wAssocStatus</span> <span class="o">=</span> <span class="n">WLAN_MGMT_STATUS_SUCCESS</span><span class="p">;</span>
        <span class="n">wAssocAID</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">uNodeIndex</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>check if ERP support</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span> <span class="o">&gt;</span> <span class="n">RATE_11M</span><span class="p">)</span>
           <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bERPExist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span> <span class="o">&lt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>B only STA join</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bNonERPPresent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Associate AID= %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wAssocAID</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;MAC=%2.2X:%2.2X:%2.2X:%2.2X:%2.2X:%2.2X </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                  <span class="p">)</span> <span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Max Support rate = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">);</span>
    <span class="p">}</span><span class="c1">//else { TODO: received STA under state1 handle }</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>assoc response reply..</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="n">s_MgrMakeAssocResponse</span>
                <span class="p">(</span>
                  <span class="n">pDevice</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span><span class="p">,</span>
                  <span class="n">wAssocStatus</span><span class="p">,</span>
                  <span class="n">wAssocAID</span><span class="p">,</span>
                  <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span>
                <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pTxPacket</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">){</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostapd</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* send the frame */</span>
        <span class="n">Status</span> <span class="o">=</span> <span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Assoc response tx failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Assoc response tx sending..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Description:(AP function)</span>
<span class="cm"> *      Handle incoming station re-association request frames.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pMgmt           - Management Object structure</span>
<span class="cm"> *      pRxPacket       - Received Packet</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxReAssocRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">WLAN_FR_REASSOCREQ</span>    <span class="n">sFrame</span><span class="p">;</span>
    <span class="n">CMD_STATUS</span>          <span class="n">Status</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocAID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">!=</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>node index not found</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uNodeIndex</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>check if node is authenticated
decode the frame</p></td><td class="code"><div class="highlight"><pre>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WLAN_FR_REASSOCREQ</span><span class="p">));</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">vMgrDecodeReassocRequest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">&gt;=</span> <span class="n">NODE_AUTH</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">=</span> <span class="n">NODE_ASSOC</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wCapInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wListenInterval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwListenInterval</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span> <span class="o">=</span>
                <span class="n">WLAN_GET_FC_PWRMGT</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Todo: check sta basic rate, if ap can't support, set status code</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
        <span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
                                         <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                         <span class="n">uRateLen</span><span class="p">);</span>
        <span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_EXTSUPP_RATES</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
                                                <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                                                <span class="n">uRateLen</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="n">RATEvParseMaxRate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                           <span class="nb">false</span><span class="p">,</span> <span class="c1">// do not change our basic rate</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxBasicRate</span><span class="p">),</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">),</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wSuppRate</span><span class="p">),</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byTopCCKBasicRate</span><span class="p">),</span>
                           <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byTopOFDMBasicRate</span><span class="p">)</span>
                          <span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>set max tx rate</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span> <span class="o">=</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">;</span>
<span class="cp">#ifdef	PLICE_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RxReAssocRequest:TxDataRate is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Todo: check sta preamble, if ap can't support, set status code</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span> <span class="o">=</span>
                <span class="n">WLAN_GET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortSlotTime</span> <span class="o">=</span>
                <span class="n">WLAN_GET_CAP_INFO_SHORTSLOTTIME</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wAID</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">uNodeIndex</span><span class="p">;</span>
        <span class="n">wAssocStatus</span> <span class="o">=</span> <span class="n">WLAN_MGMT_STATUS_SUCCESS</span><span class="p">;</span>
        <span class="n">wAssocAID</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">uNodeIndex</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>if suppurt ERP</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span> <span class="o">&gt;</span> <span class="n">RATE_11M</span><span class="p">)</span>
           <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bERPExist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span> <span class="o">&lt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>B only STA join</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bNonERPPresent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Rx ReAssociate AID= %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wAssocAID</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;MAC=%2.2X:%2.2X:%2.2X:%2.2X:%2.2X:%2.2X </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                  <span class="p">)</span> <span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Max Support rate = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">);</span>

    <span class="p">}</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>assoc response reply..</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="n">s_MgrMakeReAssocResponse</span>
                <span class="p">(</span>
                  <span class="n">pDevice</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span><span class="p">,</span>
                  <span class="n">wAssocStatus</span><span class="p">,</span>
                  <span class="n">wAssocAID</span><span class="p">,</span>
                  <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span>
                <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pTxPacket</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">){</span>
        <span class="cm">/* send the frame */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostapd</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Status</span> <span class="o">=</span> <span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:ReAssoc response tx failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:ReAssoc response tx sending..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Handle incoming association response frames.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxAssocResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span><span class="p">,</span>
    <span class="n">bool</span> <span class="n">bReAssocType</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">WLAN_FR_ASSOCRESP</span>   <span class="n">sFrame</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SSID</span>   <span class="n">pItemSSID</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyIEs</span><span class="p">;</span>
    <span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="n">wpahdr</span><span class="p">;</span>



    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOCPENDING</span> <span class="o">||</span>
         <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>decode the frame</p></td><td class="code"><div class="highlight"><pre>        <span class="n">vMgrDecodeAssocResponse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)){</span>
            <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0xCC</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">ResponseFixedIEs</span><span class="p">.</span><span class="n">Capabilities</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">ResponseFixedIEs</span><span class="p">.</span><span class="n">StatusCode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">ResponseFixedIEs</span><span class="p">.</span><span class="n">AssociationId</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAid</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">AvailableResponseFixedIEs</span> <span class="o">|=</span> <span class="mh">0x07</span><span class="p">;</span>

        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">ResponseIELength</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">OffsetResponseIEs</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">OffsetRequestIEs</span> <span class="o">+</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span><span class="p">;</span>
        <span class="n">pbyIEs</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">abyIEs</span><span class="p">;</span>
        <span class="n">pbyIEs</span> <span class="o">+=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyIEs</span><span class="p">,</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">ResponseIELength</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>save values and set current BSS state</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">)))</span> <span class="o">==</span> <span class="n">WLAN_MGMT_STATUS_SUCCESS</span> <span class="p">){</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>set AID</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrAID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAid</span><span class="p">)));</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrAID</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">BIT0</span> <span class="o">|</span> <span class="n">BIT1</span><span class="p">)</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;AID from AP, has two msb clear.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Association Successful, AID=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrAID</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT14</span><span class="o">|</span><span class="n">BIT15</span><span class="p">));</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">;</span>
            <span class="n">BSSvUpdateAPNode</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">);</span>
            <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">;</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Link with AP(SSID): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">)</span><span class="o">+</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">ResponseIELength</span><span class="o">+</span>
		   	                                                 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span><span class="p">))</span> <span class="p">{</span>    <span class="c1">//data room not enough</span>
                     <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
	       	<span class="p">}</span>
                <span class="n">wpahdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
                <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIAWGET_ASSOC_MSG</span><span class="p">;</span>
                <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">ResponseIELength</span><span class="p">;</span>
                <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span><span class="p">;</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">),</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">abyIEs</span><span class="p">,</span> <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span><span class="p">);</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span><span class="p">,</span>
                       <span class="n">pbyIEs</span><span class="p">,</span>
                       <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span>
                       <span class="p">);</span>
                <span class="n">skb_put</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">+</span> <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wpadev</span><span class="p">;</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
                <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
                <span class="n">netif_rx</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>2008-0409-07, <Add> by Einsn Liu</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>if(pDevice->bWPADevEnable == true)</p></td><td class="code"><div class="highlight"><pre>		<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">iwreq_data</span>  <span class="n">wrqu</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">we_event</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">abyIEs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
			<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">we_event</span> <span class="o">=</span> <span class="n">IWEVASSOCREQIE</span><span class="p">;</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">we_event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">ResponseIELength</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pbyIEs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
			<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">we_event</span> <span class="o">=</span> <span class="n">IWEVASSOCRESPIE</span><span class="p">;</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">we_event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>


  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
        <span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="c1">//#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>End Add -- //2008-0409-07, <Add> by Einsn Liu</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bReAssocType</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>jump back to the auth state and indicate the error</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_AUTH</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">s_vMgrLogStatus</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span><span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">))));</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>need clear flags related to Networkmanager</p></td><td class="code"><div class="highlight"><pre>              <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPASuppWextEnabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>


<span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span>
      <span class="n">timer_expire</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Start the station authentication procedure.  Namely, send an</span>
<span class="cm"> *    authentication frame to the AP.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span>
<span class="nf">vMgrAuthenBeginSta</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span>  <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PCMD_STATUS</span> <span class="n">pStatus</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">WLAN_FR_AUTHEN</span>  <span class="n">sFrame</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>  <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_AUTHEN_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_AUTHEN_FR_MAXLEN</span><span class="p">;</span>
    <span class="n">vMgrEncodeAuthen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
    <span class="cm">/* insert values */</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_AUTHEN</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span><span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthAlgorithm</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_AUTH_ALG_SHAREDKEY</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthAlgorithm</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_AUTH_ALG_OPENSYSTEM</span><span class="p">);</span>

    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthSequence</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="cm">/* Adjust the length fields */</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>

    <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pStatus</span> <span class="o">==</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">){</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_AUTHPENDING</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Start the station(AP) deauthentication procedure.  Namely, send an</span>
<span class="cm"> *    deauthentication frame to the AP or Sta.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span>
<span class="nf">vMgrDeAuthenBeginSta</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span>  <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">abyDestAddress</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wReason</span><span class="p">,</span>
    <span class="n">PCMD_STATUS</span> <span class="n">pStatus</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>            <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">WLAN_FR_DEAUTHEN</span>    <span class="n">sFrame</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_DEAUTHEN_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_DEAUTHEN_FR_MAXLEN</span><span class="p">;</span>
    <span class="n">vMgrEncodeDeauthen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
    <span class="cm">/* insert values */</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_DEAUTHEN</span><span class="p">)</span>
        <span class="p">));</span>

    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">abyDestAddress</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>

    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwReason</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wReason</span><span class="p">);</span>       <span class="c1">// deauthen. bcs left BSS</span>
    <span class="cm">/* Adjust the length fields */</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>

    <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pStatus</span> <span class="o">==</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">){</span>
        <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Handle incoming authentication frames.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxAuthentication</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">WLAN_FR_AUTHEN</span>  <span class="n">sFrame</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>we better be an AP or a STA in AUTHPENDING otherwise ignore</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span> <span class="o">||</span>
          <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_AUTHPENDING</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>decode the frame</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">vMgrDecodeAuthen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthSequence</span> <span class="p">)))){</span>
        <span class="k">case</span> <span class="mi">1</span>:</pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>AP funciton</p></td><td class="code"><div class="highlight"><pre>            <span class="n">s_vMgrRxAuthenSequence_1</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pMgmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span>:
            <span class="n">s_vMgrRxAuthenSequence_2</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">3</span>:</pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>AP funciton</p></td><td class="code"><div class="highlight"><pre>            <span class="n">s_vMgrRxAuthenSequence_3</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">4</span>:
            <span class="n">s_vMgrRxAuthenSequence_4</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Auth Sequence error, seq = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthSequence</span><span class="p">))));</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Handles incoming authen frames with sequence 1.  Currently</span>
<span class="cm"> *   assumes we&#39;re an AP.  So far, no one appears to use authentication</span>
<span class="cm"> *   in Ad-Hoc mode.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxAuthenSequence_1</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_FR_AUTHEN</span> <span class="n">pFrame</span>
     <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">uNodeIndex</span><span class="p">;</span>
    <span class="n">WLAN_FR_AUTHEN</span>      <span class="n">sFrame</span><span class="p">;</span>
    <span class="n">PSKeyItem</span>           <span class="n">pTransmitKey</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Insert a Node entry</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">BSSvCreateOneNode</span><span class="p">((</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span>
               <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">=</span> <span class="n">NODE_KNOWN</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byAuthSequence</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">=</span> <span class="n">NODE_AUTH</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>send auth reply</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_AUTHEN_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_AUTHEN_FR_MAXLEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>format buffer structure</p></td><td class="code"><div class="highlight"><pre>    <span class="n">vMgrEncodeAuthen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>insert values</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
         <span class="p">(</span>
         <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
         <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_AUTHEN</span><span class="p">)</span><span class="o">|</span>
         <span class="n">WLAN_SET_FC_ISWEP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
         <span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthAlgorithm</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwAuthAlgorithm</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthSequence</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwAuthAlgorithm</span><span class="p">))</span> <span class="o">==</span> <span class="n">WLAN_AUTH_ALG_SHAREDKEY</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span><span class="p">)</span>
            <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_MGMT_STATUS_SUCCESS</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_MGMT_STATUS_UNSUPPORTED_AUTHALG</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span><span class="p">)</span>
            <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_MGMT_STATUS_UNSUPPORTED_AUTHALG</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_MGMT_STATUS_SUCCESS</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">))</span> <span class="o">==</span> <span class="n">WLAN_MGMT_STATUS_SUCCESS</span><span class="p">))</span> <span class="p">{</span>

        <span class="n">sFrame</span><span class="p">.</span><span class="n">pChallenge</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_CHALLENGE</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">WLAN_CHALLENGE_IE_LEN</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pChallenge</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_CHALLENGE</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pChallenge</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_CHALLENGE_LEN</span><span class="p">;</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyChallenge</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_CHALLENGE_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>get group key</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="n">GROUP_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rc4_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
            <span class="n">rc4_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyChallenge</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyChallenge</span><span class="p">,</span> <span class="n">WLAN_CHALLENGE_LEN</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pChallenge</span><span class="o">-&gt;</span><span class="n">abyChallenge</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyChallenge</span> <span class="p">,</span> <span class="n">WLAN_CHALLENGE_LEN</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Adjust the length fields */</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>send the frame</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostapd</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Authreq_reply sequence_1 tx.. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Authreq_reply sequence_1 tx failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Handles incoming auth frames with sequence number 2.  Currently</span>
<span class="cm"> *   assumes we&#39;re a station.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxAuthenSequence_2</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_FR_AUTHEN</span> <span class="n">pFrame</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">WLAN_FR_AUTHEN</span>      <span class="n">sFrame</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


    <span class="k">switch</span> <span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwAuthAlgorithm</span><span class="p">))))</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">WLAN_AUTH_ALG_OPENSYSTEM</span>:
            <span class="k">if</span> <span class="p">(</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwStatus</span><span class="p">)))</span> <span class="o">==</span> <span class="n">WLAN_MGMT_STATUS_SUCCESS</span> <span class="p">){</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;802.11 Authen (OPEN) Successful.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_AUTH</span><span class="p">;</span>
	 <span class="n">timer_expire</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;802.11 Authen (OPEN) Failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">s_vMgrLogStatus</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwStatus</span><span class="p">))));</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">==</span> <span class="n">WLAN_AUTHENTICATE_WAIT</span> <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><pre><code>           spin_unlock_irq(&amp;pDevice-&gt;lock);
           vCommandTimerWait((void *)pDevice, 0);
           spin_lock_irq(&amp;pDevice-&gt;lock);
</code></pre></td><td class="code"><div class="highlight"><pre>            <span class="p">}</span>

            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_AUTH_ALG_SHAREDKEY</span>:

            <span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwStatus</span><span class="p">)))</span> <span class="o">==</span> <span class="n">WLAN_MGMT_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
                <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_AUTHEN_FR_MAXLEN</span><span class="p">);</span>
                <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_AUTHEN_FR_MAXLEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>format buffer structure</p></td><td class="code"><div class="highlight"><pre>                <span class="n">vMgrEncodeAuthen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>insert values</p></td><td class="code"><div class="highlight"><pre>                <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
                     <span class="p">(</span>
                     <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
                     <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_AUTHEN</span><span class="p">)</span><span class="o">|</span>
                     <span class="n">WLAN_SET_FC_ISWEP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                     <span class="p">));</span>
                <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
                <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
                <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
                <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthAlgorithm</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwAuthAlgorithm</span><span class="p">);</span>
                <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthSequence</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
                <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_MGMT_STATUS_SUCCESS</span><span class="p">);</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pChallenge</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_CHALLENGE</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">WLAN_CHALLENGE_IE_LEN</span><span class="p">;</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pChallenge</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_CHALLENGE</span><span class="p">;</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pChallenge</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_CHALLENGE_LEN</span><span class="p">;</span>
                <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pChallenge</span><span class="o">-&gt;</span><span class="n">abyChallenge</span><span class="p">,</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pChallenge</span><span class="o">-&gt;</span><span class="n">abyChallenge</span><span class="p">,</span> <span class="n">WLAN_CHALLENGE_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Adjust the length fields</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
                <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>send the frame</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Auth_reply sequence_2 tx failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Auth_reply sequence_2 tx ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
            	<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:rx Auth_reply sequence_2 status error ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">==</span> <span class="n">WLAN_AUTHENTICATE_WAIT</span> <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><pre><code>               spin_unlock_irq(&amp;pDevice-&gt;lock);
               vCommandTimerWait((void *)pDevice, 0);
               spin_lock_irq(&amp;pDevice-&gt;lock);
</code></pre></td><td class="code"><div class="highlight"><pre>                <span class="p">}</span>
                <span class="n">s_vMgrLogStatus</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwStatus</span><span class="p">))));</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt: rx auth.seq = 2 unknown AuthAlgorithm=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwAuthAlgorithm</span><span class="p">))));</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Handles incoming authen frames with sequence 3.  Currently</span>
<span class="cm"> *   assumes we&#39;re an AP.  This function assumes the frame has</span>
<span class="cm"> *   already been successfully decrypted.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxAuthenSequence_3</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_FR_AUTHEN</span> <span class="n">pFrame</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uStatusCode</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">WLAN_FR_AUTHEN</span>      <span class="n">sFrame</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WLAN_GET_FC_ISWEP</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">uStatusCode</span> <span class="o">=</span> <span class="n">WLAN_MGMT_STATUS_CHALLENGE_FAIL</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">reply</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byAuthSequence</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">uStatusCode</span> <span class="o">=</span> <span class="n">WLAN_MGMT_STATUS_RX_AUTH_NOSEQ</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">reply</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyChallenge</span><span class="p">,</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pChallenge</span><span class="o">-&gt;</span><span class="n">abyChallenge</span><span class="p">,</span> <span class="n">WLAN_CHALLENGE_LEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">uStatusCode</span> <span class="o">=</span> <span class="n">WLAN_MGMT_STATUS_CHALLENGE_FAIL</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">reply</span><span class="p">;</span>
         <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">uStatusCode</span> <span class="o">=</span> <span class="n">WLAN_MGMT_STATUS_UNSPEC_FAILURE</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">reply</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">uNodeIndex</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">=</span> <span class="n">NODE_AUTH</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byAuthSequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">uStatusCode</span> <span class="o">=</span> <span class="n">WLAN_MGMT_STATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Challenge text check ok..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">reply:</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>send auth reply</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_AUTHEN_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_AUTHEN_FR_MAXLEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>format buffer structure</p></td><td class="code"><div class="highlight"><pre>    <span class="n">vMgrEncodeAuthen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
    <span class="cm">/* insert values */</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
         <span class="p">(</span>
         <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
         <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_AUTHEN</span><span class="p">)</span><span class="o">|</span>
         <span class="n">WLAN_SET_FC_ISWEP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
         <span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthAlgorithm</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwAuthAlgorithm</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAuthSequence</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">uStatusCode</span><span class="p">);</span>

    <span class="cm">/* Adjust the length fields */</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>send the frame</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostapd</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Authreq_reply sequence_4 tx failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>

<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Handles incoming authen frames with sequence 4</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxAuthenSequence_4</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_FR_AUTHEN</span> <span class="n">pFrame</span>
    <span class="p">)</span>
<span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwStatus</span><span class="p">)))</span> <span class="o">==</span> <span class="n">WLAN_MGMT_STATUS_SUCCESS</span> <span class="p">){</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;802.11 Authen (SHAREDKEY) Successful.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_AUTH</span><span class="p">;</span>
	  <span class="n">timer_expire</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;802.11 Authen (SHAREDKEY) Failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">s_vMgrLogStatus</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">pwStatus</span><span class="p">)))</span> <span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCommandState</span> <span class="o">==</span> <span class="n">WLAN_AUTHENTICATE_WAIT</span> <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><pre><code>   spin_unlock_irq(&amp;pDevice-&gt;lock);
   vCommandTimerWait((void *)pDevice, 0);
   spin_lock_irq(&amp;pDevice-&gt;lock);
</code></pre></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Handles incoming disassociation frames</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxDisassociation</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">WLAN_FR_DISASSOC</span>    <span class="n">sFrame</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>CMD_STATUS          CmdStatus;</p></td><td class="code"><div class="highlight"><pre>    <span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="n">wpahdr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span> <span class="p">){</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>if is acting an AP..
a STA is leaving this BSS..</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">BSSvRemoveOneNode</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Rx disassoc, sta not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span> <span class="p">){</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
        <span class="n">vMgrDecodeDisassociation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;AP disassociated me, reason=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwReason</span><span class="p">)));</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>TODO: do something let upper layer know or
try to send associate packet again because of inactivity timeout
 if (pMgmt->eCurrState == WMAC<em>STATE</em>ASSOC) {
    vMgrReAssocBeginSta((PSDevice)pDevice, pMgmt, &amp;CmdStatus);
 }</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
             <span class="n">wpahdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
             <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIAWGET_DISASSOC_MSG</span><span class="p">;</span>
             <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="n">skb_put</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">));</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wpadev</span><span class="p">;</span>
	     <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
             <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
             <span class="n">netif_rx</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
         <span class="p">}</span>

 <span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>if(pDevice->bWPASuppWextEnabled == true)</p></td><td class="code"><div class="highlight"><pre>      <span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span>  <span class="n">wrqu</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
        <span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wireless_send_event---&gt;SIOCGIWAP(disassociated)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
     <span class="p">}</span>
  <span class="cp">#endif</span>
    <span class="p">}</span>
    <span class="cm">/* else, ignore it */</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Handles incoming deauthentication frames</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxDeauthentication</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">WLAN_FR_DEAUTHEN</span>    <span class="n">sFrame</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="n">wpahdr</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span> <span class="p">){</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Todo:
if is acting an AP..
a STA is leaving this BSS..</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">BSSvRemoveOneNode</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Rx deauth, sta not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
            <span class="n">vMgrDecodeDeauthen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span>  <span class="s">&quot;AP deauthed me, reason=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwReason</span><span class="p">))));</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>TODO: update BSS list for specific BSSID if pre-authentication case</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">&gt;=</span> <span class="n">WMAC_STATE_AUTHPENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_STANDBY</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
                    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
                 <span class="n">wpahdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
                 <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIAWGET_DISASSOC_MSG</span><span class="p">;</span>
                 <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">skb_put</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">));</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wpadev</span><span class="p">;</span>
		 <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
                 <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
                 <span class="n">netif_rx</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
           <span class="p">}</span>

   <span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>if(pDevice->bWPASuppWextEnabled == true)</p></td><td class="code"><div class="highlight"><pre>      <span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span>  <span class="n">wrqu</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
        <span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;wireless_send_event---&gt;SIOCGIWAP(disauthen)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
     <span class="p">}</span>
  <span class="cp">#endif</span>

        <span class="p">}</span>
        <span class="cm">/* else, ignore it.  TODO: IBSS authentication service</span>
<span class="cm">            would be implemented here */</span>
    <span class="p">};</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>2008-8-4 <add> by chester</p></td><td class="code"><div class="highlight"><pre><span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> * check if current channel is match ZoneType.</span>
<span class="cm"> *for USA:1~11;</span>
<span class="cm"> *      Japan:1~13;</span>
<span class="cm"> *      Europe:1~13</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *               True:exceed;</span>
<span class="cm"> *                False:normal case</span>
<span class="cm">-*/</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">ChannelExceedZoneType</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byCurrChannel</span>
    <span class="p">)</span>
<span class="p">{</span>
  <span class="n">bool</span> <span class="n">exceed</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byZoneType</span><span class="p">)</span> <span class="p">{</span>
  	<span class="k">case</span> <span class="mh">0x00</span>:                  <span class="c1">//USA:1~11</span>
                     <span class="k">if</span><span class="p">((</span><span class="n">byCurrChannel</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span><span class="p">(</span><span class="n">byCurrChannel</span><span class="o">&gt;</span><span class="mi">11</span><span class="p">))</span>
	                <span class="n">exceed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	         <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>:                  <span class="c1">//Japan:1~13</span>
	<span class="k">case</span> <span class="mh">0x02</span>:                  <span class="c1">//Europe:1~13</span>
                     <span class="k">if</span><span class="p">((</span><span class="n">byCurrChannel</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span><span class="p">(</span><span class="n">byCurrChannel</span><span class="o">&gt;</span><span class="mi">13</span><span class="p">))</span>
	                <span class="n">exceed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	         <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>                    <span class="c1">//reserve for other zonetype</span>
		<span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">exceed</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Handles and analysis incoming beacon frames.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxBeacon</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span><span class="p">,</span>
    <span class="n">bool</span> <span class="n">bInScan</span>
    <span class="p">)</span>
<span class="p">{</span>

    <span class="n">PKnownBSS</span>           <span class="n">pBSSList</span><span class="p">;</span>
    <span class="n">WLAN_FR_BEACON</span>      <span class="n">sFrame</span><span class="p">;</span>
    <span class="n">QWORD</span>               <span class="n">qwTSFOffset</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bIsBSSIDEqual</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bIsSSIDEqual</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bTSFLargeDiff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bTSFOffsetPostive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bUpdateTSF</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bIsAPBeacon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bIsChannelEqual</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uLocateByteIndex</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byTIMBitOn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAIDNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span><span class="p">;</span>
    <span class="n">QWORD</span>               <span class="n">qwTimestamp</span><span class="p">,</span> <span class="n">qwLocalTSF</span><span class="p">;</span>
    <span class="n">QWORD</span>               <span class="n">qwCurrTSF</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wStartIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAIDIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byCurrChannel</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxChannel</span><span class="p">;</span>
    <span class="n">ERPObject</span>           <span class="n">sERP</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bChannelHit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bUpdatePhyParameter</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byIEChannel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WLAN_FR_BEACON</span><span class="p">));</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>decode the beacon frame</p></td><td class="code"><div class="highlight"><pre>    <span class="n">vMgrDecodeBeacon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwBeaconInterval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Rx beacon frame error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byCurrChannel</span> <span class="o">&gt;</span> <span class="n">CB_MAX_CHANNEL_24G</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>channel remapping to</p></td><td class="code"><div class="highlight"><pre>            <span class="n">byIEChannel</span> <span class="o">=</span> <span class="n">get_channel_mapping</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">byCurrChannel</span><span class="p">,</span> <span class="n">PHY_TYPE_11A</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">byIEChannel</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">byCurrChannel</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byCurrChannel</span> <span class="o">!=</span> <span class="n">byIEChannel</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>adjust channel info. bcs we rcv adjcent channel pakckets</p></td><td class="code"><div class="highlight"><pre>            <span class="n">bChannelHit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">byCurrChannel</span> <span class="o">=</span> <span class="n">byIEChannel</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>no DS channel info</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bChannelHit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>2008-0730-01<Add>by MikeLiu</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="n">ChannelExceedZoneType</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">byCurrChannel</span><span class="p">)</span><span class="o">==</span><span class="nb">true</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sERP</span><span class="p">.</span><span class="n">byERP</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span><span class="p">;</span>
        <span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">sERP</span><span class="p">.</span><span class="n">byERP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pBSSList</span> <span class="o">=</span> <span class="n">BSSpAddrIsInBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Beacon/insert: RxChannel = : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byCurrChannel</span><span class="p">);</span>
        <span class="n">BSSbInsertToBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pqwTimestamp</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwBeaconInterval</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">,</span>
                            <span class="n">byCurrChannel</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="n">sERP</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_Country</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_Quiet</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">abyAddr4</span><span class="p">,</span>   <span class="c1">// payload of beacon</span>
                            <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span>
                           <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><pre><code>   DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"update bcn: RxChannel = : %d\n", byCurrChannel);
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="n">BSSbUpdateToBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pqwTimestamp</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwBeaconInterval</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">,</span>
                            <span class="n">byCurrChannel</span><span class="p">,</span>
                            <span class="n">bChannelHit</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="n">sERP</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_Country</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_Quiet</span><span class="p">,</span>
                            <span class="n">pBSSList</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">abyAddr4</span><span class="p">,</span>   <span class="c1">// payload of probresponse</span>
                            <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span>
                           <span class="p">);</span>

    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bInScan</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">byCurrChannel</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">)</span>
       <span class="n">bIsChannelEqual</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bIsChannelEqual</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>if rx beacon without ERP field</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_ERP_USE_PROTECTION</span><span class="p">(</span><span class="n">sERP</span><span class="p">.</span><span class="n">byERP</span><span class="p">)){</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span> <span class="o">|=</span> <span class="n">WLAN_SET_ERP_USE_PROTECTION</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wUseProtectCntDown</span> <span class="o">=</span> <span class="n">USE_PROTECT_PERIOD</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span> <span class="o">|=</span> <span class="n">WLAN_SET_ERP_USE_PROTECTION</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wUseProtectCntDown</span> <span class="o">=</span> <span class="n">USE_PROTECT_PERIOD</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">WLAN_GET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">))</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span> <span class="o">|=</span> <span class="n">WLAN_SET_ERP_BARKER_MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span> <span class="o">|=</span> <span class="n">WLAN_SET_ERP_NONERP_PRESENT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>set to MAC&amp;BBP</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_ERP_USE_PROTECTION</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span><span class="p">)){</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">MACvEnableProtectMD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>check if BSSID the same</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span>
               <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span>
               <span class="n">WLAN_BSSID_LEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">bIsBSSIDEqual</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>2008-05-21 <add> by Richardtai</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrRSSI</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">uRSSI</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurrSQ</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">bySQ</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"BCN:Wake Count= [%d]\n", pMgmt->wCountToWakeUp);</p></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>check if SSID the same</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                   <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                   <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span>
                   <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bIsSSIDEqual</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">WLAN_GET_CAP_INFO_ESS</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">)</span><span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">bIsBSSIDEqual</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">bIsSSIDEqual</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>add state check to prevent reconnect fail since we'll receive Beacon</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bIsAPBeacon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>Compare PHY paramater setting</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">!=</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bUpdatePhyParameter</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">=</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">==</span> <span class="n">WLAN_EID_ERP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byERPContext</span> <span class="o">!=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">bUpdatePhyParameter</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byERPContext</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>Basic Rate Set may change dynamiclly</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abySuppRates</span><span class="p">,</span>
                                                    <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                                    <span class="n">uRateLen</span><span class="p">);</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyExtSuppRates</span><span class="p">,</span>
                                                    <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                                                    <span class="n">uRateLen</span><span class="p">);</span>
            <span class="n">RATEvParseMaxRate</span><span class="p">(</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
                               <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                               <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                               <span class="nb">true</span><span class="p">,</span>
                               <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wMaxBasicRate</span><span class="p">),</span>
                               <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">),</span>
                               <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wSuppRate</span><span class="p">),</span>
                               <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">byTopCCKBasicRate</span><span class="p">),</span>
                               <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">byTopOFDMBasicRate</span><span class="p">)</span>
                              <span class="p">);</span>
<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>printk("RxBeacon:MaxSuppRate is %d\n",pMgmt->sNodeDBTable[0].wMaxSuppRate);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bUpdatePhyParameter</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">CARDbSetPhyParameter</span><span class="p">(</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span>
                                      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span><span class="p">,</span>
                                      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span><span class="p">,</span>
                                      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byERPContext</span><span class="p">,</span>
                                      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span>
                                      <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_PowerConstraint</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">CARDvSetPowerConstraint</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span>
                                        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">,</span>
                                        <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_PowerConstraint</span><span class="o">-&gt;</span><span class="n">byPower</span>
                                        <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_CHSW</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">CARDbChannelSwitch</span><span class="p">(</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span>
                                    <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_CHSW</span><span class="o">-&gt;</span><span class="n">byMode</span><span class="p">,</span>
                                    <span class="n">get_channel_mapping</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_CHSW</span><span class="o">-&gt;</span><span class="n">byMode</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span><span class="p">),</span>
                                    <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_CHSW</span><span class="o">-&gt;</span><span class="n">byCount</span>
                                    <span class="p">);</span>

            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bIsChannelEqual</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">set_channel</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"Beacon 2 \n");
check if CF field exisit</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_CAP_INFO_ESS</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pCFParms</span><span class="o">-&gt;</span><span class="n">wCFPDurRemaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>TODO: deal with CFP period to set NAV</p></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">HIDWORD</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pqwTimestamp</span><span class="p">));</span>
    <span class="n">LODWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LODWORD</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pqwTimestamp</span><span class="p">));</span>
    <span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwLocalTSF</span><span class="p">)</span> <span class="o">=</span> <span class="n">HIDWORD</span><span class="p">(</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span><span class="p">);</span>
    <span class="n">LODWORD</span><span class="p">(</span><span class="n">qwLocalTSF</span><span class="p">)</span> <span class="o">=</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>check if beacon TSF larger or small than our local TSF</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">)</span> <span class="o">==</span> <span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwLocalTSF</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">qwLocalTSF</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">bTSFOffsetPostive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">bTSFOffsetPostive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwLocalTSF</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">bTSFOffsetPostive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwLocalTSF</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">bTSFOffsetPostive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bTSFOffsetPostive</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">qwTSFOffset</span> <span class="o">=</span> <span class="n">CARDqGetTSFOffset</span><span class="p">(</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxRate</span><span class="p">,</span> <span class="p">(</span><span class="n">qwTimestamp</span><span class="p">),</span> <span class="p">(</span><span class="n">qwLocalTSF</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">qwTSFOffset</span> <span class="o">=</span> <span class="n">CARDqGetTSFOffset</span><span class="p">(</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxRate</span><span class="p">,</span> <span class="p">(</span><span class="n">qwLocalTSF</span><span class="p">),</span> <span class="p">(</span><span class="n">qwTimestamp</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwTSFOffset</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwTSFOffset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TRIVIAL_SYNC_DIFFERENCE</span> <span class="p">))</span> <span class="p">{</span>
         <span class="n">bTSFLargeDiff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>if infra mode</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">bIsAPBeacon</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>Infra mode: Local TSF always follow AP's TSF if Difference huge.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">bTSFLargeDiff</span><span class="p">)</span>
            <span class="n">bUpdateTSF</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnablePSMode</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>deal with DTIM, analysis TIM</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bMulticastTIM</span> <span class="o">=</span> <span class="n">WLAN_MGMT_IS_MULTICAST_TIM</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byBitMapCtl</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span> <span class="p">;</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span><span class="p">;</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMPeriod</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byDTIMPeriod</span><span class="p">;</span>
            <span class="n">wAIDNumber</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrAID</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT14</span><span class="o">|</span><span class="n">BIT15</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>check if AID in TIM field bit on
wStartIndex = N1</p></td><td class="code"><div class="highlight"><pre>            <span class="n">wStartIndex</span> <span class="o">=</span> <span class="n">WLAN_MGMT_GET_TIM_OFFSET</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byBitMapCtl</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>AIDIndex = N2</p></td><td class="code"><div class="highlight"><pre>            <span class="n">wAIDIndex</span> <span class="o">=</span> <span class="p">(</span><span class="n">wAIDNumber</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">wAIDNumber</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wAIDIndex</span> <span class="o">&gt;=</span> <span class="n">wStartIndex</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">uLocateByteIndex</span> <span class="o">=</span> <span class="n">wAIDIndex</span> <span class="o">-</span> <span class="n">wStartIndex</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>len = byDTIMCount + byDTIMPeriod + byDTIMPeriod + byVirtBitMap[0~250]</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">uLocateByteIndex</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">byTIMBitOn</span>  <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">wAIDNumber</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bInTIM</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byVirtBitMap</span><span class="p">[</span><span class="n">uLocateByteIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">byTIMBitOn</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bInTIM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bInTIM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bInTIM</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bMulticastTIM</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bInTIMWake</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>send out ps-poll packet
               DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO "BCN:In TIM\n");</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bInTIM</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">PSvSendPSPOLL</span><span class="p">((</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><pre><code>               DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "BCN:PS-POLL sent..\n");
</code></pre></td><td class="code"><div class="highlight"><pre>                <span class="p">}</span>

            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bInTIMWake</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;BCN: Not In TIM..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bPWBitOn</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;BCN: Send Null Packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">PSbSendNullPacket</span><span class="p">(</span><span class="n">pDevice</span><span class="p">))</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bPWBitOn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">PSbConsiderPowerDown</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
                   <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;BCN: Power down now...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="p">}</span>

    <span class="p">}</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>if adhoc mode</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bIsAPBeacon</span> <span class="o">&amp;&amp;</span> <span class="n">bIsChannelEqual</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bIsBSSIDEqual</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>Use sNodeDBTable[0].uInActiveCount as IBSS beacons received count.</p></td><td class="code"><div class="highlight"><pre>		    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		 	    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>adhoc mode:TSF updated only when beacon larger then local TSF</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">bTSFLargeDiff</span> <span class="o">&amp;&amp;</span> <span class="n">bTSFOffsetPostive</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_JOINTED</span><span class="p">))</span>
                <span class="n">bUpdateTSF</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>During dpc, already in spinlocked.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>Update the STA, (Techically the Beacons of all the IBSS nodes
should be identical, but that's not happening in practice.</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
                                                        <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                                        <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">);</span>
                <span class="n">RATEvParseMaxRate</span><span class="p">(</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                   <span class="nb">NULL</span><span class="p">,</span>
                                   <span class="nb">true</span><span class="p">,</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxBasicRate</span><span class="p">),</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">),</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wSuppRate</span><span class="p">),</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byTopCCKBasicRate</span><span class="p">),</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byTopOFDMBasicRate</span><span class="p">)</span>
                                  <span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span> <span class="o">=</span> <span class="n">WLAN_GET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortSlotTime</span> <span class="o">=</span> <span class="n">WLAN_GET_CAP_INFO_SHORTSLOTTIME</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>Todo, initial Node content</p></td><td class="code"><div class="highlight"><pre>                <span class="n">BSSvCreateOneNode</span><span class="p">((</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">);</span>

                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
                                                        <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                                        <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">);</span>
                <span class="n">RATEvParseMaxRate</span><span class="p">(</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                   <span class="nb">NULL</span><span class="p">,</span>
                                   <span class="nb">true</span><span class="p">,</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxBasicRate</span><span class="p">),</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">),</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wSuppRate</span><span class="p">),</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byTopCCKBasicRate</span><span class="p">),</span>
                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byTopOFDMBasicRate</span><span class="p">)</span>
                                 <span class="p">);</span>

                <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span> <span class="o">=</span> <span class="n">WLAN_GET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">;</span>
<span class="cp">#ifdef	PLICE_DEBUG</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>if (uNodeIndex == 0)</p></td><td class="code"><div class="highlight"><pre>		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;s_vMgrRxBeacon:TxDataRate is %d,Index is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">,</span><span class="n">uNodeIndex</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm">                pMgmt-&gt;sNodeDBTable[uNodeIndex].bShortSlotTime = WLAN_GET_CAP_INFO_SHORTSLOTTIME(*sFrame.pwCapInfo);</span>
<span class="cm">                if(pMgmt-&gt;sNodeDBTable[uNodeIndex].wMaxSuppRate &gt; RATE_11M)</span>
<span class="cm">                       pMgmt-&gt;sNodeDBTable[uNodeIndex].bERPExist = true;</span>
<span class="cm">*/</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>if other stations jointed, indicate connect to upper layer..</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_STARTED</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Current IBSS State: [Started]........to: [Jointed] </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_JOINTED</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)){</span>
                    <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bIsSSIDEqual</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>See other adhoc sta with the same SSID but BSSID is different.
adpot this vars only when TSF larger then us.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">bTSFLargeDiff</span> <span class="o">&amp;&amp;</span> <span class="n">bTSFOffsetPostive</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>we don't support ATIM under adhoc mode
if ( sFrame.pIBSSParms->wATIMWindow == 0) {
adpot this vars
TODO: check sFrame cap if privacy on, and support rate syn</p></td><td class="code"><div class="highlight"><pre>                     <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
                     <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
                     <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrATIMWindow</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pIBSSParms</span><span class="o">-&gt;</span><span class="n">wATIMWindow</span><span class="p">);</span>
                     <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwBeaconInterval</span><span class="p">);</span>
                     <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
                                                      <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                                      <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>set HW beacon interval and re-synchronizing....</p></td><td class="code"><div class="highlight"><pre>                     <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Rejoining to Other Adhoc group with same SSID........</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                     <span class="n">VNSvOutPortW</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_BI</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span><span class="p">);</span>
                     <span class="n">CARDbUpdateTSF</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxRate</span><span class="p">,</span> <span class="n">qwTimestamp</span><span class="p">,</span> <span class="n">qwLocalTSF</span><span class="p">);</span>
                     <span class="n">CARDvUpdateNextTBTT</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">qwTimestamp</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>Turn off bssid filter to avoid filter others adhoc station which bssid is different.</p></td><td class="code"><div class="highlight"><pre>                     <span class="n">MACvWriteBSSIDAddress</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">);</span>

                     <span class="n">CARDbSetPhyParameter</span> <span class="p">(</span>  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span>
                                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span><span class="p">,</span>
                                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span><span class="p">,</span>
                                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byERPContext</span><span class="p">,</span>
                                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>MACvRegBitsOff(pDevice->PortOffset, MAC<em>REG</em>RCR, RCR<em>BSSID);
set highest basic rate
s</em>vSetHighestBasicRate(pDevice, (PWLAN<em>IE</em>SUPP_RATES)pMgmt->abyCurrSuppRates);
Prepare beacon frame</p></td><td class="code"><div class="highlight"><pre>                     <span class="n">bMgrPrepareBeaconToSend</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>}</p></td><td class="code"><div class="highlight"><pre>            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>endian issue ???
Update TSF</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">bUpdateTSF</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CARDbGetCurrentTSF</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qwCurrTSF</span><span class="p">);</span>
        <span class="n">CARDbUpdateTSF</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxRate</span><span class="p">,</span> <span class="n">qwTimestamp</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span><span class="p">);</span>
        <span class="n">CARDbGetCurrentTSF</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qwCurrTSF</span><span class="p">);</span>
        <span class="n">CARDvUpdateNextTBTT</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">qwTimestamp</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Instructs the hw to create a bss using the supplied</span>
<span class="cm"> *   attributes. Note that this implementation only supports Ad-Hoc</span>
<span class="cm"> *   BSS creation.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    CMD_STATUS</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="kt">void</span>
<span class="nf">vMgrCreateOwnIBSS</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">PCMD_STATUS</span> <span class="n">pStatus</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>            <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wMaxBasicRate</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wMaxSuppRate</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byTopCCKBasicRate</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byTopOFDMBasicRate</span><span class="p">;</span>
    <span class="n">QWORD</span>               <span class="n">qwCurrTSF</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyRATE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCCK_RATE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyOFDM_RATE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wSuppRate</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Create Basic Service Set .......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">!=</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">!=</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>encryption mode error</p></td><td class="code"><div class="highlight"><pre>            <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_FAILURE</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_EXTSUPP_RATES</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byAPBBType</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11G</span><span class="p">)</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">=</span> <span class="n">PHY_TYPE_11G</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11B</span><span class="p">)</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">=</span> <span class="n">PHY_TYPE_11B</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">=</span> <span class="n">PHY_TYPE_11A</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">!=</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">abyRATE</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">abyRATE</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span>  <span class="n">abyCCK_RATE</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span>  <span class="n">abyOFDM_RATE</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">4</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span>  <span class="n">abyOFDM_RATE</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>Disable Protect Mode</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">MACvDisableProtectMD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">MACvDisableBarkerPreambleMd</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>Kyle Test 2003.11.04</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>set HW beacon interval</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wIBSSBeaconPeriod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wIBSSBeaconPeriod</span> <span class="o">=</span> <span class="n">DEFAULT_IBSS_BI</span><span class="p">;</span>


    <span class="n">CARDbGetCurrentTSF</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qwCurrTSF</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>clear TSF counter</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_TFTCTL</span><span class="p">,</span> <span class="n">TFTCTL_TSFCNTRST</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>enable TSF counter</p></td><td class="code"><div class="highlight"><pre>    <span class="n">VNSvOutPortB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span> <span class="o">+</span> <span class="n">MAC_REG_TFTCTL</span><span class="p">,</span> <span class="n">TFTCTL_TSFCNTREN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>set Next TBTT</p></td><td class="code"><div class="highlight"><pre>    <span class="n">CARDvSetFirstNextTBTT</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wIBSSBeaconPeriod</span><span class="p">);</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uIBSSChannel</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uIBSSChannel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uIBSSChannel</span> <span class="o">=</span> <span class="n">DEFAULT_IBSS_CHANNEL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>set basic rate</p></td><td class="code"><div class="highlight"><pre>    <span class="n">RATEvParseMaxRate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
                      <span class="o">&amp;</span><span class="n">wMaxBasicRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wMaxSuppRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wSuppRate</span><span class="p">,</span>
                      <span class="o">&amp;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyIBSSDFSOwner</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byIBSSDFSRecovery</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>Adopt pre-configured IBSS vars to current vars</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_STARTED</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wIBSSBeaconPeriod</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uIBSSChannel</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrATIMWindow</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wIBSSATIMWindow</span><span class="p">;</span>
    <span class="n">MACvWriteATIMW</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrATIMWindow</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrRSSI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurrSQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>memcpy(pMgmt->abyDesireSSID,pMgmt->abyAdHocSSID,
((PWLAN<em>IE</em>SSID)pMgmt->abyAdHocSSID)->len + WLAN<em>IEHDR</em>LEN);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span>
           <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">,</span>
           <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
          <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>AP mode BSSID = MAC addr</p></td><td class="code"><div class="highlight"><pre>        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
	<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;AP beacon created BSSID:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>BSSID selected must be randomized as spec 11.1.3</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwCurrTSF</span><span class="p">)</span><span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwCurrTSF</span><span class="p">)</span><span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwCurrTSF</span><span class="p">)</span><span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwCurrTSF</span><span class="p">)</span><span class="o">&amp;</span> <span class="mh">0x00000ff0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwCurrTSF</span><span class="p">)</span><span class="o">&amp;</span> <span class="mh">0x000ff000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwCurrTSF</span><span class="p">)</span><span class="o">&amp;</span> <span class="mh">0x0ff00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">^=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE_ADDR_GROUP</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IEEE_ADDR_UNIVERSAL</span><span class="p">;</span>


	<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_INFO</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Adhoc beacon created bssid:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div><p>Set Capability Info</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_ESS</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMPeriod</span> <span class="o">=</span> <span class="n">DEFAULT_DTIM_PERIOD</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMPeriod</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_IBSS</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_PRIVACY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_NONE</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byERPContext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>memcpy(pDevice->abyBSSID, pMgmt->abyCurrBSSID, WLAN<em>BSSID</em>LEN);</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">OP_MODE_AP</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">OP_MODE_ADHOC</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">CARDbSetPhyParameter</span><span class="p">(</span>   <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span>
                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span><span class="p">,</span>
                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span><span class="p">,</span>
                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byERPContext</span><span class="p">,</span>
                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span>
                            <span class="p">);</span>

    <span class="n">CARDbSetBeaconPeriod</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wIBSSBeaconPeriod</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>set channel and clear NAV</p></td><td class="code"><div class="highlight"><pre>    <span class="n">set_channel</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uIBSSChannel</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uIBSSChannel</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">CARDbIsShortPreamble</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">WLAN_SET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">b11hEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_SPECTRUMMNG</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">WLAN_SET_CAP_INFO_SPECTRUMMNG</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_STARTED</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>Prepare beacon to send</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">bMgrPrepareBeaconToSend</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">))</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *   Instructs wmac to join a bss using the supplied attributes.</span>
<span class="cm"> *   The arguments may the BSSID or SSID and the rest of the</span>
<span class="cm"> *   attributes are obtained from the scan result of known bss list.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span>
<span class="nf">vMgrJoinBSSBegin</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">PCMD_STATUS</span> <span class="n">pStatus</span>
    <span class="p">)</span>
<span class="p">{</span>

    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span>
    <span class="n">PKnownBSS</span>       <span class="n">pCurr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">,</span> <span class="n">uu</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pItemRates</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pItemExtRates</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SSID</span>   <span class="n">pItemSSID</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wMaxBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wMaxSuppRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wSuppRate</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byTopCCKBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byTopOFDMBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>


    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="n">MAX_BSS_NUM</span><span class="p">)</span> <span class="p">{</span>
       <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_RESOURCES</span><span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;BSS finding:BSS list is empty.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
       <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-133"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-133">&#182;</a></div><p>memset(pMgmt->abyDesireBSSID, 0,  WLAN<em>BSSID</em>LEN);
Search known BSS list for prefer BSSID or SSID</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pCurr</span> <span class="o">=</span> <span class="n">BSSpSearchBSSList</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                              <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">,</span>
                              <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">,</span>
                              <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span>
                              <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pCurr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
       <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_RESOURCES</span><span class="p">;</span>
       <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">;</span>
       <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Scanning [%s] not found, disconnected !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span>
       <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;AP(BSS) finding:Found a AP(BSS)..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_CAP_INFO_ESS</span><span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))){</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-134"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-134">&#182;</a></div><p>patch for CISCO migration mode</p></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">            if (pDevice-&gt;eEncryptionStatus == Ndis802_11Encryption2Enabled) {</span>
<span class="cm">                if (WPA_SearchRSN(0, WPA_TKIP, pCurr) == false) {</span>
<span class="cm">                    DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO&quot;No match RSN info. ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n&quot;);</span>

<span class="cm">//DIVIDER</span>
<span class="cm">                    pMgmt-&gt;eCurrState = WMAC_STATE_IDLE;</span>
<span class="cm">                    return;</span>
<span class="cm">                }</span>
<span class="cm">            } else if (pDevice-&gt;eEncryptionStatus == Ndis802_11Encryption3Enabled) {</span>
<span class="cm">                if (WPA_SearchRSN(0, WPA_AESCCMP, pCurr) == false) {</span>
<span class="cm">                    DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO&quot;No match RSN info. ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n&quot;);</span>

<span class="cm">//DIVIDER</span>
<span class="cm">                    pMgmt-&gt;eCurrState = WMAC_STATE_IDLE;</span>
<span class="cm">                    return;</span>
<span class="cm">                }</span>
<span class="cm">            }</span>
<span class="cm">*/</span>
        <span class="p">}</span>

<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-135"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-135">&#182;</a></div><p>encryption mode error</p></td><td class="code"><div class="highlight"><pre>            <span class="n">Encyption_Rebuild</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pCurr</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-136"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-136">&#182;</a></div><p>encryption mode error</p></td><td class="code"><div class="highlight"><pre>        <span class="n">s_vMgrSynchBSS</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                       <span class="n">WMAC_MODE_ESS_STA</span><span class="p">,</span>
                       <span class="n">pCurr</span><span class="p">,</span>
                       <span class="n">pStatus</span>
                       <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pStatus</span> <span class="o">==</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-137"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-137">&#182;</a></div><p>if(pDevice->bWPASuppWextEnabled == true)</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span> <span class="o">=</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">;</span>

            <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">pItemRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">;</span>
            <span class="n">pItemExtRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-138"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-138">&#182;</a></div><p>Infrastructure BSS</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pItemRates</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
            <span class="n">pItemRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abySuppRates</span><span class="p">,</span>
                                         <span class="n">pItemRates</span><span class="p">,</span>
                                         <span class="n">uRateLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-139"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-139">&#182;</a></div><p>Adopt this BSS state vars in Mgmt Object</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_EXTSUPP_RATES</span><span class="p">;</span>
            <span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyExtSuppRates</span><span class="p">,</span>
                                            <span class="n">pItemExtRates</span><span class="p">,</span>
                                            <span class="n">uRateLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-140"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-140">&#182;</a></div><p>Parse Support Rate IE</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">((</span><span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pItemRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">pItemRates</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="n">pItemRates</span><span class="o">-&gt;</span><span class="n">abyRates</span><span class="p">[</span><span class="n">pItemRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">abyRates</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
                    <span class="n">ii</span> <span class="o">++</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">ii</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">pItemRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">ii</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">ii</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">uu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uu</span> <span class="o">&lt;</span> <span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">uu</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">abyRates</span><span class="p">[</span><span class="n">uu</span><span class="p">]</span> <span class="o">=</span> <span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">abyRates</span><span class="p">[</span><span class="n">uu</span> <span class="o">+</span> <span class="n">ii</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">pItemExtRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">RATEvParseMaxRate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pItemRates</span><span class="p">,</span> <span class="n">pItemExtRates</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
                              <span class="o">&amp;</span><span class="n">wMaxBasicRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wMaxSuppRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wSuppRate</span><span class="p">,</span>
                              <span class="o">&amp;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-141"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-141">&#182;</a></div><p>Parse Extension Support Rate IE</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span> <span class="o">=</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">wBeaconInterval</span><span class="p">;</span>
            <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">;</span>

            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_JOINTED</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-142"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-142">&#182;</a></div><p>Stuffing Rate IE</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-143"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-143">&#182;</a></div><p>TODO: deal with if wCapInfo the privacy is on, but station WEP is off
TODO: deal with if wCapInfo the PS-Pollable is on.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bool</span> <span class="n">bResult</span> <span class="o">=</span> <span class="n">bAdd_PMKID_Candidate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">sRSNCapObj</span><span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;bAdd_PMKID_Candidate: 1(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bResult</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bResult</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">vFlush_PMKID_Candidate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;vFlush_PMKID_Candidate: 4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="n">bAdd_PMKID_Candidate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">sRSNCapObj</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-144"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-144">&#182;</a></div><p>Adopt BSS state in Adapter Device Object
pDevice->byOpMode = OP<em>MODE</em>INFRASTRUCTURE;
           memcpy(pDevice->abyBSSID, pCurr->abyBSSID, WLAN<em>BSSID</em>LEN);</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Join ESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>



            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;End of Join AP -- A/B/G Action</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
        <span class="p">};</span>


     <span class="p">}</span>
     <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-145"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-145">&#182;</a></div><p>Add current BSS to Candidate list
This should only works for WPA2 BSS, and WPA2 BSS check must be done before.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">WPA_SearchRSN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">WPA_TKIP</span><span class="p">,</span> <span class="n">pCurr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-146"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-146">&#182;</a></div><p>Preamble type auto-switch: if AP can receive short-preamble cap,
we can turn on too.</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">WPA_SearchRSN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">WPA_AESCCMP</span><span class="p">,</span> <span class="n">pCurr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-147"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-147">&#182;</a></div><p>ad-hoc mode BSS</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-148"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-148">&#182;</a></div><p>encryption mode error</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">s_vMgrSynchBSS</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                       <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">,</span>
                       <span class="n">pCurr</span><span class="p">,</span>
                       <span class="n">pStatus</span>
                       <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pStatus</span> <span class="o">==</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-149"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-149">&#182;</a></div><p>encryption mode error</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span> <span class="o">=</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-150"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-150">&#182;</a></div><p>encryption mode error</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abySuppRates</span><span class="p">,</span>
                                                    <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                                    <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-151"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-151">&#182;</a></div><p>Adopt this BSS state vars in Mgmt Object
TODO: check if CapInfo privacy on, but we don't..</p></td><td class="code"><div class="highlight"><pre>            <span class="n">RATEvParseMaxRate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                              <span class="nb">NULL</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wMaxBasicRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wMaxSuppRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wSuppRate</span><span class="p">,</span>
                              <span class="o">&amp;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>

            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">=</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">;</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span> <span class="o">=</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">wBeaconInterval</span><span class="p">;</span>
            <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-152"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-152">&#182;</a></div><p>Parse Support Rate IE</p></td><td class="code"><div class="highlight"><pre>            <span class="n">MACvWriteATIMW</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrATIMWindow</span><span class="p">);</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">;</span>

            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_STARTED</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-153"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-153">&#182;</a></div><p>set basic rate</p></td><td class="code"><div class="highlight"><pre>		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Join IBSS ok:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-154"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-154">&#182;</a></div><pre><code>     pMgmt-&gt;wCurrATIMWindow = pCurr-&gt;wATIMWindow;
</code></pre></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-155"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-155">&#182;</a></div><p>Adopt BSS state in Adapter Device Object
pDevice->byOpMode = OP<em>MODE</em>ADHOC;
           pDevice->bLinkPass = true;
           memcpy(pDevice->abyBSSID, pCurr->abyBSSID, WLAN<em>BSSID</em>LEN);</p></td><td class="code"><div class="highlight"><pre>            <span class="n">bMgrPrepareBeaconToSend</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
        <span class="p">};</span>
     <span class="p">};</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> * Set HW to synchronize a specific BSS from known BSS list.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    PCM_STATUS</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrSynchBSS</span> <span class="p">(</span>
    <span class="n">PSDevice</span>      <span class="n">pDevice</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uBSSMode</span><span class="p">,</span>
    <span class="n">PKnownBSS</span>     <span class="n">pCurr</span><span class="p">,</span>
    <span class="n">PCMD_STATUS</span>  <span class="n">pStatus</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">CARD_PHY_TYPE</span>   <span class="n">ePhyType</span> <span class="o">=</span> <span class="n">PHY_TYPE_11B</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>  <span class="n">pMgmt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pMgmt</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-156"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-156">&#182;</a></div><p>Preamble type auto-switch: if AP can receive short-preamble cap,
and if registry setting is short preamble we can turn on too.</p></td><td class="code"><div class="highlight"><pre>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrSuppRatesG</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WLAN_EID_SUPP_RATES</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrExtSuppRatesG</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WLAN_EID_EXTSUPP_RATES</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">};</span></pre></div></td></tr>


<tr id="section-157"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-157">&#182;</a></div><p>Prepare beacon</p></td><td class="code"><div class="highlight"><pre>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrSuppRatesA</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WLAN_EID_SUPP_RATES</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyCurrSuppRatesB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WLAN_EID_SUPP_RATES</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">};</span>


    <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_FAILURE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">s_bCipherMatch</span><span class="p">(</span><span class="n">pCurr</span><span class="p">,</span>
                       <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span><span class="p">,</span>
                       <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span><span class="p">),</span>
                       <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span><span class="p">))</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;s_bCipherMatch Fail .......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span> <span class="o">=</span> <span class="n">pCurr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-158"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-158">&#182;</a></div><p>int     ii;
1M,   2M,   5M,   11M,  18M,  24M,  36M,  54M</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_BCNDMACTL</span><span class="p">,</span> <span class="n">BEACON_READY</span><span class="p">);</span>
        <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">MAC_REG_TCR</span><span class="p">,</span> <span class="n">TCR_AUTOBCNTX</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-159"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-159">&#182;</a></div><p>6M,   9M,   12M,  48M</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCCK</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">MACvDisableProtectMD</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">MACvDisableBarkerPreambleMd</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bNonERPPresent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wBasicRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-160"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-160">&#182;</a></div><p>if previous mode is IBSS.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">CARDbAddBasicRate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RATE_1M</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-161"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-161">&#182;</a></div><p>Init the BSS informations</p></td><td class="code"><div class="highlight"><pre>    <span class="n">CARDbUpdateTSF</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">byRxRate</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">qwBSSTimestamp</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span><span class="p">);</span>

    <span class="n">CARDbSetBeaconPeriod</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">wBeaconInterval</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-162"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-162">&#182;</a></div><p>Set Basic Rate</p></td><td class="code"><div class="highlight"><pre>    <span class="n">CARDvSetFirstNextTBTT</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">wBeaconInterval</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-163"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-163">&#182;</a></div><p>calculate TSF offset
TSF Offset = Received Timestamp TSF - Marked Local's TSF</p></td><td class="code"><div class="highlight"><pre>    <span class="n">MACvWriteBSSIDAddress</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">);</span>

    <span class="n">MACvReadBSSIDAddress</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">PortOffset</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">);</span>

	<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Sync:set CurrBSSID address = &quot;</span>
		<span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_AUTO</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">ePhyType</span> <span class="o">=</span> <span class="n">PHY_TYPE_11A</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_AUTO</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">ePhyType</span> <span class="o">=</span> <span class="n">PHY_TYPE_11B</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_AUTO</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">ePhyType</span> <span class="o">=</span> <span class="n">PHY_TYPE_11G</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ePhyType</span> <span class="o">=</span> <span class="n">PHY_TYPE_11B</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ePhyType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abyCurrSuppRatesA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">abyCurrSuppRatesA</span><span class="p">));</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ePhyType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abyCurrSuppRatesB</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">abyCurrSuppRatesB</span><span class="p">));</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abyCurrSuppRatesG</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">abyCurrSuppRatesG</span><span class="p">));</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abyCurrExtSuppRatesG</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">abyCurrExtSuppRatesG</span><span class="p">));</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_CAP_INFO_ESS</span><span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">OP_MODE_INFRASTRUCTURE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-164"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-164">&#182;</a></div><p>set Next TBTT
Next TBTT = ((local<em>current</em>TSF / beacon<em>interval) + 1 ) * beacon</em>interval</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">CARDbAdd_PMKID_Candidate</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">sRSNCapObj</span><span class="p">.</span><span class="n">bRSNCapExist</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">sRSNCapObj</span><span class="p">.</span><span class="n">wRSNCap</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">CARDbSetBSSID</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">OP_MODE_ADHOC</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">CARDbSetPhyParameter</span><span class="p">(</span>   <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span>
                                <span class="n">ePhyType</span><span class="p">,</span>
                                <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">,</span>
                                <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">sERP</span><span class="p">.</span><span class="n">byERP</span><span class="p">,</span>
                                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span>
                            <span class="p">)</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;&lt;----s_bSynchBSS Set Phy Mode Fail [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ePhyType</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-165"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-165">&#182;</a></div><p>set BSSID</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">set_channel</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;&lt;----s_bSynchBSS Set Channel [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">    for (ii=0;ii&lt;BB_VGA_LEVEL;ii++) {</span>
<span class="cm">        if (pCurr-&gt;ldBmMAX&lt; pDevice-&gt;ldBmThreshold[ii]) {</span>
<span class="cm">            pDevice-&gt;byBBVGANew = pDevice-&gt;abyBBVGA[ii];</span>
<span class="cm">            break;</span>
<span class="cm">        }</span>
<span class="cm">    }</span>

<span class="cm">    if (pDevice-&gt;byBBVGANew != pDevice-&gt;byBBVGACurrent) {</span>
<span class="cm">        DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO&quot;RSSI[%d] NewGain[%d] OldGain[%d] \n&quot;,</span>
<span class="cm">                        (int)pCurr-&gt;ldBmMAX, pDevice-&gt;byBBVGANew, pDevice-&gt;byBBVGACurrent);</span>
<span class="cm">        printk(&quot;RSSI[%d] NewGain[%d] OldGain[%d] \n&quot;,</span>
<span class="cm">                        (int)pCurr-&gt;ldBmMAX, pDevice-&gt;byBBVGANew, pDevice-&gt;byBBVGACurrent);</span>
<span class="cm">        BBvSetVGAGainOffset(pDevice, pDevice-&gt;byBBVGANew);</span>
<span class="cm">    }</span>
<span class="cm">    printk(&quot;ldBmMAX[%d] NewGain[%d] OldGain[%d] \n&quot;,</span>
<span class="cm">           (int)pCurr-&gt;ldBmMAX, pDevice-&gt;byBBVGANew, pDevice-&gt;byBBVGACurrent);</span>
<span class="cm">*/</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span> <span class="o">=</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">=</span> <span class="n">ePhyType</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byERPContext</span> <span class="o">=</span> <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">sERP</span><span class="p">.</span><span class="n">byERP</span><span class="p">;</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Sync:Set to channel = [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">);</span>


    <span class="o">*</span><span class="n">pStatus</span> <span class="o">=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">;</span>


    <span class="k">return</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-166"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-166">&#182;</a></div><p>Add current BSS to Candidate list
This should only works for WPA2 BSS, and WPA2 BSS check must be done before.</p></td><td class="code"><div class="highlight"><pre> <span class="k">static</span> <span class="kt">void</span>  <span class="nf">Encyption_Rebuild</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PKnownBSS</span> <span class="n">pCurr</span>
 <span class="p">)</span>
 <span class="p">{</span>
  <span class="n">PSMgmtObject</span>  <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-167"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-167">&#182;</a></div><p>set channel and clear NAV</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-168"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-168">&#182;</a></div><p>mike add: fix NetworkManager 0.7.0 hidden ssid mode in WPA encryption
                  ,need reset eAuthenMode and eEncryptionStatus</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">)</span> <span class="o">||</span>           <span class="c1">//networkmanager 0.7.0 does not give the pairwise-key selsection,</span>
             <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2PSK</span><span class="p">))</span> <span class="p">{</span>         <span class="c1">// so we need re-selsect it according to real pairwise-key info.</span>
               <span class="k">if</span><span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">bWPAValid</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>  <span class="p">{</span>   <span class="c1">//WPA-PSK</span>
                          <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">;</span>
		    <span class="k">if</span><span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyPKType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WPA_TKIP</span><span class="p">)</span> <span class="p">{</span>
     		        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">;</span>    <span class="c1">//TKIP</span>
     		        <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;Encyption_Rebuild---&gt;ssid reset config to [WPAPSK-TKIP]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		      <span class="p">}</span>
     		   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyPKType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WPA_AESCCMP</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">;</span>    <span class="c1">//AES</span>
                          <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;Encyption_Rebuild---&gt;ssid reset config to [WPAPSK-AES]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     		     <span class="p">}</span>
               	<span class="p">}</span>
               <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">bWPA2Valid</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//WPA2-PSK</span>
                         <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="n">WMAC_AUTH_WPA2PSK</span><span class="p">;</span>
		       <span class="k">if</span><span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyCSSPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_TKIP</span><span class="p">)</span> <span class="p">{</span>
      		           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">;</span>     <span class="c1">//TKIP</span>
                             <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;Encyption_Rebuild---&gt;ssid reset config to [WPA2PSK-TKIP]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		       	<span class="p">}</span>
      		       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyCSSPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_CCMP</span><span class="p">)</span> <span class="p">{</span>
		           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">;</span>    <span class="c1">//AES</span>
                            <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;Encyption_Rebuild---&gt;ssid reset config to [WPA2PSK-AES]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      		       	<span class="p">}</span>
               	<span class="p">}</span>
              <span class="p">}</span></pre></div></td></tr>


<tr id="section-169"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-169">&#182;</a></div><p>unsigned int ii , uSameBssidNum=0;</p></td><td class="code"><div class="highlight"><pre>      <span class="k">return</span><span class="p">;</span>
 <span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *  Format TIM field</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    void</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrFormatTIM</span><span class="p">(</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PWLAN_IE_TIM</span> <span class="n">pTIM</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byMask</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byMap</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bStartFound</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bMulticast</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wStartIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wEndIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-170"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-170">&#182;</a></div><p>for (ii = 0; ii &lt; MAX<em>BSS</em>NUM; ii++) {
  if (pMgmt->sBSSList[ii].bActive &amp;&amp;
     !compare<em>ether</em>addr(pMgmt->sBSSList[ii].abyBSSID, pCurr->abyBSSID)) {
      uSameBssidNum++;
  }
}
  if( uSameBssidNum>=2) {     //we only check AP in hidden sssid  mode</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_NODE_NUM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byMap</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ii</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-171"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-171">&#182;</a></div><p>}</p></td><td class="code"><div class="highlight"><pre>            <span class="n">bMulticast</span> <span class="o">=</span> <span class="p">(</span><span class="n">byMap</span> <span class="o">&amp;</span> <span class="n">byMask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">bMulticast</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bRxPSPoll</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">byMap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bStartFound</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bStartFound</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">wStartIndex</span> <span class="o">=</span> <span class="n">ii</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">wEndIndex</span> <span class="o">=</span> <span class="n">ii</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-172"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-172">&#182;</a></div><p>Find size of partial virtual bitmap</p></td><td class="code"><div class="highlight"><pre>    <span class="n">wStartIndex</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">BIT0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-173"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-173">&#182;</a></div><p>Mask out the broadcast bit which is indicated separately.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">wEndIndex</span> <span class="o">=</span> <span class="p">((</span><span class="n">wEndIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-174"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-174">&#182;</a></div><p>Round start index down to nearest even number</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span>  <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">wEndIndex</span> <span class="o">-</span> <span class="n">wStartIndex</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-175"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-175">&#182;</a></div><p>Round end index up to nearest even number</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMCount</span><span class="p">;</span>
    <span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byDTIMPeriod</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byDTIMPeriod</span><span class="p">;</span>
    <span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byBitMapCtl</span> <span class="o">=</span> <span class="p">(</span><span class="n">bMulticast</span> <span class="o">?</span> <span class="n">TIM_MULTICAST_MASK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(((</span><span class="n">wStartIndex</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TIM_BITMAPOFFSET_MASK</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-176"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-176">&#182;</a></div><p>Size of element payload</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="n">wStartIndex</span><span class="p">,</span> <span class="n">jj</span> <span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;=</span> <span class="n">wEndIndex</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">,</span> <span class="n">jj</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byVirtBitMap</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-177"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-177">&#182;</a></div><p>Fill in the Fixed parts of the TIM</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byVirtBitMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *  Constructs an Beacon frame( Ad-hoc mode)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    PTR to frame; or NULL on allocation failue</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="n">PSTxMgmtPacket</span>
<span class="nf">s_MgrMakeBeacon</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrBeaconPeriod</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uCurrChannel</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrATIMWinodw</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pCurrSSID</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pCurrBSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrSuppRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WLAN_FR_BEACON</span>      <span class="n">sFrame</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abyBroadcastAddr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyBuffer</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PWLAN_IE_IBSS_DFS</span>   <span class="n">pIBSSDFS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-178"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-178">&#182;</a></div><p>Append variable part of TIM</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_BEACON_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-179"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-179">&#182;</a></div><p>Aid = 0 don't used.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_BEACON_FR_MAXLEN</span><span class="p">;</span>
    <span class="n">vMgrEncodeBeacon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-180"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-180">&#182;</a></div><p>prepare beacon frame</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_BEACON</span><span class="p">)</span>
        <span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnablePSMode</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">WLAN_SET_FC_PWRMGT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwBeaconInterval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCurrBeaconPeriod</span><span class="p">);</span>
    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCurrCapInfo</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-181"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-181">&#182;</a></div><p>Setup the sFrame structure.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">,</span>
             <span class="n">pCurrSSID</span><span class="p">,</span>
             <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pCurrSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
            <span class="p">);</span></pre></div></td></tr>


<tr id="section-182"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-182">&#182;</a></div><p>Setup the header</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
           <span class="n">pCurrSuppRates</span><span class="p">,</span>
           <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
          <span class="p">);</span></pre></div></td></tr>


<tr id="section-183"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-183">&#182;</a></div><p>Copy SSID</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">!=</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_DS_PARMS</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_DS_PARMS</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">byCurrChannel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">uCurrChannel</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-184"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-184">&#182;</a></div><p>Copy the rate set</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_TIM</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_TIM</span><span class="p">;</span>
        <span class="n">s_vMgrFormatTIM</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pTIM</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-185"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-185">&#182;</a></div><p>DS parameter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pIBSSParms</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_IBSS_PARMS</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pIBSSParms</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_IBSS_PARMS</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pIBSSParms</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pIBSSParms</span><span class="o">-&gt;</span><span class="n">wATIMWindow</span> <span class="o">=</span> <span class="n">wCurrATIMWinodw</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* RSN parameter */</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_RSN_EXT</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_RSN_WPA</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">wVersion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span><span class="c1">//AES</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span><span class="c1">//TKIP</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">)</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span><span class="c1">//WEP40</span>
            <span class="k">else</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span><span class="c1">//NONE</span></pre></div></td></tr>


<tr id="section-186"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-186">&#182;</a></div><p>TIM field</p></td><td class="code"><div class="highlight"><pre>            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">wPKCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-187"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-187">&#182;</a></div><p>IBSS parameter</p></td><td class="code"><div class="highlight"><pre>            <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-188"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-188">&#182;</a></div><p>Pairwise Key Cipher Suite</p></td><td class="code"><div class="highlight"><pre>            <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">b11hEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-189"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-189">&#182;</a></div><p>Auth Key Management Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pbyBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">set_country_IE</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pbyBuffer</span><span class="p">);</span>
        <span class="n">set_country_info</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">PHY_TYPE_11A</span><span class="p">,</span> <span class="n">pbyBuffer</span><span class="p">);</span>
        <span class="n">uLength</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_COUNTRY</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">PWLAN_IE_COUNTRY</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-190"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-190">&#182;</a></div><p>RSN Capabilites</p></td><td class="code"><div class="highlight"><pre>        <span class="p">((</span><span class="n">PWLAN_IE_PW_CONST</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_PWR_CONSTRAINT</span><span class="p">;</span>
        <span class="p">((</span><span class="n">PWLAN_IE_PW_CONST</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">((</span><span class="n">PWLAN_IE_PW_CONST</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byPower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">uLength</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bSwitchChannel</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-191"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-191">&#182;</a></div><p>Country IE</p></td><td class="code"><div class="highlight"><pre>            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_CH_SWITCH</span><span class="p">;</span>
            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byChannel</span> <span class="o">=</span> <span class="n">get_channel_number</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byNewChannel</span><span class="p">);</span>
            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
            <span class="n">uLength</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-192"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-192">&#182;</a></div><p>Power Constrain IE</p></td><td class="code"><div class="highlight"><pre>        <span class="p">((</span><span class="n">PWLAN_IE_TPC_REP</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_TPC_REP</span><span class="p">;</span>
        <span class="p">((</span><span class="n">PWLAN_IE_TPC_REP</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">((</span><span class="n">PWLAN_IE_TPC_REP</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byTxPower</span> <span class="o">=</span> <span class="n">CARDbyGetTransmitPower</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">);</span>
        <span class="p">((</span><span class="n">PWLAN_IE_TPC_REP</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byLinkMargin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">uLength</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-193"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-193">&#182;</a></div><p>Channel Switch IE</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">!=</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pIBSSDFS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_IBSS_DFS</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">;</span>
            <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_IBSS_DFS</span><span class="p">;</span>
            <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span>   <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">abyDFSOwner</span><span class="p">,</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyIBSSDFSOwner</span><span class="p">,</span>
                        <span class="mi">6</span><span class="p">);</span>
            <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">byDFSRecovery</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byIBSSDFSRecovery</span><span class="p">;</span>
            <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
            <span class="n">uLength</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="n">CB_MAX_CHANNEL_24G</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;=</span><span class="n">CB_MAX_CHANNEL</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">get_channel_map_info</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">pbyBuffer</span><span class="p">,</span> <span class="n">pbyBuffer</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="n">uLength</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">uLength</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_ERP</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_ERP</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span> <span class="o">|=</span> <span class="n">WLAN_EID_ERP_USE_PROTECTION</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bNonERPPresent</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span> <span class="o">|=</span> <span class="n">WLAN_EID_ERP_NONERP_PRESENT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span> <span class="o">|=</span> <span class="n">WLAN_EID_ERP_BARKER_MODE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
             <span class="n">pCurrExtSuppRates</span><span class="p">,</span>
             <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
             <span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-194"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-194">&#182;</a></div><p>TPC report</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostapd</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_RSN</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
                 <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyWPAIE</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span><span class="p">);</span>
                 <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span><span class="p">;</span>
             <span class="p">}</span>
         <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Adjust the length fields */</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">pTxPacket</span><span class="p">;</span>
<span class="p">}</span>





<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *  Constructs an Prob-response frame</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    PTR to frame; or NULL on allocation failue</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>




<span class="n">PSTxMgmtPacket</span>
<span class="nf">s_MgrMakeProbeResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrBeaconPeriod</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uCurrChannel</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrATIMWinodw</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDstAddr</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pCurrSSID</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pCurrBSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrSuppRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byPHYType</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WLAN_FR_PROBERESP</span>   <span class="n">sFrame</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyBuffer</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PWLAN_IE_IBSS_DFS</span>   <span class="n">pIBSSDFS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>


    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_PROBERESP_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-195"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-195">&#182;</a></div><p>IBSS DFS</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_PROBERESP_FR_MAXLEN</span><span class="p">;</span>
    <span class="n">vMgrEncodeProbeResponse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-196"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-196">&#182;</a></div><p>hostapd wpa/wpa2 IE</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_PROBERESP</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pDstAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwBeaconInterval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCurrBeaconPeriod</span><span class="p">);</span>
    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCurrCapInfo</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byPHYType</span> <span class="o">==</span> <span class="n">BB_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">~</span><span class="p">(</span><span class="n">WLAN_SET_CAP_INFO_SHORTSLOTTIME</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-197"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-197">&#182;</a></div><p>Setup the sFrame structure.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">,</span>
           <span class="n">pCurrSSID</span><span class="p">,</span>
           <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pCurrSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
           <span class="p">);</span></pre></div></td></tr>


<tr id="section-198"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-198">&#182;</a></div><p>Setup the header</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
           <span class="n">pCurrSuppRates</span><span class="p">,</span>
           <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
          <span class="p">);</span></pre></div></td></tr>


<tr id="section-199"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-199">&#182;</a></div><p>Copy SSID</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">!=</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_DS_PARMS</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_DS_PARMS</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">byCurrChannel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">uCurrChannel</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">!=</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-200"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-200">&#182;</a></div><p>Copy the rate set</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pIBSSParms</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_IBSS_PARMS</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pIBSSParms</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_IBSS_PARMS</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pIBSSParms</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pIBSSParms</span><span class="o">-&gt;</span><span class="n">wATIMWindow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_ERP</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_ERP</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span> <span class="o">|=</span> <span class="n">WLAN_EID_ERP_USE_PROTECTION</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bNonERPPresent</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span> <span class="o">|=</span> <span class="n">WLAN_EID_ERP_NONERP_PRESENT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span> <span class="o">|=</span> <span class="n">WLAN_EID_ERP_BARKER_MODE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">b11hEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-201"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-201">&#182;</a></div><p>DS parameter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pbyBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">set_country_IE</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pbyBuffer</span><span class="p">);</span>
        <span class="n">set_country_info</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">PHY_TYPE_11A</span><span class="p">,</span> <span class="n">pbyBuffer</span><span class="p">);</span>
        <span class="n">uLength</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_COUNTRY</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">PWLAN_IE_COUNTRY</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-202"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-202">&#182;</a></div><p>IBSS parameter</p></td><td class="code"><div class="highlight"><pre>        <span class="p">((</span><span class="n">PWLAN_IE_PW_CONST</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_PWR_CONSTRAINT</span><span class="p">;</span>
        <span class="p">((</span><span class="n">PWLAN_IE_PW_CONST</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">((</span><span class="n">PWLAN_IE_PW_CONST</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byPower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">uLength</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bSwitchChannel</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-203"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-203">&#182;</a></div><p>Country IE</p></td><td class="code"><div class="highlight"><pre>            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_CH_SWITCH</span><span class="p">;</span>
            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byChannel</span> <span class="o">=</span> <span class="n">get_channel_number</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byNewChannel</span><span class="p">);</span>
            <span class="p">((</span><span class="n">PWLAN_IE_CH_SW</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
            <span class="n">uLength</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-204"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-204">&#182;</a></div><p>Power Constrain IE</p></td><td class="code"><div class="highlight"><pre>        <span class="p">((</span><span class="n">PWLAN_IE_TPC_REP</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_TPC_REP</span><span class="p">;</span>
        <span class="p">((</span><span class="n">PWLAN_IE_TPC_REP</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">((</span><span class="n">PWLAN_IE_TPC_REP</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byTxPower</span> <span class="o">=</span> <span class="n">CARDbyGetTransmitPower</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">);</span>
        <span class="p">((</span><span class="n">PWLAN_IE_TPC_REP</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byLinkMargin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">uLength</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-205"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-205">&#182;</a></div><p>Channel Switch IE</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">!=</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pIBSSDFS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_IBSS_DFS</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">;</span>
            <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_IBSS_DFS</span><span class="p">;</span>
            <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span>   <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">abyDFSOwner</span><span class="p">,</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyIBSSDFSOwner</span><span class="p">,</span>
                        <span class="mi">6</span><span class="p">);</span>
            <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">byDFSRecovery</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byIBSSDFSRecovery</span><span class="p">;</span>
            <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
            <span class="n">uLength</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="n">CB_MAX_CHANNEL_24G</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;=</span><span class="n">CB_MAX_CHANNEL</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">get_channel_map_info</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">pbyBuffer</span><span class="p">,</span> <span class="n">pbyBuffer</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pbyBuffer</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="n">uLength</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="n">pIBSSDFS</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">uLength</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
             <span class="n">pCurrExtSuppRates</span><span class="p">,</span>
             <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
             <span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-206"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-206">&#182;</a></div><p>TPC report</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostapd</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_RSN</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
                 <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyWPAIE</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span><span class="p">);</span>
                 <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span><span class="p">;</span>
             <span class="p">}</span>
         <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-207"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-207">&#182;</a></div><p>IBSS DFS</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">pTxPacket</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *  Constructs an association request frame</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    A ptr to frame or NULL on allocation failue</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="n">PSTxMgmtPacket</span>
<span class="nf">s_MgrMakeAssocRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDAddr</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wListenInterval</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pCurrSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WLAN_FR_ASSOCREQ</span>    <span class="n">sFrame</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyIEs</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRSN</span><span class="p">;</span>


    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_ASSOCREQ_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-208"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-208">&#182;</a></div><p>hostapd wpa/wpa2 IE</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_ASSOCREQ_FR_MAXLEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-209"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-209">&#182;</a></div><p>Adjust the length fields</p></td><td class="code"><div class="highlight"><pre>    <span class="n">vMgrEncodeAssocRequest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-210"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-210">&#182;</a></div><p>Setup the sFrame structure.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_ASSOCREQ</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pDAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-211"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-211">&#182;</a></div><p>format fixed field frame structure</p></td><td class="code"><div class="highlight"><pre>    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCurrCapInfo</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwListenInterval</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wListenInterval</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-212"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-212">&#182;</a></div><p>Setup the header</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">,</span> <span class="n">pCurrSSID</span><span class="p">,</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span> <span class="o">=</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">OffsetRequestIEs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NDIS_802_11_ASSOCIATION_INFORMATION</span><span class="p">);</span>
    <span class="n">pbyIEs</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">abyIEs</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyIEs</span><span class="p">,</span> <span class="n">pCurrSSID</span><span class="p">,</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="n">pbyIEs</span> <span class="o">+=</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-213"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-213">&#182;</a></div><p>Set the capibility and listen interval</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11B</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-214"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-214">&#182;</a></div><p>sFrame.len point to end of fixed field</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eCurrentPHYType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pCurrExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pCurrExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span> <span class="n">pCurrExtSuppRates</span><span class="p">,</span> <span class="n">pCurrExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span> <span class="o">+=</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyIEs</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="n">pbyIEs</span> <span class="o">+=</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-215"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-215">&#182;</a></div><p>Copy the rate set</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">b11hEnable</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pCurrPowerCap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pCurrPowerCap</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_PW_CAP</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pCurrPowerCap</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_PWR_CAPABILITY</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pCurrPowerCap</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">CARDvGetPowerCapability</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pCurrPowerCap</span><span class="o">-&gt;</span><span class="n">byMinPower</span><span class="p">),</span>
                                    <span class="o">&amp;</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pCurrPowerCap</span><span class="o">-&gt;</span><span class="n">byMaxPower</span><span class="p">)</span>
                                    <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pCurrSuppCh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pCurrSuppCh</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_CH</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">set_support_channels</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pCurrSuppCh</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* WPA IE */</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_RSN_EXT</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_RSN_WPA</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">wVersion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-216"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-216">&#182;</a></div><p>Copy the extension rate set</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">byGKType</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_AESCCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_NONE</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-217"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-217">&#182;</a></div><p>for 802.11h</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">wPKCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_AESCCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_NONE</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-218"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-218">&#182;</a></div><p>Group Key Cipher Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pbyRSN</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x01</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x00</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x00</span><span class="p">;</span>

        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x50</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0xf2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="n">WPA_AUTH_PSK</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="n">WPA_AUTH_IEEE802_1X</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="n">WPA_NONE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-219"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-219">&#182;</a></div><p>Pairwise Key Cipher Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x00</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">2</span><span class="p">;</span>

        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-220"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-220">&#182;</a></div><p>Auth Key Management Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyIEs</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
        <span class="n">pbyIEs</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2PSK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
               <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pwPMKID</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-221"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-221">&#182;</a></div><p>RSN Capabilites</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_RSN</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_RSN</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="c1">//Version(2)+GK(4)</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">wVersion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-222"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-222">&#182;</a></div><p>copy to AssocInfo. for OID<em>802</em>11<em>ASSOCIATION</em>INFORMATION</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">byCSSGK</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_CCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_UNKNOWN</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-223"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-223">&#182;</a></div><p>WPA IE</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_CCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_NONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_USE_GROUP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_UNKNOWN</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-224"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-224">&#182;</a></div><p>Group Key Cipher Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2PSK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_AKMSS_PSK</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_AKMSS_802_1X</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_AKMSS_UNKNOWN</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-225"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-225">&#182;</a></div><p>Pairwise Key Cipher Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">sRSNCapObj</span><span class="p">.</span><span class="n">bRSNCapExist</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">sRSNCapObj</span><span class="p">.</span><span class="n">wRSNCap</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">2</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKID</span><span class="p">.</span><span class="n">BSSIDInfoCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-226"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-226">&#182;</a></div><p>Auth Key Management Suite</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pbyRSN</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
            <span class="n">pwPMKID</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyRSN</span><span class="p">;</span> <span class="c1">// Point to PMKID count</span>
            <span class="o">*</span><span class="n">pwPMKID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>            <span class="c1">// Initialize PMKID count</span>
            <span class="n">pbyRSN</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>             <span class="c1">// Point to PMKID list</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKID</span><span class="p">.</span><span class="n">BSSIDInfoCount</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKID</span><span class="p">.</span><span class="n">BSSIDInfo</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">BSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
                    <span class="p">(</span><span class="o">*</span><span class="n">pwPMKID</span><span class="p">)</span> <span class="o">++</span><span class="p">;</span>
                    <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyRSN</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKID</span><span class="p">.</span><span class="n">BSSIDInfo</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">PMKID</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
                    <span class="n">pbyRSN</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pwPMKID</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">pwPMKID</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-227"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-227">&#182;</a></div><p>RSN Capabilites</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyIEs</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
        <span class="n">pbyIEs</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-228"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-228">&#182;</a></div><p>RSN PMKID</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">pTxPacket</span><span class="p">;</span>
<span class="p">}</span>








<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *  Constructs an re-association request frame</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    A ptr to frame or NULL on allocation failue</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="n">PSTxMgmtPacket</span>
<span class="nf">s_MgrMakeReAssocRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDAddr</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wListenInterval</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SSID</span> <span class="n">pCurrSSID</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WLAN_FR_REASSOCREQ</span>  <span class="n">sFrame</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyIEs</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyRSN</span><span class="p">;</span>


    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span> <span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_REASSOCREQ_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span>
    <span class="cm">/* Setup the sFrame structure. */</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_REASSOCREQ_FR_MAXLEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-229"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-229">&#182;</a></div><p>copy to AssocInfo. for OID<em>802</em>11<em>ASSOCIATION</em>INFORMATION</p></td><td class="code"><div class="highlight"><pre>    <span class="n">vMgrEncodeReassocRequest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>

    <span class="cm">/* Setup the header */</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_REASSOCREQ</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pDAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>

    <span class="cm">/* Set the capibility and listen interval */</span>
    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCurrCapInfo</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwListenInterval</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wListenInterval</span><span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pAddrCurrAP</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
    <span class="cm">/* Copy the SSID */</span>
    <span class="cm">/* sFrame.len point to end of fixed field */</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">,</span> <span class="n">pCurrSSID</span><span class="p">,</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span> <span class="o">=</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">OffsetRequestIEs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NDIS_802_11_ASSOCIATION_INFORMATION</span><span class="p">);</span>
    <span class="n">pbyIEs</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">abyIEs</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyIEs</span><span class="p">,</span> <span class="n">pCurrSSID</span><span class="p">,</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="n">pbyIEs</span> <span class="o">+=</span> <span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>

    <span class="cm">/* Copy the rate set */</span>
    <span class="cm">/* sFrame.len point to end of SSID */</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-230"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-230">&#182;</a></div><p>Adjust the length fields</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrentPHYMode</span> <span class="o">==</span> <span class="n">PHY_TYPE_11G</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pCurrExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pCurrExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span> <span class="n">pCurrExtSuppRates</span><span class="p">,</span> <span class="n">pCurrExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span> <span class="o">+=</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyIEs</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="p">,</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="n">pbyIEs</span> <span class="o">+=</span> <span class="n">pCurrRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* WPA IE */</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_RSN_EXT</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_RSN_WPA</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">wVersion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-231"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-231">&#182;</a></div><p>format fixed field frame structure</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">byGKType</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_AESCCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">abyMulticast</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_NONE</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-232"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-232">&#182;</a></div><p>Copy the extension rate set</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">wPKCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_AESCCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">PKSList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyOUI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WPA_NONE</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-233"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-233">&#182;</a></div><p>Group Key Cipher Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pbyRSN</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x01</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x00</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x00</span><span class="p">;</span>

        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x50</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0xf2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="n">WPA_AUTH_PSK</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="n">WPA_AUTH_IEEE802_1X</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="n">WPA_NONE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-234"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-234">&#182;</a></div><p>Pairwise Key Cipher Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x00</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pbyRSN</span><span class="o">++=</span><span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">2</span><span class="p">;</span>

        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-235"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-235">&#182;</a></div><p>Auth Key Management Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyIEs</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
        <span class="n">pbyIEs</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2PSK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
               <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pwPMKID</span><span class="p">;</span>

        <span class="cm">/* WPA IE */</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_RSN</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_RSN</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="c1">//Version(2)+GK(4)</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">wVersion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-236"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-236">&#182;</a></div><p>RSN Capabilites</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">byCSSGK</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_CCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_UNKNOWN</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-237"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-237">&#182;</a></div><p>copy to AssocInfo. for OID<em>802</em>11<em>ASSOCIATION</em>INFORMATION</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_CCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">byCSSPK</span> <span class="o">==</span> <span class="n">KEY_CTL_NONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_USE_GROUP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_CSS_UNKNOWN</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-238"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-238">&#182;</a></div><p>Group Key Cipher Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2PSK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_AKMSS_PSK</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_AKMSS_802_1X</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_11i_AKMSS_UNKNOWN</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-239"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-239">&#182;</a></div><p>Pairwise Key Cipher Suite</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">sRSNCapObj</span><span class="p">.</span><span class="n">bRSNCapExist</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">sRSNCapObj</span><span class="p">.</span><span class="n">wRSNCap</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span><span class="mi">2</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKID</span><span class="p">.</span><span class="n">BSSIDInfoCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-240"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-240">&#182;</a></div><p>Auth Key Management Suite</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pbyRSN</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">abyRSN</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
            <span class="n">pwPMKID</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyRSN</span><span class="p">;</span> <span class="c1">// Point to PMKID count</span>
            <span class="o">*</span><span class="n">pwPMKID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>            <span class="c1">// Initialize PMKID count</span>
            <span class="n">pbyRSN</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>             <span class="c1">// Point to PMKID list</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKID</span><span class="p">.</span><span class="n">BSSIDInfoCount</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKID</span><span class="p">.</span><span class="n">BSSIDInfo</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">BSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
                    <span class="p">(</span><span class="o">*</span><span class="n">pwPMKID</span><span class="p">)</span> <span class="o">++</span><span class="p">;</span>
                    <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyRSN</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKID</span><span class="p">.</span><span class="n">BSSIDInfo</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">PMKID</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
                    <span class="n">pbyRSN</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pwPMKID</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">pwPMKID</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-241"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-241">&#182;</a></div><p>RSN Capabilites</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sAssocInfo</span><span class="p">.</span><span class="n">AssocInfo</span><span class="p">.</span><span class="n">RequestIELength</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyIEs</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
        <span class="n">pbyIEs</span> <span class="o">+=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="cm">/* Adjust the length fields */</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">pTxPacket</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *  Constructs an assoc-response frame</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    PTR to frame; or NULL on allocation failue</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="n">PSTxMgmtPacket</span>
<span class="nf">s_MgrMakeAssocResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocStatus</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocAID</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDstAddr</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrSuppRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WLAN_FR_ASSOCRESP</span>   <span class="n">sFrame</span><span class="p">;</span>


    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_ASSOCREQ_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-242"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-242">&#182;</a></div><p>RSN PMKID</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_REASSOCRESP_FR_MAXLEN</span><span class="p">;</span>
    <span class="n">vMgrEncodeAssocResponse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-243"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-243">&#182;</a></div><p>copy to AssocInfo. for OID<em>802</em>11<em>ASSOCIATION</em>INFORMATION</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_ASSOCRESP</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pDstAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>

    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCurrCapInfo</span><span class="p">);</span>
    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wAssocStatus</span><span class="p">);</span>
    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">wAssocAID</span> <span class="o">|</span> <span class="n">BIT14</span> <span class="o">|</span> <span class="n">BIT15</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-244"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-244">&#182;</a></div><p>Setup the sFrame structure</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
           <span class="n">pCurrSuppRates</span><span class="p">,</span>
           <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
          <span class="p">);</span>

    <span class="k">if</span> <span class="p">(((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
             <span class="n">pCurrExtSuppRates</span><span class="p">,</span>
             <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
             <span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-245"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-245">&#182;</a></div><p>Setup the header</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">pTxPacket</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *  Constructs an reassoc-response frame</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    PTR to frame; or NULL on allocation failue</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="n">PSTxMgmtPacket</span>
<span class="nf">s_MgrMakeReAssocResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wCurrCapInfo</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocStatus</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wAssocAID</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pDstAddr</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrSuppRates</span><span class="p">,</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pCurrExtSuppRates</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WLAN_FR_REASSOCRESP</span>   <span class="n">sFrame</span><span class="p">;</span>


    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxMgmtPacket</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pbyMgmtPacketPool</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxPacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">)</span> <span class="o">+</span> <span class="n">WLAN_ASSOCREQ_FR_MAXLEN</span><span class="p">);</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxMgmtPacket</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-246"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-246">&#182;</a></div><p>Copy the rate set</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_REASSOCRESP_FR_MAXLEN</span><span class="p">;</span>
    <span class="n">vMgrEncodeReassocResponse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-247"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-247">&#182;</a></div><p>Adjust the length fields</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="n">WLAN_SET_FC_FTYPE</span><span class="p">(</span><span class="n">WLAN_TYPE_MGR</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">WLAN_SET_FC_FSTYPE</span><span class="p">(</span><span class="n">WLAN_FSTYPE_REASSOCRESP</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">,</span> <span class="n">pDstAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>

    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCurrCapInfo</span><span class="p">);</span>
    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwStatus</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wAssocStatus</span><span class="p">);</span>
    <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwAid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">wAssocAID</span> <span class="o">|</span> <span class="n">BIT14</span> <span class="o">|</span> <span class="n">BIT15</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-248"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-248">&#182;</a></div><p>Setup the sFrame structure</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
             <span class="n">pCurrSuppRates</span><span class="p">,</span>
             <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
             <span class="p">);</span>

    <span class="k">if</span> <span class="p">(((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">+</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
             <span class="n">pCurrExtSuppRates</span><span class="p">,</span>
             <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
             <span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-249"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-249">&#182;</a></div><p>Setup the header</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">pTxPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">pTxPacket</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *  Handles probe response management frames.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    none.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxProbeResponse</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PKnownBSS</span>           <span class="n">pBSSList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WLAN_FR_PROBERESP</span>   <span class="n">sFrame</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byCurrChannel</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxChannel</span><span class="p">;</span>
    <span class="n">ERPObject</span>           <span class="n">sERP</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byIEChannel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bChannelHit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>


    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WLAN_FR_PROBERESP</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-250"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-250">&#182;</a></div><p>Copy the rate set</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
    <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
    <span class="n">vMgrDecodeProbeResponse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pqwTimestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwBeaconInterval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Probe resp:Fail addr:[%p] </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">);</span>
        <span class="n">DBG_PORT80</span><span class="p">(</span><span class="mh">0xCC</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
       <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Rx Probe resp: SSID len = 0 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byCurrChannel</span> <span class="o">&gt;</span> <span class="n">CB_MAX_CHANNEL_24G</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-251"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-251">&#182;</a></div><p>Adjust the length fields</p></td><td class="code"><div class="highlight"><pre>            <span class="n">byIEChannel</span> <span class="o">=</span> <span class="n">get_channel_mapping</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pAdapter</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">byCurrChannel</span><span class="p">,</span> <span class="n">PHY_TYPE_11A</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">byIEChannel</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pDSParms</span><span class="o">-&gt;</span><span class="n">byCurrChannel</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byCurrChannel</span> <span class="o">!=</span> <span class="n">byIEChannel</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-252"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-252">&#182;</a></div><p>decode the frame</p></td><td class="code"><div class="highlight"><pre>            <span class="n">bChannelHit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">byCurrChannel</span> <span class="o">=</span> <span class="n">byIEChannel</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-253"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-253">&#182;</a></div><p>channel remapping to</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bChannelHit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-254"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-254">&#182;</a></div><p>adjust channel info. bcs we rcv adjcent channel pakckets</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="n">ChannelExceedZoneType</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">byCurrChannel</span><span class="p">)</span><span class="o">==</span><span class="nb">true</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sERP</span><span class="p">.</span><span class="n">byERP</span> <span class="o">=</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pERP</span><span class="o">-&gt;</span><span class="n">byContext</span><span class="p">;</span>
        <span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">sERP</span><span class="p">.</span><span class="n">byERP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-255"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-255">&#182;</a></div><p>no DS channel info</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pBSSList</span> <span class="o">=</span> <span class="n">BSSpAddrIsInBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span> <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">BSSbUpdateToBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pqwTimestamp</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwBeaconInterval</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">,</span>
                            <span class="n">byCurrChannel</span><span class="p">,</span>
                            <span class="n">bChannelHit</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="n">sERP</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_Country</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_Quiet</span><span class="p">,</span>
                            <span class="n">pBSSList</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">abyAddr4</span><span class="p">,</span>   <span class="c1">// payload of probresponse</span>
                            <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span>
                           <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Probe resp/insert: RxChannel = : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byCurrChannel</span><span class="p">);</span>
        <span class="n">BSSbInsertToBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr3</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pqwTimestamp</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwBeaconInterval</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pwCapInfo</span><span class="p">,</span>
                            <span class="n">byCurrChannel</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="n">sERP</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSN</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pRSNWPA</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_Country</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pIE_Quiet</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">,</span>
                            <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">abyAddr4</span><span class="p">,</span>   <span class="c1">// payload of beacon</span>
                            <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span>
                           <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:(AP)or(Ad-hoc STA)</span>
<span class="cm"> *  Handles probe request management frames.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    none.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrRxProbeRequest</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">WLAN_FR_PROBEREQ</span>    <span class="n">sFrame</span><span class="p">;</span>
    <span class="n">CMD_STATUS</span>          <span class="n">Status</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byPHYType</span> <span class="o">=</span> <span class="n">BB_TYPE_11B</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-256"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-256">&#182;</a></div><p>2008-0730-01<Add>by MikeLiu</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBeaconSent</span><span class="p">))</span> <span class="p">{</span>

        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WLAN_FR_PROBEREQ</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-257"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-257">&#182;</a></div><p>update or insert the bss</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">;</span>
        <span class="n">sFrame</span><span class="p">.</span><span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">;</span>
        <span class="n">vMgrDecodeProbeRequest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFrame</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">	DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO &quot;Probe request rx:MAC addr:%pM\n&quot;,</span>
<span class="cm">		sFrame.pHdr-&gt;sA3.abyAddr2);</span>
<span class="cm">*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                       <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                       <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                       <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sFrame</span><span class="p">.</span><span class="n">pExtSuppRates</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">byPHYType</span> <span class="o">=</span> <span class="n">BB_TYPE_11G</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-258"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-258">&#182;</a></div><p>STA in Ad-hoc mode: when latest TBTT beacon transmit success,
STA have to response this request.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pTxPacket</span> <span class="o">=</span> <span class="n">s_MgrMakeProbeResponse</span>
                    <span class="p">(</span>
                      <span class="n">pDevice</span><span class="p">,</span>
                      <span class="n">pMgmt</span><span class="p">,</span>
                      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span><span class="p">,</span>
                      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span><span class="p">,</span>
                      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">,</span>
                      <span class="mi">0</span><span class="p">,</span>
                      <span class="n">sFrame</span><span class="p">.</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span>
                      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                       <span class="n">byPHYType</span>
                    <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pTxPacket</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">){</span>
            <span class="cm">/* send the frame */</span>
            <span class="n">Status</span> <span class="o">=</span> <span class="n">csMgmt_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Mgt:Probe response tx failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-259"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-259">&#182;</a></div><p>decode the frame</p></td><td class="code"><div class="highlight"><pre>            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>





<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *</span>
<span class="cm"> *  Entry point for the reception and handling of 802.11 management</span>
<span class="cm"> *  frames. Makes a determination of the frame type and then calls</span>
<span class="cm"> *  the appropriate function.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    none.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="kt">void</span>
<span class="nf">vMgrRxManagePacket</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="n">PSRxMgmtPacket</span> <span class="n">pRxPacket</span>
     <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>    <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">bInScan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">NODE_STATE</span>  <span class="n">eNodeState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">CMD_STATUS</span>  <span class="n">Status</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">BSSDBbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span>
            <span class="n">eNodeState</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">eNodeState</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">switch</span><span class="p">(</span> <span class="n">WLAN_GET_FC_FSTYPE</span><span class="p">((</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">))</span> <span class="p">){</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_ASSOCREQ</span>:</pre></div></td></tr>


<tr id="section-260"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-260">&#182;</a></div><p>Probe response reply..</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx assocreq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eNodeState</span> <span class="o">&lt;</span> <span class="n">NODE_AUTH</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-261"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-261">&#182;</a></div><pre><code>           DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Probe response tx sending..\n");
</code></pre></td><td class="code"><div class="highlight"><pre>                <span class="n">vMgrDeAuthenBeginSta</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                     <span class="n">pMgmt</span><span class="p">,</span>
                                     <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span>
                                     <span class="p">(</span><span class="mi">6</span><span class="p">),</span>
                                     <span class="o">&amp;</span><span class="n">Status</span>
                                     <span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;wmgr: send vMgrDeAuthenBeginSta 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">s_vMgrRxAssocRequest</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_ASSOCRESP</span>:</pre></div></td></tr>


<tr id="section-262"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-262">&#182;</a></div><p>Frame Clase = 2</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx assocresp1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">s_vMgrRxAssocResponse</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx assocresp2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_REASSOCREQ</span>:</pre></div></td></tr>


<tr id="section-263"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-263">&#182;</a></div><p>send deauth notification
reason = (6) class 2 received from nonauth sta</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx reassocreq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-264"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-264">&#182;</a></div><p>Frame Clase = 2</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">eNodeState</span> <span class="o">&lt;</span> <span class="n">NODE_AUTH</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-265"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-265">&#182;</a></div><p>Frame Clase = 2</p></td><td class="code"><div class="highlight"><pre>                <span class="n">vMgrDeAuthenBeginSta</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                     <span class="n">pMgmt</span><span class="p">,</span>
                                     <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span>
                                     <span class="p">(</span><span class="mi">6</span><span class="p">),</span>
                                     <span class="o">&amp;</span><span class="n">Status</span>
                                     <span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;wmgr: send vMgrDeAuthenBeginSta 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

            <span class="p">}</span>
            <span class="n">s_vMgrRxReAssocRequest</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_REASSOCRESP</span>:</pre></div></td></tr>


<tr id="section-266"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-266">&#182;</a></div><p>Todo: reassoc</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx reassocresp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">s_vMgrRxAssocResponse</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_PROBEREQ</span>:</pre></div></td></tr>


<tr id="section-267"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-267">&#182;</a></div><p>send deauth notification
reason = (6) class 2 received from nonauth sta</p></td><td class="code"><div class="highlight"><pre>            <span class="n">s_vMgrRxProbeRequest</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_PROBERESP</span>:</pre></div></td></tr>


<tr id="section-268"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-268">&#182;</a></div><p>Frame Clase = 2</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx proberesp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

            <span class="n">s_vMgrRxProbeResponse</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_BEACON</span>:</pre></div></td></tr>


<tr id="section-269"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-269">&#182;</a></div><p>Frame Clase = 0
DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO "rx probereq\n");</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanState</span> <span class="o">!=</span> <span class="n">WMAC_NO_SCANNING</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bInScan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">s_vMgrRxBeacon</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">,</span> <span class="n">bInScan</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_ATIM</span>:</pre></div></td></tr>


<tr id="section-270"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-270">&#182;</a></div><p>Frame Clase = 0</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx atim</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_DISASSOC</span>:</pre></div></td></tr>


<tr id="section-271"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-271">&#182;</a></div><p>Frame Clase = 0
DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO "rx beacon\n");</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx disassoc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eNodeState</span> <span class="o">&lt;</span> <span class="n">NODE_AUTH</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-272"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-272">&#182;</a></div><p>Frame Clase = 1</p></td><td class="code"><div class="highlight"><pre>                <span class="n">vMgrDeAuthenBeginSta</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                     <span class="n">pMgmt</span><span class="p">,</span>
                                     <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">,</span>
                                     <span class="p">(</span><span class="mi">6</span><span class="p">),</span>
                                     <span class="o">&amp;</span><span class="n">Status</span>
                                     <span class="p">);</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;wmgr: send vMgrDeAuthenBeginSta 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">s_vMgrRxDisassociation</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_AUTHEN</span>:</pre></div></td></tr>


<tr id="section-273"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-273">&#182;</a></div><p>Frame Clase = 2</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span>  <span class="s">&quot;rx authen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">s_vMgrRxAuthentication</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">WLAN_FSTYPE_DEAUTHEN</span>:</pre></div></td></tr>


<tr id="section-274"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-274">&#182;</a></div><p>send deauth notification
reason = (6) class 2 received from nonauth sta</p></td><td class="code"><div class="highlight"><pre>            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx deauthen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">s_vMgrRxDeauthentication</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="p">,</span> <span class="n">pRxPacket</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="nl">default:</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;rx unknown mgmt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>




<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Prepare beacon to send</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    true if success; false if failed.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="n">bool</span>
<span class="nf">bMgrPrepareBeaconToSend</span><span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>            <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSTxMgmtPacket</span>      <span class="n">pTxPacket</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-275"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-275">&#182;</a></div><p>Frame Clase = 1</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">||</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnable8021x</span><span class="p">){</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">|=</span> <span class="n">WLAN_SET_CAP_INFO_PRIVACY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_SET_CAP_INFO_PRIVACY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pTxPacket</span> <span class="o">=</span> <span class="n">s_MgrMakeBeacon</span>
                <span class="p">(</span>
                  <span class="n">pDevice</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrCapInfo</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">,</span>
                  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrATIMWindow</span><span class="p">,</span> <span class="c1">//0,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span>
                  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span>
                <span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">csBeacon_xmit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTxPacket</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>




<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *</span>
<span class="cm"> *  Log a warning message based on the contents of the Status</span>
<span class="cm"> *  Code field of an 802.11 management frame.  Defines are</span>
<span class="cm"> *  derived from 802.11-1997 SPEC.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    none.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vMgrLogStatus</span><span class="p">(</span>
    <span class="n">PSMgmtObject</span> <span class="n">pMgmt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wStatus</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span> <span class="n">wStatus</span> <span class="p">){</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_UNSPEC_FAILURE</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Unspecified error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_CAPS_UNSUPPORTED</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Can&#39;t support all requested capabilities.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_REASSOC_NO_ASSOC</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Reassoc denied, can&#39;t confirm original Association.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_ASSOC_DENIED_UNSPEC</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Assoc denied, undefine in spec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_UNSUPPORTED_AUTHALG</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Peer doesn&#39;t support authen algorithm.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_RX_AUTH_NOSEQ</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Authen frame received out of sequence.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_CHALLENGE_FAIL</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Authen rejected, challenge  failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_AUTH_TIMEOUT</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Authen rejected, timeout waiting for next frame.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_ASSOC_DENIED_BUSY</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Assoc denied, AP too busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_ASSOC_DENIED_RATES</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Assoc denied, we haven&#39;t enough basic rates.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_ASSOC_DENIED_SHORTPREAMBLE</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Assoc denied, we do not support short preamble.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_ASSOC_DENIED_PBCC</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Assoc denied, we do not support PBCC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">WLAN_MGMT_STATUS_ASSOC_DENIED_AGILITY</span>:
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Status code == Assoc denied, we do not support channel agility.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Unknown status code %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wStatus</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *    Add BSSID in PMKID Candidate list.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      hDeviceContext - device structure point</span>
<span class="cm"> *      pbyBSSID - BSSID address for adding</span>
<span class="cm"> *      wRSNCap - BSS&#39;s RSN capability</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="n">bool</span>
<span class="nf">bAdd_PMKID_Candidate</span> <span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyBSSID</span><span class="p">,</span>
    <span class="n">PSRSNCapObject</span> <span class="n">psRSNCapObj</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>         <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PPMKID_CANDIDATE</span> <span class="n">pCandidateList</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;bAdd_PMKID_Candidate START: (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">NumCandidates</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pbyBSSID</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">psRSNCapObj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">NumCandidates</span> <span class="o">&gt;=</span> <span class="n">MAX_PMKIDLIST</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-276"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-276">&#182;</a></div><p>Frame Clase = 1</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">NumCandidates</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pCandidateList</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">CandidateList</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pCandidateList</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">psRSNCapObj</span><span class="o">-&gt;</span><span class="n">bRSNCapExist</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">psRSNCapObj</span><span class="o">-&gt;</span><span class="n">wRSNCap</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pCandidateList</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pCandidateList</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-277"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-277">&#182;</a></div><p>pDevice->bBeaconBufReady = false;</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pCandidateList</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">CandidateList</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">NumCandidates</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">psRSNCapObj</span><span class="o">-&gt;</span><span class="n">bRSNCapExist</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">psRSNCapObj</span><span class="o">-&gt;</span><span class="n">wRSNCap</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pCandidateList</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pCandidateList</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pCandidateList</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">NumCandidates</span><span class="o">++</span><span class="p">;</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;NumCandidates:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">NumCandidates</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *    Flush PMKID Candidate list.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      hDeviceContext - device structure point</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="kt">void</span>
<span class="nf">vFlush_PMKID_Candidate</span> <span class="p">(</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SPMKIDCandidateEvent</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">s_bCipherMatch</span> <span class="p">(</span>
    <span class="n">PKnownBSS</span>                        <span class="n">pBSSNode</span><span class="p">,</span>
    <span class="n">NDIS_802_11_ENCRYPTION_STATUS</span>    <span class="n">EncStatus</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyCCSPK</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbyCCSGK</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_INVALID</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byCipherMask</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-278"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-278">&#182;</a></div><p>Update Old Candidate</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">WLAN_GET_CAP_INFO_PRIVACY</span><span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="p">(</span><span class="n">EncStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-279"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-279">&#182;</a></div><p>New Candidate</p></td><td class="code"><div class="highlight"><pre>        <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">WLAN_GET_CAP_INFO_PRIVACY</span><span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">bWPA2Valid</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span></pre></div></td></tr>


<tr id="section-280"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-280">&#182;</a></div><p>check cap. of BSS</p></td><td class="code"><div class="highlight"><pre>        <span class="p">((</span><span class="n">EncStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">EncStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-281"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-281">&#182;</a></div><p>default is WEP only</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_WEP40</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_WEP104</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">byCSSGK</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_INVALID</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-282"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-282">&#182;</a></div><p>20080123-01,<Add> by Einsn Liu</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">wCSSPKCount</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">abyCSSPK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_WEP40</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">abyCSSPK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_WEP104</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-283"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-283">&#182;</a></div><p>WPA2
check Group Key Cipher</p></td><td class="code"><div class="highlight"><pre>                <span class="n">byCipherMask</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">abyCSSPK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_TKIP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">byCipherMask</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">abyCSSPK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_CCMP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">byCipherMask</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">abyCSSPK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_11i_CSS_USE_GROUP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-284"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-284">&#182;</a></div><p>check Pairwise Key Cipher</p></td><td class="code"><div class="highlight"><pre>                <span class="n">byCipherMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">wCSSPKCount</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">WLAN_GET_CAP_INFO_PRIVACY</span><span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">bWPAValid</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">((</span><span class="n">EncStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">EncStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-285"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-285">&#182;</a></div><p>this should not happen as defined 802.11i</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">byGKType</span> <span class="o">==</span> <span class="n">WPA_WEP40</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">byGKType</span> <span class="o">==</span> <span class="n">WPA_WEP104</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">byGKType</span> <span class="o">==</span> <span class="n">WPA_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">byGKType</span> <span class="o">==</span> <span class="n">WPA_AESCCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">byMulticastCipher</span> <span class="o">=</span> <span class="n">KEY_CTL_INVALID</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-286"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-286">&#182;</a></div><p>use group key only ignore all others</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">wPKCount</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">abyPKType</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">WPA_TKIP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">byCipherMask</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">abyPKType</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">WPA_AESCCMP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">byCipherMask</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">abyPKType</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">WPA_NONE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-287"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-287">&#182;</a></div><p>WPA
check Group Key Cipher</p></td><td class="code"><div class="highlight"><pre>                <span class="n">byCipherMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">wPKCount</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;%d, %d, %d, %d, EncStatus:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="n">byMulticastCipher</span><span class="p">,</span> <span class="n">byCipherMask</span><span class="p">,</span> <span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">bWPAValid</span><span class="p">,</span> <span class="n">pBSSNode</span><span class="o">-&gt;</span><span class="n">bWPA2Valid</span><span class="p">,</span> <span class="n">EncStatus</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-288"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-288">&#182;</a></div><p>check Pairwise Key Cipher</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">EncStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-289"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-289">&#182;</a></div><p>use group key only ignore all others</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="n">byMulticastCipher</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">byCipherMask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyCCSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
            <span class="o">*</span><span class="n">pbyCCSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_NONE</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">EncStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">byMulticastCipher</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">byCipherMask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyCCSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
            <span class="o">*</span><span class="n">pbyCCSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_NONE</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byMulticastCipher</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">((</span><span class="n">byCipherMask</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyCCSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
            <span class="o">*</span><span class="n">pbyCCSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byMulticastCipher</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">((</span><span class="n">byCipherMask</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyCCSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
            <span class="o">*</span><span class="n">pbyCCSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">EncStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">byMulticastCipher</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">byCipherMask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-290"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-290">&#182;</a></div><p>mask our cap. with BSS</p></td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byMulticastCipher</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">((</span><span class="n">byCipherMask</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyCCSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_WEP</span><span class="p">;</span>
            <span class="o">*</span><span class="n">pbyCCSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byMulticastCipher</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">((</span><span class="n">byCipherMask</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyCCSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_TKIP</span><span class="p">;</span>
            <span class="o">*</span><span class="n">pbyCCSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byMulticastCipher</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">((</span><span class="n">byCipherMask</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pbyCCSGK</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
            <span class="o">*</span><span class="n">pbyCCSPK</span> <span class="o">=</span> <span class="n">KEY_CTL_CCMP</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>


<tr id="section-291"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-291">&#182;</a></div><p>For supporting Cisco migration mode, don't care pairwise key cipher</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-292"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-292">&#182;</a></div><p>When CCMP is enable, "Use group cipher suite" shall not be a valid option.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
