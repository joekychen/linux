<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › sbe-2t3e3 › dc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SBE 2T3E3 synchronous serial card driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009-2010 Krzysztof Halasa &lt;khc@pm.waw.pl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This code is based on a driver written by SBE Inc.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &quot;2t3e3.h&quot;</span>
<span class="cp">#include &quot;ctrl.h&quot;</span>

<span class="kt">void</span> <span class="nf">dc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">dc_stop</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="cm">/*dc_reset(sc);*/</span> <span class="cm">/* do not want to reset here */</span>

	<span class="cm">/*</span>
<span class="cm">	 * BUS_MODE (CSR0)</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_21143_VAL_READ_LINE_ENABLE</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_READ_MULTIPLE_ENABLE</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_TRANSMIT_AUTOMATIC_POLLING_200us</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_BUS_ARBITRATION_RR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SBE_2T3E3_21143_VAL_WRITE_AND_INVALIDATE_ENABLE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">cache_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SBE_2T3E3_21143_VAL_CACHE_ALIGNMENT_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SBE_2T3E3_21143_VAL_CACHE_ALIGNMENT_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SBE_2T3E3_21143_VAL_CACHE_ALIGNMENT_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_BUS_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* OPERATION_MODE (CSR6) */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_21143_VAL_RECEIVE_ALL</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_MUST_BE_ONE</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS_1</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_LOOPBACK_OFF</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_PASS_ALL_MULTICAST</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_PROMISCUOUS_MODE</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_PASS_BAD_FRAMES</span><span class="p">;</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">loopback</span> <span class="o">==</span> <span class="n">SBE_2T3E3_LOOPBACK_ETHERNET</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">SBE_2T3E3_LOOPBACK_NONE</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"> /* No need to clear this register - and it may be in use */</span>
<span class="c">	/*</span>
<span class="c">	 * BOOT_ROM_SERIAL_ROM_AND_MII_MANAGEMENT (CSR9)</span>
<span class="c">	 */</span>
<span class="c">	val = 0;</span>
<span class="c">	dc_write(sc-&gt;addr, SBE_2T3E3_21143_REG_BOOT_ROM_SERIAL_ROM_AND_MII_MANAGEMENT, val);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * GENERAL_PURPOSE_TIMER_AND_INTERRUPT_MITIGATION_CONTROL (CSR11)</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_21143_VAL_CYCLE_SIZE</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_TRANSMIT_TIMER</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_NUMBER_OF_TRANSMIT_PACKETS</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_RECEIVE_TIMER</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_21143_VAL_NUMBER_OF_RECEIVE_PACKETS</span><span class="p">;</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_GENERAL_PURPOSE_TIMER_AND_INTERRUPT_MITIGATION_CONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* prepare descriptors and data for receive and transmit procecsses */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dc_init_descriptor_list</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* clear ethernet interrupts status */</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_STATUS</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="cm">/* SIA mode registers */</span>
	<span class="n">dc_set_output_port</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SBE_2T3E3_FLAG_NETWORK_UP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dc_init</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="cm">/* get actual LOS and OOF status */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">frame_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_TYPE_E3_G751</span>:
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_TYPE_E3_G832</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">exar7250_read</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_FRAMER_REG_E3_RX_CONFIGURATION_STATUS_2</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Start Framer Rx Status = %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">OOF</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">SBE_2T3E3_FRAMER_VAL_E3_RX_OOF</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_TYPE_T3_CBIT</span>:
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_TYPE_T3_M13</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">exar7250_read</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_FRAMER_REG_T3_RX_CONFIGURATION_STATUS</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Start Framer Rx Status = %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">OOF</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">SBE_2T3E3_FRAMER_VAL_T3_RX_OOF</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cpld_LOS_update</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="cm">/* start receive and transmit processes */</span>
	<span class="n">dc_transmitter_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_ON</span><span class="p">);</span>
	<span class="n">dc_receiver_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_ON</span><span class="p">);</span>

	<span class="cm">/* start interrupts */</span>
	<span class="n">dc_start_intr</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_INT_WAIT_CNT	12000</span>
<span class="kt">void</span> <span class="nf">dc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wcnt</span><span class="p">;</span>

	<span class="cm">/* stop receive and transmit processes */</span>
	<span class="n">dc_receiver_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_OFF</span><span class="p">);</span>
	<span class="n">dc_transmitter_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_OFF</span><span class="p">);</span>

	<span class="cm">/* turn off ethernet interrupts */</span>
	<span class="n">dc_stop_intr</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="cm">/* wait to ensure the interrupts have been completed */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">wcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">wcnt</span> <span class="o">&lt;</span> <span class="n">MAX_INT_WAIT_CNT</span><span class="p">;</span> <span class="n">wcnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">interrupt_active</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wcnt</span> <span class="o">&gt;=</span> <span class="n">MAX_INT_WAIT_CNT</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBE 2T3E3: Interrupt active too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* clear all receive/transmit data */</span>
	<span class="n">dc_drop_descriptor_list</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dc_start_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">loopback</span> <span class="o">==</span> <span class="n">SBE_2T3E3_LOOPBACK_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">OOF</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">receiver_on</span> <span class="o">||</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">transmitter_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">interrupt_enable_mask</span><span class="p">)</span>
			<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_STATUS</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">interrupt_enable_mask</span> <span class="o">=</span>
			<span class="n">SBE_2T3E3_21143_VAL_NORMAL_INTERRUPT_SUMMARY_ENABLE</span> <span class="o">|</span>
			<span class="n">SBE_2T3E3_21143_VAL_ABNORMAL_INTERRUPT_SUMMARY_ENABLE</span> <span class="o">|</span>
			<span class="n">SBE_2T3E3_21143_VAL_RECEIVE_STOPPED_ENABLE</span> <span class="o">|</span>
			<span class="n">SBE_2T3E3_21143_VAL_RECEIVE_BUFFER_UNAVAILABLE_ENABLE</span> <span class="o">|</span>
			<span class="n">SBE_2T3E3_21143_VAL_RECEIVE_INTERRUPT_ENABLE</span> <span class="o">|</span>
			<span class="n">SBE_2T3E3_21143_VAL_TRANSMIT_UNDERFLOW_INTERRUPT_ENABLE</span> <span class="o">|</span>
			<span class="n">SBE_2T3E3_21143_VAL_TRANSMIT_BUFFER_UNAVAILABLE_ENABLE</span> <span class="o">|</span>
			<span class="n">SBE_2T3E3_21143_VAL_TRANSMIT_STOPPED_ENABLE</span> <span class="o">|</span>
			<span class="n">SBE_2T3E3_21143_VAL_TRANSMIT_INTERRUPT_ENABLE</span><span class="p">;</span>

		<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_INTERRUPT_ENABLE</span><span class="p">,</span>
			 <span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">interrupt_enable_mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dc_stop_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">interrupt_enable_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* turn off ethernet interrupts */</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_STATUS</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="cm">/* software reset */</span>
	<span class="n">dc_set_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_BUS_MODE</span><span class="p">,</span>
		   <span class="n">SBE_2T3E3_21143_VAL_SOFTWARE_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="cm">/* 50 PCI cycles &lt; 2us */</span>

	<span class="cm">/* clear hardware configuration */</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_BUS_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* clear software configuration */</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* turn off SIA reset */</span>
	<span class="n">dc_set_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_SIA_CONNECTIVITY</span><span class="p">,</span>
		   <span class="n">SBE_2T3E3_21143_VAL_SIA_RESET</span><span class="p">);</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_SIA_TRANSMIT_AND_RECEIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_SIA_AND_GENERAL_PURPOSE_PORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">dc_receiver_onoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">receiver_on</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dc_read</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">SBE_2T3E3_21143_VAL_RECEIVE_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dc_clear_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span>
				      <span class="n">SBE_2T3E3_21143_VAL_RECEIVE_START</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">dc_read</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">SBE_2T3E3_21143_VAL_RECEIVE_PROCESS_STATE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">SBE_2T3E3_21143_VAL_RX_STOPPED</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SBE_2T3E3_21143_VAL_RX_STOPPED</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBE 2T3E3: Rx failed to stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBE 2T3E3: Rx off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_ON</span>:
		<span class="n">dc_set_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span>
			   <span class="n">SBE_2T3E3_21143_VAL_RECEIVE_START</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_RECEIVE_POLL_DEMAND</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">receiver_on</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dc_transmitter_onoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">transmitter_on</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dc_read</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">SBE_2T3E3_21143_VAL_TRANSMISSION_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dc_clear_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span>
				      <span class="n">SBE_2T3E3_21143_VAL_TRANSMISSION_START</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">dc_read</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">SBE_2T3E3_21143_VAL_TRANSMISSION_PROCESS_STATE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">SBE_2T3E3_21143_VAL_TX_STOPPED</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SBE_2T3E3_21143_VAL_TX_STOPPED</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBE 2T3E3: Tx failed to stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_ON</span>:
		<span class="n">dc_set_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span>
			   <span class="n">SBE_2T3E3_21143_VAL_TRANSMISSION_START</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_TRANSMIT_POLL_DEMAND</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">transmitter_on</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">dc_set_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_21143_VAL_LOOPBACK_OFF</span>:
	<span class="k">case</span> <span class="n">SBE_2T3E3_21143_VAL_LOOPBACK_INTERNAL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* restart SIA */</span>
<span class="c">	dc_clear_bits(sc-&gt;addr, SBE_2T3E3_21143_REG_SIA_CONNECTIVITY,</span>
<span class="c">		      SBE_2T3E3_21143_VAL_SIA_RESET);</span>
<span class="c">	udelay(1000);</span>
<span class="c">	dc_set_bits(sc-&gt;addr, SBE_2T3E3_21143_REG_SIA_CONNECTIVITY,</span>
<span class="c">		    SBE_2T3E3_21143_VAL_SIA_RESET);</span>
<span class="cp">#endif</span>

	<span class="cm">/* select loopback mode */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">dc_read</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="n">SBE_2T3E3_21143_VAL_OPERATING_MODE</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SBE_2T3E3_21143_VAL_LOOPBACK_OFF</span><span class="p">)</span>
		<span class="n">dc_set_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span>
			   <span class="n">SBE_2T3E3_21143_VAL_FULL_DUPLEX_MODE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dc_clear_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span>
			      <span class="n">SBE_2T3E3_21143_VAL_FULL_DUPLEX_MODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">dc_init_descriptor_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">SBE_2T3E3_RX_DESC_RING_SIZE</span> <span class="o">*</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">t3e3_rx_desc_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBE 2T3E3: no buffer space for RX ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">SBE_2T3E3_TX_DESC_RING_SIZE</span> <span class="o">*</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">t3e3_tx_desc_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBE 2T3E3: no buffer space for RX ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Receive ring</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SBE_2T3E3_RX_DESC_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdes0</span> <span class="o">=</span> <span class="n">SBE_2T3E3_RX_DESC_21143_OWN</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdes1</span> <span class="o">=</span>
			<span class="n">SBE_2T3E3_RX_DESC_SECOND_ADDRESS_CHAINED</span> <span class="o">|</span> <span class="n">SBE_2T3E3_MTU</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MCLBYTES</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_data</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
					<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">);</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">);</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBE 2T3E3: token_alloc err:&quot;</span>
					<span class="s">&quot; no buffer space for RX ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdes2</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdes3</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SBE_2T3E3_RX_DESC_RING_SIZE</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">SBE_2T3E3_RX_DESC_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">rdes1</span> <span class="o">|=</span>
		<span class="n">SBE_2T3E3_RX_DESC_END_OF_RING</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring_current_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_RECEIVE_LIST_BASE_ADDRESS</span><span class="p">,</span>
		 <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Transmit ring</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SBE_2T3E3_TX_DESC_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdes0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdes1</span> <span class="o">=</span> <span class="n">SBE_2T3E3_TX_DESC_SECOND_ADDRESS_CHAINED</span> <span class="o">|</span>
			<span class="n">SBE_2T3E3_TX_DESC_DISABLE_PADDING</span><span class="p">;</span>

		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdes2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdes3</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SBE_2T3E3_TX_DESC_RING_SIZE</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">SBE_2T3E3_TX_DESC_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">tdes1</span> <span class="o">|=</span>
		<span class="n">SBE_2T3E3_TX_DESC_END_OF_RING</span><span class="p">;</span>

	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_TRANSMIT_LIST_BASE_ADDRESS</span><span class="p">,</span>
		 <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring_current_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring_current_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_free_cnt</span> <span class="o">=</span> <span class="n">SBE_2T3E3_TX_DESC_RING_SIZE</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dc_clear_descriptor_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* clear CSR3 and CSR4 */</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_RECEIVE_LIST_BASE_ADDRESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_TRANSMIT_LIST_BASE_ADDRESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* free all data buffers on TX ring */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SBE_2T3E3_TX_DESC_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dc_drop_descriptor_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dc_clear_descriptor_list</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="cm">/* free all data buffers on RX ring */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SBE_2T3E3_RX_DESC_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ether</span><span class="p">.</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">dc_set_output_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dc_clear_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span>
		      <span class="n">SBE_2T3E3_21143_VAL_PORT_SELECT</span><span class="p">);</span>

	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_SIA_STATUS</span><span class="p">,</span> <span class="mh">0x00000301</span><span class="p">);</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_SIA_CONNECTIVITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_SIA_TRANSMIT_AND_RECEIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dc_write</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_SIA_AND_GENERAL_PURPOSE_PORT</span><span class="p">,</span> <span class="mh">0x08000011</span><span class="p">);</span>

	<span class="n">dc_set_bits</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">SBE_2T3E3_21143_REG_OPERATION_MODE</span><span class="p">,</span>
		   <span class="n">SBE_2T3E3_21143_VAL_TRANSMIT_THRESHOLD_MODE_100Mbs</span> <span class="o">|</span>
		   <span class="n">SBE_2T3E3_21143_VAL_HEARTBEAT_DISABLE</span> <span class="o">|</span>
		   <span class="n">SBE_2T3E3_21143_VAL_PORT_SELECT</span> <span class="o">|</span>
		   <span class="n">SBE_2T3E3_21143_VAL_FULL_DUPLEX_MODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dc_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBE 2T3E3: 21143 restart</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dc_stop</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">dc_reset</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">dc_init</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>	<span class="cm">/* stop + reset + init */</span>
	<span class="n">dc_start</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
