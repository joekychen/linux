<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › sbe-2t3e3 › cpld.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cpld.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SBE 2T3E3 synchronous serial card driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009-2010 Krzysztof Halasa &lt;khc@pm.waw.pl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This code is based on a driver written by SBE Inc.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;2t3e3.h&quot;</span>
<span class="cp">#include &quot;ctrl.h&quot;</span>

<span class="cp">#define bootrom_set_bit(sc, reg, bit)				\</span>
<span class="cp">	bootrom_write((sc), (reg),				\</span>
<span class="cp">		      bootrom_read((sc), (reg)) | (bit))</span>

<span class="cp">#define bootrom_clear_bit(sc, reg, bit)				\</span>
<span class="cp">	bootrom_write((sc), (reg),				\</span>
<span class="cp">		      bootrom_read((sc), (reg)) &amp; ~(bit))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpld_set_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bootrom_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bootrom_set_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">CPLD_MAP_REG</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">channel</span><span class="p">),</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bootrom_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpld_clear_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bootrom_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bootrom_clear_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">CPLD_MAP_REG</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">channel</span><span class="p">),</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bootrom_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cpld_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* reset LIU and Framer */</span>
<span class="c">	val = cpld_val_map[SBE_2T3E3_CPLD_VAL_LIU_FRAMER_RESET][sc-&gt;h.slot];</span>
<span class="c">	cpld_write(sc, SBE_2T3E3_CPLD_REG_STATIC_RESET, val);</span>
<span class="c">	udelay(10000); /* TODO - how long? */</span>
<span class="c">	val = 0;</span>
<span class="c">	cpld_write(sc, SBE_2T3E3_CPLD_REG_STATIC_RESET, val);</span>
<span class="cp">#endif</span>

	<span class="cm">/* PCRA */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_CPLD_VAL_CRC32</span> <span class="o">|</span>
		<span class="n">cpld_val_map</span><span class="p">[</span><span class="n">SBE_2T3E3_CPLD_VAL_LOOP_TIMING_SOURCE</span><span class="p">][</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">slot</span><span class="p">];</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* PCRB */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* PCRC */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRC</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* PBWF */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PBWF</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* PBWL */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PBWL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* PLTR */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_CPLD_VAL_LCV_COUNTER</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PLTR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* PLCR */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PLCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* PPFR */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PPFR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="cm">/* TODO: this doesn&#39;t work!!! */</span>

	<span class="cm">/* SERIAL_CHIP_SELECT */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_SERIAL_CHIP_SELECT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* PICSR */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_CPLD_VAL_DMO_SIGNAL_DETECTED</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_CPLD_VAL_RECEIVE_LOSS_OF_LOCK_DETECTED</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_CPLD_VAL_RECEIVE_LOSS_OF_SIGNAL_DETECTED</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PICSR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">cpld_start_intr</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cpld_start_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* PIER */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_CPLD_VAL_INTERRUPT_FROM_ETHERNET_ENABLE</span> <span class="o">|</span>
		<span class="n">SBE_2T3E3_CPLD_VAL_INTERRUPT_FROM_FRAMER_ENABLE</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PIER</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	  do you want to hang up your computer?</span>
<span class="c">	  ENABLE REST OF INTERRUPTS !!!</span>
<span class="c">	  you have been warned :).</span>
<span class="c">	*/</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cpld_stop_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* PIER */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PIER</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cpld_set_frame_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">frame_mode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_MODE_HDLC</span>:
		<span class="n">cpld_clear_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			       <span class="n">SBE_2T3E3_CPLD_VAL_TRANSPARENT_MODE</span> <span class="o">|</span>
			       <span class="n">SBE_2T3E3_CPLD_VAL_RAW_MODE</span><span class="p">);</span>
		<span class="n">exar7250_unipolar_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_OFF</span><span class="p">);</span>
		<span class="n">exar7300_unipolar_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_MODE_TRANSPARENT</span>:
		<span class="n">cpld_clear_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			       <span class="n">SBE_2T3E3_CPLD_VAL_RAW_MODE</span><span class="p">);</span>
		<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			     <span class="n">SBE_2T3E3_CPLD_VAL_TRANSPARENT_MODE</span><span class="p">);</span>
		<span class="n">exar7250_unipolar_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_OFF</span><span class="p">);</span>
		<span class="n">exar7300_unipolar_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_MODE_RAW</span>:
		<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			     <span class="n">SBE_2T3E3_CPLD_VAL_RAW_MODE</span><span class="p">);</span>
		<span class="n">exar7250_unipolar_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_ON</span><span class="p">);</span>
		<span class="n">exar7300_unipolar_onoff</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">frame_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set rate of the local clock */</span>
<span class="kt">void</span> <span class="nf">cpld_set_frame_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_TYPE_E3_G751</span>:
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_TYPE_E3_G832</span>:
		<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			     <span class="n">SBE_2T3E3_CPLD_VAL_LOCAL_CLOCK_E3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_TYPE_T3_CBIT</span>:
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRAME_TYPE_T3_M13</span>:
		<span class="n">cpld_clear_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			       <span class="n">SBE_2T3E3_CPLD_VAL_LOCAL_CLOCK_E3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cpld_set_scrambler</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">scrambler</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_SCRAMBLER_OFF</span>:
		<span class="n">cpld_clear_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRB</span><span class="p">,</span>
			       <span class="n">SBE_2T3E3_CPLD_VAL_SCRAMBLER_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_SCRAMBLER_LARSCOM</span>:
		<span class="n">cpld_clear_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRB</span><span class="p">,</span>
			       <span class="n">SBE_2T3E3_CPLD_VAL_SCRAMBLER_TYPE</span><span class="p">);</span>
		<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRB</span><span class="p">,</span>
			     <span class="n">SBE_2T3E3_CPLD_VAL_SCRAMBLER_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_SCRAMBLER_ADC_KENTROX_DIGITAL</span>:
		<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRB</span><span class="p">,</span>
			     <span class="n">SBE_2T3E3_CPLD_VAL_SCRAMBLER_TYPE</span><span class="p">);</span>
		<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRB</span><span class="p">,</span>
			     <span class="n">SBE_2T3E3_CPLD_VAL_SCRAMBLER_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">scrambler</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">cpld_set_crc</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">crc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">crc</span> <span class="o">==</span> <span class="n">crc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_CRC_16</span>:
		<span class="n">cpld_clear_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			       <span class="n">SBE_2T3E3_CPLD_VAL_CRC32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_CRC_32</span>:
		<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			     <span class="n">SBE_2T3E3_CPLD_VAL_CRC32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">crc</span> <span class="o">=</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">cpld_select_panel</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">panel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">panel</span> <span class="o">==</span> <span class="n">panel</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">panel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_PANEL_FRONT</span>:
		<span class="n">cpld_clear_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			       <span class="n">SBE_2T3E3_CPLD_VAL_REAR_PANEL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_PANEL_REAR</span>:
		<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			     <span class="n">SBE_2T3E3_CPLD_VAL_REAR_PANEL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">panel</span> <span class="o">=</span> <span class="n">panel</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">extern</span> <span class="kt">void</span> <span class="nf">cpld_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">clock_source</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_TIMING_LOCAL</span>:
		<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			     <span class="n">SBE_2T3E3_CPLD_VAL_ALT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_TIMING_LOOP</span>:
		<span class="n">cpld_clear_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRA</span><span class="p">,</span>
			       <span class="n">SBE_2T3E3_CPLD_VAL_ALT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">clock_source</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cpld_set_pad_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pad_count</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_PAD_COUNT_1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_CPLD_VAL_PAD_COUNT_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_PAD_COUNT_2</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_CPLD_VAL_PAD_COUNT_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_PAD_COUNT_3</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_CPLD_VAL_PAD_COUNT_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_PAD_COUNT_4</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">SBE_2T3E3_CPLD_VAL_PAD_COUNT_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpld_clear_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRB</span><span class="p">,</span>
		       <span class="n">SBE_2T3E3_CPLD_VAL_PAD_COUNT</span><span class="p">);</span>
	<span class="n">cpld_set_bit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pad_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cpld_LOS_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int8_t</span> <span class="n">los</span><span class="p">;</span>

	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PICSR</span><span class="p">,</span>
		   <span class="n">SBE_2T3E3_CPLD_VAL_DMO_SIGNAL_DETECTED</span> <span class="o">|</span>
		   <span class="n">SBE_2T3E3_CPLD_VAL_RECEIVE_LOSS_OF_LOCK_DETECTED</span> <span class="o">|</span>
		   <span class="n">SBE_2T3E3_CPLD_VAL_RECEIVE_LOSS_OF_SIGNAL_DETECTED</span><span class="p">);</span>
	<span class="n">los</span> <span class="o">=</span> <span class="n">cpld_read</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PICSR</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">SBE_2T3E3_CPLD_VAL_RECEIVE_LOSS_OF_SIGNAL_DETECTED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">los</span> <span class="o">!=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">LOS</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBE 2T3E3: LOS status: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">los</span> <span class="o">?</span> <span class="s">&quot;Loss of signal&quot;</span> <span class="o">:</span> <span class="s">&quot;Signal OK&quot;</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">LOS</span> <span class="o">=</span> <span class="n">los</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cpld_set_fractional_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SBE_2T3E3_FRACTIONAL_MODE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">fractional_mode</span> <span class="o">==</span> <span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">bandwidth_start</span> <span class="o">==</span> <span class="n">start</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">bandwidth_stop</span> <span class="o">==</span> <span class="n">stop</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRACTIONAL_MODE_NONE</span>:
		<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRC</span><span class="p">,</span>
			   <span class="n">SBE_2T3E3_CPLD_VAL_FRACTIONAL_MODE_NONE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRACTIONAL_MODE_0</span>:
		<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRC</span><span class="p">,</span>
			   <span class="n">SBE_2T3E3_CPLD_VAL_FRACTIONAL_MODE_0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRACTIONAL_MODE_1</span>:
		<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRC</span><span class="p">,</span>
			   <span class="n">SBE_2T3E3_CPLD_VAL_FRACTIONAL_MODE_1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SBE_2T3E3_FRACTIONAL_MODE_2</span>:
		<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PCRC</span><span class="p">,</span>
			   <span class="n">SBE_2T3E3_CPLD_VAL_FRACTIONAL_MODE_2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;wrong mode in set_fractional_mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PBWF</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">cpld_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">SBE_2T3E3_CPLD_REG_PBWL</span><span class="p">,</span> <span class="n">stop</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">fractional_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">bandwidth_start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">bandwidth_stop</span> <span class="o">=</span> <span class="n">stop</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
