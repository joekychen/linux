<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › nvec › nvec.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>nvec.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * NVEC: NVIDIA compliant embedded controller interface</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 The AC100 Kernel Team &lt;ac100@lists.lauchpad.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:  Pierre-Hugues Husson &lt;phhusson@free.fr&gt;</span>
<span class="cm"> *           Ilya Petrov &lt;ilya.muromec@gmail.com&gt;</span>
<span class="cm"> *           Marc Dietrich &lt;marvin24@gmx.de&gt;</span>
<span class="cm"> *           Julian Andres Klode &lt;jak@jak-linux.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* #define DEBUG */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/core.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &lt;mach/clk.h&gt;</span>
<span class="cp">#include &lt;mach/iomap.h&gt;</span>

<span class="cp">#include &quot;nvec.h&quot;</span>

<span class="cp">#define I2C_CNFG			0x00</span>
<span class="cp">#define I2C_CNFG_PACKET_MODE_EN		(1&lt;&lt;10)</span>
<span class="cp">#define I2C_CNFG_NEW_MASTER_SFM		(1&lt;&lt;11)</span>
<span class="cp">#define I2C_CNFG_DEBOUNCE_CNT_SHIFT	12</span>

<span class="cp">#define I2C_SL_CNFG		0x20</span>
<span class="cp">#define I2C_SL_NEWSL		(1&lt;&lt;2)</span>
<span class="cp">#define I2C_SL_NACK		(1&lt;&lt;1)</span>
<span class="cp">#define I2C_SL_RESP		(1&lt;&lt;0)</span>
<span class="cp">#define I2C_SL_IRQ		(1&lt;&lt;3)</span>
<span class="cp">#define END_TRANS		(1&lt;&lt;4)</span>
<span class="cp">#define RCVD			(1&lt;&lt;2)</span>
<span class="cp">#define RNW			(1&lt;&lt;1)</span>

<span class="cp">#define I2C_SL_RCVD		0x24</span>
<span class="cp">#define I2C_SL_STATUS		0x28</span>
<span class="cp">#define I2C_SL_ADDR1		0x2c</span>
<span class="cp">#define I2C_SL_ADDR2		0x30</span>
<span class="cp">#define I2C_SL_DELAY_COUNT	0x3c</span>

<span class="cm">/**</span>
<span class="cm"> * enum nvec_msg_category - Message categories for nvec_msg_alloc()</span>
<span class="cm"> * @NVEC_MSG_RX: The message is an incoming message (from EC)</span>
<span class="cm"> * @NVEC_MSG_TX: The message is an outgoing message (to EC)</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">nvec_msg_category</span>  <span class="p">{</span>
	<span class="n">NVEC_MSG_RX</span><span class="p">,</span>
	<span class="n">NVEC_MSG_TX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">EC_DISABLE_EVENT_REPORTING</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x04\x00\x00</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">EC_ENABLE_EVENT_REPORTING</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x04\x00\x01</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">EC_GET_FIRMWARE_VERSION</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x07\x15</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec_power_handle</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">nvec_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nvec-kbd&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nvec-mouse&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nvec-power&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nvec-power&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nvec-leds&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_register_notifier - Register a notifier with nvec</span>
<span class="cm"> * @nvec: A &amp;struct nvec_chip</span>
<span class="cm"> * @nb: The notifier block to register</span>
<span class="cm"> *</span>
<span class="cm"> * Registers a notifier with @nvec. The notifier will be added to an atomic</span>
<span class="cm"> * notifier chain that is called for all received messages except those that</span>
<span class="cm"> * correspond to a request initiated by nvec_write_sync().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nvec_register_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">notifier_list</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nvec_register_notifier</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_status_notifier - The final notifier</span>
<span class="cm"> *</span>
<span class="cm"> * Prints a message about control events not handled in the notifier</span>
<span class="cm"> * chain.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvec_status_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_type</span> <span class="o">!=</span> <span class="n">NVEC_CNTL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;unhandled msg type %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event_type</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;payload: &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_msg_alloc:</span>
<span class="cm"> * @nvec: A &amp;struct nvec_chip</span>
<span class="cm"> * @category: Pool category, see &amp;enum nvec_msg_category</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate a single &amp;struct nvec_msg object from the message pool of</span>
<span class="cm"> * @nvec. The result shall be passed to nvec_msg_free() if no longer</span>
<span class="cm"> * used.</span>
<span class="cm"> *</span>
<span class="cm"> * Outgoing messages are placed in the upper 75% of the pool, keeping the</span>
<span class="cm"> * lower 25% available for RX buffers only. The reason is to prevent a</span>
<span class="cm"> * situation where all buffers are full and a message is thus endlessly</span>
<span class="cm"> * retried because the response could never be processed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="nf">nvec_msg_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">nvec_msg_category</span> <span class="n">category</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">category</span> <span class="o">==</span> <span class="n">NVEC_MSG_TX</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">NVEC_POOL_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NVEC_POOL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">msg_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">used</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;INFO: Allocate %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">msg_pool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate %s buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">category</span> <span class="o">==</span> <span class="n">NVEC_MSG_TX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;TX&quot;</span> <span class="o">:</span> <span class="s">&quot;RX&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_msg_free:</span>
<span class="cm"> * @nvec: A &amp;struct nvec_chip</span>
<span class="cm"> * @msg:  A message (must be allocated by nvec_msg_alloc() and belong to @nvec)</span>
<span class="cm"> *</span>
<span class="cm"> * Free the given message</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nvec_msg_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_scratch</span><span class="p">)</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;INFO: Free %ti</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span> <span class="o">-</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">msg_pool</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nvec_msg_free</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_msg_is_event - Return %true if @msg is an event</span>
<span class="cm"> * @msg: A message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">nvec_msg_is_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_msg_size - Get the size of a message</span>
<span class="cm"> * @msg: The message to get the size for</span>
<span class="cm"> *</span>
<span class="cm"> * This only works for received messages, not for outgoing messages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">nvec_msg_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_event</span> <span class="o">=</span> <span class="n">nvec_msg_is_event</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">event_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* for variable size, payload size in byte 1 + count (1) + cmd (1) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_event</span> <span class="o">||</span> <span class="n">event_length</span> <span class="o">==</span> <span class="n">NVEC_VAR_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">||</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event_length</span> <span class="o">==</span> <span class="n">NVEC_2BYTES</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event_length</span> <span class="o">==</span> <span class="n">NVEC_3BYTES</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_gpio_set_value - Set the GPIO value</span>
<span class="cm"> * @nvec: A &amp;struct nvec_chip</span>
<span class="cm"> * @value: The value to write (0 or 1)</span>
<span class="cm"> *</span>
<span class="cm"> * Like gpio_set_value(), but generating debugging information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvec_gpio_set_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPIO changed from %u to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">gpio_get_value</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_write_async - Asynchronously write a message to NVEC</span>
<span class="cm"> * @nvec: An nvec_chip instance</span>
<span class="cm"> * @data: The message data, starting with the request type</span>
<span class="cm"> * @size: The size of @data</span>
<span class="cm"> *</span>
<span class="cm"> * Queue a single message to be transferred to the embedded controller</span>
<span class="cm"> * and return immediately.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, a negative error code on failure. If a failure</span>
<span class="cm"> * occured, the nvec driver may print an error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nvec_write_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="kt">short</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nvec_msg_alloc</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">NVEC_MSG_TX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nvec_write_async</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_write_sync - Write a message to nvec and read the response</span>
<span class="cm"> * @nvec: An &amp;struct nvec_chip</span>
<span class="cm"> * @data: The data to write</span>
<span class="cm"> * @size: The size of @data</span>
<span class="cm"> *</span>
<span class="cm"> * This is similar to nvec_write_async(), but waits for the</span>
<span class="cm"> * request to be answered before returning. This function</span>
<span class="cm"> * uses a mutex and can thus not be called from e.g.</span>
<span class="cm"> * interrupt handlers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: A pointer to the response message on success,</span>
<span class="cm"> * %NULL on failure. Free with nvec_msg_free() once no longer</span>
<span class="cm"> * used.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="nf">nvec_write_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">short</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write_mutex</span><span class="p">);</span>

	<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write_pending</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nvec_write_async</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nvec_sync_write: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write_pending</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for sync write to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nvec_sync_write: pong!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">last_sync_msg</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nvec_write_sync</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_request_master - Process outgoing messages</span>
<span class="cm"> * @work: A &amp;struct work_struct (the tx_worker member of &amp;struct nvec_chip)</span>
<span class="cm"> *</span>
<span class="cm"> * Processes all outgoing requests by sending the request and awaiting the</span>
<span class="cm"> * response, then continuing with the next request. Once a request has a</span>
<span class="cm"> * matching response, it will be freed and removed from the list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvec_request_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nvec_chip</span><span class="p">,</span> <span class="n">tx_work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nvec_msg</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nvec_gpio_set_value</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">ec_transfer</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5000</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for ec transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">nvec_gpio_set_value</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">msg</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
			<span class="n">nvec_msg_free</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * parse_msg - Print some information and call the notifiers on an RX message</span>
<span class="cm"> * @nvec: A &amp;struct nvec_chip</span>
<span class="cm"> * @msg: A message received by @nvec</span>
<span class="cm"> *</span>
<span class="cm"> * Paarse some pieces of the message and then call the chain of notifiers</span>
<span class="cm"> * registered via nvec_register_notifier.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ec responded %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;ec system event &quot;</span><span class="p">,</span>
				<span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">notifier_list</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8f</span><span class="p">,</span>
				   <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_dispatch - Process messages received from the EC</span>
<span class="cm"> * @work: A &amp;struct work_struct (the tx_worker member of &amp;struct nvec_chip)</span>
<span class="cm"> *</span>
<span class="cm"> * Process messages previously received from the EC and put into the RX</span>
<span class="cm"> * queue of the &amp;struct nvec_chip instance associated with @work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvec_dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nvec_chip</span><span class="p">,</span> <span class="n">rx_work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nvec_msg</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write_pending</span> <span class="o">==</span>
		      <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sync write completed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">last_sync_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">parse_msg</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
			<span class="n">nvec_msg_free</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_tx_completed - Complete the current transfer</span>
<span class="cm"> * @nvec: A &amp;struct nvec_chip</span>
<span class="cm"> *</span>
<span class="cm"> * This is called when we have received an END_TRANS on a TX transfer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvec_tx_completed</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We got an END_TRANS, let&#39;s skip this, maybe there&#39;s an event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;premature END_TRANS, resending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nvec_gpio_set_value</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_rx_completed - Complete the current transfer</span>
<span class="cm"> * @nvec: A &amp;struct nvec_chip</span>
<span class="cm"> *</span>
<span class="cm"> * This is called when we have received an END_TRANS on a RX transfer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvec_rx_completed</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">nvec_msg_size</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX incomplete: Expected %u bytes, got %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">nvec_msg_size</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">),</span>
			   <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>

		<span class="n">nvec_msg_free</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Battery quirk - Often incomplete, and likes to crash */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">NVEC_BAT</span><span class="p">)</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">ec_transfer</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="cm">/* add the received data to the work list</span>
<span class="cm">	   and move the ring buffer pointer to the next entry */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nvec_msg_is_event</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">))</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">ec_transfer</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_invalid_flags - Send an error message about invalid flags and jump</span>
<span class="cm"> * @nvec: The nvec device</span>
<span class="cm"> * @status: The status flags</span>
<span class="cm"> * @reset: Whether we shall jump to state 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvec_invalid_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unexpected status flags 0x%02x during state %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">status</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_tx_set - Set the message to transfer (nvec-&gt;tx)</span>
<span class="cm"> * @nvec: A &amp;struct nvec_chip</span>
<span class="cm"> *</span>
<span class="cm"> * Gets the first entry from the tx_data list of @nvec and sets the</span>
<span class="cm"> * tx member to it. If the tx_data list is empty, this uses the</span>
<span class="cm"> * tx_scratch message to send a no operation message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvec_tx_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;empty tx - sending no-op</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_scratch</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x07\x02</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_scratch</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_scratch</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_scratch</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nvec_msg</span><span class="p">,</span>
					    <span class="n">node</span><span class="p">);</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Sending message of length %u, command 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nvec_interrupt - Interrupt handler</span>
<span class="cm"> * @irq: The IRQ</span>
<span class="cm"> * @dev: The nvec device</span>
<span class="cm"> *</span>
<span class="cm"> * Interrupt handler that fills our RX buffers and empties our TX</span>
<span class="cm"> * buffers. This uses a finite state machine with ridiculous amounts</span>
<span class="cm"> * of error checking, in order to be fairly reliable.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nvec_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">to_send</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_mask</span> <span class="o">=</span> <span class="n">I2C_SL_IRQ</span> <span class="o">|</span> <span class="n">END_TRANS</span> <span class="o">|</span> <span class="n">RCVD</span> <span class="o">|</span> <span class="n">RNW</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_SL_STATUS</span><span class="p">);</span>

	<span class="cm">/* Filter out some errors */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">irq_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">irq_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unexpected irq mask %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">I2C_SL_IRQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Spurious IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The EC did not request a read, so it send us something, read it */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RNW</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">received</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_SL_RCVD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RCVD</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_SL_RCVD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">I2C_SL_IRQ</span> <span class="o">|</span> <span class="n">RCVD</span><span class="p">))</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* Verify that its a transfer start, the rest later */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="p">(</span><span class="n">I2C_SL_IRQ</span> <span class="o">|</span> <span class="n">RCVD</span><span class="p">))</span>
			<span class="n">nvec_invalid_flags</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* command byte */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">I2C_SL_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nvec_invalid_flags</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">nvec_msg_alloc</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">NVEC_MSG_RX</span><span class="p">);</span>
			<span class="cm">/* Should not happen in a normal world */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">received</span><span class="p">;</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* first byte after command */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">I2C_SL_IRQ</span> <span class="o">|</span> <span class="n">RNW</span> <span class="o">|</span> <span class="n">RCVD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">33</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Read without prior read command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nvec_msg_free</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">nvec_tx_set</span><span class="p">(</span><span class="n">nvec</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">to_send</span> <span class="o">=</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">I2C_SL_IRQ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">received</span><span class="p">;</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nvec_invalid_flags</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:		<span class="cm">/* EC does a block read, we transmit data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">END_TRANS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nvec_tx_completed</span><span class="p">(</span><span class="n">nvec</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RNW</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RCVD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nvec_invalid_flags</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">&amp;&amp;</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">to_send</span> <span class="o">=</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">pos</span><span class="o">++</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx buffer underflow on %p (%u &gt; %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">,</span>
				<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">?</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
				<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">?</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:		<span class="cm">/* EC does some write, we read the data */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">END_TRANS</span> <span class="o">|</span> <span class="n">RNW</span><span class="p">))</span> <span class="o">==</span> <span class="n">END_TRANS</span><span class="p">)</span>
			<span class="n">nvec_rx_completed</span><span class="p">(</span><span class="n">nvec</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RNW</span> <span class="o">|</span> <span class="n">RCVD</span><span class="p">))</span>
			<span class="n">nvec_invalid_flags</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">&amp;&amp;</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">NVEC_MSG_SIZE</span><span class="p">)</span>
			<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">received</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;RX buffer overflow on %p: &quot;</span>
				<span class="s">&quot;Trying to write byte %u of %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">NVEC_MSG_SIZE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we are told that a new transfer starts, verify it */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RCVD</span> <span class="o">|</span> <span class="n">RNW</span><span class="p">))</span> <span class="o">==</span> <span class="n">RCVD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">received</span> <span class="o">!=</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;received address 0x%02x, expected 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">received</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">);</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send data if requested, but not on end of transmission */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RNW</span> <span class="o">|</span> <span class="n">END_TRANS</span><span class="p">))</span> <span class="o">==</span> <span class="n">RNW</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">to_send</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_SL_RCVD</span><span class="p">);</span>

	<span class="cm">/* If we have send the first byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">I2C_SL_IRQ</span> <span class="o">|</span> <span class="n">RNW</span> <span class="o">|</span> <span class="n">RCVD</span><span class="p">))</span>
		<span class="n">nvec_gpio_set_value</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Handled: %s 0x%02x, %s 0x%02x in state %u [%s%s%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RNW</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;received&quot;</span> <span class="o">:</span> <span class="s">&quot;R=&quot;</span><span class="p">,</span>
		<span class="n">received</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RNW</span> <span class="o">|</span> <span class="n">END_TRANS</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;sent&quot;</span> <span class="o">:</span> <span class="s">&quot;S=&quot;</span><span class="p">,</span>
		<span class="n">to_send</span><span class="p">,</span>
		<span class="n">state</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">END_TRANS</span> <span class="o">?</span> <span class="s">&quot; END_TRANS&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">RCVD</span> <span class="o">?</span> <span class="s">&quot; RCVD&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">RNW</span> <span class="o">?</span> <span class="s">&quot; RNW&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * TODO: A correct fix needs to be found for this.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We experience less incomplete messages with this delay than without</span>
<span class="cm">	 * it, but we don&#39;t know why. Help is appreciated.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tegra_init_i2c_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_clk</span><span class="p">);</span>

	<span class="n">tegra_periph_reset_assert</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_clk</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">tegra_periph_reset_deassert</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_clk</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">I2C_CNFG_NEW_MASTER_SFM</span> <span class="o">|</span> <span class="n">I2C_CNFG_PACKET_MODE_EN</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">I2C_CNFG_DEBOUNCE_CNT_SHIFT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_CNFG</span><span class="p">);</span>

	<span class="n">clk_set_rate</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_clk</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">80000</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">I2C_SL_NEWSL</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_SL_CNFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x1E</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_SL_DELAY_COUNT</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_SL_ADDR1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_SL_ADDR2</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvec_disable_i2c_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">I2C_SL_NEWSL</span> <span class="o">|</span> <span class="n">I2C_SL_NACK</span><span class="p">,</span> <span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">I2C_SL_CNFG</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvec_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nvec_write_async</span><span class="p">(</span><span class="n">nvec_power_handle</span><span class="p">,</span> <span class="n">EC_DISABLE_EVENT_REPORTING</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">nvec_write_async</span><span class="p">(</span><span class="n">nvec_power_handle</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x04\x01</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tegra_nvec_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">i2c_clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvec_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">iomem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">nvec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvec_chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to reserve memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>
	<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">of_get_named_gpio</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;request-gpios&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no gpio specified&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;slave-addr&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no i2c address specified&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no mem resource?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iomem</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iomem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;I2C region already claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">iomem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">iomem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t ioremap I2C region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no irq resource?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_clk</span> <span class="o">=</span> <span class="n">clk_get_sys</span><span class="p">(</span><span class="s">&quot;tegra-i2c.2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">i2c_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get controller clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">i2c_clk</span> <span class="o">=</span> <span class="n">i2c_clk</span><span class="p">;</span>
	<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">msg_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ATOMIC_INIT_NOTIFIER_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">notifier_list</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">ec_transfer</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">sync_write_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">,</span> <span class="n">nvec_dispatch</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">,</span> <span class="n">nvec_request_master</span><span class="p">);</span>
	<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;nvec&quot;</span><span class="p">,</span> <span class="n">WQ_NON_REENTRANT</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">gpio_request_one</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_HIGH</span><span class="p">,</span> <span class="s">&quot;nvec gpio&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t request gpio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">nvec_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;nvec&quot;</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t request irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">tegra_init_i2c_slave</span><span class="p">(</span><span class="n">nvec</span><span class="p">);</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">i2c_clk</span><span class="p">);</span>


	<span class="cm">/* enable event reporting */</span>
	<span class="n">nvec_write_async</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">EC_ENABLE_EVENT_REPORTING</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">EC_ENABLE_EVENT_REPORTING</span><span class="p">));</span>

	<span class="n">nvec</span><span class="o">-&gt;</span><span class="n">nvec_status_notifier</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">nvec_status_notifier</span><span class="p">;</span>
	<span class="n">nvec_register_notifier</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">nvec_status_notifier</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">nvec_power_handle</span> <span class="o">=</span> <span class="n">nvec</span><span class="p">;</span>
	<span class="n">pm_power_off</span> <span class="o">=</span> <span class="n">nvec_power_off</span><span class="p">;</span>

	<span class="cm">/* Get Firmware Version */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">nvec_write_sync</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">EC_GET_FIRMWARE_VERSION</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">EC_GET_FIRMWARE_VERSION</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ec firmware version %02x.%02x.%02x / %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

		<span class="n">nvec_msg_free</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nvec_devices</span><span class="p">,</span>
			      <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nvec_devices</span><span class="p">),</span> <span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error adding subdevices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* unmute speakers? */</span>
	<span class="n">nvec_write_async</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x0d\x10\x59\x95</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* enable lid switch event */</span>
	<span class="n">nvec_write_async</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x01\x01\x00\x00\x02\x00</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="cm">/* enable power button event */</span>
	<span class="n">nvec_write_async</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x01\x01\x00\x00\x80\x00</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="nl">failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nvec</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">tegra_nvec_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">nvec_write_async</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">EC_DISABLE_EVENT_REPORTING</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mfd_remove_devices</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvec_interrupt</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nvec</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tegra_nvec_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nvec_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;suspending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* keep these sync or you&#39;ll break suspend */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">nvec_write_sync</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">EC_DISABLE_EVENT_REPORTING</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">nvec_msg_free</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">nvec_write_sync</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x04\x02</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">nvec_msg_free</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="n">nvec_disable_i2c_slave</span><span class="p">(</span><span class="n">nvec</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tegra_nvec_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvec_chip</span> <span class="o">*</span><span class="n">nvec</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">nvec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resuming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tegra_init_i2c_slave</span><span class="p">(</span><span class="n">nvec</span><span class="p">);</span>
	<span class="n">nvec_write_async</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">EC_ENABLE_EVENT_REPORTING</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define tegra_nvec_suspend NULL</span>
<span class="cp">#define tegra_nvec_resume NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* Match table for of_platform binding */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">nvidia_nvec_of_match</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;nvidia,nvec&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">nvidia_nvec_of_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">nvec_device_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>   <span class="o">=</span> <span class="n">tegra_nvec_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>  <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tegra_nvec_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">tegra_nvec_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>  <span class="o">=</span> <span class="n">tegra_nvec_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>  <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nvec&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">nvidia_nvec_of_match</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tegra_nvec_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvec_device_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tegra_nvec_init</span><span class="p">);</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:nvec&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;NVIDIA compliant embedded controller interface&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Marc Dietrich &lt;marvin24@gmx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
