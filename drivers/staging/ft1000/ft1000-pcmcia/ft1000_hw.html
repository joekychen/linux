<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › ft1000 › ft1000-pcmcia › ft1000_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ft1000_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   FT1000 driver for Flarion Flash OFDM NIC Device</span>

<span class="cm">   Copyright (C) 2002 Flarion Technologies, All rights reserved.</span>
<span class="cm">   Copyright (C) 2006 Patrik Ostrihon, All rights reserved.</span>
<span class="cm">   Copyright (C) 2006 ProWeb Consulting, a.s, All rights reserved.</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">   under the terms of the GNU General Public License as published by the Free</span>
<span class="cm">   Software Foundation; either version 2 of the License, or (at your option) any</span>
<span class="cm">   later version. This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="cm">   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">   more details. You should have received a copy of the GNU General Public</span>
<span class="cm">   License along with this program; if not, write to the</span>
<span class="cm">   Free Software Foundation, Inc., 59 Temple Place -</span>
<span class="cm">   Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm">-----------------------------------------------------------------------------*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/bitops.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/cisreg.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>

<span class="cp">#ifdef FT_DEBUG</span>
<span class="cp">#define DEBUG(n, args...) printk(KERN_DEBUG args);</span>
<span class="cp">#else</span>
<span class="cp">#define DEBUG(n, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;ft1000.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ft1000_hbchk</span><span class="p">(</span><span class="n">u_long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">poll_timer</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ft1000_hbchk</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">cmdbuffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">tempbuffer</span><span class="p">[</span><span class="mi">1600</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">ft1000_card_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">flarion_ft1000_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ft1000_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ft1000_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ft1000_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* new kernel */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span>
    <span class="p">(</span><span class="s">&quot;Support for Flarion Flash OFDM NIC Device. Support for PCMCIA when used with ft1000_cs.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;FT1000&quot;</span><span class="p">);</span>

<span class="cp">#define MAX_RCV_LOOP   100</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><hr />

<p>Function:   ft1000<em>read</em>fifo_len
Description: This function will read the ASIC Uplink FIFO status register
            which will return the number of bytes remaining in the Uplink FIFO.
            Sixteen bytes are subtracted to make sure that the ASIC does not
            reach its threshold.
Input:
    dev    - network device structure
Output:
    value  - number of bytes available in the ASIC Uplink FIFO.</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">ft1000_read_fifo_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_STAT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_UFSR</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><hr />

<p>Function:   ft1000<em>read</em>dpram
Description: This function will read the specific area of dpram
            (Electrabuzz ASIC only)
Input:
    dev    - device structure
    offset - index of dpram
Output:
    value  - value of dpram</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="n">u16</span> <span class="nf">ft1000_read_dpram</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><hr />

<p>Function:   ft1000<em>write</em>dpram
Description: This function will write to a specific area of dpram
            (Electrabuzz ASIC only)
Input:
    dev    - device structure
    offset - index of dpram
    value  - value to write
Output:
    none.</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ft1000_write_dpram</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><hr />

<p>Function:   ft1000<em>read</em>dpram<em>mag</em>16
Description: This function will read the specific area of dpram
            (Magnemite ASIC only)
Input:
    dev    - device structure
    offset - index of dpram
Output:
    value  - value of dpram</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="n">u16</span> <span class="nf">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>check if we want to read upper or lower 32-bit word</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">Index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><hr />

<p>Function:   ft1000<em>write</em>dpram<em>mag</em>16
Description: This function will write to a specific area of dpram
            (Magnemite ASIC only)
Input:
    dev    - device structure
    offset - index of dpram
    value  - value to write
Output:
    none.</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ft1000_write_dpram_mag_16</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><hr />

<p>Function:   ft1000<em>read</em>dpram<em>mag</em>32
Description: This function will read the specific area of dpram
            (Magnemite ASIC only)
Input:
    dev    - device structure
    offset - index of dpram
Output:
    value  - value of dpram</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="n">u32</span> <span class="nf">ft1000_read_dpram_mag_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><hr />

<p>Function:   ft1000<em>write</em>dpram<em>mag</em>32
Description: This function will write to a specific area of dpram
            (Magnemite ASIC only)
Input:
    dev    - device structure
    offset - index of dpram
    value  - value to write
Output:
    none.</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">ft1000_write_dpram_mag_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><hr />

<p>Function:   ft1000<em>enable</em>interrupts
Description: This function will enable interrupts base on the current interrupt mask.
Input:
    dev    - device structure
Output:
    None.</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_enable_interrupts()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_IMASK</span><span class="p">,</span> <span class="n">ISR_DEFAULT_MASK</span><span class="p">);</span>
	<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_IMASK</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
		  <span class="s">&quot;ft1000_hw:ft1000_enable_interrupts:current interrupt enable mask = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">tempword</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><hr />

<p>Function:   ft1000<em>disable</em>interrupts
Description: This function will disable all interrupts.
Input:
    dev    - device structure
Output:
    None.</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ft1000_disable_interrupts()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_IMASK</span><span class="p">,</span> <span class="n">ISR_MASK_ALL</span><span class="p">);</span>
	<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_IMASK</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
		  <span class="s">&quot;ft1000_hw:ft1000_disable_interrupts:current interrupt enable mask = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">tempword</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><hr />

<p>Function:   ft1000<em>reset</em>asic
Description: This function will call the Card Service function to reset the
            ASIC.
Input:
    dev    - device structure
Output:
    none</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_reset_asic</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_reset_asic called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ft1000_reset</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Let's use the register provided by the Magnemite ASIC to reset the
ASIC and DSP.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">MAGNEMITE_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">DSP_RESET_BIT</span> <span class="o">|</span> <span class="n">ASIC_RESET_BIT</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>set watermark to -1 in order to not generate an interrupt</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_WATERMARK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>set watermark to -1 in order to not generate an interrupt</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_WATERMARK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>clear interrupts</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: interrupt status register = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
	<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: interrupt status register = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><hr />

<p>Function:   ft1000<em>reset</em>card
Description: This function will reset the card
Input:
    dev    - device structure
Output:
    status - false (card reset fail)
             true  (card reset successful)</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_reset_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prov_record</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_reset_card called.....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ProgConStat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">squeseqnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ft1000_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>del<em>timer(&amp;poll</em>timer);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Make sure we free any memory reserve for provisioning</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
			  <span class="s">&quot;ft1000_hw:ft1000_reset_card:deleting provisioning record</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">prov_record</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_reset_card:resetting DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">,</span> <span class="n">DSP_RESET_BIT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			  <span class="s">&quot;ft1000_hw:ft1000_reset_card:resetting ASIC and DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">DSP_RESET_BIT</span> <span class="o">|</span> <span class="n">ASIC_RESET_BIT</span><span class="p">));</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Copy DSP session record into info block if this is not a coldstart</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ft1000_card_present</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
					 <span class="n">FT1000_DPRAM_RX_BASE</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DSP_SESS_REC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPSess</span><span class="p">.</span><span class="n">Rec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
					 <span class="n">FT1000_DPRAM_MAG_RX_BASE</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DSP_SESS_REC</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPSess</span><span class="p">.</span><span class="n">MagRec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_reset_card:resetting ASIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>reset ASIC</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ft1000_reset_asic</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_reset_card:downloading dsp image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">MAGNEMITE_ID</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Put dsp in reset and take ASIC out of reset</p></td><td class="code"><div class="highlight"><pre>		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
			  <span class="s">&quot;ft1000_hw:ft1000_reset_card:Put DSP in reset and take ASIC out of reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">,</span> <span class="n">DSP_RESET_BIT</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Setting MAGNEMITE ASIC to big endian mode</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_CTRL</span><span class="p">,</span> <span class="n">HOST_INTF_BE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Download bootloader</p></td><td class="code"><div class="highlight"><pre>		<span class="n">card_bootload</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Take DSP out of reset</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>FLARION<em>DSP</em>ACTIVE;</p></td><td class="code"><div class="highlight"><pre>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_reset_card:Take DSP out of reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Wait for 0xfefe indicating dsp ready before starting download</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DPRAM_FEFE</span><span class="p">,</span>
							 <span class="n">FT1000_MAG_DPRAM_FEFE_INDX</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">==</span> <span class="mh">0xfefe</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;ft1000_hw:ft1000_reset_card:No FEFE detected from DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Take DSP out of reset</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">,</span> <span class="o">~</span><span class="n">DSP_RESET_BIT</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card_download</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;card download unsuccessful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;card download successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Need to initialize the FIFO length counter to zero in order to sync up
with the DSP</p></td><td class="code"><div class="highlight"><pre>		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ft1000_write_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_FIFO_LEN</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_cnt</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Initialize DSP heartbeat area to ho</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_HI_HO</span><span class="p">,</span> <span class="n">ho</span><span class="p">);</span>
		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_HI_HO</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_reset_asic:hi_ho value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tempword</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Initialize DSP heartbeat area to ho</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span> <span class="n">ho_mag</span><span class="p">,</span>
					  <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">);</span>
		<span class="n">tempword</span> <span class="o">=</span>
			<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span>
						 <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_reset_card:hi_ho value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tempword</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ft1000_enable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Schedule heartbeat process to run every 2 seconds */</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>poll<em>timer.expires = jiffies + (2*HZ);
poll</em>timer.data = (u<em>long)dev;
add</em>timer(&amp;poll_timer);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><hr />

<p>Function:   ft1000_chkcard
Description: This function will check if the device is presently available on
            the system.
Input:
    dev    - device structure
Output:
    status - false (device is not present)
             true  (device is present)</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_chkcard</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Mask register is used to check for device presence since it is never
set to zero.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_IMASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			  <span class="s">&quot;ft1000_hw:ft1000_chkcard: IMASK = 0 Card not detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>The system will return the value of 0xffff for the version register
if the device is not present.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_ASIC_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			  <span class="s">&quot;ft1000_hw:ft1000_chkcard: Version = 0xffff Card not detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><hr />

<p>Function:   ft1000_hbchk
Description: This function will perform the heart beat check of the DSP as
            well as the ASIC.
Input:
    dev    - device structure
Output:
    none</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_hbchk</span><span class="p">(</span><span class="n">u_long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Perform dsp heartbeat check</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_HI_HO</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">ft1000_read_dpram_mag_16</span>
				  <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span>
				   <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_hbchk:hi_ho value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tempword</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Let's perform another check if ho is not detected</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">!=</span> <span class="n">ho</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_HI_HO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">tempword</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">!=</span> <span class="n">ho</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				   <span class="s">&quot;ft1000: heartbeat failed - no ho detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER0</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER1</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER2</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER3</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER0</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER0_INDX</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER1</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER1_INDX</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER2</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER2_INDX</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER3</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER3_INDX</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="n">DSP_HB_INFO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ft1000_reset_card</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					   <span class="s">&quot;ft1000: Hardware Failure Detected - PC Card disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">ProgConStat</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Schedule this module to run every 2 seconds */</span>
			<span class="n">poll_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
			<span class="n">poll_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>Let's check doorbell again if fail</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_HB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_HB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				   <span class="s">&quot;ft1000: heartbeat doorbell not clear by firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER0</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER1</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER2</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER3</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER0</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER0_INDX</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER1</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER1_INDX</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER2</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER2_INDX</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER3</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER3_INDX</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="n">DSP_HB_INFO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ft1000_reset_card</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					   <span class="s">&quot;ft1000: Hardware Failure Detected - PC Card disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">ProgConStat</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Schedule this module to run every 2 seconds */</span>
			<span class="n">poll_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
			<span class="n">poll_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>Set dedicated area to hi and ring appropriate doorbell according
to hi/ho heartbeat protocol</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ft1000_write_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_HI_HO</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ft1000_write_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span> <span class="n">hi_mag</span><span class="p">,</span>
						  <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_HI_HO</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">ft1000_read_dpram_mag_16</span>
				  <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span>
				   <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">));</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>Let's write hi again if fail</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">!=</span> <span class="n">hi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ft1000_write_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_HI_HO</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">ft1000_write_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span> <span class="n">hi_mag</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_HI_HO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">tempword</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">));</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">!=</span> <span class="n">hi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				   <span class="s">&quot;ft1000: heartbeat failed - cannot write hi into DPRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER0</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER1</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER2</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER3</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER0</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER0_INDX</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER1</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER1_INDX</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER2</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER2_INDX</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER3</span><span class="p">,</span>
								 <span class="n">FT1000_MAG_DSP_TIMER3_INDX</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="n">DSP_HB_INFO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ft1000_reset_card</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					   <span class="s">&quot;ft1000: Hardware Failure Detected - PC Card disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">ProgConStat</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Schedule this module to run every 2 seconds */</span>
			<span class="n">poll_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
			<span class="n">poll_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">,</span> <span class="n">FT1000_DB_HB</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* Schedule this module to run every 2 seconds */</span>
	<span class="n">poll_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">poll_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><hr />

<p>Function:   ft1000<em>send</em>cmd
Description:
Input:
Output:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_send_cmd</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ptempbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>check for odd byte and increment to 16-bit word align value</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">size</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:ft1000_send_cmd:total length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:ft1000_send_cmd:length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="n">ptempbuffer</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>put message into slow queue area
All messages are in the form total_len + pseudo header + message body</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Make sure SLOWQ doorbell is clear</p></td><td class="code"><div class="highlight"><pre>    <span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
    <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
				 <span class="n">FT1000_DPRAM_TX_BASE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Write total length to dpram</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Write pseudo header and messgae body</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:ft1000_send_cmd:data %d = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				  <span class="o">*</span><span class="n">ptempbuffer</span><span class="p">);</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">ptempbuffer</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
				 <span class="n">FT1000_DPRAM_MAG_TX_BASE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Write total length to dpram</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">,</span> <span class="n">htons</span><span class="p">(</span><span class="n">size</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>Write pseudo header and messgae body</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
				 <span class="n">FT1000_DPRAM_MAG_TX_BASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:ft1000_send_cmd:data = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="o">*</span><span class="n">ptempbuffer</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="o">*</span><span class="n">ptempbuffer</span><span class="o">++</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:ft1000_send_cmd:data = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="o">*</span><span class="n">ptempbuffer</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="o">*</span><span class="n">ptempbuffer</span><span class="o">++</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:ft1000_send_cmd:data = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptempbuffer</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="o">*</span><span class="n">ptempbuffer</span><span class="o">++</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:ft1000_send_cmd:data = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptempbuffer</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="o">*</span><span class="n">ptempbuffer</span><span class="o">++</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>ring doorbell to notify DSP that we have a message ready</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">,</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><hr />

<p>Function:   ft1000<em>receive</em>cmd
Description: This function will read a message from the dpram area.
Input:
   dev - network device structure
   pbuffer - caller supply address to buffer
   pnxtph - pointer to next pseudo header
Output:
  Status = 0 (unsuccessful)
         = 1 (successful)</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">bool</span> <span class="nf">ft1000_receive_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">maxsz</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pnxtph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">ppseudohdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span> <span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">pnxtph</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span>
			<span class="n">ntohs</span><span class="p">(</span><span class="n">ft1000_read_dpram_mag_16</span>
			  <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_PH_LEN</span><span class="p">,</span>
			   <span class="n">FT1000_MAG_PH_LEN_INDX</span><span class="p">))</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">maxsz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			  <span class="s">&quot;FT1000:ft1000_receive_cmd:Invalid command length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ppseudohdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pbuffer</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
					 <span class="n">FT1000_DPRAM_RX_BASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tempword</span> <span class="o">=</span>
					<span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">);</span>
				<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tempword</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
					 <span class="n">FT1000_DPRAM_MAG_RX_BASE</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:received data = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">);</span>
			<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
					 <span class="n">FT1000_DPRAM_MAG_RX_BASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span>
					<span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
					<span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
				<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span>
					<span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
					<span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">);</span>
				<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>copy odd aligned word</p></td><td class="code"><div class="highlight"><pre>			<span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:received data = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">);</span>
			<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:received data = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">);</span>
			<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>copy odd byte from fifo</p></td><td class="code"><div class="highlight"><pre>			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tempword</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Check if pseudo header checksum is good
Calculate pseudo header checksum</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tempword</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppseudohdr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">^=</span> <span class="o">*</span><span class="n">ppseudohdr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tempword</span> <span class="o">!=</span> <span class="o">*</span><span class="n">ppseudohdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;FT1000:ft1000_receive_cmd:Pseudo header checksum mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Drop this message</p></td><td class="code"><div class="highlight"><pre>			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><hr />

<p>Function:   ft1000<em>proc</em>drvmsg
Description: This function will process the various driver messages.
Input:
    dev    - device structure
    pnxtph - pointer to next pseudo header
Output:
    none</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_proc_drvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">msgtype</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_msg</span> <span class="o">*</span><span class="n">pmediamsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_init_msg</span> <span class="o">*</span><span class="n">pdspinitmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drv_msg</span> <span class="o">*</span><span class="n">pdrvmsg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prov_record</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">ppseudo_hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">pmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">byte</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">u16</span> <span class="n">wrd</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">convert</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tempword</span> <span class="o">=</span> <span class="n">FT1000_DPRAM_RX_BASE</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">tempword</span> <span class="o">=</span> <span class="n">FT1000_DPRAM_MAG_RX_BASE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">ft1000_receive_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MAX_CMD_SQSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>Get the message type which is total_len + PSEUDO header + msgtype + message body</p></td><td class="code"><div class="highlight"><pre>		<span class="n">pdrvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drv_msg</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmdbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">msgtype</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pdrvmsg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Command message type = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msgtype</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msgtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DSP_PROVISION</span>:
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;Got a provisioning request message from DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Sending a provisioning message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>Make sure SLOWQ doorbell is clear</p></td><td class="code"><div class="highlight"><pre>				<span class="n">tempword</span> <span class="o">=</span>
					<span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">ptr</span> <span class="o">=</span>
					<span class="n">list_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">prov_record</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

				<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmsg</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>Insert slow queue sequence number</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">squeseqnum</span><span class="o">++</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Calculate new checksum</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;checksum = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">^=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
					<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;checksum = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">ft1000_send_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">SLOWQ_TYPE</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Indicate adapter is ready to take application messages after all
provisioning messages are sent</p></td><td class="code"><div class="highlight"><pre>			<span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEDIA_STATE</span>:
			<span class="n">pmediamsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">media_msg</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmdbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ProgConStat</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmediamsg</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Media is up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">ConTm</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Media is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">ConTm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Media is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                    <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConTm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DSP_INIT_MSG</span>:
			<span class="n">pdspinitmsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_init_msg</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmdbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">,</span> <span class="n">DSPVERSZ</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;DSPVER = 0x%2x 0x%2x 0x%2x 0x%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				   <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">HwSerNum</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">HwSerNum</span><span class="p">,</span>
				   <span class="n">HWSERNUMSZ</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">Sku</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">Sku</span><span class="p">,</span> <span class="n">SKUSZ</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">,</span> <span class="n">EUISZ</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">==</span>
				<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_init_msg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ProductMode</span><span class="p">,</span>
					   <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">ProductMode</span><span class="p">,</span> <span class="n">MODESZ</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">RfCalVer</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">RfCalVer</span><span class="p">,</span>
					   <span class="n">CALVERSZ</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">RfCalDate</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">RfCalDate</span><span class="p">,</span>
					   <span class="n">CALDATESZ</span><span class="p">);</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RFCalVer = 0x%2x 0x%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">info</span><span class="o">-&gt;</span><span class="n">RfCalVer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">RfCalVer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">DSP_STORE_INFO</span>:
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:drivermsg:Got DSP_STORE_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pdrvmsg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span> <span class="o">=</span> <span class="n">tempword</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_DSP_SESS_REC</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pdrvmsg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">tempword</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
						  <span class="s">&quot;FT1000:drivermsg:dsp info data = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="o">*</span><span class="n">pmsg</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DSP_GET_INFO</span>:
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:drivermsg:Got DSP_GET_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>copy dsp info block to dsp
allow any outstanding ioctl to finish</p></td><td class="code"><div class="highlight"><pre>			<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="n">tempword</span> <span class="o">=</span>
					<span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Put message into Slow Queue
Form Pseudo header</p></td><td class="code"><div class="highlight"><pre>				<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmsg</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span>
					<span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">destination</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portdest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">sh_str_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">rsvd1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">rsvd2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">qos_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>Insert slow queue sequence number</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">squeseqnum</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Insert application id</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>Calculate new checksum</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">^=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7200</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span><span class="p">);</span>
				<span class="n">ft1000_send_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GET_DRV_ERR_RPT_MSG</span>:
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:drivermsg:Got GET_DRV_ERR_RPT_MSG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>copy driver error message to dsp
allow any outstanding ioctl to finish</p></td><td class="code"><div class="highlight"><pre>			<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="n">tempword</span> <span class="o">=</span>
					<span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>Put message into Slow Queue
Form Pseudo header</p></td><td class="code"><div class="highlight"><pre>				<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tempbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">ppseudo_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmsg</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x0012</span><span class="p">);</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">destination</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portdest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">sh_str_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">rsvd1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">rsvd2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">qos_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>Insert slow queue sequence number</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">squeseqnum</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>Insert application id</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>Calculate new checksum</p></td><td class="code"><div class="highlight"><pre>                <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">^=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
				<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tempbuffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">RSP_DRV_ERR_RPT_MSG</span><span class="p">);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x000e</span><span class="p">);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="n">convert</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">convert</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">convert</span><span class="p">.</span><span class="n">wrd</span><span class="p">;</span>
				<span class="n">convert</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">convert</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">convert</span><span class="p">.</span><span class="n">wrd</span><span class="p">;</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span><span class="p">);</span>

				<span class="n">ft1000_send_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="mh">0x0012</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><hr />

<p>Function:   ft1000<em>parse</em>dpram_msg
Description: This function will parse the message received from the DSP
            via the DPRAM interface.
Input:
    dev    - device structure
Output:
    status - FAILURE
             SUCCESS</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_parse_dpram_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">doorbell</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">portid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">nxtph</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">total_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">doorbell</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Doorbell = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doorbell</span> <span class="o">&amp;</span> <span class="n">FT1000_ASIC_RESET_REQ</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>Copy DSP session record from info block</p></td><td class="code"><div class="highlight"><pre>		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
					 <span class="n">FT1000_DPRAM_RX_BASE</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DSP_SESS_REC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">,</span>
						 <span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPSess</span><span class="p">.</span><span class="n">Rec</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
					 <span class="n">FT1000_DPRAM_MAG_RX_BASE</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DSP_SESS_REC</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPSess</span><span class="p">.</span><span class="n">MagRec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>clear ASIC RESET request</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">,</span>
				 <span class="n">FT1000_ASIC_RESET_REQ</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Got an ASIC RESET Request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">,</span>
				 <span class="n">FT1000_ASIC_RESET_DSP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">MAGNEMITE_ID</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Setting MAGNEMITE ASIC to big endian mode</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_CTRL</span><span class="p">,</span>
					 <span class="n">HOST_INTF_BE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doorbell</span> <span class="o">&amp;</span> <span class="n">FT1000_DSP_ASIC_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
			  <span class="s">&quot;FT1000:ft1000_parse_dpram_msg: Got a dsp ASIC reset message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">,</span>
				 <span class="n">FT1000_DSP_ASIC_RESET</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doorbell</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			  <span class="s">&quot;FT1000:ft1000_parse_dpram_msg: Got a slow queue message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nxtph</span> <span class="o">=</span> <span class="n">FT1000_DPRAM_RX_BASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">total_len</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DPRAM_RX_BASE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">total_len</span> <span class="o">=</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">ft1000_read_dpram_mag_16</span>
				  <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_TOTAL_LEN</span><span class="p">,</span>
				   <span class="n">FT1000_MAG_TOTAL_LEN_INDX</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FT1000:ft1000_parse_dpram_msg:total length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">total_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">total_len</span> <span class="o">&lt;</span> <span class="n">MAX_CMD_SQSIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">total_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">total_len</span> <span class="o">+=</span> <span class="n">nxtph</span><span class="p">;</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>ft1000<em>read</em>reg will return a value that needs to be byteswap
in order to get DSP<em>QID</em>OFFSET.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">portid</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">ft1000_read_dpram</span>
					 <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">DSP_QID_OFFSET</span> <span class="o">+</span> <span class="n">FT1000_DPRAM_RX_BASE</span> <span class="o">+</span>
					  <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">portid</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">ft1000_read_dpram_mag_16</span>
					 <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_PORT_ID</span><span class="p">,</span>
					  <span class="n">FT1000_MAG_PORT_ID_INDX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;DSP_QID = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">portid</span> <span class="o">==</span> <span class="n">DRIVERID</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>We are assumming one driver message from the DSP at a time.</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ft1000_proc_drvmsg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">,</span> <span class="n">FT1000_DB_DPRAM_RX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doorbell</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_COND_RESET</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>Reset ASIC and DSP</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER0</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER1</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER2</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER0</span><span class="p">,</span>
							 <span class="n">FT1000_MAG_DSP_TIMER0_INDX</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER1</span><span class="p">,</span>
							 <span class="n">FT1000_MAG_DSP_TIMER1_INDX</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER2</span><span class="p">,</span>
							 <span class="n">FT1000_MAG_DSP_TIMER2_INDX</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER3</span><span class="p">,</span>
							 <span class="n">FT1000_MAG_DSP_TIMER3_INDX</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="n">DSP_CONDRESET_INFO</span><span class="p">;</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:DSP conditional reset requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ft1000_reset_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">,</span>
				 <span class="n">FT1000_DB_COND_RESET</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>let's clear any unexpected doorbells from DSP</p></td><td class="code"><div class="highlight"><pre>	<span class="n">doorbell</span> <span class="o">=</span>
		<span class="n">doorbell</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">FT1000_DB_DPRAM_RX</span> <span class="o">|</span> <span class="n">FT1000_ASIC_RESET_REQ</span> <span class="o">|</span>
			 <span class="n">FT1000_DB_COND_RESET</span> <span class="o">|</span> <span class="mh">0xff00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doorbell</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Clearing unexpected doorbell = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><hr />

<p>Function:   ft1000<em>flush</em>fifo
Description: This function will flush one packet from the downlink
            FIFO.
Input:
    dev      - device structure
    drv_err  - driver error causing the flush fifo
Output:
    None.</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_flush_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">DrvErrNum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">templong</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000:ft1000_hw:ft1000_flush_fifo called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">PktIntfErr</span> <span class="o">&gt;</span> <span class="n">MAX_PH_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER0</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER1</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER2</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_TIMER3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER0</span><span class="p">,</span>
							 <span class="n">FT1000_MAG_DSP_TIMER0_INDX</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER1</span><span class="p">,</span>
							 <span class="n">FT1000_MAG_DSP_TIMER1_INDX</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER2</span><span class="p">,</span>
							 <span class="n">FT1000_MAG_DSP_TIMER2_INDX</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER3</span><span class="p">,</span>
							 <span class="n">FT1000_MAG_DSP_TIMER3_INDX</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="n">DrvErrNum</span><span class="p">;</span>
		<span class="n">ft1000_reset_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>Flush corrupted pkt from FIFO</p></td><td class="code"><div class="highlight"><pre>		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tempword</span> <span class="o">=</span>
					<span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DFIFO</span><span class="p">);</span>
				<span class="n">tempword</span> <span class="o">=</span>
					<span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DFIFO_STAT</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">templong</span> <span class="o">=</span>
					<span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DFR</span><span class="p">);</span>
				<span class="n">tempword</span> <span class="o">=</span>
					<span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DFSR</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>This should never happen unless the ASIC is broken.
We must reset to recover.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">FT1000_DSP_TIMER0</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">FT1000_DSP_TIMER1</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">FT1000_DSP_TIMER2</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ft1000_read_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">FT1000_DSP_TIMER3</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									 <span class="n">FT1000_MAG_DSP_TIMER0</span><span class="p">,</span>
									 <span class="n">FT1000_MAG_DSP_TIMER0_INDX</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									 <span class="n">FT1000_MAG_DSP_TIMER1</span><span class="p">,</span>
									 <span class="n">FT1000_MAG_DSP_TIMER1_INDX</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									 <span class="n">FT1000_MAG_DSP_TIMER2</span><span class="p">,</span>
									 <span class="n">FT1000_MAG_DSP_TIMER2_INDX</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ft1000_read_dpram_mag_16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									 <span class="n">FT1000_MAG_DSP_TIMER3</span><span class="p">,</span>
									 <span class="n">FT1000_MAG_DSP_TIMER3_INDX</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>Let's check if ASIC reads are still ok by reading the Mask register
which is never zero at this point of the code.</p></td><td class="code"><div class="highlight"><pre>					<span class="n">tempword</span> <span class="o">=</span>
						<span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
						<span class="n">FT1000_REG_SUP_IMASK</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>This indicates that we can not communicate with the ASIC</p></td><td class="code"><div class="highlight"><pre>						<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span>
							<span class="n">FIFO_FLUSH_BADCNT</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>Let's assume that we really flush the FIFO</p></td><td class="code"><div class="highlight"><pre>						<span class="n">info</span><span class="o">-&gt;</span><span class="n">PktIntfErr</span><span class="o">++</span><span class="p">;</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="n">FIFO_FLUSH_MAXLIMIT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_SUP_STAT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flushing FIFO complete = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>Flush last word in FIFO.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DFIFO</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>Update FIFO counter for DSP</p></td><td class="code"><div class="highlight"><pre>			<span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flush Data byte count to dsp = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_cnt</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">ft1000_write_dpram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_FIFO_LEN</span><span class="p">,</span>
					   <span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_cnt</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flushing FIFO complete = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>Flush last word in FIFO</p></td><td class="code"><div class="highlight"><pre>			<span class="n">templong</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DFR</span><span class="p">);</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_SUP_STAT</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;FT1000_REG_SUP_STAT = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DFSR</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;FT1000_REG_MAG_DFSR = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DrvErrNum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">PktIntfErr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><hr />

<p>Function:   ft1000<em>copy</em>up_pkt
Description: This function will pull Flarion packets out of the Downlink
            FIFO and convert it to an ethernet packet.  The ethernet packet will
            then be deliver to the TCP/IP stack.
Input:
    dev    - device structure
Output:
    status - FAILURE
             SUCCESS</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_copy_up_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptemp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptemplong</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">templong</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_copy_up_pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>Read length</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DFIFO</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRL</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tempword</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chksum</span> <span class="o">=</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Number of Bytes in FIFO = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ENET_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;size of ethernet packet invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">MAGNEMITE_ID</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>Read High word to complete 32 bit access</p></td><td class="code"><div class="highlight"><pre>			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRH</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ft1000_flush_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DSP_PKTLEN_INFO</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;No Network buffers available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>Read High word to complete 32 bit access</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">MAGNEMITE_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRH</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ft1000_flush_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>Pseudo header</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DFIFO</span><span class="p">);</span>
			<span class="n">chksum</span> <span class="o">^=</span> <span class="n">tempword</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>read checksum value</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DFIFO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRH</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Pseudo = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">^=</span> <span class="n">tempword</span><span class="p">;</span>

		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRL</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Pseudo = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">^=</span> <span class="n">tempword</span><span class="p">;</span>

		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRH</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Pseudo = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">^=</span> <span class="n">tempword</span><span class="p">;</span>

		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRL</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Pseudo = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">^=</span> <span class="n">tempword</span><span class="p">;</span>

		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRH</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Pseudo = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">^=</span> <span class="n">tempword</span><span class="p">;</span>

		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRL</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Pseudo = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">^=</span> <span class="n">tempword</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>read checksum value</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFRH</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Pseudo = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">!=</span> <span class="n">tempword</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Packet checksum mismatch 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chksum</span><span class="p">,</span>
			  <span class="n">tempword</span><span class="p">);</span>
		<span class="n">ft1000_flush_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DSP_PKTPHCKSUM_INFO</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>subtract the number of bytes read already</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ptemp</span> <span class="o">=</span> <span class="n">pbuffer</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>fake MAC address</p></td><td class="code"><div class="highlight"><pre>	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x35</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DFIFO</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tempword</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ft1000_chkcard</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>Need to read one more word if odd byte</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DFIFO</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ptemplong</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pbuffer</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">templong</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DFR</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Data = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">templong</span><span class="p">);</span>
			<span class="o">*</span><span class="n">ptemplong</span><span class="o">++</span> <span class="o">=</span> <span class="n">templong</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>Need to read one more word if odd align.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">templong</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DFR</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Data = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">templong</span><span class="p">);</span>
			<span class="o">*</span><span class="n">ptemplong</span><span class="o">++</span> <span class="o">=</span> <span class="n">templong</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Data passed to Protocol layer:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Protocol Data: 0x%x</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptemp</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>Add on 12 bytes for MAC address which was removed</p></td><td class="code"><div class="highlight"><pre>	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>track how many bytes have been read from FIFO - round up to 16 bit word</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tempword</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="n">tempword</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_cnt</span> <span class="o">+=</span> <span class="n">tempword</span><span class="p">;</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span> <span class="n">FT1000_FIFO_LEN</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><hr />

<p>Function:   ft1000<em>copy</em>down_pkt
Description: This function will take an ethernet packet and convert it to
            a Flarion packet prior to sending it to the ASIC Downlink
            FIFO.
Input:
    dev    - device structure
    packet - address of ethernet packet
    len    - length of IP packet
Output:
    status - FAILURE
             SUCCESS</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_copy_down_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">packet</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="n">blk</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">buff</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">buffc</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">)];</span>
	<span class="p">}</span> <span class="n">pseudo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">plong</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: copy_down_pkt()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>Check if there is room on the FIFO</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ft1000_read_fifo_len</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ft1000_read_fifo_len</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ft1000_read_fifo_len</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ft1000_read_fifo_len</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ft1000_read_fifo_len</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ft1000_read_fifo_len</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ft1000_read_fifo_len</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:Transmit FIFO is fulli - pkt drop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>Create pseudo header and send pseudo/ip to hardware</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">DSPID</span><span class="p">;</span>	<span class="c1">// Need to swap to get in correct order</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">HOSTID</span><span class="p">;</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">portdest</span> <span class="o">=</span> <span class="n">NETWORKID</span><span class="p">;</span>	<span class="c1">// Need to swap to get in correct order</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">portsrc</span> <span class="o">=</span> <span class="n">DSPAIRID</span><span class="p">;</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">sh_str_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">rsvd1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">seq_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">rsvd2</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">packetseqnum</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">qos_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Calculate pseudo header checksum */</span>
	<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pseudo</span><span class="p">.</span><span class="n">blk</span><span class="p">.</span><span class="n">checksum</span> <span class="o">^=</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>Production Mode</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>copy first word to UFIFO_BEG reg</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_BEG</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data 0 BEG = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>copy subsequent words to UFIFO_MID reg</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_MID</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data 1 MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_MID</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data 2 MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_MID</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data 3 MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_MID</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data 4 MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_MID</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data 5 MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_MID</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data 6 MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_MID</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data 7 MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>Write PPP type + IP Packet into Downlink FIFO</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_MID</span><span class="p">,</span>
					 <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">packet</span><span class="p">));</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data %d MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">packet</span><span class="p">));</span>
			<span class="n">packet</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>Check for odd byte</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_MID</span><span class="p">,</span>
					 <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">packet</span><span class="p">));</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">packet</span><span class="p">));</span>
			<span class="n">packet</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_END</span><span class="p">,</span>
					 <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">packet</span><span class="p">));</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data %d MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">packet</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_UFIFO_END</span><span class="p">,</span>
					 <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">packet</span><span class="p">));</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data %d MID = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">packet</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_UFDR</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_copy_down_pkt: Pseudo = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">outl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_UFDR</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_copy_down_pkt: Pseudo = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">outl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_UFDR</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_copy_down_pkt: Pseudo = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">outl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_UFDR</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_copy_down_pkt: Pseudo = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pseudo</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

		<span class="n">plong</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">packet</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>Write PPP type + IP Packet into Downlink FIFO</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outl</span><span class="p">(</span><span class="o">*</span><span class="n">plong</span><span class="o">++</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_UFDR</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>Check for odd alignment</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:data = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="o">*</span><span class="n">plong</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="o">*</span><span class="n">plong</span><span class="o">++</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_UFDR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_UFER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>Add 14 bytes for MAC address plus ethernet type</p></td><td class="code"><div class="highlight"><pre>	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">ft1000_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ft1000_open is called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ft1000_reset_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ft1000_open is ended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* schedule ft1000_hbchk to perform periodic heartbeat checks on DSP and ASIC */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>
	<span class="n">poll_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">poll_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ft1000_open is ended2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ft1000_close()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ft1000_card_present</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Media is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">ft1000_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">,</span> <span class="n">DSP_RESET_BIT</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>reset ASIC</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ft1000_reset_asic</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ft1000_start_xmit()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ft1000_start_xmit:skb == NULL!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ft1000_start_xmit:length of packet = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Drop packet is mediastate is down */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:mediastate is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ENET_HEADER_SIZE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ENET_MAX_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Drop packet which has invalid size */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			  <span class="s">&quot;ft1000_hw:ft1000_copy_down_pkt:invalid ethernet length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ft1000_copy_down_pkt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">+</span> <span class="n">ENET_HEADER_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span>
				 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ENET_HEADER_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ft1000_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">inttype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ft1000_interrupt()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft1000_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ft1000_chkcard</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft1000_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ft1000_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>Read interrupt type</p></td><td class="code"><div class="highlight"><pre>	<span class="n">inttype</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>Make sure we process all interrupt before leaving the ISR due to the edge trigger interrupt type</p></td><td class="code"><div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="n">inttype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inttype</span> <span class="o">&amp;</span> <span class="n">ISR_DOORBELL_PEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft1000_parse_dpram_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inttype</span> <span class="o">&amp;</span> <span class="n">ISR_RCV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Data in FIFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>Check if we have packets in the Downlink FIFO</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tempword</span> <span class="o">=</span>
					<span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DFIFO_STAT</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tempword</span> <span class="o">=</span>
					<span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DFSR</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ft1000_copy_up_pkt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_RCV_LOOP</span><span class="p">);</span>

	<span class="p">}</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>clear interrupts</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tempword</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: interrupt status register = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>Read interrupt type</p></td><td class="code"><div class="highlight"><pre>        <span class="n">inttype</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">);</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;ft1000_hw: interrupt status register after clear = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inttype</span><span class="p">);</span>
    <span class="p">}</span>
	<span class="n">ft1000_enable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stop_ft1000_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">prov_record</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>int cnt;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: stop_ft1000_card()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ft1000_card_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ft1000_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>Make sure we free any memory reserve for provisioning</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">prov_record</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="n">flarion_ft1000_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ft1000CleanupProc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">ft_info</span><span class="p">;</span>
	<span class="n">ft_info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;ft1000&quot;</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">ETHTOOL_BUSINFO_LEN</span><span class="p">,</span> <span class="s">&quot;PCMCIA 0x%lx&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%d.%d.%d.%d&quot;</span><span class="p">,</span> <span class="n">ft_info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		 <span class="n">ft_info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ft_info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ft_info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ft1000_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">ft1000_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ft1000_get_link</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">init_ft1000_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span><span class="n">ft1000_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ft1000ops</span> <span class="o">=</span>		<span class="c1">// Slavius 21.10.2009 due to kernel changes</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ft1000_open</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ft1000_close</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ft1000_start_xmit</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ndo_get_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ft1000_stats</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: init_ft1000_card()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: irq = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: port = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

	<span class="n">flarion_ft1000_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flarion_ft1000_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flarion_ft1000_cnt</span><span class="o">--</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			   <span class="s">&quot;ft1000: This driver can not support more than one instance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ft1000: failed to allocate etherdev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span><span class="p">));</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;address of dev = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;address of dev info = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;device name = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span><span class="p">));</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ft1000_reset</span> <span class="o">=</span> <span class="n">ft1000_reset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flarion_ft1000_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">squeseqnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>dev->hard<em>start</em>xmit = &ft1000<em>start</em>xmit;
dev->get<em>stats = &ft1000</em>stats;
dev->open = &ft1000<em>open;
dev->stop = &ft1000</em>close;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ft1000ops</span><span class="p">;</span>		<span class="c1">// Slavius 21.10.2009 due to kernel changes</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;device name = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_get_mac_from_cis</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ft1000: Could not read mac address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ft1000_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ft1000: Could not request_irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ft1000: Could not request_region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ft1000: Could not register netdev&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_ASIC_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: ELECTRABUZZ ASIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="s">&quot;ft1000.img&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ft1000: Could not open ft1000.img</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_unreg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ft1000_hw: MAGNEMITE ASIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="s">&quot;ft2000.img&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ft1000: Could not open ft2000.img</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_unreg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ft1000_enable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ft1000InitProc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ft1000_card_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ft1000: %s: addr 0x%04lx irq %d, MAC addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">err_unreg:</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_reg:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
<span class="nl">err_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">err_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
