<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › ft1000 › ft1000-pcmcia › ft1000_dnld.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ft1000_dnld.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">   FT1000 driver for Flarion Flash OFDM NIC Device</span>

<span class="cm">   Copyright (C) 2002 Flarion Technologies, All rights reserved.</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">   under the terms of the GNU General Public License as published by the Free</span>
<span class="cm">   Software Foundation; either version 2 of the License, or (at your option) any</span>
<span class="cm">   later version. This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="cm">   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">   more details. You should have received a copy of the GNU General Public</span>
<span class="cm">   License along with this program; if not, write to the</span>
<span class="cm">   Free Software Foundation, Inc., 59 Temple Place -</span>
<span class="cm">   Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm">  --------------------------------------------------------------------------</span>

<span class="cm">   Description:  This module will handshake with the DSP bootloader to</span>
<span class="cm">                 download the DSP runtime image.</span>

<span class="cm">---------------------------------------------------------------------------*/</span>

<span class="cp">#define __KERNEL_SYSCALLS__</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;ft1000.h&quot;</span>
<span class="cp">#include &quot;boot.h&quot;</span>

<span class="cp">#ifdef FT_DEBUG</span>
<span class="cp">#define DEBUG(n, args...) printk(KERN_DEBUG args);</span>
<span class="cp">#else</span>
<span class="cp">#define DEBUG(n, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#define  MAX_DSP_WAIT_LOOPS      100</span>
<span class="cp">#define  DSP_WAIT_SLEEP_TIME     1	</span><span class="cm">/* 1 millisecond */</span><span class="cp"></span>

<span class="cp">#define  MAX_LENGTH              0x7f0</span>

<span class="cp">#define  DWNLD_MAG_HANDSHAKE_LOC 0x00</span>
<span class="cp">#define  DWNLD_MAG_TYPE_LOC      0x01</span>
<span class="cp">#define  DWNLD_MAG_SIZE_LOC      0x02</span>
<span class="cp">#define  DWNLD_MAG_PS_HDR_LOC    0x03</span>

<span class="cp">#define  DWNLD_HANDSHAKE_LOC     0x02</span>
<span class="cp">#define  DWNLD_TYPE_LOC          0x04</span>
<span class="cp">#define  DWNLD_SIZE_MSW_LOC      0x06</span>
<span class="cp">#define  DWNLD_SIZE_LSW_LOC      0x08</span>
<span class="cp">#define  DWNLD_PS_HDR_LOC        0x0A</span>

<span class="cp">#define  HANDSHAKE_TIMEOUT_VALUE 0xF1F1</span>
<span class="cp">#define  HANDSHAKE_RESET_VALUE   0xFEFE	</span><span class="cm">/* When DSP requests startover */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_DSP_BL_READY  0xFEFE	</span><span class="cm">/* At start DSP writes this when bootloader ready */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_DRIVER_READY  0xFFFF	</span><span class="cm">/* Driver writes after receiving 0xFEFE */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_SEND_DATA     0x0000	</span><span class="cm">/* DSP writes this when ready for more data */</span><span class="cp"></span>

<span class="cp">#define  HANDSHAKE_REQUEST       0x0001	</span><span class="cm">/* Request from DSP */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_RESPONSE      0x0000	</span><span class="cm">/* Satisfied DSP request */</span><span class="cp"></span>

<span class="cp">#define  REQUEST_CODE_LENGTH     0x0000</span>
<span class="cp">#define  REQUEST_RUN_ADDRESS     0x0001</span>
<span class="cp">#define  REQUEST_CODE_SEGMENT    0x0002	</span><span class="cm">/* In WORD count */</span><span class="cp"></span>
<span class="cp">#define  REQUEST_DONE_BL         0x0003</span>
<span class="cp">#define  REQUEST_DONE_CL         0x0004</span>
<span class="cp">#define  REQUEST_VERSION_INFO    0x0005</span>
<span class="cp">#define  REQUEST_CODE_BY_VERSION 0x0006</span>
<span class="cp">#define  REQUEST_MAILBOX_DATA    0x0007</span>
<span class="cp">#define  REQUEST_FILE_CHECKSUM   0x0008</span>

<span class="cp">#define  STATE_START_DWNLD       0x01</span>
<span class="cp">#define  STATE_BOOT_DWNLD        0x02</span>
<span class="cp">#define  STATE_CODE_DWNLD        0x03</span>
<span class="cp">#define  STATE_DONE_DWNLD        0x04</span>
<span class="cp">#define  STATE_SECTION_PROV      0x05</span>
<span class="cp">#define  STATE_DONE_PROV         0x06</span>
<span class="cp">#define  STATE_DONE_FILE         0x07</span>

<span class="n">u16</span> <span class="n">get_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">expected_value</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">put_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handshake_value</span><span class="p">);</span>
<span class="n">u16</span> <span class="n">get_request_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">long</span> <span class="n">get_request_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">put_request_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">long</span> <span class="n">lvalue</span><span class="p">);</span>
<span class="n">u16</span> <span class="n">hdr_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">pHdr</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">dsp_file_hdr</span> <span class="p">{</span>
	<span class="n">u32</span>  <span class="n">version_id</span><span class="p">;</span>	<span class="c1">// Version ID of this image format.</span>
	<span class="n">u32</span>  <span class="n">package_id</span><span class="p">;</span>	<span class="c1">// Package ID of code release.</span>
	<span class="n">u32</span>  <span class="n">build_date</span><span class="p">;</span>	<span class="c1">// Date/time stamp when file was built.</span>
	<span class="n">u32</span>  <span class="n">commands_offset</span><span class="p">;</span>	<span class="c1">// Offset to attached commands in Pseudo Hdr format.</span>
	<span class="n">u32</span>  <span class="n">loader_offset</span><span class="p">;</span>	<span class="c1">// Offset to bootloader code.</span>
	<span class="n">u32</span>  <span class="n">loader_code_address</span><span class="p">;</span>	<span class="c1">// Start address of bootloader.</span>
	<span class="n">u32</span>  <span class="n">loader_code_end</span><span class="p">;</span>	<span class="c1">// Where bootloader code ends.</span>
	<span class="n">u32</span>  <span class="n">loader_code_size</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">version_data_offset</span><span class="p">;</span>	<span class="c1">// Offset were scrambled version data begins.</span>
	<span class="n">u32</span>  <span class="n">version_data_size</span><span class="p">;</span>	<span class="c1">// Size, in words, of scrambled version data.</span>
	<span class="n">u32</span>  <span class="n">nDspImages</span><span class="p">;</span>	<span class="c1">// Number of DSP images in file.</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">dsp_image_info</span> <span class="p">{</span>
	<span class="n">u32</span>  <span class="n">coff_date</span><span class="p">;</span>		<span class="c1">// Date/time when DSP Coff image was built.</span>
	<span class="n">u32</span>  <span class="n">begin_offset</span><span class="p">;</span>	<span class="c1">// Offset in file where image begins.</span>
	<span class="n">u32</span>  <span class="n">end_offset</span><span class="p">;</span>	<span class="c1">// Offset in file where image begins.</span>
	<span class="n">u32</span>  <span class="n">run_address</span><span class="p">;</span>	<span class="c1">// On chip Start address of DSP code.</span>
	<span class="n">u32</span>  <span class="n">image_size</span><span class="p">;</span>	<span class="c1">// Size of image.</span>
	<span class="n">u32</span>  <span class="n">version</span><span class="p">;</span>		<span class="c1">// Embedded version # of DSP code.</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">checksum</span><span class="p">;</span>	<span class="c1">// Dsp File checksum</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pad1</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="kt">void</span> <span class="nf">card_bootload</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">templong</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;card_bootload is called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">bootimage</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bootimage</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>check for odd word</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>need to set i/o base address initially and hardware will autoincrement</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span> <span class="n">FT1000_DPRAM_BASE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>write bytes</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">templong</span> <span class="o">=</span> <span class="o">*</span><span class="n">pdata</span><span class="o">++</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">templong</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">FT1000_REG_MAG_DPDATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">get_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">expected_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">handshake</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tempx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loopcnt</span><span class="p">;</span>

	<span class="n">loopcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">loopcnt</span> <span class="o">&lt;</span> <span class="n">MAX_DSP_WAIT_LOOPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
					 <span class="n">DWNLD_HANDSHAKE_LOC</span><span class="p">);</span>

			<span class="n">handshake</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tempx</span> <span class="o">=</span>
				<span class="n">ntohl</span><span class="p">(</span><span class="n">ft1000_read_dpram_mag_32</span>
				  <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DWNLD_MAG_HANDSHAKE_LOC</span><span class="p">));</span>
			<span class="n">handshake</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">tempx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">expected_value</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">HANDSHAKE_RESET_VALUE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">handshake</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">loopcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="n">DSP_WAIT_SLEEP_TIME</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">HANDSHAKE_TIMEOUT_VALUE</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">put_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handshake_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tempx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
				 <span class="n">DWNLD_HANDSHAKE_LOC</span><span class="p">);</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">,</span> <span class="n">handshake_value</span><span class="p">);</span>	<span class="cm">/* Handshake */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">handshake_value</span><span class="p">;</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tempx</span><span class="p">);</span>
		<span class="n">ft1000_write_dpram_mag_32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DWNLD_MAG_HANDSHAKE_LOC</span><span class="p">,</span> <span class="n">tempx</span><span class="p">);</span>	<span class="cm">/* Handshake */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">get_request_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">request_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tempx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span> <span class="n">DWNLD_TYPE_LOC</span><span class="p">);</span>
		<span class="n">request_type</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="n">ft1000_read_dpram_mag_32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DWNLD_MAG_TYPE_LOC</span><span class="p">);</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tempx</span><span class="p">);</span>
		<span class="n">request_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">tempx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">request_type</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">long</span> <span class="nf">get_request_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
				 <span class="n">DWNLD_SIZE_MSW_LOC</span><span class="p">);</span>

		<span class="n">w_val</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">);</span>

		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">w_val</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
				 <span class="n">DWNLD_SIZE_LSW_LOC</span><span class="p">);</span>

		<span class="n">w_val</span> <span class="o">=</span> <span class="n">ft1000_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">);</span>

		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">value</span> <span class="o">|</span> <span class="n">w_val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">ft1000_read_dpram_mag_32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DWNLD_MAG_SIZE_LOC</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">put_request_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">long</span> <span class="n">lvalue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tempx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">AsicID</span> <span class="o">==</span> <span class="n">ELECTRABUZZ_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">lvalue</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
				 <span class="n">DWNLD_SIZE_MSW_LOC</span><span class="p">);</span>

		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">lvalue</span><span class="p">);</span>

		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
				 <span class="n">DWNLD_SIZE_LSW_LOC</span><span class="p">);</span>

		<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">lvalue</span><span class="p">);</span>
		<span class="n">ft1000_write_dpram_mag_32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DWNLD_MAG_SIZE_LOC</span><span class="p">,</span> <span class="n">tempx</span><span class="p">);</span>	<span class="cm">/* Handshake */</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="n">u16</span> <span class="nf">hdr_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">pHdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">usPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pHdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chksum</span><span class="p">;</span>

	<span class="n">chksum</span> <span class="o">=</span> <span class="p">((((((</span><span class="n">usPtr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">^</span>
			<span class="n">usPtr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">chksum</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">card_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pFileStart</span><span class="p">,</span>
		  <span class="kt">size_t</span> <span class="n">FileLength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uiState</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handshake</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">pHdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">usHdrLength</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">word_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prov_record</span> <span class="o">*</span><span class="n">pprov_record</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_file_hdr</span> <span class="o">*</span><span class="n">pFileHdr5</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_image_info</span> <span class="o">*</span><span class="n">pDspImageInfoV6</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">requested_version</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bGoodVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drv_msg</span> <span class="o">*</span><span class="n">pMailBoxData</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">pUsData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">pUsFile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pUcFile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pBootEnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pCodeEnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">imageN</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">file_version</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">loader_code_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">loader_code_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">run_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">run_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">templong</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">image_chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">file_version</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">pFileStart</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file_version</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ft1000: unsupported firmware version %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file_version</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uiState</span> <span class="o">=</span> <span class="n">STATE_START_DWNLD</span><span class="p">;</span>

	<span class="n">pFileHdr5</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_file_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pFileStart</span><span class="p">;</span>

	<span class="n">pUsFile</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pFileStart</span> <span class="o">+</span> <span class="n">pFileHdr5</span><span class="o">-&gt;</span><span class="n">loader_offset</span><span class="p">);</span>
	<span class="n">pUcFile</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pFileStart</span> <span class="o">+</span> <span class="n">pFileHdr5</span><span class="o">-&gt;</span><span class="n">loader_offset</span><span class="p">);</span>
	<span class="n">pBootEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pFileStart</span> <span class="o">+</span> <span class="n">pFileHdr5</span><span class="o">-&gt;</span><span class="n">loader_code_end</span><span class="p">);</span>
	<span class="n">loader_code_address</span> <span class="o">=</span> <span class="n">pFileHdr5</span><span class="o">-&gt;</span><span class="n">loader_code_address</span><span class="p">;</span>
	<span class="n">loader_code_size</span> <span class="o">=</span> <span class="n">pFileHdr5</span><span class="o">-&gt;</span><span class="n">loader_code_size</span><span class="p">;</span>
	<span class="n">bGoodVersion</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">Status</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">uiState</span> <span class="o">!=</span> <span class="n">STATE_DONE_FILE</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">uiState</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STATE_START_DWNLD</span>:

			<span class="n">handshake</span> <span class="o">=</span> <span class="n">get_handshake</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HANDSHAKE_DSP_BL_READY</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">HANDSHAKE_DSP_BL_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">put_handshake</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HANDSHAKE_DRIVER_READY</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">uiState</span> <span class="o">=</span> <span class="n">STATE_BOOT_DWNLD</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_BOOT_DWNLD</span>:
			<span class="n">handshake</span> <span class="o">=</span> <span class="n">get_handshake</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HANDSHAKE_REQUEST</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">HANDSHAKE_REQUEST</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Get type associated with the request.</span>
<span class="cm">				 */</span>
				<span class="n">request</span> <span class="o">=</span> <span class="n">get_request_type</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">REQUEST_RUN_ADDRESS</span>:
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">loader_code_address</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_CODE_LENGTH</span>:
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">loader_code_size</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_DONE_BL</span>:
					<span class="cm">/* Reposition ptrs to beginning of code section */</span>
					<span class="n">pUsFile</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pBootEnd</span><span class="p">);</span>
					<span class="n">pUcFile</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pBootEnd</span><span class="p">);</span>
					<span class="n">uiState</span> <span class="o">=</span> <span class="n">STATE_CODE_DWNLD</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_CODE_SEGMENT</span>:
					<span class="n">word_length</span> <span class="o">=</span> <span class="n">get_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&gt;</span> <span class="n">MAX_LENGTH</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">word_length</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pUcFile</span><span class="p">)</span> <span class="o">&gt;</span>
						<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pBootEnd</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Error, beyond boot code range.</span>
<span class="cm">						 */</span>
						<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span>
							  <span class="n">flags</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					 * Position ASIC DPRAM auto-increment pointer.</span>
<span class="cm">					 */</span>
					<span class="n">outw</span><span class="p">(</span><span class="n">DWNLD_MAG_PS_HDR_LOC</span><span class="p">,</span>
						 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
						 <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
						<span class="n">word_length</span><span class="o">++</span><span class="p">;</span>
					<span class="n">word_length</span> <span class="o">=</span> <span class="n">word_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

					<span class="k">for</span> <span class="p">(;</span> <span class="n">word_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word_length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* In words */</span>
						<span class="n">templong</span> <span class="o">=</span> <span class="o">*</span><span class="n">pUsFile</span><span class="o">++</span><span class="p">;</span>
						<span class="n">templong</span> <span class="o">|=</span>
							<span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="o">++</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="n">pUcFile</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">outl</span><span class="p">(</span><span class="n">templong</span><span class="p">,</span>
							 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
							 <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span>
								   <span class="n">dpram_lock</span><span class="p">,</span>
								   <span class="n">flags</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">put_handshake</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HANDSHAKE_RESPONSE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_CODE_DWNLD</span>:
			<span class="n">handshake</span> <span class="o">=</span> <span class="n">get_handshake</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HANDSHAKE_REQUEST</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">HANDSHAKE_REQUEST</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Get type associated with the request.</span>
<span class="cm">				 */</span>
				<span class="n">request</span> <span class="o">=</span> <span class="n">get_request_type</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">REQUEST_FILE_CHECKSUM</span>:
					<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
						  <span class="s">&quot;ft1000_dnld: REQUEST_FOR_CHECKSUM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">image_chksum</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_RUN_ADDRESS</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">bGoodVersion</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">put_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">run_address</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_CODE_LENGTH</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">bGoodVersion</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">put_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">run_size</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_DONE_CL</span>:
					<span class="cm">/* Reposition ptrs to beginning of provisioning section */</span>
					<span class="n">pUsFile</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pFileStart</span> <span class="o">+</span> <span class="n">pFileHdr5</span><span class="o">-&gt;</span><span class="n">commands_offset</span><span class="p">);</span>
					<span class="n">pUcFile</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pFileStart</span> <span class="o">+</span> <span class="n">pFileHdr5</span><span class="o">-&gt;</span><span class="n">commands_offset</span><span class="p">);</span>
					<span class="n">uiState</span> <span class="o">=</span> <span class="n">STATE_DONE_DWNLD</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_CODE_SEGMENT</span>:
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bGoodVersion</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">word_length</span> <span class="o">=</span> <span class="n">get_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&gt;</span> <span class="n">MAX_LENGTH</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">word_length</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pUcFile</span><span class="p">)</span> <span class="o">&gt;</span>
						<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pCodeEnd</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Error, beyond boot code range.</span>
<span class="cm">						 */</span>
						<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/*</span>
<span class="cm">					 * Position ASIC DPRAM auto-increment pointer.</span>
<span class="cm">					 */</span>
					<span class="n">outw</span><span class="p">(</span><span class="n">DWNLD_MAG_PS_HDR_LOC</span><span class="p">,</span>
						 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
						 <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
						<span class="n">word_length</span><span class="o">++</span><span class="p">;</span>
					<span class="n">word_length</span> <span class="o">=</span> <span class="n">word_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

					<span class="k">for</span> <span class="p">(;</span> <span class="n">word_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word_length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* In words */</span>
						<span class="n">templong</span> <span class="o">=</span> <span class="o">*</span><span class="n">pUsFile</span><span class="o">++</span><span class="p">;</span>
						<span class="n">templong</span> <span class="o">|=</span>
							<span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="o">++</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="n">pUcFile</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">outl</span><span class="p">(</span><span class="n">templong</span><span class="p">,</span>
							 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
							 <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">REQUEST_MAILBOX_DATA</span>:</pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Convert length from byte count to word count. Make sure we round up.</p></td><td class="code"><div class="highlight"><pre>					<span class="n">word_length</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">word_length</span><span class="p">);</span>
					<span class="n">pMailBoxData</span> <span class="o">=</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">drv_msg</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="n">pUsData</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pMailBoxData</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span>
							  <span class="n">flags</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">file_version</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Position ASIC DPRAM auto-increment pointer.</span>
<span class="cm">						 */</span>
						<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								 <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">,</span>
								 <span class="n">DWNLD_PS_HDR_LOC</span><span class="p">);</span>

						<span class="k">for</span> <span class="p">(;</span> <span class="n">word_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word_length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* In words */</span>
							<span class="n">temp</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="n">pUsData</span><span class="p">);</span>
							<span class="n">ft1000_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									 <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">,</span>
									 <span class="n">temp</span><span class="p">);</span>
							<span class="n">pUsData</span><span class="o">++</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Position ASIC DPRAM auto-increment pointer.</span>
<span class="cm">						 */</span>
						<span class="n">outw</span><span class="p">(</span><span class="n">DWNLD_MAG_PS_HDR_LOC</span><span class="p">,</span>
							 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
							 <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">word_length</span><span class="o">++</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">word_length</span> <span class="o">=</span> <span class="n">word_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

						<span class="k">for</span> <span class="p">(;</span> <span class="n">word_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word_length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* In words */</span>
							<span class="n">templong</span> <span class="o">=</span> <span class="o">*</span><span class="n">pUsData</span><span class="o">++</span><span class="p">;</span>
							<span class="n">templong</span> <span class="o">|=</span>
								<span class="p">(</span><span class="o">*</span><span class="n">pUsData</span><span class="o">++</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
							<span class="n">outl</span><span class="p">(</span><span class="n">templong</span><span class="p">,</span>
								 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
								 <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span>
								   <span class="n">dpram_lock</span><span class="p">,</span>
								   <span class="n">flags</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">REQUEST_VERSION_INFO</span>:
					<span class="n">word_length</span> <span class="o">=</span>
						<span class="n">pFileHdr5</span><span class="o">-&gt;</span><span class="n">version_data_size</span><span class="p">;</span>
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">word_length</span><span class="p">);</span>
					<span class="n">pUsFile</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pFileStart</span> <span class="o">+</span>
							<span class="n">pFileHdr5</span><span class="o">-&gt;</span>
							<span class="n">version_data_offset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Provide mutual exclusive access while reading ASIC registers.</p></td><td class="code"><div class="highlight"><pre>					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">,</span>
							  <span class="n">flags</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					 * Position ASIC DPRAM auto-increment pointer.</span>
<span class="cm">					 */</span>
					<span class="n">outw</span><span class="p">(</span><span class="n">DWNLD_MAG_PS_HDR_LOC</span><span class="p">,</span>
						 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
						 <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
						<span class="n">word_length</span><span class="o">++</span><span class="p">;</span>
					<span class="n">word_length</span> <span class="o">=</span> <span class="n">word_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

					<span class="k">for</span> <span class="p">(;</span> <span class="n">word_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word_length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* In words */</span>
						<span class="n">templong</span> <span class="o">=</span>
							<span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="o">++</span><span class="p">);</span>
						<span class="n">temp</span> <span class="o">=</span>
							<span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="o">++</span><span class="p">);</span>
						<span class="n">templong</span> <span class="o">|=</span>
							<span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="n">outl</span><span class="p">(</span><span class="n">templong</span><span class="p">,</span>
							 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
							 <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span>
								   <span class="n">dpram_lock</span><span class="p">,</span>
								   <span class="n">flags</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">REQUEST_CODE_BY_VERSION</span>:
					<span class="n">bGoodVersion</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">requested_version</span> <span class="o">=</span>
						<span class="n">get_request_value</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">pDspImageInfoV6</span> <span class="o">=</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">dsp_image_info</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span>
								  <span class="n">pFileStart</span>
								  <span class="o">+</span>
								  <span class="k">sizeof</span>
								  <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_file_hdr</span><span class="p">));</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">imageN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						 <span class="n">imageN</span> <span class="o">&lt;</span>
						 <span class="n">pFileHdr5</span><span class="o">-&gt;</span><span class="n">nDspImages</span><span class="p">;</span>
						 <span class="n">imageN</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span>
							<span class="p">(</span><span class="n">pDspImageInfoV6</span><span class="o">-&gt;</span>
							 <span class="n">version</span><span class="p">);</span>
						<span class="n">templong</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
						<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span>
							<span class="p">(</span><span class="n">pDspImageInfoV6</span><span class="o">-&gt;</span>
							 <span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="n">templong</span> <span class="o">|=</span>
							<span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">templong</span> <span class="o">==</span>
							<span class="n">requested_version</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">bGoodVersion</span> <span class="o">=</span>
								<span class="nb">true</span><span class="p">;</span>
							<span class="n">pUsFile</span> <span class="o">=</span>
								<span class="p">(</span><span class="n">u16</span>
								 <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span>
								 <span class="n">pFileStart</span>
								 <span class="o">+</span>
								 <span class="n">pDspImageInfoV6</span><span class="o">-&gt;</span>
								 <span class="n">begin_offset</span><span class="p">);</span>
							<span class="n">pUcFile</span> <span class="o">=</span>
								<span class="p">(</span><span class="n">u8</span>
								 <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span>
								 <span class="n">pFileStart</span>
								 <span class="o">+</span>
								 <span class="n">pDspImageInfoV6</span><span class="o">-&gt;</span>
								 <span class="n">begin_offset</span><span class="p">);</span>
							<span class="n">pCodeEnd</span> <span class="o">=</span>
								<span class="p">(</span><span class="n">u8</span>
								 <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span>
								 <span class="n">pFileStart</span>
								 <span class="o">+</span>
								 <span class="n">pDspImageInfoV6</span><span class="o">-&gt;</span>
								 <span class="n">end_offset</span><span class="p">);</span>
							<span class="n">run_address</span> <span class="o">=</span>
								<span class="n">pDspImageInfoV6</span><span class="o">-&gt;</span>
								<span class="n">run_address</span><span class="p">;</span>
							<span class="n">run_size</span> <span class="o">=</span>
								<span class="n">pDspImageInfoV6</span><span class="o">-&gt;</span>
								<span class="n">image_size</span><span class="p">;</span>
							<span class="n">image_chksum</span> <span class="o">=</span>
								<span class="p">(</span><span class="n">u32</span><span class="p">)</span>
								<span class="n">pDspImageInfoV6</span><span class="o">-&gt;</span>
								<span class="n">checksum</span><span class="p">;</span>
							<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
								  <span class="s">&quot;ft1000_dnld: image_chksum = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								  <span class="p">(</span><span class="kt">unsigned</span>
								   <span class="kt">int</span><span class="p">)</span>
								  <span class="n">image_chksum</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">pDspImageInfoV6</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bGoodVersion</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Error, beyond boot code range.</span>
<span class="cm">						 */</span>
						<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="nl">default:</span>
					<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">put_handshake</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HANDSHAKE_RESPONSE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DONE_DWNLD</span>:
			<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">pUcFile</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pFileStart</span><span class="p">)</span> <span class="o">&gt;=</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">FileLength</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">uiState</span> <span class="o">=</span> <span class="n">STATE_DONE_FILE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pHdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pUsFile</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">portdest</span> <span class="o">==</span> <span class="mh">0x80</span>	<span class="cm">/* DspOAM */</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">==</span> <span class="mh">0x00</span>	<span class="cm">/* Driver */</span>
				<span class="o">||</span> <span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="cm">/* FMM */</span> <span class="p">))</span> <span class="p">{</span>
				<span class="n">uiState</span> <span class="o">=</span> <span class="n">STATE_SECTION_PROV</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					  <span class="s">&quot;FT1000:download:Download error: Bad Port IDs in Pseudo Record</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s"> Port Source = 0x%2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">portsrc</span><span class="p">);</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s"> Port Destination = 0x%2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">portdest</span><span class="p">);</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_SECTION_PROV</span>:

			<span class="n">pHdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pUcFile</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">==</span> <span class="n">hdr_checksum</span><span class="p">(</span><span class="n">pHdr</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">portdest</span> <span class="o">!=</span> <span class="mh">0x80</span> <span class="cm">/* Dsp OAM */</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">uiState</span> <span class="o">=</span> <span class="n">STATE_DONE_PROV</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">usHdrLength</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pHdr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>	<span class="cm">/* Byte length for PROV records */</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Get buffer for provisioning data</p></td><td class="code"><div class="highlight"><pre>				<span class="n">pbuffer</span> <span class="o">=</span>
					<span class="n">kmalloc</span><span class="p">((</span><span class="n">usHdrLength</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">)),</span>
						<span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pbuffer</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">pbuffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pUcFile</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">usHdrLength</span> <span class="o">+</span>
							   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">)));</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>link provisioning data</p></td><td class="code"><div class="highlight"><pre>					<span class="n">pprov_record</span> <span class="o">=</span>
						<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prov_record</span><span class="p">),</span>
							<span class="n">GFP_ATOMIC</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pprov_record</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pprov_record</span><span class="o">-&gt;</span><span class="n">pprov_data</span> <span class="o">=</span>
							<span class="n">pbuffer</span><span class="p">;</span>
						<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pprov_record</span><span class="o">-&gt;</span>
								  <span class="n">list</span><span class="p">,</span>
								  <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Move to next entry if available</p></td><td class="code"><div class="highlight"><pre>						<span class="n">pUcFile</span> <span class="o">=</span>
							<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pUcFile</span> <span class="o">+</span>
								   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">((</span><span class="n">usHdrLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">));</span>
						<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">pUcFile</span><span class="p">)</span> <span class="o">-</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span><span class="p">)</span> <span class="o">&gt;=</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">FileLength</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">uiState</span> <span class="o">=</span>
								<span class="n">STATE_DONE_FILE</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">kfree</span><span class="p">(</span><span class="n">pbuffer</span><span class="p">);</span>
						<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Checksum did not compute */</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DONE_PROV</span>:
			<span class="n">uiState</span> <span class="o">=</span> <span class="n">STATE_DONE_FILE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>		<span class="cm">/* End Switch */</span>

	<span class="p">}</span>			<span class="cm">/* End while */</span>

	<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>

<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
