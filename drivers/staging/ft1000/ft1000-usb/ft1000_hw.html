<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › ft1000 › ft1000-usb › ft1000_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ft1000_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>=====================================================
CopyRight (C) 2007 Qualcomm Inc. All Rights Reserved.</p>

<p>This file is part of Express Card USB Driver</p>

<h1>$Id:</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &quot;ft1000_usb.h&quot;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#define HARLEY_READ_REGISTER     0x0</span>
<span class="cp">#define HARLEY_WRITE_REGISTER    0x01</span>
<span class="cp">#define HARLEY_READ_DPRAM_32     0x02</span>
<span class="cp">#define HARLEY_READ_DPRAM_LOW    0x03</span>
<span class="cp">#define HARLEY_READ_DPRAM_HIGH   0x04</span>
<span class="cp">#define HARLEY_WRITE_DPRAM_32    0x05</span>
<span class="cp">#define HARLEY_WRITE_DPRAM_LOW   0x06</span>
<span class="cp">#define HARLEY_WRITE_DPRAM_HIGH  0x07</span>

<span class="cp">#define HARLEY_READ_OPERATION    0xc1</span>
<span class="cp">#define HARLEY_WRITE_OPERATION   0x41</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define JDEBUG</h1></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="n">ft1000_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ft1000_submit_rx_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ft1000_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ft1000_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">ft1000_netdev_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ft1000_chkcard</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">tempbuffer</span><span class="p">[</span><span class="mi">1600</span><span class="p">];</span>

<span class="cp">#define MAX_RCV_LOOP   100</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><hr />

<p>Function:    ft1000_control</p>

<p>Parameters:  ft1000_device  - device structure
             pipe - usb control message pipe
             request - control request
             requesttype - control message request type
             value - value to be written or 0
             index - register index
             data - data buffer to hold the read/write values
             size - data size
             timeout - control message time out value</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function sends a control message via USB interface synchronously</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">request</span><span class="p">,</span> <span class="n">u8</span> <span class="n">requesttype</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ft1000dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000dev or ft1000dev-&gt;dev == NULL, failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">requesttype</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">LARGE_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><hr />

<p>Function:    ft1000<em>read</em>register</p>

<p>Parameters:  ft1000_device  - device structure
             Data - data buffer to hold the value read
             nRegIndex - register index</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function returns the value in a register</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">ft1000_read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">Data</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">nRegIndx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_control</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
			     <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">HARLEY_READ_REGISTER</span><span class="p">,</span>
			     <span class="n">HARLEY_READ_OPERATION</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span>
			     <span class="n">nRegIndx</span><span class="p">,</span>
			     <span class="n">Data</span><span class="p">,</span>
			     <span class="mi">2</span><span class="p">,</span>
			     <span class="n">LARGE_TIMEOUT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><hr />

<p>Function:    ft1000<em>write</em>register</p>

<p>Parameters:  ft1000_device  - device structure
             value - value to write into a register
             nRegIndex - register index</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function writes the value in a register</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">ft1000_write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">nRegIndx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_control</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
			     <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">HARLEY_WRITE_REGISTER</span><span class="p">,</span>
			     <span class="n">HARLEY_WRITE_OPERATION</span><span class="p">,</span>
			     <span class="n">value</span><span class="p">,</span>
			     <span class="n">nRegIndx</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span>
			     <span class="n">LARGE_TIMEOUT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><hr />

<p>Function:    ft1000<em>read</em>dpram32</p>

<p>Parameters:  ft1000_device  - device structure
             indx - starting address to read
             buffer - data buffer to hold the data read
             cnt - number of byte read from DPRAM</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function read a number of bytes from DPRAM</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">ft1000_read_dpram32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_control</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
			     <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">HARLEY_READ_DPRAM_32</span><span class="p">,</span>
			     <span class="n">HARLEY_READ_OPERATION</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span>
			     <span class="n">indx</span><span class="p">,</span>
			     <span class="n">buffer</span><span class="p">,</span>
			     <span class="n">cnt</span><span class="p">,</span>
			     <span class="n">LARGE_TIMEOUT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><hr />

<p>Function:    ft1000<em>write</em>dpram32</p>

<p>Parameters:  ft1000_device  - device structure
             indx - starting address to write the data
             buffer - data buffer to write into DPRAM
             cnt - number of bytes to write</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function writes into DPRAM a number of bytes</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">ft1000_write_dpram32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">+=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_control</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
			     <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">HARLEY_WRITE_DPRAM_32</span><span class="p">,</span>
			     <span class="n">HARLEY_WRITE_OPERATION</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span>
			     <span class="n">indx</span><span class="p">,</span>
			     <span class="n">buffer</span><span class="p">,</span>
			     <span class="n">cnt</span><span class="p">,</span>
			     <span class="n">LARGE_TIMEOUT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><hr />

<p>Function:    ft1000<em>read</em>dpram16</p>

<p>Parameters:  ft1000_device  - device structure
             indx - starting address to read
             buffer - data buffer to hold the data read
             hightlow - high or low 16 bit word</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function read 16 bits from DPRAM</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">ft1000_read_dpram16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">highlow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">request</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">highlow</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">request</span> <span class="o">=</span> <span class="n">HARLEY_READ_DPRAM_LOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">request</span> <span class="o">=</span> <span class="n">HARLEY_READ_DPRAM_HIGH</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_control</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
			     <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">request</span><span class="p">,</span>
			     <span class="n">HARLEY_READ_OPERATION</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span>
			     <span class="n">indx</span><span class="p">,</span>
			     <span class="n">buffer</span><span class="p">,</span>
			     <span class="mi">2</span><span class="p">,</span>
			     <span class="n">LARGE_TIMEOUT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><hr />

<p>Function:    ft1000<em>write</em>dpram16</p>

<p>Parameters:  ft1000_device  - device structure
             indx - starting address to write the data
             value - 16bits value to write
             hightlow - high or low 16 bit word</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function writes into DPRAM a number of bytes</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">ft1000_write_dpram16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">highlow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">request</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">highlow</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">request</span> <span class="o">=</span> <span class="n">HARLEY_WRITE_DPRAM_LOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">request</span> <span class="o">=</span> <span class="n">HARLEY_WRITE_DPRAM_HIGH</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_control</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
			     <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">request</span><span class="p">,</span>
			     <span class="n">HARLEY_WRITE_OPERATION</span><span class="p">,</span>
			     <span class="n">value</span><span class="p">,</span>
			     <span class="n">indx</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span>
			     <span class="n">LARGE_TIMEOUT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><hr />

<p>Function:    fix<em>ft1000</em>read_dpram32</p>

<p>Parameters:  ft1000_device  - device structure
             indx - starting address to read
             buffer - data buffer to hold the data read</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function read DPRAM 4 words at a time</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">fix_ft1000_read_dpram32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">indx</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">indx</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_read_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">indx</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">];</span>
		<span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">];</span>
		<span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">];</span>
		<span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;fix_ft1000_read_dpram32: DPRAM32 Read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><hr />

<p>Function:    fix<em>ft1000</em>write_dpram32</p>

<p>Parameters:  ft1000_device  - device structure
             indx - starting address to write
             buffer - data buffer to write</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function write to DPRAM 4 words at a time</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">fix_ft1000_write_dpram32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pos1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pos2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">resultbuffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span>  <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="n">pos1</span> <span class="o">=</span> <span class="p">(</span><span class="n">indx</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_read_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos2</span> <span class="o">=</span> <span class="p">(</span><span class="n">indx</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">pos2</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">pos2</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">pos2</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">pos2</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_write_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;fix_ft1000_write_dpram32: DPRAM32 Read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_read_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">resultbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">resultbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">STATUS_FAILURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_write_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_read_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">resultbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tempbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">resultbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;%s Failed to write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">__func__</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><hr />

<p>Function:   card<em>reset</em>dsp</p>

<p>Synopsis:   This function is called to reset or activate the DSP</p>

<p>Arguments:  value                  - reset or activate</p>

<h2> Returns:    None</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">card_reset_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">HOST_INTF_BE</span><span class="p">,</span>
					<span class="n">FT1000_REG_SUP_CTRL</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
				      <span class="n">FT1000_REG_SUP_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Reset DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
					      <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
		<span class="n">tempword</span> <span class="o">|=</span> <span class="n">DSP_RESET_BIT</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">tempword</span><span class="p">,</span>
					       <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Activate DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
					      <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
		<span class="n">tempword</span> <span class="o">|=</span> <span class="n">DSP_ENCRYPTED</span><span class="p">;</span>
		<span class="n">tempword</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_UNENCRYPTED</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">tempword</span><span class="p">,</span>
					       <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
					      <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
		<span class="n">tempword</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EFUSE_MEM_DISABLE</span><span class="p">;</span>
		<span class="n">tempword</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_RESET_BIT</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">tempword</span><span class="p">,</span>
					       <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
					      <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><hr />

<p>Function:    card<em>send</em>command</p>

<p>Parameters:  ft1000_device  - device structure
             ptempbuffer - command buffer
             size - command buffer size</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function sends a command to ASIC</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">card_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptempbuffer</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">commandbuf</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;card_send_command: enter card_send_command... size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">commandbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">commandbuf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ptempbuffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* check for odd word */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Must force to be 32 bit aligned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">ft1000_write_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">commandbuf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">,</span>
			      <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>DEBUG("card<em>send</em>command: Message sent\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><hr />

<p>Function:   dsp_reload</p>

<p>Synopsis:   This function is called to load or reload the DSP</p>

<p>Arguments:  ft1000dev - device structure</p>

<h2> Returns:    None</h2></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">dsp_reload</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">templong</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pft1000info</span><span class="p">;</span>

	<span class="n">pft1000info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Program Interrupt Mask register */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_IMASK</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
	<span class="n">tempword</span> <span class="o">|=</span> <span class="n">ASIC_RESET_BIT</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Reset Register = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>

	<span class="cm">/* Toggle DSP reset */</span>
	<span class="n">card_reset_dsp</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">card_reset_dsp</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">HOST_INTF_BE</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_CTRL</span><span class="p">);</span>

	<span class="cm">/* Let&#39;s check for FEFE */</span>
	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">ft1000_read_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DPRAM_FEFE_INDX</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">templong</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;templong (fefe) = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">templong</span><span class="p">);</span>

	<span class="cm">/* call codeloader */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">scram_dnldr</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">pFileStart</span><span class="p">,</span> <span class="n">FileLength</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;dsp_reload returned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><hr />

<p>Function:   ft1000<em>reset</em>asic
Description: This function will call the Card Service function to reset the
            ASIC.
Input:
    dev    - device structure
Output:
    none</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_reset_asic</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pFt1000Dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_reset_asic called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Let&#39;s use the register provided by the Magnemite ASIC to reset the</span>
<span class="cm">	 * ASIC and DSP.</span>
<span class="cm">	 */</span>
	<span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="p">(</span><span class="n">DSP_RESET_BIT</span> <span class="o">|</span> <span class="n">ASIC_RESET_BIT</span><span class="p">),</span>
			      <span class="n">FT1000_REG_RESET</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* set watermark to -1 in order to not generate an interrupt */</span>
	<span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_WATERMARK</span><span class="p">);</span>

	<span class="cm">/* clear interrupts */</span>
	<span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw: interrupt status register = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
	<span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">);</span>
	<span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_ISR</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw: interrupt status register = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><hr />

<p>Function:   ft1000<em>reset</em>card
Description: This function will reset the card
Input:
    dev    - device structure
Output:
    status - FALSE (card reset fail)
             TRUE  (card reset successful)</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_reset_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pFt1000Dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prov_record</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_reset_card called.....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fCondResetPend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fProvComplete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Make sure we free any memory reserve for provisioning */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_reset_card:deleting provisioning record</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span>
		    <span class="n">list_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">prov_record</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_reset_card: reset asic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ft1000_reset_asic</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_reset_card: call dsp_reload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dsp_reload</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;dsp reload successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Initialize DSP heartbeat area */</span>
	<span class="n">ft1000_write_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span> <span class="n">ho_mag</span><span class="p">,</span>
			     <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">);</span>
	<span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">FT1000_MAG_HI_HO</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
			    <span class="n">FT1000_MAG_HI_HO_INDX</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_reset_card:hi_ho value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempword</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fCondResetPend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ftnet_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ft1000_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ft1000_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ft1000_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ft1000_netdev_stats</span><span class="p">,</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><hr />

<p>Function:    init<em>ft1000</em>netdev</p>

<p>Parameters:  ft1000dev  - device structure</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function initialize the network device</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">init_ft1000_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dpram_blk</span> <span class="o">*</span><span class="n">pdpram_blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">card_nr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gCardIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Enter init_ft1000_netdev...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;init_ft1000_netdev: can not allocate network device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pInfo</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span><span class="p">));</span>

	<span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;init_ft1000_netdev: network device name is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card_nr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">card_nr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">card_nr</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gCardIndex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t parse netdev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_net</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">CardNumber</span> <span class="o">=</span> <span class="n">gCardIndex</span><span class="p">;</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;card number = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">CardNumber</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ft1000: Invalid device name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_net</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span><span class="p">));</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">dpram_lock</span><span class="p">);</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">pFt1000Dev</span> <span class="o">=</span> <span class="n">ft1000dev</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">ft1000_reset</span> <span class="o">=</span> <span class="n">ft1000_reset</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">fifo_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">DeviceCreated</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">fAppMsgPend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">fCondResetPend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">usbboot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">dspalive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tempbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tempbuf</span><span class="p">));</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ftnet_ops</span><span class="p">;</span>

	<span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Initialize free_buff_lock and freercvpool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_buff_lock</span><span class="p">);</span>

	<span class="cm">/* initialize a list of buffers to be use for queuing</span>
<span class="cm">	 * up receive command data</span>
<span class="cm">	 */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>

	<span class="cm">/* create list of free buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_OF_FREE_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get memory for DPRAM_DATA link list */</span>
		<span class="n">pdpram_blk</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dpram_blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdpram_blk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Get a block of memory to store command data */</span>
		<span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">pbuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_CMD_SQSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">pbuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* link provisioning data */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">numofmsgbuf</span> <span class="o">=</span> <span class="n">NUM_OF_FREE_BUFFERS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free:</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdpram_blk</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dpram_blk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err_net:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><hr />

<p>Function:    reg<em>ft1000</em>netdev</p>

<p>Parameters:  ft1000dev  - device structure</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function register the network driver</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">reg_ft1000_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
	<span class="n">pInfo</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Enter reg_ft1000_netdev...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">AsicID</span><span class="p">,</span> <span class="n">FT1000_REG_ASIC_ID</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">pInfo</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;reg_ft1000_netdev: could not register network device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ft1000_create_dev</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;reg_ft1000_netdev returned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ft1000_reset_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><hr />

<p>Function:    ft1000<em>usb</em>transmit_complete</p>

<p>Parameters:  urb  - transmitted usb urb</p>

<p>Returns:     none</p>

<p>Description: This is the callback function when a urb is transmitted</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">ft1000_usb_transmit_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: TX status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><hr />

<p>Function:   ft1000<em>copy</em>down_pkt
Description: This function will take an ethernet packet and convert it to
            a Flarion packet prior to sending it to the ASIC Downlink
            FIFO.
Input:
    dev    - device structure
    packet - address of ethernet packet
    len    - length of IP packet
Output:
    status - FAILURE
             SUCCESS</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_copy_down_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">packet</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">pFt1000Dev</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">pFt1000Dev</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="n">hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">CardReady</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_copy_down_pkt::Card Not Ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Error:ft1000_copy_down_pkt:Message Size Overflow!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">));</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">destination</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">portdest</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">sh_str_id</span> <span class="o">=</span> <span class="mh">0x91</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">^</span> <span class="n">hdr</span><span class="p">.</span><span class="n">source</span> <span class="o">^</span> <span class="n">hdr</span><span class="p">.</span><span class="n">destination</span> <span class="o">^</span>
	    <span class="n">hdr</span><span class="p">.</span><span class="n">portdest</span> <span class="o">^</span> <span class="n">hdr</span><span class="p">.</span><span class="n">portsrc</span> <span class="o">^</span> <span class="n">hdr</span><span class="p">.</span><span class="n">sh_str_id</span> <span class="o">^</span> <span class="n">hdr</span><span class="p">.</span><span class="n">control</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">)]),</span> <span class="n">packet</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span>
			  <span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddr</span><span class="p">),</span>
			  <span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			  <span class="n">ft1000_usb_transmit_complete</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pFt1000Dev</span><span class="p">);</span>

	<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000 failed tx_urb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><hr />

<p>Function:    ft1000<em>start</em>xmit</p>

<p>Parameters:  skb - socket buffer to be sent
             dev - network device</p>

<p>Returns:     none</p>

<p>Description: transmit a ethernet packet</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">pFt1000Dev</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">pFt1000Dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw: ft1000_start_xmit:skb == NULL!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FT1000_STATUS_CLOSING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;network driver is closed, return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pipe</span> <span class="o">=</span>
	    <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddr</span><span class="p">);</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">usb_pipeout</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Drop packet is mediastate is down */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_start_xmit:mediastate is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ENET_HEADER_SIZE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ENET_MAX_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Drop packet which has invalid size */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_start_xmit:invalid ethernet length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ft1000_copy_down_pkt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">+</span> <span class="n">ENET_HEADER_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span>
			     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ENET_HEADER_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><hr />

<p>Function:   ft1000<em>copy</em>up_pkt
Description: This function will take a packet from the FIFO up link and
            convert it into an ethernet packet and deliver it to the IP stack
Input:
    urb - the receiving usb urb</p>

<p>Output:
    status - FAILURE
             SUCCESS</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_copy_up_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pFt1000Dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lena</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptemp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">chksum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FT1000_STATUS_CLOSING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;network driver is closed, return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Read length</p></td><td class="code"><div class="highlight"><pre>	<span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">;</span>
	<span class="n">lena</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

	<span class="n">chksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>

	<span class="n">tempword</span> <span class="o">=</span> <span class="o">*</span><span class="n">chksum</span><span class="o">++</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tempword</span> <span class="o">^=</span> <span class="o">*</span><span class="n">chksum</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">!=</span> <span class="o">*</span><span class="n">chksum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ft1000_submit_rx_urb</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_copy_up_pkt: No Network buffers available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ft1000_submit_rx_urb</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* subtract the number of bytes read already */</span>
	<span class="n">ptemp</span> <span class="o">=</span> <span class="n">pbuffer</span><span class="p">;</span>

	<span class="cm">/* fake MAC address */</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x35</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbuffer</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">),</span>
	       <span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">));</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Add on 12 bytes for MAC address which was removed */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">lena</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

	<span class="n">ft1000_submit_rx_urb</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><hr />

<p>Function:   ft1000<em>submit</em>rx_urb
Description: the receiving function of the network driver</p>

<p>Input:
    info - a private structure contains the device information</p>

<p>Output:
    status - FAILURE
             SUCCESS</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_submit_rx_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">pFt1000Dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pFt1000Dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FT1000_STATUS_CLOSING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;network driver is closed, return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span>
			  <span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">bulk_in_endpointAddr</span><span class="p">),</span>
			  <span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">MAX_BUF_SIZE</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span> <span class="n">ft1000_copy_up_pkt</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pFt1000Dev</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ft1000_submit_rx_urb: submitting rx_urb %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><hr />

<p>Function:    ft1000_open</p>

<p>Parameters:
             dev - network device</p>

<p>Returns:     none</p>

<p>Description: open the network driver</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_open is called for card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">CardNumber</span><span class="p">);</span>

	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">ConTm</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">ProgConStat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ft1000_submit_rx_urb</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><hr />

<p>Function:    ft1000_close</p>

<p>Parameters:
             net - network device</p>

<p>Returns:     none</p>

<p>Description: close the network driver</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">ft1000_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">pFt1000Dev</span><span class="p">;</span>

	<span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FT1000_STATUS_CLOSING</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_close: pInfo=%p, ft1000dev=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="p">,</span> <span class="n">ft1000dev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FT1000_STATUS_CLOSING</span><span class="p">;</span>

	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">ProgConStat</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">ft1000_netdev_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><hr />

<p>Function:   ft1000_chkcard
Description: This function will check if the device is presently available on
            the system.
Input:
    dev    - device structure
Output:
    status - FALSE (device is not present)
             TRUE  (device is present)</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_chkcard</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fCondResetPend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span>
		    <span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_chkcard:Card is being reset, return FALSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Mask register is used to check for device presence since it is never</span>
<span class="cm">	 * set to zero.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_IMASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span>
		    <span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_chkcard: IMASK = 0 Card not detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* The system will return the value of 0xffff for the version register</span>
<span class="cm">	 * if the device is not present.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_ASIC_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">!=</span> <span class="mh">0x1b01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FT1000_STATUS_CLOSING</span><span class="p">;</span>
		<span class="n">DEBUG</span>
		    <span class="p">(</span><span class="s">&quot;ft1000_hw:ft1000_chkcard: Version = 0xffff Card not detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><hr />

<p>Function:   ft1000<em>receive</em>cmd
Description: This function will read a message from the dpram area.
Input:
   dev - network device structure
   pbuffer - caller supply address to buffer
   pnxtph - pointer to next pseudo header
Output:
  Status = 0 (unsuccessful)
         = 1 (successful)</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">bool</span> <span class="nf">ft1000_receive_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">maxsz</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pnxtph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">ppseudohdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span>
	    <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_PH_LEN</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span>
				<span class="n">FT1000_MAG_PH_LEN_INDX</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="n">PSEUDOSZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">maxsz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_receive_cmd:Invalid command length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ppseudohdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pbuffer</span><span class="p">;</span>
		<span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DPRAM_MAG_RX_BASE</span><span class="p">,</span>
				      <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">);</span>
		<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DPRAM_MAG_RX_BASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				      <span class="n">FT1000_REG_DPRAM_ADDR</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span>
						 <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>
			<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span>
						 <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">);</span>
			<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* copy odd aligned word */</span>
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DPDATAL</span><span class="p">);</span>

		<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_DPDATAH</span><span class="p">);</span>

		<span class="n">pbuffer</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* copy odd byte from fifo */</span>
			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
						 <span class="n">FT1000_REG_DPRAM_DATA</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tempword</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Check if pseudo header checksum is good</span>
<span class="cm">		 * Calculate pseudo header checksum</span>
<span class="cm">		 */</span>
		<span class="n">tempword</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppseudohdr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tempword</span> <span class="o">^=</span> <span class="o">*</span><span class="n">ppseudohdr</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tempword</span> <span class="o">!=</span> <span class="o">*</span><span class="n">ppseudohdr</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_dsp_prov</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prov_record</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">ppseudo_hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">pmsg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">TempShortBuf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;*** DspProv Entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;DSP Provisioning List Entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Check if doorbell is available */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;check if doorbell is cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_dsp_prov::ft1000_read_register error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_dsp_prov:message drop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
					     <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;*** Provision Data Sent to DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* Send provisioning data */</span>
			<span class="n">ptr</span> <span class="o">=</span>
			    <span class="n">list_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">prov_record</span><span class="p">,</span>
				       <span class="n">list</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">PSEUDOSZ</span><span class="p">;</span>

			<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pmsg</span><span class="p">;</span>
			<span class="cm">/* Insert slow queue sequence number */</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">squeseqnum</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Calculate new checksum */</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">^=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">TempShortBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">TempShortBuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TempShortBuf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ppseudo_hdr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ft1000_write_dpram32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">TempShortBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">,</span>
						  <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>

			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pprov_data</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;DSP Provisioning List Entry finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fProvComplete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_proc_drvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">msgtype</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_msg</span> <span class="o">*</span><span class="n">pmediamsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_init_msg</span> <span class="o">*</span><span class="n">pdspinitmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drv_msg</span> <span class="o">*</span><span class="n">pdrvmsg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">ppseudo_hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">pmsg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">byte</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">u16</span> <span class="n">wrd</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">convert</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">cmdbuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1600</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdbuffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">cmdbuffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

<span class="cp">#ifdef JDEBUG</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_proc_drvmsg:cmdbuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;0x%x, 0x%x, 0x%x, 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmdbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">cmdbuffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmdbuffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
			      <span class="n">cmdbuffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">],</span> <span class="n">cmdbuffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;0x%x &quot;</span><span class="p">,</span> <span class="n">cmdbuffer</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">pdrvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drv_msg</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmdbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">msgtype</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pdrvmsg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_proc_drvmsg:Command message type = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msgtype</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">msgtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEDIA_STATE</span>:<span class="p">{</span>
			<span class="n">DEBUG</span>
			    <span class="p">(</span><span class="s">&quot;ft1000_proc_drvmsg:Command message type = MEDIA_STATE&quot;</span><span class="p">);</span>

			<span class="n">pmediamsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">media_msg</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmdbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ProgConStat</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pmediamsg</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Media is up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">NetDevRegDone</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span>
									 <span class="n">net</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Media is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">NetDevRegDone</span><span class="p">)</span> <span class="p">{</span>
						<span class="p">}</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">ConTm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Media is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">mediastate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">ConTm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">DSP_INIT_MSG</span>:<span class="p">{</span>
			<span class="n">DEBUG</span>
			    <span class="p">(</span><span class="s">&quot;ft1000_proc_drvmsg:Command message type = DSP_INIT_MSG&quot;</span><span class="p">);</span>

			<span class="n">pdspinitmsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_init_msg</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmdbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">,</span> <span class="n">DSPVERSZ</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;DSPVER = 0x%2x 0x%2x 0x%2x 0x%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			      <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">HwSerNum</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">HwSerNum</span><span class="p">,</span>
			       <span class="n">HWSERNUMSZ</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">Sku</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">Sku</span><span class="p">,</span> <span class="n">SKUSZ</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">,</span> <span class="n">EUISZ</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;EUI64=%2x.%2x.%2x.%2x.%2x.%2x.%2x.%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			      <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			      <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">==</span>
			    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_init_msg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ProductMode</span><span class="p">,</span>
				       <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">ProductMode</span><span class="p">,</span> <span class="n">MODESZ</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">RfCalVer</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">RfCalVer</span><span class="p">,</span>
				       <span class="n">CALVERSZ</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">RfCalDate</span><span class="p">,</span> <span class="n">pdspinitmsg</span><span class="o">-&gt;</span><span class="n">RfCalDate</span><span class="p">,</span>
				       <span class="n">CALDATESZ</span><span class="p">);</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;RFCalVer = 0x%2x 0x%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">info</span><span class="o">-&gt;</span><span class="n">RfCalVer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">RfCalVer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">DSP_PROVISION</span>:<span class="p">{</span>
			<span class="n">DEBUG</span>
			    <span class="p">(</span><span class="s">&quot;ft1000_proc_drvmsg:Command message type = DSP_PROVISION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* kick off dspprov routine to start provisioning</span>
<span class="cm">			 * Send provisioning data to DSP</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prov_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">fProvComplete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_dsp_prov</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">fProvComplete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span>
				    <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DB_HB</span><span class="p">,</span>
							  <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
				<span class="n">DEBUG</span>
				    <span class="p">(</span><span class="s">&quot;FT1000:drivermsg:No more DSP provisioning data in dsp image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_proc_drvmsg:DSP PROVISION is done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">DSP_STORE_INFO</span>:<span class="p">{</span>
			<span class="n">DEBUG</span>
			    <span class="p">(</span><span class="s">&quot;ft1000_proc_drvmsg:Command message type = DSP_STORE_INFO&quot;</span><span class="p">);</span>

			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:drivermsg:Got DSP_STORE_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pdrvmsg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span> <span class="o">=</span> <span class="n">tempword</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_DSP_SESS_REC</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pdrvmsg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">tempword</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEBUG</span>
					    <span class="p">(</span><span class="s">&quot;FT1000:drivermsg:dsp info data = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="o">*</span><span class="n">pmsg</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">DSP_GET_INFO</span>:<span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:drivermsg:Got DSP_GET_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* copy dsp info block to dsp */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvMsgPend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* allow any outstanding ioctl to finish */</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
						 <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span>
				    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
							 <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">status</span> <span class="o">=</span>
					    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
								 <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* Put message into Slow Queue</span>
<span class="cm">			 * Form Pseudo header</span>
<span class="cm">			 */</span>
			<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span>
			    <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span><span class="p">);</span>
			<span class="n">ppseudo_hdr</span> <span class="o">=</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span>
			    <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span><span class="p">);</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">destination</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portdest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">sh_str_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">rsvd1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">rsvd2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">qos_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Insert slow queue sequence number */</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">squeseqnum</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Insert application id */</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Calculate new checksum */</span>
			<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">^=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>

			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7200</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ft1000_write_dpram32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span>
								  <span class="n">DSPInfoBlklen</span>
								  <span class="o">+</span> <span class="mi">22</span><span class="p">));</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">,</span>
						  <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvMsgPend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">GET_DRV_ERR_RPT_MSG</span>:<span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:drivermsg:Got GET_DRV_ERR_RPT_MSG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* copy driver error message to dsp */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvMsgPend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* allow any outstanding ioctl to finish */</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
						 <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span>
				    <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span>
							 <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span>
					<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Put message into Slow Queue</span>
<span class="cm">				 * Form Pseudo header</span>
<span class="cm">				 */</span>
				<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">ppseudo_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pmsg</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x0012</span><span class="p">);</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">destination</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portdest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">sh_str_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">rsvd1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">rsvd2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">qos_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* Insert slow queue sequence number */</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">squeseqnum</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* Insert application id */</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* Calculate new checksum */</span>
				<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">^=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>

				<span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">RSP_DRV_ERR_RPT_MSG</span><span class="p">);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x000e</span><span class="p">);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="n">convert</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">convert</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">convert</span><span class="p">.</span><span class="n">wrd</span><span class="p">;</span>
				<span class="n">convert</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">convert</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">convert</span><span class="p">.</span><span class="n">wrd</span><span class="p">;</span>
				<span class="o">*</span><span class="n">pmsg</span><span class="o">++</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span><span class="p">);</span>

				<span class="n">card_send_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						 <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="mh">0x0012</span> <span class="o">+</span> <span class="n">PSEUDOSZ</span><span class="p">));</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvMsgPend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmdbuffer</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;return from ft1000_proc_drvmsg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ft1000_poll</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

    <span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">modulo</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">portid</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">nxtph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dpram_blk</span> <span class="o">*</span><span class="n">pdpram_blk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">ppseudo_hdr</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ft1000_chkcard</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_poll::ft1000_chkcard: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">status</span> <span class="p">)</span>
    <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_RX</span><span class="p">)</span> <span class="p">{</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">modulo</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">modulo</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x201</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">portid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">portid</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">MAX_CMD_SQSIZE</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">portid</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">case</span> <span class="n">DRIVERID</span>:
                        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_poll: FT1000_REG_DOORBELL message type: FT1000_DB_DPRAM_RX : portid DRIVERID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

                        <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_proc_drvmsg</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span> <span class="p">)</span>
                            <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="n">DSPBCMSGID</span>:</pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>This is a dsp broadcast message
Check which application has registered for dsp broadcast messages</p></td><td class="code"><div class="highlight"><pre>    	    	        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        	           <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">DspBCMsgFlag</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                                         <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NumOfMsg</span> <span class="o">&lt;</span> <span class="n">MAX_MSG_LIMIT</span><span class="p">)</span>  <span class="p">)</span>
			   <span class="p">{</span>
			       <span class="n">nxtph</span> <span class="o">=</span> <span class="n">FT1000_DPRAM_RX_BASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			       <span class="n">pdpram_blk</span> <span class="o">=</span> <span class="n">ft1000_get_buffer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>
			       <span class="k">if</span> <span class="p">(</span><span class="n">pdpram_blk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			           <span class="k">if</span> <span class="p">(</span> <span class="n">ft1000_receive_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">MAX_CMD_SQSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nxtph</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">ppseudo_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Put message into the appropriate application block</p></td><td class="code"><div class="highlight"><pre>				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nRxMsg</span><span class="o">++</span><span class="p">;</span>
				       <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				       <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">);</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NumOfMsg</span><span class="o">++</span><span class="p">;</span>
				       <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				       <span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_dpram_msg</span><span class="p">);</span>
                                   <span class="p">}</span>
                                   <span class="k">else</span> <span class="p">{</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nRxMsgMiss</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Put memory back to free pool</p></td><td class="code"><div class="highlight"><pre>				       <span class="n">ft1000_free_buffer</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>
				       <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;pdpram_blk::ft1000_get_buffer NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                   <span class="p">}</span>
                               <span class="p">}</span>
                               <span class="k">else</span> <span class="p">{</span>
                                   <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Out of memory in free receive command pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                   <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nRxMsgMiss</span><span class="o">++</span><span class="p">;</span>
                               <span class="p">}</span>
                           <span class="p">}</span>
	                <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="nl">default:</span>
                        <span class="n">pdpram_blk</span> <span class="o">=</span> <span class="n">ft1000_get_buffer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">pdpram_blk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                           <span class="k">if</span> <span class="p">(</span> <span class="n">ft1000_receive_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">MAX_CMD_SQSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nxtph</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ppseudo_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Search for correct application block</p></td><td class="code"><div class="highlight"><pre>                               <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                   <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_id</span> <span class="o">==</span> <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portdest</span><span class="p">)</span> <span class="p">{</span>
                                       <span class="k">break</span><span class="p">;</span>
                                   <span class="p">}</span>
                               <span class="p">}</span>

                               <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_NUM_APP</span><span class="p">)</span> <span class="p">{</span>
                                   <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_parse_dpram_msg: No application matching id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portdest</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Put memory back to free pool</p></td><td class="code"><div class="highlight"><pre>                                   <span class="n">ft1000_free_buffer</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>
                               <span class="p">}</span>
                               <span class="k">else</span> <span class="p">{</span>
                                   <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NumOfMsg</span> <span class="o">&gt;</span> <span class="n">MAX_MSG_LIMIT</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Put memory back to free pool</p></td><td class="code"><div class="highlight"><pre>	                               <span class="n">ft1000_free_buffer</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>
                                   <span class="p">}</span>
                                   <span class="k">else</span> <span class="p">{</span>
                                       <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nRxMsg</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Put message into the appropriate application block</p></td><td class="code"><div class="highlight"><pre>                                       <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">);</span>
            			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NumOfMsg</span><span class="o">++</span><span class="p">;</span>
                                   <span class="p">}</span>
                               <span class="p">}</span>
                           <span class="p">}</span>
                           <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Put memory back to free pool</p></td><td class="code"><div class="highlight"><pre>                               <span class="n">ft1000_free_buffer</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>
                           <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Out of memory in free receive command pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:dpc:Invalid total length for SlowQ = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DB_DPRAM_RX</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DSP_ASIC_RESET</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Let's reset the ASIC from the Host side as well</p></td><td class="code"><div class="highlight"><pre>            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ASIC_RESET_BIT</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">ASIC_RESET_BIT</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_RESET</span><span class="p">);</span>
                <span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
                <span class="n">i</span><span class="o">++</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">100</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Unable to reset ASIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Program WMARK register</p></td><td class="code"><div class="highlight"><pre>            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x600</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_WATERMARK</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>clear ASIC reset doorbell</p></td><td class="code"><div class="highlight"><pre>            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DSP_ASIC_RESET</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
            <span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_ASIC_RESET_REQ</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_poll: FT1000_REG_DOORBELL message type:  FT1000_ASIC_RESET_REQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>clear ASIC reset request from DSP</p></td><td class="code"><div class="highlight"><pre>            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_ASIC_RESET_REQ</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HOST_INTF_BE</span><span class="p">,</span> <span class="n">FT1000_REG_SUP_CTRL</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>copy dsp session record from Adapter block</p></td><td class="code"><div class="highlight"><pre>            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_dpram32</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSPSess</span><span class="p">.</span><span class="n">Rec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1024</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Program WMARK register</p></td><td class="code"><div class="highlight"><pre>            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x600</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_WATERMARK</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>ring doorbell to tell DSP that ASIC is out of reset</p></td><td class="code"><div class="highlight"><pre>            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_ASIC_RESET_DSP</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_COND_RESET</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_poll: FT1000_REG_DOORBELL message type:  FT1000_DB_COND_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fAppMsgPend</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>Reset ASIC and DSP</p></td><td class="code"><div class="highlight"><pre>                <span class="n">status</span>    <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">FT1000_MAG_DSP_TIMER0_INDX</span><span class="p">);</span>
                <span class="n">status</span>    <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">FT1000_MAG_DSP_TIMER1_INDX</span><span class="p">);</span>
                <span class="n">status</span>    <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER2</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">FT1000_MAG_DSP_TIMER2_INDX</span><span class="p">);</span>
                <span class="n">status</span>    <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_TIMER3</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DSP_TIME</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">FT1000_MAG_DSP_TIMER3_INDX</span><span class="p">);</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvErrNum</span> <span class="o">=</span> <span class="n">DSP_CONDRESET_INFO</span><span class="p">;</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_hw:DSP conditional reset requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">ft1000_reset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">fProvComplete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">fCondResetPend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FT1000_DB_COND_RESET</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>

    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
