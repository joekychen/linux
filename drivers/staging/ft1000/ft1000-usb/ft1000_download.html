<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › ft1000 › ft1000-usb › ft1000_download.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ft1000_download.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>=====================================================
CopyRight (C) 2007 Qualcomm Inc. All Rights Reserved.</p>

<p>This file is part of Express Card USB Driver</p>

<h1>$Id:</h1>

<p>20090926; aelias; removed compiler warnings; ubuntu 9.04; 2.6.28-15-generic</p></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &quot;ft1000_usb.h&quot;</span>


<span class="cp">#define  DWNLD_HANDSHAKE_LOC     0x02</span>
<span class="cp">#define  DWNLD_TYPE_LOC          0x04</span>
<span class="cp">#define  DWNLD_SIZE_MSW_LOC      0x06</span>
<span class="cp">#define  DWNLD_SIZE_LSW_LOC      0x08</span>
<span class="cp">#define  DWNLD_PS_HDR_LOC        0x0A</span>

<span class="cp">#define  MAX_DSP_WAIT_LOOPS      40</span>
<span class="cp">#define  DSP_WAIT_SLEEP_TIME     1000       </span><span class="cm">/* 1 millisecond */</span><span class="cp"></span>
<span class="cp">#define  DSP_WAIT_DISPATCH_LVL   50         </span><span class="cm">/* 50 usec */</span><span class="cp"></span>

<span class="cp">#define  HANDSHAKE_TIMEOUT_VALUE 0xF1F1</span>
<span class="cp">#define  HANDSHAKE_RESET_VALUE   0xFEFE   </span><span class="cm">/* When DSP requests startover */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_RESET_VALUE_USB   0xFE7E   </span><span class="cm">/* When DSP requests startover */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_DSP_BL_READY  0xFEFE   </span><span class="cm">/* At start DSP writes this when bootloader ready */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_DSP_BL_READY_USB  0xFE7E   </span><span class="cm">/* At start DSP writes this when bootloader ready */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_DRIVER_READY  0xFFFF   </span><span class="cm">/* Driver writes after receiving 0xFEFE */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_SEND_DATA     0x0000   </span><span class="cm">/* DSP writes this when ready for more data */</span><span class="cp"></span>

<span class="cp">#define  HANDSHAKE_REQUEST       0x0001   </span><span class="cm">/* Request from DSP */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_RESPONSE      0x0000   </span><span class="cm">/* Satisfied DSP request */</span><span class="cp"></span>

<span class="cp">#define  REQUEST_CODE_LENGTH     0x0000</span>
<span class="cp">#define  REQUEST_RUN_ADDRESS     0x0001</span>
<span class="cp">#define  REQUEST_CODE_SEGMENT    0x0002   </span><span class="cm">/* In WORD count */</span><span class="cp"></span>
<span class="cp">#define  REQUEST_DONE_BL         0x0003</span>
<span class="cp">#define  REQUEST_DONE_CL         0x0004</span>
<span class="cp">#define  REQUEST_VERSION_INFO    0x0005</span>
<span class="cp">#define  REQUEST_CODE_BY_VERSION 0x0006</span>
<span class="cp">#define  REQUEST_MAILBOX_DATA    0x0007</span>
<span class="cp">#define  REQUEST_FILE_CHECKSUM   0x0008</span>

<span class="cp">#define  STATE_START_DWNLD       0x01</span>
<span class="cp">#define  STATE_BOOT_DWNLD        0x02</span>
<span class="cp">#define  STATE_CODE_DWNLD        0x03</span>
<span class="cp">#define  STATE_DONE_DWNLD        0x04</span>
<span class="cp">#define  STATE_SECTION_PROV      0x05</span>
<span class="cp">#define  STATE_DONE_PROV         0x06</span>
<span class="cp">#define  STATE_DONE_FILE         0x07</span>

<span class="cp">#define  MAX_LENGTH              0x7f0</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Temporary download mechanism for Magnemite</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define  DWNLD_MAG_TYPE_LOC          0x00</span>
<span class="cp">#define  DWNLD_MAG_LEN_LOC           0x01</span>
<span class="cp">#define  DWNLD_MAG_ADDR_LOC          0x02</span>
<span class="cp">#define  DWNLD_MAG_CHKSUM_LOC        0x03</span>
<span class="cp">#define  DWNLD_MAG_VAL_LOC           0x04</span>

<span class="cp">#define  HANDSHAKE_MAG_DSP_BL_READY  0xFEFE0000   </span><span class="cm">/* At start DSP writes this when bootloader ready */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_MAG_DSP_ENTRY     0x01000000   </span><span class="cm">/* Dsp writes this to request for entry address */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_MAG_DSP_DATA      0x02000000   </span><span class="cm">/* Dsp writes this to request for data block */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_MAG_DSP_DONE      0x03000000   </span><span class="cm">/* Dsp writes this to indicate download done */</span><span class="cp"></span>

<span class="cp">#define  HANDSHAKE_MAG_DRV_READY     0xFFFF0000   </span><span class="cm">/* Driver writes this to indicate ready to download */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_MAG_DRV_DATA      0x02FECDAB   </span><span class="cm">/* Driver writes this to indicate data available to DSP */</span><span class="cp"></span>
<span class="cp">#define  HANDSHAKE_MAG_DRV_ENTRY     0x01FECDAB   </span><span class="cm">/* Driver writes this to indicate entry point to DSP */</span><span class="cp"></span>

<span class="cp">#define  HANDSHAKE_MAG_TIMEOUT_VALUE 0xF1F1</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>New Magnemite downloader</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define  DWNLD_MAG1_HANDSHAKE_LOC     0x00</span>
<span class="cp">#define  DWNLD_MAG1_TYPE_LOC          0x01</span>
<span class="cp">#define  DWNLD_MAG1_SIZE_LOC          0x02</span>
<span class="cp">#define  DWNLD_MAG1_PS_HDR_LOC        0x03</span>

<span class="k">struct</span> <span class="n">dsp_file_hdr</span> <span class="p">{</span>
   <span class="kt">long</span>              <span class="n">version_id</span><span class="p">;</span>          <span class="c1">// Version ID of this image format.</span>
   <span class="kt">long</span>              <span class="n">package_id</span><span class="p">;</span>          <span class="c1">// Package ID of code release.</span>
   <span class="kt">long</span>              <span class="n">build_date</span><span class="p">;</span>          <span class="c1">// Date/time stamp when file was built.</span>
   <span class="kt">long</span>              <span class="n">commands_offset</span><span class="p">;</span>     <span class="c1">// Offset to attached commands in Pseudo Hdr format.</span>
   <span class="kt">long</span>              <span class="n">loader_offset</span><span class="p">;</span>       <span class="c1">// Offset to bootloader code.</span>
   <span class="kt">long</span>              <span class="n">loader_code_address</span><span class="p">;</span> <span class="c1">// Start address of bootloader.</span>
   <span class="kt">long</span>              <span class="n">loader_code_end</span><span class="p">;</span>     <span class="c1">// Where bootloader code ends.</span>
   <span class="kt">long</span>              <span class="n">loader_code_size</span><span class="p">;</span>
   <span class="kt">long</span>              <span class="n">version_data_offset</span><span class="p">;</span> <span class="c1">// Offset were scrambled version data begins.</span>
   <span class="kt">long</span>              <span class="n">version_data_size</span><span class="p">;</span>   <span class="c1">// Size, in words, of scrambled version data.</span>
   <span class="kt">long</span>              <span class="n">nDspImages</span><span class="p">;</span>          <span class="c1">// Number of DSP images in file.</span>
<span class="p">};</span>

<span class="cp">#pragma pack(1)</span>
<span class="k">struct</span> <span class="n">dsp_image_info</span> <span class="p">{</span>
   <span class="kt">long</span>              <span class="n">coff_date</span><span class="p">;</span>           <span class="c1">// Date/time when DSP Coff image was built.</span>
   <span class="kt">long</span>              <span class="n">begin_offset</span><span class="p">;</span>        <span class="c1">// Offset in file where image begins.</span>
   <span class="kt">long</span>              <span class="n">end_offset</span><span class="p">;</span>          <span class="c1">// Offset in file where image begins.</span>
   <span class="kt">long</span>              <span class="n">run_address</span><span class="p">;</span>         <span class="c1">// On chip Start address of DSP code.</span>
   <span class="kt">long</span>              <span class="n">image_size</span><span class="p">;</span>          <span class="c1">// Size of image.</span>
   <span class="kt">long</span>              <span class="n">version</span><span class="p">;</span>             <span class="c1">// Embedded version # of DSP code.</span>
   <span class="kt">unsigned</span> <span class="kt">short</span>    <span class="n">checksum</span><span class="p">;</span>            <span class="c1">// DSP File checksum</span>
   <span class="kt">unsigned</span> <span class="kt">short</span>    <span class="n">pad1</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><hr />

<p>Function:    check<em>usb</em>db</p>

<p>Parameters:  struct ft1000_device  - device structure</p>

<p>Returns:     0 - success</p>

<p>Description: This function checks if the doorbell register is cleared</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">u32</span> <span class="nf">check_usb_db</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loopcnt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">loopcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">loopcnt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span>
					       <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;check_usb_db: read FT1000_REG_DOORBELL value is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:Got checkusb doorbell</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">,</span>
						<span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span>
						<span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>  <span class="mh">0x8000</span><span class="p">,</span>
						<span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">loopcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">loopcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">loopcnt</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span>
					       <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:check_usb_db:Doorbell = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">loopcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;check_usb_db: door bell is cleared, return 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">HANDSHAKE_MAG_TIMEOUT_VALUE</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><hr />

<p>Function:    get_handshake</p>

<p>Parameters:  struct ft1000<em>device  - device structure
             u16 expected</em>value - the handshake value expected</p>

<p>Returns:     handshakevalue - success
             HANDSHAKE<em>TIMEOUT</em>VALUE - failure</p>

<p>Description: This function gets the handshake and compare with the expected value</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">u16</span> <span class="nf">get_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">expected_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">handshake</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loopcnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pft1000info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="n">loopcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">loopcnt</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need to clear downloader doorbell if Hartley ASIC */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>  <span class="n">FT1000_DB_DNLD_RX</span><span class="p">,</span>
						<span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">fcodeldr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot; get_handshake: fcodeldr is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">fcodeldr</span><span class="p">);</span>
			<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">fcodeldr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">check_usb_db</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;get_handshake: check_usb_db failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
					<span class="n">FT1000_DB_DNLD_RX</span><span class="p">,</span>
					<span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
				<span class="n">DWNLD_MAG1_HANDSHAKE_LOC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">handshake</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">handshake</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">handshake</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HANDSHAKE_TIMEOUT_VALUE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">expected_value</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">HANDSHAKE_RESET_VALUE_USB</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">handshake</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span>
			<span class="n">loopcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">HANDSHAKE_TIMEOUT_VALUE</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><hr />

<p>Function:    put_handshake</p>

<p>Parameters:  struct ft1000<em>device  - device structure
             u16 handshake</em>value - handshake to be written</p>

<p>Returns:     none</p>

<p>Description: This function write the handshake value to the handshake location
             in DPRAM</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">put_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span><span class="n">u16</span> <span class="n">handshake_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tempx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">tempx</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">handshake_value</span><span class="p">;</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tempx</span><span class="p">);</span>

	<span class="n">tempword</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">tempx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">DWNLD_MAG1_HANDSHAKE_LOC</span><span class="p">,</span>
					<span class="n">tempword</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tempword</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">tempx</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">DWNLD_MAG1_HANDSHAKE_LOC</span><span class="p">,</span>
					<span class="n">tempword</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">FT1000_DB_DNLD_TX</span><span class="p">,</span>
					<span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_handshake_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">expected_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">handshake</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loopcnt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pft1000info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">loopcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">handshake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">loopcnt</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">tempbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">64</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">temp</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">temp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;tempbuf %d = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
					<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">tempbuf</span><span class="p">[</span><span class="n">temp</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
						<span class="n">DWNLD_MAG1_HANDSHAKE_LOC</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">handshake</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;handshake from read_dpram16 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">handshake</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">dspalive</span> <span class="o">==</span> <span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">tempbuf</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">handshake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">handshake</span> <span class="o">=</span> <span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">tempbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">dspalive</span> <span class="o">=</span>
						<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">tempbuf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
						<span class="n">DWNLD_MAG1_HANDSHAKE_LOC</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">handshake</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">loopcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">handshake</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">handshake</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">expected_value</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">HANDSHAKE_RESET_VALUE_USB</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">handshake</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">HANDSHAKE_TIMEOUT_VALUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_handshake_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span><span class="n">u16</span> <span class="n">handshake_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><hr />

<p>Function:    get<em>request</em>type</p>

<p>Parameters:  struct ft1000_device  - device structure</p>

<p>Returns:     request type - success</p>

<p>Description: This function returns the request type</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">u16</span> <span class="nf">get_request_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">request_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tempx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pft1000info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">bootmode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">fix_ft1000_read_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
				<span class="n">DWNLD_MAG1_TYPE_LOC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempx</span><span class="p">);</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tempx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
				<span class="n">DWNLD_MAG1_TYPE_LOC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tempx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tempx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">request_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">tempx</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">request_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_request_type_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">request_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tempx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pft1000info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">bootmode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">fix_ft1000_read_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
				<span class="n">DWNLD_MAG1_TYPE_LOC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempx</span><span class="p">);</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tempx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempx</span> <span class="o">=</span> <span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">tempbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">tempword</span> <span class="o">=</span> <span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">tempbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tempx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
					<span class="n">DWNLD_MAG1_TYPE_LOC</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tempx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">tempx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tempx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">request_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">tempx</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">request_type</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><hr />

<p>Function:    get<em>request</em>value</p>

<p>Parameters:  struct ft1000_device  - device structure</p>

<p>Returns:     request value - success</p>

<p>Description: This function returns the request value</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">long</span> <span class="nf">get_request_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pft1000info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">bootmode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">fix_ft1000_read_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
				<span class="n">DWNLD_MAG1_SIZE_LOC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
				<span class="n">DWNLD_MAG1_SIZE_LOC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">tempword</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
				<span class="n">DWNLD_MAG1_SIZE_LOC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><hr />

<p>Function:    put<em>request</em>value</p>

<p>Parameters:  struct ft1000<em>device  - device structure
             long lvalue - value to be put into DPRAM location DWNLD</em>MAG1<em>SIZE</em>LOC</p>

<p>Returns:     none</p>

<p>Description: This function writes a value to DWNLD<em>MAG1</em>SIZE_LOC</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">put_request_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="kt">long</span> <span class="n">lvalue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>    <span class="n">tempx</span><span class="p">;</span>
	<span class="n">u32</span>    <span class="n">status</span><span class="p">;</span>

	<span class="n">tempx</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">lvalue</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">fix_ft1000_write_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">DWNLD_MAG1_SIZE_LOC</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempx</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><hr />

<p>Function:    hdr_checksum</p>

<p>Parameters:  struct pseudo_hdr *pHdr - Pseudo header pointer</p>

<p>Returns:     checksum - success</p>

<p>Description: This function returns the checksum of the pseudo header</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">u16</span> <span class="nf">hdr_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">pHdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>   <span class="o">*</span><span class="n">usPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pHdr</span><span class="p">;</span>
	<span class="n">u16</span>   <span class="n">chksum</span><span class="p">;</span>


	<span class="n">chksum</span> <span class="o">=</span> <span class="p">((((((</span><span class="n">usPtr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">^</span>
	<span class="n">usPtr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">^</span> <span class="n">usPtr</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">chksum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_buffers</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">buff_w</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">buff_r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buff_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">buff_r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><hr />

<p>Function:    write_blk</p>

<p>Parameters:  struct ft1000<em>device  - device structure
             u16 **pUsFile - DSP image file pointer in u16
             u8  **pUcFile - DSP image file pointer in u8
             long   word</em>length - length of the buffer to be written
                                  to DPRAM</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function writes a block of DSP image to DPRAM</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">u32</span> <span class="nf">write_blk</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">**</span><span class="n">pUsFile</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">pUcFile</span><span class="p">,</span> <span class="kt">long</span> <span class="n">word_length</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">u32</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
   <span class="n">u16</span> <span class="n">dpram</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">loopcnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
   <span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
   <span class="n">u16</span> <span class="n">tempbuffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
   <span class="n">u16</span> <span class="n">resultbuffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pft1000info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>DEBUG("FT1000:download:start word<em>length = %d\n",(int)word</em>length);</p></td><td class="code"><div class="highlight"><pre>   <span class="n">dpram</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">DWNLD_MAG1_PS_HDR_LOC</span><span class="p">;</span>
   <span class="n">tempword</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="p">);</span>
   <span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
   <span class="n">Status</span> <span class="o">=</span> <span class="n">ft1000_write_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="p">,</span> <span class="n">tempword</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
   <span class="n">tempword</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="p">);</span>
   <span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
   <span class="n">Status</span> <span class="o">=</span> <span class="n">ft1000_write_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="o">++</span><span class="p">,</span> <span class="n">tempword</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

   <span class="o">*</span><span class="n">pUcFile</span> <span class="o">=</span> <span class="o">*</span><span class="n">pUcFile</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
   <span class="n">word_length</span><span class="o">--</span><span class="p">;</span>
   <span class="n">tempword</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">word_length</span><span class="p">;</span>
   <span class="n">word_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(;</span> <span class="n">word_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word_length</span><span class="o">--</span><span class="p">)</span> <span class="cm">/* In words */</span>
   <span class="p">{</span>
	   <span class="n">loopcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	      <span class="p">{</span>
		       <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		       <span class="p">{</span>
    		           <span class="n">tempbuffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="p">);</span>
			   <span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
   	    	           <span class="n">tempbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="p">);</span>
			   <span class="p">(</span><span class="o">*</span><span class="n">pUsFile</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			   <span class="o">*</span><span class="n">pUcFile</span> <span class="o">=</span> <span class="o">*</span><span class="n">pUcFile</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			   <span class="n">loopcnt</span><span class="o">++</span><span class="p">;</span>
			   <span class="n">tempword</span><span class="o">--</span><span class="p">;</span>
		       <span class="p">}</span>
		       <span class="k">else</span>
		       <span class="p">{</span>
			   <span class="n">tempbuffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			   <span class="n">tempbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                       <span class="p">}</span>
	      <span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>DEBUG("write<em>blk: loopcnt is %d\n", loopcnt);
DEBUG("write</em>blk: bootmode = %d\n", bootmode);
DEBUG("write_blk: dpram = %x\n", dpram);</p></td><td class="code"><div class="highlight"><pre>	      <span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">bootmode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	      <span class="p">{</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">dpram</span> <span class="o">&gt;=</span> <span class="mh">0x3F4</span><span class="p">)</span>
                     <span class="n">Status</span> <span class="o">=</span> <span class="n">ft1000_write_dpram32</span> <span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
	         <span class="k">else</span>
                    <span class="n">Status</span> <span class="o">=</span> <span class="n">ft1000_write_dpram32</span> <span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
	      <span class="p">}</span>
	      <span class="k">else</span>
	      <span class="p">{</span>
                 <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                 <span class="p">{</span>
                   <span class="n">Status</span> <span class="o">=</span> <span class="n">ft1000_write_dpram32</span> <span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
		   <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		   <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Work around for ASIC bit stuffing problem.</p></td><td class="code"><div class="highlight"><pre>		       <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfe00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xfe00</span><span class="p">)</span>
		       <span class="p">{</span>
      		           <span class="n">Status</span> <span class="o">=</span> <span class="n">ft1000_write_dpram32</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
		       <span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Let's check the data written</p></td><td class="code"><div class="highlight"><pre>	    	       <span class="n">Status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram32</span> <span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">resultbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
		       <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">tempbuffer</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfe00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xfe00</span><span class="p">)</span>
		       <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_buffers</span><span class="p">(</span><span class="n">tempbuffer</span><span class="p">,</span> <span class="n">resultbuffer</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:download:DPRAM write failed 1 during bootloading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
   			   <span class="n">Status</span> <span class="o">=</span> <span class="n">ft1000_read_dpram32</span> <span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">resultbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">check_buffers</span><span class="p">(</span><span class="n">tempbuffer</span><span class="p">,</span> <span class="n">resultbuffer</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:download:DPRAM write failed 2 during bootloading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			   
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_buffers</span><span class="p">(</span><span class="n">tempbuffer</span><span class="p">,</span> <span class="n">resultbuffer</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:download:DPRAM write failed 3 during bootloading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			    
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			    <span class="k">break</span><span class="p">;</span>

		    <span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="p">{</span>
                    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:download:Write failed tempbuffer[31] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempbuffer</span><span class="p">[</span><span class="mi">31</span><span class="p">]);</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	     <span class="p">}</span>
   	     <span class="n">dpram</span> <span class="o">=</span> <span class="n">dpram</span> <span class="o">+</span> <span class="n">loopcnt</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_dnld_complete</span> <span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>DEBUG("<strong>**</strong> usb<em>dnld</em>complete\n");</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><hr />

<p>Function:    write<em>blk</em>fifo</p>

<p>Parameters:  struct ft1000<em>device  - device structure
             u16 **pUsFile - DSP image file pointer in u16
             u8  **pUcFile - DSP image file pointer in u8
             long   word</em>length - length of the buffer to be written
                                  to DPRAM</p>

<p>Returns:     STATUS<em>SUCCESS - success
             STATUS</em>FAILURE - failure</p>

<p>Description: This function writes a block of DSP image to DPRAM</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">u32</span> <span class="nf">write_blk_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">**</span><span class="n">pUsFile</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">**</span><span class="n">pUcFile</span><span class="p">,</span> <span class="kt">long</span> <span class="n">word_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">byte_length</span><span class="p">;</span>

	<span class="n">byte_length</span> <span class="o">=</span> <span class="n">word_length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">byte_length</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">byte_length</span> <span class="o">%</span> <span class="mi">64</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">byte_length</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">byte_length</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">byte_length</span> <span class="o">=</span> <span class="mi">68</span><span class="p">;</span>

	<span class="n">usb_init_urb</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="o">*</span><span class="n">pUcFile</span><span class="p">,</span> <span class="n">byte_length</span><span class="p">);</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span>
			  <span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddr</span><span class="p">),</span>
			  <span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">byte_length</span><span class="p">,</span> <span class="n">usb_dnld_complete</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ft1000dev</span><span class="p">);</span>

	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pUsFile</span> <span class="o">=</span> <span class="o">*</span><span class="n">pUsFile</span> <span class="o">+</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pUcFile</span> <span class="o">=</span> <span class="o">*</span><span class="n">pUcFile</span> <span class="o">+</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><hr />

<p>Function:   scram_dnldr</p>

<p>Synopsis:   Scramble downloader for Harley based ASIC via USB interface</p>

<p>Arguments:  pFileStart              - pointer to start of file
             FileLength              - file length</p>

<h2> Returns:    status                  - return code</h2></td><td class="code"><div class="highlight"><pre><span class="n">u16</span> <span class="nf">scram_dnldr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pFileStart</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">FileLength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handshake</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">pseudo_header</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pseudo_header_len</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">word_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dsp_file_hdr</span> <span class="o">*</span><span class="n">file_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_image_info</span> <span class="o">*</span><span class="n">dsp_img_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">requested_version</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">correct_version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drv_msg</span> <span class="o">*</span><span class="n">mailbox_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">s_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">c_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">boot_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">code_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">image</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">loader_code_address</span><span class="p">,</span> <span class="n">loader_code_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">run_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">run_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">templong</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">image_chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">dpram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prov_record</span> <span class="o">*</span><span class="n">pprov_record</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">pft1000info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ft1000dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Entered   scram_dnldr...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">fcodeldr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">dspalive</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Get version id of file, at first 4 bytes of file, for newer files.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_START_DWNLD</span><span class="p">;</span>

	<span class="n">file_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_file_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pFileStart</span><span class="p">;</span>

	<span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">,</span> <span class="n">FT1000_REG_MAG_WATERMARK</span><span class="p">);</span>

	<span class="n">s_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span> <span class="o">+</span> <span class="n">file_hdr</span><span class="o">-&gt;</span><span class="n">loader_offset</span><span class="p">);</span>
	<span class="n">c_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span> <span class="o">+</span> <span class="n">file_hdr</span><span class="o">-&gt;</span><span class="n">loader_offset</span><span class="p">);</span>

	<span class="n">boot_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span> <span class="o">+</span> <span class="n">file_hdr</span><span class="o">-&gt;</span><span class="n">loader_code_end</span><span class="p">);</span>

	<span class="n">loader_code_address</span> <span class="o">=</span> <span class="n">file_hdr</span><span class="o">-&gt;</span><span class="n">loader_code_address</span><span class="p">;</span>
	<span class="n">loader_code_size</span> <span class="o">=</span> <span class="n">file_hdr</span><span class="o">-&gt;</span><span class="n">loader_code_size</span><span class="p">;</span>
	<span class="n">correct_version</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_DONE_FILE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STATE_START_DWNLD</span>:
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:STATE_START_DWNLD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span><span class="p">)</span>
				<span class="n">handshake</span> <span class="o">=</span>
				    <span class="n">get_handshake_usb</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
						      <span class="n">HANDSHAKE_DSP_BL_READY</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">handshake</span> <span class="o">=</span>
				    <span class="n">get_handshake</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
						  <span class="n">HANDSHAKE_DSP_BL_READY</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">HANDSHAKE_DSP_BL_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG</span>
				    <span class="p">(</span><span class="s">&quot;scram_dnldr: handshake is HANDSHAKE_DSP_BL_READY, call put_handshake(HANDSHAKE_DRIVER_READY)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">put_handshake</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
					      <span class="n">HANDSHAKE_DRIVER_READY</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUG</span>
				    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Handshake failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_BOOT_DWNLD</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_BOOT_DWNLD</span>:
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:STATE_BOOT_DWNLD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">bootmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">handshake</span> <span class="o">=</span> <span class="n">get_handshake</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">HANDSHAKE_REQUEST</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">HANDSHAKE_REQUEST</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Get type associated with the request.</span>
<span class="cm">				 */</span>
				<span class="n">request</span> <span class="o">=</span> <span class="n">get_request_type</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">REQUEST_RUN_ADDRESS</span>:
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:REQUEST_RUN_ADDRESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
							  <span class="n">loader_code_address</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_CODE_LENGTH</span>:
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:REQUEST_CODE_LENGTH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
							  <span class="n">loader_code_size</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_DONE_BL</span>:
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:REQUEST_DONE_BL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="cm">/* Reposition ptrs to beginning of code section */</span>
					<span class="n">s_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">boot_end</span><span class="p">);</span>
					<span class="n">c_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">boot_end</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>DEBUG("FT1000:download:s<em>file = 0x%8x\n", (int)s</em>file);
DEBUG("FT1000:download:c<em>file = 0x%8x\n", (int)c</em>file);</p></td><td class="code"><div class="highlight"><pre>					<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_CODE_DWNLD</span><span class="p">;</span>
					<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">fcodeldr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_CODE_SEGMENT</span>:</pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>DEBUG("FT1000:REQUEST<em>CODE</em>SEGMENT\n");</p></td><td class="code"><div class="highlight"><pre>					<span class="n">word_length</span> <span class="o">=</span>
					    <span class="n">get_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>DEBUG("FT1000:word<em>length = 0x%x\n", (int)word</em>length);
NdisMSleep (100);</p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&gt;</span> <span class="n">MAX_LENGTH</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Max length exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">word_length</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">c_file</span><span class="p">)</span> <span class="o">&gt;</span>
					    <span class="n">boot_end</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Error, beyond boot code range.</span>
<span class="cm">						 */</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Requested len=%d exceeds BOOT code boundary.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">word_length</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/*</span>
<span class="cm">					 * Position ASIC DPRAM auto-increment pointer.</span>
<span class="cm">					 */</span>
					<span class="n">dpram</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">DWNLD_MAG1_PS_HDR_LOC</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
						<span class="n">word_length</span><span class="o">++</span><span class="p">;</span>
					<span class="n">word_length</span> <span class="o">=</span> <span class="n">word_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

					<span class="n">status</span> <span class="o">=</span>
					    <span class="n">write_blk</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s_file</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">c_file</span><span class="p">,</span> <span class="n">word_length</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>DEBUG("write_blk returned %d\n", status);</p></td><td class="code"><div class="highlight"><pre>					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">DEBUG</span>
					    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Bad request type=%d in BOOT download state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">request</span><span class="p">);</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span><span class="p">)</span>
					<span class="n">put_handshake_usb</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
							  <span class="n">HANDSHAKE_RESPONSE</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">put_handshake</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
						      <span class="n">HANDSHAKE_RESPONSE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUG</span>
				    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Handshake failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_CODE_DWNLD</span>:</pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>DEBUG("FT1000:STATE<em>CODE</em>DWNLD\n");</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">bootmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span><span class="p">)</span>
				<span class="n">handshake</span> <span class="o">=</span>
				    <span class="n">get_handshake_usb</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
						      <span class="n">HANDSHAKE_REQUEST</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">handshake</span> <span class="o">=</span>
				    <span class="n">get_handshake</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">HANDSHAKE_REQUEST</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handshake</span> <span class="o">==</span> <span class="n">HANDSHAKE_REQUEST</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Get type associated with the request.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span><span class="p">)</span>
					<span class="n">request</span> <span class="o">=</span>
					    <span class="n">get_request_type_usb</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">request</span> <span class="o">=</span> <span class="n">get_request_type</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">REQUEST_FILE_CHECKSUM</span>:
					<span class="n">DEBUG</span>
					    <span class="p">(</span><span class="s">&quot;FT1000:download:image_chksum = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">image_chksum</span><span class="p">);</span>
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
							  <span class="n">image_chksum</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_RUN_ADDRESS</span>:
					<span class="n">DEBUG</span>
					    <span class="p">(</span><span class="s">&quot;FT1000:download:  REQUEST_RUN_ADDRESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">correct_version</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:run_address = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">run_address</span><span class="p">);</span>
						<span class="n">put_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
								  <span class="n">run_address</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Got Run address request before image offset request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_CODE_LENGTH</span>:
					<span class="n">DEBUG</span>
					    <span class="p">(</span><span class="s">&quot;FT1000:download:REQUEST_CODE_LENGTH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">correct_version</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:run_size = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">run_size</span><span class="p">);</span>
						<span class="n">put_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
								  <span class="n">run_size</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Got Size request before image offset request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_DONE_CL</span>:
					<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
					<span class="cm">/* Reposition ptrs to beginning of provisioning section */</span>
					<span class="n">s_file</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span> <span class="o">+</span>
						     <span class="n">file_hdr</span><span class="o">-&gt;</span><span class="n">commands_offset</span><span class="p">);</span>
					<span class="n">c_file</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span> <span class="o">+</span>
						    <span class="n">file_hdr</span><span class="o">-&gt;</span><span class="n">commands_offset</span><span class="p">);</span>
					<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DONE_DWNLD</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">REQUEST_CODE_SEGMENT</span>:</pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>DEBUG("FT1000:download: REQUEST<em>CODE</em>SEGMENT - CODELOADER\n");</p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">correct_version</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Got Code Segment request before image offset request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">word_length</span> <span class="o">=</span>
					    <span class="n">get_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>DEBUG("FT1000:download:word<em>length = %d\n", (int)word</em>length);</p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&gt;</span> <span class="n">MAX_LENGTH</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Max length exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">word_length</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">c_file</span><span class="p">)</span> <span class="o">&gt;</span>
					    <span class="n">code_end</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Error, beyond boot code range.</span>
<span class="cm">						 */</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Requested len=%d exceeds DSP code boundary.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">word_length</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/*</span>
<span class="cm">					 * Position ASIC DPRAM auto-increment pointer.</span>
<span class="cm">					 */</span>
					<span class="n">dpram</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">DWNLD_MAG1_PS_HDR_LOC</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
						<span class="n">word_length</span><span class="o">++</span><span class="p">;</span>
					<span class="n">word_length</span> <span class="o">=</span> <span class="n">word_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

					<span class="n">write_blk_fifo</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s_file</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">c_file</span><span class="p">,</span> <span class="n">word_length</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">tempword</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">ft1000_write_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
								     <span class="n">DWNLD_MAG1_PS_HDR_LOC</span><span class="p">,</span>
								     <span class="n">tempword</span><span class="p">,</span>
								     <span class="mi">0</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">REQUEST_MAILBOX_DATA</span>:
					<span class="n">DEBUG</span>
					    <span class="p">(</span><span class="s">&quot;FT1000:download: REQUEST_MAILBOX_DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Convert length from byte count to word count. Make sure we round up.</p></td><td class="code"><div class="highlight"><pre>					<span class="n">word_length</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">DSPInfoBlklen</span> <span class="o">+</span>
						   <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
							  <span class="n">word_length</span><span class="p">);</span>
					<span class="n">mailbox_data</span> <span class="o">=</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">drv_msg</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span>
								<span class="n">DSPInfoBlk</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
					<span class="cm">/*</span>
<span class="cm">					 * Position ASIC DPRAM auto-increment pointer.</span>
<span class="cm">					 */</span>

					<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mailbox_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="n">dpram</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">DWNLD_MAG1_PS_HDR_LOC</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
						<span class="n">word_length</span><span class="o">++</span><span class="p">;</span>

					<span class="n">word_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

					<span class="k">for</span> <span class="p">(;</span> <span class="n">word_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word_length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* In words */</span>

						<span class="n">templong</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>
						<span class="n">templong</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span>
						    <span class="n">fix_ft1000_write_dpram32</span>
						    <span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="o">++</span><span class="p">,</span>
						     <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">templong</span><span class="p">);</span>

					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">REQUEST_VERSION_INFO</span>:
					<span class="n">DEBUG</span>
					    <span class="p">(</span><span class="s">&quot;FT1000:download:REQUEST_VERSION_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">word_length</span> <span class="o">=</span>
					    <span class="n">file_hdr</span><span class="o">-&gt;</span><span class="n">version_data_size</span><span class="p">;</span>
					<span class="n">put_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
							  <span class="n">word_length</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					 * Position ASIC DPRAM auto-increment pointer.</span>
<span class="cm">					 */</span>

					<span class="n">s_file</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span> <span class="o">+</span>
						     <span class="n">file_hdr</span><span class="o">-&gt;</span>
						     <span class="n">version_data_offset</span><span class="p">);</span>

					<span class="n">dpram</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">DWNLD_MAG1_PS_HDR_LOC</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
						<span class="n">word_length</span><span class="o">++</span><span class="p">;</span>

					<span class="n">word_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">word_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

					<span class="k">for</span> <span class="p">(;</span> <span class="n">word_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word_length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* In words */</span>

						<span class="n">templong</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="n">s_file</span><span class="o">++</span><span class="p">);</span>
						<span class="n">temp</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="n">s_file</span><span class="o">++</span><span class="p">);</span>
						<span class="n">templong</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span>
						    <span class="n">fix_ft1000_write_dpram32</span>
						    <span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">dpram</span><span class="o">++</span><span class="p">,</span>
						     <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">templong</span><span class="p">);</span>

					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">REQUEST_CODE_BY_VERSION</span>:
					<span class="n">DEBUG</span>
					    <span class="p">(</span><span class="s">&quot;FT1000:download:REQUEST_CODE_BY_VERSION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">correct_version</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
					<span class="n">requested_version</span> <span class="o">=</span>
					    <span class="n">get_request_value</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">);</span>

					<span class="n">dsp_img_info</span> <span class="o">=</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_image_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">pFileStart</span>
								      <span class="o">+</span>
								      <span class="k">sizeof</span>
								      <span class="p">(</span><span class="k">struct</span>
								       <span class="n">dsp_file_hdr</span><span class="p">));</span>

					<span class="k">for</span> <span class="p">(</span><span class="n">image</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					     <span class="n">image</span> <span class="o">&lt;</span> <span class="n">file_hdr</span><span class="o">-&gt;</span><span class="n">nDspImages</span><span class="p">;</span>
					     <span class="n">image</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">dsp_img_info</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span>
						    <span class="n">requested_version</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">correct_version</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
							<span class="n">DEBUG</span>
							    <span class="p">(</span><span class="s">&quot;FT1000:download: correct_version is TRUE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">s_file</span> <span class="o">=</span>
							    <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span>
								     <span class="o">+</span>
								     <span class="n">dsp_img_info</span><span class="o">-&gt;</span>
								     <span class="n">begin_offset</span><span class="p">);</span>
							<span class="n">c_file</span> <span class="o">=</span>
							    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span> <span class="o">+</span>
								    <span class="n">dsp_img_info</span><span class="o">-&gt;</span>
								    <span class="n">begin_offset</span><span class="p">);</span>
							<span class="n">code_end</span> <span class="o">=</span>
							    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileStart</span> <span class="o">+</span>
								    <span class="n">dsp_img_info</span><span class="o">-&gt;</span>
								    <span class="n">end_offset</span><span class="p">);</span>
							<span class="n">run_address</span> <span class="o">=</span>
							    <span class="n">dsp_img_info</span><span class="o">-&gt;</span>
							    <span class="n">run_address</span><span class="p">;</span>
							<span class="n">run_size</span> <span class="o">=</span>
							    <span class="n">dsp_img_info</span><span class="o">-&gt;</span>
							    <span class="n">image_size</span><span class="p">;</span>
							<span class="n">image_chksum</span> <span class="o">=</span>
							    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dsp_img_info</span><span class="o">-&gt;</span>
							    <span class="n">checksum</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">dsp_img_info</span><span class="o">++</span><span class="p">;</span>

					<span class="p">}</span>	<span class="c1">//end of for</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">correct_version</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Error, beyond boot code range.</span>
<span class="cm">						 */</span>
						<span class="n">DEBUG</span>
						    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Bad Version Request = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">requested_version</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="nl">default:</span>
					<span class="n">DEBUG</span>
					    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Bad request type=%d in CODE download state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">request</span><span class="p">);</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pft1000info</span><span class="o">-&gt;</span><span class="n">usbboot</span><span class="p">)</span>
					<span class="n">put_handshake_usb</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
							  <span class="n">HANDSHAKE_RESPONSE</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">put_handshake</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span>
						      <span class="n">HANDSHAKE_RESPONSE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUG</span>
				    <span class="p">(</span><span class="s">&quot;FT1000:download:Download error: Handshake failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DONE_DWNLD</span>:
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:download:Code loader is done...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_SECTION_PROV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_SECTION_PROV</span>:
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:download:STATE_SECTION_PROV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pseudo_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">c_file</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pseudo_header</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">==</span>
			    <span class="n">hdr_checksum</span><span class="p">(</span><span class="n">pseudo_header</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pseudo_header</span><span class="o">-&gt;</span><span class="n">portdest</span> <span class="o">!=</span>
				    <span class="mh">0x80</span> <span class="cm">/* Dsp OAM */</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DONE_PROV</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pseudo_header_len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pseudo_header</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>	<span class="cm">/* Byte length for PROV records */</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Get buffer for provisioning data</p></td><td class="code"><div class="highlight"><pre>				<span class="n">pbuffer</span> <span class="o">=</span>
				    <span class="n">kmalloc</span><span class="p">((</span><span class="n">pseudo_header_len</span> <span class="o">+</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">)),</span>
					    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pbuffer</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">pbuffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">c_file</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">pseudo_header_len</span> <span class="o">+</span>
						      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
							     <span class="n">pseudo_hdr</span><span class="p">)));</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>link provisioning data</p></td><td class="code"><div class="highlight"><pre>					<span class="n">pprov_record</span> <span class="o">=</span>
					    <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prov_record</span><span class="p">),</span>
						    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pprov_record</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pprov_record</span><span class="o">-&gt;</span><span class="n">pprov_data</span> <span class="o">=</span>
						    <span class="n">pbuffer</span><span class="p">;</span>
						<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pprov_record</span><span class="o">-&gt;</span>
							      <span class="n">list</span><span class="p">,</span>
							      <span class="o">&amp;</span><span class="n">pft1000info</span><span class="o">-&gt;</span>
							      <span class="n">prov_list</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Move to next entry if available</p></td><td class="code"><div class="highlight"><pre>						<span class="n">c_file</span> <span class="o">=</span>
						    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
							    <span class="n">c_file</span> <span class="o">+</span>
							    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">pseudo_header_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span><span class="p">));</span>
						<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">c_file</span><span class="p">)</span> <span class="o">-</span>
						    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">pFileStart</span><span class="p">)</span>
						    <span class="o">&gt;=</span>
						    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">FileLength</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DONE_FILE</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">kfree</span><span class="p">(</span><span class="n">pbuffer</span><span class="p">);</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Checksum did not compute */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DEBUG</span>
			    <span class="p">(</span><span class="s">&quot;ft1000:download: after STATE_SECTION_PROV, state = %d, status= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">state</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DONE_PROV</span>:
			<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:download:STATE_DONE_PROV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DONE_FILE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>		<span class="cm">/* End Switch */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cm">/****</span>

<span class="cm">//DIVIDER</span>
<span class="cm">      status = Harley_Read_Register(&amp;temp, FT1000_REG_SUP_IMASK);</span>
<span class="cm">      if ( (status != NDIS_STATUS_SUCCESS) || (temp == 0x0000) ) {</span>
<span class="cm">          break;</span>
<span class="cm">      }</span>

<span class="cm">      status = Harley_Read_Register(&amp;temp, FT1000_REG_ASIC_ID);</span>
<span class="cm">      if ( (status != NDIS_STATUS_SUCCESS) || (temp == 0xffff) ) {</span>
<span class="cm">          break;</span>
<span class="cm">      }</span>
<span class="cm">****/</span>

	<span class="p">}</span>			<span class="cm">/* End while */</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Download exiting with status = 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">ft1000_write_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">FT1000_DB_DNLD_TX</span><span class="p">,</span>
			      <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Check if Card is present</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
