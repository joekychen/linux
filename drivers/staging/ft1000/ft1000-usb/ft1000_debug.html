<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › ft1000 › ft1000-usb › ft1000_debug.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ft1000_debug.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><hr />

<p>FT1000 driver for Flarion Flash OFDM NIC Device</p>

<p>Copyright (C) 2006 Flarion Technologies, All rights reserved.</p>

<p>This program is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the Free
Software Foundation; either version 2 of the License, or (at your option) any
later version. This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
more details. You should have received a copy of the GNU General Public
License along with this program; if not, write to the
Free Software Foundation, Inc., 59 Temple Place -</p>

<h2>Suite 330, Boston, MA 02111-1307, USA.</h2>

<p>File:         ft1000_chdev.c</p>

<p>Description:  Custom character device dispatch routines.</p>

<p>History:
8/29/02    Whc                Ported to Linux.
6/05/06    Whc                Porting to Linux 2.6.9</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &quot;ft1000_usb.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ft1000_flarion_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ft1000_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ft1000_poll_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">ft1000_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
                           <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">argument</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ft1000_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>List to free receive command buffer pool</p></td><td class="code"><div class="highlight"><pre><span class="k">struct</span> <span class="n">list_head</span> <span class="n">freercvpool</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>lock to arbitrate free buffer list for receive command data</p></td><td class="code"><div class="highlight"><pre><span class="n">spinlock_t</span> <span class="n">free_buff_lock</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">numofmsgbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Table of entry-point routines for char device</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ft1000fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">ft1000_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">ft1000_poll_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ft1000_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">ft1000_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><hr />

<p>Function:    ft1000<em>get</em>buffer</p>

<p>Parameters:</p>

<p>Returns:</p>

<p>Description:</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">struct</span> <span class="n">dpram_blk</span> <span class="o">*</span><span class="nf">ft1000_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">bufflist</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dpram_blk</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Check if buffer is available</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="n">list_empty</span><span class="p">(</span><span class="n">bufflist</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_get_buffer:  No more buffer - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">numofmsgbuf</span><span class="p">);</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">numofmsgbuf</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">bufflist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dpram_blk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
        <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>DEBUG("ft1000<em>get</em>buffer: number of free msg buffers = %d\n", numofmsgbuf);</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><hr />

<p>Function:    ft1000<em>free</em>buffer</p>

<p>Parameters:</p>

<p>Returns:</p>

<p>Description:</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">ft1000_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dpram_blk</span> <span class="o">*</span><span class="n">pdpram_blk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Put memory back to list</p></td><td class="code"><div class="highlight"><pre>    <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">plist</span><span class="p">);</span>
    <span class="n">numofmsgbuf</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>DEBUG("ft1000<em>free</em>buffer: number of free msg buffers = %d\n", numofmsgbuf);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><hr />

<p>Function:    ft1000_CreateDevice</p>

<p>Parameters:  dev - pointer to adapter object</p>

<p>Returns:     0 if successful</p>

<p>Description: Creates a private char device.</p>

<p>Notes:       Only called by init_module().</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">ft1000_create_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_debug_dirs</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>make a new device name</p></td><td class="code"><div class="highlight"><pre>    <span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceName</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="s">&quot;FT1000_&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">CardNumber</span><span class="p">);</span>

    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;%s: number of instance = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ft1000_flarion_cnt</span><span class="p">);</span>
    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;DeviceCreated = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceCreated</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceCreated</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;%s: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> already registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceName</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>register the device</p></td><td class="code"><div class="highlight"><pre>    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;%s: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> debugfs device registration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceName</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_debug_dirs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceName</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">debug_dir_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">file</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;device&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
					<span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ft1000fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">debug_file_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">dent</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">int_number</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">CardNumber</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">.</span><span class="n">list</span><span class="p">));</span>

    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;%s: registered debugfs directory </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceName</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>initialize application information</p></td><td class="code"><div class="highlight"><pre>    <span class="n">info</span><span class="o">-&gt;</span><span class="n">appcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nTxMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nRxMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nTxMsgReject</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nRxMsgMiss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_id</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">DspBCMsgFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NumOfMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_dpram_msg</span><span class="p">);</span>
        <span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceCreated</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ft1000_flarion_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">debug_file_fail:</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
<span class="nl">debug_dir_fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><hr />

<p>Function:    ft1000_DestroyDeviceDEBUG</p>

<p>Parameters:  dev - pointer to adapter object</p>

<p>Description: Destroys a private char device.</p>

<p>Notes:       Only called by cleanup_module().</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">ft1000_destroy_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dpram_blk</span> <span class="o">*</span><span class="n">pdpram_blk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dpram_blk</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_debug_dirs</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>

    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;%s called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>



    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceCreated</span><span class="p">)</span>
	<span class="p">{</span>
        <span class="n">ft1000_flarion_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ft1000_debug_dirs</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">int_number</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">CardNumber</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">);</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">dent</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;%s: unregistered device </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					   <span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceName</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Make sure we free any memory reserve for slow Queue</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pdpram_blk</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dpram_blk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
                <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
                <span class="n">ft1000_free_buffer</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>

            <span class="p">}</span>
            <span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_dpram_msg</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Remove buffer allocated for receive command data</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">ft1000_flarion_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">freercvpool</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dpram_blk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
                <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
                <span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">);</span>
                <span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceCreated</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>


<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><hr />

<p>Function:    ft1000_open</p>

<p>Parameters:</p>

<p>Description:</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">num</span><span class="p">;</span>

    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;%s called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
    <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_open: minor number=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;f_owner = %p number of application = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_owner</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">appcnt</span> <span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Check if maximum number of application exceeded</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">appcnt</span> <span class="o">&gt;</span> <span class="n">MAX_NUM_APP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Maximum number of application exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Search for available application info block</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Fail due to lack of application info block</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_NUM_APP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Could not find an application info block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">info</span><span class="o">-&gt;</span><span class="n">appcnt</span><span class="o">++</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_owner</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nTxMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nRxMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nTxMsgReject</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nRxMsgMiss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><hr />

<p>Function:    ft1000<em>poll</em>dev</p>

<p>Parameters:</p>

<p>Description:</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ft1000_poll_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>DEBUG("ft1000<em>poll</em>dev called\n");</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">ft1000_flarion_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_poll_dev called when ft1000_flarion_cnt is zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBADF</span><span class="p">);</span>
    <span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Search for matching file object</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_owner</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>ioctl: Message is for AppId = %d\n", info->app</em>info[i].app_id);</p></td><td class="code"><div class="highlight"><pre>            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Could not find application info block</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_NUM_APP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl:Could not find application info block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span> <span class="o">-</span><span class="n">EACCES</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_poll_dev:Message detected in slow queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">(</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span> <span class="o">|</span> <span class="n">POLLPRI</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">poll_wait</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_dpram_msg</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>poll</em>dev:Polling for data from DSP\n");</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><hr />

<p>Function:    ft1000_ioctl</p>

<p>Parameters:</p>

<p>Description:</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">long</span> <span class="nf">ft1000_ioctl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
                           <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">argument</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argument</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">ft1000_device</span> <span class="o">*</span><span class="n">ft1000dev</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">result</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">tempword</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
    <span class="n">IOCTL_GET_VER</span> <span class="n">get_ver_data</span><span class="p">;</span>
    <span class="n">IOCTL_GET_DSP_STAT</span> <span class="n">get_stat_data</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">ConnectionMsg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x93</span><span class="p">,</span><span class="mh">0x64</span><span class="p">,</span>
                          <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0a</span><span class="p">,</span>
                          <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
                          <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
                          <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
                          <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">};</span>

    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ledStat</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">conStat</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>DEBUG("ft1000_ioctl called\n");</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">ft1000_flarion_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl called when ft1000_flarion_cnt is zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBADF</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>DEBUG("FT1000:ft1000_ioctl:command = 0x%x argument = 0x%8x\n", command, (u32)argument);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">info</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">ft1000dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pFt1000Dev</span><span class="p">;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">command</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>DEBUG("FT1000:ft1000_ioctl:cmd = 0x%x\n", cmd);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>process the command</p></td><td class="code"><div class="highlight"><pre>    <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">IOCTL_REGISTER_CMD</span>:
            <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: IOCTL_FT1000_REGISTER called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">tempword</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;result = %d failed to get_user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">==</span> <span class="n">DSPBCMSGID</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Search for matching file object</p></td><td class="code"><div class="highlight"><pre>                <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_owner</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">DspBCMsgFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl:Registered for broadcast messages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">IOCTL_GET_VER_CMD</span>:
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: IOCTL_FT1000_GET_VER called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="n">get_ver_data</span><span class="p">.</span><span class="n">drv_ver</span> <span class="o">=</span> <span class="n">FT1000_DRV_VER</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">get_ver_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">get_ver_data</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: copy fault occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl:driver version = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">get_ver_data</span><span class="p">.</span><span class="n">drv_ver</span><span class="p">);</span>

        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IOCTL_CONNECT</span>:</pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Connect Message</p></td><td class="code"><div class="highlight"><pre>        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: IOCTL_FT1000_CONNECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">ConnectionMsg</span><span class="p">[</span><span class="mi">79</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfc</span><span class="p">;</span>
			   <span class="n">card_send_command</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">ConnectionMsg</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>

        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IOCTL_DISCONNECT</span>:</pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Disconnect Message</p></td><td class="code"><div class="highlight"><pre>        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: IOCTL_FT1000_DISCONNECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">ConnectionMsg</span><span class="p">[</span><span class="mi">79</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfd</span><span class="p">;</span>
			   <span class="n">card_send_command</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">ConnectionMsg</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IOCTL_GET_DSP_STAT_CMD</span>:</pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>ioctl: IOCTL</em>FT1000<em>GET</em>DSP_STAT called\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">get_stat_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">get_stat_data</span><span class="p">));</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">get_stat_data</span><span class="p">.</span><span class="n">DspVer</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DspVer</span><span class="p">,</span> <span class="n">DSPVERSZ</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">get_stat_data</span><span class="p">.</span><span class="n">HwSerNum</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">HwSerNum</span><span class="p">,</span> <span class="n">HWSERNUMSZ</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">get_stat_data</span><span class="p">.</span><span class="n">Sku</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">Sku</span><span class="p">,</span> <span class="n">SKUSZ</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">get_stat_data</span><span class="p">.</span><span class="n">eui64</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">eui64</span><span class="p">,</span> <span class="n">EUISZ</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ProgConStat</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_LED</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ledStat</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_LED_INDX</span><span class="p">);</span>
                <span class="n">get_stat_data</span><span class="p">.</span><span class="n">LedStat</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ledStat</span><span class="p">);</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: LedStat = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_stat_data</span><span class="p">.</span><span class="n">LedStat</span><span class="p">);</span>
                <span class="n">ft1000_read_dpram16</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_CON_STATE</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">conStat</span><span class="p">,</span> <span class="n">FT1000_MAG_DSP_CON_STATE_INDX</span><span class="p">);</span>
                <span class="n">get_stat_data</span><span class="p">.</span><span class="n">ConStat</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">conStat</span><span class="p">);</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: ConStat = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_stat_data</span><span class="p">.</span><span class="n">ConStat</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">get_stat_data</span><span class="p">.</span><span class="n">ConStat</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
            <span class="p">}</span>


        <span class="n">get_stat_data</span><span class="p">.</span><span class="n">nTxPkts</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
        <span class="n">get_stat_data</span><span class="p">.</span><span class="n">nRxPkts</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
        <span class="n">get_stat_data</span><span class="p">.</span><span class="n">nTxBytes</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">;</span>
        <span class="n">get_stat_data</span><span class="p">.</span><span class="n">nRxBytes</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">;</span>
        <span class="n">do_gettimeofday</span> <span class="p">(</span> <span class="o">&amp;</span><span class="n">tv</span> <span class="p">);</span>
        <span class="n">get_stat_data</span><span class="p">.</span><span class="n">ConTm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConTm</span><span class="p">);</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Connection Time = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">get_stat_data</span><span class="p">.</span><span class="n">ConTm</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">get_stat_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">get_stat_data</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: copy fault occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_chioctl: GET_DSP_STAT succeed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IOCTL_SET_DPRAM_CMD</span>:
        <span class="p">{</span>
            <span class="n">IOCTL_DPRAM_BLK</span> <span class="o">*</span><span class="n">dpram_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>IOCTL<em>DPRAM</em>COMMAND dpram_command;</p></td><td class="code"><div class="highlight"><pre>            <span class="n">u16</span> <span class="n">qtype</span><span class="p">;</span>
            <span class="n">u16</span> <span class="n">msgsz</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="n">ppseudo_hdr</span><span class="p">;</span>
            <span class="n">u16</span> <span class="o">*</span><span class="n">pmsg</span><span class="p">;</span>
            <span class="n">u16</span> <span class="n">total_len</span><span class="p">;</span>
            <span class="n">u16</span> <span class="n">app_index</span><span class="p">;</span>
            <span class="n">u16</span> <span class="n">status</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>ioctl: IOCTL</em>FT1000<em>SET</em>DPRAM called\n");</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">ft1000_flarion_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBADF</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DrvMsgPend</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOTTY</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DspAsicReset</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fProvComplete</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">info</span><span class="o">-&gt;</span><span class="n">fAppMsgPend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">CardReady</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>ioctl: try to SET</em>DPRAM \n");</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Get the length field to see how many bytes to copy</p></td><td class="code"><div class="highlight"><pre>                <span class="n">result</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">msgsz</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
                <span class="n">msgsz</span> <span class="o">=</span> <span class="n">ntohs</span> <span class="p">(</span><span class="n">msgsz</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>DEBUG("FT1000:ft1000_ioctl: length of message = %d\n", msgsz);</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">msgsz</span> <span class="o">&gt;</span> <span class="n">MAX_CMD_SQSIZE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: bad message length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">);</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dpram_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">msgsz</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpram_data</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">dpram_data</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">msgsz</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ChIoctl: copy fault occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Check if this message came from a registered application</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_owner</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">MAX_NUM_APP</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:No matching application fileobject</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">dpram_data</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">app_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Check message qtype type which is the lower byte within qos_class</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">qtype</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">dpram_data</span><span class="o">-&gt;</span><span class="n">pseudohdr</span><span class="p">.</span><span class="n">qos_class</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>DEBUG("FT1000<em>ft1000</em>ioctl: qtype = %d\n", qtype);</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="n">qtype</span><span class="p">)</span> <span class="p">{</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>Put message into Slow Queue
Only put a message into the DPRAM if msg doorbell is available</p></td><td class="code"><div class="highlight"><pre>                        <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>DEBUG("FT1000<em>ft1000</em>ioctl: READ REGISTER tempword=%x\n", tempword);</p></td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>Suspend for 2ms and try again due to DSP doorbell busy</p></td><td class="code"><div class="highlight"><pre>                            <span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                            <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Suspend for 1ms and try again due to DSP doorbell busy</p></td><td class="code"><div class="highlight"><pre>                                <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                                <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Suspend for 3ms and try again due to DSP doorbell busy</p></td><td class="code"><div class="highlight"><pre>                                        <span class="n">mdelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
                                        <span class="n">status</span> <span class="o">=</span> <span class="n">ft1000_read_register</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempword</span><span class="p">,</span> <span class="n">FT1000_REG_DOORBELL</span><span class="p">);</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">tempword</span> <span class="o">&amp;</span> <span class="n">FT1000_DB_DPRAM_TX</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl:Doorbell not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                            <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
						<span class="n">kfree</span><span class="p">(</span><span class="n">dpram_data</span><span class="p">);</span>
                                            <span class="k">break</span><span class="p">;</span>
                                        <span class="p">}</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>DEBUG("FT1000<em>ft1000</em>ioctl: finished reading register\n");</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Make sure we are within the limits of the slow queue memory limitation</p></td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">msgsz</span> <span class="o">&lt;</span> <span class="n">MAX_CMD_SQSIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msgsz</span> <span class="o">&gt;</span> <span class="n">PSEUDOSZ</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Need to put sequence number plus new checksum for message</p></td><td class="code"><div class="highlight"><pre>                            <span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dpram_data</span><span class="o">-&gt;</span><span class="n">pseudohdr</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pmsg</span><span class="p">;</span>
                            <span class="n">total_len</span> <span class="o">=</span> <span class="n">msgsz</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">total_len</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">total_len</span><span class="o">++</span><span class="p">;</span>
                            <span class="p">}</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Insert slow queue sequence number</p></td><td class="code"><div class="highlight"><pre>                            <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">squeseqnum</span><span class="o">++</span><span class="p">;</span>
                            <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">portsrc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">app_index</span><span class="p">].</span><span class="n">app_id</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Calculate new checksum</p></td><td class="code"><div class="highlight"><pre>                            <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>DEBUG("checksum = 0x%x\n", ppseudo_hdr->checksum);</p></td><td class="code"><div class="highlight"><pre>                            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">ppseudo_hdr</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">^=</span> <span class="o">*</span><span class="n">pmsg</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>DEBUG("checksum = 0x%x\n", ppseudo_hdr->checksum);</p></td><td class="code"><div class="highlight"><pre>                            <span class="p">}</span>
                            <span class="n">pmsg</span><span class="o">++</span><span class="p">;</span>
				<span class="n">ppseudo_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pseudo_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pmsg</span><span class="p">;</span>
                           <span class="n">card_send_command</span><span class="p">(</span><span class="n">ft1000dev</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)</span><span class="n">dpram_data</span><span class="p">,</span><span class="n">total_len</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>


                            <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">app_index</span><span class="p">].</span><span class="n">nTxMsg</span><span class="o">++</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: Card not ready take messages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
            <span class="p">}</span>
	    <span class="n">kfree</span><span class="p">(</span><span class="n">dpram_data</span><span class="p">);</span>

        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IOCTL_GET_DPRAM_CMD</span>:
        <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dpram_blk</span> <span class="o">*</span><span class="n">pdpram_blk</span><span class="p">;</span>
            <span class="n">IOCTL_DPRAM_BLK</span> <span class="n">__user</span> <span class="o">*</span><span class="n">pioctl_dpram</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">msglen</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>ioctl: IOCTL</em>FT1000<em>GET</em>DPRAM called\n");</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">ft1000_flarion_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBADF</span><span class="p">);</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Search for matching file object</p></td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_owner</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>ioctl: Message is for AppId = %d\n", info->app</em>info[i].app_id);</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Could not find application info block</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_NUM_APP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl:Could not find application info block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">pioctl_dpram</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>DEBUG("FT1000:ft1000_ioctl:Message detected in slow queue\n");</p></td><td class="code"><div class="highlight"><pre>                <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                <span class="n">pdpram_blk</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dpram_blk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
                <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NumOfMsg</span><span class="o">--</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>ioctl:NumOfMsg for app %d = %d\n", i, info->app</em>info[i].NumOfMsg);</p></td><td class="code"><div class="highlight"><pre>                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                <span class="n">msglen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">)</span> <span class="o">+</span> <span class="n">PSEUDOSZ</span><span class="p">;</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">msglen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pioctl_dpram</span><span class="o">-&gt;</span><span class="n">total_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msglen</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">msglen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>DEBUG("FT1000:ft1000_ioctl:msg length = %x\n", msglen);</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pioctl_dpram</span><span class="o">-&gt;</span><span class="n">pseudohdr</span><span class="p">,</span> <span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">msglen</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl: copy fault occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	             	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	             	<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

                <span class="n">ft1000_free_buffer</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">msglen</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>ioctl: IOCTL</em>FT1000<em>GET</em>DPRAM no message\n");</p></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;FT1000:ft1000_ioctl:unknown command: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
        <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">fAppMsgPend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><hr />

<p>Function:    ft1000_release</p>

<p>Parameters:</p>

<p>Description:</p>

<p>Notes:</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ft1000_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ft1000_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dpram_blk</span> <span class="o">*</span><span class="n">pdpram_blk</span><span class="p">;</span>

    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_release called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">dev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ft1000_flarion_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">appcnt</span><span class="o">--</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBADF</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Search for matching file object</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NUM_APP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_owner</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>DEBUG("FT1000:ft1000<em>ioctl: Message is for AppId = %d\n", info->app</em>info[i].app_id);</p></td><td class="code"><div class="highlight"><pre>            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">MAX_NUM_APP</span><span class="p">)</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;Remove and free memory queue up on slow queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">pdpram_blk</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_sqlist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dpram_blk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
        <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpram_blk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
        <span class="n">ft1000_free_buffer</span><span class="p">(</span><span class="n">pdpram_blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freercvpool</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>initialize application information</p></td><td class="code"><div class="highlight"><pre>    <span class="n">info</span><span class="o">-&gt;</span><span class="n">appcnt</span><span class="o">--</span><span class="p">;</span>
    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;ft1000_chdev:%s:appcnt = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">appcnt</span><span class="p">);</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">app_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fileobject</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
