<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › cptm1217 › clearpad_tm1217.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>clearpad_tm1217.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * clearpad_tm1217.c - Touch Screen driver for Synaptics Clearpad</span>
<span class="cm"> * TM1217 controller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Intel Corp</span>
<span class="cm"> *</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; ifnot, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Questions/Comments/Bug fixes to Ramesh Agarwal (ramesh.agarwal@intel.com)</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;cp_tm1217.h&quot;</span>

<span class="cp">#define CPTM1217_DEVICE_NAME		&quot;cptm1217&quot;</span>
<span class="cp">#define CPTM1217_DRIVER_NAME		CPTM1217_DEVICE_NAME</span>

<span class="cp">#define MAX_TOUCH_SUPPORTED		2</span>
<span class="cp">#define TOUCH_SUPPORTED			1</span>
<span class="cp">#define SAMPLING_FREQ			80	</span><span class="cm">/* Frequency in HZ */</span><span class="cp"></span>
<span class="cp">#define DELAY_BTWIN_SAMPLE		(1000 / SAMPLING_FREQ)</span>
<span class="cp">#define WAIT_FOR_RESPONSE		5	</span><span class="cm">/* 5msec just works */</span><span class="cp"></span>
<span class="cp">#define MAX_RETRIES			5	</span><span class="cm">/* As above */</span><span class="cp"></span>
<span class="cp">#define INCREMENTAL_DELAY		5	</span><span class="cm">/* As above */</span><span class="cp"></span>

<span class="cm">/* Regster Definitions */</span>
<span class="cp">#define TMA1217_DEV_STATUS		0x13	</span><span class="cm">/* Device Status */</span><span class="cp"></span>
<span class="cp">#define TMA1217_INT_STATUS		0x14	</span><span class="cm">/* Interrupt Status */</span><span class="cp"></span>

<span class="cm">/* Controller can detect up to 2 possible finger touches.</span>
<span class="cm"> * Each finger touch provides  12 bit X Y co-ordinates, the values are split</span>
<span class="cm"> * across 2 registers, and an 8 bit  Z value */</span>
<span class="cp">#define TMA1217_FINGER_STATE		0x18 </span><span class="cm">/* Finger State */</span><span class="cp"></span>
<span class="cp">#define TMA1217_FINGER1_X_HIGHER8	0x19 </span><span class="cm">/* Higher 8 bit of X coordinate */</span><span class="cp"></span>
<span class="cp">#define TMA1217_FINGER1_Y_HIGHER8	0x1A </span><span class="cm">/* Higher 8 bit of Y coordinate */</span><span class="cp"></span>
<span class="cp">#define TMA1217_FINGER1_XY_LOWER4	0x1B </span><span class="cm">/* Lower 4 bits of X and Y */</span><span class="cp"></span>
<span class="cp">#define TMA1217_FINGER1_Z_VALUE		0x1D </span><span class="cm">/* 8 bit Z value for finger 1 */</span><span class="cp"></span>
<span class="cp">#define TMA1217_FINGER2_X_HIGHER8	0x1E </span><span class="cm">/* Higher 8 bit of X coordinate */</span><span class="cp"></span>
<span class="cp">#define TMA1217_FINGER2_Y_HIGHER8	0x1F </span><span class="cm">/* Higher 8 bit of Y coordinate */</span><span class="cp"></span>
<span class="cp">#define TMA1217_FINGER2_XY_LOWER4	0x20 </span><span class="cm">/* Lower 4 bits of X and Y */</span><span class="cp"></span>
<span class="cp">#define TMA1217_FINGER2_Z_VALUE		0x22 </span><span class="cm">/* 8 bit Z value for finger 2 */</span><span class="cp"></span>
<span class="cp">#define TMA1217_DEVICE_CTRL		0x23 </span><span class="cm">/* Device Control */</span><span class="cp"></span>
<span class="cp">#define TMA1217_INTERRUPT_ENABLE	0x24 </span><span class="cm">/* Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define TMA1217_REPORT_MODE		0x2B </span><span class="cm">/* Reporting Mode */</span><span class="cp"></span>
<span class="cp">#define TMA1217_MAX_X_LOWER8		0x31 </span><span class="cm">/* Bit 0-7 for Max X */</span><span class="cp"></span>
<span class="cp">#define TMA1217_MAX_X_HIGHER4		0x32 </span><span class="cm">/* Bit 8-11 for Max X */</span><span class="cp"></span>
<span class="cp">#define TMA1217_MAX_Y_LOWER8		0x33 </span><span class="cm">/* Bit 0-7 for Max Y */</span><span class="cp"></span>
<span class="cp">#define TMA1217_MAX_Y_HIGHER4		0x34 </span><span class="cm">/* Bit 8-11 for Max Y */</span><span class="cp"></span>
<span class="cp">#define TMA1217_DEVICE_CMD_RESET	0x67 </span><span class="cm">/* Device CMD reg for reset */</span><span class="cp"></span>
<span class="cp">#define TMA1217_DEVICE_CMD_REZERO	0x69 </span><span class="cm">/* Device CMD reg for rezero */</span><span class="cp"></span>

<span class="cp">#define TMA1217_MANUFACTURER_ID		0x73 </span><span class="cm">/* Manufacturer Id */</span><span class="cp"></span>
<span class="cp">#define TMA1217_PRODUCT_FAMILY		0x75 </span><span class="cm">/* Product Family */</span><span class="cp"></span>
<span class="cp">#define TMA1217_FIRMWARE_REVISION	0x76 </span><span class="cm">/* Firmware Revision */</span><span class="cp"></span>
<span class="cp">#define TMA1217_SERIAL_NO_HIGH		0x7C </span><span class="cm">/* Bit 8-15 of device serial no. */</span><span class="cp"></span>
<span class="cp">#define TMA1217_SERIAL_NO_LOW		0x7D </span><span class="cm">/* Bit 0-7 of device serial no. */</span><span class="cp"></span>
<span class="cp">#define TMA1217_PRODUCT_ID_START	0x7E </span><span class="cm">/* Start address for 10 byte ID */</span><span class="cp"></span>
<span class="cp">#define TMA1217_DEVICE_CAPABILITY	0x8B </span><span class="cm">/* Reporting capability */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * The touch position structure.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">touch_state</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">y</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">button</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Device Specific info given by the controller */</span>
<span class="k">struct</span> <span class="n">cp_dev_info</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">maxX</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">maxY</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Vendor related info given by the controller */</span>
<span class="k">struct</span> <span class="n">cp_vendor_info</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">product_family</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">firmware_rev</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">serial_no</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Private structure to store the device details</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cp_vendor_info</span>	<span class="n">vinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cp_dev_info</span>	<span class="n">dinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev_info</span> <span class="p">{</span>
		<span class="kt">char</span>			<span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
		<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">input_dev</span>	<span class="o">*</span><span class="n">input</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">touch_state</span>	<span class="n">touch</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">cp_input_info</span><span class="p">[</span><span class="n">MAX_TOUCH_SUPPORTED</span><span class="p">];</span>

	<span class="kt">int</span>	<span class="n">thread_running</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>	<span class="n">thread_mutex</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">gpio</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* The following functions are used to read/write registers on the device</span>
<span class="cm"> * as per the RMI prorocol. Technically, a page select should be written</span>
<span class="cm"> * before doing read/write but since the register offsets are below 0xFF</span>
<span class="cm"> * we can use the default value of page which is 0x00</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Send the address */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: I2C send failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">WAIT_FOR_RESPONSE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">INCREMENTAL_DELAY</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: Retry count is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: Read from device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Send the address and the data to be written */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: I2C write  failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Wait for the write to complete. TBD why this is required */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">WAIT_FOR_RESPONSE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_mask_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_INTERRUPT_ENABLE</span><span class="p">;</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_write</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_unmask_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_INTERRUPT_ENABLE</span><span class="p">;</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_write</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_touch</span><span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev_info</span> <span class="o">*</span><span class="n">input_info</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">input_dev_info</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">xy_data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">xy_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_FINGER1_X_HIGHER8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xy_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_FINGER2_X_HIGHER8</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">xy_data</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: XY read from device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Note: Currently not using the Z values but may be requried in</span>
<span class="cm">	   the future. */</span>
	<span class="n">input_info</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
					<span class="o">|</span> <span class="p">(</span><span class="n">xy_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
	<span class="n">input_info</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
					<span class="o">|</span> <span class="p">((</span><span class="n">xy_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input_info</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">input_info</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input_info</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">input_info</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">input_info</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp_tm1217_get_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">finger_touched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_FINGER_STATE</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;cp_tm1217: Read from device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">finger_touched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Start sampling until the pressure is below</span>
<span class="cm">		  threshold */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOUCH_SUPPORTED</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">finger_touched</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">touch</span><span class="p">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* send the button touch event */</span>
					<span class="n">input_report_key</span><span class="p">(</span>
						<span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">,</span>
						<span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">touch</span><span class="p">.</span><span class="n">button</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">process_touch</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">touch</span><span class="p">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* send the button release event */</span>
					<span class="n">input_report_key</span><span class="p">(</span>
						<span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">,</span>
						<span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">input_sync</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">);</span>
					<span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">touch</span><span class="p">.</span><span class="n">button</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">DELAY_BTWIN_SAMPLE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">finger_touched</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">cp_tm1217_sample_thread</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Chedk if another thread is already running */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Mask the interrupts */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_mask_interrupt</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>

	<span class="cm">/* Read the Interrupt Status register to find the cause of the</span>
<span class="cm">	   Interrupt */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_INT_STATUS</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_thread</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_thread</span><span class="p">;</span>

	<span class="n">cp_tm1217_get_data</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>

<span class="nl">exit_thread:</span>
	<span class="cm">/* Unmask the interrupts before going to sleep */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_unmask_interrupt</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_mutex</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_init_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Read the vendor id/ fw revision etc. Ignoring return check as this</span>
<span class="cm">	   is non critical info  */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_MANUFACTURER_ID</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">vinfo</span><span class="p">.</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_PRODUCT_FAMILY</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">vinfo</span><span class="p">.</span><span class="n">product_family</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_FIRMWARE_REVISION</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">vinfo</span><span class="p">.</span><span class="n">firmware_rev</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_SERIAL_NO_HIGH</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">vinfo</span><span class="p">.</span><span class="n">serial_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_SERIAL_NO_LOW</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">vinfo</span><span class="p">.</span><span class="n">serial_no</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">vinfo</span><span class="p">.</span><span class="n">serial_no</span> <span class="o">|</span> <span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_MAX_X_HIGHER4</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">dinfo</span><span class="p">.</span><span class="n">maxX</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_MAX_X_LOWER8</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">dinfo</span><span class="p">.</span><span class="n">maxX</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">dinfo</span><span class="p">.</span><span class="n">maxX</span> <span class="o">|</span> <span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_MAX_Y_HIGHER4</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">dinfo</span><span class="p">.</span><span class="n">maxY</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_MAX_Y_LOWER8</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">dinfo</span><span class="p">.</span><span class="n">maxY</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">dinfo</span><span class="p">.</span><span class="n">maxY</span> <span class="o">|</span> <span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Set up a GPIO for use as the interrupt. We can&#39;t simply do this at</span>
<span class="cm"> *	boot time because the GPIO drivers themselves may not be around at</span>
<span class="cm"> *	boot/firmware set up time to do the work. Instead defer it to driver</span>
<span class="cm"> *	detection.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_setup_gpio_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Hook up the irq handler */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">,</span> <span class="s">&quot;cp_tm1217_touch&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: GPIO request failed error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">retval</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;cp_tm1217: GPIO direction configuration failed, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">retval</span><span class="p">);</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: GPIO to IRQ failedi,&quot;</span>
		<span class="s">&quot; error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;cp_tm1217: Got IRQ number is %d for GPIO %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">retval</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev_info</span>	<span class="o">*</span><span class="n">input_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cp_tm1217_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* No pdata is fine - we then use &quot;normal&quot; IRQ mode */</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">ts</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cp_tm1217_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cp_tm1217: Private Device Struct alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>

	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">thread_mutex</span><span class="p">);</span>

	<span class="cm">/* Reset the Controller */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_DEVICE_CMD_RESET</span><span class="p">;</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_write</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: Controller reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear up the interrupt status from reset. */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_INT_STATUS</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Mask all the interrupts */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_mask_interrupt</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>

	<span class="cm">/* Read the controller information */</span>
	<span class="n">cp_tm1217_init_data</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>

	<span class="cm">/* The following code will register multiple event devices when</span>
<span class="cm">	   multi-pointer is enabled, the code has not been tested</span>
<span class="cm">	   with MPX */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOUCH_SUPPORTED</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">input_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;cp_tm1217:Input Device Struct alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">input_info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input_info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			<span class="s">&quot;cp_tm1217_touchscreen_%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">input_info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">input_info</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input_info</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span>
			<span class="s">&quot;%s/input%d&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">input_info</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_I2C</span><span class="p">;</span>

		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">);</span>

		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">dinfo</span><span class="p">.</span><span class="n">maxX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">dinfo</span><span class="p">.</span><span class="n">maxY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Input dev registration failed for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_info</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the reporting mode to send an interrupt only when</span>
<span class="cm">	   finger arrives or departs. */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_REPORT_MODE</span><span class="p">;</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_write</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Setup the device to no sleep mode for now and make it configured */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_DEVICE_CTRL</span><span class="p">;</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_write</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Check for the status of the device */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_DEV_STATUS</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cp_tm1217: Device Status 0x%x != 0: config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_setup_gpio_irq</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: GPIO request failed error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>


	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="n">cp_tm1217_sample_thread</span><span class="p">,</span>
		<span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span> <span class="s">&quot;cp_tm1217_touch&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cp_tm1217: Request IRQ error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_gpio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Unmask the interrupts */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_unmask_interrupt</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>
<span class="nl">fail_gpio:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">)</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="cm">/* Clean up before returning failure */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOUCH_SUPPORTED</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">);</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cp_tm1217 suspend</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Put the controller to sleep */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_DEVICE_CTRL</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_write</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cp_tm1217_resume</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Take the controller out of sleep */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_DEVICE_CTRL</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_read</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x4</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_write</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Restore the register settings sinc the power to the</span>
<span class="cm">	   could have been cut off */</span>

	<span class="cm">/* Setup the reporting mode to send an interrupt only when</span>
<span class="cm">	   finger arrives or departs. */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_REPORT_MODE</span><span class="p">;</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_write</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Setup the device to no sleep mode for now and make it configured */</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMA1217_DEVICE_CTRL</span><span class="p">;</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_write</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Setup the interrupt mask */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cp_tm1217_unmask_interrupt</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">disable_irq_wake</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cp_tm1217_remove</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp_tm1217_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cp_tm1217_device</span> <span class="o">*</span><span class="n">ts</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">)</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOUCH_SUPPORTED</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">cp_input_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">cp_tm1217_idtable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">CPTM1217_DEVICE_NAME</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">cp_tm1217_idtable</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">cp_tm1217_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">CPTM1217_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">cp_tm1217_idtable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">cp_tm1217_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">cp_tm1217_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>    <span class="o">=</span> <span class="n">cp_tm1217_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>     <span class="o">=</span> <span class="n">cp_tm1217_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">clearpad_tm1217_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp_tm1217_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">clearpad_tm1217_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp_tm1217_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">clearpad_tm1217_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">clearpad_tm1217_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ramesh Agarwal &lt;ramesh.agarwal@intel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Synaptics TM1217 TouchScreen Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
