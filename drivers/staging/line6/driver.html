<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › line6 › driver.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>driver.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Line6 Linux USB driver - 0.9.1beta</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004-2010 Markus Grabner (grabner@icg.tugraz.at)</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation, version 2.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>

<span class="cp">#include &quot;audio.h&quot;</span>
<span class="cp">#include &quot;capture.h&quot;</span>
<span class="cp">#include &quot;control.h&quot;</span>
<span class="cp">#include &quot;driver.h&quot;</span>
<span class="cp">#include &quot;midi.h&quot;</span>
<span class="cp">#include &quot;playback.h&quot;</span>
<span class="cp">#include &quot;pod.h&quot;</span>
<span class="cp">#include &quot;podhd.h&quot;</span>
<span class="cp">#include &quot;revision.h&quot;</span>
<span class="cp">#include &quot;toneport.h&quot;</span>
<span class="cp">#include &quot;usbdefs.h&quot;</span>
<span class="cp">#include &quot;variax.h&quot;</span>

<span class="cp">#define DRIVER_AUTHOR  &quot;Markus Grabner &lt;grabner@icg.tugraz.at&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC    &quot;Line6 USB Driver&quot;</span>
<span class="cp">#define DRIVER_VERSION &quot;0.9.1beta&quot; DRIVER_REVISION</span>

<span class="cm">/* table of devices that work with this driver */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">line6_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_BASSPODXT</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_BASSPODXTLIVE</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_BASSPODXTPRO</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_GUITARPORT</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_POCKETPOD</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODHD300</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODHD500</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODSTUDIO_GX</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX1</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODX3</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODX3LIVE</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODXT</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODXTLIVE</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_PODXTPRO</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_TONEPORT_GX</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_TONEPORT_UX1</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_TONEPORT_UX2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">LINE6_VENDOR_ID</span><span class="p">,</span> <span class="n">LINE6_DEVID_VARIAX</span><span class="p">)},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">line6_id_table</span><span class="p">);</span>

<span class="cm">/* *INDENT-OFF* */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">line6_properties</span> <span class="n">line6_properties_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_BASSPODXT</span><span class="p">,</span>     <span class="s">&quot;BassPODxt&quot;</span><span class="p">,</span>     <span class="s">&quot;BassPODxt&quot;</span><span class="p">,</span>        <span class="n">LINE6_BIT_CONTROL_PCM_HWMON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_BASSPODXTLIVE</span><span class="p">,</span> <span class="s">&quot;BassPODxtLive&quot;</span><span class="p">,</span> <span class="s">&quot;BassPODxt Live&quot;</span><span class="p">,</span>   <span class="n">LINE6_BIT_CONTROL_PCM_HWMON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_BASSPODXTPRO</span><span class="p">,</span>  <span class="s">&quot;BassPODxtPro&quot;</span><span class="p">,</span>  <span class="s">&quot;BassPODxt Pro&quot;</span><span class="p">,</span>    <span class="n">LINE6_BIT_CONTROL_PCM_HWMON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_GUITARPORT</span><span class="p">,</span>    <span class="s">&quot;GuitarPort&quot;</span><span class="p">,</span>    <span class="s">&quot;GuitarPort&quot;</span><span class="p">,</span>       <span class="n">LINE6_BIT_PCM</span>               <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_POCKETPOD</span><span class="p">,</span>     <span class="s">&quot;PocketPOD&quot;</span><span class="p">,</span>     <span class="s">&quot;Pocket POD&quot;</span><span class="p">,</span>       <span class="n">LINE6_BIT_CONTROL</span>           <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODHD300</span><span class="p">,</span>      <span class="s">&quot;PODHD300&quot;</span><span class="p">,</span>      <span class="s">&quot;POD HD300&quot;</span><span class="p">,</span>        <span class="n">LINE6_BIT_CONTROL_PCM_HWMON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODHD500</span><span class="p">,</span>      <span class="s">&quot;PODHD500&quot;</span><span class="p">,</span>      <span class="s">&quot;POD HD500&quot;</span><span class="p">,</span>        <span class="n">LINE6_BIT_CONTROL_PCM_HWMON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODSTUDIO_GX</span><span class="p">,</span>  <span class="s">&quot;PODStudioGX&quot;</span><span class="p">,</span>   <span class="s">&quot;POD Studio GX&quot;</span><span class="p">,</span>    <span class="n">LINE6_BIT_PCM</span>               <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODSTUDIO_UX1</span><span class="p">,</span> <span class="s">&quot;PODStudioUX1&quot;</span><span class="p">,</span>  <span class="s">&quot;POD Studio UX1&quot;</span><span class="p">,</span>   <span class="n">LINE6_BIT_PCM</span>               <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODSTUDIO_UX2</span><span class="p">,</span> <span class="s">&quot;PODStudioUX2&quot;</span><span class="p">,</span>  <span class="s">&quot;POD Studio UX2&quot;</span><span class="p">,</span>   <span class="n">LINE6_BIT_PCM</span>               <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODX3</span><span class="p">,</span>         <span class="s">&quot;PODX3&quot;</span><span class="p">,</span>         <span class="s">&quot;POD X3&quot;</span><span class="p">,</span>           <span class="n">LINE6_BIT_PCM</span>               <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODX3LIVE</span><span class="p">,</span>     <span class="s">&quot;PODX3Live&quot;</span><span class="p">,</span>     <span class="s">&quot;POD X3 Live&quot;</span><span class="p">,</span>      <span class="n">LINE6_BIT_PCM</span>               <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODXT</span><span class="p">,</span>         <span class="s">&quot;PODxt&quot;</span><span class="p">,</span>         <span class="s">&quot;PODxt&quot;</span><span class="p">,</span>            <span class="n">LINE6_BIT_CONTROL_PCM_HWMON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODXTLIVE</span><span class="p">,</span>     <span class="s">&quot;PODxtLive&quot;</span><span class="p">,</span>     <span class="s">&quot;PODxt Live&quot;</span><span class="p">,</span>       <span class="n">LINE6_BIT_CONTROL_PCM_HWMON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_PODXTPRO</span><span class="p">,</span>      <span class="s">&quot;PODxtPro&quot;</span><span class="p">,</span>      <span class="s">&quot;PODxt Pro&quot;</span><span class="p">,</span>        <span class="n">LINE6_BIT_CONTROL_PCM_HWMON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_TONEPORT_GX</span><span class="p">,</span>   <span class="s">&quot;TonePortGX&quot;</span><span class="p">,</span>    <span class="s">&quot;TonePort GX&quot;</span><span class="p">,</span>      <span class="n">LINE6_BIT_PCM</span>               <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_TONEPORT_UX1</span><span class="p">,</span>  <span class="s">&quot;TonePortUX1&quot;</span><span class="p">,</span>   <span class="s">&quot;TonePort UX1&quot;</span><span class="p">,</span>     <span class="n">LINE6_BIT_PCM</span>               <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_TONEPORT_UX2</span><span class="p">,</span>  <span class="s">&quot;TonePortUX2&quot;</span><span class="p">,</span>   <span class="s">&quot;TonePort UX2&quot;</span><span class="p">,</span>     <span class="n">LINE6_BIT_PCM</span>               <span class="p">},</span>
	<span class="p">{</span> <span class="n">LINE6_BIT_VARIAX</span><span class="p">,</span>        <span class="s">&quot;Variax&quot;</span><span class="p">,</span>        <span class="s">&quot;Variax Workbench&quot;</span><span class="p">,</span> <span class="n">LINE6_BIT_CONTROL</span>           <span class="p">},</span>
<span class="p">};</span>
<span class="cm">/* *INDENT-ON* */</span>

<span class="cm">/*</span>
<span class="cm">	This is Line6&#39;s MIDI manufacturer ID.</span>
<span class="cm">*/</span>
<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">line6_midi_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0c</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">	Code to request version of POD, Variax interface</span>
<span class="cm">	(and maybe other devices).</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">line6_request_version</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xf7</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6_devices</span><span class="p">[</span><span class="n">LINE6_MAX_DEVICES</span><span class="p">];</span>

<span class="cm">/**</span>
<span class="cm">	 Class for asynchronous messages.</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">message</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">	Forward declarations.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">line6_data_received</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">line6_send_raw_message_async_part</span><span class="p">(</span><span class="k">struct</span> <span class="n">message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">	Start to listen on endpoint.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">line6_start_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">urb_listen</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">ep_control_read</span><span class="p">),</span>
			 <span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_listen</span><span class="p">,</span> <span class="n">LINE6_BUFSIZE_LISTEN</span><span class="p">,</span>
			 <span class="n">line6_data_received</span><span class="p">,</span> <span class="n">line6</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>
	<span class="n">line6</span><span class="o">-&gt;</span><span class="n">urb_listen</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">urb_listen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Stop listening on endpoint.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">line6_stop_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">urb_listen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_LINE6_USB_DUMP_ANY</span>
<span class="cm">/*</span>
<span class="cm">	Write hexdump to syslog.</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">line6_write_hexdump</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="kt">char</span> <span class="n">dir</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">BYTES_PER_LINE</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hexdump</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">asc</span><span class="p">[</span><span class="n">BYTES_PER_LINE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">BYTES_PER_LINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">hexdumpsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hexdump</span><span class="p">);</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">hexdump</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">BYTES_PER_LINE</span><span class="p">);</span>
		<span class="n">asc</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BYTES_PER_LINE</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hexdumpsize</span><span class="p">,</span> <span class="s">&quot; %02X&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="n">asc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
					  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="o">?</span> <span class="n">val</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hexdumpsize</span><span class="p">,</span> <span class="s">&quot;   &quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">hexdumpsize</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* buffer overflow */</span>

			<span class="n">p</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">hexdumpsize</span> <span class="o">-=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;%c%04X:%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hexdump</span><span class="p">,</span> <span class="n">asc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_LINE6_USB_DUMP_CTRL</span>
<span class="cm">/*</span>
<span class="cm">	Dump URB data to syslog.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">line6_dump_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">line6_write_hexdump</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
			    <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">	Send raw message in pieces of wMaxPacketSize bytes.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_send_raw_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_LINE6_USB_DUMP_CTRL</span>
	<span class="n">line6_write_hexdump</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">max_packet_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">partial</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">frag_buf</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">frag_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">max_packet_size</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_interrupt_msg</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
					   <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
							  <span class="n">line6</span><span class="o">-&gt;</span><span class="n">ep_control_write</span><span class="p">),</span>
					   <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">frag_buf</span><span class="p">,</span> <span class="n">frag_size</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">partial</span><span class="p">,</span> <span class="n">LINE6_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span>
				<span class="s">&quot;usb_interrupt_msg failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">done</span> <span class="o">+=</span> <span class="n">frag_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Notification of completion of asynchronous request transmission.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">line6_async_request_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">message</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">&gt;=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">line6_send_raw_message_async_part</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Asynchronously send part of a raw message.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">line6_send_raw_message_async_part</span><span class="p">(</span><span class="k">struct</span> <span class="n">message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">line6</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">done</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">max_packet_size</span><span class="p">);</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
			 <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">ep_control_write</span><span class="p">),</span>
			 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">done</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span>
			 <span class="n">line6_async_request_sent</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_LINE6_USB_DUMP_CTRL</span>
	<span class="n">line6_write_hexdump</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">done</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;%s: usb_submit_urb failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Setup and start timer.</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">line6_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">timer_list</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msecs</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Asynchronously send raw message.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_send_raw_message_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">message</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>

	<span class="cm">/* create message: */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">message</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create URB: */</span>
	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set message data: */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">line6</span> <span class="o">=</span> <span class="n">line6</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* start sending: */</span>
	<span class="k">return</span> <span class="n">line6_send_raw_message_async_part</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Send asynchronous device version request.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_version_request_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">line6_request_version</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">line6_request_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line6_request_version</span><span class="p">));</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">line6_send_raw_message_async</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="n">line6_request_version</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Send sysex message in pieces of wMaxPacketSize bytes.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_send_sysex_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">line6_send_raw_message</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
				      <span class="n">size</span> <span class="o">+</span> <span class="n">SYSEX_EXTRA_SIZE</span><span class="p">)</span> <span class="o">-</span>
	    <span class="n">SYSEX_EXTRA_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Send sysex message in pieces of wMaxPacketSize bytes.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_send_sysex_message_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">line6_send_raw_message_async</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
					    <span class="n">size</span> <span class="o">+</span> <span class="n">SYSEX_EXTRA_SIZE</span><span class="p">)</span> <span class="o">-</span>
	    <span class="n">SYSEX_EXTRA_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Allocate buffer for sysex message and prepare header.</span>
<span class="cm">	@param code sysex message code</span>
<span class="cm">	@param size number of bytes between code and sysex end</span>
<span class="cm">*/</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">line6_alloc_sysex_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code2</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">SYSEX_EXTRA_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINE6_SYSEX_BEGIN</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">line6_midi_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line6_midi_id</span><span class="p">));</span>
	<span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">line6_midi_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">code1</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">line6_midi_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">code2</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">line6_midi_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINE6_SYSEX_END</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Notification of data received from the Line6 device.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">line6_data_received</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MidiBuffer</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">line6midi</span><span class="o">-&gt;</span><span class="n">midibuf_in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_LINE6_USB_DUMP_CTRL</span>
	<span class="n">line6_dump_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">done</span> <span class="o">=</span>
	    <span class="n">line6_midibuf_write</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">line6_midibuf_ignore</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="n">DEBUG_MESSAGES</span><span class="p">(</span><span class="n">dev_err</span>
			       <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span>
				<span class="s">&quot;%d %d buffer overflow - message skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">done</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">done</span> <span class="o">=</span>
		    <span class="n">line6_midibuf_read</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_message</span><span class="p">,</span>
				       <span class="n">LINE6_MESSAGE_MAXLEN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* MIDI input filter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line6_midibuf_skip_message</span>
		    <span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">line6midi</span><span class="o">-&gt;</span><span class="n">midi_mask_receive</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">line6</span><span class="o">-&gt;</span><span class="n">message_length</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_LINE6_USB_DUMP_MIDI</span>
		<span class="n">line6_write_hexdump</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_message</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">line6_midi_receive</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_message</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXT</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTLIVE</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTPRO</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODXT</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTPRO</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_POCKETPOD</span>:
			<span class="n">line6_pod_process_message</span><span class="p">((</span><span class="k">struct</span> <span class="n">usb_line6_pod</span> <span class="o">*</span><span class="p">)</span>
						  <span class="n">line6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD300</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD500</span>:
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* let userspace handle MIDI */</span>

		<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTLIVE</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">interface_number</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PODXTLIVE_INTERFACE_POD</span>:
				<span class="n">line6_pod_process_message</span><span class="p">((</span><span class="k">struct</span> <span class="n">usb_line6_pod</span>
							   <span class="o">*</span><span class="p">)</span><span class="n">line6</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">PODXTLIVE_INTERFACE_VARIAX</span>:
				<span class="n">line6_variax_process_message</span><span class="p">((</span><span class="k">struct</span>
							      <span class="n">usb_line6_variax</span>
							      <span class="o">*</span><span class="p">)</span><span class="n">line6</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span>
					<span class="s">&quot;PODxt Live interface %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">line6</span><span class="o">-&gt;</span><span class="n">interface_number</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINE6_DEVID_VARIAX</span>:
			<span class="n">line6_variax_process_message</span><span class="p">((</span><span class="k">struct</span> <span class="n">usb_line6_variax</span> <span class="o">*</span><span class="p">)</span>
						     <span class="n">line6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">MISSING_CASE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">line6_start_listen</span><span class="p">(</span><span class="n">line6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Send channel number (i.e., switch to a different sound).</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_send_program</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">partial</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINE6_PROGRAM_CHANGE</span> <span class="o">|</span> <span class="n">LINE6_CHANNEL_HOST</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_LINE6_USB_DUMP_CTRL</span>
	<span class="n">line6_write_hexdump</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_interrupt_msg</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
				   <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
						  <span class="n">line6</span><span class="o">-&gt;</span><span class="n">ep_control_write</span><span class="p">),</span>
				   <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">partial</span><span class="p">,</span> <span class="n">LINE6_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;usb_interrupt_msg failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">retval</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Transmit Line6 control parameter.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_transmit_parameter</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">partial</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINE6_PARAM_CHANGE</span> <span class="o">|</span> <span class="n">LINE6_CHANNEL_HOST</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_LINE6_USB_DUMP_CTRL</span>
	<span class="n">line6_write_hexdump</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_interrupt_msg</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
				   <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
						  <span class="n">line6</span><span class="o">-&gt;</span><span class="n">ep_control_write</span><span class="p">),</span>
				   <span class="n">buffer</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">partial</span><span class="p">,</span> <span class="n">LINE6_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;usb_interrupt_msg failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">retval</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Read data from device.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">datalen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* query the serial number: */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x67</span><span class="p">,</span>
			      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">datalen</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
			      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LINE6_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;read request failed (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for data length. We&#39;ll get a couple of 0xff until length arrives. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x67</span><span class="p">,</span>
				      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span>
				      <span class="n">USB_DIR_IN</span><span class="p">,</span>
				      <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				      <span class="n">LINE6_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span>
				<span class="s">&quot;receive length failed (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">datalen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* should be equal or something went wrong */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span>
			<span class="s">&quot;length mismatch (expected %d, got %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">datalen</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* receive the result: */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x67</span><span class="p">,</span>
			      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span>
			      <span class="mh">0x0013</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span>
			      <span class="n">LINE6_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;read failed (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Write data to device.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		     <span class="kt">size_t</span> <span class="n">datalen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x67</span><span class="p">,</span>
			      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
			      <span class="mh">0x0022</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span>
			      <span class="n">LINE6_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span>
			<span class="s">&quot;write request failed (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				      <span class="mh">0x67</span><span class="p">,</span>
				      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span>
				      <span class="n">USB_DIR_IN</span><span class="p">,</span>
				      <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LINE6_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span>
				<span class="s">&quot;receiving status failed (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span> <span class="s">&quot;write failed (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Read Line6 device serial number.</span>
<span class="cm">	(POD, TonePort, GuitarPort)</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">line6_read_serial_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">serial_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">line6_read_data</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="mh">0x80d0</span><span class="p">,</span> <span class="n">serial_number</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">serial_number</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	No operation (i.e., unsupported).</span>
<span class="cm">*/</span>
<span class="kt">ssize_t</span> <span class="nf">line6_nop_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	No operation (i.e., unsupported).</span>
<span class="cm">*/</span>
<span class="kt">ssize_t</span> <span class="nf">line6_nop_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	&quot;write&quot; request on &quot;raw&quot; special file.</span>
<span class="cm">*/</span>
<span class="cp">#ifdef CONFIG_LINE6_USB_RAW</span>
<span class="kt">ssize_t</span> <span class="nf">line6_set_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">line6_send_raw_message</span><span class="p">(</span><span class="n">line6</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">	Generic destructor.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">line6_destruct</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interface</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">line6</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line6</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* free buffer memory first: */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_message</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_listen</span><span class="p">);</span>

	<span class="cm">/* then free URBs: */</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">urb_listen</span><span class="p">);</span>

	<span class="cm">/* make sure the device isn&#39;t destructed twice: */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* free interface data: */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">line6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Probe USB device.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">line6_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">devtype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">line6_properties</span> <span class="o">*</span><span class="n">properties</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devnum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interface_number</span><span class="p">,</span> <span class="n">alternate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">product</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ep_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ep_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interface</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">usbdev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* we don&#39;t handle multiple configurations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check vendor and product id */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">devtype</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">line6_id_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">devtype</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">idVendor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">idProduct</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idVendor</span> <span class="o">==</span> <span class="n">line6_id_table</span><span class="p">[</span><span class="n">devtype</span><span class="p">].</span><span class="n">idVendor</span> <span class="o">&amp;&amp;</span>
		    <span class="n">idProduct</span> <span class="o">==</span> <span class="n">line6_id_table</span><span class="p">[</span><span class="n">devtype</span><span class="p">].</span><span class="n">idProduct</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devtype</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find free slot in device table: */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">devnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">devnum</span> <span class="o">&lt;</span> <span class="n">LINE6_MAX_DEVICES</span><span class="p">;</span> <span class="o">++</span><span class="n">devnum</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line6_devices</span><span class="p">[</span><span class="n">devnum</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devnum</span> <span class="o">==</span> <span class="n">LINE6_MAX_DEVICES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize device info: */</span>
	<span class="n">properties</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">line6_properties_table</span><span class="p">[</span><span class="n">devtype</span><span class="p">];</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Line6 %s found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">properties</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">product</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>

	<span class="cm">/* query interface number */</span>
	<span class="n">interface_number</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTLIVE</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTLIVE</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_VARIAX</span>:
		<span class="n">alternate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_POCKETPOD</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">interface_number</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* this interface has no endpoints */</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">alternate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">MISSING_CASE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD500</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3LIVE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">interface_number</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">alternate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">alternate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">MISSING_CASE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXT</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTPRO</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODXT</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTPRO</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD300</span>:
		<span class="n">alternate</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_GUITARPORT</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_GX</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX1</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_GX</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX1</span>:
		<span class="n">alternate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 1..4 seem to be ok */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX2</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX2</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">interface_number</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* defaults to 44.1kHz, 16-bit */</span>
			<span class="n">alternate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* don&#39;t know yet what this is ...</span>
<span class="cm">			   alternate = 1;</span>
<span class="cm">			   break;</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">MISSING_CASE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">MISSING_CASE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">interface_number</span><span class="p">,</span> <span class="n">alternate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set_interface failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize device data based on product id: */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXT</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTLIVE</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTPRO</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODXT</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTPRO</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_pod</span><span class="p">);</span>
		<span class="n">ep_read</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
		<span class="n">ep_write</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD300</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_podhd</span><span class="p">);</span>
		<span class="n">ep_read</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
		<span class="n">ep_write</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD500</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_podhd</span><span class="p">);</span>
		<span class="n">ep_read</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
		<span class="n">ep_write</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_POCKETPOD</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_pod</span><span class="p">);</span>
		<span class="n">ep_read</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
		<span class="n">ep_write</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3LIVE</span>:
		<span class="cm">/* currently unused! */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_pod</span><span class="p">);</span>
		<span class="n">ep_read</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
		<span class="n">ep_write</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_GX</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX1</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX2</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_GX</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX1</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX2</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_GUITARPORT</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_toneport</span><span class="p">);</span>
		<span class="cm">/* these don&#39;t have a control channel */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTLIVE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">interface_number</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PODXTLIVE_INTERFACE_POD</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_pod</span><span class="p">);</span>
			<span class="n">ep_read</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
			<span class="n">ep_write</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PODXTLIVE_INTERFACE_VARIAX</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_variax</span><span class="p">);</span>
			<span class="n">ep_read</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
			<span class="n">ep_write</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_VARIAX</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_variax</span><span class="p">);</span>
		<span class="n">ep_read</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
		<span class="n">ep_write</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">MISSING_CASE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;driver bug: interface data size not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">line6</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line6</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* store basic data: */</span>
	<span class="n">line6</span><span class="o">-&gt;</span><span class="n">interface_number</span> <span class="o">=</span> <span class="n">interface_number</span><span class="p">;</span>
	<span class="n">line6</span><span class="o">-&gt;</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span><span class="p">;</span>
	<span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">usbdev</span><span class="p">;</span>
	<span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">line6</span><span class="o">-&gt;</span><span class="n">ep_control_read</span> <span class="o">=</span> <span class="n">ep_read</span><span class="p">;</span>
	<span class="n">line6</span><span class="o">-&gt;</span><span class="n">ep_control_write</span> <span class="o">=</span> <span class="n">ep_write</span><span class="p">;</span>
	<span class="n">line6</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span><span class="p">;</span>

	<span class="cm">/* get data from endpoint descriptor (see usb_maxpacket): */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">epnum</span> <span class="o">=</span>
		    <span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">ep_read</span><span class="p">));</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">line6</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterval</span><span class="p">;</span>
			<span class="n">line6</span><span class="o">-&gt;</span><span class="n">max_packet_size</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">line6</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">LINE6_FALLBACK_INTERVAL</span><span class="p">;</span>
			<span class="n">line6</span><span class="o">-&gt;</span><span class="n">max_packet_size</span> <span class="o">=</span> <span class="n">LINE6_FALLBACK_MAXPACKETSIZE</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span>
				<span class="s">&quot;endpoint not available, using fallback values&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">line6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">LINE6_BIT_CONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* initialize USB buffers: */</span>
		<span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_listen</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="n">LINE6_BUFSIZE_LISTEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_listen</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_destruct</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_message</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="n">LINE6_MESSAGE_MAXLEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">buffer_message</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_destruct</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">line6</span><span class="o">-&gt;</span><span class="n">urb_listen</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">urb_listen</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">line6_destruct</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_destruct</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">line6_start_listen</span><span class="p">(</span><span class="n">line6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: usb_submit_urb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_destruct</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* initialize device data based on product id: */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXT</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTLIVE</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTPRO</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_POCKETPOD</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3LIVE</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODXT</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTPRO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">line6_pod_init</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_pod</span> <span class="o">*</span><span class="p">)</span><span class="n">line6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD300</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD500</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">line6_podhd_init</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span>
				       <span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_podhd</span> <span class="o">*</span><span class="p">)</span><span class="n">line6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTLIVE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">interface_number</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PODXTLIVE_INTERFACE_POD</span>:
			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">line6_pod_init</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span>
					   <span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_pod</span> <span class="o">*</span><span class="p">)</span><span class="n">line6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PODXTLIVE_INTERFACE_VARIAX</span>:
			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">line6_variax_init</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span>
					      <span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_variax</span> <span class="o">*</span><span class="p">)</span><span class="n">line6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;PODxt Live interface %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">interface_number</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_VARIAX</span>:
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">line6_variax_init</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span>
				      <span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_variax</span> <span class="o">*</span><span class="p">)</span><span class="n">line6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_GX</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX1</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX2</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_GX</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX1</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX2</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_GUITARPORT</span>:
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">line6_toneport_init</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">usb_line6_toneport</span> <span class="o">*</span><span class="p">)</span><span class="n">line6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">MISSING_CASE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_destruct</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				<span class="s">&quot;usb_device&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_destruct</span><span class="p">;</span>

	<span class="cm">/* creation of additional special files should go here */</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Line6 %s now attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">line6</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">line6_devices</span><span class="p">[</span><span class="n">devnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">line6</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3LIVE</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;NOTE: the Line6 %s is detected, but not yet supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">line6</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* increment reference counters: */</span>
	<span class="n">usb_get_intf</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_destruct:</span>
	<span class="n">line6_destruct</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
<span class="nl">err_put:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Line6 device disconnected.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">line6_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interface_number</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interface</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">usbdev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* removal of additional special files should go here */</span>

	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;usb_device&quot;</span><span class="p">);</span>

	<span class="n">interface_number</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">line6</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line6</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">urb_listen</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">line6_stop_listen</span><span class="p">(</span><span class="n">line6</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usbdev</span> <span class="o">!=</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">ifcdev</span><span class="p">,</span>
				<span class="s">&quot;driver bug: inconsistent usb device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXT</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTLIVE</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_BASSPODXTPRO</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_POCKETPOD</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODX3LIVE</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODXT</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTPRO</span>:
			<span class="n">line6_pod_disconnect</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD300</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODHD500</span>:
			<span class="n">line6_podhd_disconnect</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINE6_DEVID_PODXTLIVE</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">interface_number</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PODXTLIVE_INTERFACE_POD</span>:
				<span class="n">line6_pod_disconnect</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">PODXTLIVE_INTERFACE_VARIAX</span>:
				<span class="n">line6_variax_disconnect</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINE6_DEVID_VARIAX</span>:
			<span class="n">line6_variax_disconnect</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_GX</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX1</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX2</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_GX</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX1</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX2</span>:
		<span class="k">case</span> <span class="n">LINE6_DEVID_GUITARPORT</span>:
			<span class="n">line6_toneport_disconnect</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">MISSING_CASE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Line6 %s now disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">line6</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">LINE6_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">line6_devices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">line6</span><span class="p">)</span>
				<span class="n">line6_devices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">line6_destruct</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="cm">/* decrement reference counters: */</span>
	<span class="n">usb_put_intf</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/*</span>
<span class="cm">	Suspend Line6 device.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">line6_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_line6_pcm</span> <span class="o">*</span><span class="n">line6pcm</span> <span class="o">=</span> <span class="n">line6</span><span class="o">-&gt;</span><span class="n">line6pcm</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">LINE6_BIT_CONTROL</span><span class="p">)</span>
		<span class="n">line6_stop_listen</span><span class="p">(</span><span class="n">line6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line6pcm</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">line6pcm</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
		<span class="n">line6_pcm_disconnect</span><span class="p">(</span><span class="n">line6pcm</span><span class="p">);</span>
		<span class="n">line6pcm</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Resume Line6 device.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">line6_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">LINE6_BIT_CONTROL</span><span class="p">)</span>
		<span class="n">line6_start_listen</span><span class="p">(</span><span class="n">line6</span><span class="p">);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Resume Line6 device after reset.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">line6_reset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_line6</span> <span class="o">*</span><span class="n">line6</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">line6</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_GX</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX1</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_PODSTUDIO_UX2</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_GX</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX1</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_TONEPORT_UX2</span>:
	<span class="k">case</span> <span class="n">LINE6_DEVID_GUITARPORT</span>:
		<span class="n">line6_toneport_reset_resume</span><span class="p">((</span><span class="k">struct</span> <span class="n">usb_line6_toneport</span> <span class="o">*</span><span class="p">)</span><span class="n">line6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">line6_resume</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">line6_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">line6_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">line6_disconnect</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">line6_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">line6_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span> <span class="n">line6_reset_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">line6_id_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">line6_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
