<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › net › pc300_drv.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pc300_drv.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#define	USE_PCI_CLOCK</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">rcsid</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">&quot;Revision: 3.4.5 Date: 2002/03/07 &quot;</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * pc300.c	Cyclades-PC300(tm) Driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:	Ivan Passos &lt;ivan@cyclades.com&gt;</span>
<span class="cm"> * Maintainer:	PC300 Maintainer &lt;pc300@cyclades.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright:	(c) 1999-2003 Cyclades Corp.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License</span>
<span class="cm"> *	as published by the Free Software Foundation; either version</span>
<span class="cm"> *	2 of the License, or (at your option) any later version.</span>
<span class="cm"> *	</span>
<span class="cm"> *	Using tabstop = 4.</span>
<span class="cm"> * </span>
<span class="cm"> * $Log: pc300_drv.c,v $</span>
<span class="cm"> * Revision 3.23  2002/03/20 13:58:40  henrique</span>
<span class="cm"> * Fixed ortographic mistakes</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.22  2002/03/13 16:56:56  henrique</span>
<span class="cm"> * Take out the debug messages</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.21  2002/03/07 14:17:09  henrique</span>
<span class="cm"> * License data fixed</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.20  2002/01/17 17:58:52  ivan</span>
<span class="cm"> * Support for PC300-TE/M (PMC).</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.19  2002/01/03 17:08:47  daniela</span>
<span class="cm"> * Enables DMA reception when the SCA-II disables it improperly.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.18  2001/12/03 18:47:50  daniela</span>
<span class="cm"> * Esthetic changes.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.17  2001/10/19 16:50:13  henrique</span>
<span class="cm"> * Patch to kernel 2.4.12 and new generic hdlc.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.16  2001/10/16 15:12:31  regina</span>
<span class="cm"> * clear statistics</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.11 to 3.15  2001/10/11 20:26:04  daniela</span>
<span class="cm"> * More DMA fixes for noisy lines.</span>
<span class="cm"> * Return the size of bad frames in dma_get_rx_frame_size, so that the Rx buffer</span>
<span class="cm"> * descriptors can be cleaned by dma_buf_read (called in cpc_net_rx).</span>
<span class="cm"> * Renamed dma_start routine to rx_dma_start. Improved Rx statistics.</span>
<span class="cm"> * Fixed BOF interrupt treatment. Created dma_start routine.</span>
<span class="cm"> * Changed min and max to cpc_min and cpc_max.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.10  2001/08/06 12:01:51  regina</span>
<span class="cm"> * Fixed problem in DSR_DE bit.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.9  2001/07/18 19:27:26  daniela</span>
<span class="cm"> * Added some history comments.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.8  2001/07/12 13:11:19  regina</span>
<span class="cm"> * bug fix - DCD-OFF in pc300 tty driver</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.3 to 3.7  2001/07/06 15:00:20  daniela</span>
<span class="cm"> * Removing kernel 2.4.3 and previous support.</span>
<span class="cm"> * DMA transmission bug fix.</span>
<span class="cm"> * MTU check in cpc_net_rx fixed.</span>
<span class="cm"> * Boot messages reviewed.</span>
<span class="cm"> * New configuration parameters (line code, CRC calculation and clock).</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.2 2001/06/22 13:13:02  regina</span>
<span class="cm"> * MLPPP implementation. Changed the header of message trace to include</span>
<span class="cm"> * the device name. New format : &quot;hdlcX[R/T]: &quot;.</span>
<span class="cm"> * Default configuration changed.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.1 2001/06/15 regina</span>
<span class="cm"> * in cpc_queue_xmit, netif_stop_queue is called if don&#39;t have free descriptor</span>
<span class="cm"> * upping major version number</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.1.1.1  2001/06/13 20:25:04  daniela</span>
<span class="cm"> * PC300 initial CVS version (3.4.0-pre1)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.0.1.2 2001/06/08 daniela</span>
<span class="cm"> * Did some changes in the DMA programming implementation to avoid the </span>
<span class="cm"> * occurrence of a SCA-II bug when CDA is accessed during a DMA transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.0.1.1 2001/05/02 daniela</span>
<span class="cm"> * Added kernel 2.4.3 support.</span>
<span class="cm"> * </span>
<span class="cm"> * Revision 3.0.1.0 2001/03/13 daniela, henrique</span>
<span class="cm"> * Added Frame Relay Support.</span>
<span class="cm"> * Driver now uses HDLC generic driver to provide protocol support.</span>
<span class="cm"> * </span>
<span class="cm"> * Revision 3.0.0.8 2001/03/02 daniela</span>
<span class="cm"> * Fixed ram size detection. </span>
<span class="cm"> * Changed SIOCGPC300CONF ioctl, to give hw information to pc300util.</span>
<span class="cm"> * </span>
<span class="cm"> * Revision 3.0.0.7 2001/02/23 daniela</span>
<span class="cm"> * netif_stop_queue called before the SCA-II transmition commands in </span>
<span class="cm"> * cpc_queue_xmit, and with interrupts disabled to avoid race conditions with </span>
<span class="cm"> * transmition interrupts.</span>
<span class="cm"> * Fixed falc_check_status for Unframed E1.</span>
<span class="cm"> * </span>
<span class="cm"> * Revision 3.0.0.6 2000/12/13 daniela</span>
<span class="cm"> * Implemented pc300util support: trace, statistics, status and loopback</span>
<span class="cm"> * tests for the PC300 TE boards.</span>
<span class="cm"> * </span>
<span class="cm"> * Revision 3.0.0.5 2000/12/12 ivan</span>
<span class="cm"> * Added support for Unframed E1.</span>
<span class="cm"> * Implemented monitor mode.</span>
<span class="cm"> * Fixed DCD sensitivity on the second channel.</span>
<span class="cm"> * Driver now complies with new PCI kernel architecture.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.0.0.4 2000/09/28 ivan</span>
<span class="cm"> * Implemented DCD sensitivity.</span>
<span class="cm"> * Moved hardware-specific open to the end of cpc_open, to avoid race</span>
<span class="cm"> * conditions with early reception interrupts.</span>
<span class="cm"> * Included code for [request|release]_mem_region().</span>
<span class="cm"> * Changed location of pc300.h .</span>
<span class="cm"> * Minor code revision (contrib. of Jeff Garzik).</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.0.0.3 2000/07/03 ivan</span>
<span class="cm"> * Previous bugfix for the framing errors with external clock made X21</span>
<span class="cm"> * boards stop working. This version fixes it.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.0.0.2 2000/06/23 ivan</span>
<span class="cm"> * Revisited cpc_queue_xmit to prevent race conditions on Tx DMA buffer</span>
<span class="cm"> * handling when Tx timeouts occur.</span>
<span class="cm"> * Revisited Rx statistics.</span>
<span class="cm"> * Fixed a bug in the SCA-II programming that would cause framing errors</span>
<span class="cm"> * when external clock was configured.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.0.0.1 2000/05/26 ivan</span>
<span class="cm"> * Added logic in the SCA interrupt handler so that no board can monopolize</span>
<span class="cm"> * the driver.</span>
<span class="cm"> * Request PLX I/O region, although driver doesn&#39;t use it, to avoid</span>
<span class="cm"> * problems with other drivers accessing it.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 3.0.0.0 2000/05/15 ivan</span>
<span class="cm"> * Did some changes in the DMA programming implementation to avoid the</span>
<span class="cm"> * occurrence of a SCA-II bug in the second channel.</span>
<span class="cm"> * Implemented workaround for PLX9050 bug that would cause a system lockup</span>
<span class="cm"> * in certain systems, depending on the MMIO addresses allocated to the</span>
<span class="cm"> * board.</span>
<span class="cm"> * Fixed the FALC chip programming to avoid synchronization problems in the</span>
<span class="cm"> * second channel (TE only).</span>
<span class="cm"> * Implemented a cleaner and faster Tx DMA descriptor cleanup procedure in</span>
<span class="cm"> * cpc_queue_xmit().</span>
<span class="cm"> * Changed the built-in driver implementation so that the driver can use the</span>
<span class="cm"> * general &#39;hdlcN&#39; naming convention instead of proprietary device names.</span>
<span class="cm"> * Driver load messages are now device-centric, instead of board-centric.</span>
<span class="cm"> * Dynamic allocation of net_device structures.</span>
<span class="cm"> * Code is now compliant with the new module interface (module_[init|exit]).</span>
<span class="cm"> * Make use of the PCI helper functions to access PCI resources.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 2.0.0.0 2000/04/15 ivan</span>
<span class="cm"> * Added support for the PC300/TE boards (T1/FT1/E1/FE1).</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.1.0.0 2000/02/28 ivan</span>
<span class="cm"> * Major changes in the driver architecture.</span>
<span class="cm"> * Softnet compliancy implemented.</span>
<span class="cm"> * Driver now reports physical instead of virtual memory addresses.</span>
<span class="cm"> * Added cpc_change_mtu function.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.0.0.0 1999/12/16 ivan</span>
<span class="cm"> * First official release.</span>
<span class="cm"> * Support for 1- and 2-channel boards (which use distinct PCI Device ID&#39;s).</span>
<span class="cm"> * Support for monolythic installation (i.e., drv built into the kernel).</span>
<span class="cm"> * X.25 additional checking when lapb_[dis]connect_request returns an error.</span>
<span class="cm"> * SCA programming now covers X.21 as well.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.3.1.0 1999/11/18 ivan</span>
<span class="cm"> * Made X.25 support configuration-dependent (as it depends on external </span>
<span class="cm"> * modules to work).</span>
<span class="cm"> * Changed X.25-specific function names to comply with adopted convention.</span>
<span class="cm"> * Fixed typos in X.25 functions that would cause compile errors (Daniela).</span>
<span class="cm"> * Fixed bug in ch_config that would disable interrupts on a previously </span>
<span class="cm"> * enabled channel if the other channel on the same board was enabled later.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.3.0.0 1999/11/16 daniela</span>
<span class="cm"> * X.25 support.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.2.3.0 1999/11/15 ivan</span>
<span class="cm"> * Function cpc_ch_status now provides more detailed information.</span>
<span class="cm"> * Added support for X.21 clock configuration.</span>
<span class="cm"> * Changed TNR1 setting in order to prevent Tx FIFO overaccesses by the SCA.</span>
<span class="cm"> * Now using PCI clock instead of internal oscillator clock for the SCA.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.2.2.0 1999/11/10 ivan</span>
<span class="cm"> * Changed the *_dma_buf_check functions so that they would print only </span>
<span class="cm"> * the useful info instead of the whole buffer descriptor bank.</span>
<span class="cm"> * Fixed bug in cpc_queue_xmit that would eventually crash the system </span>
<span class="cm"> * in case of a packet drop.</span>
<span class="cm"> * Implemented TX underrun handling.</span>
<span class="cm"> * Improved SCA fine tuning to boost up its performance.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.2.1.0 1999/11/03 ivan</span>
<span class="cm"> * Added functions *dma_buf_pt_init to allow independent initialization </span>
<span class="cm"> * of the next-descr. and DMA buffer pointers on the DMA descriptors.</span>
<span class="cm"> * Kernel buffer release and tbusy clearing is now done in the interrupt </span>
<span class="cm"> * handler.</span>
<span class="cm"> * Fixed bug in cpc_open that would cause an interface reopen to fail.</span>
<span class="cm"> * Added a protocol-specific code section in cpc_net_rx.</span>
<span class="cm"> * Removed printk level defs (they might be added back after the beta phase).</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.2.0.0 1999/10/28 ivan</span>
<span class="cm"> * Revisited the code so that new protocols can be easily added / supported. </span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.1.0.1 1999/10/20 ivan</span>
<span class="cm"> * Mostly &quot;esthetic&quot; changes.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.1.0.0 1999/10/11 ivan</span>
<span class="cm"> * Initial version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;pc300.h&quot;</span>

<span class="cp">#define	CPC_LOCK(card,flags)		\</span>
<span class="cp">		do {						\</span>
<span class="cp">		spin_lock_irqsave(&amp;card-&gt;card_lock, flags);	\</span>
<span class="cp">		} while (0)</span>

<span class="cp">#define CPC_UNLOCK(card,flags)			\</span>
<span class="cp">		do {							\</span>
<span class="cp">		spin_unlock_irqrestore(&amp;card-&gt;card_lock, flags);	\</span>
<span class="cp">		} while (0)</span>

<span class="cp">#undef	PC300_DEBUG_PCI</span>
<span class="cp">#undef	PC300_DEBUG_INTR</span>
<span class="cp">#undef	PC300_DEBUG_TX</span>
<span class="cp">#undef	PC300_DEBUG_RX</span>
<span class="cp">#undef	PC300_DEBUG_OTHER</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">cpc_pci_dev_id</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* PC300/RSV or PC300/X21, 2 chan */</span>
	<span class="p">{</span><span class="mh">0x120e</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">},</span>
	<span class="cm">/* PC300/RSV or PC300/X21, 1 chan */</span>
	<span class="p">{</span><span class="mh">0x120e</span><span class="p">,</span> <span class="mh">0x301</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x301</span><span class="p">},</span>
	<span class="cm">/* PC300/TE, 2 chan */</span>
	<span class="p">{</span><span class="mh">0x120e</span><span class="p">,</span> <span class="mh">0x310</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x310</span><span class="p">},</span>
	<span class="cm">/* PC300/TE, 1 chan */</span>
	<span class="p">{</span><span class="mh">0x120e</span><span class="p">,</span> <span class="mh">0x311</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x311</span><span class="p">},</span>
	<span class="cm">/* PC300/TE-M, 2 chan */</span>
	<span class="p">{</span><span class="mh">0x120e</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">},</span>
	<span class="cm">/* PC300/TE-M, 1 chan */</span>
	<span class="p">{</span><span class="mh">0x120e</span><span class="p">,</span> <span class="mh">0x321</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x321</span><span class="p">},</span>
	<span class="cm">/* End of table */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">cpc_pci_dev_id</span><span class="p">);</span>

<span class="cp">#ifndef cpc_min</span>
<span class="cp">#define	cpc_min(a,b)	(((a)&lt;(b))?(a):(b))</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef cpc_max</span>
<span class="cp">#define	cpc_max(a,b)	(((a)&gt;(b))?(a):(b))</span>
<span class="cp">#endif</span>

<span class="cm">/* prototypes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_dma_buf_pt_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_dma_buf_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_dma_buf_pt_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_dma_buf_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_dma_buf_check</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_dma_buf_check</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">cpc_intr</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">clock_rate_calc</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">detect_ram</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">plx_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cpc_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cpc_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cpc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
<span class="kt">void</span> <span class="n">cpc_tty_init</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">cpc_tty_unregister_service</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span> <span class="n">pc300dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">cpc_tty_receive</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span> <span class="n">pc300dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">cpc_tty_trigger_poll</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span> <span class="n">pc300dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/************************/</span>
<span class="cm">/***   DMA Routines   ***/</span>
<span class="cm">/************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_dma_buf_pt_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_factor</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">*</span> <span class="n">N_DMA_TX_BUF</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span>
			               <span class="o">+</span> <span class="n">DMA_TX_BD_BASE</span> <span class="o">+</span> <span class="n">ch_factor</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcsca_bd_t</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_DMA_TX_BUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ptdescr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">DMA_TX_BD_BASE</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">ch_factor</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_TX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcsca_bd_t</span><span class="p">)));</span>
		<span class="n">cpc_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">ptbuf</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">DMA_TX_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch_factor</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">BD_DEF_LEN</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_dma_buf_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_factor</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">*</span> <span class="n">N_DMA_TX_BUF</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span>
			       <span class="o">+</span> <span class="n">DMA_TX_BD_BASE</span> <span class="o">+</span> <span class="n">ch_factor</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcsca_bd_t</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_DMA_TX_BUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ptdescr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset_io</span><span class="p">(</span><span class="n">ptdescr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcsca_bd_t</span><span class="p">));</span>
		<span class="n">cpc_writew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">DST_OSB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tx_dma_buf_pt_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_dma_buf_pt_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_factor</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">*</span> <span class="n">N_DMA_RX_BUF</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span>
				       <span class="o">+</span> <span class="n">DMA_RX_BD_BASE</span> <span class="o">+</span> <span class="n">ch_factor</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcsca_bd_t</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_DMA_RX_BUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ptdescr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">DMA_RX_BD_BASE</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">ch_factor</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_RX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcsca_bd_t</span><span class="p">)));</span>
		<span class="n">cpc_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">ptbuf</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">DMA_RX_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch_factor</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">BD_DEF_LEN</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_dma_buf_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_factor</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">*</span> <span class="n">N_DMA_RX_BUF</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span>
				       <span class="o">+</span> <span class="n">DMA_RX_BD_BASE</span> <span class="o">+</span> <span class="n">ch_factor</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcsca_bd_t</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_DMA_RX_BUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ptdescr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset_io</span><span class="p">(</span><span class="n">ptdescr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcsca_bd_t</span><span class="p">));</span>
		<span class="n">cpc_writew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rx_dma_buf_pt_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_dma_buf_check</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">first_bd</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_first_bd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">next_bd</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_next_bd</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;#CH%d: f_bd = %d(0x%08zx), n_bd = %d(0x%08zx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
	       <span class="n">first_bd</span><span class="p">,</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">first_bd</span><span class="p">),</span>
	       <span class="n">next_bd</span><span class="p">,</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">next_bd</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first_bd</span><span class="p">,</span>
	     <span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">first_bd</span><span class="p">));</span>
	     <span class="n">i</span> <span class="o">!=</span> <span class="p">((</span><span class="n">next_bd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_TX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	     <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_TX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> 
		 <span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> CH%d TX%d: next=0x%x, ptbuf=0x%x, ST=0x%x, len=%d&quot;</span><span class="p">,</span>
		       <span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">),</span>
		       <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">ptbuf</span><span class="p">),</span>
		       <span class="n">cpc_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span> <span class="n">cpc_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef	PC300_DEBUG_OTHER</span>
<span class="cm">/* Show all TX buffer descriptors */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx1_dma_buf_check</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">first_bd</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_first_bd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">next_bd</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_next_bd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>

	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">nfree_tx_bd = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nfree_tx_bd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;#CH%d: f_bd = %d(0x%08x), n_bd = %d(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
	       <span class="n">first_bd</span><span class="p">,</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">first_bd</span><span class="p">),</span>
	       <span class="n">next_bd</span><span class="p">,</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">next_bd</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TX_CDA=0x%08x, TX_EDA=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DTX_REG</span><span class="p">(</span><span class="n">CDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DTX_REG</span><span class="p">(</span><span class="n">EDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_DMA_TX_BUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> CH%d TX%d: next=0x%x, ptbuf=0x%x, ST=0x%x, len=%d&quot;</span><span class="p">,</span>
		       <span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">),</span>
		       <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">ptbuf</span><span class="p">),</span>
		       <span class="n">cpc_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span> <span class="n">cpc_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_dma_buf_check</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">first_bd</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">rx_first_bd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">last_bd</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">rx_last_bd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_factor</span><span class="p">;</span>

	<span class="n">ch_factor</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">*</span> <span class="n">N_DMA_RX_BUF</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;#CH%d: f_bd = %d, l_bd = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">first_bd</span><span class="p">,</span> <span class="n">last_bd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span>
					      <span class="n">DMA_RX_BD_BASE</span> <span class="o">+</span> <span class="n">ch_factor</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcsca_bd_t</span><span class="p">));</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_DMA_RX_BUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ptdescr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DST_OSB</span><span class="p">)</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> CH%d RX%d: next=0x%x, ptbuf=0x%x, ST=0x%x, len=%d&quot;</span><span class="p">,</span>
				 <span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">),</span>
				 <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">ptbuf</span><span class="p">),</span>
				 <span class="n">cpc_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
				 <span class="n">cpc_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_get_rx_frame_size</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">first_bd</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">rx_first_bd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rcvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">RX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">first_bd</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DST_OSB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcvd</span> <span class="o">+=</span> <span class="n">cpc_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">first_bd</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_bd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_RX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DST_EOM</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">first_bd</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">rx_last_bd</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Return the size of a good frame or incomplete bad frame </span>
<span class="cm">			* (dma_buf_read will clean the buffer descriptors in this case). */</span>
			<span class="k">return</span> <span class="n">rcvd</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dma_buf_write: writes a frame to the Tx DMA buffers</span>
<span class="cm"> * NOTE: this function writes one frame at a time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_buf_write</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nchar</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tosend</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nbuf</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">BD_DEF_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nbuf</span> <span class="o">&gt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nfree_tx_bd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbuf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span>
					  <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_next_bd</span><span class="p">));</span>
		<span class="n">nchar</span> <span class="o">=</span> <span class="n">cpc_min</span><span class="p">(</span><span class="n">BD_DEF_LEN</span><span class="p">,</span> <span class="n">tosend</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DST_OSB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy_toio</span><span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">ptbuf</span><span class="p">)),</span>
				    <span class="o">&amp;</span><span class="n">ptdata</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="n">tosend</span><span class="p">],</span> <span class="n">nchar</span><span class="p">);</span>
			<span class="n">cpc_writew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">nchar</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nfree_tx_bd</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">nbuf</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* This must be the last BD to be used */</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">DST_EOM</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tosend</span> <span class="o">-=</span> <span class="n">nchar</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_next_bd</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_next_bd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_TX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* If it gets to here, it means we have sent the whole frame */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dma_buf_read: reads a frame from the Rx DMA buffers</span>
<span class="cm"> * NOTE: this function reads one frame at a time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_buf_read</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nchar</span><span class="p">;</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptdescr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rcvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span>
				  <span class="n">RX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DST_OSB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nchar</span> <span class="o">=</span> <span class="n">cpc_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DST_OVR</span> <span class="o">|</span> <span class="n">DST_CRC</span> <span class="o">|</span> <span class="n">DST_RBIT</span> <span class="o">|</span> <span class="n">DST_SHRT</span> <span class="o">|</span> <span class="n">DST_ABT</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">nchar</span> <span class="o">&gt;</span> <span class="n">BD_DEF_LEN</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nchar</span> <span class="o">&gt;</span> <span class="n">BD_DEF_LEN</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">DST_RBIT</span><span class="p">;</span>
			<span class="n">rcvd</span> <span class="o">=</span> <span class="o">-</span><span class="n">status</span><span class="p">;</span>
			<span class="cm">/* Discard remaining descriptors used by the bad frame */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span> <span class="o">!=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_last_bd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_RX_BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DST_EOM</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span>
							  <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nchar</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nchar</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span><span class="o">+</span><span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">ptbuf</span><span class="p">)),</span><span class="n">nchar</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rcvd</span> <span class="o">+=</span> <span class="n">nchar</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_RX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DST_EOM</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update pointer */</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_last_bd</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_RX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Update EDA */</span>
		<span class="n">cpc_writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRX_REG</span><span class="p">(</span><span class="n">EDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">RX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_last_bd</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rcvd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_dma_stop</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">drr_ena_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">drr_rst_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">);</span>

	<span class="cm">/* Disable DMA */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRR</span><span class="p">,</span> <span class="n">drr_ena_bit</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRR</span><span class="p">,</span> <span class="n">drr_rst_bit</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">drr_ena_bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_dma_stop</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">drr_ena_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">drr_rst_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">);</span>

	<span class="cm">/* Disable DMA */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRR</span><span class="p">,</span> <span class="n">drr_ena_bit</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRR</span><span class="p">,</span> <span class="n">drr_rst_bit</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">drr_ena_bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_dma_start</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	
	<span class="cm">/* Start DMA */</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRX_REG</span><span class="p">(</span><span class="n">CDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">RX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRX_REG</span><span class="p">(</span><span class="n">CDAL</span><span class="p">,</span><span class="n">ch</span><span class="p">))</span> <span class="o">!=</span>
				  <span class="n">RX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cpc_writel</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRX_REG</span><span class="p">(</span><span class="n">CDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">RX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRX_REG</span><span class="p">(</span><span class="n">EDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">RX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_last_bd</span><span class="p">));</span>
	<span class="n">cpc_writew</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRX_REG</span><span class="p">(</span><span class="n">BFLL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">BD_DEF_LEN</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">DSR_DE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DSR_DE</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">DSR_DE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*************************/</span>
<span class="cm">/***   FALC Routines   ***/</span>
<span class="cm">/*************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_issue_cmd</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">SIS</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SIS_CEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">PC300_FALC_MAXLOOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: FALC command locked(cmd=0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CMDR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_intr_enable</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="cm">/* Interrupt pins are open-drain */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IPC</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IPC</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IPC_IC0</span><span class="p">);</span>
	<span class="cm">/* Conters updated each second */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR1_ECM</span><span class="p">);</span>
	<span class="cm">/* Enable SEC and ES interrupts  */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IMR3_SEC</span> <span class="o">|</span> <span class="n">IMR3_ES</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fr_mode</span> <span class="o">==</span> <span class="n">PC300_FR_UNFRAMED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IMR4_LOS</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">(</span><span class="n">IMR4_LFA</span> <span class="o">|</span> <span class="n">IMR4_AIS</span> <span class="o">|</span> <span class="n">IMR4_LOS</span> <span class="o">|</span> <span class="n">IMR4_SLIP</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IMR3_LLBSC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IPC</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IPC</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IPC_SCI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fr_mode</span> <span class="o">==</span> <span class="n">PC300_FR_UNFRAMED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IMR2_LOS</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span>
				   <span class="o">~</span><span class="p">(</span><span class="n">IMR2_FAR</span> <span class="o">|</span> <span class="n">IMR2_LFA</span> <span class="o">|</span> <span class="n">IMR2_AIS</span> <span class="o">|</span> <span class="n">IMR2_LOS</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">multiframe_mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
					   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> 
					   <span class="o">~</span><span class="p">(</span><span class="n">IMR2_T400MS</span> <span class="o">|</span> <span class="n">IMR2_MFAR</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
					   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> 
					   <span class="n">IMR2_T400MS</span> <span class="o">|</span> <span class="n">IMR2_MFAR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_open_timeslot</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeslot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tshf</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">falc</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">ICB1</span> <span class="o">+</span> <span class="p">(</span><span class="n">timeslot</span> <span class="o">-</span> <span class="n">tshf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">ICB1</span> <span class="o">+</span> <span class="p">(</span><span class="n">timeslot</span> <span class="o">-</span> <span class="n">tshf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> 
		   	<span class="o">~</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">timeslot</span> <span class="o">-</span> <span class="n">tshf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)));</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">TTR1</span> <span class="o">+</span> <span class="n">timeslot</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">TTR1</span> <span class="o">+</span> <span class="n">timeslot</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> 
   			<span class="p">(</span><span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">timeslot</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)));</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">RTR1</span> <span class="o">+</span> <span class="n">timeslot</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">RTR1</span> <span class="o">+</span> <span class="n">timeslot</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> 
			<span class="p">(</span><span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">timeslot</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_close_timeslot</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeslot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tshf</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">falc</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">ICB1</span> <span class="o">+</span> <span class="p">(</span><span class="n">timeslot</span> <span class="o">-</span> <span class="n">tshf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">ICB1</span> <span class="o">+</span> <span class="p">(</span><span class="n">timeslot</span> <span class="o">-</span> <span class="n">tshf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> 
		   <span class="p">(</span><span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">timeslot</span> <span class="o">-</span> <span class="n">tshf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)));</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">TTR1</span> <span class="o">+</span> <span class="n">timeslot</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">TTR1</span> <span class="o">+</span> <span class="n">timeslot</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> 
		   <span class="o">~</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">timeslot</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)));</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">RTR1</span> <span class="o">+</span> <span class="n">timeslot</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">((</span><span class="n">RTR1</span> <span class="o">+</span> <span class="n">timeslot</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> 
		   <span class="o">~</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">timeslot</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_close_all_timeslots</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">ICB1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">ICB2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">ICB3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_E1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">ICB4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_open_all_timeslots</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">ICB1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fr_mode</span> <span class="o">==</span> <span class="n">PC300_FR_UNFRAMED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Timeslot 0 is never enabled */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">ICB2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">ICB3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_E1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">ICB4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">ICB4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TTR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RTR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_init_timeslot</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tslot</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tslot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tslot</span> <span class="o">&lt;</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span> <span class="n">tslot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">tslot_bitmap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tslot</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Channel enabled</p></td><td class="code"><div class="highlight"><pre>			<span class="n">falc_open_timeslot</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">tslot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Channel disabled</p></td><td class="code"><div class="highlight"><pre>			<span class="n">falc_close_timeslot</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">tslot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_enable_comm</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">full_bandwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">falc_open_all_timeslots</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">falc_init_timeslot</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>CTS/DCD ON</p></td><td class="code"><div class="highlight"><pre>	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">,</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="o">~</span><span class="p">((</span><span class="n">CPLD_REG1_FALC_DCD</span> <span class="o">|</span> <span class="n">CPLD_REG1_FALC_CTS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_disable_comm</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">falc_close_all_timeslots</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>CTS/DCD OFF</p></td><td class="code"><div class="highlight"><pre>	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">,</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">CPLD_REG1_FALC_DCD</span> <span class="o">|</span> <span class="n">CPLD_REG1_FALC_CTS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_init_t1</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dja</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">?</span> <span class="p">(</span><span class="n">LIM2_DJA2</span> <span class="o">|</span> <span class="n">LIM2_DJA1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Switch to T1 mode (PCM 24) */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">FMR1_PMOD</span><span class="p">);</span>

	<span class="cm">/* Wait 20 us for setup */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Transmit Buffer Size (1 frame) */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">SIC1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">SIC1_XBS0</span><span class="p">);</span>

	<span class="cm">/* Clock mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">phys_settings</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">==</span> <span class="n">CLOCK_INT</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Master mode */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">LIM0_MAS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Slave mode */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LIM0_MAS</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LOOP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LOOP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LOOP_RTM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IPC</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">IPC_SCI</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span>
		   <span class="o">~</span><span class="p">(</span><span class="n">FMR0_XC0</span> <span class="o">|</span> <span class="n">FMR0_XC1</span> <span class="o">|</span> <span class="n">FMR0_RC0</span> <span class="o">|</span> <span class="n">FMR0_RC1</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">lcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PC300_LC_AMI</span>:
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span>
				   <span class="n">FMR0_XC1</span> <span class="o">|</span> <span class="n">FMR0_RC1</span><span class="p">);</span>
			<span class="cm">/* Clear Channel register to ON for all channels */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CCB1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CCB2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CCB3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_LC_B8ZS</span>:
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span>
				   <span class="n">FMR0_XC0</span> <span class="o">|</span> <span class="n">FMR0_XC1</span> <span class="o">|</span> <span class="n">FMR0_RC0</span> <span class="o">|</span> <span class="n">FMR0_RC1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_LC_NRZ</span>:
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">LIM0_ELOS</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LIM0_SCL1</span> <span class="o">|</span> <span class="n">LIM0_SCL0</span><span class="p">));</span>
	<span class="cm">/* Set interface mode to 2 MBPS */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR1_IMOD</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fr_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PC300_FR_ESF</span>:
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">multiframe_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR4_FM1</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> 
				   <span class="n">FMR1_CRC</span> <span class="o">|</span> <span class="n">FMR1_EDL</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XDL1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XDL2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XDL3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR0_SRAF</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span><span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR2_MCSP</span> <span class="o">|</span> <span class="n">FMR2_SSP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_FR_D4</span>:
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">multiframe_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span>
				   <span class="o">~</span><span class="p">(</span><span class="n">FMR4_FM1</span> <span class="o">|</span> <span class="n">FMR4_FM0</span><span class="p">));</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR0_SRAF</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR2_SSP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable Automatic Resynchronization */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR4_AUTO</span><span class="p">);</span>

	<span class="cm">/* Transmit Automatic Remote Alarm */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR2_AXRA</span><span class="p">);</span>

	<span class="cm">/* Channel translation mode 1 : one to one */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR1_CTM</span><span class="p">);</span>

	<span class="cm">/* No signaling */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR1_SIGM</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span>
		   <span class="o">~</span><span class="p">(</span><span class="n">FMR5_EIBR</span> <span class="o">|</span> <span class="n">FMR5_SRS</span><span class="p">));</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">LIM1_RIL0</span> <span class="o">|</span> <span class="n">LIM1_RIL1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">lbo</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Provides proper Line Build Out */</span>
		<span class="k">case</span> <span class="n">PC300_LBO_0_DB</span>:
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="n">LIM2_LOS1</span> <span class="o">|</span> <span class="n">dja</span><span class="p">));</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x5a</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x8f</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PC300_LBO_7_5_DB</span>:
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x40</span> <span class="o">|</span> <span class="n">LIM2_LOS1</span> <span class="o">|</span> <span class="n">dja</span><span class="p">));</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x11</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x02</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PC300_LBO_15_DB</span>:
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">LIM2_LOS1</span> <span class="o">|</span> <span class="n">dja</span><span class="p">));</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x8e</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PC300_LBO_22_5_DB</span>:
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="mh">0xc0</span> <span class="o">|</span> <span class="n">LIM2_LOS1</span> <span class="o">|</span> <span class="n">dja</span><span class="p">));</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x09</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Transmit Clock-Slot Offset */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XC0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XC0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="cm">/* Transmit Time-slot Offset */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XC1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x3e</span><span class="p">);</span>
	<span class="cm">/* Receive  Clock-Slot offset */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RC0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="cm">/* Receive  Time-slot offset */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RC1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* LOS Detection after 176 consecutive 0s */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">PCDR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x0a</span><span class="p">);</span>
	<span class="cm">/* LOS Recovery after 22 ones in the time window of PCD */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">PCRR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x15</span><span class="p">);</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IDLE</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fr_mode</span> <span class="o">==</span> <span class="n">PC300_FR_ESF_JAPAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RC1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RC1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">falc_close_all_timeslots</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_init_e1</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dja</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">?</span> <span class="p">(</span><span class="n">LIM2_DJA2</span> <span class="o">|</span> <span class="n">LIM2_DJA1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Switch to E1 mode (PCM 30) */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR1_PMOD</span><span class="p">);</span>

	<span class="cm">/* Clock mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">phys_settings</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">==</span> <span class="n">CLOCK_INT</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Master mode */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">LIM0_MAS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Slave mode */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LIM0_MAS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LOOP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LOOP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LOOP_SFM</span><span class="p">);</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IPC</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">IPC_SCI</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span>
		   <span class="o">~</span><span class="p">(</span><span class="n">FMR0_XC0</span> <span class="o">|</span> <span class="n">FMR0_XC1</span> <span class="o">|</span> <span class="n">FMR0_RC0</span> <span class="o">|</span> <span class="n">FMR0_RC1</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">lcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PC300_LC_AMI</span>:
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span>
				   <span class="n">FMR0_XC1</span> <span class="o">|</span> <span class="n">FMR0_RC1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_LC_HDB3</span>:
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span>
				   <span class="n">FMR0_XC0</span> <span class="o">|</span> <span class="n">FMR0_XC1</span> <span class="o">|</span> <span class="n">FMR0_RC0</span> <span class="o">|</span> <span class="n">FMR0_RC1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_LC_NRZ</span>:
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LIM0_SCL1</span> <span class="o">|</span> <span class="n">LIM0_SCL0</span><span class="p">));</span>
	<span class="cm">/* Set interface mode to 2 MBPS */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR1_IMOD</span><span class="p">);</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XPM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fr_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PC300_FR_MF_CRC4</span>:
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">multiframe_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR1_XFS</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR2_RFS1</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR2_RFS0</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR3_EXTIW</span><span class="p">);</span>

			<span class="cm">/* MultiFrame Resynchronization */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR1_MFCS</span><span class="p">);</span>

			<span class="cm">/* Automatic Loss of Multiframe &gt; 914 CRC errors */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR2_ALMF</span><span class="p">);</span>

			<span class="cm">/* S1 and SI1/SI2 spare Bits set to 1 */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XSP_AXS</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">XSP_EBP</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">XSP_XS13</span> <span class="o">|</span> <span class="n">XSP_XS15</span><span class="p">);</span>

			<span class="cm">/* Automatic Force Resynchronization */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR1_AFR</span><span class="p">);</span>

			<span class="cm">/* Transmit Automatic Remote Alarm */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR2_AXRA</span><span class="p">);</span>

			<span class="cm">/* Transmit Spare Bits for National Use (Y, Sn, Sa) */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span>
				   <span class="n">XSW_XY0</span> <span class="o">|</span> <span class="n">XSW_XY1</span> <span class="o">|</span> <span class="n">XSW_XY2</span> <span class="o">|</span> <span class="n">XSW_XY3</span> <span class="o">|</span> <span class="n">XSW_XY4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_FR_MF_NON_CRC4</span>:
		<span class="k">case</span> <span class="n">PC300_FR_D4</span>:
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">multiframe_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR1_XFS</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> 
				   <span class="o">~</span><span class="p">(</span><span class="n">FMR2_RFS1</span> <span class="o">|</span> <span class="n">FMR2_RFS0</span><span class="p">));</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">XSW_XSIS</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">XSP_XSIF</span><span class="p">);</span>

			<span class="cm">/* Automatic Force Resynchronization */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR1_AFR</span><span class="p">);</span>

			<span class="cm">/* Transmit Automatic Remote Alarm */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR2_AXRA</span><span class="p">);</span>

			<span class="cm">/* Transmit Spare Bits for National Use (Y, Sn, Sa) */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span>
				   <span class="n">XSW_XY0</span> <span class="o">|</span> <span class="n">XSW_XY1</span> <span class="o">|</span> <span class="n">XSW_XY2</span> <span class="o">|</span> <span class="n">XSW_XY3</span> <span class="o">|</span> <span class="n">XSW_XY4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_FR_UNFRAMED</span>:
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">multiframe_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR1_XFS</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> 
				   <span class="o">~</span><span class="p">(</span><span class="n">FMR2_RFS1</span> <span class="o">|</span> <span class="n">FMR2_RFS0</span><span class="p">));</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">XSP_TT0</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> 
				   <span class="o">~</span><span class="p">(</span><span class="n">XSW_XTM</span><span class="o">|</span><span class="n">XSW_XY0</span><span class="o">|</span><span class="n">XSW_XY1</span><span class="o">|</span><span class="n">XSW_XY2</span><span class="o">|</span><span class="n">XSW_XY3</span><span class="o">|</span><span class="n">XSW_XY4</span><span class="p">));</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">TSWM</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">FMR2_RTM</span> <span class="o">|</span> <span class="n">FMR2_DAIS</span><span class="p">));</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR2_AXRA</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR1_AFR</span><span class="p">);</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">CPLD_REG2_FALC_LED2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No signaling */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XSP_CASEN</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">LIM1_RIL0</span> <span class="o">|</span> <span class="n">LIM1_RIL1</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="n">LIM2_LOS1</span> <span class="o">|</span> <span class="n">dja</span><span class="p">));</span>

	<span class="cm">/* Transmit Clock-Slot Offset */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XC0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XC0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="cm">/* Transmit Time-slot Offset */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XC1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x3e</span><span class="p">);</span>
	<span class="cm">/* Receive  Clock-Slot offset */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RC0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="cm">/* Receive  Time-slot offset */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RC1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* LOS Detection after 176 consecutive 0s */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">PCDR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x0a</span><span class="p">);</span>
	<span class="cm">/* LOS Recovery after 22 ones in the time window of PCD */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">PCRR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x15</span><span class="p">);</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IDLE</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="n">falc_close_all_timeslots</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_init_hdlc</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="cm">/* Enable transparent data transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fr_mode</span> <span class="o">==</span> <span class="n">PC300_FR_UNFRAMED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">MODE</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">MODE</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">MODE</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">MODE_HRAC</span> <span class="o">|</span> <span class="n">MODE_MDS2</span><span class="p">));</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RAH2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RAH1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RAL2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RAL1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Tx/Rx reset  */</span>
	<span class="n">falc_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">CMDR_RRES</span> <span class="o">|</span> <span class="n">CMDR_XRES</span> <span class="o">|</span> <span class="n">CMDR_SRES</span><span class="p">);</span>

	<span class="cm">/* Enable interrupt sources */</span>
	<span class="n">falc_intr_enable</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">te_config</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pfalc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">falc_t</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IF_IFACE_T1</span>:
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">NUM_OF_T1_CHANNELS</span><span class="p">;</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IF_IFACE_E1</span>:
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">NUM_OF_E1_CHANNELS</span><span class="p">;</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">tslot_bitmap</span> <span class="o">==</span> <span class="mh">0xffffffffUL</span><span class="p">)</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">full_bandwidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">full_bandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CPC_LOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Reset the FALC chip */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">,</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">CPLD_REG1_FALC_RESET</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">,</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="o">~</span><span class="p">(</span><span class="n">CPLD_REG1_FALC_RESET</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">falc_init_t1</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">falc_init_e1</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">falc_init_hdlc</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">rx_sens</span> <span class="o">==</span> <span class="n">PC300_RX_SENS_SH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LIM0_EQON</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">LIM0_EQON</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">CPLD_REG2_FALC_TX_CLK</span> <span class="o">|</span> <span class="n">CPLD_REG2_FALC_RX_CLK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>

	<span class="cm">/* Clear all interrupt registers */</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">+</span>
		<span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">+</span>
		<span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">+</span>
		<span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
	<span class="n">CPC_UNLOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_check_status</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">frs0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="cm">/* Verify LOS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frs0</span> <span class="o">&amp;</span> <span class="n">FRS0_LOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">red_alarm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">red_alarm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">los</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">blue_alarm</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Disable this interrupt as it may otherwise interfere </span>
<span class="cm">					 * with other working boards. */</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> 
						   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
						   <span class="o">|</span> <span class="n">IMR0_PDEN</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">falc_disable_comm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">red_alarm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">red_alarm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">losr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fr_mode</span> <span class="o">!=</span> <span class="n">PC300_FR_UNFRAMED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Verify AIS alarm */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frs0</span> <span class="o">&amp;</span> <span class="n">FRS0_AIS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">blue_alarm</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">blue_alarm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">ais</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>EVENT_AIS</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Disable this interrupt as it may otherwise interfere with                       other working boards. */</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
						   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IMR0_PDEN</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">falc_disable_comm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>EVENT_AIS</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">blue_alarm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Verify LFA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frs0</span> <span class="o">&amp;</span> <span class="n">FRS0_LFA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_fa</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_fa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">lfa</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">blue_alarm</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">red_alarm</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* Disable this interrupt as it may otherwise </span>
<span class="cm">						 * interfere with other working boards. */</span>
						<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
							   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
							   <span class="o">|</span> <span class="n">IMR0_PDEN</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">falc_disable_comm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_fa</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_fa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">farec</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Verify LMFA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">multiframe_mode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">frs0</span> <span class="o">&amp;</span> <span class="n">FRS0_LMFA</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* D4 or CRC4 frame mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_mfa</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_mfa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">lmfa</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">blue_alarm</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">red_alarm</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_fa</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* Disable this interrupt as it may otherwise </span>
<span class="cm">						 * interfere with other working boards. */</span>
						<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
							   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
							   <span class="o">|</span> <span class="n">IMR0_PDEN</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">falc_disable_comm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_mfa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Verify Remote Alarm */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frs0</span> <span class="o">&amp;</span> <span class="n">FRS0_RRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">yellow_alarm</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">yellow_alarm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">rai</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>EVENT_RAI</p></td><td class="code"><div class="highlight"><pre>					<span class="n">falc_disable_comm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>EVENT_RAI</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">yellow_alarm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* if !PC300_UNFRAMED */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">red_alarm</span> <span class="o">||</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_fa</span> <span class="o">||</span>
	    <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_mfa</span> <span class="o">||</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">blue_alarm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">line_off</span><span class="o">++</span><span class="p">;</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span>
				   <span class="o">~</span><span class="p">(</span><span class="n">CPLD_REG2_FALC_LED2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">line_on</span><span class="o">++</span><span class="p">;</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">CPLD_REG2_FALC_LED2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">yellow_alarm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>EVENT<em>FALC</em>NORMAL</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
					   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IMR0_PDEN</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">falc_enable_comm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>EVENT<em>FALC</em>NORMAL</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_update_stats</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">counter</span><span class="p">;</span>

	<span class="n">counter</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FECL</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
	<span class="n">counter</span> <span class="o">|=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FECH</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">+=</span> <span class="n">counter</span><span class="p">;</span>

	<span class="n">counter</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CVCL</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
	<span class="n">counter</span> <span class="o">|=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CVCH</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">cvc</span> <span class="o">+=</span> <span class="n">counter</span><span class="p">;</span>

	<span class="n">counter</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CECL</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
	<span class="n">counter</span> <span class="o">|=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">CECH</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">cec</span> <span class="o">+=</span> <span class="n">counter</span><span class="p">;</span>

	<span class="n">counter</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">EBCL</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
	<span class="n">counter</span> <span class="o">|=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">EBCH</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">ebc</span> <span class="o">+=</span> <span class="n">counter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LCR1_EPRM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">counter</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">BECL</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
		<span class="n">counter</span> <span class="o">|=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">BECH</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">bec</span> <span class="o">+=</span> <span class="n">counter</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FRS1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">FRS1_LLBAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FRS1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">FRS1_PDEN</span><span class="p">)))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_E1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RSP_LLBAD</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">prbs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">prbs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * falc_remote_loop</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> * Description:	In the remote loopback mode the clock and data recovered</span>
<span class="cm"> *		from the line inputs RL1/2 or RDIP/RDIN are routed back</span>
<span class="cm"> *		to the line outputs XL1/2 or XDOP/XDON via the analog</span>
<span class="cm"> *		transmitter. As in normal mode they are processed by</span>
<span class="cm"> *		the synchronizer and then sent to the system interface.</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_remote_loop</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loop_on</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable this interrupt as it may otherwise interfere with </span>
<span class="cm">			 * other working boards. */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IMR0_PDEN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">falc_disable_comm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">LIM1_RL</span><span class="p">);</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LIM1_RL</span><span class="p">);</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">(</span><span class="n">CPLD_REG2_FALC_LED2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">falc_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">CMDR_XRES</span><span class="p">);</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * falc_local_loop</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> * Description: The local loopback mode disconnects the receive lines </span>
<span class="cm"> *		RL1/RL2 resp. RDIP/RDIN from the receiver. Instead of the</span>
<span class="cm"> *		signals coming from the line the data provided by system</span>
<span class="cm"> *		interface are routed through the analog receiver back to</span>
<span class="cm"> *		the system interface. The unipolar bit stream will be</span>
<span class="cm"> *		undisturbed transmitted on the line. Receiver and transmitter</span>
<span class="cm"> *		coding must be identical.</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_local_loop</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loop_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">LIM0_LL</span><span class="p">);</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LIM0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LIM0_LL</span><span class="p">);</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * falc_payload_loop</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> * Description: This routine allows to enable/disable payload loopback.</span>
<span class="cm"> *		When the payload loop is activated, the received 192 bits</span>
<span class="cm"> *		of payload data will be looped back to the transmit</span>
<span class="cm"> *		direction. The framing bits, CRC6 and DL bits are not </span>
<span class="cm"> *		looped. They are originated by the FALC-LH transmitter.</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_payload_loop</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loop_on</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable this interrupt as it may otherwise interfere with </span>
<span class="cm">			 * other working boards. */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IMR0_PDEN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">falc_disable_comm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR2_PLB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR4_TM</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">XSP_TT0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">falc_open_all_timeslots</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR2_PLB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR4</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR4_TM</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XSP_TT0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">(</span><span class="n">CPLD_REG2_FALC_LED2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">falc_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">CMDR_XRES</span><span class="p">);</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * turn_off_xlu</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> * Description:	Turns XLU bit off in the proper register</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">turn_off_xlu</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR5_XLU</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR3_XLU</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * turn_off_xld</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> * Description: Turns XLD bit off in the proper register</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">turn_off_xld</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR5_XLD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMR3_XLD</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * falc_generate_loop_up_code</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> * Description:	This routine writes the proper FALC chip register in order</span>
<span class="cm"> *		to generate a LOOP activation code over a T1/E1 line.</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_generate_loop_up_code</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR5_XLU</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR3_XLU</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable this interrupt as it may otherwise interfere with </span>
<span class="cm">		 * other working boards. */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IMR0_PDEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">falc_disable_comm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>EVENT<em>FALC</em>ABNORMAL</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_gen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * falc_generate_loop_down_code</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> * Description:	This routine writes the proper FALC chip register in order</span>
<span class="cm"> *		to generate a LOOP deactivation code over a T1/E1 line.</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_generate_loop_down_code</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR5</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR5_XLD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">FMR3_XLD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="o">~</span><span class="p">(</span><span class="n">CPLD_REG2_FALC_LED2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>?    falc<em>issue</em>cmd(card, ch, CMDR_XRES);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * falc_pattern_test</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> * Description:	This routine generates a pattern code and checks</span>
<span class="cm"> *		it on the reception side.</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_pattern_test</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">activate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">activate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">prbs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">bec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable local loop activation/deactivation detect */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IMR3_LLBSC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Disable local loop activation/deactivation detect */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IMR1_LLBSC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Activates generation and monitoring of PRBS </span>
<span class="cm">		 * (Pseudo Random Bit Sequence) */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">LCR1_EPRM</span> <span class="o">|</span> <span class="n">LCR1_XPRBS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">prbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Deactivates generation and monitoring of PRBS </span>
<span class="cm">		 * (Pseudo Random Bit Sequence) */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span><span class="o">+</span><span class="n">F_REG</span><span class="p">(</span><span class="n">LCR1</span><span class="p">,</span><span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LCR1_EPRM</span> <span class="o">|</span> <span class="n">LCR1_XPRBS</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable local loop activation/deactivation detect */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IMR3_LLBSC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Enable local loop activation/deactivation detect */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IMR1_LLBSC</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * falc_pattern_test_error</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> * Description:	This routine returns the bit error counter value</span>
<span class="cm"> *----------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">falc_pattern_test_error</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">bec</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************/</span>
<span class="cm">/***   Net Interface Routines   ***/</span>
<span class="cm">/**********************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cpc_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_main</span><span class="p">,</span> <span class="kt">char</span> <span class="n">rx_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">skb_main</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">skb_main</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_CUST</span><span class="p">);</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">skb_main</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;[&#39;</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx_tx</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;]&#39;</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb_main</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">skb_main</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpc_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ilar</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">CPC_LOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ilar</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">ILAR</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ILAR=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ilar</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">ILAR</span><span class="p">,</span> <span class="n">ilar</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DMER</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">(</span><span class="n">CPLD_REG2_FALC_LED1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">CPC_UNLOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpc_queue_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef PC300_DEBUG_TX</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* DCD must be OFF: drop packet */</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ST3_DCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: DCD is OFF. Going administrative down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">CPC_LOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">CMD_TX_BUF_CLR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
				   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span> 
				   			<span class="o">~</span><span class="p">(</span><span class="n">CPLD_REG2_FALC_LED1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">CPC_UNLOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write buffer to DMA buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_buf_write</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><pre><code>printk("%s: write error. Dropping TX packet.\n", dev-&gt;name);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef PC300_DEBUG_TX</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s T:&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trace_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_trace</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Start transmission */</span>
	<span class="n">CPC_LOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* verify if it has more than one free descriptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nfree_tx_bd</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t have so stop the queue */</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DTX_REG</span><span class="p">(</span><span class="n">EDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_next_bd</span><span class="p">));</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">CMD_TX_ENA</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">DSR_DE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">CPLD_REG2_FALC_LED1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="n">CPC_UNLOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpc_net_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
<span class="cp">#ifdef PC300_DEBUG_RX</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">rxb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rxb</span> <span class="o">=</span> <span class="n">dma_get_rx_frame_size</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* DCD must be OFF: drop packet */</span>
		    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s : DCD is OFF - drop %d rx bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rxb</span><span class="p">);</span> 
			<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">40</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* add headers */</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s : MTU exceeded %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rxb</span><span class="p">);</span> 
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Memory squeeze!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">rxb</span> <span class="o">=</span> <span class="n">dma_buf_read</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef PC300_DEBUG_RX</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: rxb = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rxb</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rxb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* rxb &gt; dev-&gt;mtu */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Invalid frame */</span>
				<span class="n">rxb</span> <span class="o">=</span> <span class="o">-</span><span class="n">rxb</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span> <span class="o">&amp;</span> <span class="n">DST_OVR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span> <span class="o">&amp;</span> <span class="n">DST_CRC</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DST_RBIT</span> <span class="o">|</span> <span class="n">DST_SHRT</span> <span class="o">|</span> <span class="n">DST_ABT</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">rxb</span><span class="p">;</span>

<span class="cp">#ifdef PC300_DEBUG_RX</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s R:&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trace_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpc_trace</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hdlc_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************************/</span>
<span class="cm">/***   PC300 Interrupt Routines   ***/</span>
<span class="cm">/************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sca_tx_intr</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span> 
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span> 
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span> 
	<span class="k">volatile</span> <span class="n">pcsca_bd_t</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">ptdescr</span><span class="p">;</span> 

    <span class="cm">/* Clean up descriptors from previous transmission */</span>
	<span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span>
						<span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_first_bd</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">cpc_readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DTX_REG</span><span class="p">(</span><span class="n">CDAL</span><span class="p">,</span><span class="n">ch</span><span class="p">))</span> <span class="o">!=</span>
		<span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_first_bd</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DST_OSB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">cpc_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">DST_OSB</span><span class="p">);</span>
		<span class="n">cpc_writew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptdescr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">nfree_tx_bd</span><span class="o">++</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_first_bd</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_first_bd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_DMA_TX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ptdescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_first_bd</span><span class="p">));</span>
    <span class="p">}</span>

<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpc_tty_trigger_poll</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#endif</span>
	<span class="cm">/* Tell the upper layer we are ready to transmit more packets */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sca_intr</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dsr_rx</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">ISR0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nchan</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
			<span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">);</span>

	    <span class="cm">/**** Reception ****/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IR0_DRX</span><span class="p">((</span><span class="n">IR0_DMIA</span> <span class="o">|</span> <span class="n">IR0_DMIB</span><span class="p">),</span> <span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">drx_stat</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

				<span class="cm">/* Clear RX interrupts */</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">drx_stat</span> <span class="o">|</span> <span class="n">DSR_DWE</span><span class="p">);</span>

<span class="cp">#ifdef PC300_DEBUG_INTR</span>
				<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;sca_intr: RX intr chan[%d] (st=0x%08lx, dsr=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ch</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">drx_stat</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IR0_DRX</span><span class="p">(</span><span class="n">IR0_DMIA</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">drx_stat</span> <span class="o">&amp;</span> <span class="n">DSR_BOF</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* verify if driver is TTY */</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DSR_DE</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">rx_dma_stop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
							<span class="p">}</span>
							<span class="n">cpc_tty_receive</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
							<span class="n">rx_dma_start</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> 
<span class="cp">#endif</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DSR_DE</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">rx_dma_stop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
							<span class="p">}</span>
							<span class="n">cpc_net_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
							<span class="cm">/* Discard invalid frames */</span>
							<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
							<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
							<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_last_bd</span> <span class="o">=</span> <span class="n">N_DMA_RX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">rx_dma_start</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IR0_DRX</span><span class="p">(</span><span class="n">IR0_DMIB</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">drx_stat</span> <span class="o">&amp;</span> <span class="n">DSR_EOM</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span>
								   <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
								   <span class="n">cpc_readb</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span>
								    	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">|</span>
								   <span class="p">(</span><span class="n">CPLD_REG2_FALC_LED1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
						<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* verify if driver is TTY */</span>
							<span class="n">cpc_tty_receive</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">cpc_net_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
						<span class="p">}</span>
<span class="cp">#else</span>
						<span class="n">cpc_net_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span>
								   <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
								   <span class="n">cpc_readb</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span>
								    		<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span>
								   <span class="o">~</span> <span class="p">(</span><span class="n">CPLD_REG2_FALC_LED1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dsr_rx</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DSR_DE</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef PC300_DEBUG_INTR</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: RX intr chan[%d] (st=0x%08lx, dsr=0x%02x, dsr2=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">drx_stat</span><span class="p">,</span> <span class="n">dsr_rx</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="n">dsr_rx</span> <span class="o">|</span> <span class="n">DSR_DE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

	    <span class="cm">/**** Transmission ****/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IR0_DTX</span><span class="p">((</span><span class="n">IR0_EFT</span> <span class="o">|</span> <span class="n">IR0_DMIA</span> <span class="o">|</span> <span class="n">IR0_DMIB</span><span class="p">),</span> <span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">dtx_stat</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

				<span class="cm">/* Clear TX interrupts */</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">dtx_stat</span> <span class="o">|</span> <span class="n">DSR_DWE</span><span class="p">);</span>

<span class="cp">#ifdef PC300_DEBUG_INTR</span>
				<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;sca_intr: TX intr chan[%d] (st=0x%08lx, dsr=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ch</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">dtx_stat</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IR0_DTX</span><span class="p">(</span><span class="n">IR0_EFT</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dtx_stat</span> <span class="o">&amp;</span> <span class="n">DSR_UDRF</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span> <span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TBN</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span><span class="n">ch</span><span class="p">),</span> <span class="n">CMD_TX_BUF_CLR</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
								   <span class="n">cpc_readb</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> 
										   <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span>
								   <span class="o">~</span> <span class="p">(</span><span class="n">CPLD_REG2_FALC_LED1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
						<span class="p">}</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
						<span class="n">sca_tx_intr</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IR0_DTX</span><span class="p">(</span><span class="n">IR0_DMIA</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dtx_stat</span> <span class="o">&amp;</span> <span class="n">DSR_BOF</span><span class="p">)</span> <span class="p">{</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IR0_DTX</span><span class="p">(</span><span class="n">IR0_DMIB</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dtx_stat</span> <span class="o">&amp;</span> <span class="n">DSR_EOM</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
								   <span class="n">cpc_readb</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span>
								    			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span>
								   <span class="o">~</span> <span class="p">(</span><span class="n">CPLD_REG2_FALC_LED1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
						<span class="p">}</span>
						<span class="n">sca_tx_intr</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

	    <span class="cm">/**** MSCI ****/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IR0_M</span><span class="p">(</span><span class="n">IR0_RXINTA</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">st1</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST1</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>

				<span class="cm">/* Clear MSCI interrupts */</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">st1</span><span class="p">);</span>

<span class="cp">#ifdef PC300_DEBUG_INTR</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sca_intr: MSCI intr chan[%d] (st=0x%08lx, st1=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ch</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">st1</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">st1</span> <span class="o">&amp;</span> <span class="n">ST1_CDCD</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* DCD changed */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ST3_DCD</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%s: DCD is OFF. Going administrative down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
						<span class="p">}</span>
<span class="cp">#else</span>
						<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#endif</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">line_off</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* DCD = 1 */</span>
						<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%s: DCD is ON. Going administrative up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">)</span>
							<span class="cm">/* verify if driver is not TTY */</span>
<span class="cp">#endif</span>
							<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">line_on</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">intr_count</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
			<span class="cm">/* Too much work at this board. Force exit */</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_t1_loop_detection</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">u8</span> <span class="n">frs1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LCR1_XPRBS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_gen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frs1</span> <span class="o">&amp;</span> <span class="n">FRS1_LLBDD</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>A Line Loop Back Deactivation signal detected</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">falc_remote_loop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">frs1</span> <span class="o">&amp;</span> <span class="n">FRS1_LLBAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LCR1_EPRM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>A Line Loop Back Activation signal detected  </p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">falc_remote_loop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_e1_loop_detection</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LCR1_XPRBS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_gen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span> <span class="o">&amp;</span> <span class="n">RSP_LLBDD</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>A Line Loop Back Deactivation signal detected</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">falc_remote_loop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rsp</span> <span class="o">&amp;</span> <span class="n">RSP_LLBAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">LCR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LCR1_EPRM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>A Line Loop Back Activation signal detected  </p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loop_active</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">falc_remote_loop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_t1_intr</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">isr0</span><span class="p">,</span> <span class="n">isr3</span><span class="p">,</span> <span class="n">gis</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">gis</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">GIS</span><span class="p">,</span> <span class="n">ch</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="n">GIS_ISR0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isr0</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">FISR0_PDEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Read the bit to clear the situation */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FRS1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span>
				    <span class="n">FRS1_PDEN</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">pden</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="n">GIS_ISR1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dummy</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="n">GIS_ISR2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dummy</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="n">GIS_ISR3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isr3</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr3</span> <span class="o">&amp;</span> <span class="n">FISR3_SEC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sec</span><span class="o">++</span><span class="p">;</span>
				<span class="n">falc_update_stats</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
				<span class="n">falc_check_status</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
						  <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FRS0</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr3</span> <span class="o">&amp;</span> <span class="n">FISR3_ES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">es</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr3</span> <span class="o">&amp;</span> <span class="n">FISR3_LLBSC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">falc_t1_loop_detection</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
						       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FRS1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_e1_intr</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">isr1</span><span class="p">,</span> <span class="n">isr2</span><span class="p">,</span> <span class="n">isr3</span><span class="p">,</span> <span class="n">gis</span><span class="p">,</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">gis</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">GIS</span><span class="p">,</span> <span class="n">ch</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsp</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">RSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="n">GIS_ISR0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dummy</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="n">GIS_ISR1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isr1</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">FISR1_XMB</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">xmb_cause</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">multiframe_mode</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span> <span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FRS0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> 
									<span class="p">(</span><span class="n">FRS0_LOS</span> <span class="o">|</span> <span class="n">FRS0_AIS</span> <span class="o">|</span> <span class="n">FRS0_LFA</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
							   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
							   <span class="o">&amp;</span> <span class="o">~</span><span class="n">XSP_AXS</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
							   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSP</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
							   <span class="o">|</span> <span class="n">XSP_AXS</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">xmb_cause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
					   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IMR1_XMB</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">FISR1_LLBSC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">falc_e1_loop_detection</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="n">GIS_ISR2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isr2</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR2</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr2</span> <span class="o">&amp;</span> <span class="n">FISR2_T400MS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
					   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">XSW_XRA</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr2</span> <span class="o">&amp;</span> <span class="n">FISR2_MFAR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
					   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">XSW</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XSW_XRA</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FISR2_FAR</span> <span class="o">|</span> <span class="n">FISR2_LFA</span> <span class="o">|</span> <span class="n">FISR2_AIS</span> <span class="o">|</span> <span class="n">FISR2_LOS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">xmb_cause</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
					   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">IMR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IMR1_XMB</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="n">GIS_ISR3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isr3</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FISR3</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr3</span> <span class="o">&amp;</span> <span class="n">FISR3_SEC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sec</span><span class="o">++</span><span class="p">;</span>
				<span class="n">falc_update_stats</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
				<span class="n">falc_check_status</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
						  <span class="n">cpc_readb</span><span class="p">(</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">F_REG</span><span class="p">(</span><span class="n">FRS0</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr3</span> <span class="o">&amp;</span> <span class="n">FISR3_ES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">es</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falc_intr</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nchan</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
		<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_T1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">falc_t1_intr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">falc_e1_intr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">cpc_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u8</span> <span class="n">plx_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PC300_DEBUG_INTR</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cpc_intr: spurious intr %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>		<span class="cm">/* spurious intr */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PC300_DEBUG_INTR</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cpc_intr: spurious intr2 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>		<span class="cm">/* spurious intr */</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PC300_RSV</span>:
		<span class="k">case</span> <span class="n">PC300_X21</span>:
			<span class="n">sca_intr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_TE</span>:
			<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">plx_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">intctl_reg</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="p">(</span><span class="n">PLX_9050_LINT1_STATUS</span> <span class="o">|</span> <span class="n">PLX_9050_LINT2_STATUS</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plx_status</span> <span class="o">&amp;</span> <span class="n">PLX_9050_LINT1_STATUS</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* SCA Interrupt */</span>
					<span class="n">sca_intr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plx_status</span> <span class="o">&amp;</span> <span class="n">PLX_9050_LINT2_STATUS</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* FALC Interrupt */</span>
					<span class="n">falc_intr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpc_sca_status</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ilar</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">tx_dma_buf_check</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">rx_dma_buf_check</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">ilar</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">ILAR</span><span class="p">);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;ILAR=0x%02x, WCRL=0x%02x, PCR=0x%02x, BTCR=0x%02x, BOLR=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ilar</span><span class="p">,</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">WCRL</span><span class="p">),</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">PCR</span><span class="p">),</span>
		 <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">BTCR</span><span class="p">),</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">BOLR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TX_CDA=0x%08x, TX_EDA=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DTX_REG</span><span class="p">(</span><span class="n">CDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DTX_REG</span><span class="p">(</span><span class="n">EDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RX_CDA=0x%08x, RX_EDA=0x%08x, BFL=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRX_REG</span><span class="p">(</span><span class="n">CDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRX_REG</span><span class="p">(</span><span class="n">EDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readw</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DRX_REG</span><span class="p">(</span><span class="n">BFLL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMER=0x%02x, DSR_TX=0x%02x, DSR_RX=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DMER</span><span class="p">),</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMR_TX=0x%02x, DMR_RX=0x%02x, DIR_TX=0x%02x, DIR_RX=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DMR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">)),</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DMR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DIR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DIR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DCR_TX=0x%02x, DCR_RX=0x%02x, FCT_TX=0x%02x, FCT_RX=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DCR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">)),</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DCR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">FCT_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">FCT_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MD0=0x%02x, MD1=0x%02x, MD2=0x%02x, MD3=0x%02x, IDL=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD0</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD2</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD3</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IDL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CMD=0x%02x, SA0=0x%02x, SA1=0x%02x, TFN=0x%02x, CTL=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">SA0</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">SA1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TFN</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ST0=0x%02x, ST1=0x%02x, ST2=0x%02x, ST3=0x%02x, ST4=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST0</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST2</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST3</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST4</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;CST0=0x%02x, CST1=0x%02x, CST2=0x%02x, CST3=0x%02x, FST=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CST0</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
		 <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CST1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
		 <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CST2</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
		 <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CST3</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
		 <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">FST</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TRC0=0x%02x, TRC1=0x%02x, RRC=0x%02x, TBN=0x%02x, RBN=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TRC0</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TRC1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RRC</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TBN</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RBN</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TFS=0x%02x, TNR0=0x%02x, TNR1=0x%02x, RNR=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TFS</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TNR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TNR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RNR</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TCR=0x%02x, RCR=0x%02x, TNR1=0x%02x, RNR=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TNR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RNR</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TXS=0x%02x, RXS=0x%02x, EXS=0x%02x, TMCT=0x%02x, TMCR=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">EXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TMCT</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TMCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IE0=0x%02x, IE1=0x%02x, IE2=0x%02x, IE4=0x%02x, FIE=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IE0</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IE1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IE2</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IE4</span><span class="p">,</span> <span class="n">ch</span><span class="p">)),</span>
	       <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">FIE</span><span class="p">,</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IER0=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">IER0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ilar</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CPC_LOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">ILAR</span><span class="p">,</span> <span class="n">ilar</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DMER</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">CPC_UNLOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpc_falc_status</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">CPC_LOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CH%d:   %s %s  %d channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ch</span><span class="p">,</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">?</span> <span class="s">&quot;SYNC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">?</span> <span class="s">&quot;ACTIVE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;        pden=%d,  los=%d,  losr=%d,  lfa=%d,  farec=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">pden</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">los</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">losr</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">lfa</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">farec</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;        lmfa=%d,  ais=%d,  sec=%d,  es=%d,  rai=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">lmfa</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">ais</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">rai</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;        bec=%d,  fec=%d,  cvc=%d,  cec=%d,  ebc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">bec</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">fec</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">cvc</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">cec</span><span class="p">,</span> <span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">ebc</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;        STATUS: %s  %s  %s  %s  %s  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">red_alarm</span> <span class="o">?</span> <span class="s">&quot;RED&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">blue_alarm</span> <span class="o">?</span> <span class="s">&quot;BLU&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">yellow_alarm</span> <span class="o">?</span> <span class="s">&quot;YEL&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_fa</span> <span class="o">?</span> <span class="s">&quot;LFA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">loss_mfa</span> <span class="o">?</span> <span class="s">&quot;LMF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">pfalc</span><span class="o">-&gt;</span><span class="n">prbs</span> <span class="o">?</span> <span class="s">&quot;PRB&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
	<span class="n">CPC_UNLOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpc_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">PC300_DEF_MTU</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpc_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">pc300conf_t</span> <span class="n">conf_aux</span><span class="p">;</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">if_settings</span> <span class="o">*</span><span class="n">settings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SIOCGPC300CONF</span>:
<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="cm">/* FIXME hdlc-&gt;proto.id */</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#else</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="cm">/* FIXME hdlc-&gt;proto.id */</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf_aux</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300chconf_t</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf_aux</span><span class="p">.</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300hw_t</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> 
				<span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_aux</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300conf_t</span><span class="p">)))</span> 
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SIOCSPC300CONF</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> 
				<span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf_aux</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300chconf_t</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_id</span> <span class="o">&lt;</span> <span class="mh">0x02</span> <span class="o">&amp;&amp;</span>
			    <span class="n">conf_aux</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">fr_mode</span> <span class="o">==</span> <span class="n">PC300_FR_UNFRAMED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* CPLD_ID &lt; 0x02 doesn&#39;t support Unframed E1 */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf_aux</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_aux</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300chconf_t</span><span class="p">));</span>
					<span class="n">cpc_tty_init</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>	<span class="cm">/* init TTY driver */</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">conf_aux</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">){</span> 
						<span class="cm">/* ifdown interface */</span>
						<span class="n">cpc_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_aux</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300chconf_t</span><span class="p">));</span>
					<span class="cm">/* FIXME hdlc-&gt;proto.id = conf-&gt;proto; */</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_aux</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300chconf_t</span><span class="p">));</span>
			<span class="cm">/* FIXME hdlc-&gt;proto.id = conf-&gt;proto; */</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SIOCGPC300STATUS</span>:
			<span class="n">cpc_sca_status</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SIOCGPC300FALCSTATUS</span>:
			<span class="n">cpc_falc_status</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SIOCGPC300UTILSTATS</span>:
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* clear statistics */</span>
					<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">falc_t</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pc300stats_t</span> <span class="n">pc300stats</span><span class="p">;</span>

					<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc300stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300stats_t</span><span class="p">));</span>
					<span class="n">pc300stats</span><span class="p">.</span><span class="n">hw_type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
					<span class="n">pc300stats</span><span class="p">.</span><span class="n">line_on</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">line_on</span><span class="p">;</span>
					<span class="n">pc300stats</span><span class="p">.</span><span class="n">line_off</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">line_off</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc300stats</span><span class="p">.</span><span class="n">gen_stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span>
						<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc300stats</span><span class="p">.</span><span class="n">te_stats</span><span class="p">,</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">falc_t</span><span class="p">));</span>
				    	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pc300stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300stats_t</span><span class="p">)))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">case</span> <span class="n">SIOCGPC300UTILSTATUS</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">pc300status</span> <span class="n">pc300status</span><span class="p">;</span>

				<span class="n">pc300status</span><span class="p">.</span><span class="n">hw_type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">te_status</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">.</span><span class="n">sync</span><span class="p">;</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">te_status</span><span class="p">.</span><span class="n">red_alarm</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">.</span><span class="n">red_alarm</span><span class="p">;</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">te_status</span><span class="p">.</span><span class="n">blue_alarm</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">.</span><span class="n">blue_alarm</span><span class="p">;</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">te_status</span><span class="p">.</span><span class="n">loss_fa</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">.</span><span class="n">loss_fa</span><span class="p">;</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">te_status</span><span class="p">.</span><span class="n">yellow_alarm</span> <span class="o">=</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">.</span><span class="n">yellow_alarm</span><span class="p">;</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">te_status</span><span class="p">.</span><span class="n">loss_mfa</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">.</span><span class="n">loss_mfa</span><span class="p">;</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">te_status</span><span class="p">.</span><span class="n">prbs</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">.</span><span class="n">prbs</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">gen_status</span><span class="p">.</span><span class="n">dcd</span> <span class="o">=</span>
						<span class="o">!</span><span class="p">(</span><span class="n">cpc_readb</span> <span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ST3_DCD</span><span class="p">);</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">gen_status</span><span class="p">.</span><span class="n">cts</span> <span class="o">=</span>
						<span class="o">!</span><span class="p">(</span><span class="n">cpc_readb</span> <span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">ST3</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ST3_CTS</span><span class="p">);</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">gen_status</span><span class="p">.</span><span class="n">rts</span> <span class="o">=</span>
						<span class="o">!</span><span class="p">(</span><span class="n">cpc_readb</span> <span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CTL_RTS</span><span class="p">);</span>
					<span class="n">pc300status</span><span class="p">.</span><span class="n">gen_status</span><span class="p">.</span><span class="n">dtr</span> <span class="o">=</span>
						<span class="o">!</span><span class="p">(</span><span class="n">cpc_readb</span> <span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CTL_DTR</span><span class="p">);</span>
					<span class="cm">/* There is no DSR in HD64572 */</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span>
				    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pc300status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300status_t</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">case</span> <span class="n">SIOCSPC300TRACE</span>:
			<span class="cm">/* Sets/resets a trace_flag for the respective device */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trace_on</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SIOCSPC300LOOPBACK</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">pc300loopback</span> <span class="n">pc300loop</span><span class="p">;</span>

				<span class="cm">/* TE boards only */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PC300_TE</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> 
					<span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc300loop</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300loopback_t</span><span class="p">)))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">pc300loop</span><span class="p">.</span><span class="n">loop_type</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">PC300LOCLOOP</span>:	<span class="cm">/* Turn the local loop on/off */</span>
						<span class="n">falc_local_loop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">pc300loop</span><span class="p">.</span><span class="n">loop_on</span><span class="p">);</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

					<span class="k">case</span> <span class="n">PC300REMLOOP</span>:	<span class="cm">/* Turn the remote loop on/off */</span>
						<span class="n">falc_remote_loop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">pc300loop</span><span class="p">.</span><span class="n">loop_on</span><span class="p">);</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

					<span class="k">case</span> <span class="n">PC300PAYLOADLOOP</span>:	<span class="cm">/* Turn the payload loop on/off */</span>
						<span class="n">falc_payload_loop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">pc300loop</span><span class="p">.</span><span class="n">loop_on</span><span class="p">);</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

					<span class="k">case</span> <span class="n">PC300GENLOOPUP</span>:	<span class="cm">/* Generate loop UP */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">pc300loop</span><span class="p">.</span><span class="n">loop_on</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">falc_generate_loop_up_code</span> <span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">turn_off_xlu</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

					<span class="k">case</span> <span class="n">PC300GENLOOPDOWN</span>:	<span class="cm">/* Generate loop DOWN */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">pc300loop</span><span class="p">.</span><span class="n">loop_on</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">falc_generate_loop_down_code</span> <span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">turn_off_xld</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

					<span class="nl">default:</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="k">case</span> <span class="n">SIOCSPC300PATTERNTEST</span>:
			<span class="cm">/* Turn the pattern test on/off and show the errors counter */</span>
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">pc300patterntst</span> <span class="n">pc300patrntst</span><span class="p">;</span>

				<span class="cm">/* TE boards only */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PC300_TE</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_id</span> <span class="o">&lt;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* CPLD_ID &lt; 0x02 doesn&#39;t support pattern test */</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> 
					<span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc300patrntst</span><span class="p">,</span><span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pc300patterntst_t</span><span class="p">)))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pc300patrntst</span><span class="p">.</span><span class="n">patrntst_on</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">.</span><span class="n">prbs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">falc_pattern_test</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">pc300patrntst</span><span class="p">.</span><span class="n">num_errors</span> <span class="o">=</span>
						<span class="n">falc_pattern_test_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pc300patrntst</span><span class="p">,</span>
							 <span class="k">sizeof</span><span class="p">(</span><span class="n">pc300patterntst_t</span><span class="p">)))</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">falc_pattern_test</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">pc300patrntst</span><span class="p">.</span><span class="n">patrntst_on</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">case</span> <span class="n">SIOCWANDEV</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">IF_GET_IFACE</span>:
				<span class="p">{</span>
					<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sync_serial_settings</span><span class="p">);</span>
					<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* data size wanted */</span>
						<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
					<span class="p">}</span>
	
					<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">ifs_ifsu</span><span class="p">.</span><span class="n">sync</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">phys_settings</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">case</span> <span class="n">IF_IFACE_V35</span>:
				<span class="k">case</span> <span class="n">IF_IFACE_V24</span>:
				<span class="k">case</span> <span class="n">IF_IFACE_X21</span>:
				<span class="p">{</span>
					<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sync_serial_settings</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* incorrect data len? */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">phys_settings</span><span class="p">,</span> 
							   <span class="n">settings</span><span class="o">-&gt;</span><span class="n">ifs_ifsu</span><span class="p">.</span><span class="n">sync</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">phys_settings</span><span class="p">.</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
							<span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> 
							<span class="n">MD2_LOOP_MIR</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">case</span> <span class="n">IF_IFACE_T1</span>:
				<span class="k">case</span> <span class="n">IF_IFACE_E1</span>:
				<span class="p">{</span>
					<span class="k">const</span> <span class="kt">size_t</span> <span class="n">te_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">te1_settings</span><span class="p">);</span>
					<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sync_serial_settings</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="cm">/* incorrect data len? */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">te_size</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">phys_settings</span><span class="p">,</span> 
							   <span class="n">settings</span><span class="o">-&gt;</span><span class="n">ifs_ifsu</span><span class="p">.</span><span class="n">te1</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="p">}</span><span class="cm">/* Ignoring HDLC slot_map for a while */</span>
					
					<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">phys_settings</span><span class="p">.</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
							<span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD2</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> 
							<span class="n">MD2_LOOP_MIR</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="nl">default:</span>
					<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clock_rate_calc</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clock</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">br_io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">br</span><span class="p">,</span> <span class="n">tc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">br_pwr</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">br_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">br</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">br_pwr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">br</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">;</span> <span class="n">br</span><span class="o">++</span><span class="p">,</span> <span class="n">br_pwr</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tc</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">/</span> <span class="n">br_pwr</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">br_io</span> <span class="o">=</span> <span class="n">br</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="p">((</span><span class="n">rate</span> <span class="o">-</span> <span class="p">(</span><span class="n">clock</span> <span class="o">/</span> <span class="n">br_pwr</span> <span class="o">/</span> <span class="n">rate</span><span class="p">))</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="cm">/* Errors bigger than +/- 1% won&#39;t be tolerated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span> <span class="o">||</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">tc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ch_config</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">plxbase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clkrate</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">phys_settings</span><span class="p">.</span><span class="n">clock_rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clktype</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">phys_settings</span><span class="p">.</span><span class="n">clock_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto_settings</span><span class="p">.</span><span class="n">encoding</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">parity</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto_settings</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">md0</span><span class="p">,</span> <span class="n">md2</span><span class="p">;</span>

	<span class="cm">/* Reset the channel */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">CMD_CH_RST</span><span class="p">);</span>

	<span class="cm">/* Configure the SCA registers */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">parity</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PARITY_NONE</span>:
			<span class="n">md0</span> <span class="o">=</span> <span class="n">MD0_BIT_SYNC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARITY_CRC16_PR0</span>:
			<span class="n">md0</span> <span class="o">=</span> <span class="n">MD0_CRC16_0</span><span class="o">|</span><span class="n">MD0_CRCC0</span><span class="o">|</span><span class="n">MD0_BIT_SYNC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARITY_CRC16_PR1</span>:
			<span class="n">md0</span> <span class="o">=</span> <span class="n">MD0_CRC16_1</span><span class="o">|</span><span class="n">MD0_CRCC0</span><span class="o">|</span><span class="n">MD0_BIT_SYNC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARITY_CRC32_PR1_CCITT</span>:
			<span class="n">md0</span> <span class="o">=</span> <span class="n">MD0_CRC32</span><span class="o">|</span><span class="n">MD0_CRCC0</span><span class="o">|</span><span class="n">MD0_BIT_SYNC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARITY_CRC16_PR1_CCITT</span>:
		<span class="nl">default:</span>
			<span class="n">md0</span> <span class="o">=</span> <span class="n">MD0_CRC_CCITT</span><span class="o">|</span><span class="n">MD0_CRCC0</span><span class="o">|</span><span class="n">MD0_BIT_SYNC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">encoding</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ENCODING_NRZI</span>:
			<span class="n">md2</span> <span class="o">=</span> <span class="n">MD2_F_DUPLEX</span><span class="o">|</span><span class="n">MD2_ADPLL_X8</span><span class="o">|</span><span class="n">MD2_NRZI</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ENCODING_FM_MARK</span>:	<span class="cm">/* FM1 */</span>
			<span class="n">md2</span> <span class="o">=</span> <span class="n">MD2_F_DUPLEX</span><span class="o">|</span><span class="n">MD2_ADPLL_X8</span><span class="o">|</span><span class="n">MD2_FM</span><span class="o">|</span><span class="n">MD2_FM1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ENCODING_FM_SPACE</span>:	<span class="cm">/* FM0 */</span>
			<span class="n">md2</span> <span class="o">=</span> <span class="n">MD2_F_DUPLEX</span><span class="o">|</span><span class="n">MD2_ADPLL_X8</span><span class="o">|</span><span class="n">MD2_FM</span><span class="o">|</span><span class="n">MD2_FM0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ENCODING_MANCHESTER</span>: <span class="cm">/* It&#39;s not working... */</span>
			<span class="n">md2</span> <span class="o">=</span> <span class="n">MD2_F_DUPLEX</span><span class="o">|</span><span class="n">MD2_ADPLL_X8</span><span class="o">|</span><span class="n">MD2_FM</span><span class="o">|</span><span class="n">MD2_MANCH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ENCODING_NRZ</span>:
		<span class="nl">default:</span>
			<span class="n">md2</span> <span class="o">=</span> <span class="n">MD2_F_DUPLEX</span><span class="o">|</span><span class="n">MD2_ADPLL_X8</span><span class="o">|</span><span class="n">MD2_NRZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">md0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">MD2</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">md2</span><span class="p">);</span>
 	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IDL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mh">0x7e</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">CTL_URSKP</span> <span class="o">|</span> <span class="n">CTL_IDLC</span><span class="p">);</span>

	<span class="cm">/* Configure HW media */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PC300_RSV</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">IF_IFACE_V35</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpc_writel</span><span class="p">((</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span><span class="p">),</span>
					   <span class="n">cpc_readl</span><span class="p">(</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">PC300_CHMEDIA_MASK</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cpc_writel</span><span class="p">((</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span><span class="p">),</span>
					   <span class="n">cpc_readl</span><span class="p">(</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PC300_CHMEDIA_MASK</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_X21</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_TE</span>:
			<span class="n">te_config</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PC300_RSV</span>:
		<span class="k">case</span> <span class="n">PC300_X21</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">clktype</span> <span class="o">==</span> <span class="n">CLOCK_INT</span> <span class="o">||</span> <span class="n">clktype</span> <span class="o">==</span> <span class="n">CLOCK_TXINT</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">tmc</span><span class="p">,</span> <span class="n">br</span><span class="p">;</span>

				<span class="cm">/* Calculate the clkrate parameters */</span>
				<span class="n">tmc</span> <span class="o">=</span> <span class="n">clock_rate_calc</span><span class="p">(</span><span class="n">clkrate</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">br</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TMCT</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">tmc</span><span class="p">);</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
					   <span class="p">(</span><span class="n">TXS_DTRXC</span> <span class="o">|</span> <span class="n">TXS_IBRG</span> <span class="o">|</span> <span class="n">br</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">clktype</span> <span class="o">==</span> <span class="n">CLOCK_INT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TMCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">tmc</span><span class="p">);</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> 
						   <span class="p">(</span><span class="n">RXS_IBRG</span> <span class="o">|</span> <span class="n">br</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TMCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
	    			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_X21</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">GPO</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">EXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">EXS_TES1</span> <span class="o">|</span> <span class="n">EXS_RES1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">EXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">EXS_TES1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TMCT</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">clktype</span> <span class="o">==</span> <span class="n">CLOCK_EXT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> 
						   <span class="n">TXS_DTRXC</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> 
						   <span class="n">TXS_DTRXC</span><span class="o">|</span><span class="n">TXS_RCLK</span><span class="p">);</span>
				<span class="p">}</span>
	    			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TMCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_X21</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">GPO</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">EXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">EXS_TES1</span> <span class="o">|</span> <span class="n">EXS_RES1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">EXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">EXS_TES1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PC300_TE</span>:
			<span class="cm">/* SCA always receives clock from the FALC chip */</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TMCT</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TMCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">EXS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable Interrupts */</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">IER0</span><span class="p">,</span>
		   <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">IER0</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">IR0_M</span><span class="p">(</span><span class="n">IR0_RXINTA</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">IR0_DRX</span><span class="p">(</span><span class="n">IR0_EFT</span> <span class="o">|</span> <span class="n">IR0_DMIA</span> <span class="o">|</span> <span class="n">IR0_DMIB</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">IR0_DTX</span><span class="p">(</span><span class="n">IR0_EFT</span> <span class="o">|</span> <span class="n">IR0_DMIA</span> <span class="o">|</span> <span class="n">IR0_DMIB</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IE0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IE0</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IE0_RXINTA</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IE1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readl</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">IE1</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">|</span> <span class="n">IE1_CDCD</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_config</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* General RX settings */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RRC</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">RNR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* Enable reception */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">CMD_RX_CRC_INIT</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">CMD_RX_ENA</span><span class="p">);</span>

	<span class="cm">/* Initialize DMA stuff */</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_last_bd</span> <span class="o">=</span> <span class="n">N_DMA_RX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rx_dma_buf_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DCR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">DCR_FCT_CLR</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DMR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="n">DMR_TMOD</span> <span class="o">|</span> <span class="n">DMR_NF</span><span class="p">));</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DIR_RX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="n">DIR_EOM</span> <span class="o">|</span> <span class="n">DIR_BOF</span><span class="p">));</span>

	<span class="cm">/* Start DMA */</span>
	<span class="n">rx_dma_start</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_config</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DSR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* General TX settings */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TRC0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TFS</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TNR0</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TNR1</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">48</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">TCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Enable transmission */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">CMD_TX_CRC_INIT</span><span class="p">);</span>

	<span class="cm">/* Initialize DMA stuff */</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_first_bd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_next_bd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_dma_buf_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DCR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">DCR_FCT_CLR</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DMR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="n">DMR_TMOD</span> <span class="o">|</span> <span class="n">DMR_NF</span><span class="p">));</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DIR_TX</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="p">(</span><span class="n">DIR_EOM</span> <span class="o">|</span> <span class="n">DIR_BOF</span> <span class="o">|</span> <span class="n">DIR_UDRF</span><span class="p">));</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DTX_REG</span><span class="p">(</span><span class="n">CDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_first_bd</span><span class="p">));</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DTX_REG</span><span class="p">(</span><span class="n">EDAL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">TX_BD_ADDR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_next_bd</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpc_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">encoding</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">parity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">pc300chconf_t</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300chconf_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_NRZ</span> <span class="o">&amp;&amp;</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_NRZI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_NRZ</span> <span class="o">&amp;&amp;</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_NRZI</span> <span class="o">&amp;&amp;</span>
		    <span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_FM_MARK</span> <span class="o">&amp;&amp;</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_FM_SPACE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Driver doesn&#39;t support ENCODING_MANCHESTER yet */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_CRC16_PR0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_CRC16_PR1</span> <span class="o">&amp;&amp;</span> <span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_CRC32_PR1_CCITT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_CRC16_PR1_CCITT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">proto_settings</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">proto_settings</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">parity</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpc_opench</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ch_config</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rx_config</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">tx_config</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="cm">/* Assert RTS and DTR */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span>
		   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CTL_RTS</span> <span class="o">|</span> <span class="n">CTL_DTR</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpc_closech</span><span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">falc_t</span> <span class="o">*</span><span class="n">pfalc</span> <span class="o">=</span> <span class="p">(</span><span class="n">falc_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">falc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">M_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="n">CMD_CH_RST</span><span class="p">);</span>
	<span class="n">rx_dma_stop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">tx_dma_stop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pfalc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">falc_t</span><span class="p">));</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">,</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span><span class="p">)</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">((</span><span class="n">CPLD_REG2_FALC_TX_CLK</span> <span class="o">|</span> <span class="n">CPLD_REG2_FALC_RX_CLK</span> <span class="o">|</span>
			      <span class="n">CPLD_REG2_FALC_LED2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
		<span class="cm">/* Reset the FALC chip */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">,</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">CPLD_REG1_FALC_RESET</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">,</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">)</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">(</span><span class="n">CPLD_REG1_FALC_RESET</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cpc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

<span class="cp">#ifdef	PC300_DEBUG_OTHER</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pc300: cpc_open&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">hdlc_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">cpc_opench</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">hdlc_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300ch_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef	PC300_DEBUG_OTHER</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pc300: cpc_close&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">CPC_LOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cpc_closech</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">CPC_UNLOCK</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">hdlc_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PC300_MLPPP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PC300_PROTO_MLPPP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpc_tty_unregister_service</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">detect_ram</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rambase</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramsize</span> <span class="o">=</span> <span class="n">PC300_RAMSIZE</span><span class="p">;</span>
	<span class="cm">/* Let&#39;s find out how much RAM is present on this board */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">plx_init</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">RUNTIME_9050</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">plx_ctl</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span><span class="p">;</span>

	<span class="cm">/* Reset PLX */</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_ctl</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">,</span>
		   <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_ctl</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000L</span><span class="p">);</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_ctl</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">,</span>
		   <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_ctl</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40000000</span><span class="p">);</span>

	<span class="cm">/* Reload Config. Registers from EEPROM */</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_ctl</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">,</span>
		   <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_ctl</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20000000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000L</span><span class="p">);</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_ctl</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">,</span>
		   <span class="n">cpc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_ctl</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20000000</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rcsvers</span><span class="p">,</span> <span class="o">*</span><span class="n">rcsdate</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">rcsvers</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">rcsid</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
	<span class="n">rcsvers</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">rcsvers</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">rcsdate</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
	<span class="n">rcsdate</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">rcsdate</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Cyclades-PC300 driver %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcsvers</span><span class="p">,</span> <span class="n">rcsdate</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* show_version */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">cpc_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">cpc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">cpc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">cpc_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">cpc_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">cpc_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpc_init_card</span><span class="p">(</span><span class="n">pc300_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">devcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">board_nbr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Enable interrupts on the PCI bridge */</span>
	<span class="n">plx_init</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">cpc_writew</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">intctl_reg</span><span class="p">,</span>
		   <span class="n">cpc_readw</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">intctl_reg</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0040</span><span class="p">);</span>

<span class="cp">#ifdef USE_PCI_CLOCK</span>
	<span class="cm">/* Set board clock to PCI clock */</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span><span class="p">,</span>
		   <span class="n">cpc_readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00000004UL</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">clock</span> <span class="o">=</span> <span class="n">PC300_PCI_CLOCK</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/* Set board clock to internal oscillator clock */</span>
	<span class="n">cpc_writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span><span class="p">,</span>
		   <span class="n">cpc_readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00000004UL</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">clock</span> <span class="o">=</span> <span class="n">PC300_OSC_CLOCK</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Detect actual on-board RAM size */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramsize</span> <span class="o">=</span> <span class="n">detect_ram</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Set Global SCA-II registers */</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">PCR</span><span class="p">,</span> <span class="n">PCR_PR2</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">BTCR</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">WCRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">+</span> <span class="n">DMER</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">reg1</span><span class="p">;</span>

		<span class="cm">/* Check CPLD version */</span>
		<span class="n">reg1</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">CPLD_REG1</span><span class="p">);</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">CPLD_REG1</span><span class="p">,</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">+</span> <span class="mh">0x5a</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">CPLD_REG1</span><span class="p">)</span> <span class="o">==</span> <span class="n">reg1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* New CPLD */</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_id</span> <span class="o">=</span> <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">CPLD_ID_REG</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span> <span class="o">=</span> <span class="n">CPLD_V2_REG1</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span> <span class="o">=</span> <span class="n">CPLD_V2_REG2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* old CPLD */</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span> <span class="o">=</span> <span class="n">CPLD_REG1</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg2</span> <span class="o">=</span> <span class="n">CPLD_REG2</span><span class="p">;</span>
			<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">CPLD_REG1</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Enable the board&#39;s global clock */</span>
		<span class="n">cpc_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">,</span>
			   <span class="n">cpc_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cpld_reg1</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">CPLD_REG1_GLOBAL_CLK</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nchan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pc300ch_t</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pc300dev_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">;</span>
		<span class="n">hdlc_device</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">phys_settings</span><span class="p">.</span><span class="n">clock_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">phys_settings</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_EXT</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto_settings</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">ENCODING_NRZ</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto_settings</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">PARITY_CRC16_PR1_CCITT</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PC300_TE</span>:
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">media</span> <span class="o">=</span> <span class="n">IF_IFACE_T1</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">lcode</span> <span class="o">=</span> <span class="n">PC300_LC_B8ZS</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fr_mode</span> <span class="o">=</span> <span class="n">PC300_FR_ESF</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">lbo</span> <span class="o">=</span> <span class="n">PC300_LBO_0_DB</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx_sens</span> <span class="o">=</span> <span class="n">PC300_RX_SENS_SH</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tslot_bitmap</span> <span class="o">=</span> <span class="mh">0xffffffffUL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">PC300_X21</span>:
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">media</span> <span class="o">=</span> <span class="n">IF_IFACE_X21</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">PC300_RSV</span>:
			<span class="nl">default:</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">media</span> <span class="o">=</span> <span class="n">IF_IFACE_V35</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">IF_PROTO_PPP</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_first_bd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_next_bd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_first_bd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_last_bd</span> <span class="o">=</span> <span class="n">N_DMA_RX_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">nfree_tx_bd</span> <span class="o">=</span> <span class="n">N_DMA_TX_BUF</span><span class="p">;</span>

		<span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">trace_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">line_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">line_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_hdlcdev</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hdlc</span> <span class="o">=</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">xmit</span> <span class="o">=</span> <span class="n">cpc_queue_xmit</span><span class="p">;</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">attach</span> <span class="o">=</span> <span class="n">cpc_attach</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">PC300_TX_QUEUE_LEN</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">PC300_DEF_MTU</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpc_netdev_ops</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">PC300_TX_TIMEOUT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">register_hdlc_device</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Cyclades-PC300/&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">PC300_TE</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bus</span> <span class="o">==</span> <span class="n">PC300_PMC</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TE-M&quot;</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TE  &quot;</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">PC300_X21</span>:
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;X21 &quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">PC300_RSV</span>:
				<span class="nl">default:</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RSV &quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot; #%d, %dKB of RAM at 0x%08x, IRQ%d, channel %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">board_nbr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramsize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
				 <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">devcount</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Dev%d on card(0x%08x): unable to allocate i/f name.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">);</span>

	<span class="n">board_nbr</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">cpc_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">eeprom_outdated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pc300_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PC300 found at RAM 0x%016llx, &quot;</span>
		       <span class="s">&quot;but could not allocate card structure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* read PCI configuration area */</span>
	<span class="n">device_id</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">iophys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scaphys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scasize</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">alloc_ramsize</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcphys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcsize</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxphys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxsize</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_RX_1</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_1</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_M_1</span>:
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_RX_2</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_2</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_M_2</span>:
		<span class="nl">default:</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="n">PC300_MAXCHAN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef PC300_DEBUG_PCI</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cpc (bus=0x0%x,pci_id=0x%x,&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rev_id=%d) IRQ%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cpc:found  ramaddr=0x%08lx plxaddr=0x%08lx &quot;</span>
	       <span class="s">&quot;ctladdr=0x%08lx falcaddr=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scaphys</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcphys</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Although we don&#39;t use this I/O region, we should</span>
<span class="cm">	 * request it from the kernel anyway, to avoid problems</span>
<span class="cm">	 * with other drivers accessing it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">iophys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">iosize</span><span class="p">,</span> <span class="s">&quot;PLX Registers&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* In case we can&#39;t allocate it, warn user */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WARNING: couldn&#39;t allocate I/O region for PC300 board &quot;</span>
		       <span class="s">&quot;at 0x%08x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxphys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxphys</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">eeprom_outdated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxphys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxsize</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxsize</span><span class="p">,</span>
				<span class="s">&quot;PLX Registers&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PC300 found at RAM 0x%08x, &quot;</span>
		       <span class="s">&quot;but could not allocate PLX mem region.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_io</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">alloc_ramsize</span><span class="p">,</span>
				<span class="s">&quot;On-board RAM&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PC300 found at RAM 0x%08x, &quot;</span>
		       <span class="s">&quot;but could not allocate RAM mem region.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_plx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scaphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scasize</span><span class="p">,</span>
				<span class="s">&quot;SCA-II Registers&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PC300 found at RAM 0x%08x, &quot;</span>
		       <span class="s">&quot;but could not allocate SCA mem region.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_ram</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxsize</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">alloc_ramsize</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scaphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scasize</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_1</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_2</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_M_1</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_M_2</span>:
			<span class="n">request_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcsize</span><span class="p">,</span>
					   <span class="s">&quot;FALC Registers&quot;</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcsize</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_RX_1</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_RX_2</span>:
		<span class="nl">default:</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef PC300_DEBUG_PCI</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cpc: relocate ramaddr=0x%08lx plxaddr=0x%08lx &quot;</span>
	       <span class="s">&quot;ctladdr=0x%08lx falcaddr=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Set PCI drv pointer to the card structure */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Set board type */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_1</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_2</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_M_1</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_TE_M_2</span>:
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PC300_TE</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_PC300_TE_M_1</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_PC300_TE_M_2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">PC300_PMC</span><span class="p">;</span>
				<span class="cm">/* Set PLX register offsets */</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span> <span class="o">=</span> <span class="mh">0x54</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">intctl_reg</span> <span class="o">=</span> <span class="mh">0x4c</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">PC300_PCI</span><span class="p">;</span>
				<span class="cm">/* Set PLX register offsets */</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">intctl_reg</span> <span class="o">=</span> <span class="mh">0x4c</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_RX_1</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PC300_RX_2</span>:
		<span class="nl">default:</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">PC300_PCI</span><span class="p">;</span>
			<span class="cm">/* Set PLX register offsets */</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">intctl_reg</span> <span class="o">=</span> <span class="mh">0x4c</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">cpc_readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">gpioc_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PC300_CTYPE_MASK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PC300_X21</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PC300_RSV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">cpc_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;Cyclades-PC300&quot;</span><span class="p">,</span> <span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;PC300 found at RAM 0x%08x, but could not allocate IRQ%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_io_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpc_init_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_outdated</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WARNING: PC300 with outdated EEPROM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_io_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcsize</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scaphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scasize</span><span class="p">);</span>
<span class="nl">err_release_ram:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">alloc_ramsize</span><span class="p">);</span>
<span class="nl">err_release_plx:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxsize</span><span class="p">);</span>
<span class="nl">err_release_io:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">iophys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">iosize</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">err_disable_dev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">cpc_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc300_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Disable interrupts on the PCI bridge */</span>
		<span class="n">cpc_writew</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">intctl_reg</span><span class="p">,</span>
			   <span class="n">cpc_readw</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">intctl_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nchan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unregister_hdlc_device</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxbase</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scabase</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rambase</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">plxsize</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ramphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">alloc_ramsize</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scaphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">scasize</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">iophys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">iosize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PC300_TE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcbase</span><span class="p">);</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcphys</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcsize</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nchan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
				<span class="n">free_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cpc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;pc300&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">cpc_pci_dev_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">cpc_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cpc_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cpc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_version</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpc_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cpc_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpc_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cpc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cpc_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Cyclades-PC300 cards driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span>  <span class="s">&quot;Author: Ivan Passos &lt;ivan@cyclades.com&gt;</span><span class="se">\r\n</span><span class="s">&quot;</span>
                <span class="s">&quot;Maintainer: PC300 Maintainer &lt;pc300@cyclades.com&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
