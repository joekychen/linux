<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6656 › usbpipe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>usbpipe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * File: usbpipe.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Handle USB control endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Warren Hsu</span>
<span class="cm"> *</span>
<span class="cm"> * Date: Mar. 29, 2005</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *      CONTROLnsRequestOut - Write variable length bytes to MEM/BB/MAC/EEPROM</span>
<span class="cm"> *      CONTROLnsRequestIn - Read variable length bytes from MEM/BB/MAC/EEPROM</span>
<span class="cm"> *      ControlvWriteByte - Write one byte to MEM/BB/MAC/EEPROM</span>
<span class="cm"> *      ControlvReadByte - Read one byte from MEM/BB/MAC/EEPROM</span>
<span class="cm"> *      ControlvMaskByte - Read one byte from MEM/BB/MAC/EEPROM and clear/set some bits in the same address</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> *      04-05-2004 Jerry Chen:  Initial release</span>
<span class="cm"> *      11-24-2004 Warren Hsu: Add ControlvWriteByte,ControlvReadByte,ControlvMaskByte</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;int.h&quot;</span>
<span class="cp">#include &quot;rxtx.h&quot;</span>
<span class="cp">#include &quot;dpc.h&quot;</span>
<span class="cp">#include &quot;control.h&quot;</span>
<span class="cp">#include &quot;desc.h&quot;</span>
<span class="cp">#include &quot;device.h&quot;</span>

<span class="cm">/*---------------------  Static Definitions -------------------------*/</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>endpoint def
endpoint 0: control
endpoint 1: interrupt
endpoint 2: read bulk
endpoint 3: write bulk</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>RequestType:</p>

<h1>define REQUEST<em>OUT       (USB</em>DIR<em>OUT | USB</em>TYPE<em>VENDOR | USB</em>RECIP_DEVICE) // 0x40</h1>

<h1>define REQUEST<em>IN        (USB</em>DIR<em>IN | USB</em>TYPE<em>VENDOR | USB</em>RECIP_DEVICE )  //0xc0</h1>

<p>static int          msglevel                =MSG<em>LEVEL</em>DEBUG;</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span><span class="n">MSG_LEVEL_INFO</span><span class="p">;</span>


<span class="cp">#define USB_CTL_WAIT   500 </span><span class="c1">//ms</span>

<span class="cp">#ifndef URB_ASYNC_UNLINK</span>
<span class="cp">#define URB_ASYNC_UNLINK    0</span>
<span class="cp">#endif</span>

<span class="cm">/*---------------------  Static Classes  ----------------------------*/</span>

<span class="cm">/*---------------------  Static Variables  --------------------------*/</span>

<span class="cm">/*---------------------  Static Functions  --------------------------*/</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_nsInterruptUsbIoCompleteRead</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">);</span>


<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_nsBulkInUsbIoCompleteRead</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">);</span>


<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_nsBulkOutIoCompleteWrite</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">);</span>


<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_nsControlInUsbIoCompleteRead</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_nsControlInUsbIoCompleteWrite</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">);</span>

<span class="cm">/*---------------------  Export Variables  --------------------------*/</span>

<span class="cm">/*---------------------  Export Functions  --------------------------*/</span>

<span class="kt">int</span> <span class="nf">PIPEnsControlOutAsyn</span><span class="p">(</span>
     <span class="n">PSDevice</span>     <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>         <span class="n">byRequest</span><span class="p">,</span>
     <span class="n">WORD</span>         <span class="n">wValue</span><span class="p">,</span>
     <span class="n">WORD</span>         <span class="n">wIndex</span><span class="p">,</span>
     <span class="n">WORD</span>         <span class="n">wLength</span><span class="p">,</span>
     <span class="n">PBYTE</span>        <span class="n">pbyBuffer</span>
    <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ntStatus</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_DISCONNECTED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_CONTROL_WRITES</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;in_interrupt return ..byRequest %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byRequest</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ntStatus</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
                            <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span> <span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">byRequest</span><span class="p">,</span>
                            <span class="mh">0x40</span><span class="p">,</span> <span class="c1">// RequestType</span>
                            <span class="n">wValue</span><span class="p">,</span>
                            <span class="n">wIndex</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pbyBuffer</span><span class="p">,</span>
                            <span class="n">wLength</span><span class="p">,</span>
                            <span class="n">HZ</span>
                          <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ntStatus</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;usb_sndctrlpipe ntStatus= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntStatus</span><span class="p">);</span>
        <span class="n">ntStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;usb_sndctrlpipe fail, ntStatus= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntStatus</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ntStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">PIPEnsControlOut</span><span class="p">(</span>
     <span class="n">PSDevice</span>     <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>         <span class="n">byRequest</span><span class="p">,</span>
     <span class="n">WORD</span>         <span class="n">wValue</span><span class="p">,</span>
     <span class="n">WORD</span>         <span class="n">wIndex</span><span class="p">,</span>
     <span class="n">WORD</span>         <span class="n">wLength</span><span class="p">,</span>
     <span class="n">PBYTE</span>        <span class="n">pbyBuffer</span>
    <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ntStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_DISCONNECTED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_CONTROL_WRITES</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">byRequest</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wLength</span><span class="p">);</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_ASYNC_UNLINK</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Notice, pbyBuffer limited point to variable buffer, can't be constant.</p></td><td class="code"><div class="highlight"><pre>  	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			 <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span> <span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">,</span>
			 <span class="n">pbyBuffer</span><span class="p">,</span> <span class="n">wLength</span><span class="p">,</span> <span class="n">s_nsControlInUsbIoCompleteWrite</span><span class="p">,</span> <span class="n">pDevice</span><span class="p">);</span>

	<span class="n">ntStatus</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;control send request submission failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntStatus</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
	    <span class="n">MP_SET_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_CONTROL_WRITES</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;=</span> <span class="n">USB_CTL_WAIT</span><span class="p">;</span> <span class="n">ii</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_CONTROL_WRITES</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span>
		<span class="k">break</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;=</span> <span class="n">USB_CTL_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span>
			<span class="n">KERN_INFO</span> <span class="s">&quot;control send request submission timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
            <span class="n">MP_CLEAR_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_CONTROL_WRITES</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">PIPEnsControlIn</span><span class="p">(</span>
     <span class="n">PSDevice</span>     <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>         <span class="n">byRequest</span><span class="p">,</span>
     <span class="n">WORD</span>         <span class="n">wValue</span><span class="p">,</span>
     <span class="n">WORD</span>         <span class="n">wIndex</span><span class="p">,</span>
     <span class="n">WORD</span>         <span class="n">wLength</span><span class="p">,</span>
       <span class="n">PBYTE</span>   <span class="n">pbyBuffer</span>
    <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ntStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_DISCONNECTED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_CONTROL_READS</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">byRequest</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wLength</span><span class="p">);</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_ASYNC_UNLINK</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			 <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span> <span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sUsbCtlRequest</span><span class="p">,</span>
			 <span class="n">pbyBuffer</span><span class="p">,</span> <span class="n">wLength</span><span class="p">,</span> <span class="n">s_nsControlInUsbIoCompleteRead</span><span class="p">,</span> <span class="n">pDevice</span><span class="p">);</span>

	<span class="n">ntStatus</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;control request submission failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntStatus</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
		<span class="n">MP_SET_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_CONTROL_READS</span><span class="p">);</span>
    <span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;=</span> <span class="n">USB_CTL_WAIT</span><span class="p">;</span> <span class="n">ii</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_CONTROL_READS</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;=</span> <span class="n">USB_CTL_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span>
			<span class="n">KERN_INFO</span> <span class="s">&quot;control rcv request submission timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
            <span class="n">MP_CLEAR_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_CONTROL_READS</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ntStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_nsControlInUsbIoCompleteWrite</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span><span class="p">;</span>

	<span class="n">pDevice</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINPROGRESS</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ctrl write urb status EINPROGRESS%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ctrl write urb status ENOENT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ctrl write urb status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

    <span class="n">MP_CLEAR_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_CONTROL_WRITES</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Complete function of usb Control callback</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice     - Pointer to the adapter</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: STATUS_INSUFFICIENT_RESOURCES or result of IoCallDriver</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_nsControlInUsbIoCompleteRead</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span><span class="p">;</span>

	<span class="n">pDevice</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINPROGRESS</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ctrl read urb status EINPROGRESS%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ctrl read urb status = ENOENT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ctrl read urb status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

    <span class="n">MP_CLEAR_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_CONTROL_READS</span><span class="p">);</span>
<span class="p">}</span>




<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Allocates an usb interrupt in irp and calls USBD.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice     - Pointer to the adapter</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: STATUS_INSUFFICIENT_RESOURCES or result of IoCallDriver</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">PIPEnsInterruptRead</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ntStatus</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;----&gt;s_nsStartInterruptUsbRead()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">intBuf</span><span class="p">.</span><span class="n">bInUse</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">){</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">STATUS_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">intBuf</span><span class="p">.</span><span class="n">bInUse</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>pDevice->bEventAvailable = FALSE;</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulIntInPosted</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Now that we have created the urb, we will send a
request to the USB device object.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">int_interval</span><span class="p">;</span>

<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="p">,</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
		<span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">intBuf</span><span class="p">.</span><span class="n">pDataBuf</span><span class="p">,</span>
		<span class="n">MAX_INTERRUPT_SIZE</span><span class="p">,</span>
		<span class="n">s_nsInterruptUsbIoCompleteRead</span><span class="p">,</span>
		<span class="n">pDevice</span><span class="p">);</span>

	<span class="n">ntStatus</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Submit int URB failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntStatus</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;&lt;----s_nsStartInterruptUsbRead Return(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ntStatus</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ntStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Complete function of usb interrupt in irp.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice     - Pointer to the adapter</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: STATUS_INSUFFICIENT_RESOURCES or result of IoCallDriver</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_nsInterruptUsbIoCompleteRead</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">)</span>

<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ntStatus</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;----&gt;s_nsInterruptUsbIoCompleteRead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>The context given to IoSetCompletionRoutine is the receive buffer object</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>We have a number of cases:
     1) The USB read timed out and we received no data.
     2) The USB read timed out and we received some data.
     3) The USB read was successful and fully filled our irp buffer.
     4) The irp was cancelled.
     5) Some other failure from the USB device object.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">ntStatus</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;s_nsInterruptUsbIoCompleteRead Status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntStatus</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>if we were not successful, we need to free the int buffer for future use right here
otherwise interrupt data handler will free int buffer after it handle it.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span> <span class="n">ntStatus</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span> <span class="p">))</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulBulkInError</span><span class="o">++</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">intBuf</span><span class="p">.</span><span class="n">bInUse</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><pre><code>   if (ntStatus == USBD_STATUS_CRC) {
       pDevice-&gt;ulIntInContCRCError++;
   }
</code></pre></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><pre><code>   if (ntStatus == STATUS_NOT_CONNECTED )
   {
</code></pre></td><td class="code"><div class="highlight"><pre>            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fKillEventPollingThread</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><pre><code>   }
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;IntUSBIoCompleteControl STATUS = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntStatus</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulIntInBytesRead</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulIntInContCRCError</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEventAvailable</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	    <span class="n">INTnsProcessData</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">STAvUpdateUSBCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">USB_InterruptStat</span><span class="p">,</span> <span class="n">ntStatus</span><span class="p">);</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fKillEventPollingThread</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="p">,</span>
		      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
		      <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">intBuf</span><span class="p">.</span><span class="n">pDataBuf</span><span class="p">,</span>
		     <span class="n">MAX_INTERRUPT_SIZE</span><span class="p">,</span>
		     <span class="n">s_nsInterruptUsbIoCompleteRead</span><span class="p">,</span>
		     <span class="n">pDevice</span><span class="p">);</span>

	<span class="n">ntStatus</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Submit int URB failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntStatus</span><span class="p">);</span>
           <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>We return STATUS<em>MORE</em>PROCESSING_REQUIRED so that the completion
routine (IofCompleteRequest) will stop working on the irp.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Allocates an usb BulkIn  irp and calls USBD.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice     - Pointer to the adapter</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: STATUS_INSUFFICIENT_RESOURCES or result of IoCallDriver</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">PIPEnsBulkInUsbRead</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">PRCB</span> <span class="n">pRCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ntStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">urb</span>          <span class="o">*</span><span class="n">pUrb</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;----&gt;s_nsStartBulkInUsbRead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_DISCONNECTED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulBulkInPosted</span><span class="o">++</span><span class="p">;</span>


	<span class="n">pUrb</span> <span class="o">=</span> <span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">pUrb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Now that we have created the urb, we will send a
request to the USB device object.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;pRCB-&gt;skb is null </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ntStatus</span><span class="p">;</span>
    <span class="p">}</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pUrb</span><span class="p">,</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
		<span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
		<span class="n">MAX_TOTAL_SIZE_WITH_ALL_HEADERS</span><span class="p">,</span>
		<span class="n">s_nsBulkInUsbIoCompleteRead</span><span class="p">,</span>
		<span class="n">pRCB</span><span class="p">);</span>

	<span class="n">ntStatus</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pUrb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Submit Rx URB failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntStatus</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_FAILURE</span> <span class="p">;</span>
	<span class="p">}</span>
    <span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">Ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span><span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">ntStatus</span><span class="p">;</span>
<span class="p">}</span>




<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Complete function of usb BulkIn irp.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice     - Pointer to the adapter</span>
<span class="cm"> *</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: STATUS_INSUFFICIENT_RESOURCES or result of IoCallDriver</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_nsBulkInUsbIoCompleteRead</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">)</span>

<span class="p">{</span>
    <span class="n">PRCB</span>    <span class="n">pRCB</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRCB</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">pDevice</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">bytesRead</span><span class="p">;</span>
    <span class="n">BOOL</span>    <span class="n">bIndicateReceive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">BOOL</span>    <span class="n">bReAllocSkb</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;----&gt;s_nsBulkInUsbIoCompleteRead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
    <span class="n">bytesRead</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulBulkInError</span><span class="o">++</span><span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;BULK In failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">RxFcsErrCnt</span> <span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>todo...xxxxxx
       if (status == USBD<em>STATUS</em>CRC) {
           pDevice->ulBulkInContCRCError++;
       }
       if (status == STATUS<em>DEVICE</em>NOT<em>CONNECTED )
       {
           MP</em>SET<em>FLAG(pDevice, fMP</em>DISCONNECTED);
       }</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">bIndicateReceive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulBulkInContCRCError</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulBulkInBytesRead</span> <span class="o">+=</span> <span class="n">bytesRead</span><span class="p">;</span>

           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">RxOkCnt</span> <span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="n">STAvUpdateUSBCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">USB_BulkInStat</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bIndicateReceive</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">RXbBulkInProcessData</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pRCB</span><span class="p">,</span> <span class="n">bytesRead</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
            <span class="n">bReAllocSkb</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">Ref</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">Ref</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;RxvFreeNormal %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">NumRecvFreeList</span><span class="p">);</span>
        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="n">RXvFreeRCB</span><span class="p">(</span><span class="n">pRCB</span><span class="p">,</span> <span class="n">bReAllocSkb</span><span class="p">);</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Allocates an usb BulkOut  irp and calls USBD.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice     - Pointer to the adapter</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: STATUS_INSUFFICIENT_RESOURCES or result of IoCallDriver</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">PIPEnsSendBulkOut</span><span class="p">(</span>
      <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
      <span class="n">PUSB_SEND_CONTEXT</span> <span class="n">pContext</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">urb</span>          <span class="o">*</span><span class="n">pUrb</span><span class="p">;</span>



    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bPWBitOn</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">    if (pDevice-&gt;pPendingBulkOutContext != NULL) {</span>
<span class="cm">        pDevice-&gt;NumContextsQueued++;</span>
<span class="cm">        EnqueueContext(pDevice-&gt;FirstTxContextQueue, pDevice-&gt;LastTxContextQueue, pContext);</span>
<span class="cm">        status = STATUS_PENDING;</span>
<span class="cm">        DBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO&quot;Send pending!\n&quot;);</span>
<span class="cm">        return status;</span>
<span class="cm">    }</span>
<span class="cm">*/</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;s_nsSendBulkOut</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">MP_IS_READY</span><span class="p">(</span><span class="n">pDevice</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">fMP_POST_WRITES</span><span class="p">))</span> <span class="p">{</span>

        <span class="n">pUrb</span> <span class="o">=</span> <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pUrb</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulBulkOutPosted</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><pre><code>   pDevice-&gt;pPendingBulkOutContext = pContext;
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="n">usb_fill_bulk_urb</span><span class="p">(</span>
        	    <span class="n">pUrb</span><span class="p">,</span>
        		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
		    <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
		    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        		<span class="n">pContext</span><span class="o">-&gt;</span><span class="n">uBufLen</span><span class="p">,</span>
        		<span class="n">s_nsBulkOutIoCompleteWrite</span><span class="p">,</span>
        		<span class="n">pContext</span><span class="p">);</span>

    	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pUrb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
    	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    	<span class="p">{</span>
    		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Submit Tx URB failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
    		<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
    	<span class="p">}</span>
        <span class="k">return</span> <span class="n">STATUS_PENDING</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">STATUS_RESOURCES</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description: s_nsBulkOutIoCompleteWrite</span>
<span class="cm"> *     1a) Indicate to the protocol the status of the write.</span>
<span class="cm"> *     1b) Return ownership of the packet to the protocol.</span>
<span class="cm"> *</span>
<span class="cm"> *     2)  If any more packets are queue for sending, send another packet</span>
<span class="cm"> *         to USBD.</span>
<span class="cm"> *         If the attempt to send the packet to the driver fails,</span>
<span class="cm"> *         return ownership of the packet to the protocol and</span>
<span class="cm"> *         try another packet (until one succeeds).</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pdoUsbDevObj  - pointer to the USB device object which</span>
<span class="cm"> *                      completed the irp</span>
<span class="cm"> *      pIrp          - the irp which was completed by the</span>
<span class="cm"> *                      device object</span>
<span class="cm"> *      pContext      - the context given to IoSetCompletionRoutine</span>
<span class="cm"> *                      before calling IoCallDriver on the irp</span>
<span class="cm"> *                      The pContext is a pointer to the USB device object.</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: STATUS_MORE_PROCESSING_REQUIRED - allows the completion routine</span>
<span class="cm"> *               (IofCompleteRequest) to stop working on the irp.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_nsBulkOutIoCompleteWrite</span><span class="p">(</span>
     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>            <span class="n">pDevice</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">CONTEXT_TYPE</span>        <span class="n">ContextType</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>               <span class="n">ulBufLen</span><span class="p">;</span>
    <span class="n">PUSB_SEND_CONTEXT</span>   <span class="n">pContext</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;----&gt;s_nsBulkOutIoCompleteWrite</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>The context given to IoSetCompletionRoutine is an USB_CONTEXT struct</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUSB_SEND_CONTEXT</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
    <span class="n">ASSERT</span><span class="p">(</span> <span class="nb">NULL</span> <span class="o">!=</span> <span class="n">pContext</span> <span class="p">);</span>

    <span class="n">pDevice</span> <span class="o">=</span> <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pDevice</span><span class="p">;</span>
    <span class="n">ContextType</span> <span class="o">=</span> <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Type</span><span class="p">;</span>
    <span class="n">ulBufLen</span> <span class="o">=</span> <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">uBufLen</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
	    <span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Perform various IRP, URB, and buffer 'sanity checks'</p></td><td class="code"><div class="highlight"><pre>    <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>we should have failed, succeeded, or cancelled, but NOT be pending</p></td><td class="code"><div class="highlight"><pre>    <span class="n">STAvUpdateUSBCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">USB_BulkOutStat</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Write %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">ulBufLen</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulBulkOutBytesWrite</span> <span class="o">+=</span> <span class="n">ulBufLen</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulBulkOutContCRCError</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">nTxDataTimeCout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;BULK Out failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulBulkOutError</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>pDevice->ulCheckForHangCount = 0;
   pDevice->pPendingBulkOutContext = NULL;</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="n">CONTEXT_DATA_PACKET</span> <span class="o">==</span> <span class="n">ContextType</span> <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Indicate to the protocol the status of the sent packet and return
ownership of the packet.</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">if</span> <span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pPacket</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pPacket</span><span class="p">);</span>
	        <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;tx  %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">ulBufLen</span><span class="p">);</span>
	    <span class="p">}</span>

        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">packetsSent</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Send USB error! [%08xh]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">packetsSentDropped</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
            <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
