<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6656 › rxtx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rxtx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * File: rxtx.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: handle WMAC/802.3/802.11 rx &amp; tx functions</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Lyndon Chen</span>
<span class="cm"> *</span>
<span class="cm"> * Date: May 20, 2003</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *      s_vGenerateTxParameter - Generate tx dma required parameter.</span>
<span class="cm"> *      s_vGenerateMACHeader - Translate 802.3 to 802.11 header</span>
<span class="cm"> *      csBeacon_xmit - beacon tx function</span>
<span class="cm"> *      csMgmt_xmit - management tx function</span>
<span class="cm"> *      s_uGetDataDuration - get tx data required duration</span>
<span class="cm"> *      s_uFillDataHead- fulfill tx data duration header</span>
<span class="cm"> *      s_uGetRTSCTSDuration- get rtx/cts required duration</span>
<span class="cm"> *      s_uGetRTSCTSRsvTime- get rts/cts reserved time</span>
<span class="cm"> *      s_uGetTxRsvTime- get frame reserved time</span>
<span class="cm"> *      s_vFillCTSHead- fulfill CTS ctl header</span>
<span class="cm"> *      s_vFillFragParameter- Set fragment ctl parameter.</span>
<span class="cm"> *      s_vFillRTSHead- fulfill RTS ctl header</span>
<span class="cm"> *      s_vFillTxKey- fulfill tx encrypt key</span>
<span class="cm"> *      s_vSWencryption- Software encrypt header</span>
<span class="cm"> *      vDMA0_tx_80211- tx 802.11 frame via dma0</span>
<span class="cm"> *      vGenerateFIFOHeader- Generate tx FIFO ctl header</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;rxtx.h&quot;</span>
<span class="cp">#include &quot;tether.h&quot;</span>
<span class="cp">#include &quot;card.h&quot;</span>
<span class="cp">#include &quot;bssdb.h&quot;</span>
<span class="cp">#include &quot;mac.h&quot;</span>
<span class="cp">#include &quot;baseband.h&quot;</span>
<span class="cp">#include &quot;michael.h&quot;</span>
<span class="cp">#include &quot;tkip.h&quot;</span>
<span class="cp">#include &quot;tcrc.h&quot;</span>
<span class="cp">#include &quot;wctl.h&quot;</span>
<span class="cp">#include &quot;hostap.h&quot;</span>
<span class="cp">#include &quot;rf.h&quot;</span>
<span class="cp">#include &quot;datarate.h&quot;</span>
<span class="cp">#include &quot;usbpipe.h&quot;</span>
<span class="cp">#include &quot;iocmd.h&quot;</span>

<span class="cm">/*---------------------  Static Definitions -------------------------*/</span>

<span class="cm">/*---------------------  Static Classes  ----------------------------*/</span>

<span class="cm">/*---------------------  Static Variables  --------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span> <span class="n">MSG_LEVEL_INFO</span><span class="p">;</span>

<span class="cm">/*---------------------  Static Functions  --------------------------*/</span>

<span class="cm">/*---------------------  Static Definitions -------------------------*/</span>
<span class="cp">#define CRITICAL_PACKET_LEN      256    </span><span class="c1">// if packet size &lt; 256 -&gt; in-direct send</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>packet size >= 256 -> direct send</p></td><td class="code"><div class="highlight"><pre><span class="k">const</span> <span class="n">WORD</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">MAX_RATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="mi">384</span><span class="p">,</span> <span class="mi">288</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">23</span><span class="p">},</span> <span class="c1">// Long Preamble</span>
        <span class="p">{</span><span class="mi">384</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">23</span><span class="p">},</span> <span class="c1">// Short Preamble</span>
    <span class="p">};</span>

<span class="k">const</span> <span class="n">WORD</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_36M</span><span class="p">,</span> <span class="n">RATE_48M</span><span class="p">},</span> <span class="c1">// fallback_rate0</span>
        <span class="p">{</span><span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_36M</span><span class="p">},</span> <span class="c1">// fallback_rate1</span>
    <span class="p">};</span>
<span class="k">const</span> <span class="n">WORD</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_36M</span><span class="p">},</span> <span class="c1">// fallback_rate0</span>
        <span class="p">{</span><span class="n">RATE_6M</span> <span class="p">,</span> <span class="n">RATE_6M</span><span class="p">,</span>  <span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">},</span> <span class="c1">// fallback_rate1</span>
    <span class="p">};</span>


<span class="cp">#define RTSDUR_BB       0</span>
<span class="cp">#define RTSDUR_BA       1</span>
<span class="cp">#define RTSDUR_AA       2</span>
<span class="cp">#define CTSDUR_BA       3</span>
<span class="cp">#define RTSDUR_BA_F0    4</span>
<span class="cp">#define RTSDUR_AA_F0    5</span>
<span class="cp">#define RTSDUR_BA_F1    6</span>
<span class="cp">#define RTSDUR_AA_F1    7</span>
<span class="cp">#define CTSDUR_BA_F0    8</span>
<span class="cp">#define CTSDUR_BA_F1    9</span>
<span class="cp">#define DATADUR_B       10</span>
<span class="cp">#define DATADUR_A       11</span>
<span class="cp">#define DATADUR_A_F0    12</span>
<span class="cp">#define DATADUR_A_F1    13</span>

<span class="cm">/*---------------------  Static Functions  --------------------------*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vSaveTxPktInfo</span><span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byPktNum</span><span class="p">,</span>
     <span class="n">PBYTE</span> <span class="n">pbyDestAddr</span><span class="p">,</span>
     <span class="n">WORD</span> <span class="n">wPktLength</span><span class="p">,</span>
     <span class="n">WORD</span> <span class="n">wFIFOCtl</span>
<span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="n">s_vGetFreeContext</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span>
    <span class="p">);</span>


<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vGenerateTxParameter</span><span class="p">(</span>
     <span class="n">PSDevice</span>         <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>             <span class="n">byPktType</span><span class="p">,</span>
     <span class="n">WORD</span>             <span class="n">wCurrentRate</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pTxBufHead</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvRrvTime</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvRTS</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvCTS</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">cbFrameSize</span><span class="p">,</span>
     <span class="n">BOOL</span>             <span class="n">bNeedACK</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uDMAIdx</span><span class="p">,</span>
     <span class="n">PSEthernetHeader</span> <span class="n">psEthHeader</span>
    <span class="p">);</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s_uFillDataHead</span><span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byPktType</span><span class="p">,</span>
     <span class="n">WORD</span>     <span class="n">wCurrentRate</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pTxDataHead</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uDMAIdx</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uFragIdx</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbLastFragmentSize</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uMACfragNum</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byFBOption</span>
    <span class="p">);</span>




<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vGenerateMACHeader</span> <span class="p">(</span>
     <span class="n">PSDevice</span>         <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">PBYTE</span>            <span class="n">pbyBufferAddr</span><span class="p">,</span>
     <span class="n">WORD</span>             <span class="n">wDuration</span><span class="p">,</span>
     <span class="n">PSEthernetHeader</span> <span class="n">psEthHeader</span><span class="p">,</span>
     <span class="n">BOOL</span>             <span class="n">bNeedEncrypt</span><span class="p">,</span>
     <span class="n">WORD</span>             <span class="n">wFragType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uDMAIdx</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uFragIdx</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vFillTxKey</span><span class="p">(</span>
      <span class="n">PSDevice</span>   <span class="n">pDevice</span><span class="p">,</span>
      <span class="n">PBYTE</span>      <span class="n">pbyBuf</span><span class="p">,</span>
      <span class="n">PBYTE</span>      <span class="n">pbyIVHead</span><span class="p">,</span>
      <span class="n">PSKeyItem</span>  <span class="n">pTransmitKey</span><span class="p">,</span>
      <span class="n">PBYTE</span>      <span class="n">pbyHdrBuf</span><span class="p">,</span>
      <span class="n">WORD</span>       <span class="n">wPayloadLen</span><span class="p">,</span>
     <span class="n">PBYTE</span>      <span class="n">pMICHDR</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vSWencryption</span> <span class="p">(</span>
      <span class="n">PSDevice</span>         <span class="n">pDevice</span><span class="p">,</span>
      <span class="n">PSKeyItem</span>        <span class="n">pTransmitKey</span><span class="p">,</span>
      <span class="n">PBYTE</span>            <span class="n">pbyPayloadHead</span><span class="p">,</span>
      <span class="n">WORD</span>             <span class="n">wPayloadSize</span>
    <span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byPktType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">WORD</span>     <span class="n">wRate</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bNeedAck</span>
    <span class="p">);</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s_uGetRTSCTSRsvTime</span><span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byRTSRsvType</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byPktType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">WORD</span> <span class="n">wCurrentRate</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vFillCTSHead</span> <span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uDMAIdx</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byPktType</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvCTS</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bDisCRC</span><span class="p">,</span>
     <span class="n">WORD</span>     <span class="n">wCurrentRate</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byFBOption</span>
    <span class="p">);</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="n">s_vFillRTSHead</span><span class="p">(</span>
     <span class="n">PSDevice</span>         <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>             <span class="n">byPktType</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvRTS</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">BOOL</span>             <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="n">BOOL</span>             <span class="n">bDisCRC</span><span class="p">,</span>
     <span class="n">PSEthernetHeader</span> <span class="n">psEthHeader</span><span class="p">,</span>
     <span class="n">WORD</span>             <span class="n">wCurrentRate</span><span class="p">,</span>
     <span class="n">BYTE</span>             <span class="n">byFBOption</span>
    <span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s_uGetDataDuration</span><span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byDurType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byPktType</span><span class="p">,</span>
     <span class="n">WORD</span>     <span class="n">wRate</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uFragIdx</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbLastFragmentSize</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uMACfragNum</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byFBOption</span>
    <span class="p">);</span>


<span class="k">static</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="n">s_uGetRTSCTSDuration</span> <span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byDurType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byPktType</span><span class="p">,</span>
     <span class="n">WORD</span> <span class="n">wRate</span><span class="p">,</span>
     <span class="n">BOOL</span> <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byFBOption</span>
    <span class="p">);</span>


<span class="cm">/*---------------------  Export Variables  --------------------------*/</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">s_vGetFreeContext</span><span class="p">(</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PUSB_SEND_CONTEXT</span>   <span class="n">pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PUSB_SEND_CONTEXT</span>   <span class="n">pReturnContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>                <span class="n">ii</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;GetFreeContext()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbTD</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pContext</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">pReturnContext</span> <span class="o">=</span> <span class="n">pContext</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">ii</span> <span class="o">==</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbTD</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;No Free Tx Context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pReturnContext</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vSaveTxPktInfo</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">byPktNum</span><span class="p">,</span> <span class="n">PBYTE</span> <span class="n">pbyDestAddr</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">wPktLength</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">wFIFOCtl</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSStatCounter</span>           <span class="n">pStatistic</span><span class="o">=&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">pbyDestAddr</span><span class="p">))</span>
        <span class="n">pStatistic</span><span class="o">-&gt;</span><span class="n">abyTxPktInfo</span><span class="p">[</span><span class="n">byPktNum</span><span class="p">].</span><span class="n">byBroadMultiUni</span> <span class="o">=</span> <span class="n">TX_PKT_BROAD</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">pbyDestAddr</span><span class="p">))</span>
        <span class="n">pStatistic</span><span class="o">-&gt;</span><span class="n">abyTxPktInfo</span><span class="p">[</span><span class="n">byPktNum</span><span class="p">].</span><span class="n">byBroadMultiUni</span> <span class="o">=</span> <span class="n">TX_PKT_MULTI</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">pStatistic</span><span class="o">-&gt;</span><span class="n">abyTxPktInfo</span><span class="p">[</span><span class="n">byPktNum</span><span class="p">].</span><span class="n">byBroadMultiUni</span> <span class="o">=</span> <span class="n">TX_PKT_UNI</span><span class="p">;</span>

    <span class="n">pStatistic</span><span class="o">-&gt;</span><span class="n">abyTxPktInfo</span><span class="p">[</span><span class="n">byPktNum</span><span class="p">].</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">wPktLength</span><span class="p">;</span>
    <span class="n">pStatistic</span><span class="o">-&gt;</span><span class="n">abyTxPktInfo</span><span class="p">[</span><span class="n">byPktNum</span><span class="p">].</span><span class="n">wFIFOCtl</span> <span class="o">=</span> <span class="n">wFIFOCtl</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pStatistic</span><span class="o">-&gt;</span><span class="n">abyTxPktInfo</span><span class="p">[</span><span class="n">byPktNum</span><span class="p">].</span><span class="n">abyDestAddr</span><span class="p">,</span>
	   <span class="n">pbyDestAddr</span><span class="p">,</span>
	   <span class="n">ETH_ALEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vFillTxKey</span> <span class="p">(</span>
      <span class="n">PSDevice</span>   <span class="n">pDevice</span><span class="p">,</span>
      <span class="n">PBYTE</span>      <span class="n">pbyBuf</span><span class="p">,</span>
      <span class="n">PBYTE</span>      <span class="n">pbyIVHead</span><span class="p">,</span>
      <span class="n">PSKeyItem</span>  <span class="n">pTransmitKey</span><span class="p">,</span>
      <span class="n">PBYTE</span>      <span class="n">pbyHdrBuf</span><span class="p">,</span>
      <span class="n">WORD</span>       <span class="n">wPayloadLen</span><span class="p">,</span>
     <span class="n">PBYTE</span>      <span class="n">pMICHDR</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PDWORD</span>          <span class="n">pdwIV</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span> <span class="n">pbyIVHead</span><span class="p">;</span>
    <span class="n">PDWORD</span>          <span class="n">pdwExtIV</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span> <span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pbyIVHead</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">WORD</span>            <span class="n">wValue</span><span class="p">;</span>
    <span class="n">PS802_11Header</span>  <span class="n">pMACHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span><span class="n">pbyHdrBuf</span><span class="p">;</span>
    <span class="n">DWORD</span>           <span class="n">dwRevIVCounter</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Fill TXKEY</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">dwRevIVCounter</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIVCounter</span><span class="p">);</span>
    <span class="o">*</span><span class="n">pdwIV</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIVCounter</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span> <span class="o">=</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">==</span> <span class="n">WLAN_WEP232_KEYLEN</span> <span class="p">){</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dwRevIVCounter</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyBuf</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dwRevIVCounter</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyBuf</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">==</span> <span class="n">WLAN_WEP40_KEYLEN</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyBuf</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dwRevIVCounter</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyBuf</span><span class="o">+</span><span class="mi">11</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">pbyBuf</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Append IV after Mac Header</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pdwIV</span> <span class="o">&amp;=</span> <span class="n">WEP_IV_MASK</span><span class="p">;</span><span class="c1">//00000000 11111111 11111111 11111111</span>
        <span class="o">*</span><span class="n">pdwIV</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
        <span class="o">*</span><span class="n">pdwIV</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">pdwIV</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIVCounter</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIVCounter</span> <span class="o">&gt;</span> <span class="n">WEP_IV_MASK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwIVCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">TKIPvMixKey</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">,</span>
                    <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyBuf</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Make IV</p></td><td class="code"><div class="highlight"><pre>        <span class="n">memcpy</span><span class="p">(</span><span class="n">pdwIV</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

        <span class="o">*</span><span class="p">(</span><span class="n">pbyIVHead</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span> <span class="c1">// 0x20 is ExtIV</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Append IV&amp;ExtIV after Mac Header</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pdwExtIV</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;vFillTxKey()---- pdwExtIV: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwExtIV</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyBuf</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Make IV</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pdwIV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="o">*</span><span class="p">(</span><span class="n">pbyIVHead</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span> <span class="c1">// 0x20 is ExtIV</span>
        <span class="o">*</span><span class="n">pdwIV</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Append IV&amp;ExtIV after Mac Header</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pdwExtIV</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Fill MICHDR0</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pMICHDR</span> <span class="o">=</span> <span class="mh">0x59</span><span class="p">;</span>
        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// TxPriority</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">6</span><span class="p">);</span>
        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">8</span><span class="p">))</span> <span class="o">=</span> <span class="n">HIBYTE</span><span class="p">(</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="p">));</span>
        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">9</span><span class="p">))</span> <span class="o">=</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="p">));</span>
        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">10</span><span class="p">))</span> <span class="o">=</span> <span class="n">HIBYTE</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="p">));</span>
        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">11</span><span class="p">))</span> <span class="o">=</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="p">));</span>
        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">12</span><span class="p">))</span> <span class="o">=</span> <span class="n">HIBYTE</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span><span class="p">);</span>
        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">13</span><span class="p">))</span> <span class="o">=</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span><span class="p">);</span>
        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">14</span><span class="p">))</span> <span class="o">=</span> <span class="n">HIBYTE</span><span class="p">(</span><span class="n">wPayloadLen</span><span class="p">);</span>
        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">15</span><span class="p">))</span> <span class="o">=</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">wPayloadLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Fill MICHDR1</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">16</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// HLEN[15:8]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLongHeader</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">17</span><span class="p">))</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span> <span class="c1">// HLEN[7:0]</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">17</span><span class="p">))</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span> <span class="c1">// HLEN[7:0]</span>
        <span class="p">}</span>
        <span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">&amp;</span> <span class="mh">0xC78F</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">18</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wValue</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// MSKFRACTL</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">20</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">6</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">26</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">6</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Fill MICHDR2</p></td><td class="code"><div class="highlight"><pre>        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">32</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">6</span><span class="p">);</span>
        <span class="n">wValue</span> <span class="o">=</span> <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wSeqCtl</span><span class="p">;</span>
        <span class="n">wValue</span> <span class="o">&amp;=</span> <span class="mh">0x000F</span><span class="p">;</span>
        <span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wValue</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">38</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wValue</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// MSKSEQCTL</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLongHeader</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pMICHDR</span><span class="o">+</span><span class="mi">40</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr4</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">6</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vSWencryption</span> <span class="p">(</span>
      <span class="n">PSDevice</span>            <span class="n">pDevice</span><span class="p">,</span>
      <span class="n">PSKeyItem</span>           <span class="n">pTransmitKey</span><span class="p">,</span>
      <span class="n">PBYTE</span>               <span class="n">pbyPayloadHead</span><span class="p">,</span>
      <span class="n">WORD</span>                <span class="n">wPayloadSize</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">DWORD</span>  <span class="n">dwICV</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFL</span><span class="p">;</span>
    <span class="n">PDWORD</span> <span class="n">pdwICV</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>=======================================================================
Append ICV after payload</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dwICV</span> <span class="o">=</span> <span class="n">CRCdwGetCrc32Ex</span><span class="p">(</span><span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="n">wPayloadSize</span><span class="p">,</span> <span class="n">dwICV</span><span class="p">);</span><span class="c1">//ICV(Payload)</span>
        <span class="n">pdwICV</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">pbyPayloadHead</span> <span class="o">+</span> <span class="n">wPayloadSize</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>finally, we must invert dwCRC to get the correct answer</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pdwICV</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">dwICV</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>RC4 encryption</p></td><td class="code"><div class="highlight"><pre>        <span class="n">rc4_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
        <span class="n">rc4_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="n">wPayloadSize</span><span class="o">+</span><span class="n">cbICVlen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>=======================================================================</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>=======================================================================
Append ICV after payload</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dwICV</span> <span class="o">=</span> <span class="n">CRCdwGetCrc32Ex</span><span class="p">(</span><span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="n">wPayloadSize</span><span class="p">,</span> <span class="n">dwICV</span><span class="p">);</span><span class="c1">//ICV(Payload)</span>
        <span class="n">pdwICV</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">pbyPayloadHead</span> <span class="o">+</span> <span class="n">wPayloadSize</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>finally, we must invert dwCRC to get the correct answer</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pdwICV</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">dwICV</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>RC4 encryption</p></td><td class="code"><div class="highlight"><pre>        <span class="n">rc4_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPRNG</span><span class="p">,</span> <span class="n">TKIP_KEY_LEN</span><span class="p">);</span>
        <span class="n">rc4_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">SBox</span><span class="p">,</span> <span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="n">wPayloadSize</span><span class="o">+</span><span class="n">cbICVlen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>=======================================================================</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>
<span class="p">}</span>




<span class="cm">/*byPktType : PK_TYPE_11A     0</span>
<span class="cm">             PK_TYPE_11B     1</span>
<span class="cm">             PK_TYPE_11GB    2</span>
<span class="cm">             PK_TYPE_11GA    3</span>
<span class="cm">*/</span>
<span class="k">static</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">s_uGetTxRsvTime</span> <span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byPktType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">WORD</span>     <span class="n">wRate</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bNeedAck</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uDataTime</span><span class="p">,</span> <span class="n">uAckTime</span><span class="p">;</span>

    <span class="n">uDataTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wRate</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11B</span><span class="p">)</span> <span class="p">{</span><span class="c1">//llb,CCK mode</span>
        <span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="c1">//11g 2.4G OFDM mode &amp; 11a 5G OFDM mode</span>
        <span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bNeedAck</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">uDataTime</span> <span class="o">+</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uAckTime</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">uDataTime</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>byFreqType: 0=>5GHZ 1=>2.4GHZ</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">s_uGetRTSCTSRsvTime</span> <span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byRTSRsvType</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byPktType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">WORD</span> <span class="n">wCurrentRate</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uRrvTime</span>  <span class="p">,</span> <span class="n">uRTSTime</span><span class="p">,</span> <span class="n">uCTSTime</span><span class="p">,</span> <span class="n">uAckTime</span><span class="p">,</span> <span class="n">uDataTime</span><span class="p">;</span>

    <span class="n">uRrvTime</span> <span class="o">=</span> <span class="n">uRTSTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">uAckTime</span> <span class="o">=</span> <span class="n">uDataTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


    <span class="n">uDataTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byRTSRsvType</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//RTSTxRrvTime_bb</span>
        <span class="n">uRTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byRTSRsvType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span> <span class="c1">//RTSTxRrvTime_ba, only in 2.4GHZ</span>
        <span class="n">uRTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
        <span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byRTSRsvType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//RTSTxRrvTime_aa</span>
        <span class="n">uRTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byRTSRsvType</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//CTSTxRrvTime_ba, only in 2.4GHZ</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
        <span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
        <span class="n">uRrvTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="n">uAckTime</span> <span class="o">+</span> <span class="n">uDataTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">uRrvTime</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>RTSRrvTime</p></td><td class="code"><div class="highlight"><pre>    <span class="n">uRrvTime</span> <span class="o">=</span> <span class="n">uRTSTime</span> <span class="o">+</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="n">uAckTime</span> <span class="o">+</span> <span class="n">uDataTime</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">uRrvTime</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>byFreqType 0: 5GHz, 1:2.4Ghz</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">s_uGetDataDuration</span> <span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byDurType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byPktType</span><span class="p">,</span>
     <span class="n">WORD</span>     <span class="n">wRate</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uFragIdx</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbLastFragmentSize</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uMACfragNum</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byFBOption</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">bLastFrag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uAckTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">uFragIdx</span> <span class="o">==</span> <span class="p">(</span><span class="n">uMACfragNum</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">bLastFrag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">byDurType</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">case</span> <span class="n">DATADUR_B</span>:    <span class="c1">//DATADUR_B</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">uMACfragNum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">bLastFrag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span><span class="c1">//Non Frag or Last Frag</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bNeedAck</span><span class="p">)</span> <span class="p">{</span>
            	<span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uAckTime</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span><span class="c1">//First Frag or Mid Frag</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">uFragIdx</span> <span class="o">==</span> <span class="p">(</span><span class="n">uMACfragNum</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
            	<span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">wRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bNeedAck</span><span class="p">)</span> <span class="p">{</span>
            	<span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uAckTime</span> <span class="o">+</span> <span class="n">uNextPktTime</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uNextPktTime</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>


    <span class="k">case</span> <span class="n">DATADUR_A</span>:    <span class="c1">//DATADUR_A</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">uMACfragNum</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">bLastFrag</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span><span class="c1">//Non Frag or Last Frag</span>
            <span class="k">if</span><span class="p">(</span><span class="n">bNeedAck</span><span class="p">){</span>
            	<span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uAckTime</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span><span class="c1">//First Frag or Mid Frag</span>
            <span class="k">if</span><span class="p">(</span><span class="n">uFragIdx</span> <span class="o">==</span> <span class="p">(</span><span class="n">uMACfragNum</span><span class="o">-</span><span class="mi">2</span><span class="p">)){</span>
            	<span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">wRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">bNeedAck</span><span class="p">){</span>
            	<span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uAckTime</span> <span class="o">+</span> <span class="n">uNextPktTime</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uNextPktTime</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DATADUR_A_F0</span>:    <span class="c1">//DATADUR_A_F0</span>
	    <span class="k">if</span> <span class="p">(((</span><span class="n">uMACfragNum</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">bLastFrag</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span><span class="c1">//Non Frag or Last Frag</span>
            <span class="k">if</span><span class="p">(</span><span class="n">bNeedAck</span><span class="p">){</span>
            	<span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uAckTime</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
	    <span class="k">else</span> <span class="p">{</span> <span class="c1">//First Frag or Mid Frag</span>
	        <span class="k">if</span> <span class="p">(</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;</span> <span class="n">RATE_18M</span><span class="p">)</span>
                    <span class="n">wRate</span> <span class="o">=</span> <span class="n">RATE_18M</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;</span> <span class="n">RATE_54M</span><span class="p">)</span>
                    <span class="n">wRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>

	            <span class="k">if</span><span class="p">(</span><span class="n">uFragIdx</span> <span class="o">==</span> <span class="p">(</span><span class="n">uMACfragNum</span><span class="o">-</span><span class="mi">2</span><span class="p">)){</span>
            	    <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
                <span class="p">}</span>
	        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// (byFBOption == AUTO_FB_1)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;</span> <span class="n">RATE_18M</span><span class="p">)</span>
                    <span class="n">wRate</span> <span class="o">=</span> <span class="n">RATE_18M</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;</span> <span class="n">RATE_54M</span><span class="p">)</span>
                    <span class="n">wRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>

	            <span class="k">if</span><span class="p">(</span><span class="n">uFragIdx</span> <span class="o">==</span> <span class="p">(</span><span class="n">uMACfragNum</span><span class="o">-</span><span class="mi">2</span><span class="p">)){</span>
            	    <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
                <span class="p">}</span>
	        <span class="p">}</span>

	        <span class="k">if</span><span class="p">(</span><span class="n">bNeedAck</span><span class="p">){</span>
            	<span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uAckTime</span> <span class="o">+</span> <span class="n">uNextPktTime</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uNextPktTime</span><span class="p">);</span>
            <span class="p">}</span>
	    <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DATADUR_A_F1</span>:    <span class="c1">//DATADUR_A_F1</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">uMACfragNum</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">bLastFrag</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span><span class="c1">//Non Frag or Last Frag</span>
            <span class="k">if</span><span class="p">(</span><span class="n">bNeedAck</span><span class="p">){</span>
            	<span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uAckTime</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
	    <span class="k">else</span> <span class="p">{</span> <span class="c1">//First Frag or Mid Frag</span>
	        <span class="k">if</span> <span class="p">(</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;</span> <span class="n">RATE_18M</span><span class="p">)</span>
                    <span class="n">wRate</span> <span class="o">=</span> <span class="n">RATE_18M</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;</span> <span class="n">RATE_54M</span><span class="p">)</span>
                    <span class="n">wRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>

	            <span class="k">if</span><span class="p">(</span><span class="n">uFragIdx</span> <span class="o">==</span> <span class="p">(</span><span class="n">uMACfragNum</span><span class="o">-</span><span class="mi">2</span><span class="p">)){</span>
            	    <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
                <span class="p">}</span>

	        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// (byFBOption == AUTO_FB_1)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;</span> <span class="n">RATE_18M</span><span class="p">)</span>
                    <span class="n">wRate</span> <span class="o">=</span> <span class="n">RATE_18M</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;</span> <span class="n">RATE_54M</span><span class="p">)</span>
                    <span class="n">wRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>

	            <span class="k">if</span><span class="p">(</span><span class="n">uFragIdx</span> <span class="o">==</span> <span class="p">(</span><span class="n">uMACfragNum</span><span class="o">-</span><span class="mi">2</span><span class="p">)){</span>
            	    <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">uNextPktTime</span> <span class="o">=</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
                <span class="p">}</span>
	        <span class="p">}</span>
	        <span class="k">if</span><span class="p">(</span><span class="n">bNeedAck</span><span class="p">){</span>
            	<span class="n">uAckTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uAckTime</span> <span class="o">+</span> <span class="n">uNextPktTime</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">uNextPktTime</span><span class="p">);</span>
            <span class="p">}</span>
	    <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>byFreqType: 0=>5GHZ 1=>2.4GHZ</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">s_uGetRTSCTSDuration</span> <span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byDurType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byPktType</span><span class="p">,</span>
     <span class="n">WORD</span> <span class="n">wRate</span><span class="p">,</span>
     <span class="n">BOOL</span> <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="n">BYTE</span> <span class="n">byFBOption</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uCTSTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uDurTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


    <span class="k">switch</span> <span class="p">(</span><span class="n">byDurType</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">case</span> <span class="n">RTSDUR_BB</span>:    <span class="c1">//RTSDuration_bb</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
        <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">RTSDUR_BA</span>:    <span class="c1">//RTSDuration_ba</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
        <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">RTSDUR_AA</span>:    <span class="c1">//RTSDuration_aa</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
        <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">CTSDUR_BA</span>:    <span class="c1">//CTSDuration_ba</span>
        <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">RTSDUR_BA_F0</span>: <span class="c1">//RTSDuration_ba_f0</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">RTSDUR_AA_F0</span>: <span class="c1">//RTSDuration_aa_f0</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">RTSDUR_BA_F1</span>: <span class="c1">//RTSDuration_ba_f1</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">RTSDUR_AA_F1</span>: <span class="c1">//RTSDuration_aa_f1</span>
        <span class="n">uCTSTime</span> <span class="o">=</span> <span class="n">BBuGetFrameTime</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">uCTSTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">CTSDUR_BA_F0</span>: <span class="c1">//CTSDuration_ba_f0</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE0</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">CTSDUR_BA_F1</span>: <span class="c1">//CTSDuration_ba_f1</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt0</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;=</span><span class="n">RATE_54M</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">uDurTime</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uSIFS</span> <span class="o">+</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wFB_Opt1</span><span class="p">[</span><span class="n">FB_RATE1</span><span class="p">][</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">],</span> <span class="n">bNeedAck</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">uDurTime</span><span class="p">;</span>

<span class="p">}</span>




<span class="k">static</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">s_uFillDataHead</span> <span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byPktType</span><span class="p">,</span>
     <span class="n">WORD</span>     <span class="n">wCurrentRate</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pTxDataHead</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uDMAIdx</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uFragIdx</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbLastFragmentSize</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uMACfragNum</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byFBOption</span>
    <span class="p">)</span>
<span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pTxDataHead</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span> <span class="o">||</span> <span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">uDMAIdx</span> <span class="o">==</span> <span class="n">TYPE_ATIMDMA</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">uDMAIdx</span> <span class="o">==</span> <span class="n">TYPE_BEACONDMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PSTxDataHead_ab</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span> <span class="n">pTxDataHead</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField</span><span class="p">)</span>
            <span class="p">);</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Get Duration and TimeStampOff</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                                                       <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span>
                                                       <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span>
                                                       <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//1: 2.4GHz</span>
            <span class="k">if</span><span class="p">(</span><span class="n">uDMAIdx</span><span class="o">!=</span><span class="n">TYPE_ATIMDMA</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTimeStampOff</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">wCurrentRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span> <span class="c1">// DATA &amp; MANAGE Frame</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PSTxDataHead_g</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_g</span><span class="p">)</span><span class="n">pTxDataHead</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>                <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_a</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_a</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_a</span><span class="p">)</span>
                <span class="p">);</span>
                <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_b</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_b</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_b</span><span class="p">)</span>
                <span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Get Duration and TimeStamp</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span>
                                                             <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span>
                                                             <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span>
                                                             <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//1: 2.4GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_B</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span>
                                                             <span class="n">PK_TYPE_11B</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span>
                                                             <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span>
                                                             <span class="n">uMACfragNum</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//1: 2.4GHz</span>

                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTimeStampOff_a</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">wCurrentRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTimeStampOff_b</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_a</span><span class="p">);</span>
             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Auto Fallback</p></td><td class="code"><div class="highlight"><pre>                <span class="n">PSTxDataHead_g_FB</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_g_FB</span><span class="p">)</span><span class="n">pTxDataHead</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>                <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_a</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_a</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_a</span><span class="p">)</span>
                <span class="p">);</span>
                <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_b</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_b</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_b</span><span class="p">)</span>
                <span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Get Duration and TimeStamp</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                                             <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//1: 2.4GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_B</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
                                             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//1: 2.4GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_a_f0</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A_F0</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                                             <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//1: 2.4GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_a_f1</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A_F1</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                                             <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//1: 2.4GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTimeStampOff_a</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">wCurrentRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTimeStampOff_b</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_a</span><span class="p">);</span>
            <span class="p">}</span> <span class="c1">//if (byFBOption == AUTO_FB_NONE)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">byFBOption</span> <span class="o">!=</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">uDMAIdx</span> <span class="o">!=</span> <span class="n">TYPE_ATIMDMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">uDMAIdx</span> <span class="o">!=</span> <span class="n">TYPE_BEACONDMA</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Auto Fallback</p></td><td class="code"><div class="highlight"><pre>            <span class="n">PSTxDataHead_a_FB</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_a_FB</span><span class="p">)</span><span class="n">pTxDataHead</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField</span><span class="p">)</span>
            <span class="p">);</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Get Duration and TimeStampOff</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                                        <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//0: 5GHz</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_f0</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A_F0</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                                        <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//0: 5GHz</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_f1</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A_F1</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                                        <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span> <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//0: 5GHz</span>
            <span class="k">if</span><span class="p">(</span><span class="n">uDMAIdx</span><span class="o">!=</span><span class="n">TYPE_ATIMDMA</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTimeStampOff</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">wCurrentRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">PSTxDataHead_ab</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span><span class="n">pTxDataHead</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField</span><span class="p">)</span>
            <span class="p">);</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Get Duration and TimeStampOff</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                                                       <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span>
                                                       <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span>
                                                       <span class="n">byFBOption</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">uDMAIdx</span><span class="o">!=</span><span class="n">TYPE_ATIMDMA</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTimeStampOff</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">wCurrentRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PSTxDataHead_ab</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span><span class="n">pTxDataHead</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField</span><span class="p">)</span>
            <span class="p">);</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Get Duration and TimeStampOff</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_B</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                                                       <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">uFragIdx</span><span class="p">,</span>
                                                       <span class="n">cbLastFragmentSize</span><span class="p">,</span> <span class="n">uMACfragNum</span><span class="p">,</span>
                                                       <span class="n">byFBOption</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">uDMAIdx</span> <span class="o">!=</span> <span class="n">TYPE_ATIMDMA</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTimeStampOff</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">wCurrentRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>




<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vFillRTSHead</span> <span class="p">(</span>
     <span class="n">PSDevice</span>         <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>             <span class="n">byPktType</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvRTS</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">BOOL</span>             <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="n">BOOL</span>             <span class="n">bDisCRC</span><span class="p">,</span>
     <span class="n">PSEthernetHeader</span> <span class="n">psEthHeader</span><span class="p">,</span>
     <span class="n">WORD</span>             <span class="n">wCurrentRate</span><span class="p">,</span>
     <span class="n">BYTE</span>             <span class="n">byFBOption</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uRTSFrameLen</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">WORD</span>  <span class="n">wLen</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pvRTS</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    	<span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bDisCRC</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>When CRCDIS bit is on, H/W forgot to generate FCS for RTS frame,
in this case we need to decrease its length by 4.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">uRTSFrameLen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Note: So far RTSHead dosen't appear in ATIM &amp; Beacom DMA, so we don't need to take them into account.
      Otherwise, we need to modified codes for them.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span> <span class="o">||</span> <span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PSRTS_g</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRTS_g</span><span class="p">)</span><span class="n">pvRTS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uRTSFrameLen</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wLen</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_b</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_b</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_b</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wLen</span><span class="p">);</span>
            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uRTSFrameLen</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wLen</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_a</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_a</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_a</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>Get Duration</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_bb</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_BB</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span>    <span class="c1">//0:RTSDuration_bb, 1:2.4G, 1:CCKData</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_aa</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_AA</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//2:RTSDuration_aa, 1:2.4G, 2,3: 2.4G OFDMData</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_BA</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//1:RTSDuration_ba, 1:2.4G, 2,3:2.4G OFDM Data</span>

            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wDurationID</span> <span class="o">=</span> <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_aa</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Get RTS Frame body</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wFrameControl</span> <span class="o">=</span> <span class="n">TYPE_CTL_RTS</span><span class="p">;</span><span class="c1">//0x00B4</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
		    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			   <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			   <span class="n">ETH_ALEN</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
		    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			   <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			   <span class="n">ETH_ALEN</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
           <span class="n">PSRTS_g_FB</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRTS_g_FB</span><span class="p">)</span><span class="n">pvRTS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uRTSFrameLen</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wLen</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_b</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_b</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_b</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wLen</span><span class="p">);</span>
            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uRTSFrameLen</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wLen</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_a</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_a</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_a</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Get Duration</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_bb</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_BB</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span>    <span class="c1">//0:RTSDuration_bb, 1:2.4G, 1:CCKData</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_aa</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_AA</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//2:RTSDuration_aa, 1:2.4G, 2,3:2.4G OFDMData</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_BA</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//1:RTSDuration_ba, 1:2.4G, 2,3:2.4G OFDMData</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSDuration_ba_f0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_BA_F0</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span>    <span class="c1">//4:wRTSDuration_ba_f0, 1:2.4G, 1:CCKData</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSDuration_aa_f0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_AA_F0</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span>    <span class="c1">//5:wRTSDuration_aa_f0, 1:2.4G, 1:CCKData</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSDuration_ba_f1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_BA_F1</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span>    <span class="c1">//6:wRTSDuration_ba_f1, 1:2.4G, 1:CCKData</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSDuration_aa_f1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_AA_F1</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span>    <span class="c1">//7:wRTSDuration_aa_f1, 1:2.4G, 1:CCKData</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wDurationID</span> <span class="o">=</span> <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_aa</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>Get RTS Frame body</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wFrameControl</span> <span class="o">=</span> <span class="n">TYPE_CTL_RTS</span><span class="p">;</span><span class="c1">//0x00B4</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
            <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
		    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			   <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			   <span class="n">ETH_ALEN</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="c1">// if (byFBOption == AUTO_FB_NONE)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PSRTS_ab</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRTS_ab</span><span class="p">)</span><span class="n">pvRTS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uRTSFrameLen</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wLen</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>Get Duration</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_AA</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//0:RTSDuration_aa, 0:5G, 0: 5G OFDMData</span>
    	    <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wDurationID</span> <span class="o">=</span> <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Get RTS Frame body</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wFrameControl</span> <span class="o">=</span> <span class="n">TYPE_CTL_RTS</span><span class="p">;</span><span class="c1">//0x00B4</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">PSRTS_a_FB</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRTS_a_FB</span><span class="p">)</span><span class="n">pvRTS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uRTSFrameLen</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wLen</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>Get Duration</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_AA</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//0:RTSDuration_aa, 0:5G, 0: 5G OFDMData</span>
    	    <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSDuration_f0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_AA_F0</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//5:RTSDuration_aa_f0, 0:5G, 0: 5G OFDMData</span>
    	    <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSDuration_f1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_AA_F1</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//7:RTSDuration_aa_f1, 0:5G, 0:</span>
    	    <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wDurationID</span> <span class="o">=</span> <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Get RTS Frame body</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wFrameControl</span> <span class="o">=</span> <span class="n">TYPE_CTL_RTS</span><span class="p">;</span><span class="c1">//0x00B4</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PSRTS_ab</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRTS_ab</span><span class="p">)</span><span class="n">pvRTS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>        <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uRTSFrameLen</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
            <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wLen</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Get Duration</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RTSDUR_BB</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//0:RTSDuration_bb, 1:2.4G, 1:CCKData</span>
        <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wDurationID</span> <span class="o">=</span> <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Get RTS Frame body</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wFrameControl</span> <span class="o">=</span> <span class="n">TYPE_CTL_RTS</span><span class="p">;</span><span class="c1">//0x00B4</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyTA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vFillCTSHead</span> <span class="p">(</span>
     <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uDMAIdx</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byPktType</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvCTS</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">cbFrameLength</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bNeedAck</span><span class="p">,</span>
     <span class="n">BOOL</span>     <span class="n">bDisCRC</span><span class="p">,</span>
     <span class="n">WORD</span>     <span class="n">wCurrentRate</span><span class="p">,</span>
     <span class="n">BYTE</span>     <span class="n">byFBOption</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uCTSFrameLen</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
    <span class="n">WORD</span>  <span class="n">wLen</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pvCTS</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bDisCRC</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>When CRCDIS bit is on, H/W forgot to generate FCS for CTS frame,
in this case we need to decrease its length by 4.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">uCTSFrameLen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span> <span class="o">||</span> <span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byFBOption</span> <span class="o">!=</span> <span class="n">AUTO_FB_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">uDMAIdx</span> <span class="o">!=</span> <span class="n">TYPE_ATIMDMA</span> <span class="o">&amp;&amp;</span> <span class="n">uDMAIdx</span> <span class="o">!=</span> <span class="n">TYPE_BEACONDMA</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Auto Fall back</p></td><td class="code"><div class="highlight"><pre>            <span class="n">PSCTS_FB</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSCTS_FB</span><span class="p">)</span><span class="n">pvCTS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uCTSFrameLen</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wLen</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_b</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_b</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_b</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wLen</span><span class="p">);</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">CTSDUR_BA</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//3:CTSDuration_ba, 1:2.4G, 2,3:2.4G OFDM Data</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span> <span class="o">+=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCTSDuration</span><span class="p">;</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Get CTSDuration<em>ba</em>f0</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wCTSDuration_ba_f0</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">CTSDUR_BA_F0</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//8:CTSDuration_ba_f0, 1:2.4G, 2,3:2.4G OFDM Data</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wCTSDuration_ba_f0</span> <span class="o">+=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCTSDuration</span><span class="p">;</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wCTSDuration_ba_f0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wCTSDuration_ba_f0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Get CTSDuration<em>ba</em>f1</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wCTSDuration_ba_f1</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">CTSDUR_BA_F1</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span> <span class="c1">//9:CTSDuration_ba_f1, 1:2.4G, 2,3:2.4G OFDM Data</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wCTSDuration_ba_f1</span> <span class="o">+=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCTSDuration</span><span class="p">;</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wCTSDuration_ba_f1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wCTSDuration_ba_f1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Get CTS Frame body</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wDurationID</span> <span class="o">=</span> <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span><span class="p">;</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wFrameControl</span> <span class="o">=</span> <span class="n">TYPE_CTL_CTS</span><span class="p">;</span><span class="c1">//0x00C4</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wReserved</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	       <span class="n">ETH_ALEN</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//if (byFBOption != AUTO_FB_NONE &amp;&amp; uDMAIdx != TYPE_ATIMDMA &amp;&amp; uDMAIdx != TYPE_BEACONDMA)</span>
            <span class="n">PSCTS</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSCTS</span><span class="p">)</span><span class="n">pvCTS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>            <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uCTSFrameLen</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wLen</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">byServiceField_b</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">bySignalField_b</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTransmitLength_b</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>Get CTSDuration_ba</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">CTSDUR_BA</span><span class="p">,</span> <span class="n">cbFrameLength</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedAck</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">));</span> <span class="c1">//3:CTSDuration_ba, 1:2.4G, 2,3:2.4G OFDM Data</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span> <span class="o">+=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCTSDuration</span><span class="p">;</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>Get CTS Frame body</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wDurationID</span> <span class="o">=</span> <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wDuration_ba</span><span class="p">;</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wFrameControl</span> <span class="o">=</span> <span class="n">TYPE_CTL_CTS</span><span class="p">;</span><span class="c1">//0x00C4</span>
            <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">wReserved</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">abyRA</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	       <span class="n">ETH_ALEN</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Generate FIFO control for MAC &amp; Baseband controller</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice         - Pointer to adpater</span>
<span class="cm"> *      pTxDataHead     - Transmit Data Buffer</span>
<span class="cm"> *      pTxBufHead      - pTxBufHead</span>
<span class="cm"> *      pvRrvTime        - pvRrvTime</span>
<span class="cm"> *      pvRTS            - RTS Buffer</span>
<span class="cm"> *      pCTS            - CTS Buffer</span>
<span class="cm"> *      cbFrameSize     - Transmit Data Length (Hdr+Payload+FCS)</span>
<span class="cm"> *      bNeedACK        - If need ACK</span>
<span class="cm"> *      uDMAIdx         - DMA Index</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">s_vGenerateTxParameter</span> <span class="p">(</span>
     <span class="n">PSDevice</span>         <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">BYTE</span>             <span class="n">byPktType</span><span class="p">,</span>
     <span class="n">WORD</span>             <span class="n">wCurrentRate</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pTxBufHead</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvRrvTime</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvRTS</span><span class="p">,</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">pvCTS</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">cbFrameSize</span><span class="p">,</span>
     <span class="n">BOOL</span>             <span class="n">bNeedACK</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uDMAIdx</span><span class="p">,</span>
     <span class="n">PSEthernetHeader</span> <span class="n">psEthHeader</span>
    <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbMACHdLen</span> <span class="o">=</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span> <span class="cm">/* 24 */</span>
    <span class="n">WORD</span> <span class="n">wFifoCtl</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">bDisCRC</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">BYTE</span> <span class="n">byFBOption</span> <span class="o">=</span> <span class="n">AUTO_FB_NONE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>WORD wCurrentRate = pDevice->wCurrentRate;</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"s_vGenerateTxParameter...\n");</p></td><td class="code"><div class="highlight"><pre>    <span class="n">PSTxBufHead</span> <span class="n">pFifoHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxBufHead</span><span class="p">)</span><span class="n">pTxBufHead</span><span class="p">;</span>
    <span class="n">pFifoHead</span><span class="o">-&gt;</span><span class="n">wReserved</span> <span class="o">=</span> <span class="n">wCurrentRate</span><span class="p">;</span>
    <span class="n">wFifoCtl</span> <span class="o">=</span> <span class="n">pFifoHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wFifoCtl</span> <span class="o">&amp;</span> <span class="n">FIFOCTL_CRCDIS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bDisCRC</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wFifoCtl</span> <span class="o">&amp;</span> <span class="n">FIFOCTL_AUTO_FB_0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byFBOption</span> <span class="o">=</span> <span class="n">AUTO_FB_0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wFifoCtl</span> <span class="o">&amp;</span> <span class="n">FIFOCTL_AUTO_FB_1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byFBOption</span> <span class="o">=</span> <span class="n">AUTO_FB_1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLongHeader</span><span class="p">)</span>
        <span class="n">cbMACHdLen</span> <span class="o">=</span> <span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span> <span class="o">||</span> <span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pvRTS</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//RTS_need</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Fill RsvTime</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pvRrvTime</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PSRrvTime_gRTS</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_gRTS</span><span class="p">)</span><span class="n">pvRrvTime</span><span class="p">;</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSTxRrvTime_aa</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">));</span><span class="c1">//2:RTSTxRrvTime_aa, 1:2.4GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSTxRrvTime_ba</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">));</span><span class="c1">//1:RTSTxRrvTime_ba, 1:2.4GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSTxRrvTime_bb</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">));</span><span class="c1">//0:RTSTxRrvTime_bb, 1:2.4GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTxRrvTime_a</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">));</span><span class="c1">//2.4G OFDM</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTxRrvTime_b</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span> <span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">));</span><span class="c1">//1:CCK</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Fill RTS</p></td><td class="code"><div class="highlight"><pre>            <span class="n">s_vFillRTSHead</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">pvRTS</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span> <span class="n">bDisCRC</span><span class="p">,</span> <span class="n">psEthHeader</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span><span class="c1">//RTS_needless, PCF mode</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Fill RsvTime</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pvRrvTime</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PSRrvTime_gCTS</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_gCTS</span><span class="p">)</span><span class="n">pvRrvTime</span><span class="p">;</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTxRrvTime_a</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">));</span><span class="c1">//2.4G OFDM</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTxRrvTime_b</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">));</span><span class="c1">//1:CCK</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wCTSTxRrvTime_ba</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">));</span><span class="c1">//3:CTSTxRrvTime_Ba, 1:2.4GHz</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Fill CTS</p></td><td class="code"><div class="highlight"><pre>            <span class="n">s_vFillCTSHead</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uDMAIdx</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">pvCTS</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span> <span class="n">bDisCRC</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pvRTS</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span><span class="c1">//RTS_need, non PCF mode</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>Fill RsvTime</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pvRrvTime</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PSRrvTime_ab</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span><span class="n">pvRrvTime</span><span class="p">;</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSTxRrvTime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">));</span><span class="c1">//2:RTSTxRrvTime_aa, 0:5GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTxRrvTime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">));</span><span class="c1">//0:OFDM</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Fill RTS</p></td><td class="code"><div class="highlight"><pre>            <span class="n">s_vFillRTSHead</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">pvRTS</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span> <span class="n">bDisCRC</span><span class="p">,</span> <span class="n">psEthHeader</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pvRTS</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span><span class="c1">//RTS_needless, non PCF mode</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>Fill RsvTime</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pvRrvTime</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PSRrvTime_ab</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span><span class="n">pvRrvTime</span><span class="p">;</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTxRrvTime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">PK_TYPE_11A</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">));</span> <span class="c1">//0:OFDM</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pvRTS</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span><span class="c1">//RTS_need, non PCF mode</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>Fill RsvTime</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pvRrvTime</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PSRrvTime_ab</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span><span class="n">pvRrvTime</span><span class="p">;</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wRTSTxRrvTime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetRTSCTSRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">));</span><span class="c1">//0:RTSTxRrvTime_bb, 1:2.4GHz</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTxRrvTime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">));</span><span class="c1">//1:CCK</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>Fill RTS</p></td><td class="code"><div class="highlight"><pre>            <span class="n">s_vFillRTSHead</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">pvRTS</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span> <span class="n">bDisCRC</span><span class="p">,</span> <span class="n">psEthHeader</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span> <span class="c1">//RTS_needless, non PCF mode</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>Fill RsvTime</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pvRrvTime</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PSRrvTime_ab</span> <span class="n">pBuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span><span class="n">pvRrvTime</span><span class="p">;</span>
                <span class="n">pBuf</span><span class="o">-&gt;</span><span class="n">wTxRrvTime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetTxRsvTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">));</span> <span class="c1">//1:CCK</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"s_vGenerateTxParameter END.\n");</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">    PBYTE pbyBuffer,//point to pTxBufHead</span>
<span class="cm">    WORD  wFragType,//00:Non-Frag, 01:Start, 02:Mid, 03:Last</span>
<span class="cm">    unsigned int  cbFragmentSize,//Hdr+payoad+FCS</span>
<span class="cm">*/</span>


<span class="n">BOOL</span>
<span class="nf">s_bPacketToWirelessUsb</span><span class="p">(</span>
      <span class="n">PSDevice</span>         <span class="n">pDevice</span><span class="p">,</span>
      <span class="n">BYTE</span>             <span class="n">byPktType</span><span class="p">,</span>
      <span class="n">PBYTE</span>            <span class="n">usbPacketBuf</span><span class="p">,</span>
      <span class="n">BOOL</span>             <span class="n">bNeedEncryption</span><span class="p">,</span>
      <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uSkbPacketLen</span><span class="p">,</span>
      <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uDMAIdx</span><span class="p">,</span>
      <span class="n">PSEthernetHeader</span> <span class="n">psEthHeader</span><span class="p">,</span>
      <span class="n">PBYTE</span>            <span class="n">pPacket</span><span class="p">,</span>
      <span class="n">PSKeyItem</span>        <span class="n">pTransmitKey</span><span class="p">,</span>
      <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uNodeIndex</span><span class="p">,</span>
      <span class="n">WORD</span>             <span class="n">wCurrentRate</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="o">*</span><span class="n">pcbHeaderLen</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="o">*</span><span class="n">pcbTotalLen</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">cbFrameBodySize</span><span class="p">;</span>
    <span class="n">PTX_BUFFER</span>          <span class="n">pTxBufHead</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cb802_1_H_len</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cbMIClen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">cbMACHdLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cbFCSlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbMICHDR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BOOL</span>                <span class="n">bNeedACK</span><span class="p">,</span><span class="n">bRTS</span><span class="p">;</span>
    <span class="n">PBYTE</span>               <span class="n">pbyType</span><span class="p">,</span><span class="n">pbyMacHdr</span><span class="p">,</span><span class="n">pbyIVHead</span><span class="p">,</span><span class="n">pbyPayloadHead</span><span class="p">,</span><span class="n">pbyTxBufferAddr</span><span class="p">;</span>
    <span class="n">BYTE</span> <span class="n">abySNAP_RFC1042</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
    <span class="n">BYTE</span> <span class="n">abySNAP_Bridgetunnel</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uDuration</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbHeaderLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uPadding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvRrvTime</span><span class="p">;</span>
    <span class="n">PSMICHDRHead</span>        <span class="n">pMICHDR</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvRTS</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvCTS</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvTxDataHd</span><span class="p">;</span>
    <span class="n">BYTE</span>                <span class="n">byFBOption</span> <span class="o">=</span> <span class="n">AUTO_FB_NONE</span><span class="p">,</span><span class="n">byFragType</span><span class="p">;</span>
    <span class="n">WORD</span>                <span class="n">wTxBufSize</span><span class="p">;</span>
    <span class="n">DWORD</span>               <span class="n">dwMICKey0</span><span class="p">,</span><span class="n">dwMICKey1</span><span class="p">,</span><span class="n">dwMIC_Priority</span><span class="p">,</span><span class="n">dwCRC</span><span class="p">;</span>
    <span class="n">PDWORD</span>              <span class="n">pdwMIC_L</span><span class="p">,</span><span class="n">pdwMIC_R</span><span class="p">;</span>
    <span class="n">BOOL</span>                <span class="n">bSoftWEP</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>




    <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="n">pMICHDR</span> <span class="o">=</span> <span class="n">pvRTS</span> <span class="o">=</span> <span class="n">pvCTS</span> <span class="o">=</span> <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">bNeedEncryption</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>  <span class="p">{</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">PSKeyTable</span><span class="p">)</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">pvKeyTable</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">bSoftWEP</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>WEP 256</p></td><td class="code"><div class="highlight"><pre>            <span class="n">bSoftWEP</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pTxBufHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTX_BUFFER</span><span class="p">)</span> <span class="n">usbPacketBuf</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxBufHead</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TX_BUFFER</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>Get pkt type</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">wType</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwDiagRefCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cb802_1_H_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">cb802_1_H_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cb802_1_H_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">cbFrameBodySize</span> <span class="o">=</span> <span class="n">uSkbPacketLen</span> <span class="o">-</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">cb802_1_H_len</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>Set packet type</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)(</span><span class="n">byPktType</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwDiagRefCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bNeedACK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">=</span> <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">FIFOCTL_NEEDACK</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//if (pDevice-&gt;dwDiagRefCount != 0) {</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bNeedACK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">=</span>
				<span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">FIFOCTL_NEEDACK</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bNeedACK</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_NEEDACK</span><span class="p">;</span>
		<span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>MSDUs in Infra mode always need ACK</p></td><td class="code"><div class="highlight"><pre>            <span class="n">bNeedACK</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_NEEDACK</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="c1">//if (pDevice-&gt;dwDiagRefCount != 0) {</span>

    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wTimeStamp</span> <span class="o">=</span> <span class="n">DEFAULT_MSDU_LIFETIME_RES_64us</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Set FIFOCTL_LHEAD</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLongHeader</span><span class="p">)</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_LHEAD</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bSoftwareGenCrcErr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_CRCDIS</span><span class="p">;</span> <span class="c1">// set tx descriptors to NO hardware CRC</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>Set FRAGCTL_MACHDCNT</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLongHeader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cbMACHdLen</span> <span class="o">=</span> <span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cbMACHdLen</span> <span class="o">=</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)(</span><span class="n">cbMACHdLen</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>Set FIFOCTL_GrpAckPolicy</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bGrpAckPolicy</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0100 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span>	<span class="n">FIFOCTL_GRPACK</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>Set Auto Fallback Ctl</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">wCurrentRate</span> <span class="o">&gt;=</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAutoFBCtrl</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_AUTO_FB_0</span><span class="p">;</span>
            <span class="n">byFBOption</span> <span class="o">=</span> <span class="n">AUTO_FB_0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAutoFBCtrl</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_AUTO_FB_1</span><span class="p">;</span>
            <span class="n">byFBOption</span> <span class="o">=</span> <span class="n">AUTO_FB_1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bSoftWEP</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">bNeedEncryption</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>  <span class="p">{</span> <span class="c1">//WEP enabled</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//WEP40 or WEP104</span>
                <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">FRAGCTL_LEGACY</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Tx Set wFragCtl == FRAGCTL_TKIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">FRAGCTL_TKIP</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//CCMP</span>
                <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">FRAGCTL_AES</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">((</span><span class="n">bNeedEncryption</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>  <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_WEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//IV+ExtIV</span>
            <span class="n">cbMIClen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_CCMP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//RSN Header</span>
            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//MIC</span>
            <span class="n">cbMICHDR</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SMICHDRHead</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bSoftWEP</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>MAC Header should be padding 0 to DW alignment.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">uPadding</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">cbMACHdLen</span><span class="o">%</span><span class="mi">4</span><span class="p">);</span>
            <span class="n">uPadding</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">cbFrameSize</span> <span class="o">=</span> <span class="n">cbMACHdLen</span> <span class="o">+</span> <span class="n">cbIVlen</span> <span class="o">+</span> <span class="p">(</span><span class="n">cbFrameBodySize</span> <span class="o">+</span> <span class="n">cbMIClen</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbICVlen</span> <span class="o">+</span> <span class="n">cbFCSlen</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">bNeedACK</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="o">||</span><span class="p">(</span><span class="n">cbFrameSize</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wRTSThreshold</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">bRTS</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">bRTS</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FIFOCTL_RTS</span> <span class="o">|</span> <span class="n">FIFOCTL_LRETRY</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pbyTxBufferAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">adwTxKey</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">wTxBufSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxBufHead</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span> <span class="o">||</span> <span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span><span class="c1">//802.11g packet</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bRTS</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//RTS_need</span>
                <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_gRTS</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
                <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gRTS</span><span class="p">));</span>
                <span class="n">pvRTS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRTS_g</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gRTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
                <span class="n">pvCTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_g</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gRTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRTS_g</span><span class="p">));</span>
                <span class="n">cbHeaderLength</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gRTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRTS_g</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_g</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span> <span class="c1">//RTS_needless</span>
                <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_gCTS</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
                <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">));</span>
                <span class="n">pvRTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvCTS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSCTS</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
                <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_g</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCTS</span><span class="p">));</span>
                <span class="n">cbHeaderLength</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCTS</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_g</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>Auto Fall Back</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">bRTS</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//RTS_need</span>
                <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_gRTS</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
                <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gRTS</span><span class="p">));</span>
                <span class="n">pvRTS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRTS_g_FB</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gRTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
                <span class="n">pvCTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_g_FB</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gRTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRTS_g_FB</span><span class="p">));</span>
                <span class="n">cbHeaderLength</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gRTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRTS_g_FB</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_g_FB</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bRTS</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//RTS_needless</span>
                <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_gCTS</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
                <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">));</span>
                <span class="n">pvRTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvCTS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSCTS_FB</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
                <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_g_FB</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCTS_FB</span><span class="p">));</span>
                <span class="n">cbHeaderLength</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCTS_FB</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_g_FB</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="c1">// Auto Fall Back</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span><span class="c1">//802.11a/b packet</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byFBOption</span> <span class="o">==</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bRTS</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//RTS_need</span>
                <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
                <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">));</span>
                <span class="n">pvRTS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRTS_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
                <span class="n">pvCTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRTS_ab</span><span class="p">));</span>
                <span class="n">cbHeaderLength</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRTS_ab</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_ab</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bRTS</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//RTS_needless, no MICHDR</span>
                <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
                <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">));</span>
                <span class="n">pvRTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvCTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
                <span class="n">cbHeaderLength</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_ab</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>Auto Fall Back</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">bRTS</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//RTS_need</span>
                <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
                <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">));</span>
                <span class="n">pvRTS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRTS_a_FB</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
                <span class="n">pvCTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_a_FB</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRTS_a_FB</span><span class="p">));</span>
                <span class="n">cbHeaderLength</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRTS_a_FB</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_a_FB</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bRTS</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//RTS_needless</span>
                <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
                <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">));</span>
                <span class="n">pvRTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvCTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_a_FB</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
                <span class="n">cbHeaderLength</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_a_FB</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="c1">// Auto Fall Back</span>
    <span class="p">}</span>

    <span class="n">pbyMacHdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderLength</span><span class="p">);</span>
    <span class="n">pbyIVHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pbyMacHdr</span> <span class="o">+</span> <span class="n">cbMACHdLen</span> <span class="o">+</span> <span class="n">uPadding</span><span class="p">);</span>
    <span class="n">pbyPayloadHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pbyMacHdr</span> <span class="o">+</span> <span class="n">cbMACHdLen</span> <span class="o">+</span> <span class="n">uPadding</span> <span class="o">+</span> <span class="n">cbIVlen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>=========================</p>

<h1>   No Fragmentation</h1></td><td class="code"><div class="highlight"><pre>    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;No Fragmentation...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">byFragType</span> <span class="o">=</span> <span class="n">FRAGCTL_NONFRAG</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>uDMAIdx = TYPE_AC0DMA;
pTxBufHead = (PSTxBufHead) &amp;(pTxBufHead->adwTxKey[0]);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>Fill FIFO,RrvTime,RTS,and CTS</p></td><td class="code"><div class="highlight"><pre>    <span class="n">s_vGenerateTxParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pbyTxBufferAddr</span><span class="p">,</span> <span class="n">pvRrvTime</span><span class="p">,</span> <span class="n">pvRTS</span><span class="p">,</span> <span class="n">pvCTS</span><span class="p">,</span>
                               <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span> <span class="n">uDMAIdx</span><span class="p">,</span> <span class="n">psEthHeader</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>Fill DataHead</p></td><td class="code"><div class="highlight"><pre>    <span class="n">uDuration</span> <span class="o">=</span> <span class="n">s_uFillDataHead</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">pvTxDataHd</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">uDMAIdx</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span>
                                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="cm">/*uMACfragNum*/</span><span class="p">,</span> <span class="n">byFBOption</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>Generate TX MAC Header</p></td><td class="code"><div class="highlight"><pre>    <span class="n">s_vGenerateMACHeader</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pbyMacHdr</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">uDuration</span><span class="p">,</span> <span class="n">psEthHeader</span><span class="p">,</span> <span class="n">bNeedEncryption</span><span class="p">,</span>
                           <span class="n">byFragType</span><span class="p">,</span> <span class="n">uDMAIdx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bNeedEncryption</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>Fill TXKEY</p></td><td class="code"><div class="highlight"><pre>        <span class="n">s_vFillTxKey</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">adwTxKey</span><span class="p">),</span> <span class="n">pbyIVHead</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span>
                         <span class="n">pbyMacHdr</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbFrameBodySize</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pMICHDR</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwTSC47_16</span> <span class="o">=</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="p">;</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTSC15_0</span> <span class="o">=</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>802.1H</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">wType</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwDiagRefCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">wType</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ETH_P_IPX</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">wType</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xF380</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyPayloadHead</span><span class="p">),</span>
			       <span class="n">abySNAP_Bridgetunnel</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">memcpy</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyPayloadHead</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">abySNAP_RFC1042</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">pbyType</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyPayloadHead</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyType</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">wType</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WORD</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">memcpy</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyPayloadHead</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">wType</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WORD</span><span class="p">));</span>

        <span class="p">}</span>

    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pPacket</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>Copy the Packet into a tx Buffer</p></td><td class="code"><div class="highlight"><pre>        <span class="n">memcpy</span><span class="p">((</span><span class="n">pbyPayloadHead</span> <span class="o">+</span> <span class="n">cb802_1_H_len</span><span class="p">),</span>
                 <span class="p">(</span><span class="n">pPacket</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">),</span>
                 <span class="n">uSkbPacketLen</span> <span class="o">-</span> <span class="n">ETH_HLEN</span>
                 <span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>while bRelayPacketSend psEthHeader is point to header+payload</p></td><td class="code"><div class="highlight"><pre>        <span class="n">memcpy</span><span class="p">((</span><span class="n">pbyPayloadHead</span> <span class="o">+</span> <span class="n">cb802_1_H_len</span><span class="p">),</span> <span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">psEthHeader</span><span class="p">)</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span> <span class="n">uSkbPacketLen</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">uLength</span> <span class="o">==</span> <span class="n">cbNdisBodySize</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">bNeedEncryption</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>/////////////////////////////////////////////////////////////////</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">.</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dwMICKey0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
            <span class="n">dwMICKey1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span> <span class="o">&amp;</span> <span class="n">AUTHENTICATOR_KEY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dwMICKey0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
            <span class="n">dwMICKey1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">dwMICKey0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">24</span><span class="p">]);</span>
            <span class="n">dwMICKey1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">28</span><span class="p">]);</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>DO Software Michael</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MIC_vInit</span><span class="p">(</span><span class="n">dwMICKey0</span><span class="p">,</span> <span class="n">dwMICKey1</span><span class="p">);</span>
        <span class="n">MIC_vAppend</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">12</span><span class="p">);</span>
        <span class="n">dwMIC_Priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">MIC_vAppend</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dwMIC_Priority</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;MIC KEY: %lX, %lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dwMICKey0</span><span class="p">,</span> <span class="n">dwMICKey1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>/////////////////////////////////////////////////////////////////</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>DBG<em>PRN</em>GRP12(("Length:%d, %d\n", cbFrameBodySize, uFromHDtoPLDLength));
for (ii = 0; ii &lt; cbFrameBodySize; ii++) {
   DBG<em>PRN</em>GRP12(("%02x ", *((PBYTE)((pbyPayloadHead + cb802<em>1</em>H<em>len) + ii))));
}
DBG</em>PRN_GRP12(("\n\n\n"));</p></td><td class="code"><div class="highlight"><pre>        <span class="n">MIC_vAppend</span><span class="p">(</span><span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="n">cbFrameBodySize</span><span class="p">);</span>

        <span class="n">pdwMIC_L</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">pbyPayloadHead</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span><span class="p">);</span>
        <span class="n">pdwMIC_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">pbyPayloadHead</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

        <span class="n">MIC_vGetMIC</span><span class="p">(</span><span class="n">pdwMIC_L</span><span class="p">,</span> <span class="n">pdwMIC_R</span><span class="p">);</span>
        <span class="n">MIC_vUnInit</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxMICFail</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pdwMIC_L</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="o">*</span><span class="n">pdwMIC_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxMICFail</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"uLength: %d, %d\n", uLength, cbFrameBodySize);
DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"cbReqCount:%d, %d, %d, %d\n", cbReqCount, cbHeaderLength, uPadding, cbIVlen);
DBG<em>PRT(MSG</em>LEVEL<em>DEBUG, KERN</em>INFO"MIC:%lX, %lX\n", *pdwMIC<em>L, *pdwMIC</em>R);</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">bSoftWEP</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">s_vSWencryption</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span> <span class="p">(</span><span class="n">pbyPayloadHead</span><span class="p">),</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)(</span><span class="n">cbFrameBodySize</span> <span class="o">+</span> <span class="n">cbMIClen</span><span class="p">));</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>  <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bNeedEncryption</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span>  <span class="o">||</span>
          <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bNeedEncryption</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span>   <span class="o">||</span>
          <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bNeedEncryption</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span>      <span class="p">)</span> <span class="p">{</span>
        <span class="n">cbFrameSize</span> <span class="o">-=</span> <span class="n">cbICVlen</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bSoftwareGenCrcErr</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbLen</span><span class="p">;</span>
        <span class="n">PDWORD</span> <span class="n">pdwCRC</span><span class="p">;</span>

        <span class="n">dwCRC</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFL</span><span class="p">;</span>
        <span class="n">cbLen</span> <span class="o">=</span> <span class="n">cbFrameSize</span> <span class="o">-</span> <span class="n">cbFCSlen</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>calculate CRC, and wrtie CRC value to end of TD</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dwCRC</span> <span class="o">=</span> <span class="n">CRCdwGetCrc32Ex</span><span class="p">(</span><span class="n">pbyMacHdr</span><span class="p">,</span> <span class="n">cbLen</span><span class="p">,</span> <span class="n">dwCRC</span><span class="p">);</span>
        <span class="n">pdwCRC</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">pbyMacHdr</span> <span class="o">+</span> <span class="n">cbLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>finally, we must invert dwCRC to get the correct answer</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pdwCRC</span> <span class="o">=</span> <span class="o">~</span><span class="n">dwCRC</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>Force Error</p></td><td class="code"><div class="highlight"><pre>        <span class="o">*</span><span class="n">pdwCRC</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cbFrameSize</span> <span class="o">-=</span> <span class="n">cbFCSlen</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">pcbHeaderLen</span> <span class="o">=</span> <span class="n">cbHeaderLength</span><span class="p">;</span>
    <span class="o">*</span><span class="n">pcbTotalLen</span> <span class="o">=</span> <span class="n">cbHeaderLength</span> <span class="o">+</span> <span class="n">cbFrameSize</span> <span class="p">;</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>Set FragCtl in TxBufferHead</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">byFragType</span><span class="p">;</span>


    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Translate 802.3 to 802.11 header</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice         - Pointer to adpater</span>
<span class="cm"> *      dwTxBufferAddr  - Transmit Buffer</span>
<span class="cm"> *      pPacket         - Packet from upper layer</span>
<span class="cm"> *      cbPacketSize    - Transmit Data Length</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      pcbHeadSize         - Header size of MAC&amp;Baseband control and 802.11 Header</span>
<span class="cm"> *      pcbAppendPayload    - size of append payload for 802.1H translation</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: none</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span>
<span class="nf">s_vGenerateMACHeader</span> <span class="p">(</span>
     <span class="n">PSDevice</span>         <span class="n">pDevice</span><span class="p">,</span>
     <span class="n">PBYTE</span>            <span class="n">pbyBufferAddr</span><span class="p">,</span>
     <span class="n">WORD</span>             <span class="n">wDuration</span><span class="p">,</span>
     <span class="n">PSEthernetHeader</span> <span class="n">psEthHeader</span><span class="p">,</span>
     <span class="n">BOOL</span>             <span class="n">bNeedEncrypt</span><span class="p">,</span>
     <span class="n">WORD</span>             <span class="n">wFragType</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uDMAIdx</span><span class="p">,</span>
     <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uFragIdx</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PS802_11Header</span>  <span class="n">pMACHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span><span class="n">pbyBufferAddr</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">pMACHeader</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">S802_11Header</span><span class="p">)));</span>  <span class="c1">//- sizeof(pMACHeader-&gt;dwIV)));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">uDMAIdx</span> <span class="o">==</span> <span class="n">TYPE_ATIMDMA</span><span class="p">)</span> <span class="p">{</span>
    	<span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">TYPE_802_11_ATIM</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">=</span> <span class="n">TYPE_802_11_DATA</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_AP</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	       <span class="n">ETH_ALEN</span><span class="p">);</span>
        <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">|=</span> <span class="n">FC_FROMDS</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">psEthHeader</span><span class="o">-&gt;</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
            <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">|=</span> <span class="n">FC_TODS</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bNeedEncrypt</span><span class="p">)</span>
        <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">WLAN_SET_FC_ISWEP</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

    <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wDurationID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wDuration</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLongHeader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PWLAN_80211HDR_A4</span> <span class="n">pMACA4Header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_80211HDR_A4</span><span class="p">)</span> <span class="n">pbyBufferAddr</span><span class="p">;</span>
        <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FC_TODS</span> <span class="o">|</span> <span class="n">FC_FROMDS</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMACA4Header</span><span class="o">-&gt;</span><span class="n">abyAddr4</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wSeqCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>Set FragNumber in Sequence Control</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wSeqCtl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">uFragIdx</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">wFragType</span> <span class="o">==</span> <span class="n">FRAGCTL_ENDFRAG</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">wFragType</span> <span class="o">==</span> <span class="n">FRAGCTL_NONFRAG</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">&gt;</span> <span class="mh">0x0fff</span><span class="p">)</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">wFragType</span> <span class="o">==</span> <span class="n">FRAGCTL_STAFRAG</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">wFragType</span> <span class="o">==</span> <span class="n">FRAGCTL_MIDFRAG</span><span class="p">))</span> <span class="p">{</span> <span class="c1">//StartFrag or MidFrag</span>
        <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">|=</span> <span class="n">FC_MOREFRAG</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Request instructs a MAC to transmit a 802.11 management packet through</span>
<span class="cm"> *      the adapter onto the medium.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      hDeviceContext  - Pointer to the adapter</span>
<span class="cm"> *      pPacket         - A pointer to a descriptor for the packet to transmit</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: CMD_STATUS_PENDING if MAC Tx resource available; otherwise FALSE</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="n">CMD_STATUS</span> <span class="nf">csMgmt_xmit</span><span class="p">(</span>
      <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
      <span class="n">PSTxMgmtPacket</span> <span class="n">pPacket</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">BYTE</span>            <span class="n">byPktType</span><span class="p">;</span>
    <span class="n">PBYTE</span>           <span class="n">pbyTxBufferAddr</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvRTS</span><span class="p">;</span>
    <span class="n">PSCTS</span>           <span class="n">pCTS</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvTxDataHd</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uDuration</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbReqCount</span><span class="p">;</span>
    <span class="n">PS802_11Header</span>  <span class="n">pMACHeader</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbHeaderSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbFrameBodySize</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bNeedACK</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bIsPSPOLL</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PSTxBufHead</span>     <span class="n">pTxBufHead</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbFrameSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbMIClen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbFCSlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uPadding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">WORD</span>            <span class="n">wTxBufSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbMacHdLen</span><span class="p">;</span>
    <span class="n">SEthernetHeader</span> <span class="n">sEthHeader</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvRrvTime</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pMICHDR</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">WORD</span>            <span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
    <span class="n">PTX_BUFFER</span>          <span class="n">pTX_Buffer</span><span class="p">;</span>
    <span class="n">PUSB_SEND_CONTEXT</span>   <span class="n">pContext</span><span class="p">;</span>



    <span class="n">pContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUSB_SEND_CONTEXT</span><span class="p">)</span><span class="n">s_vGetFreeContext</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ManagementSend TX...NO CONTEXT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">CMD_STATUS_RESOURCES</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pTX_Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTX_BUFFER</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">pbyTxBufferAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">adwTxKey</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">cbFrameBodySize</span> <span class="o">=</span> <span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span><span class="p">;</span>
    <span class="n">pTxBufHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxBufHead</span><span class="p">)</span> <span class="n">pbyTxBufferAddr</span><span class="p">;</span>
    <span class="n">wTxBufSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxBufHead</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxBufHead</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wTxBufSize</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11A</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11B</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>SetPower will cause error power TX state for OFDM Date packet in TX buffer.
2004.11.11 Kyle -- Using OFDM power to tx MngPkt will decrease the connection capability.
                   And cmd timer will wait data pkt TX finish before scanning so it's OK
                   to set power here.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanState</span> <span class="o">!=</span> <span class="n">WMAC_NO_SCANNING</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RFbSetPower</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurrentCh</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">RFbSetPower</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">wCurrentRate</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>Set packet type</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11A</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0000 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11B</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0001 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_11B</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0010 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_11GB</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0011 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_11GA</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_TMOEN</span><span class="p">;</span>
    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wTimeStamp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">DEFAULT_MGN_LIFETIME_RES_64us</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">bNeedACK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">bNeedACK</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_NEEDACK</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_LRETRY</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>Set Preamble type always long
pDevice->byPreambleType = PREAMBLE<em>LONG;
probe-response don't retry
if ((pPacket->p80211Header->sA4.wFrameCtl &amp; TYPE</em>SUBTYPE<em>MASK) == TYPE</em>MGMT<em>PROBE</em>RSP) {
    bNeedACK = FALSE;
    pTxBufHead->wFIFOCtl  &amp;= (~FIFOCTL_NEEDACK);
}</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>

    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FIFOCTL_GENINT</span> <span class="o">|</span> <span class="n">FIFOCTL_ISDMA0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">&amp;</span> <span class="n">TYPE_SUBTYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_CTL_PSPOLL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bIsPSPOLL</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">cbMacHdLen</span> <span class="o">=</span> <span class="n">WLAN_HDR_ADDR2_LEN</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cbMacHdLen</span> <span class="o">=</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>Set FRAGCTL_MACHDCNT</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)(</span><span class="n">cbMacHdLen</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>Notes:
Although spec says MMPDU can be fragmented; In most case,
no one will send a MMPDU under fragmentation. With RTS may occur.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bAES</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>  <span class="c1">//Set FRAGCTL_WEPTYP</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_FC_ISWEP</span><span class="p">(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    	    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">FRAGCTL_LEGACY</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//IV+ExtIV</span>
            <span class="n">cbMIClen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    	    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">FRAGCTL_TKIP</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>We need to get seed here for filling TxKey entry.
TKIPvMixKey(pTransmitKey->abyKey, pDevice->abyCurrentNetAddr,
           pTransmitKey->wTSC15<em>0, pTransmitKey->dwTSC47</em>16, pDevice->abyPRNG);</p></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//RSN Header</span>
            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//MIC</span>
            <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">FRAGCTL_AES</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bAES</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>MAC Header should be padding 0 to DW alignment.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">uPadding</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">cbMacHdLen</span><span class="o">%</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">uPadding</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">cbFrameSize</span> <span class="o">=</span> <span class="n">cbMacHdLen</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span> <span class="o">+</span> <span class="n">cbIVlen</span> <span class="o">+</span> <span class="n">cbMIClen</span> <span class="o">+</span> <span class="n">cbICVlen</span> <span class="o">+</span> <span class="n">cbFCSlen</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>Set FIFOCTL_GrpAckPolicy</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bGrpAckPolicy</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0100 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span>	<span class="n">FIFOCTL_GRPACK</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>the rest of pTxBufHead->wFragCtl:FragTyp will be set later in s_vFillFragParameter()</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>Set RrvTime/RTS/CTS Buffer</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span> <span class="o">||</span> <span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span><span class="c1">//802.11g packet</span>

        <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_gCTS</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
        <span class="n">pMICHDR</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">pvRTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">pCTS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSCTS</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">));</span>
        <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_g</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCTS</span><span class="p">));</span>
        <span class="n">cbHeaderSize</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCTS</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_g</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span> <span class="c1">// 802.11a/b packet</span>
        <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
        <span class="n">pMICHDR</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">pvRTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">pCTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">));</span>
        <span class="n">cbHeaderSize</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_ab</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">cbHeaderSize</span> <span class="o">-</span> <span class="n">wTxBufSize</span><span class="p">));</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	   <span class="o">&amp;</span><span class="p">(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	   <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sEthHeader</span><span class="p">.</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	   <span class="o">&amp;</span><span class="p">(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	   <span class="n">ETH_ALEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>=========================</p>

<h1>   No Fragmentation</h1></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">FRAGCTL_NONFRAG</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>Fill FIFO,RrvTime,RTS,and CTS</p></td><td class="code"><div class="highlight"><pre>    <span class="n">s_vGenerateTxParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span>  <span class="n">pbyTxBufferAddr</span><span class="p">,</span> <span class="n">pvRrvTime</span><span class="p">,</span> <span class="n">pvRTS</span><span class="p">,</span> <span class="n">pCTS</span><span class="p">,</span>
                           <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span> <span class="n">TYPE_TXDMA0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sEthHeader</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>Fill DataHead</p></td><td class="code"><div class="highlight"><pre>    <span class="n">uDuration</span> <span class="o">=</span> <span class="n">s_uFillDataHead</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">pvTxDataHd</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">TYPE_TXDMA0</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span>
                                <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AUTO_FB_NONE</span><span class="p">);</span>

    <span class="n">pMACHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>

    <span class="n">cbReqCount</span> <span class="o">=</span> <span class="n">cbHeaderSize</span> <span class="o">+</span> <span class="n">cbMacHdLen</span> <span class="o">+</span> <span class="n">uPadding</span> <span class="o">+</span> <span class="n">cbIVlen</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_FC_ISWEP</span><span class="p">(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PBYTE</span>           <span class="n">pbyIVHead</span><span class="p">;</span>
        <span class="n">PBYTE</span>           <span class="n">pbyPayloadHead</span><span class="p">;</span>
        <span class="n">PBYTE</span>           <span class="n">pbyBSSID</span><span class="p">;</span>
        <span class="n">PSKeyItem</span>       <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="n">pbyIVHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span> <span class="o">+</span> <span class="n">cbMacHdLen</span> <span class="o">+</span> <span class="n">uPadding</span><span class="p">);</span>
        <span class="n">pbyPayloadHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span> <span class="o">+</span> <span class="n">cbMacHdLen</span> <span class="o">+</span> <span class="n">uPadding</span> <span class="o">+</span> <span class="n">cbIVlen</span><span class="p">);</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_INFRASTRUCTURE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>get pairwise key</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">PAIRWISE_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>get group key</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">GROUP_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Get GTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Get PTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>get group key</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">GROUP_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;KEY is NULL. OP Mode[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Get GTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>Fill TXKEY</p></td><td class="code"><div class="highlight"><pre>        <span class="n">s_vFillTxKey</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">adwTxKey</span><span class="p">),</span> <span class="n">pbyIVHead</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pMACHeader</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbFrameBodySize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMACHeader</span><span class="p">,</span> <span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">,</span> <span class="n">cbMacHdLen</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMacHdLen</span><span class="p">),</span>
                 <span class="n">cbFrameBodySize</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>Copy the Packet into a tx Buffer</p></td><td class="code"><div class="highlight"><pre>        <span class="n">memcpy</span><span class="p">(</span><span class="n">pMACHeader</span><span class="p">,</span> <span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">,</span> <span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wSeqCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span><span class="o">++</span> <span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">&gt;</span> <span class="mh">0x0fff</span><span class="p">)</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bIsPSPOLL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>The MAC will automatically replace the Duration-field of MAC header by Duration-field
of  FIFO control header.
This will cause AID-field of PS-POLL packet be incorrect (Because PS-POLL's AID field is
in the same place of other packet's Duration-field).
And it will cause Cisco-AP to issue Disassociation-packet</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span> <span class="o">||</span> <span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">((</span><span class="n">PSTxDataHead_g</span><span class="p">)</span><span class="n">pvTxDataHd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wDuration_a</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA2</span><span class="p">.</span><span class="n">wDurationID</span><span class="p">);</span>
            <span class="p">((</span><span class="n">PSTxDataHead_g</span><span class="p">)</span><span class="n">pvTxDataHd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wDuration_b</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA2</span><span class="p">.</span><span class="n">wDurationID</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="p">((</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span><span class="n">pvTxDataHd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA2</span><span class="p">.</span><span class="n">wDurationID</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wTxByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)(</span><span class="n">cbReqCount</span><span class="p">));</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(((</span><span class="n">wCurrentRate</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span><span class="mh">0x00F0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">));</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byType</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">CONTEXT_MGMT_PACKET</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">uBufLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbReqCount</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>  <span class="c1">//USB header</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_FC_TODS</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s_vSaveTxPktInfo</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbFrameSize</span><span class="p">,</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">s_vSaveTxPktInfo</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]),(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbFrameSize</span><span class="p">,</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">PIPEnsSendBulkOut</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pContext</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">CMD_STATUS</span>
<span class="nf">csBeacon_xmit</span><span class="p">(</span>
      <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
      <span class="n">PSTxMgmtPacket</span> <span class="n">pPacket</span>
    <span class="p">)</span>
<span class="p">{</span>

    <span class="kt">unsigned</span> <span class="kt">int</span>                <span class="n">cbFrameSize</span> <span class="o">=</span> <span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span> <span class="o">+</span> <span class="n">WLAN_FCS_LEN</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>                <span class="n">cbHeaderSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">WORD</span>                <span class="n">wTxBufSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxShortBufHead</span><span class="p">);</span>
    <span class="n">PSTxShortBufHead</span>    <span class="n">pTxBufHead</span><span class="p">;</span>
    <span class="n">PS802_11Header</span>      <span class="n">pMACHeader</span><span class="p">;</span>
    <span class="n">PSTxDataHead_ab</span>     <span class="n">pTxDataHead</span><span class="p">;</span>
    <span class="n">WORD</span>                <span class="n">wCurrentRate</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>                <span class="n">cbFrameBodySize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>                <span class="n">cbReqCount</span><span class="p">;</span>
    <span class="n">PBEACON_BUFFER</span>      <span class="n">pTX_Buffer</span><span class="p">;</span>
    <span class="n">PBYTE</span>               <span class="n">pbyTxBufferAddr</span><span class="p">;</span>
    <span class="n">PUSB_SEND_CONTEXT</span>   <span class="n">pContext</span><span class="p">;</span>
    <span class="n">CMD_STATUS</span>          <span class="n">status</span><span class="p">;</span>


    <span class="n">pContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUSB_SEND_CONTEXT</span><span class="p">)</span><span class="n">s_vGetFreeContext</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">CMD_STATUS_RESOURCES</span><span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ManagementSend TX...NO CONTEXT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">status</span> <span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pTX_Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBEACON_BUFFER</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">pbyTxBufferAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span><span class="p">);</span>

    <span class="n">cbFrameBodySize</span> <span class="o">=</span> <span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">cbPayloadLen</span><span class="p">;</span>

    <span class="n">pTxBufHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxShortBufHead</span><span class="p">)</span> <span class="n">pbyTxBufferAddr</span><span class="p">;</span>
    <span class="n">wTxBufSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxShortBufHead</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxBufHead</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wTxBufSize</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
        <span class="n">pTxDataHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>        <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">PK_TYPE_11A</span><span class="p">,</span>
            <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">wTransmitLength</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">byServiceField</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">bySignalField</span><span class="p">)</span>
        <span class="p">);</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>Get Duration and TimeStampOff</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_A</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">PK_TYPE_11A</span><span class="p">,</span>
                                                          <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AUTO_FB_NONE</span><span class="p">));</span>
        <span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">wTimeStampOff</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">wCurrentRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
        <span class="n">cbHeaderSize</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_ab</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_11B</span><span class="p">;</span>
        <span class="n">pTxDataHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>Get SignalField,ServiceField,Length</p></td><td class="code"><div class="highlight"><pre>        <span class="n">BBvCaculateParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
            <span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">wTransmitLength</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">byServiceField</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">bySignalField</span><span class="p">)</span>
        <span class="p">);</span></pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div><p>Get Duration and TimeStampOff</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">s_uGetDataDuration</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DATADUR_B</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">PK_TYPE_11B</span><span class="p">,</span>
                                                          <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AUTO_FB_NONE</span><span class="p">));</span>
        <span class="n">pTxDataHead</span><span class="o">-&gt;</span><span class="n">wTimeStampOff</span> <span class="o">=</span> <span class="n">wTimeStampOff</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span><span class="o">%</span><span class="mi">2</span><span class="p">][</span><span class="n">wCurrentRate</span><span class="o">%</span><span class="n">MAX_RATE</span><span class="p">];</span>
        <span class="n">cbHeaderSize</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_ab</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>Generate Beacon Header</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pMACHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pMACHeader</span><span class="p">,</span> <span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">p80211Header</span><span class="p">,</span> <span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">cbMPDULen</span><span class="p">);</span>

    <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wDurationID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wSeqCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span><span class="o">++</span> <span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">&gt;</span> <span class="mh">0x0fff</span><span class="p">)</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">cbReqCount</span> <span class="o">=</span> <span class="n">cbHeaderSize</span> <span class="o">+</span> <span class="n">WLAN_HDR_ADDR3_LEN</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span><span class="p">;</span>

    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wTxByteCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbReqCount</span><span class="p">;</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(((</span><span class="n">wCurrentRate</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span><span class="mh">0x00F0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">));</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byType</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">CONTEXT_MGMT_PACKET</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">uBufLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbReqCount</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>  <span class="c1">//USB header</span>

    <span class="n">PIPEnsSendBulkOut</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pContext</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">CMD_STATUS_PENDING</span><span class="p">;</span>

<span class="p">}</span>





<span class="kt">void</span>
<span class="nf">vDMA0_tx_80211</span><span class="p">(</span><span class="n">PSDevice</span>  <span class="n">pDevice</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">BYTE</span>            <span class="n">byPktType</span><span class="p">;</span>
    <span class="n">PBYTE</span>           <span class="n">pbyTxBufferAddr</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvRTS</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvCTS</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvTxDataHd</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uDuration</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbReqCount</span><span class="p">;</span>
    <span class="n">PS802_11Header</span>  <span class="n">pMACHeader</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbHeaderSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbFrameBodySize</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bNeedACK</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bIsPSPOLL</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PSTxBufHead</span>     <span class="n">pTxBufHead</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbFrameSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbMIClen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbFCSlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uPadding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbMICHDR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">DWORD</span>           <span class="n">dwMICKey0</span><span class="p">,</span> <span class="n">dwMICKey1</span><span class="p">;</span>
    <span class="n">DWORD</span>           <span class="n">dwMIC_Priority</span><span class="p">;</span>
    <span class="n">PDWORD</span>          <span class="n">pdwMIC_L</span><span class="p">;</span>
    <span class="n">PDWORD</span>          <span class="n">pdwMIC_R</span><span class="p">;</span>
    <span class="n">WORD</span>            <span class="n">wTxBufSize</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbMacHdLen</span><span class="p">;</span>
    <span class="n">SEthernetHeader</span> <span class="n">sEthHeader</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pvRrvTime</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">pMICHDR</span><span class="p">;</span>
    <span class="n">WORD</span>            <span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
    <span class="n">PUWLAN_80211HDR</span>  <span class="n">p80211Header</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>             <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bNodeExist</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">SKeyItem</span>        <span class="n">STempKey</span><span class="p">;</span>
    <span class="n">PSKeyItem</span>       <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PBYTE</span>           <span class="n">pbyIVHead</span><span class="p">;</span>
    <span class="n">PBYTE</span>           <span class="n">pbyPayloadHead</span><span class="p">;</span>
    <span class="n">PBYTE</span>           <span class="n">pbyMacHdr</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">cbExtSuppRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PTX_BUFFER</span>          <span class="n">pTX_Buffer</span><span class="p">;</span>
    <span class="n">PUSB_SEND_CONTEXT</span>   <span class="n">pContext</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>PWLAN_IE        pItem;</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="n">pMICHDR</span> <span class="o">=</span> <span class="n">pvRTS</span> <span class="o">=</span> <span class="n">pvCTS</span> <span class="o">=</span> <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">cbFrameBodySize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
       <span class="n">cbFrameBodySize</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">p80211Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUWLAN_80211HDR</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

    <span class="n">pContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUSB_SEND_CONTEXT</span><span class="p">)</span><span class="n">s_vGetFreeContext</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;DMA0 TX...NO CONTEXT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pTX_Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTX_BUFFER</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">pbyTxBufferAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">adwTxKey</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">pTxBufHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxBufHead</span><span class="p">)</span> <span class="n">pbyTxBufferAddr</span><span class="p">;</span>
    <span class="n">wTxBufSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxBufHead</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pTxBufHead</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wTxBufSize</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11A</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11B</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>SetPower will cause error power TX state for OFDM Date packet in TX buffer.
2004.11.11 Kyle -- Using OFDM power to tx MngPkt will decrease the connection capability.
                   And cmd timer will wait data pkt TX finish before scanning so it's OK
                   to set power here.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanState</span> <span class="o">!=</span> <span class="n">WMAC_NO_SCANNING</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RFbSetPower</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurrentCh</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">RFbSetPower</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;vDMA0_tx_80211: p80211Header-&gt;sA3.wFrameCtl = %x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-133"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-133">&#182;</a></div><p>Set packet type</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11A</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0000 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11B</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0001 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_11B</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0010 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_11GB</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0011 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_11GA</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_TMOEN</span><span class="p">;</span>
    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wTimeStamp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">DEFAULT_MGN_LIFETIME_RES_64us</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">bNeedACK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">bNodeExist</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">BSSbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span>
                <span class="n">bNodeExist</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">bNeedACK</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_NEEDACK</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="n">FIFOCTL_LRETRY</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-134"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-134">&#182;</a></div><p>Set Preamble type always long
pDevice->byPreambleType = PREAMBLE_LONG;</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-135"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-135">&#182;</a></div><p>probe-response don't retry
if ((p80211Header->sA4.wFrameCtl &amp; TYPE<em>SUBTYPE</em>MASK) == TYPE<em>MGMT</em>PROBE<em>RSP) {
    bNeedACK = FALSE;
    pTxBufHead->wFIFOCtl  &amp;= (~FIFOCTL</em>NEEDACK);
}</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>

    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FIFOCTL_GENINT</span> <span class="o">|</span> <span class="n">FIFOCTL_ISDMA0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">wFrameCtl</span> <span class="o">&amp;</span> <span class="n">TYPE_SUBTYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_CTL_PSPOLL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bIsPSPOLL</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">cbMacHdLen</span> <span class="o">=</span> <span class="n">WLAN_HDR_ADDR2_LEN</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cbMacHdLen</span> <span class="o">=</span> <span class="n">WLAN_HDR_ADDR3_LEN</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-136"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-136">&#182;</a></div><p>hostapd deamon ext support rate patch</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_FC_FSTYPE</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">==</span> <span class="n">WLAN_FSTYPE_ASSOCRESP</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbExtSuppRate</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
         <span class="p">}</span>

        <span class="k">if</span> <span class="p">(((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbExtSuppRate</span> <span class="o">+=</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">cbExtSuppRate</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbFrameBodySize</span> <span class="o">=</span> <span class="n">WLAN_ASSOCRESP_OFF_SUPP_RATES</span><span class="p">;</span>
         <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-137"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-137">&#182;</a></div><p>Set FRAGCTL_MACHDCNT</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbMacHdLen</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-138"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-138">&#182;</a></div><p>Notes:
Although spec says MMPDU can be fragmented; In most case,
no one will send a MMPDU under fragmentation. With RTS may occur.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bAES</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>  <span class="c1">//Set FRAGCTL_WEPTYP</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_FC_ISWEP</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    	    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">FRAGCTL_LEGACY</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//IV+ExtIV</span>
            <span class="n">cbMIClen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    	    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">FRAGCTL_TKIP</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-139"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-139">&#182;</a></div><p>We need to get seed here for filling TxKey entry.
TKIPvMixKey(pTransmitKey->abyKey, pDevice->abyCurrentNetAddr,
           pTransmitKey->wTSC15<em>0, pTransmitKey->dwTSC47</em>16, pDevice->abyPRNG);</p></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cbIVlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//RSN Header</span>
            <span class="n">cbICVlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//MIC</span>
            <span class="n">cbMICHDR</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SMICHDRHead</span><span class="p">);</span>
            <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="n">FRAGCTL_AES</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bAES</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-140"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-140">&#182;</a></div><p>MAC Header should be padding 0 to DW alignment.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">uPadding</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">cbMacHdLen</span><span class="o">%</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">uPadding</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">cbFrameSize</span> <span class="o">=</span> <span class="n">cbMacHdLen</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span> <span class="o">+</span> <span class="n">cbIVlen</span> <span class="o">+</span> <span class="n">cbMIClen</span> <span class="o">+</span> <span class="n">cbICVlen</span> <span class="o">+</span> <span class="n">cbFCSlen</span> <span class="o">+</span> <span class="n">cbExtSuppRate</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-141"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-141">&#182;</a></div><p>Set FIFOCTL_GrpAckPolicy</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bGrpAckPolicy</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//0000 0100 0000 0000</span>
        <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span> <span class="o">|=</span>	<span class="n">FIFOCTL_GRPACK</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-142"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-142">&#182;</a></div><p>the rest of pTxBufHead->wFragCtl:FragTyp will be set later in s_vFillFragParameter()</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span> <span class="o">||</span> <span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span><span class="c1">//802.11g packet</span>

        <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_gCTS</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
        <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">));</span>
        <span class="n">pvRTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">pvCTS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSCTS</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
        <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_g</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCTS</span><span class="p">));</span>
        <span class="n">cbHeaderSize</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_gCTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCTS</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_g</span><span class="p">);</span>

    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span><span class="c1">//802.11a/b packet</span>

        <span class="n">pvRrvTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRrvTime_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">);</span>
        <span class="n">pMICHDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSMICHDRHead</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">));</span>
        <span class="n">pvRTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">pvCTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">pvTxDataHd</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span><span class="p">);</span>
        <span class="n">cbHeaderSize</span> <span class="o">=</span> <span class="n">wTxBufSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRrvTime_ab</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbMICHDR</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STxDataHead_ab</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">wTxBufSize</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">cbHeaderSize</span> <span class="o">-</span> <span class="n">wTxBufSize</span><span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	   <span class="o">&amp;</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	   <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sEthHeader</span><span class="p">.</span><span class="n">abySrcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	   <span class="o">&amp;</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA3</span><span class="p">.</span><span class="n">abyAddr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	   <span class="n">ETH_ALEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-143"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-143">&#182;</a></div><p>=========================</p>

<h1>   No Fragmentation</h1></td><td class="code"><div class="highlight"><pre>    <span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">wFragCtl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">FRAGCTL_NONFRAG</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-144"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-144">&#182;</a></div><p>Fill FIFO,RrvTime,RTS,and CTS</p></td><td class="code"><div class="highlight"><pre>    <span class="n">s_vGenerateTxParameter</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">pbyTxBufferAddr</span><span class="p">,</span> <span class="n">pvRrvTime</span><span class="p">,</span> <span class="n">pvRTS</span><span class="p">,</span> <span class="n">pvCTS</span><span class="p">,</span>
                           <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span> <span class="n">TYPE_TXDMA0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sEthHeader</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-145"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-145">&#182;</a></div><p>Fill DataHead</p></td><td class="code"><div class="highlight"><pre>    <span class="n">uDuration</span> <span class="o">=</span> <span class="n">s_uFillDataHead</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span> <span class="n">wCurrentRate</span><span class="p">,</span> <span class="n">pvTxDataHd</span><span class="p">,</span> <span class="n">cbFrameSize</span><span class="p">,</span> <span class="n">TYPE_TXDMA0</span><span class="p">,</span> <span class="n">bNeedACK</span><span class="p">,</span>
                                <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AUTO_FB_NONE</span><span class="p">);</span>

    <span class="n">pMACHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PS802_11Header</span><span class="p">)</span> <span class="p">(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>

    <span class="n">cbReqCount</span> <span class="o">=</span> <span class="n">cbHeaderSize</span> <span class="o">+</span> <span class="n">cbMacHdLen</span> <span class="o">+</span> <span class="n">uPadding</span> <span class="o">+</span> <span class="n">cbIVlen</span> <span class="o">+</span> <span class="p">(</span><span class="n">cbFrameBodySize</span> <span class="o">+</span> <span class="n">cbMIClen</span><span class="p">)</span> <span class="o">+</span> <span class="n">cbExtSuppRate</span><span class="p">;</span>

    <span class="n">pbyMacHdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">cbHeaderSize</span><span class="p">);</span>
    <span class="n">pbyPayloadHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pbyMacHdr</span> <span class="o">+</span> <span class="n">cbMacHdLen</span> <span class="o">+</span> <span class="n">uPadding</span> <span class="o">+</span> <span class="n">cbIVlen</span><span class="p">);</span>
    <span class="n">pbyIVHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pbyMacHdr</span> <span class="o">+</span> <span class="n">cbMacHdLen</span> <span class="o">+</span> <span class="n">uPadding</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-146"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-146">&#182;</a></div><p>Copy the Packet into a tx Buffer</p></td><td class="code"><div class="highlight"><pre>    <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyMacHdr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">cbMacHdLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-147"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-147">&#182;</a></div><p>version set to 0, patch for hostapd deamon</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xfffc</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">cbMacHdLen</span><span class="p">),</span> <span class="n">cbFrameBodySize</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-148"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-148">&#182;</a></div><p>replace support rate, patch for hostapd deamon( only support 11M)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_FC_FSTYPE</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">==</span> <span class="n">WLAN_FSTYPE_ASSOCRESP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cbExtSuppRate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">memcpy</span><span class="p">((</span><span class="n">pbyPayloadHead</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span><span class="p">),</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                        <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
                       <span class="p">);</span>
             <span class="k">if</span> <span class="p">(((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">memcpy</span><span class="p">((</span><span class="n">pbyPayloadHead</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">,</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                        <span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span>
                       <span class="p">);</span>
         <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-149"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-149">&#182;</a></div><p>Set wep</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_FC_ISWEP</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA4</span><span class="p">.</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STempKey</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byCipherSuite</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwKeyIndex</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uWepKeyLength</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwTSC47_16</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTSC15_0</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">abyWepKey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span>
                <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pTransmitKey</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">==</span> <span class="n">KEY_CTL_TKIP</span><span class="p">))</span> <span class="p">{</span>

            <span class="n">dwMICKey0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
            <span class="n">dwMICKey1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-150"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-150">&#182;</a></div><p>DO Software Michael</p></td><td class="code"><div class="highlight"><pre>            <span class="n">MIC_vInit</span><span class="p">(</span><span class="n">dwMICKey0</span><span class="p">,</span> <span class="n">dwMICKey1</span><span class="p">);</span>
            <span class="n">MIC_vAppend</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">12</span><span class="p">);</span>
            <span class="n">dwMIC_Priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">MIC_vAppend</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dwMIC_Priority</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;DMA0_tx_8021:MIC KEY: %lX, %lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dwMICKey0</span><span class="p">,</span> <span class="n">dwMICKey1</span><span class="p">);</span>

            <span class="n">uLength</span> <span class="o">=</span> <span class="n">cbHeaderSize</span> <span class="o">+</span> <span class="n">cbMacHdLen</span> <span class="o">+</span> <span class="n">uPadding</span> <span class="o">+</span> <span class="n">cbIVlen</span><span class="p">;</span>

            <span class="n">MIC_vAppend</span><span class="p">((</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">uLength</span><span class="p">),</span> <span class="n">cbFrameBodySize</span><span class="p">);</span>

            <span class="n">pdwMIC_L</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">uLength</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span><span class="p">);</span>
            <span class="n">pdwMIC_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">pbyTxBufferAddr</span> <span class="o">+</span> <span class="n">uLength</span> <span class="o">+</span> <span class="n">cbFrameBodySize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

            <span class="n">MIC_vGetMIC</span><span class="p">(</span><span class="n">pdwMIC_L</span><span class="p">,</span> <span class="n">pdwMIC_R</span><span class="p">);</span>
            <span class="n">MIC_vUnInit</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxMICFail</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">pdwMIC_L</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="o">*</span><span class="n">pdwMIC_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxMICFail</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;uLength: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uLength</span><span class="p">,</span> <span class="n">cbFrameBodySize</span><span class="p">);</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;cbReqCount:%d, %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cbReqCount</span><span class="p">,</span> <span class="n">cbHeaderSize</span><span class="p">,</span> <span class="n">uPadding</span><span class="p">,</span> <span class="n">cbIVlen</span><span class="p">);</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;MIC:%lx, %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwMIC_L</span><span class="p">,</span> <span class="o">*</span><span class="n">pdwMIC_R</span><span class="p">);</span>

        <span class="p">}</span>

        <span class="n">s_vFillTxKey</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">pTxBufHead</span><span class="o">-&gt;</span><span class="n">adwTxKey</span><span class="p">),</span> <span class="n">pbyIVHead</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span>
                     <span class="n">pbyMacHdr</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbFrameBodySize</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pMICHDR</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwTSC47_16</span> <span class="o">=</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span><span class="p">;</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTSC15_0</span> <span class="o">=</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span> <span class="o">&lt;=</span> <span class="n">REV_ID_VT3253_A1</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">s_vSWencryption</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span> <span class="n">pbyPayloadHead</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)(</span><span class="n">cbFrameBodySize</span> <span class="o">+</span> <span class="n">cbMIClen</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wSeqCtl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span><span class="o">++</span> <span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">&gt;</span> <span class="mh">0x0fff</span><span class="p">)</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">bIsPSPOLL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-151"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-151">&#182;</a></div><p>The MAC will automatically replace the Duration-field of MAC header by Duration-field
of  FIFO control header.
This will cause AID-field of PS-POLL packet be incorrect (Because PS-POLL's AID field is
in the same place of other packet's Duration-field).
And it will cause Cisco-AP to issue Disassociation-packet</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GB</span> <span class="o">||</span> <span class="n">byPktType</span> <span class="o">==</span> <span class="n">PK_TYPE_11GA</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">((</span><span class="n">PSTxDataHead_g</span><span class="p">)</span><span class="n">pvTxDataHd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wDuration_a</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA2</span><span class="p">.</span><span class="n">wDurationID</span><span class="p">);</span>
            <span class="p">((</span><span class="n">PSTxDataHead_g</span><span class="p">)</span><span class="n">pvTxDataHd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wDuration_b</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA2</span><span class="p">.</span><span class="n">wDurationID</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="p">((</span><span class="n">PSTxDataHead_ab</span><span class="p">)</span><span class="n">pvTxDataHd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wDuration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">p80211Header</span><span class="o">-&gt;</span><span class="n">sA2</span><span class="p">.</span><span class="n">wDurationID</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wTxByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">WORD</span><span class="p">)(</span><span class="n">cbReqCount</span><span class="p">));</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(((</span><span class="n">wCurrentRate</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span><span class="mh">0x00F0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">));</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byType</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pPacket</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">CONTEXT_MGMT_PACKET</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">uBufLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbReqCount</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>  <span class="c1">//USB header</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_FC_TODS</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">wFrameCtl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s_vSaveTxPktInfo</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbFrameSize</span><span class="p">,</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">s_vSaveTxPktInfo</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMACHeader</span><span class="o">-&gt;</span><span class="n">abyAddr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]),(</span><span class="n">WORD</span><span class="p">)</span><span class="n">cbFrameSize</span><span class="p">,</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">PIPEnsSendBulkOut</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pContext</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">;</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-152"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-152">&#182;</a></div><p>TYPE_AC0DMA data tx</p></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Tx packet via AC0DMA(DMA1)</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice         - Pointer to the adapter</span>
<span class="cm"> *      skb             - Pointer to tx skb packet</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      void</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: NULL</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">nsDMA_tx_packet</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uDMAIdx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BytesToWrite</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uHeaderLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byMask</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">};</span>
    <span class="n">WORD</span>            <span class="n">wAID</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byPktType</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PSKeyItem</span>       <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">SKeyItem</span>        <span class="n">STempKey</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bTKIP_UseGTK</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bNeedDeAuth</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PBYTE</span>           <span class="n">pbyBSSID</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bNodeExist</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PUSB_SEND_CONTEXT</span> <span class="n">pContext</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">fConvertedPacket</span><span class="p">;</span>
    <span class="n">PTX_BUFFER</span>      <span class="n">pTX_Buffer</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">status</span><span class="p">;</span>
    <span class="n">WORD</span>            <span class="n">wKeepRate</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">net_device_stats</span><span class="o">*</span> <span class="n">pStats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
     <span class="n">BOOL</span>            <span class="n">bTxeapol_key</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAssocCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">bNodeExist</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span> <span class="p">{</span>

                <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">),</span> <span class="n">skb</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-153"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-153">&#182;</a></div><p>set tx map</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">byMask</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-154"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-154">&#182;</a></div><p>muticast/broadcast data rate</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">!=</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_2M</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_24M</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-155"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-155">&#182;</a></div><p>long preamble type</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">PREAMBLE_SHORT</span><span class="p">;</span>

        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">BSSbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span> <span class="p">{</span>

                    <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-156"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-156">&#182;</a></div><p>set tx map</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">wAID</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wAID</span><span class="p">;</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>  <span class="n">byMask</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Set:pMgmt-&gt;abyPSTxMap[%d]= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]);</span>

                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr>


<tr id="section-157"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-157">&#182;</a></div><p>AP rate decided from node</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-158"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-158">&#182;</a></div><p>tx preamble decided from node</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortPreamble</span><span class="p">;</span>

                <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">PREAMBLE_LONG</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">bNodeExist</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">bNodeExist</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;Unknown STA not found in node DB </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUSB_SEND_CONTEXT</span><span class="p">)</span><span class="n">s_vGetFreeContext</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pContext</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot; pContext == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">STATUS_RESOURCES</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">ETH_HLEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-159"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-159">&#182;</a></div><p>mike add:station mode check eapol-key challenge---></p></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
    <span class="n">BYTE</span>  <span class="n">Protocol_Version</span><span class="p">;</span>    <span class="c1">//802.1x Authentication</span>
    <span class="n">BYTE</span>  <span class="n">Packet_Type</span><span class="p">;</span>           <span class="c1">//802.1x Authentication</span>
    <span class="n">BYTE</span>  <span class="n">Descriptor_type</span><span class="p">;</span>
    <span class="n">WORD</span> <span class="n">Key_info</span><span class="p">;</span>

    <span class="n">Protocol_Version</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="p">];</span>
    <span class="n">Packet_Type</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">Descriptor_type</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">Key_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ETH_P_PAE</span><span class="p">))</span> <span class="p">{</span>
	<span class="cm">/* 802.1x OR eapol-key challenge frame transfer */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">Protocol_Version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Protocol_Version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">Packet_Type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">bTxeapol_key</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                       <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">Key_info</span> <span class="o">&amp;</span> <span class="n">BIT3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="c1">//WPA or RSN group-key challenge</span>
			   <span class="p">(</span><span class="n">Key_info</span> <span class="o">&amp;</span> <span class="n">BIT8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Key_info</span> <span class="o">&amp;</span> <span class="n">BIT9</span><span class="p">))</span> <span class="p">{</span>    <span class="c1">//send 2/2 key</span>
			  <span class="k">if</span><span class="p">(</span><span class="n">Descriptor_type</span><span class="o">==</span><span class="mi">254</span><span class="p">)</span> <span class="p">{</span>
                               <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fWPA_Authened</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			     <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;WPA &quot;</span><span class="p">);</span>
			  <span class="p">}</span>
			  <span class="k">else</span> <span class="p">{</span>
                               <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fWPA_Authened</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			     <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;WPA2(re-keying) &quot;</span><span class="p">);</span>
			  <span class="p">}</span>
			  <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;Authentication completed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
		    <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">Key_info</span> <span class="o">&amp;</span> <span class="n">BIT3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Descriptor_type</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="c1">//RSN pairse-key challenge</span>
			       <span class="p">(</span><span class="n">Key_info</span> <span class="o">&amp;</span> <span class="n">BIT8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Key_info</span> <span class="o">&amp;</span> <span class="n">BIT9</span><span class="p">))</span> <span class="p">{</span>
			  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fWPA_Authened</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                            <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;WPA2 Authentication completed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		     <span class="p">}</span>
             <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-160"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-160">&#182;</a></div><p>mike add:station mode check eapol-key challenge&lt;---</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-161"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-161">&#182;</a></div><p>get Transmit key</p></td><td class="code"><div class="highlight"><pre>        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-162"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-162">&#182;</a></div><p>get pairwise key</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">PAIRWISE_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-163"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-163">&#182;</a></div><p>get group key</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">GROUP_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">bTKIP_UseGTK</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;Get GTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;Get PTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>

                <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">;</span>  <span class="c1">//TO_DS = 0 and FROM_DS = 0 --&gt; 802.11 MAC Address1</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;IBSS Serach Key: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">pbyBSSID</span><span class="o">+</span><span class="n">ii</span><span class="p">));</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-164"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-164">&#182;</a></div><p>get pairwise key</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">PAIRWISE_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr>


<tr id="section-165"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-165">&#182;</a></div><p>get group key</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">GROUP_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;IBSS and KEY is NULL. [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;NOT IBSS and KEY is NULL. [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">bTKIP_UseGTK</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;Get GTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;acdma0: STA index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STempKey</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byCipherSuite</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwKeyIndex</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uWepKeyLength</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwTSC47_16</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTSC15_0</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">abyWepKey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span>
                <span class="p">);</span>
         <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">byPktType</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPacketType</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&gt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_11M</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&lt;=</span> <span class="n">RATE_6M</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&gt;=</span> <span class="n">RATE_54M</span><span class="p">)</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-166"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-166">&#182;</a></div><p>Adhoc Tx rate decided from node DB</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-167"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-167">&#182;</a></div><p>Multicast use highest data rate</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-168"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-168">&#182;</a></div><p>preamble type</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortPreamble</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">BSSbIsSTAInNodeDB</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">bShortPreamble</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortPreamble</span><span class="p">;</span>

                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">PREAMBLE_LONG</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Found Node Index is [%d]  Tx Data Rate:[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">uNodeIndex</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">!=</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span>
                       <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_2M</span><span class="p">;</span>
                    <span class="k">else</span>
                       <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_24M</span><span class="p">;</span> <span class="c1">// refer to vMgrCreateOwnIBSS()&#39;s</span></pre></div></td></tr>


<tr id="section-169"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-169">&#182;</a></div><p>abyCurrExtSuppRates[]</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="n">PREAMBLE_SHORT</span><span class="p">;</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Not Found Node use highest basic Rate.....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">==</span> <span class="n">OP_MODE_INFRASTRUCTURE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-170"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-170">&#182;</a></div><p>Infra STA rate decided from AP Node, index = 0</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ETH_P_PAE</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">!=</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byACKRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byACKRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span>
	    <span class="n">KERN_INFO</span> <span class="s">&quot;dma_tx: pDevice-&gt;wCurrentRate = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wKeepRate</span> <span class="o">!=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_SETPOWER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">&lt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11B</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bNeedEncryption</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;ntohs Pkt Type=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span><span class="p">)</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ETH_P_PAE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Pkt Type=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">wType</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Don&#39;t Find TX KEY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">bTKIP_UseGTK</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;error: KEY is GTK!!~~</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Find PTK [%lX]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span><span class="p">);</span>
                        <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCntMeasure</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bNeedDeAuth</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">s802_11Counter</span><span class="p">.</span><span class="n">TKIPCounterMeasuresInvoked</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">uNodeIndex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwKeyIndex</span> <span class="o">&amp;</span> <span class="n">PAIRWISE_KEY</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Find PTK [%lX]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span><span class="p">);</span>
                    <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                 <span class="p">}</span>
             <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;return no tx key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
                <span class="n">pStats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">fConvertedPacket</span> <span class="o">=</span> <span class="n">s_bPacketToWirelessUsb</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">bNeedEncryption</span><span class="p">,</span>
                        <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">uDMAIdx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">,</span>
                        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">uHeaderLen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BytesToWrite</span>
                       <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fConvertedPacket</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnablePSMode</span> <span class="o">==</span> <span class="n">TRUE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bPSModeTxBurst</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_MAC_DISPOWERSAVING</span><span class="p">,</span>
				 <span class="nb">NULL</span><span class="p">);</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bPSModeTxBurst</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pTX_Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTX_BUFFER</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span><span class="mh">0x00F0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">));</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wTxByteCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">BytesToWrite</span><span class="p">;</span>

    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pPacket</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">CONTEXT_DATA_PACKET</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">uBufLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">BytesToWrite</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">;</span> <span class="c1">//USB header</span>

    <span class="n">s_vSaveTxPktInfo</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">sEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),(</span><span class="n">WORD</span><span class="p">)</span> <span class="p">(</span><span class="n">BytesToWrite</span><span class="o">-</span><span class="n">uHeaderLen</span><span class="p">),</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span><span class="p">);</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">PIPEnsSendBulkOut</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pContext</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bNeedDeAuth</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">WORD</span> <span class="n">wReason</span> <span class="o">=</span> <span class="n">WLAN_MGMT_REASON_MIC_FAILURE</span><span class="p">;</span>

	<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_DEAUTH</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wReason</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="o">!=</span><span class="n">STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      Relay packet send (AC1DMA) from rx dpc.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      pDevice         - Pointer to the adapter</span>
<span class="cm"> *      pPacket         - Pointer to rx packet</span>
<span class="cm"> *      cbPacketSize    - rx ethernet frame size</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      TURE, FALSE</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value: Return TRUE if packet is copy to dma1; otherwise FALSE</span>
<span class="cm"> */</span>


<span class="n">BOOL</span>
<span class="nf">bRelayPacketSend</span> <span class="p">(</span>
      <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span>
      <span class="n">PBYTE</span>    <span class="n">pbySkbData</span><span class="p">,</span>
      <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uDataLen</span><span class="p">,</span>
      <span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">uNodeIndex</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BytesToWrite</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uHeaderLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11B</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">SKeyItem</span>        <span class="n">STempKey</span><span class="p">;</span>
    <span class="n">PSKeyItem</span>       <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PBYTE</span>           <span class="n">pbyBSSID</span><span class="p">;</span>
    <span class="n">PUSB_SEND_CONTEXT</span>   <span class="n">pContext</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byPktTyp</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">fConvertedPacket</span><span class="p">;</span>
    <span class="n">PTX_BUFFER</span>      <span class="n">pTX_Buffer</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">status</span><span class="p">;</span>
    <span class="n">WORD</span>            <span class="n">wKeepRate</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">;</span>



    <span class="n">pContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUSB_SEND_CONTEXT</span><span class="p">)</span><span class="n">s_vGetFreeContext</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pbySkbData</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bNeedEncryption</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-171"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-171">&#182;</a></div><p>get group key</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pbyBSSID</span><span class="p">,</span> <span class="n">GROUP_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;KEY is NULL. [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="s">&quot;Get GTK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">uNodeIndex</span> <span class="o">&lt;</span> <span class="n">MAX_NODE_NUM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STempKey</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">byCipherSuite</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">byCipherSuite</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwKeyIndex</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwKeyIndex</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uWepKeyLength</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">dwTSC47_16</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">dwTSC47_16</span><span class="p">;</span>
            <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">wTSC15_0</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTSC15_0</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">abyWepKey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">pTransmitKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span>
                  <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">bNeedEncryption</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pTransmitKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">byPktTyp</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPacketType</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&gt;=</span> <span class="n">RATE_11M</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_11M</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&lt;=</span> <span class="n">RATE_6M</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_6M</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&gt;=</span> <span class="n">RATE_54M</span><span class="p">)</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wKeepRate</span> <span class="o">!=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_SETPOWER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">&lt;=</span> <span class="n">RATE_11M</span><span class="p">)</span>
        <span class="n">byPktType</span> <span class="o">=</span> <span class="n">PK_TYPE_11B</span><span class="p">;</span>

    <span class="n">BytesToWrite</span> <span class="o">=</span> <span class="n">uDataLen</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-172"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-172">&#182;</a></div><p>Convert the packet to an usb frame and copy into our buffer
and send the irp.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">fConvertedPacket</span> <span class="o">=</span> <span class="n">s_bPacketToWirelessUsb</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">byPktType</span><span class="p">,</span>
                         <span class="p">(</span><span class="n">PBYTE</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">bNeedEncryption</span><span class="p">,</span>
                         <span class="n">uDataLen</span><span class="p">,</span> <span class="n">TYPE_AC0DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTxEthHeader</span><span class="p">,</span>
                         <span class="n">pbySkbData</span><span class="p">,</span> <span class="n">pTransmitKey</span><span class="p">,</span> <span class="n">uNodeIndex</span><span class="p">,</span>
                         <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">,</span>
                         <span class="o">&amp;</span><span class="n">uHeaderLen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BytesToWrite</span>
                        <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fConvertedPacket</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pTX_Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTX_BUFFER</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span><span class="mh">0x00F0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wSeqCounter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">));</span>
    <span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wTxByteCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">BytesToWrite</span><span class="p">;</span>

    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">pPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">CONTEXT_DATA_PACKET</span><span class="p">;</span>
    <span class="n">pContext</span><span class="o">-&gt;</span><span class="n">uBufLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">BytesToWrite</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">;</span> <span class="c1">//USB header</span>

    <span class="n">s_vSaveTxPktInfo</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">byPKTNO</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">sEthHeader</span><span class="p">.</span><span class="n">abyDstAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),(</span><span class="n">WORD</span><span class="p">)</span> <span class="p">(</span><span class="n">BytesToWrite</span><span class="o">-</span><span class="n">uHeaderLen</span><span class="p">),</span><span class="n">pTX_Buffer</span><span class="o">-&gt;</span><span class="n">wFIFOCtl</span><span class="p">);</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">PIPEnsSendBulkOut</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">pContext</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
