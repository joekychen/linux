<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6656 › iwctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>iwctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * File: iwctl.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose:  wireless ext &amp; ioctl functions</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Lyndon Chen</span>
<span class="cm"> *</span>
<span class="cm"> * Date: July 5, 2006</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;ioctl.h&quot;</span>
<span class="cp">#include &quot;iocmd.h&quot;</span>
<span class="cp">#include &quot;mac.h&quot;</span>
<span class="cp">#include &quot;card.h&quot;</span>
<span class="cp">#include &quot;hostap.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>
<span class="cp">#include &quot;rf.h&quot;</span>

<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
<span class="cp">#include &quot;iowpa.h&quot;</span>
<span class="cp">#include &quot;wpactl.h&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;net/iw_handler.h&gt;</span>

<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
<span class="cp">#define SUPPORTED_WIRELESS_EXT                  18</span>
<span class="cp">#else</span>
<span class="cp">#define SUPPORTED_WIRELESS_EXT                  17</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">frequency_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">2412</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span> <span class="mi">2432</span><span class="p">,</span> <span class="mi">2437</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span> <span class="mi">2452</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span> <span class="mi">2472</span><span class="p">,</span> <span class="mi">2484</span><span class="p">,</span>
    <span class="mi">4915</span><span class="p">,</span> <span class="mi">4920</span><span class="p">,</span> <span class="mi">4925</span><span class="p">,</span> <span class="mi">4935</span><span class="p">,</span> <span class="mi">4940</span><span class="p">,</span> <span class="mi">4945</span><span class="p">,</span> <span class="mi">4960</span><span class="p">,</span> <span class="mi">4980</span><span class="p">,</span>
    <span class="mi">5035</span><span class="p">,</span> <span class="mi">5040</span><span class="p">,</span> <span class="mi">5045</span><span class="p">,</span> <span class="mi">5055</span><span class="p">,</span> <span class="mi">5060</span><span class="p">,</span> <span class="mi">5080</span><span class="p">,</span> <span class="mi">5170</span><span class="p">,</span> <span class="mi">5180</span><span class="p">,</span> <span class="mi">5190</span><span class="p">,</span> <span class="mi">5200</span><span class="p">,</span> <span class="mi">5210</span><span class="p">,</span> <span class="mi">5220</span><span class="p">,</span> <span class="mi">5230</span><span class="p">,</span> <span class="mi">5240</span><span class="p">,</span>
    <span class="mi">5260</span><span class="p">,</span> <span class="mi">5280</span><span class="p">,</span> <span class="mi">5300</span><span class="p">,</span> <span class="mi">5320</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">5520</span><span class="p">,</span> <span class="mi">5540</span><span class="p">,</span> <span class="mi">5560</span><span class="p">,</span> <span class="mi">5580</span><span class="p">,</span> <span class="mi">5600</span><span class="p">,</span> <span class="mi">5620</span><span class="p">,</span> <span class="mi">5640</span><span class="p">,</span> <span class="mi">5660</span><span class="p">,</span> <span class="mi">5680</span><span class="p">,</span>
    <span class="mi">5700</span><span class="p">,</span> <span class="mi">5745</span><span class="p">,</span> <span class="mi">5765</span><span class="p">,</span> <span class="mi">5785</span><span class="p">,</span> <span class="mi">5805</span><span class="p">,</span> <span class="mi">5825</span>
	<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span><span class="n">MSG_LEVEL_INFO</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">iwctl_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span> <span class="n">pDevice</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">ldBm</span><span class="p">;</span>

	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span><span class="p">;</span>
	   <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">LinkQuality</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
   	       <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">LinkQuality</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
               <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span><span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">LinkQuality</span><span class="p">;</span>
	<span class="n">RFvRSSITodBm</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrRSSI</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ldBm</span><span class="p">);</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">ldBm</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">nwid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">dwTsrErr</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">miss</span><span class="p">.</span><span class="n">beacon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get protocol name</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_giwname</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">wrq</span><span class="p">,</span> <span class="s">&quot;802.11-a/b/g&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set scan</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_siwscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	 <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_scan_req</span>  <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">BYTE</span>                <span class="n">abyScanSSID</span><span class="p">[</span><span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">PWLAN_IE_SSID</span>       <span class="n">pItemSSID</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot; SIOCSIWSCAN </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanState</span> <span class="o">==</span>  <span class="n">WMAC_IS_SCANNING</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>In scanning..</p></td><td class="code"><div class="highlight"><pre>     <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;SIOCSIWSCAN(overlap??)--&gt;In scanning...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">//reject scan when re-associating!</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>send scan event to wpa_Supplicant</p></td><td class="code"><div class="highlight"><pre>  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
 <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;wireless_send_event---&gt;SIOCGIWSCAN(scan done)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
 <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
 <span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">BSSvClearBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>mike add: active scan OR passive scan OR desire_ssid scan</p></td><td class="code"><div class="highlight"><pre> <span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span><span class="p">))</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_SCAN_THIS_ESSID</span><span class="p">)</span>  <span class="p">{</span>                               <span class="c1">//desire_ssid scan</span>
       <span class="n">memset</span><span class="p">(</span><span class="n">abyScanSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
       <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">abyScanSSID</span><span class="p">;</span>
       <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
       <span class="n">memcpy</span><span class="p">(</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
         <span class="p">}</span>
	<span class="k">else</span>
	  <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">;</span>
	  <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_PASSIVE</span><span class="p">;</span>
         <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;SIOCSIWSCAN:[desired_ssid=%s,len=%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">abyScanSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
		 	                                                                                <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">abyScanSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span> <span class="n">abyScanSSID</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">IW_SCAN_TYPE_PASSIVE</span><span class="p">)</span> <span class="p">{</span>          <span class="c1">//passive scan</span>
       <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_PASSIVE</span><span class="p">;</span>
   <span class="p">}</span>
 <span class="p">}</span>
 <span class="k">else</span> <span class="p">{</span>           <span class="c1">//active scan</span>
     <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_ACTIVE</span><span class="p">;</span>
 <span class="p">}</span>

	 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_PASSIVE</span><span class="p">;</span>
	<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get scan results</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_giwscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">;</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">PKnownBSS</span>           <span class="n">pBSS</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SSID</span>       <span class="n">pItemSSID</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pSuppRates</span><span class="p">,</span> <span class="n">pExtSuppRates</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span> <span class="o">=</span> <span class="n">extra</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end_buf</span> <span class="o">=</span> <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_val</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_event</span> <span class="n">iwe</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ldBm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_WPA_IE_LEN</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">30</span><span class="p">];</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWSCAN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanState</span> <span class="o">==</span>  <span class="n">WMAC_IS_SCANNING</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>In scanning..</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pBSS</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">jj</span> <span class="o">&lt;</span> <span class="n">MAX_BSS_NUM</span> <span class="p">;</span> <span class="n">jj</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_ev</span> <span class="o">&gt;=</span> <span class="n">end_buf</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
        <span class="n">pBSS</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">jj</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">bActive</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>ADD mac address</p></td><td class="code"><div class="highlight"><pre>		    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		    <span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWAP</span><span class="p">;</span>
		    <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
                           <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span><span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>ADD ssid</p></td><td class="code"><div class="highlight"><pre>	             <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
                      <span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWESSID</span><span class="p">;</span>
                      <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">;</span>
                       <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
                       <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                      <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span><span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>ADD mode</p></td><td class="code"><div class="highlight"><pre>		    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		    <span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWMODE</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_CAP_INFO_ESS</span><span class="p">(</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))</span> <span class="p">{</span>
		        <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
		    <span class="p">}</span>
	        <span class="n">iwe</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IW_EV_UINT_LEN</span><span class="p">;</span>
                      <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>  <span class="n">IW_EV_UINT_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>ADD frequency</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">abySuppRates</span><span class="p">;</span>
            <span class="n">pExtSuppRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">abyExtSuppRates</span><span class="p">;</span>
            <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
           	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWFREQ</span><span class="p">;</span>
           	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">;</span>
           	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span><span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span>
			<span class="p">{</span>
			<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">uChannel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">f</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">frequency_list</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
                  <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span><span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>ADD quality</p></td><td class="code"><div class="highlight"><pre>            <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
	        <span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVQUAL</span><span class="p">;</span>
	        <span class="n">RFvRSSITodBm</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">uRSSI</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ldBm</span><span class="p">);</span>
		    <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">ldBm</span><span class="p">;</span>
	        <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="n">ldBm</span><span class="o">&lt;</span><span class="mi">50</span><span class="p">){</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span>  <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="n">ldBm</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="p">{</span>
				 <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">ldBm</span><span class="o">-</span><span class="mi">50</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="mi">40</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span><span class="o">=</span><span class="mi">7</span><span class="p">;</span>

                 <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_QUAL_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>ADD encryption</p></td><td class="code"><div class="highlight"><pre>            <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
            <span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWENCODE</span><span class="p">;</span>
            <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_CAP_INFO_PRIVACY</span><span class="p">(</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span><span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span><span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span>

            <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
            <span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWRATE</span><span class="p">;</span>
           	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      		<span class="n">current_val</span> <span class="o">=</span> <span class="n">current_ev</span> <span class="o">+</span> <span class="n">IW_EV_LCP_LEN</span><span class="p">;</span>

       		<span class="k">for</span> <span class="p">(</span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">kk</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="p">;</span> <span class="n">kk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		        <span class="k">if</span> <span class="p">(</span><span class="n">pSuppRates</span><span class="o">-&gt;</span><span class="n">abyRates</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			        <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Bit rate given in 500 kb/s units (+ 0x80)</p></td><td class="code"><div class="highlight"><pre>		        <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">pSuppRates</span><span class="o">-&gt;</span><span class="n">abyRates</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">);</span>
                          <span class="n">current_val</span> <span class="o">=</span> <span class="n">iwe_stream_add_value</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span> <span class="n">current_val</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_PARAM_LEN</span><span class="p">);</span>
	        <span class="p">}</span>
       		<span class="k">for</span> <span class="p">(</span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">kk</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">kk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		        <span class="k">if</span> <span class="p">(</span><span class="n">pExtSuppRates</span><span class="o">-&gt;</span><span class="n">abyRates</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			        <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Bit rate given in 500 kb/s units (+ 0x80)</p></td><td class="code"><div class="highlight"><pre>		        <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">pExtSuppRates</span><span class="o">-&gt;</span><span class="n">abyRates</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">);</span>
                         <span class="n">current_val</span> <span class="o">=</span> <span class="n">iwe_stream_add_value</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span> <span class="n">current_val</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_PARAM_LEN</span><span class="p">);</span>
	        <span class="p">}</span>

	        <span class="k">if</span><span class="p">((</span><span class="n">current_val</span> <span class="o">-</span> <span class="n">current_ev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IW_EV_LCP_LEN</span><span class="p">)</span>
		        <span class="n">current_ev</span> <span class="o">=</span> <span class="n">current_val</span><span class="p">;</span>

            <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
            <span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVCUSTOM</span><span class="p">;</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;bcn_int=%d&quot;</span><span class="p">,</span> <span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">wBeaconInterval</span><span class="p">);</span>
            <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
             <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">wWPALen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">wWPALen</span> <span class="o">&lt;=</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
                <span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
                <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">wWPALen</span><span class="p">;</span>
                <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">byWPAIE</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">wRSNLen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">wRSNLen</span> <span class="o">&lt;=</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
                <span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
                <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">wRSNLen</span><span class="p">;</span>
                <span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">byRSNIE</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">}</span><span class="c1">// for</span>

	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">current_ev</span> <span class="o">-</span> <span class="n">extra</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set frequence or channel</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_siwfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWFREQ </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>If setting by frequency, convert to a channel</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="mf">2.412e8</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="mf">2.487e8</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span><span class="p">((</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="n">frequency_list</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>
			<span class="n">c</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Setting by channel number</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
		<span class="k">if</span><span class="p">((</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: New channel value of %d is invalid!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Yes ! We can set it !!!</p></td><td class="code"><div class="highlight"><pre>              <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; Set to channel = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			  <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uChannel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get frequence or channel</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_giwfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWFREQ </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef WEXT_USECHANNELS</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">;</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">f</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		   <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">frequency_list</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set operation mode</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_siwmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="n">__u32</span> <span class="o">*</span><span class="n">wmode</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWMODE </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span> <span class="o">&amp;&amp;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostapd</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Can&#39;t set operation mode, hostapd is running </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">wmode</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">!=</span> <span class="n">WMAC_CONFIG_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">=</span> <span class="n">WMAC_CONFIG_IBSS_STA</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCommit</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
   		    <span class="p">}</span>
		<span class="p">}</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;set mode to ad-hoc </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_AUTO</span>:
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">!=</span> <span class="n">WMAC_CONFIG_ESS_STA</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">=</span> <span class="n">WMAC_CONFIG_ESS_STA</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCommit</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
   		    <span class="p">}</span>
		<span class="p">}</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;set mode to infrastructure </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_MASTER</span>:

        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">=</span> <span class="n">WMAC_CONFIG_ESS_STA</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">!=</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">=</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCommit</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
   		    <span class="p">}</span>
		<span class="p">}</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;set mode to Access Point </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_MODE_REPEAT</span>:
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">=</span> <span class="n">WMAC_CONFIG_ESS_STA</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get operation mode</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">iwctl_giwmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="n">__u32</span> <span class="o">*</span><span class="n">wmode</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWMODE </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>If not managed, assume it's ad-hoc</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMAC_CONFIG_ESS_STA</span>:
		<span class="o">*</span><span class="n">wmode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMAC_CONFIG_IBSS_STA</span>:
        <span class="o">*</span><span class="n">wmode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMAC_CONFIG_AUTO</span>:
		<span class="o">*</span><span class="n">wmode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMAC_CONFIG_AP</span>:
		<span class="o">*</span><span class="n">wmode</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">wmode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get capability range</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">iwctl_giwrange</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">;</span>
    <span class="n">BYTE</span> <span class="n">abySupportedRates</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">};</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWRANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">));</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_nwid</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_nwid</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Should be based on cap_rid.country to give only
 what the current card support</p></td><td class="code"><div class="highlight"><pre>		<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// List index</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">frequency_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="c1">// Values in table in MHz -&gt; * 10^5 * 10</span>
		<span class="p">}</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Hum... Should put the right values there</p></td><td class="code"><div class="highlight"><pre>                 <span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">abySupportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Set an indication of the max TCP throughput
in bit/s that we can expect using this interface.
 May be use for QoS stuff... Jean II</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

		<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_rts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_rts</span> <span class="o">=</span> <span class="mi">2312</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_frag</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_frag</span> <span class="o">=</span> <span class="mi">2312</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>the encoding capabilities</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>64(40) bits WEP</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>128(104) bits WEP</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>256 bits for WPA-PSK</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>4 keys are allowed</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">range</span><span class="o">-&gt;</span><span class="n">max_encoding_tokens</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	    <span class="n">range</span><span class="o">-&gt;</span><span class="n">enc_capa</span> <span class="o">=</span> <span class="n">IW_ENC_CAPA_WPA</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_WPA2</span> <span class="o">|</span>
		    <span class="n">IW_ENC_CAPA_CIPHER_TKIP</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_CIPHER_CCMP</span><span class="p">;</span>

		<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_pmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_pmp</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span><span class="c1">// 1 secs</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_pmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_pmt</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span><span class="c1">// 1 secs</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmp_flags</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmt_flags</span> <span class="o">=</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">pm_capa</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span> <span class="o">|</span> <span class="n">IW_POWER_TIMEOUT</span> <span class="o">|</span> <span class="n">IW_POWER_ALL_R</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Transmit Power - values are in mW</p></td><td class="code"><div class="highlight"><pre>        <span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_txpower</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower_capa</span> <span class="o">=</span> <span class="n">IW_TXPOW_MWATT</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="n">SUPPORTED_WIRELESS_EXT</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_capa</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">r_time_flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_retry</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_r_time</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_r_time</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Experimental measurements - boundary 11/5.5 Mb/s
Note : with or without the (local->rssi), results
 are somewhat different. - Jean II</p></td><td class="code"><div class="highlight"><pre>		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">176</span><span class="p">;</span>	<span class="c1">// -80 dBm</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set ap mac address</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_siwap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BYTE</span>                 <span class="n">ZeroBSSID</span><span class="p">[</span><span class="n">WLAN_BSSID_LEN</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">};</span>

   <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot; SIOCSIWAP </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>mike :add</p></td><td class="code"><div class="highlight"><pre>	 <span class="k">if</span> <span class="p">((</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">,</span> <span class="n">ZeroBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)){</span>
	      <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;SIOCSIWAP:invalid desired BSSID return!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
               <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
         <span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>mike add: if desired AP is hidden ssid(there are two same BSSID in list),
                 then ignore,because you don't known which one to be connect with??</p></td><td class="code"><div class="highlight"><pre>       	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">,</span> <span class="n">uSameBssidNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">abyBSSID</span><span class="p">,</span>
					     <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">uSameBssidNum</span><span class="o">++</span><span class="p">;</span>
                     <span class="p">}</span>
                  <span class="p">}</span>
	     <span class="k">if</span><span class="p">(</span><span class="n">uSameBssidNum</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//hit: desired AP is in hidden ssid mode!!!</span>
                 <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;SIOCSIWAP:ignore for desired AP in hidden mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	     <span class="p">}</span>
       	<span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCommit</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
   		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get ap mac address</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_giwap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWAP </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

 <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">!=</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">))</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
    <span class="p">}</span>

	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get ap list</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_giwaplist</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">sock</span><span class="p">[</span><span class="n">IW_MAX_AP</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iw_quality</span> <span class="n">qual</span><span class="p">[</span><span class="n">IW_MAX_AP</span><span class="p">];</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWAPLIST </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Only super-user can see AP list</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">PKnownBSS</span> <span class="n">pBSS</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jj</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">pBSS</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">bActive</span><span class="p">)</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">jj</span> <span class="o">&gt;=</span> <span class="n">IW_MAX_AP</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">sock</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">sock</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">level</span> <span class="o">=</span> <span class="n">pBSS</span><span class="o">-&gt;</span><span class="n">uRSSI</span><span class="p">;</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">qual</span> <span class="o">=</span> <span class="n">qual</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">jj</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Should be define&#39;d</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">jj</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set essid</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_siwessid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">PWLAN_IE_SSID</span>       <span class="n">pItemSSID</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWESSID :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

         <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fWPA_Authened</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Check if we asked for `any'</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Just send an empty SSID list</p></td><td class="code"><div class="highlight"><pre>		<span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                  <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
	    <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;set essid to &#39;any&#39; </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Unknown desired AP,so here need not associate??</p></td><td class="code"><div class="highlight"><pre>                  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Set the SSID</p></td><td class="code"><div class="highlight"><pre>		<span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">;</span>
        <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">byElementID</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">[</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
         <span class="p">}</span>
	<span class="k">else</span>
	  <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;set essid to %s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>mike:need clear desiredBSSID</p></td><td class="code"><div class="highlight"><pre>     <span class="k">if</span><span class="p">(</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>

<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Wext wil order another command of siwap to link with desired AP,
so here need not associate??</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPASuppWextEnabled</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>  <span class="p">{</span>
        <span class="cm">/*******search if  in hidden ssid mode ****/</span>
        <span class="p">{</span>
           <span class="n">PKnownBSS</span>       <span class="n">pCurr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
           <span class="n">BYTE</span>                   <span class="n">abyTmpDesireSSID</span><span class="p">[</span><span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">,</span> <span class="n">uSameBssidNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	  <span class="n">memcpy</span><span class="p">(</span><span class="n">abyTmpDesireSSID</span><span class="p">,</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">abyTmpDesireSSID</span><span class="p">));</span>
            <span class="n">pCurr</span> <span class="o">=</span> <span class="n">BSSpSearchBSSList</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                      <span class="nb">NULL</span><span class="p">,</span>
                                      <span class="n">abyTmpDesireSSID</span><span class="p">,</span>
                                      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span>
                                      <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pCurr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
               <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;SIOCSIWESSID:hidden ssid site survey before associate.......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="n">vResetCommandTimer</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">);</span>
	      <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_ACTIVE</span><span class="p">;</span>
	      <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
			       <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span>
			       <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
	      <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
			       <span class="n">WLAN_CMD_SSID</span><span class="p">,</span>
			       <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
          <span class="p">}</span>
	 <span class="k">else</span> <span class="p">{</span>  <span class="c1">//mike:to find out if that desired SSID is a hidden-ssid AP ,</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><pre><code>    by means of judging if there are two same BSSID exist in list ?
</code></pre></td><td class="code"><div class="highlight"><pre>                  <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">abyBSSID</span><span class="p">,</span>
					     <span class="n">pCurr</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">uSameBssidNum</span><span class="o">++</span><span class="p">;</span>
                     <span class="p">}</span>
                  <span class="p">}</span>
	     <span class="k">if</span><span class="p">(</span><span class="n">uSameBssidNum</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//hit: desired AP is in hidden ssid mode!!!</span>
                 <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;SIOCSIWESSID:hidden ssid directly associate.......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		 <span class="n">vResetCommandTimer</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">);</span>
	        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_PASSIVE</span><span class="p">;</span>          <span class="c1">//this scan type,you&#39;ll submit scan result!</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span>
				 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_SSID</span><span class="p">,</span>
				 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
	     <span class="p">}</span>
	 <span class="p">}</span>
        <span class="p">}</span>
     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
	     <span class="cp">#endif</span>

	    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;set essid = %s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">);</span>
	<span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCommit</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get essid</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iwctl_giwessid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
	<span class="n">PWLAN_IE_SSID</span>       <span class="n">pItemSSID</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWESSID </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Note : if wrq->u.data.flags != 0, we should
get the relevant SSID from the SSID list...</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Get the current SSID</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span> <span class="p">,</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">extra</span><span class="p">[</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

        <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// active</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set data rate</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_siwrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">brate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="n">abySupportedRates</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">};</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWRATE </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>First : get a valid bit rate value</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>Which type of value</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Setting by rate index
Find value in the magic rate table</p></td><td class="code"><div class="highlight"><pre>		<span class="n">brate</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Setting by frequency value</p></td><td class="code"><div class="highlight"><pre>		<span class="n">u8</span>	<span class="n">normvalue</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">/</span><span class="mi">500000</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Check if rate is valid</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">normvalue</span> <span class="o">==</span> <span class="n">abySupportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">brate</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>-1 designed the max rate (mostly auto mode)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>Get the highest available rate</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">abySupportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">brate</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>Check that it is valid
brate is index of abySupportedRates[]</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">brate</span> <span class="o">&gt;</span> <span class="mi">13</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Now, check if we want a fixed or auto value</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Fixed mode
One rate, fixed</p></td><td class="code"><div class="highlight"><pre>		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11B</span><span class="p">)</span><span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">brate</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">=</span> <span class="n">brate</span><span class="p">;</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Fixed to Rate %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">);</span>
        <span class="p">}</span>

	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
    <span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get data rate</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iwctl_giwrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWRATE </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">{</span>
        <span class="n">BYTE</span> <span class="n">abySupportedRates</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">};</span>
	    <span class="kt">int</span> <span class="n">brate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">brate</span> <span class="o">=</span> <span class="n">abySupportedRates</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">];</span>
	    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11B</span><span class="p">)</span>
	            <span class="n">brate</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11G</span><span class="p">)</span>
	            <span class="n">brate</span> <span class="o">=</span> <span class="mh">0x6C</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span>
	            <span class="n">brate</span> <span class="o">=</span> <span class="mh">0x6C</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11B</span><span class="p">)</span>
	            <span class="n">brate</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11G</span><span class="p">)</span>
	            <span class="n">brate</span> <span class="o">=</span> <span class="mh">0x6C</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span>
	            <span class="n">brate</span> <span class="o">=</span> <span class="mh">0x6C</span><span class="p">;</span>
	    <span class="p">}</span>
    		<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
                <span class="n">brate</span> <span class="o">=</span> <span class="n">abySupportedRates</span><span class="p">[</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span><span class="p">];</span>
	    <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">brate</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>If more than one rate, set auto</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
	        <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set rts threshold</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwctl_siwrts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span> <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">2312</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wRTSThreshold</span> <span class="o">=</span> <span class="mi">2312</span><span class="p">;</span>

	<span class="k">else</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wRTSThreshold</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get rts</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_giwrts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWRTS </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wRTSThreshold</span><span class="p">;</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">2312</span><span class="p">);</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set fragment threshold</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_siwfrag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fthr</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWFRAG </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">fthr</span> <span class="o">=</span> <span class="mi">2312</span><span class="p">;</span>
    <span class="k">if</span><span class="p">((</span><span class="n">fthr</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fthr</span> <span class="o">&gt;</span> <span class="mi">2312</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
		 <span class="n">fthr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>	<span class="c1">// Get an even value</span>
	     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wFragmentationThreshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">fthr</span><span class="p">;</span>
    <span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get fragment threshold</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">iwctl_giwfrag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWFRAG </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wFragmentationThreshold</span><span class="p">;</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">2312</span><span class="p">);</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set retry threshold</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwctl_siwretry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWRETRY </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_MAX</span><span class="p">)</span>
			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLongRetryLimit</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_MIN</span><span class="p">)</span>
			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortRetryLimit</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>No modifier : set both</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortRetryLimit</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLongRetryLimit</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wMaxTransmitMSDULifetime</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get retry threshold</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwctl_giwretry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWRETRY </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="c1">// Can&#39;t be disabled</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Note : by default, display the min retry number</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wMaxTransmitMSDULifetime</span><span class="p">;</span> <span class="c1">//ms</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_MAX</span><span class="p">;</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLongRetryLimit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortRetryLimit</span><span class="p">;</span>
		<span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortRetryLimit</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLongRetryLimit</span><span class="p">)</span>
			<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_RETRY_MIN</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set encode mode</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwctl_siwencode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
	<span class="n">DWORD</span> <span class="n">dwKeyIndex</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ii</span><span class="p">,</span><span class="n">uu</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">);</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWENCODE </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Check the size of the key</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwKeyIndex</span> <span class="o">&gt;</span> <span class="n">WLAN_WEP_NKEYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dwKeyIndex</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dwKeyIndex</span><span class="o">--</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Send the key to the card</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span>  <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Set 232 bit wep key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span>  <span class="n">WLAN_WEP104_KEYLEN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Set 104 bit wep key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="n">WLAN_WEP40_KEYLEN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Set 40 bit wep key, index= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dwKeyIndex</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;abyKey: &quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
            <span class="n">KeybSetDefaultKey</span><span class="p">(</span>  <span class="n">pDevice</span><span class="p">,</span>
                                <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span>
                                <span class="n">dwKeyIndex</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">),</span>
                                <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
                                <span class="nb">NULL</span><span class="p">,</span>
                                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>
                                <span class="n">KEY_CTL_WEP</span>
                              <span class="p">);</span>
            <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span><span class="n">dwKeyIndex</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uKeyLength</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTransmitKey</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>Do we want to just set the transmit key index ?</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>
		    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_MODE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Read the flags</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">){</span>

        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Disable WEP function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">uu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uu</span> <span class="o">&lt;</span> <span class="n">MAX_KEY_TABLE</span><span class="p">;</span> <span class="n">uu</span><span class="o">++</span><span class="p">)</span>
		<span class="n">MACvDisableKeyEntry</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">uu</span><span class="p">);</span>
            <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Enable WEP &amp; ShareKey System</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Enable WEP &amp; Open System</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
	   <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwctl_giwencode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>			<span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">PSMgmtObject</span>		<span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">abyKey</span><span class="p">[</span><span class="n">WLAN_WEP232_KEYLEN</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">);</span>
	<span class="n">PSKeyItem</span>	<span class="n">pKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWENCODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">WLAN_WEP_NKEYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span>	<span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">){</span><span class="c1">//get default key</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span><span class="o">&lt;</span><span class="n">WLAN_WEP_NKEYS</span><span class="p">){</span>
			<span class="n">index</span><span class="o">=</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span><span class="p">;</span>
         	<span class="p">}</span> <span class="k">else</span>
                      <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span>
             <span class="n">index</span><span class="o">--</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">abyKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>Check encryption mode</p></td><td class="code"><div class="highlight"><pre>	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Is WEP enabled ???</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span><span class="p">)</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>  <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>  <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span><span class="p">)</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>  <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>  <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">index</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="o">||</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">==</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">)){</span><span class="c1">//get wpa pairwise  key</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">KeybGetKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pKey</span><span class="p">)){</span>
			   <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">;</span>
				  <span class="n">memcpy</span><span class="p">(</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>	<span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">);</span>
				  <span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span>  <span class="n">abyKey</span><span class="p">,</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">);</span>
			   <span class="p">}</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">KeybGetKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span><span class="n">index</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">pKey</span><span class="p">)){</span>
			<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>  <span class="n">pKey</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span>  <span class="n">abyKey</span><span class="p">,</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set power mode</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwctl_siwpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>            <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWPOWER </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span> <span class="p">{</span>
		 <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		 <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ePSMode</span> <span class="o">=</span> <span class="n">WMAC_POWER_CAM</span><span class="p">;</span>
		<span class="n">PSvDisablePowerSaving</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ePSMode</span> <span class="o">=</span> <span class="n">WMAC_POWER_FAST</span><span class="p">;</span>
	 <span class="n">PSvEnablePowerSaving</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_POWER_PERIOD</span><span class="p">)</span> <span class="p">{</span>
	     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ePSMode</span> <span class="o">=</span> <span class="n">WMAC_POWER_FAST</span><span class="p">;</span>
	     <span class="n">PSvEnablePowerSaving</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_MODE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_POWER_UNICAST_R</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWPOWER: IW_POWER_UNICAST_R </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_POWER_ALL_R</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWPOWER: IW_POWER_ALL_R </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_POWER_ON</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWPOWER: IW_POWER_ON </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get power mode</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwctl_giwpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>            <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ePSMode</span><span class="p">;</span>


    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWPOWER </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WMAC_POWER_CAM</span><span class="p">)))</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span> <span class="o">*</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wListenInterval</span> <span class="o">*</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wCurrBeaconPeriod</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_POWER_ALL_R</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Sensitivity</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwctl_giwsens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">long</span> <span class="n">ldBm</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWSENS </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RFvRSSITodBm</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrRSSI</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ldBm</span><span class="p">);</span>
	    <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ldBm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
	    <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>

<span class="kt">int</span> <span class="nf">iwctl_siwauth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>			<span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">PSMgmtObject</span>	<span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">wpa_version</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>  <span class="c1">//must be static to save the last value,einsn liu</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">pairwise</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWAUTH </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
		<span class="n">wpa_version</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">IW_AUTH_WPA_VERSION_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		       <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;iwctl_siwauth:set WPADEV to disable at 1??????</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">IW_AUTH_WPA_VERSION_WPA</span><span class="p">)</span> <span class="p">{</span>
                          <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;iwctl_siwauth:set WPADEV to WPA1******</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
                          <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;iwctl_siwauth:set WPADEV to WPA2******</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
		<span class="n">pairwise</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
                   <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;iwctl_siwauth:set pairwise=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pairwise</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pairwise</span> <span class="o">==</span> <span class="n">IW_AUTH_CIPHER_CCMP</span><span class="p">){</span>
			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pairwise</span> <span class="o">==</span> <span class="n">IW_AUTH_CIPHER_TKIP</span><span class="p">){</span>
			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pairwise</span> <span class="o">==</span> <span class="n">IW_AUTH_CIPHER_WEP40</span> <span class="o">||</span>
			   <span class="n">pairwise</span> <span class="o">==</span> <span class="n">IW_AUTH_CIPHER_WEP104</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pairwise</span> <span class="o">==</span> <span class="n">IW_AUTH_CIPHER_NONE</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>do nothing,einsn liu</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span><span class="k">else</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
		 <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;iwctl_siwauth:set GROUP=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">wpa_version</span> <span class="o">==</span> <span class="n">IW_AUTH_WPA_VERSION_DISABLED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pairwise</span> <span class="o">==</span> <span class="n">IW_AUTH_CIPHER_NONE</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">IW_AUTH_CIPHER_CCMP</span><span class="p">){</span>
				<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
				<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
                    <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;iwctl_siwauth(wpa_version=%d):set KEY_MGMT=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">wpa_version</span><span class="p">,</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">wpa_version</span> <span class="o">==</span> <span class="n">IW_AUTH_WPA_VERSION_WPA2</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">IW_AUTH_KEY_MGMT_PSK</span><span class="p">)</span>
				<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="n">WMAC_AUTH_WPA2PSK</span><span class="p">;</span>
			<span class="k">else</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">wpa_version</span> <span class="o">==</span> <span class="n">IW_AUTH_WPA_VERSION_WPA</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
				<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="n">WMAC_AUTH_WPANONE</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">IW_AUTH_KEY_MGMT_PSK</span><span class="p">)</span>
				<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="n">WMAC_AUTH_WPAPSK</span><span class="p">;</span>
			<span class="k">else</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="n">WMAC_AUTH_WPA</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="k">break</span><span class="p">;</span>		<span class="cm">/* FIXME */</span>
	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		 <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;iwctl_siwauth:set AUTH_ALG=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">==</span><span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">){</span>
			<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">==</span><span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">){</span>
			<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span><span class="o">=</span><span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_ROAMING_CONTROL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">=</span> <span class="o">!!</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">){</span>
			<span class="n">wpa_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pairwise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span>
			<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="n">WMAC_AUTH_OPEN</span><span class="p">;</span>
			 <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;iwctl_siwauth:set WPADEV to disaable at 2?????</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">iwctl_giwauth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">iwctl_siwgenie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>			<span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">PSMgmtObject</span>	<span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">extra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">){</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyWPAIE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyWPAIE</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)){</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyWPAIE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">);</span>
		<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">out:</span><span class="c1">//not completely ...not necessary in wpa_supplicant 0.5.8</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwctl_giwgenie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>			<span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">PSMgmtObject</span>	<span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">space</span> <span class="o">=</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span> <span class="o">&lt;=</span> <span class="n">space</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyWPAIE</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">wWPAIELen</span><span class="p">)){</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span><span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">iwctl_siwencodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>	<span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">viawget_wpa_param</span> <span class="o">*</span><span class="n">param</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>original member</p></td><td class="code"><div class="highlight"><pre>    <span class="n">wpa_alg</span> <span class="n">alg_name</span><span class="p">;</span>
    <span class="n">u8</span>  <span class="n">addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">set_tx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">u8</span>  <span class="n">seq</span><span class="p">[</span><span class="n">IW_ENCODE_SEQ_MAX_SIZE</span><span class="p">];</span>
    <span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="kt">size_t</span> <span class="n">seq_len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">key_len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">blen</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">key_array</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;SIOCSIWENCODEEXT...... </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">blen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">);</span>
<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">blen</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">viawget_wpa_param</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>recover alg_name</p></td><td class="code"><div class="highlight"><pre><span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">IW_ENCODE_ALG_NONE</span>:
                  <span class="n">alg_name</span> <span class="o">=</span> <span class="n">WPA_ALG_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IW_ENCODE_ALG_WEP</span>:
                  <span class="n">alg_name</span> <span class="o">=</span> <span class="n">WPA_ALG_WEP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IW_ENCODE_ALG_TKIP</span>:
                  <span class="n">alg_name</span> <span class="o">=</span> <span class="n">WPA_ALG_TKIP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IW_ENCODE_ALG_CCMP</span>:
                  <span class="n">alg_name</span> <span class="o">=</span> <span class="n">WPA_ALG_CCMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
		<span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;Unknown alg = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">);</span>
		<span class="n">ret</span><span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>recover addr</p></td><td class="code"><div class="highlight"><pre> <span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>recover key_idx</p></td><td class="code"><div class="highlight"><pre>  <span class="n">key_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>recover set_tx</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">)</span>
   <span class="n">set_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>recover seq,seq_len</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_RX_SEQ_VALID</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">seq_len</span><span class="o">=</span><span class="n">IW_ENCODE_SEQ_MAX_SIZE</span><span class="p">;</span>
   <span class="n">memcpy</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">rx_seq</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>recover key,key_len</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">key_len</span><span class="o">=</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="p">}</span>

<span class="n">memset</span><span class="p">(</span><span class="n">key_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">memcpy</span><span class="p">(</span><span class="n">key_array</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>notice ! the oder</p></td><td class="code"><div class="highlight"><pre>	  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_array</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
	  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_array</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/**************Translate iw_encode_ext to viawget_wpa_param****************/</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">alg_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">alg_name</span><span class="p">;</span>
<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">set_tx</span> <span class="o">=</span> <span class="n">set_tx</span><span class="p">;</span>
<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">key_index</span> <span class="o">=</span> <span class="n">key_idx</span><span class="p">;</span>
<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">key_len</span><span class="p">;</span>
<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">key_array</span><span class="p">;</span>
<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">seq</span><span class="p">;</span>
<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="n">seq_len</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p><strong><em>*set if current action is Network Manager count??
*</em></strong>this method is so foolish,but there is no other way???</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">alg_name</span> <span class="o">==</span> <span class="n">WPA_ALG_NONE</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">key_index</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep0</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
   <span class="k">if</span><span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep0</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">key_index</span> <span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep0</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep1</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
   <span class="k">if</span><span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep1</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">key_index</span> <span class="o">==</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep1</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep2</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
   <span class="k">if</span><span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep2</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_key</span><span class="p">.</span><span class="n">key_index</span> <span class="o">==</span><span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep2</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep3</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
		 <span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep3</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;SIOCSIWENCODEEXT:Enable WPA WEXT SUPPORT!!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep0</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep1</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep2</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep3</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPASuppWextEnabled</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
     <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireBSSID</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
     <span class="n">KeyvInitTable</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">);</span>
		 <span class="p">}</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre>		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
 <span class="n">ret</span> <span class="o">=</span> <span class="n">wpa_set_keys</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">error:</span>
<span class="n">kfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">iwctl_giwencodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwctl_siwmlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span>			<span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">PSMgmtObject</span>	<span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)){</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">IW_MLME_DEAUTH</span>:
	<span class="k">case</span> <span class="n">IW_MLME_DISASSOC</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">){</span>
		  <span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;iwctl_siwmlme---&gt;send DISASSOCIATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		  <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				   <span class="n">WLAN_CMD_DISASSOCIATE</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span>		<span class="n">iwctl_handler</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>      <span class="cm">/* SIOCSIWCOMMIT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>      <span class="c1">// SIOCGIWNAME</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="c1">// SIOCSIWNWID</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="c1">// SIOCGIWNWID</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWFREQ</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWFREQ</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWMODE</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWMODE</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		        <span class="c1">// SIOCSIWSENS</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		        <span class="c1">// SIOCGIWSENS</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> 		        <span class="c1">// SIOCSIWRANGE</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">iwctl_giwrange</span><span class="p">,</span>		<span class="c1">// SIOCGIWRANGE</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>         		    <span class="c1">// SIOCSIWPRIV</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>             		<span class="c1">// SIOCGIWPRIV</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>             		<span class="c1">// SIOCSIWSTATS</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>                  <span class="c1">// SIOCGIWSTATS</span>
    <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>                  <span class="c1">// SIOCSIWSPY</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		            <span class="c1">// SIOCGIWSPY</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				    <span class="c1">// -- hole --</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				    <span class="c1">// -- hole --</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		    <span class="c1">// SIOCSIWAP</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		    <span class="c1">// SIOCGIWAP</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				    <span class="c1">// -- hole -- 0x16</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>       <span class="c1">// SIOCGIWAPLIST</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">iwctl_siwscan</span><span class="p">,</span>         <span class="c1">// SIOCSIWSCAN</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">iwctl_giwscan</span><span class="p">,</span>         <span class="c1">// SIOCGIWSCAN</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWESSID</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWESSID</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWNICKN</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWNICKN</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// -- hole --</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// -- hole --</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWRATE 0x20</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWRATE</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWRTS</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWRTS</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWFRAG</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWFRAG</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWTXPOW</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWTXPOW</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWRETRY</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWRETRY</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWENCODE</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWENCODE</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWPOWER</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWPOWER</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="c1">// -- hole --</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="c1">// -- hole --</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="c1">// SIOCSIWGENIE</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="c1">// SIOCGIWGENIE</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWAUTH</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWAUTH</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCSIWENCODEEXT</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="c1">// SIOCGIWENCODEEXT</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="c1">// SIOCSIWPMKSA</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="c1">// -- hole --</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span>		<span class="n">iwctl_private_handler</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="c1">// SIOCIWFIRSTPRIV</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">iwctl_private_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="n">IOCTL_CMD_SET</span><span class="p">,</span>
  <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s">&quot;set&quot;</span><span class="p">},</span>
<span class="p">};</span>



<span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span>	<span class="n">iwctl_handler_def</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iwctl_get_wireless_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_standard</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwctl_handler</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">iw_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">standard</span>	<span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span> <span class="o">*</span><span class="p">)</span> <span class="n">iwctl_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
