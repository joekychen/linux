<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6656 › bssdb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bssdb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * File: bssdb.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Handles the Basic Service Set &amp; Node Database functions</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *      BSSpSearchBSSList - Search known BSS list for Desire SSID or BSSID</span>
<span class="cm"> *      BSSvClearBSSList - Clear BSS List</span>
<span class="cm"> *      BSSbInsertToBSSList - Insert a BSS set into known BSS list</span>
<span class="cm"> *      BSSbUpdateToBSSList - Update BSS set in known BSS list</span>
<span class="cm"> *      BSSbIsSTAInNodeDB - Search Node DB table to find the index of matched DstAddr</span>
<span class="cm"> *      BSSvCreateOneNode - Allocate an Node for Node DB</span>
<span class="cm"> *      BSSvUpdateAPNode - Update AP Node content in Index 0 of KnownNodeDB</span>
<span class="cm"> *      BSSvSecondCallBack - One second timer callback function to update Node DB info &amp; AP link status</span>
<span class="cm"> *      BSSvUpdateNodeTxCounter - Update Tx attemps, Tx failure counter in Node DB for auto-fall back rate control</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Lyndon Chen</span>
<span class="cm"> *</span>
<span class="cm"> * Date: July 17, 2002</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ttype.h&quot;</span>
<span class="cp">#include &quot;tmacro.h&quot;</span>
<span class="cp">#include &quot;tether.h&quot;</span>
<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;80211hdr.h&quot;</span>
<span class="cp">#include &quot;bssdb.h&quot;</span>
<span class="cp">#include &quot;wmgr.h&quot;</span>
<span class="cp">#include &quot;datarate.h&quot;</span>
<span class="cp">#include &quot;desc.h&quot;</span>
<span class="cp">#include &quot;wcmd.h&quot;</span>
<span class="cp">#include &quot;wpa.h&quot;</span>
<span class="cp">#include &quot;baseband.h&quot;</span>
<span class="cp">#include &quot;rf.h&quot;</span>
<span class="cp">#include &quot;card.h&quot;</span>
<span class="cp">#include &quot;mac.h&quot;</span>
<span class="cp">#include &quot;wpa2.h&quot;</span>
<span class="cp">#include &quot;control.h&quot;</span>
<span class="cp">#include &quot;rndis.h&quot;</span>
<span class="cp">#include &quot;iowpa.h&quot;</span>

<span class="cm">/*---------------------  Static Definitions -------------------------*/</span>




<span class="cm">/*---------------------  Static Classes  ----------------------------*/</span>

<span class="cm">/*---------------------  Static Variables  --------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span><span class="n">MSG_LEVEL_INFO</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>static int          msglevel                =MSG<em>LEVEL</em>DEBUG;</p></td><td class="code"><div class="highlight"><pre><span class="k">const</span> <span class="n">WORD</span>             <span class="n">awHWRetry0</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                            <span class="p">{</span><span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">},</span>
                                            <span class="p">{</span><span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">},</span>
                                            <span class="p">{</span><span class="n">RATE_36M</span><span class="p">,</span> <span class="n">RATE_36M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">},</span>
                                            <span class="p">{</span><span class="n">RATE_48M</span><span class="p">,</span> <span class="n">RATE_48M</span><span class="p">,</span> <span class="n">RATE_36M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">},</span>
                                            <span class="p">{</span><span class="n">RATE_54M</span><span class="p">,</span> <span class="n">RATE_54M</span><span class="p">,</span> <span class="n">RATE_48M</span><span class="p">,</span> <span class="n">RATE_36M</span><span class="p">,</span> <span class="n">RATE_36M</span><span class="p">}</span>
                                           <span class="p">};</span>
<span class="k">const</span> <span class="n">WORD</span>             <span class="n">awHWRetry1</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                            <span class="p">{</span><span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_6M</span><span class="p">,</span> <span class="n">RATE_6M</span><span class="p">},</span>
                                            <span class="p">{</span><span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_6M</span><span class="p">,</span> <span class="n">RATE_6M</span><span class="p">},</span>
                                            <span class="p">{</span><span class="n">RATE_36M</span><span class="p">,</span> <span class="n">RATE_36M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">},</span>
                                            <span class="p">{</span><span class="n">RATE_48M</span><span class="p">,</span> <span class="n">RATE_48M</span><span class="p">,</span> <span class="n">RATE_24M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">,</span> <span class="n">RATE_12M</span><span class="p">},</span>
                                            <span class="p">{</span><span class="n">RATE_54M</span><span class="p">,</span> <span class="n">RATE_54M</span><span class="p">,</span> <span class="n">RATE_36M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">,</span> <span class="n">RATE_18M</span><span class="p">}</span>
                                           <span class="p">};</span>



<span class="cm">/*---------------------  Static Functions  --------------------------*/</span>

<span class="kt">void</span> <span class="n">s_vCheckSensitivity</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">s_vCheckPreEDThreshold</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">s_uCalculateLinkQual</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">);</span>

<span class="cm">/*---------------------  Export Variables  --------------------------*/</span>


<span class="cm">/*---------------------  Export Functions  --------------------------*/</span>





<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Search known BSS list for Desire SSID or BSSID.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    PTR to KnownBSS or NULL</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="n">PKnownBSS</span> <span class="nf">BSSpSearchBSSList</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
			    <span class="n">PBYTE</span> <span class="n">pbyDesireBSSID</span><span class="p">,</span>
			    <span class="n">PBYTE</span> <span class="n">pbyDesireSSID</span><span class="p">,</span>
			    <span class="n">CARD_PHY_TYPE</span> <span class="n">ePhyType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">PBYTE</span>           <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SSID</span>   <span class="n">pSSID</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PKnownBSS</span>       <span class="n">pCurrBSS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PKnownBSS</span>       <span class="n">pSelect</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">BYTE</span>                 <span class="n">ZeroBSSID</span><span class="p">[</span><span class="n">WLAN_BSSID_LEN</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pbyDesireBSSID</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;BSSpSearchBSSList BSSID[%02X %02X %02X-%02X %02X %02X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">pbyDesireBSSID</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">pbyDesireBSSID</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="o">*</span><span class="p">(</span><span class="n">pbyDesireBSSID</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span>
                            <span class="o">*</span><span class="p">(</span><span class="n">pbyDesireBSSID</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span><span class="o">*</span><span class="p">(</span><span class="n">pbyDesireBSSID</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span><span class="o">*</span><span class="p">(</span><span class="n">pbyDesireBSSID</span><span class="o">+</span><span class="mi">5</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">pbyDesireBSSID</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pbyDesireBSSID</span><span class="p">,</span> <span class="n">ZeroBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">!=</span> <span class="mi">0</span><span class="p">)){</span>
            <span class="n">pbyBSSID</span> <span class="o">=</span> <span class="n">pbyDesireBSSID</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pbyDesireSSID</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pbyDesireSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span> <span class="n">pbyDesireSSID</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pbyBSSID</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>match BSSID first</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span><span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pCurrBSS</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>

	   <span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">bSelected</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">bActive</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">bSelected</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">))</span> <span class="p">{</span>
		    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">pbyBSSID</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pSSID</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>compare ssid</p></td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                            <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                            <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AUTO</span><span class="p">)</span> <span class="o">||</span>
                                <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">WLAN_GET_CAP_INFO_IBSS</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))</span> <span class="o">||</span>
                                <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">WLAN_GET_CAP_INFO_ESS</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))</span>
                                <span class="p">)</span> <span class="p">{</span>
                                <span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">bSelected</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                                <span class="k">return</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AUTO</span><span class="p">)</span> <span class="o">||</span>
                            <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">WLAN_GET_CAP_INFO_IBSS</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))</span> <span class="o">||</span>
                            <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">WLAN_GET_CAP_INFO_ESS</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))</span>
                            <span class="p">)</span> <span class="p">{</span>
                            <span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">bSelected</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                            <span class="k">return</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>ignore BSSID</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span><span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pCurrBSS</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>2007-0721-01<Mark>by MikeLiu
  if ((pCurrBSS->bActive) &amp;&amp;
      (pCurrBSS->bSelected == FALSE)) {</p></td><td class="code"><div class="highlight"><pre>	  <span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">bSelected</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">bActive</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">pSSID</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>matched SSID</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                        <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                        <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span>
                        <span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>SSID not match skip this BSS</p></td><td class="code"><div class="highlight"><pre>                        <span class="k">continue</span><span class="p">;</span>
                      <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">WLAN_GET_CAP_INFO_ESS</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))</span> <span class="o">||</span>
                    <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">WLAN_GET_CAP_INFO_IBSS</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">))</span>
                    <span class="p">){</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Type not match skip this BSS</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;BSS type mismatch.... Config[%d] BSS[0x%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span><span class="p">,</span> <span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">wCapInfo</span><span class="p">);</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">ePhyType</span> <span class="o">!=</span> <span class="n">PHY_TYPE_AUTO</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(((</span><span class="n">ePhyType</span> <span class="o">==</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">PHY_TYPE_11A</span> <span class="o">!=</span> <span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span><span class="p">))</span> <span class="o">||</span>
                        <span class="p">((</span><span class="n">ePhyType</span> <span class="o">!=</span> <span class="n">PHY_TYPE_11A</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">PHY_TYPE_11A</span> <span class="o">==</span> <span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>PhyType not match skip this BSS</p></td><td class="code"><div class="highlight"><pre>                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Physical type mismatch.... ePhyType[%d] BSS[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ePhyType</span><span class="p">,</span> <span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span><span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pSameBSS</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">uChannel</span> <span class="o">=</span> <span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;BSSpSearchBSSList pSelect1[%02X %02X %02X-%02X %02X %02X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="o">*</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span><span class="o">*</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span><span class="o">*</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span><span class="o">*</span><span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="o">+</span><span class="mi">5</span><span class="p">));</span>
        <span class="n">jj</span><span class="o">++</span><span class="p">;</span>


                <span class="k">if</span> <span class="p">(</span><span class="n">pSelect</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pSelect</span> <span class="o">=</span> <span class="n">pCurrBSS</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>compare RSSI, select signal strong one</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">uRSSI</span> <span class="o">&lt;</span> <span class="n">pSelect</span><span class="o">-&gt;</span><span class="n">uRSSI</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pSelect</span> <span class="o">=</span> <span class="n">pCurrBSS</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bSameBSSMaxNum</span> <span class="o">=</span> <span class="n">jj</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pSelect</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pSelect</span><span class="o">-&gt;</span><span class="n">bSelected</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>  <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><pre><code>  Einsn Add @20070907
</code></pre></td><td class="code"><div class="highlight"><pre>				<span class="n">memset</span><span class="p">(</span><span class="n">pbyDesireSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pbyDesireSSID</span><span class="p">,</span><span class="n">pCurrBSS</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span><span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
                                                <span class="p">}</span>

            <span class="k">return</span><span class="p">(</span><span class="n">pSelect</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Clear BSS List</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>


<span class="kt">void</span> <span class="nf">BSSvClearBSSList</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span> <span class="n">BOOL</span> <span class="n">bKeepCurrBSSID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bKeepCurrBSSID</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">abyBSSID</span><span class="p">,</span>
				    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>mike mark: there are two same BSSID in list if that AP is in hidden ssid mode,one 's SSID is null,
                but other's is obvious, so if it acssociate with your STA  exactly,you must keep two
                of them!!!!!!!!!
bKeepCurrBSSID = FALSE;</p></td><td class="code"><div class="highlight"><pre>                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

	<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KnownBSS</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">BSSvClearAnyBSSJoinRecord</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    search BSS list by BSSID &amp; SSID if matched</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    TRUE if found.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="n">PKnownBSS</span> <span class="nf">BSSpAddrIsInBSSList</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
			      <span class="n">PBYTE</span> <span class="n">abyBSSID</span><span class="p">,</span>
			      <span class="n">PWLAN_IE_SSID</span> <span class="n">pSSID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">PKnownBSS</span>       <span class="n">pBSSList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pBSSList</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">bActive</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">abyBSSID</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">){</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                            <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span>
                            <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">pBSSList</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">};</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Insert a BSS set into known BSS list</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    TRUE if success.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="n">BOOL</span> <span class="nf">BSSbInsertToBSSList</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
			 <span class="n">PBYTE</span> <span class="n">abyBSSIDAddr</span><span class="p">,</span>
			 <span class="n">QWORD</span> <span class="n">qwTimestamp</span><span class="p">,</span>
			 <span class="n">WORD</span> <span class="n">wBeaconInterval</span><span class="p">,</span>
			 <span class="n">WORD</span> <span class="n">wCapInfo</span><span class="p">,</span>
			 <span class="n">BYTE</span> <span class="n">byCurrChannel</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_SSID</span> <span class="n">pSSID</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pSuppRates</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pExtSuppRates</span><span class="p">,</span>
			 <span class="n">PERPObject</span> <span class="n">psERP</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_RSN</span> <span class="n">pRSN</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_RSN_EXT</span> <span class="n">pRSNWPA</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_COUNTRY</span> <span class="n">pIE_Country</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_QUIET</span> <span class="n">pIE_Quiet</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uIELength</span><span class="p">,</span>
			 <span class="n">PBYTE</span> <span class="n">pbyIEs</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">pRxPacketContext</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">PSRxMgmtPacket</span>  <span class="n">pRxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRxMgmtPacket</span><span class="p">)</span><span class="n">pRxPacketContext</span><span class="p">;</span>
    <span class="n">PKnownBSS</span>       <span class="n">pBSSList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bParsingQuiet</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>



    <span class="n">pBSSList</span> <span class="o">=</span> <span class="p">(</span><span class="n">PKnownBSS</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pBSSList</span> <span class="o">=</span> <span class="p">(</span><span class="n">PKnownBSS</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">bActive</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="n">MAX_BSS_NUM</span><span class="p">){</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Get free KnowBSS node failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>save the BSS info</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">bActive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">abyBSSIDAddr</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
    <span class="n">HIDWORD</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">qwBSSTimestamp</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">));</span>
    <span class="n">LODWORD</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">qwBSSTimestamp</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">));</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wBeaconInterval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wBeaconInterval</span><span class="p">);</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wCapInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCapInfo</span><span class="p">);</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uClearCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">)</span>
        <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="n">pSSID</span><span class="p">,</span> <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>

    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uChannel</span> <span class="o">=</span> <span class="n">byCurrChannel</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">WLAN_RATES_MAXLEN</span><span class="p">)</span>
        <span class="n">pSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abySuppRates</span><span class="p">,</span> <span class="n">pSuppRates</span><span class="p">,</span> <span class="n">pSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pExtSuppRates</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">WLAN_RATES_MAXLEN</span><span class="p">)</span>
            <span class="n">pExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyExtSuppRates</span><span class="p">,</span> <span class="n">pExtSuppRates</span><span class="p">,</span> <span class="n">pExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;BSSbInsertToBSSList: pExtSuppRates-&gt;len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyExtSuppRates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">sERP</span><span class="p">.</span><span class="n">byERP</span> <span class="o">=</span> <span class="n">psERP</span><span class="o">-&gt;</span><span class="n">byERP</span><span class="p">;</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span> <span class="o">=</span> <span class="n">psERP</span><span class="o">-&gt;</span><span class="n">bERPExist</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Check if BSS is 802.11a/b/g</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uChannel</span> <span class="o">&gt;</span> <span class="n">CB_MAX_CHANNEL_24G</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">=</span> <span class="n">PHY_TYPE_11A</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">=</span> <span class="n">PHY_TYPE_11G</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">=</span> <span class="n">PHY_TYPE_11B</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byRxRate</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxRate</span><span class="p">;</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span><span class="p">;</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uRSSI</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">uRSSI</span><span class="p">;</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">bySQ</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">bySQ</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>assoc with BSS</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span> <span class="o">==</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bParsingQuiet</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">WPA_ClearRSN</span><span class="p">(</span><span class="n">pBSSList</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pRSNWPA</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uLen</span> <span class="o">=</span> <span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uLen</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">uIELength</span> <span class="o">-</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span> <span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span> <span class="n">pRSNWPA</span> <span class="o">-</span> <span class="n">pbyIEs</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wWPALen</span> <span class="o">=</span> <span class="n">uLen</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byWPAIE</span><span class="p">,</span> <span class="n">pRSNWPA</span><span class="p">,</span> <span class="n">uLen</span><span class="p">);</span>
		<span class="n">WPA_ParseRSN</span><span class="p">(</span><span class="n">pBSSList</span><span class="p">,</span> <span class="n">pRSNWPA</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">WPA2_ClearRSN</span><span class="p">(</span><span class="n">pBSSList</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pRSN</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uLen</span> <span class="o">=</span> <span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uLen</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">uIELength</span> <span class="o">-</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span> <span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span> <span class="n">pRSN</span> <span class="o">-</span> <span class="n">pbyIEs</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wRSNLen</span> <span class="o">=</span> <span class="n">uLen</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byRSNIE</span><span class="p">,</span> <span class="n">pRSN</span><span class="p">,</span> <span class="n">uLen</span><span class="p">);</span>
		<span class="n">WPA2vParseRSN</span><span class="p">(</span><span class="n">pBSSList</span><span class="p">,</span> <span class="n">pRSN</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eAuthenMode</span> <span class="o">==</span> <span class="n">WMAC_AUTH_WPA2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">bWPA2Valid</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

        <span class="n">PSKeyItem</span>  <span class="n">pTransmitKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">BOOL</span>       <span class="n">bIs802_1x</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wAKMSSAuthCount</span><span class="p">;</span> <span class="n">ii</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyAKMSSAuthType</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_11i_AKMSS_802_1X</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bIs802_1x</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">bIs802_1x</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="p">((</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">bAdd_PMKID_Candidate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				     <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">sRSNCapObj</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">PAIRWISE_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">KeybGetTransmitKey</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBSSID</span><span class="p">,</span> <span class="n">GROUP_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTransmitKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">StatusType</span> <span class="o">=</span> <span class="n">Ndis802_11StatusType_PMKID_CandidateList</span><span class="p">;</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">gsPMKIDCandidate</span><span class="p">.</span><span class="n">Version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                <span class="p">}</span>

            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bUpdateBBVGA</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Moniter if RSSI is too strong.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byRSSIStatCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">RFvRSSITodBm</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">uRSSI</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmMAX</span><span class="p">);</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmMAX</span><span class="p">;</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverRange</span> <span class="o">=</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmMAX</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">RSSI_STAT_COUNT</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uIELength</span> <span class="o">=</span> <span class="n">uIELength</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uIELength</span> <span class="o">&gt;</span> <span class="n">WLAN_BEACON_FR_MAXLEN</span><span class="p">)</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uIELength</span> <span class="o">=</span> <span class="n">WLAN_BEACON_FR_MAXLEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyIEs</span><span class="p">,</span> <span class="n">pbyIEs</span><span class="p">,</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uIELength</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Update BSS set in known BSS list</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    TRUE if success.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>TODO: input structure modify</p></td><td class="code"><div class="highlight"><pre><span class="n">BOOL</span> <span class="nf">BSSbUpdateToBSSList</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
			 <span class="n">QWORD</span> <span class="n">qwTimestamp</span><span class="p">,</span>
			 <span class="n">WORD</span> <span class="n">wBeaconInterval</span><span class="p">,</span>
			 <span class="n">WORD</span> <span class="n">wCapInfo</span><span class="p">,</span>
			 <span class="n">BYTE</span> <span class="n">byCurrChannel</span><span class="p">,</span>
			 <span class="n">BOOL</span> <span class="n">bChannelHit</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_SSID</span> <span class="n">pSSID</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pSuppRates</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pExtSuppRates</span><span class="p">,</span>
			 <span class="n">PERPObject</span> <span class="n">psERP</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_RSN</span> <span class="n">pRSN</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_RSN_EXT</span> <span class="n">pRSNWPA</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_COUNTRY</span> <span class="n">pIE_Country</span><span class="p">,</span>
			 <span class="n">PWLAN_IE_QUIET</span> <span class="n">pIE_Quiet</span><span class="p">,</span>
			 <span class="n">PKnownBSS</span> <span class="n">pBSSList</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uIELength</span><span class="p">,</span>
			 <span class="n">PBYTE</span> <span class="n">pbyIEs</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">pRxPacketContext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span>             <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">;</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">PSRxMgmtPacket</span>  <span class="n">pRxPacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSRxMgmtPacket</span><span class="p">)</span><span class="n">pRxPacketContext</span><span class="p">;</span>
    <span class="kt">signed</span> <span class="kt">long</span>            <span class="n">ldBm</span><span class="p">,</span> <span class="n">ldBmSum</span><span class="p">;</span>
    <span class="n">BOOL</span>            <span class="n">bParsingQuiet</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>


    <span class="n">HIDWORD</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">qwBSSTimestamp</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">HIDWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">));</span>
    <span class="n">LODWORD</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">qwBSSTimestamp</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LODWORD</span><span class="p">(</span><span class="n">qwTimestamp</span><span class="p">));</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wBeaconInterval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wBeaconInterval</span><span class="p">);</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wCapInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wCapInfo</span><span class="p">);</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uClearCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uChannel</span> <span class="o">=</span> <span class="n">byCurrChannel</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">)</span>
        <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abySSID</span><span class="p">,</span> <span class="n">pSSID</span><span class="p">,</span> <span class="n">pSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abySuppRates</span><span class="p">,</span> <span class="n">pSuppRates</span><span class="p">,</span><span class="n">pSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pExtSuppRates</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyExtSuppRates</span><span class="p">,</span> <span class="n">pExtSuppRates</span><span class="p">,</span><span class="n">pExtSuppRates</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">WLAN_IEHDR_LEN</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyExtSuppRates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_RATES_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">sERP</span><span class="p">.</span><span class="n">byERP</span> <span class="o">=</span> <span class="n">psERP</span><span class="o">-&gt;</span><span class="n">byERP</span><span class="p">;</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span> <span class="o">=</span> <span class="n">psERP</span><span class="o">-&gt;</span><span class="n">bERPExist</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Check if BSS is 802.11a/b/g</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uChannel</span> <span class="o">&gt;</span> <span class="n">CB_MAX_CHANNEL_24G</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">=</span> <span class="n">PHY_TYPE_11A</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">sERP</span><span class="p">.</span><span class="n">bERPExist</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">=</span> <span class="n">PHY_TYPE_11G</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">eNetworkTypeInUse</span> <span class="o">=</span> <span class="n">PHY_TYPE_11B</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byRxRate</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">byRxRate</span><span class="p">;</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">qwLocalTSF</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bChannelHit</span><span class="p">)</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uRSSI</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">uRSSI</span><span class="p">;</span>
    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">bySQ</span> <span class="o">=</span> <span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">bySQ</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>assoc with BSS</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span> <span class="o">==</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">pCurrBSS</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bParsingQuiet</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

   <span class="n">WPA_ClearRSN</span><span class="p">(</span><span class="n">pBSSList</span><span class="p">);</span>         <span class="c1">//mike update</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">pRSNWPA</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uLen</span> <span class="o">=</span> <span class="n">pRSNWPA</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uLen</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">uIELength</span> <span class="o">-</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span> <span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span> <span class="n">pRSNWPA</span> <span class="o">-</span> <span class="n">pbyIEs</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wWPALen</span> <span class="o">=</span> <span class="n">uLen</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byWPAIE</span><span class="p">,</span> <span class="n">pRSNWPA</span><span class="p">,</span> <span class="n">uLen</span><span class="p">);</span>
		<span class="n">WPA_ParseRSN</span><span class="p">(</span><span class="n">pBSSList</span><span class="p">,</span> <span class="n">pRSNWPA</span><span class="p">);</span>
	<span class="p">}</span>
   <span class="p">}</span>

   <span class="n">WPA2_ClearRSN</span><span class="p">(</span><span class="n">pBSSList</span><span class="p">);</span>  <span class="c1">//mike update</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pRSN</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uLen</span> <span class="o">=</span> <span class="n">pRSN</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uLen</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">uIELength</span> <span class="o">-</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span> <span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span> <span class="n">pRSN</span> <span class="o">-</span> <span class="n">pbyIEs</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">wRSNLen</span> <span class="o">=</span> <span class="n">uLen</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byRSNIE</span><span class="p">,</span> <span class="n">pRSN</span><span class="p">,</span> <span class="n">uLen</span><span class="p">);</span>
		<span class="n">WPA2vParseRSN</span><span class="p">(</span><span class="n">pBSSList</span><span class="p">,</span> <span class="n">pRSN</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">uRSSI</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RFvRSSITodBm</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">pRxPacket</span><span class="o">-&gt;</span><span class="n">uRSSI</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ldBm</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Moniter if RSSI is too strong.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byRSSIStatCnt</span><span class="o">++</span><span class="p">;</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byRSSIStatCnt</span> <span class="o">%=</span> <span class="n">RSSI_STAT_COUNT</span><span class="p">;</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">byRSSIStatCnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">ldBm</span><span class="p">;</span>
        <span class="n">ldBmSum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">RSSI_STAT_COUNT</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmMAX</span> <span class="o">=</span>
				<span class="n">max</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ldBm</span><span class="p">);</span>
			<span class="n">ldBmSum</span> <span class="o">+=</span>
				<span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
			<span class="n">jj</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
        <span class="p">}</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverRange</span> <span class="o">=</span> <span class="n">ldBmSum</span> <span class="o">/</span><span class="n">jj</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uIELength</span> <span class="o">=</span> <span class="n">uIELength</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uIELength</span> <span class="o">&gt;</span> <span class="n">WLAN_BEACON_FR_MAXLEN</span><span class="p">)</span>
        <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uIELength</span> <span class="o">=</span> <span class="n">WLAN_BEACON_FR_MAXLEN</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">abyIEs</span><span class="p">,</span> <span class="n">pbyIEs</span><span class="p">,</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">uIELength</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>





<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Search Node DB table to find the index of matched DstAddr</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="n">BOOL</span> <span class="nf">BSSbIsSTAInNodeDB</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
		       <span class="n">PBYTE</span> <span class="n">abyDstAddr</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">puNodeIndex</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Index = 0 reserved for AP Node</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_NODE_NUM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">abyDstAddr</span><span class="p">,</span>
					<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">abyMACAddr</span><span class="p">))</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">puNodeIndex</span> <span class="o">=</span> <span class="n">ii</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

   <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">};</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Find an empty node and allocated; if no empty found,</span>
<span class="cm"> *    instand used of most inactive one.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>
<span class="kt">void</span> <span class="nf">BSSvCreateOneNode</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">puNodeIndex</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">BigestCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">SelectIndex</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Index = 0 reserved for AP Node (In STA mode)
Index = 0 reserved for Broadcast/MultiCast (In AP mode)</p></td><td class="code"><div class="highlight"><pre>    <span class="n">SelectIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_NODE_NUM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">&gt;</span> <span class="n">BigestCount</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">BigestCount</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">uInActiveCount</span><span class="p">;</span>
                <span class="n">SelectIndex</span> <span class="o">=</span> <span class="n">ii</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>if not found replace uInActiveCount is largest one.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="n">ii</span> <span class="o">==</span> <span class="p">(</span><span class="n">MAX_NODE_NUM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">puNodeIndex</span> <span class="o">=</span> <span class="n">SelectIndex</span><span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Replace inactive node = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SelectIndex</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>clear ps buffer</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="o">*</span><span class="n">puNodeIndex</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      	    <span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="o">*</span><span class="n">puNodeIndex</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">puNodeIndex</span> <span class="o">=</span> <span class="n">ii</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="o">*</span><span class="n">puNodeIndex</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KnownNodeDB</span><span class="p">));</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="o">*</span><span class="n">puNodeIndex</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="o">*</span><span class="n">puNodeIndex</span><span class="p">].</span><span class="n">uRatePollTimeout</span> <span class="o">=</span> <span class="n">FALLBACK_POLL_SECOND</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>for AP mode PS queue</p></td><td class="code"><div class="highlight"><pre>    <span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="o">*</span><span class="n">puNodeIndex</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="o">*</span><span class="n">puNodeIndex</span><span class="p">].</span><span class="n">byAuthSequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="o">*</span><span class="n">puNodeIndex</span><span class="p">].</span><span class="n">wEnQueueCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Create node index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
<span class="p">};</span>



<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Remove Node by NodeIndex</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span> <span class="nf">BSSvRemoveOneNode</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uNodeIndex</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">BYTE</span>            <span class="n">byMask</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">};</span>
    <span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">skb</span><span class="p">;</span>


    <span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>clear context</p></td><td class="code"><div class="highlight"><pre>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KnownNodeDB</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>clear tx bit map</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyPSTxMap</span><span class="p">[</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wAID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">byMask</span><span class="p">[</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">wAID</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
<span class="p">};</span>
<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Update AP Node content in Index 0 of KnownNodeDB</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span> <span class="nf">BSSvUpdateAPNode</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
		      <span class="n">PWORD</span> <span class="n">pwCapInfo</span><span class="p">,</span>
		      <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pSuppRates</span><span class="p">,</span>
		      <span class="n">PWLAN_IE_SUPP_RATES</span> <span class="n">pExtSuppRates</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KnownNodeDB</span><span class="p">));</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11B</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">uRateLen</span> <span class="o">=</span> <span class="n">WLAN_RATES_MAXLEN_11B</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pSuppRates</span><span class="p">,</span>
                                            <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                                            <span class="n">uRateLen</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RATEuSetIE</span><span class="p">((</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pExtSuppRates</span><span class="p">,</span>
                                            <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                                            <span class="n">uRateLen</span><span class="p">);</span>
    <span class="n">RATEvParseMaxRate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                       <span class="n">TRUE</span><span class="p">,</span>
                       <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wMaxBasicRate</span><span class="p">),</span>
                       <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">),</span>
                       <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wSuppRate</span><span class="p">),</span>
                       <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">byTopCCKBasicRate</span><span class="p">),</span>
                       <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">byTopOFDMBasicRate</span><span class="p">)</span>
                      <span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wTxDataRate</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bShortPreamble</span> <span class="o">=</span> <span class="n">WLAN_GET_CAP_INFO_SHORTPREAMBLE</span><span class="p">(</span><span class="o">*</span><span class="n">pwCapInfo</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uRatePollTimeout</span> <span class="o">=</span> <span class="n">FALLBACK_POLL_SECOND</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Auto rate fallback function initiation.
RATEbInit(pDevice);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;pMgmt-&gt;sNodeDBTable[0].wTxDataRate = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wTxDataRate</span><span class="p">);</span>

<span class="p">};</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Add Multicast Node content in Index 0 of KnownNodeDB</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span> <span class="nf">BSSvAddMulticastNode</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableHostWEP</span><span class="p">)</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KnownNodeDB</span><span class="p">));</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">WLAN_ADDR_LEN</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bPSEnable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">);</span>
    <span class="n">RATEvParseMaxRate</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSuppRates</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">PWLAN_IE_SUPP_RATES</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrExtSuppRates</span><span class="p">,</span>
                      <span class="n">TRUE</span><span class="p">,</span>
                      <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wMaxBasicRate</span><span class="p">),</span>
                      <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wMaxSuppRate</span><span class="p">),</span>
                       <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wSuppRate</span><span class="p">),</span>
                      <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">byTopCCKBasicRate</span><span class="p">),</span>
                      <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">byTopOFDMBasicRate</span><span class="p">)</span>
                     <span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wTxDataRate</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wMaxBasicRate</span><span class="p">;</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uRatePollTimeout</span> <span class="o">=</span> <span class="n">FALLBACK_POLL_SECOND</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Second call back function to update Node DB info &amp; AP link status</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    none.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span> <span class="nf">BSSvSecondCallBack</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>
    <span class="n">PWLAN_IE_SSID</span>   <span class="n">pItemSSID</span><span class="p">,</span> <span class="n">pCurrSSID</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uSleepySTACnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uNonShortSlotSTACnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uLongPreambleSTACnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="n">wpahdr</span><span class="p">;</span>

    <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Power Saving Mode Tx Burst</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnablePSMode</span> <span class="o">==</span> <span class="n">TRUE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulPSModeWaitTx</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulPSModeWaitTx</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulPSModeWaitTx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bPSModeTxBurst</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span> <span class="o">&amp;=</span>
        <span class="o">~</span><span class="p">(</span><span class="n">WLAN_SET_ERP_BARKER_MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">WLAN_SET_ERP_NONERP_PRESENT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wUseProtectCntDown</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wUseProtectCntDown</span> <span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>disable protect mode</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WLAN_SET_ERP_USE_PROTECTION</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span><span class="o">++</span><span class="p">;</span>
   <span class="k">if</span><span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">//10 sec timeout</span>
                     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Re-association timeout!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                     <span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>if(pDevice->bWPASuppWextEnabled == TRUE)</p></td><td class="code"><div class="highlight"><pre>                        <span class="p">{</span>
                  	<span class="k">union</span> <span class="n">iwreq_data</span>  <span class="n">wrqu</span><span class="p">;</span>
                  	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
                          <span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
                  	<span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;wireless_send_event---&gt;SIOCGIWAP(disassociated)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                  	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                       <span class="p">}</span>
                    <span class="cp">#endif</span>
     <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
   	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span><span class="o">!=</span><span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
     <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eLastState</span><span class="o">==</span><span class="n">WMAC_STATE_ASSOC</span><span class="p">))</span>
<span class="p">{</span>
  <span class="k">union</span> <span class="n">iwreq_data</span>      <span class="n">wrqu</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
  <span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RT_DISCONNECTED_EVENT_FLAG</span><span class="p">;</span>
  <span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVCUSTOM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eLastState</span> <span class="o">=</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="p">;</span>

   <span class="n">s_uCalculateLinkQual</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_NODE_NUM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Increase in-activity counter</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">uInActiveCount</span><span class="o">++</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">&gt;</span> <span class="n">MAX_INACTIVE_COUNT</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">BSSvRemoveOneNode</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span>
                        <span class="s">&quot;Inactive timeout [%d] sec, STA index = [%d] remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MAX_INACTIVE_COUNT</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">eNodeState</span> <span class="o">&gt;=</span> <span class="n">NODE_ASSOC</span><span class="p">)</span> <span class="p">{</span>

                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAssocCount</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>check if Non ERP exist</p></td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">&lt;</span> <span class="n">ERP_RECOVER_COUNT</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bShortPreamble</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span> <span class="o">|=</span> <span class="n">WLAN_SET_ERP_BARKER_MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                            <span class="n">uLongPreambleSTACnt</span> <span class="o">++</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bERPExist</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span> <span class="o">|=</span> <span class="n">WLAN_SET_ERP_NONERP_PRESENT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span> <span class="o">|=</span> <span class="n">WLAN_SET_ERP_USE_PROTECTION</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bShortSlotTime</span><span class="p">)</span>
                            <span class="n">uNonShortSlotSTACnt</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>check if any STA in PS mode</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bPSEnable</span><span class="p">)</span>
                    <span class="n">uSleepySTACnt</span><span class="o">++</span><span class="p">;</span>


            <span class="p">}</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Rate fallback check</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>ii = 0 for multicast node (AP &amp; Adhoc)</p></td><td class="code"><div class="highlight"><pre>			<span class="n">RATEvTxRateFallBack</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">]));</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>ii = 0 reserved for unicast AP node (Infra STA)</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span>
				<span class="n">RATEvTxRateFallBack</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">]));</span>
                <span class="p">}</span>

            <span class="p">}</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>check if pending PS queue</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">wEnQueueCnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Index= %d, Queue = %d pending </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="n">ii</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">wEnQueueCnt</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">ii</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">wEnQueueCnt</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">BSSvRemoveOneNode</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Pending many queues PS STA Index = %d remove </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>


    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11G</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>on/off protect mode</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_GET_ERP_USE_PROTECTION</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byERPFlag</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">MACvEnableProtectMD</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">MACvDisableProtectMD</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>on/off short slot time</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">uNonShortSlotSTACnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bShortSlotTime</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bShortSlotTime</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">BBvSetShortSlotTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
		<span class="n">vUpdateIFS</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bShortSlotTime</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bShortSlotTime</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">BBvSetShortSlotTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
		<span class="n">vUpdateIFS</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>on/off barker long preamble mode</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">uLongPreambleSTACnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">MACvEnableBarkerPreambleMd</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">MACvDisableBarkerPreambleMd</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Check if any STA in PS mode, enable DTIM multicast deliver</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">uSleepySTACnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bPSEnable</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bPSEnable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pItemSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">;</span>
    <span class="n">pCurrSSID</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_STANDBY</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">))</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Assoc with BSS</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bUpdateBBVGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* s_vCheckSensitivity((void *) pDevice); */</span>
		<span class="n">s_vCheckPreEDThreshold</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">);</span>
            <span class="p">}</span>

    	    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">LOST_BEACON_COUNT</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
    	        <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span> <span class="o">!=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBBVGA</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
    	        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBBVGA</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_CHANGE_BBSENSITIVITY</span><span class="p">,</span>
				 <span class="nb">NULL</span><span class="p">);</span>
    	    <span class="p">}</span>

        	<span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">&gt;=</span> <span class="n">LOST_BEACON_COUNT</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bActive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">=</span> <span class="n">WMAC_MODE_STANDBY</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
                <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">ControlvMaskByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span><span class="n">MAC_REG_PAPEDELAY</span><span class="p">,</span><span class="n">LEDSTS_STS</span><span class="p">,</span><span class="n">LEDSTS_SLOW</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bIsRoaming</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Lost AP beacon [%d] sec, disconnected !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span><span class="p">);</span>
		<span class="cm">/* let wpa supplicant know AP may disconnect */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
             <span class="n">wpahdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
             <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIAWGET_DISASSOC_MSG</span><span class="p">;</span>
             <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="n">skb_put</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">));</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wpadev</span><span class="p">;</span>
	     <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
             <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
             <span class="n">netif_rx</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
         <span class="p">}</span>
   <span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
      <span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span>  <span class="n">wrqu</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
        <span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">PRINT_K</span><span class="p">(</span><span class="s">&quot;wireless_send_event---&gt;SIOCGIWAP(disassociated)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
     <span class="p">}</span>
  <span class="cp">#endif</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pItemSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Davidwang</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableRoaming</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">Cisco_cckm</span><span class="p">)))</span> <span class="p">{</span>
<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;bRoaming %d, !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="p">);</span>
<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;bIsRoaming %d, !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bIsRoaming</span> <span class="p">);</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bIsRoaming</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)){</span>
	    	<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Fast   Roaming ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BSSvClearBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span><span class="p">);</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span>
				 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_SSID</span><span class="p">,</span>
				 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAutoReConnectTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uIsroamingTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

             <span class="n">wpahdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
             <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIAWGET_CCKM_ROAM_MSG</span><span class="p">;</span>
             <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="n">skb_put</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">));</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wpadev</span><span class="p">;</span>
	     <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
             <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
             <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
             <span class="n">netif_rx</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>

          <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bIsRoaming</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uIsroamingTime</span><span class="o">++</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uIsroamingTime</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bIsRoaming</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
         <span class="p">}</span>

   <span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAutoReConnectTime</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAutoReConnectTime</span><span class="o">++</span><span class="p">;</span>
               <span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>network manager support need not do Roaming scan???</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPASuppWextEnabled</span> <span class="o">==</span><span class="n">TRUE</span><span class="p">)</span>
		 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAutoReConnectTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="cp">#endif</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>mike use old encryption status for wpa reauthen</p></td><td class="code"><div class="highlight"><pre>	      <span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="p">)</span>
	          <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOldEncryptionStatus</span><span class="p">;</span>

                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Roaming ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BSSvClearBSSList</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span><span class="p">);</span>
		<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_ACTIVE</span><span class="p">;</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span>
				 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_SSID</span><span class="p">,</span>
				 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAutoReConnectTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>if adhoc started which essid is NULL string, rescanning.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_STARTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pCurrSSID</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAutoReConnectTime</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAutoReConnectTime</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Adhoc re-scanning ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	       <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_ACTIVE</span><span class="p">;</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_SSID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uAutoReConnectTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_JOINTED</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bUpdateBBVGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* s_vCheckSensitivity((void *) pDevice); */</span>
			<span class="n">s_vCheckPreEDThreshold</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">);</span>
		<span class="p">}</span>
        	<span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">&gt;=</span><span class="n">ADHOC_LOST_BEACON_COUNT</span><span class="p">)</span> <span class="p">{</span>
        	    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_NOTICE</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Lost other STA beacon [%d] sec, started !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span><span class="p">);</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uInActiveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_STARTED</span><span class="p">;</span>
                <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">ControlvMaskByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span><span class="n">MAC_REG_PAPEDELAY</span><span class="p">,</span><span class="n">LEDSTS_STS</span><span class="p">,</span><span class="n">LEDSTS_SLOW</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
            <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
    <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Update Tx attemps, Tx failure counter in Node DB</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    none.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span> <span class="nf">BSSvUpdateNodeTxCounter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
			     <span class="n">PSStatCounter</span> <span class="n">pStatistic</span><span class="p">,</span>
			     <span class="n">BYTE</span> <span class="n">byTSR</span><span class="p">,</span>
			     <span class="n">BYTE</span> <span class="n">byPktNO</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">uNodeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byTxRetry</span><span class="p">;</span>
    <span class="n">WORD</span>            <span class="n">wRate</span><span class="p">;</span>
    <span class="n">WORD</span>            <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byFallBack</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>
    <span class="n">PBYTE</span>           <span class="n">pbyDestAddr</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byPktNum</span><span class="p">;</span>
    <span class="n">WORD</span>            <span class="n">wFIFOCtl</span><span class="p">;</span>

    <span class="n">byPktNum</span> <span class="o">=</span> <span class="p">(</span><span class="n">byPktNO</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">byTxRetry</span> <span class="o">=</span> <span class="p">(</span><span class="n">byTSR</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">wRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span> <span class="p">(</span><span class="n">byPktNO</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">wFIFOCtl</span> <span class="o">=</span> <span class="n">pStatistic</span><span class="o">-&gt;</span><span class="n">abyTxPktInfo</span><span class="p">[</span><span class="n">byPktNum</span><span class="p">].</span><span class="n">wFIFOCtl</span><span class="p">;</span>
    <span class="n">pbyDestAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span> <span class="n">pStatistic</span><span class="o">-&gt;</span><span class="n">abyTxPktInfo</span><span class="p">[</span><span class="n">byPktNum</span><span class="p">].</span><span class="n">abyDestAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wFIFOCtl</span> <span class="o">&amp;</span> <span class="n">FIFOCTL_AUTO_FB_0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byFallBack</span> <span class="o">=</span> <span class="n">AUTO_FB_0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wFIFOCtl</span> <span class="o">&amp;</span> <span class="n">FIFOCTL_AUTO_FB_1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byFallBack</span> <span class="o">=</span> <span class="n">AUTO_FB_1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">byFallBack</span> <span class="o">=</span> <span class="n">AUTO_FB_NONE</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Only Unicast using support rates</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">wFIFOCtl</span> <span class="o">&amp;</span> <span class="n">FIFOCTL_NEEDACK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_STA</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uTxAttempts</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byTSR</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSR_TMO</span> <span class="o">|</span> <span class="n">TSR_RETRYTMO</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>transmit success, TxAttempts at least plus one</p></td><td class="code"><div class="highlight"><pre>                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uTxOk</span><span class="p">[</span><span class="n">MAX_RATE</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="o">||</span>
                     <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">wRate</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">byTxRetry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
                        <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry0</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="n">byTxRetry</span><span class="p">];</span>
                    <span class="k">else</span>
                        <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry0</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">byTxRetry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
                        <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry1</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="n">byTxRetry</span><span class="p">];</span>
                    <span class="k">else</span>
                        <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry1</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uTxOk</span><span class="p">[</span><span class="n">wFallBackRate</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uTxFailures</span> <span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uTxRetry</span> <span class="o">+=</span> <span class="n">byTxRetry</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">byTxRetry</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uTxFail</span><span class="p">[</span><span class="n">MAX_RATE</span><span class="p">]</span><span class="o">+=</span><span class="n">byTxRetry</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="o">||</span>
                     <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uTxFail</span><span class="p">[</span><span class="n">wRate</span><span class="p">]</span><span class="o">+=</span><span class="n">byTxRetry</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">byTxRetry</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">wFallBackRate</span> <span class="o">=</span>
						<span class="n">awHWRetry0</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="n">ii</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">wFallBackRate</span> <span class="o">=</span>
						<span class="n">awHWRetry0</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
				<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uTxFail</span><span class="p">[</span><span class="n">wFallBackRate</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">byTxRetry</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">wFallBackRate</span> <span class="o">=</span>
						<span class="n">awHWRetry1</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="n">ii</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">wFallBackRate</span> <span class="o">=</span>
						<span class="n">awHWRetry1</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
				<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uTxFail</span><span class="p">[</span><span class="n">wFallBackRate</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_ESS_AP</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">BSSbIsSTAInNodeDB</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				      <span class="n">pbyDestAddr</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">uNodeIndex</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uTxAttempts</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">byTSR</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSR_TMO</span> <span class="o">|</span> <span class="n">TSR_RETRYTMO</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>transmit success, TxAttempts at least plus one</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uTxOk</span><span class="p">[</span><span class="n">MAX_RATE</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="o">||</span>
                         <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">wRate</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">byTxRetry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
                            <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry0</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="n">byTxRetry</span><span class="p">];</span>
                        <span class="k">else</span>
                            <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry0</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">byTxRetry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
                            <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry1</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="n">byTxRetry</span><span class="p">];</span>
                        <span class="k">else</span>
                            <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry1</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
                    <span class="p">}</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uTxOk</span><span class="p">[</span><span class="n">wFallBackRate</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uTxFailures</span> <span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uTxRetry</span> <span class="o">+=</span> <span class="n">byTxRetry</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">byTxRetry</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uTxFail</span><span class="p">[</span><span class="n">MAX_RATE</span><span class="p">]</span><span class="o">+=</span><span class="n">byTxRetry</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_NONE</span><span class="p">)</span> <span class="o">||</span>
                         <span class="p">(</span><span class="n">wRate</span> <span class="o">&lt;</span> <span class="n">RATE_18M</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uTxFail</span><span class="p">[</span><span class="n">wRate</span><span class="p">]</span><span class="o">+=</span><span class="n">byTxRetry</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">byTxRetry</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">wFallBackRate</span> <span class="o">=</span>
						<span class="n">awHWRetry0</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="n">ii</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">wFallBackRate</span> <span class="o">=</span>
						<span class="n">awHWRetry0</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
				<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uTxFail</span><span class="p">[</span><span class="n">wFallBackRate</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byFallBack</span> <span class="o">==</span> <span class="n">AUTO_FB_1</span><span class="p">)</span> <span class="p">{</span>
		      <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">byTxRetry</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
                                <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry1</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="n">ii</span><span class="p">];</span>
			<span class="k">else</span>
                                <span class="n">wFallBackRate</span> <span class="o">=</span> <span class="n">awHWRetry1</span><span class="p">[</span><span class="n">wRate</span><span class="o">-</span><span class="n">RATE_18M</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">uNodeIndex</span><span class="p">].</span><span class="n">uTxFail</span><span class="p">[</span><span class="n">wFallBackRate</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		      <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+</span>
<span class="cm"> *</span>
<span class="cm"> * Routine Description:</span>
<span class="cm"> *    Clear Nodes &amp; skb in DB Table</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *  In:</span>
<span class="cm"> *      hDeviceContext        - The adapter context.</span>
<span class="cm"> *      uStartIndex           - starting index</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *      none</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> *    None.</span>
<span class="cm"> *</span>
<span class="cm">-*/</span>

<span class="kt">void</span> <span class="nf">BSSvClearNodeDBTable</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uStartIndex</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>     <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="n">uStartIndex</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_NODE_NUM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bActive</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>check if sTxPSQueue has been initial</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">sTxPSQueue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
                        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;PS skb != NULL %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
                        <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sNodeDBTable</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KnownNodeDB</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">s_vCheckSensitivity</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PKnownBSS</span>       <span class="n">pBSSList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">int</span>             <span class="n">ii</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_JOINTED</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">pBSSList</span> <span class="o">=</span> <span class="n">BSSpAddrIsInBSSList</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update BB register if RSSI is too strong */</span>
		<span class="kt">signed</span> <span class="kt">long</span>    <span class="n">LocalldBmAverage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">signed</span> <span class="kt">long</span>    <span class="n">uNumofdBm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">RSSI_STAT_COUNT</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">uNumofdBm</span> <span class="o">++</span><span class="p">;</span>
                    <span class="n">LocalldBmAverage</span> <span class="o">+=</span> <span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverage</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">uNumofdBm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">LocalldBmAverage</span> <span class="o">=</span> <span class="n">LocalldBmAverage</span><span class="o">/</span><span class="n">uNumofdBm</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">BB_VGA_LEVEL</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;LocalldBmAverage:%ld, %ld %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LocalldBmAverage</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ldBmThreshold</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBBVGA</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">LocalldBmAverage</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ldBmThreshold</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="p">{</span>
                	    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBBVGA</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span> <span class="o">!=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span> <span class="o">&gt;=</span> <span class="n">BB_VGA_CHANGE_THRESHOLD</span><span class="p">)</span>
			<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
					 <span class="n">WLAN_CMD_CHANGE_BBSENSITIVITY</span><span class="p">,</span>
					 <span class="nb">NULL</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uBBVGADiffCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">s_uCalculateLinkQual</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">TxOkRatio</span><span class="p">,</span> <span class="n">TxCnt</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">RxOkRatio</span><span class="p">,</span> <span class="n">RxCnt</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">RssiRatio</span><span class="p">;</span>
   <span class="kt">long</span> <span class="n">ldBm</span><span class="p">;</span>

<span class="n">TxCnt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">TxNoRetryOkCount</span> <span class="o">+</span>
	      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">TxRetryOkCount</span> <span class="o">+</span>
	      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">TxFailCount</span><span class="p">;</span>
<span class="n">RxCnt</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">RxFcsErrCnt</span> <span class="o">+</span>
	      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">RxOkCnt</span><span class="p">;</span>
<span class="n">TxOkRatio</span> <span class="o">=</span> <span class="p">(</span><span class="n">TxCnt</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4000</span><span class="o">:</span><span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">TxNoRetryOkCount</span> <span class="o">*</span> <span class="mi">4000</span><span class="p">)</span> <span class="o">/</span> <span class="n">TxCnt</span><span class="p">);</span>
<span class="n">RxOkRatio</span> <span class="o">=</span> <span class="p">(</span><span class="n">RxCnt</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2000</span><span class="o">:</span><span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">RxOkCnt</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">/</span> <span class="n">RxCnt</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>decide link quality</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">!=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">LinkQuality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">SignalStren</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
   <span class="n">RFvRSSITodBm</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uCurrRSSI</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ldBm</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="n">ldBm</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span>  <span class="p">{</span>
   	<span class="n">RssiRatio</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
     <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="n">ldBm</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="p">{</span>
   	<span class="n">RssiRatio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
   	<span class="n">RssiRatio</span> <span class="o">=</span> <span class="p">(</span><span class="mi">40</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">ldBm</span><span class="o">-</span><span class="mi">50</span><span class="p">))</span><span class="o">*</span><span class="mi">4000</span><span class="o">/</span><span class="mi">40</span><span class="p">;</span>
     <span class="p">}</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">SignalStren</span> <span class="o">=</span> <span class="n">RssiRatio</span><span class="o">/</span><span class="mi">40</span><span class="p">;</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">LinkQuality</span> <span class="o">=</span> <span class="p">(</span><span class="n">RssiRatio</span><span class="o">+</span><span class="n">TxOkRatio</span><span class="o">+</span><span class="n">RxOkRatio</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
<span class="p">}</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">RxFcsErrCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">RxOkCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">TxFailCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">TxNoRetryOkCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">scStatistic</span><span class="p">.</span><span class="n">TxRetryOkCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">BSSvClearAnyBSSJoinRecord</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAX_BSS_NUM</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sBSSList</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">bSelected</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">s_vCheckPreEDThreshold</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hDeviceContext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PSDevice</span>        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">hDeviceContext</span><span class="p">;</span>
    <span class="n">PKnownBSS</span>       <span class="n">pBSSList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_ASSOC</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">((</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrMode</span> <span class="o">==</span> <span class="n">WMAC_MODE_IBSS_STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">==</span> <span class="n">WMAC_STATE_JOINTED</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">pBSSList</span> <span class="o">=</span> <span class="n">BSSpAddrIsInBSSList</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="p">(</span><span class="n">PWLAN_IE_SSID</span><span class="p">)</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pBSSList</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBPreEDRSSI</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">pBSSList</span><span class="o">-&gt;</span><span class="n">ldBmAverRange</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">BBvUpdatePreEDThreshold</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
