<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › vt6656 › main_usb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>main_usb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * File: main_usb.c</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: driver entry for initial, open, close, tx and rx.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Lyndon Chen</span>
<span class="cm"> *</span>
<span class="cm"> * Date: Dec 8, 2005</span>
<span class="cm"> *</span>
<span class="cm"> * Functions:</span>
<span class="cm"> *</span>
<span class="cm"> *   vt6656_probe - module initial (insmod) driver entry</span>
<span class="cm"> *   device_remove1 - module remove entry</span>
<span class="cm"> *   device_open - allocate dma/descripter resource &amp; initial mac/bbp function</span>
<span class="cm"> *   device_xmit - asynchrous data tx function</span>
<span class="cm"> *   device_set_multi - set mac filter</span>
<span class="cm"> *   device_ioctl - ioctl entry</span>
<span class="cm"> *   device_close - shutdown mac/bbp &amp; free dma/descripter resource</span>
<span class="cm"> *   device_alloc_frag_buf - rx fragement pre-allocated function</span>
<span class="cm"> *   device_free_tx_bufs - free tx buffer function</span>
<span class="cm"> *   device_dma0_tx_80211- tx 802.11 frame via dma0</span>
<span class="cm"> *   device_dma0_xmit- tx PS bufferred frame via dma0</span>
<span class="cm"> *   device_init_registers- initial MAC &amp; BBP &amp; RF internal registers.</span>
<span class="cm"> *   device_init_rings- initial tx/rx ring buffer</span>
<span class="cm"> *   device_init_defrag_cb- initial &amp; allocate de-fragement buffer.</span>
<span class="cm"> *   device_tx_srv- tx interrupt service function</span>
<span class="cm"> *</span>
<span class="cm"> * Revision History:</span>
<span class="cm"> */</span>
<span class="cp">#undef __NO_VERSION__</span>

<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;card.h&quot;</span>
<span class="cp">#include &quot;baseband.h&quot;</span>
<span class="cp">#include &quot;mac.h&quot;</span>
<span class="cp">#include &quot;tether.h&quot;</span>
<span class="cp">#include &quot;wmgr.h&quot;</span>
<span class="cp">#include &quot;wctl.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>
<span class="cp">#include &quot;wcmd.h&quot;</span>
<span class="cp">#include &quot;iocmd.h&quot;</span>
<span class="cp">#include &quot;tcrc.h&quot;</span>
<span class="cp">#include &quot;rxtx.h&quot;</span>
<span class="cp">#include &quot;bssdb.h&quot;</span>
<span class="cp">#include &quot;hostap.h&quot;</span>
<span class="cp">#include &quot;wpactl.h&quot;</span>
<span class="cp">#include &quot;ioctl.h&quot;</span>
<span class="cp">#include &quot;iwctl.h&quot;</span>
<span class="cp">#include &quot;dpc.h&quot;</span>
<span class="cp">#include &quot;datarate.h&quot;</span>
<span class="cp">#include &quot;rf.h&quot;</span>
<span class="cp">#include &quot;firmware.h&quot;</span>
<span class="cp">#include &quot;rndis.h&quot;</span>
<span class="cp">#include &quot;control.h&quot;</span>
<span class="cp">#include &quot;channel.h&quot;</span>
<span class="cp">#include &quot;int.h&quot;</span>
<span class="cp">#include &quot;iowpa.h&quot;</span>

<span class="cm">/*---------------------  Static Definitions -------------------------*/</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>static int          msglevel                =MSG<em>LEVEL</em>DEBUG;</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>          <span class="n">msglevel</span>                <span class="o">=</span><span class="n">MSG_LEVEL_INFO</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Define module options</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Version Information</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define DRIVER_AUTHOR &quot;VIA Networking Technologies, Inc., &lt;lyndonchen@vntek.com.tw&gt;&quot;</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DEVICE_FULL_DRV_NAM</span><span class="p">);</span>

<span class="cp">#define DEVICE_PARAM(N,D) \</span>
<span class="cp">        static int N[MAX_UINTS]=OPTION_DEFAULT;\</span>
<span class="cp">        module_param_array(N, int, NULL, 0);\</span>
<span class="cp">        MODULE_PARM_DESC(N, D);</span>

<span class="cp">#define RX_DESC_MIN0     16</span>
<span class="cp">#define RX_DESC_MAX0     128</span>
<span class="cp">#define RX_DESC_DEF0     64</span>
<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">RxDescriptors0</span><span class="p">,</span><span class="s">&quot;Number of receive usb desc buffer&quot;</span><span class="p">);</span>


<span class="cp">#define TX_DESC_MIN0     16</span>
<span class="cp">#define TX_DESC_MAX0     128</span>
<span class="cp">#define TX_DESC_DEF0     64</span>
<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">TxDescriptors0</span><span class="p">,</span><span class="s">&quot;Number of transmit usb desc buffer&quot;</span><span class="p">);</span>


<span class="cp">#define CHANNEL_MIN     1</span>
<span class="cp">#define CHANNEL_MAX     14</span>
<span class="cp">#define CHANNEL_DEF     6</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">Channel</span><span class="p">,</span> <span class="s">&quot;Channel number&quot;</span><span class="p">);</span>


<span class="cm">/* PreambleType[] is the preamble length used for transmit.</span>
<span class="cm">   0: indicate allows long preamble type</span>
<span class="cm">   1: indicate allows short preamble type</span>
<span class="cm">*/</span>

<span class="cp">#define PREAMBLE_TYPE_DEF     1</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">PreambleType</span><span class="p">,</span> <span class="s">&quot;Preamble Type&quot;</span><span class="p">);</span>


<span class="cp">#define RTS_THRESH_MIN     512</span>
<span class="cp">#define RTS_THRESH_MAX     2347</span>
<span class="cp">#define RTS_THRESH_DEF     2347</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">RTSThreshold</span><span class="p">,</span> <span class="s">&quot;RTS threshold&quot;</span><span class="p">);</span>


<span class="cp">#define FRAG_THRESH_MIN     256</span>
<span class="cp">#define FRAG_THRESH_MAX     2346</span>
<span class="cp">#define FRAG_THRESH_DEF     2346</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">FragThreshold</span><span class="p">,</span> <span class="s">&quot;Fragmentation threshold&quot;</span><span class="p">);</span>


<span class="cp">#define DATA_RATE_MIN     0</span>
<span class="cp">#define DATA_RATE_MAX     13</span>
<span class="cp">#define DATA_RATE_DEF     13</span>
<span class="cm">/* datarate[] index</span>
<span class="cm">   0: indicate 1 Mbps   0x02</span>
<span class="cm">   1: indicate 2 Mbps   0x04</span>
<span class="cm">   2: indicate 5.5 Mbps 0x0B</span>
<span class="cm">   3: indicate 11 Mbps  0x16</span>
<span class="cm">   4: indicate 6 Mbps   0x0c</span>
<span class="cm">   5: indicate 9 Mbps   0x12</span>
<span class="cm">   6: indicate 12 Mbps  0x18</span>
<span class="cm">   7: indicate 18 Mbps  0x24</span>
<span class="cm">   8: indicate 24 Mbps  0x30</span>
<span class="cm">   9: indicate 36 Mbps  0x48</span>
<span class="cm">  10: indicate 48 Mbps  0x60</span>
<span class="cm">  11: indicate 54 Mbps  0x6c</span>
<span class="cm">  12: indicate 72 Mbps  0x90</span>
<span class="cm">  13: indicate auto rate</span>
<span class="cm">*/</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">ConnectionRate</span><span class="p">,</span> <span class="s">&quot;Connection data rate&quot;</span><span class="p">);</span>

<span class="cp">#define OP_MODE_MAX     2</span>
<span class="cp">#define OP_MODE_DEF     0</span>
<span class="cp">#define OP_MODE_MIN     0</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">OPMode</span><span class="p">,</span> <span class="s">&quot;Infrastruct, adhoc, AP mode &quot;</span><span class="p">);</span>

<span class="cm">/* OpMode[] is used for transmit.</span>
<span class="cm">   0: indicate infrastruct mode used</span>
<span class="cm">   1: indicate adhoc mode used</span>
<span class="cm">   2: indicate AP mode used</span>
<span class="cm">*/</span>


<span class="cm">/* PSMode[]</span>
<span class="cm">   0: indicate disable power saving mode</span>
<span class="cm">   1: indicate enable power saving mode</span>
<span class="cm">*/</span>

<span class="cp">#define PS_MODE_DEF     0</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">PSMode</span><span class="p">,</span> <span class="s">&quot;Power saving mode&quot;</span><span class="p">);</span>


<span class="cp">#define SHORT_RETRY_MIN     0</span>
<span class="cp">#define SHORT_RETRY_MAX     31</span>
<span class="cp">#define SHORT_RETRY_DEF     8</span>


<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">ShortRetryLimit</span><span class="p">,</span> <span class="s">&quot;Short frame retry limits&quot;</span><span class="p">);</span>

<span class="cp">#define LONG_RETRY_MIN     0</span>
<span class="cp">#define LONG_RETRY_MAX     15</span>
<span class="cp">#define LONG_RETRY_DEF     4</span>


<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">LongRetryLimit</span><span class="p">,</span> <span class="s">&quot;long frame retry limits&quot;</span><span class="p">);</span>


<span class="cm">/* BasebandType[] baseband type selected</span>
<span class="cm">   0: indicate 802.11a type</span>
<span class="cm">   1: indicate 802.11b type</span>
<span class="cm">   2: indicate 802.11g type</span>
<span class="cm">*/</span>
<span class="cp">#define BBP_TYPE_MIN     0</span>
<span class="cp">#define BBP_TYPE_MAX     2</span>
<span class="cp">#define BBP_TYPE_DEF     2</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">BasebandType</span><span class="p">,</span> <span class="s">&quot;baseband type&quot;</span><span class="p">);</span>



<span class="cm">/* 80211hEnable[]</span>
<span class="cm">   0: indicate disable 802.11h</span>
<span class="cm">   1: indicate enable 802.11h</span>
<span class="cm">*/</span>

<span class="cp">#define X80211h_MODE_DEF     0</span>

<span class="n">DEVICE_PARAM</span><span class="p">(</span><span class="n">b80211hEnable</span><span class="p">,</span> <span class="s">&quot;802.11h mode&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Static vars definitions</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">vt6656_table</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VNT_USB_VENDOR_ID</span><span class="p">,</span> <span class="n">VNT_USB_PRODUCT_ID</span><span class="p">)},</span>
	<span class="p">{}</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Frequency list (map channels to frequencies)</p></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">static const long frequency_list[] = {</span>
<span class="cm">    2412, 2417, 2422, 2427, 2432, 2437, 2442, 2447, 2452, 2457, 2462, 2467, 2472, 2484,</span>
<span class="cm">    4915, 4920, 4925, 4935, 4940, 4945, 4960, 4980,</span>
<span class="cm">    5035, 5040, 5045, 5055, 5060, 5080, 5170, 5180, 5190, 5200, 5210, 5220, 5230, 5240,</span>
<span class="cm">    5260, 5280, 5300, 5320, 5500, 5520, 5540, 5560, 5580, 5600, 5620, 5640, 5660, 5680,</span>
<span class="cm">    5700, 5745, 5765, 5785, 5805, 5825</span>
<span class="cm">	};</span>


<span class="cm">#ifndef IW_ENCODE_NOKEY</span>
<span class="cm">#define IW_ENCODE_NOKEY         0x0800</span>
<span class="cm">#define IW_ENCODE_MODE  (IW_ENCODE_DISABLED | IW_ENCODE_RESTRICTED | IW_ENCODE_OPEN)</span>
<span class="cm">#endif</span>

<span class="cm">static const struct iw_handler_def	iwctl_handler_def;</span>
<span class="cm">*/</span>

<span class="cm">/*---------------------  Static Functions  --------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vt6656_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vt6656_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM	</span><span class="cm">/* Minimal support for suspend and resume */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vt6656_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vt6656_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">device_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>

<span class="k">static</span> <span class="n">BOOL</span> <span class="n">device_init_registers</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">DEVICE_INIT_TYPE</span> <span class="n">InitType</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BOOL</span> <span class="n">device_init_defrag_cb</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init_diversity_timer</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">device_dma0_tx_80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">ethtool_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">useraddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_tx_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_rx_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_int_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_free_frag_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BOOL</span> <span class="n">device_alloc_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">Read_config_file</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Config_FileOperation</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">Config_FileGetParameter</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">source</span><span class="p">);</span>

<span class="k">static</span> <span class="n">BOOL</span> <span class="n">device_release_WPADEV</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">usb_device_reset</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">);</span>



<span class="cm">/*---------------------  Export Variables  --------------------------*/</span>

<span class="cm">/*---------------------  Export Functions  --------------------------*/</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">device_set_options</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">BYTE</span>    <span class="n">abyBroadcastAddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>
    <span class="n">BYTE</span>    <span class="n">abySNAP_RFC1042</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
    <span class="n">u8</span> <span class="n">abySNAP_Bridgetunnel</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">};</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abySNAP_RFC1042</span><span class="p">,</span> <span class="n">abySNAP_RFC1042</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abySNAP_Bridgetunnel</span><span class="p">,</span> <span class="n">abySNAP_Bridgetunnel</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbTD</span> <span class="o">=</span> <span class="n">TX_DESC_DEF0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbRD</span> <span class="o">=</span> <span class="n">RX_DESC_DEF0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uChannel</span> <span class="o">=</span> <span class="n">CHANNEL_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wRTSThreshold</span> <span class="o">=</span> <span class="n">RTS_THRESH_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wFragmentationThreshold</span> <span class="o">=</span> <span class="n">FRAG_THRESH_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortRetryLimit</span> <span class="o">=</span> <span class="n">SHORT_RETRY_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLongRetryLimit</span> <span class="o">=</span> <span class="n">LONG_RETRY_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wMaxTransmitMSDULifetime</span> <span class="o">=</span> <span class="n">DEFAULT_MSDU_LIFETIME</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortPreamble</span> <span class="o">=</span> <span class="n">PREAMBLE_TYPE_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ePSMode</span> <span class="o">=</span> <span class="n">PS_MODE_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">b11hEnable</span> <span class="o">=</span> <span class="n">X80211h_MODE_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eOPMode</span> <span class="o">=</span> <span class="n">OP_MODE_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">=</span> <span class="n">DATA_RATE_DEF</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span> <span class="o">&lt;</span> <span class="n">RATE_AUTO</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">=</span> <span class="n">BBP_TYPE_DEF</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPacketType</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAutoFBCtrl</span> <span class="o">=</span> <span class="n">AUTO_FB_0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bUpdateBBVGA</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byFOETuning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAutoPwrTunning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCTSDuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPreambleType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bExistSWNetAddr</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>pDevice->bDiversityRegCtlON = TRUE;</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityRegCtlON</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_init_diversity_timer</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">TimerSQ3CallBack</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>

    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">TimerSQ3CallBack</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>

    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pDevice</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">TimerFunction</span><span class="p">)</span><span class="n">TimerSQ3Tmax3CallBack</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Initialiation of MAC &amp; BBP registers</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">BOOL</span> <span class="nf">device_init_registers</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">DEVICE_INIT_TYPE</span> <span class="n">InitType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">abyBroadcastAddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>
    <span class="n">u8</span> <span class="n">abySNAP_RFC1042</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
    <span class="n">u8</span> <span class="n">abySNAP_Bridgetunnel</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">};</span>
    <span class="n">BYTE</span>            <span class="n">byAntenna</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">ii</span><span class="p">;</span>
    <span class="n">CMD_CARD_INIT</span>   <span class="n">sInitCmd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ntStatus</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">RSP_CARD_INIT</span>   <span class="n">sInitRsp</span><span class="p">;</span>
    <span class="n">PSMgmtObject</span>    <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">BYTE</span>            <span class="n">byTmp</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byCalibTXIQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byCalibTXDC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BYTE</span>            <span class="n">byCalibRXIQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;----&gt;INIbInitAdapter. [%d][%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">InitType</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byPacketType</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">InitType</span> <span class="o">==</span> <span class="n">DEVICE_INIT_COLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="n">abyBroadcastAddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abySNAP_RFC1042</span><span class="p">,</span> <span class="n">abySNAP_RFC1042</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abySNAP_Bridgetunnel</span><span class="p">,</span>
		       <span class="n">abySNAP_Bridgetunnel</span><span class="p">,</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">FIRMWAREbCheckVersion</span><span class="p">(</span><span class="n">pDevice</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">FIRMWAREbDownload</span><span class="p">(</span><span class="n">pDevice</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">FIRMWAREbBrach2Sram</span><span class="p">(</span><span class="n">pDevice</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; FIRMWAREbBrach2Sram fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                  	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; FIRMWAREbDownload fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">BBbVT3184Init</span><span class="p">(</span><span class="n">pDevice</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; BBbVT3184Init fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">sInitCmd</span><span class="p">.</span><span class="n">byInitClass</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span><span class="n">InitType</span><span class="p">;</span>
    <span class="n">sInitCmd</span><span class="p">.</span><span class="n">bExistSWNetAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bExistSWNetAddr</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
	<span class="n">sInitCmd</span><span class="p">.</span><span class="n">bySWNetAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
    <span class="n">sInitCmd</span><span class="p">.</span><span class="n">byShortRetryLimit</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byShortRetryLimit</span><span class="p">;</span>
    <span class="n">sInitCmd</span><span class="p">.</span><span class="n">byLongRetryLimit</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLongRetryLimit</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>issue Card_init command to device</p></td><td class="code"><div class="highlight"><pre>    <span class="n">ntStatus</span> <span class="o">=</span> <span class="n">CONTROLnsRequestOut</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                    <span class="n">MESSAGE_TYPE_CARDINIT</span><span class="p">,</span>
                                    <span class="mi">0</span><span class="p">,</span>
                                    <span class="mi">0</span><span class="p">,</span>
                                    <span class="k">sizeof</span><span class="p">(</span><span class="n">CMD_CARD_INIT</span><span class="p">),</span>
                                    <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sInitCmd</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">ntStatus</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot; Issue Card init fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">InitType</span> <span class="o">==</span> <span class="n">DEVICE_INIT_COLD</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">ntStatus</span> <span class="o">=</span> <span class="n">CONTROLnsRequestIn</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">MESSAGE_TYPE_INIT_RSP</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">RSP_CARD_INIT</span><span class="p">),</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sInitRsp</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ntStatus</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Cardinit request in status fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Local ID for AES functions</p></td><td class="code"><div class="highlight"><pre>        <span class="n">ntStatus</span> <span class="o">=</span> <span class="n">CONTROLnsRequestIn</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                    <span class="n">MESSAGE_TYPE_READ</span><span class="p">,</span>
                                    <span class="n">MAC_REG_LOCALID</span><span class="p">,</span>
                                    <span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span>
                                    <span class="mi">1</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byLocalID</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">ntStatus</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Do MACbSoftwareReset in MACvInitialize
force CCK</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCCK</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bProtectMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>          <span class="c1">//Only used in 11g type, sync with ERP IE</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bNonERPPresent</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bBarkerPreambleMd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bFixRate</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uConnectionRate</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11B</span> <span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_11M</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wCurrentRate</span> <span class="o">=</span> <span class="n">RATE_54M</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">CHvInitChannelTable</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopOFDMBasicRate</span> <span class="o">=</span> <span class="n">RATE_24M</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTopCCKBasicRate</span> <span class="o">=</span> <span class="n">RATE_1M</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRevId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="c1">//Target to IF pin while programming to RF chip.</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCurPwr</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCCKPwr</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_PWR_CCK</span><span class="p">];</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOFDMPwrG</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_PWR_OFDMG</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Load power Table</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="mi">14</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="n">EEP_OFS_CCK_PWR_TBL</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byCCKPwr</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="n">EEP_OFS_OFDM_PWR_TBL</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOFDMPwrG</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>original zonetype is USA,but customize zonetype is europe,
then need recover 12,13 ,14 channel  with 11 channel</p></td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">ZoneType_Japan</span><span class="p">)</span> <span class="o">||</span>
	        <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ZONETYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">ZoneType_Europe</span><span class="p">))</span><span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOriginalZonetype</span> <span class="o">==</span> <span class="n">ZoneType_USA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCCKPwrTbl</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
			<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMPwrTbl</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="p">}</span>
	  <span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>{{ RobertYu: 20041124</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOFDMPwrA</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">;</span> <span class="c1">// same as RFbMA2829SelectChannel</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Load OFDM A Power Table</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">CB_MAX_CHANNEL_5G</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//RobertYu:20041224, bug using CB_MAX_CHANNEL</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMAPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="n">EEP_OFS_OFDMA_PWR_TBL</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMAPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyOFDMAPwrTbl</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byOFDMPwrA</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>}} RobertYu</p></td><td class="code"><div class="highlight"><pre>        <span class="n">byAntenna</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_ANTENNA</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byAntenna</span> <span class="o">&amp;</span> <span class="n">EEP_ANTINV</span><span class="p">)</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

        <span class="n">byAntenna</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">EEP_ANTENNA_AUX</span> <span class="o">|</span> <span class="n">EEP_ANTENNA_MAIN</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">byAntenna</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// if not set default is All</span>
            <span class="n">byAntenna</span> <span class="o">=</span> <span class="p">(</span><span class="n">EEP_ANTENNA_AUX</span> <span class="o">|</span> <span class="n">EEP_ANTENNA_MAIN</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">byAntenna</span> <span class="o">==</span> <span class="p">(</span><span class="n">EEP_ANTENNA_AUX</span> <span class="o">|</span> <span class="n">EEP_ANTENNA_MAIN</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAntennaCount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwTxAntennaSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwRxAntennaSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_A</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityRegCtlON</span><span class="p">)</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityEnable</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityEnable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityEnable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAntennaCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwTxAntennaSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dwRxAntennaSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">byAntenna</span> <span class="o">&amp;</span> <span class="n">EEP_ANTENNA_AUX</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_A</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_A</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTxRxAntInv</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_A</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxAntennaMode</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulDiversityNValue</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">255</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulDiversityMValue</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTMax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTMax2</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulSQ3TH</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byTMax3</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Get Auto Fall Back Type</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byAutoFBCtrl</span> <span class="o">=</span> <span class="n">AUTO_FB_0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Set SCAN Time</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uScanTime</span> <span class="o">=</span> <span class="n">WLAN_SCAN_MINITIME</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>default Auto Mode
pDevice->NetworkType = Ndis802_11Automode;</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eConfigPHYMode</span> <span class="o">=</span> <span class="n">PHY_TYPE_AUTO</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">=</span> <span class="n">BB_TYPE_11G</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>initialize BBP registers</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ulTxPower</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Get Channel range</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byMinChannel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byMaxChannel</span> <span class="o">=</span> <span class="n">CB_MAX_CHANNEL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Get RFType</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRFType</span> <span class="o">=</span> <span class="n">sInitRsp</span><span class="p">.</span><span class="n">byRFType</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRFType</span> <span class="o">&amp;</span> <span class="n">RF_EMU</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>force change RevID for VT3253 emu</p></td><td class="code"><div class="highlight"><pre>            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRevId</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Load EEPROM calibrated vt3266 parameters</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRFType</span> <span class="o">==</span> <span class="n">RF_VT3226D0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_MAJOR_VER</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_MINOR_VER</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x4</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">byCalibTXIQ</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_CALIB_TX_IQ</span><span class="p">];</span>
                <span class="n">byCalibTXDC</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_CALIB_TX_DC</span><span class="p">];</span>
                <span class="n">byCalibRXIQ</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_CALIB_RX_IQ</span><span class="p">];</span>
                <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">byCalibTXIQ</span> <span class="o">||</span> <span class="n">byCalibTXDC</span> <span class="o">||</span> <span class="n">byCalibRXIQ</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="n">ControlvWriteByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">MESSAGE_REQUEST_BBREG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span> <span class="c1">// CR255, Set BB to support TX/RX IQ and DC compensation Mode</span>
                    <span class="n">ControlvWriteByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">MESSAGE_REQUEST_BBREG</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="n">byCalibTXIQ</span><span class="p">);</span> <span class="c1">// CR251, TX I/Q Imbalance Calibration</span>
                    <span class="n">ControlvWriteByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">MESSAGE_REQUEST_BBREG</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="n">byCalibTXDC</span><span class="p">);</span> <span class="c1">// CR252, TX DC-Offset Calibration</span>
                    <span class="n">ControlvWriteByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">MESSAGE_REQUEST_BBREG</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="n">byCalibRXIQ</span><span class="p">);</span> <span class="c1">// CR253, RX I/Q Imbalance Calibration</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>turn off BB Calibration compensation</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">ControlvWriteByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">MESSAGE_REQUEST_BBREG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span> <span class="c1">// CR255</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_PASSIVE</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">;</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uIBSSChannel</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uChannel</span><span class="p">;</span>
        <span class="n">CARDbSetMediaChannel</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCurrChannel</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>get Permanent network address</p></td><td class="code"><div class="highlight"><pre>        <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPermanentNetAddr</span><span class="p">,</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sInitRsp</span><span class="p">.</span><span class="n">byNetAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">,</span>
	       <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyPermanentNetAddr</span><span class="p">,</span>
	       <span class="n">ETH_ALEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>if exist SW network address, use SW network address.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;Network address = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Set BB and packet type at the same time.
Set Short Slot Time, xIFS, and RSPINF.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBType</span> <span class="o">==</span> <span class="n">BB_TYPE_11A</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CARDbAddBasicRate</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RATE_6M</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bShortSlotTime</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">CARDbAddBasicRate</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">RATE_1M</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bShortSlotTime</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">BBvSetShortSlotTime</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">CARDvSetBSSMode</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bUpdateBBVGA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBBVGA</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGANew</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byBBVGACurrent</span><span class="p">;</span>
        <span class="n">BBvSetVGAGainOffset</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyBBVGA</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRadioCtl</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyEEPROM</span><span class="p">[</span><span class="n">EEP_OFS_RADIOCTL</span><span class="p">];</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bHWRadioOff</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRadioCtl</span> <span class="o">&amp;</span> <span class="n">EEP_RADIOCTL_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">ntStatus</span> <span class="o">=</span> <span class="n">CONTROLnsRequestIn</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                                    <span class="n">MESSAGE_TYPE_READ</span><span class="p">,</span>
                                    <span class="n">MAC_REG_GPIOCTL1</span><span class="p">,</span>
                                    <span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span>
                                    <span class="mi">1</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">byTmp</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">ntStatus</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">byTmp</span> <span class="o">&amp;</span> <span class="n">GPIO3_DATA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bHWRadioOff</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">MAC_REG_GPIOCTL1</span><span class="p">,</span><span class="n">GPIO3_INTMD</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">MACvRegBitsOff</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">MAC_REG_GPIOCTL1</span><span class="p">,</span><span class="n">GPIO3_INTMD</span><span class="p">);</span>
            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bHWRadioOff</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="c1">//EEP_RADIOCTL_ENABLE</span>

    <span class="n">ControlvMaskByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span><span class="n">MAC_REG_PAPEDELAY</span><span class="p">,</span><span class="n">LEDSTS_TMLEN</span><span class="p">,</span><span class="mh">0x38</span><span class="p">);</span>
    <span class="n">ControlvMaskByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span><span class="n">MAC_REG_PAPEDELAY</span><span class="p">,</span><span class="n">LEDSTS_STS</span><span class="p">,</span><span class="n">LEDSTS_SLOW</span><span class="p">);</span>
    <span class="n">MACvRegBitsOn</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">MAC_REG_GPIOCTL0</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bHWRadioOff</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRadioControlOff</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">CARDbRadioPowerOff</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">CARDbRadioPowerOn</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="s">&quot;&lt;----INIbInitAdapter Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BOOL</span> <span class="nf">device_release_WPADEV</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="n">wpahdr</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>wait<em>queue</em>head<em>t    Set</em>wait;
send device close to wpa_supplicnat layer</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="o">==</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">wpahdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">viawget_wpa_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
                 <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIAWGET_DEVICECLOSE_MSG</span><span class="p">;</span>
                 <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">wpahdr</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">skb_put</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">viawget_wpa_header</span><span class="p">));</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">wpadev</span><span class="p">;</span>
		 <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
                 <span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
                 <span class="n">netif_rx</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
                 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>wait release WPADEV
   init<em>waitqueue</em>head(&amp;Set<em>wait);
   wait</em>event<em>timeout(Set</em>wait, ((pDevice->wpadev==NULL)&amp;&amp;(pDevice->skb == NULL)),5*HZ);    //1s wait</p></td><td class="code"><div class="highlight"><pre>              <span class="k">while</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span><span class="o">==</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
                 <span class="n">schedule_timeout</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">20</span><span class="p">);</span>          <span class="c1">//wait 50ms</span>
                 <span class="n">ii</span><span class="o">++</span><span class="p">;</span>
	        <span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">)</span>
		  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
           <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM	</span><span class="cm">/* Minimal support for suspend and resume */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt6656_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span> <span class="n">device</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span> <span class="o">||</span> <span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span>
		<span class="n">device_close</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt6656_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span> <span class="n">device</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span> <span class="o">||</span> <span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span>
		<span class="n">device_open</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">device_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">ndo_open</span>               <span class="o">=</span> <span class="n">device_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_stop</span>               <span class="o">=</span> <span class="n">device_close</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_do_ioctl</span>           <span class="o">=</span> <span class="n">device_ioctl</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_get_stats</span>          <span class="o">=</span> <span class="n">device_get_stats</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_start_xmit</span>         <span class="o">=</span> <span class="n">device_xmit</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ndo_set_rx_mode</span>	    <span class="o">=</span> <span class="n">device_set_multi</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">vt6656_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">fake_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PSDevice</span> <span class="n">pDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s Ver. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DEVICE_FULL_DRV_NAM</span><span class="p">,</span> <span class="n">DEVICE_VERSION</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Copyright (c) 2004 VIA Networking Technologies, Inc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">udev</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DEVICE_INFO</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEVICE_NAME</span> <span class="s">&quot;: allocate net device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pDevice</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DEVICE_INFO</span><span class="p">));</span>

	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>

	<span class="n">device_set_options</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">tx_80211</span> <span class="o">=</span> <span class="n">device_dma0_tx_80211</span><span class="p">;</span>
	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">.</span><span class="n">pAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device_netdev_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">iwctl_handler_def</span><span class="p">;</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">pDevice</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">fake_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEVICE_NAME</span> <span class="s">&quot; Failed to register netdev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_device_reset</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RT_INSMOD_EVENT_FLAG</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">IFNAMSIZ</span><span class="p">;</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">IWEVCUSTOM</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span>
				    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="nl">err_nomem:</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_tx_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PUSB_SEND_CONTEXT</span> <span class="n">pTxContext</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbTD</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">pTxContext</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>de-allocate URBs</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pTxContext</span><span class="o">-&gt;</span><span class="n">pUrb</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pTxContext</span><span class="o">-&gt;</span><span class="n">pUrb</span><span class="p">);</span>
            <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pTxContext</span><span class="o">-&gt;</span><span class="n">pUrb</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">kfree</span><span class="p">(</span><span class="n">pTxContext</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_rx_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PRCB</span> <span class="n">pRCB</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbRD</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">pRCB</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apRCB</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>de-allocate URBs</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">pUrb</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">pUrb</span><span class="p">);</span>
            <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">pUrb</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>de-allocate skb</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
            <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pRCBMem</span><span class="p">);</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_device_reset</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
 <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
 <span class="n">status</span> <span class="o">=</span> <span class="n">usb_reset_device</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;usb_device_reset fail status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_int_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">intBuf</span><span class="p">.</span><span class="n">pDataBuf</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">BOOL</span> <span class="nf">device_alloc_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">PUSB_SEND_CONTEXT</span> <span class="n">pTxContext</span><span class="p">;</span>
    <span class="n">PRCB</span> <span class="n">pRCB</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>


    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbTD</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">pTxContext</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">USB_SEND_CONTEXT</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pTxContext</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s : allocate tx usb context failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">free_tx</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apTD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pTxContext</span><span class="p">;</span>
	<span class="n">pTxContext</span><span class="o">-&gt;</span><span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>allocate URBs</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pTxContext</span><span class="o">-&gt;</span><span class="n">pUrb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pTxContext</span><span class="o">-&gt;</span><span class="n">pUrb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;alloc tx urb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">free_tx</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pTxContext</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>allocate rcb mem</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pRCBMem</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">RCB</span><span class="p">)</span> <span class="o">*</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbRD</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pRCBMem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s : alloc rx usb context failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">free_tx</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">FirstRecvFreeList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">LastRecvFreeList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">FirstRecvMngList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">LastRecvMngList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">NumRecvFreeList</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pRCB</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRCB</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pRCBMem</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbRD</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">apRCB</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">pRCB</span><span class="p">;</span>
	<span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>allocate URBs</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">pUrb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">pUrb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span><span class="s">&quot; Failed to alloc rx urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">free_rx_tx</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span><span class="s">&quot; Failed to alloc rx skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">free_rx_tx</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
        <span class="n">pRCB</span><span class="o">-&gt;</span><span class="n">bBoolInUse</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">EnqueueRCB</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">FirstRecvFreeList</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">LastRecvFreeList</span><span class="p">,</span> <span class="n">pRCB</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">NumRecvFreeList</span><span class="o">++</span><span class="p">;</span>
        <span class="n">pRCB</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>


	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span><span class="s">&quot;Failed to alloc control urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">goto</span> <span class="n">free_rx_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span><span class="s">&quot;Failed to alloc int urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">);</span>
	    <span class="k">goto</span> <span class="n">free_rx_tx</span><span class="p">;</span>
	<span class="p">}</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">intBuf</span><span class="p">.</span><span class="n">pDataBuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_INTERRUPT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">intBuf</span><span class="p">.</span><span class="n">pDataBuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span><span class="s">&quot;Failed to alloc int buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">);</span>
	    <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="p">);</span>
	    <span class="k">goto</span> <span class="n">free_rx_tx</span><span class="p">;</span>
	<span class="p">}</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="nl">free_rx_tx:</span>
    <span class="n">device_free_rx_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

<span class="nl">free_tx:</span>
    <span class="n">device_free_tx_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>




<span class="k">static</span> <span class="n">BOOL</span> <span class="nf">device_init_defrag_cb</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">PSDeFragControlBlock</span> <span class="n">pDeF</span><span class="p">;</span>

    <span class="cm">/* Init the fragment ctl entries */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CB_MAX_RX_FRAG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pDeF</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_alloc_frag_buf</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">pDeF</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can not alloc frag bufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">free_frag</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbDFCB</span> <span class="o">=</span> <span class="n">CB_MAX_RX_FRAG</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbFreeDFCB</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">cbDFCB</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="nl">free_frag:</span>
    <span class="n">device_free_frag_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_free_frag_bufs</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDeFragControlBlock</span> <span class="n">pDeF</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CB_MAX_RX_FRAG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">pDeF</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sRxDFCB</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
            <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="n">BOOL</span> <span class="nf">device_alloc_frag_buf</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">PSDeFragControlBlock</span> <span class="n">pDeF</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
    <span class="n">pDeF</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*-----------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="nf">device_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span>    <span class="n">pDevice</span><span class="o">=</span><span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

     <span class="k">extern</span> <span class="n">SWPAResult</span> <span class="n">wpa_Result</span><span class="p">;</span>
     <span class="n">memset</span><span class="p">(</span><span class="n">wpa_Result</span><span class="p">.</span><span class="n">ifname</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wpa_Result</span><span class="p">.</span><span class="n">ifname</span><span class="p">));</span>
     <span class="n">wpa_Result</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">wpa_Result</span><span class="p">.</span><span class="n">key_mgmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">wpa_Result</span><span class="p">.</span><span class="n">eap_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">wpa_Result</span><span class="p">.</span><span class="n">authenticated</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fWPA_Authened</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; device_open...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="n">MAX_TOTAL_SIZE_WITH_ALL_HEADERS</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">device_alloc_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; device_alloc_bufs fail... </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">device_init_defrag_cb</span><span class="p">(</span><span class="n">pDevice</span><span class="p">)</span><span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; Initial defragement cb fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">free_rx_tx</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">MP_CLEAR_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_DISCONNECTED</span><span class="p">);</span>
    <span class="n">MP_CLEAR_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_CONTROL_READS</span><span class="p">);</span>
    <span class="n">MP_CLEAR_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_CONTROL_WRITES</span><span class="p">);</span>
    <span class="n">MP_SET_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_POST_READS</span><span class="p">);</span>
    <span class="n">MP_SET_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_POST_WRITES</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>read config file</p></td><td class="code"><div class="highlight"><pre>    <span class="n">Read_config_file</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">device_init_registers</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">DEVICE_INIT_COLD</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; init register fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">free_all</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">device_set_multi</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Init for Key Management</p></td><td class="code"><div class="highlight"><pre>    <span class="n">KeyvInitTable</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">.</span><span class="n">abyMACAddr</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyCurrentNetAddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bStopTx0Pkt</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bStopDataPkt</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bIsRoaming</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableRoaming</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityRegCtlON</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">device_init_diversity_timer</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">vMgrObjectInit</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">RxMngWorkItem</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">RXvMngWorkItem</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ReadWorkItem</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">RXvWorkItem</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">EventWorkItem</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">INTvWorkItem</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">.</span><span class="n">sTimerSecondCallback</span><span class="p">));</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">int_interval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>  <span class="c1">//Max 100 microframes.</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span>

    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bIsRxWorkItemQueued</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fKillEventPollingThread</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEventAvailable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPADEVUp</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="cp">#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep0</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep1</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep2</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bwextstep3</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPASuppWextEnabled</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byReAssocCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">RXvWorkItem</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">INTvWorkItem</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Patch: if WEP key already set by iwconfig but device not yet open</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bTransmitKey</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
         <span class="n">KeybSetDefaultKey</span><span class="p">(</span> <span class="n">pDevice</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sKey</span><span class="p">),</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byKeyIndex</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">),</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">uKeyLength</span><span class="p">,</span>
                            <span class="nb">NULL</span><span class="p">,</span>
                            <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">abyKey</span><span class="p">,</span>
                            <span class="n">KEY_CTL_WEP</span>
                          <span class="p">);</span>
         <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
         <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">.</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_RUN_AP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>mike:mark@2008-11-10</p></td><td class="code"><div class="highlight"><pre>	  <span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	  <span class="cm">/* bScheduleCommand((void *) pDevice, WLAN_CMD_SSID, NULL); */</span>
    <span class="p">}</span>


    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">;</span>

<span class="p">{</span>
  <span class="k">union</span> <span class="n">iwreq_data</span>      <span class="n">wrqu</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
  <span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RT_UPDEV_EVENT_FLAG</span><span class="p">;</span>
  <span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVCUSTOM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_open success.. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_all:</span>
    <span class="n">device_free_frag_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
<span class="nl">free_rx_tx:</span>
    <span class="n">device_free_rx_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_tx_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_int_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="p">);</span>
    <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">);</span>
    <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="p">);</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_open fail.. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span>  <span class="nf">device_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span>    <span class="n">pDevice</span><span class="o">=</span><span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>     <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>

        <span class="kt">int</span> <span class="n">uu</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_close1 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="p">{</span>
  <span class="k">union</span> <span class="n">iwreq_data</span>      <span class="n">wrqu</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
  <span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RT_DOWNDEV_EVENT_FLAG</span><span class="p">;</span>
  <span class="n">wireless_send_event</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVCUSTOM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_DISASSOCIATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">mdelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
    <span class="p">}</span>

<span class="n">device_release_WPADEV</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

        <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">bShareKeyAlgorithm</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEncryptionEnable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">uu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uu</span> <span class="o">&lt;</span> <span class="n">MAX_KEY_TABLE</span><span class="p">;</span> <span class="n">uu</span><span class="o">++</span><span class="p">)</span>
                <span class="n">MACvDisableKeyEntry</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">uu</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_UNPLUG</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MACbShutdown</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">MP_SET_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_DISCONNECTED</span><span class="p">);</span>
    <span class="n">MP_CLEAR_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_POST_WRITES</span><span class="p">);</span>
    <span class="n">MP_CLEAR_FLAG</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">fMP_POST_READS</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">fKillEventPollingThread</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerCommand</span><span class="p">);</span>
    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">sTimerSecondCallback</span><span class="p">);</span>

    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sTimerTxData</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bDiversityRegCtlON</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax1</span><span class="p">);</span>
        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax2</span><span class="p">);</span>
        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">TimerSQ3Tmax3</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">RxMngWorkItem</span><span class="p">);</span>
    <span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">ReadWorkItem</span><span class="p">);</span>
    <span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">EventWorkItem</span><span class="p">);</span>

   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bRoaming</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bIsRoaming</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
   <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bEnableRoaming</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCmdRunning</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
    <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>

    <span class="n">device_free_tx_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_rx_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_int_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
    <span class="n">device_free_frag_bufs</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="p">);</span>
    <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pControlURB</span><span class="p">);</span>
    <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">pInterruptURB</span><span class="p">);</span>

    <span class="n">BSSvClearNodeDBTable</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span><span class="p">(</span><span class="o">~</span><span class="n">DEVICE_FLAGS_OPENED</span><span class="p">);</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;device_close2 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">vt6656_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span> <span class="n">device</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">{</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
		<span class="n">req</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RT_RMMOD_EVENT_FLAG</span><span class="p">;</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVCUSTOM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">device_release_WPADEV</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVICE_FLAGS_UNPLUG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">wpa_set_wpadev</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_dma0_tx_80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span> <span class="n">pDevice</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bStopTx0Pkt</span><span class="p">))</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vDMA0_tx_80211</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PSDevice</span> <span class="n">pDevice</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bStopDataPkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nsDMA_tx_packet</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">TYPE_AC0DMA</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="k">const</span> <span class="n">ethernet_polynomial</span> <span class="o">=</span> <span class="mh">0x04c11db7U</span><span class="p">;</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">ether_crc</span><span class="p">(</span><span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">crc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">current_octet</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">,</span> <span class="n">current_octet</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span>
                <span class="p">((</span><span class="n">crc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">current_octet</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">ethernet_polynomial</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>find out  the start  position of str2 from str1</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">kstrstr</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str1</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str2</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">str1_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str1</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">str2_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str2</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">str1_len</span> <span class="o">&gt;=</span> <span class="n">str2_len</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">str1_len</span><span class="o">--</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span><span class="n">str2</span><span class="p">,</span><span class="n">str2_len</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">str1</span><span class="p">;</span>
        <span class="n">str1</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Config_FileGetParameter</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf1</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf2</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">start_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">end_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
    <span class="n">strcat</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
    <span class="n">strcat</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">);</span>
    <span class="n">source</span><span class="o">+=</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>find target string start point</p></td><td class="code"><div class="highlight"><pre>    <span class="n">start_p</span> <span class="o">=</span> <span class="n">kstrstr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="n">buf1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">start_p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>check if current config line is marked by "#" ??</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">start_p</span> <span class="o">-</span> <span class="n">ii</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">start_p</span> <span class="o">-</span> <span class="n">ii</span><span class="p">,</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>find target string end point</p></td><td class="code"><div class="highlight"><pre>     <span class="n">end_p</span> <span class="o">=</span> <span class="n">kstrstr</span><span class="p">(</span><span class="n">start_p</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">end_p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>       <span class="c1">//can&#39;t find &quot;\n&quot;,but don&#39;t care</span>
          <span class="n">end_p</span><span class="o">=</span><span class="n">start_p</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">start_p</span><span class="p">);</span>   <span class="c1">//no include &quot;\n&quot;</span>
       <span class="p">}</span>

   <span class="n">memset</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
   <span class="n">memcpy</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span><span class="n">start_p</span><span class="p">,</span><span class="n">end_p</span><span class="o">-</span><span class="n">start_p</span><span class="p">);</span>    <span class="c1">//get the tartget line</span>
   <span class="n">buf2</span><span class="p">[</span><span class="n">end_p</span><span class="o">-</span><span class="n">start_p</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>find value</p></td><td class="code"><div class="highlight"><pre>   <span class="n">start_p</span> <span class="o">=</span> <span class="n">kstrstr</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span><span class="s">&quot;=&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">start_p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
   <span class="n">memset</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
   <span class="n">strcpy</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span><span class="n">start_p</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>except space</p></td><td class="code"><div class="highlight"><pre>  <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">tmp_p</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
  	<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">tmp_p</span><span class="o">==</span><span class="sc">&#39; &#39;</span><span class="p">)</span>
	    <span class="n">tmp_p</span><span class="o">++</span><span class="p">;</span>
         <span class="k">else</span>
	  <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

   <span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="n">tmp_p</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">tmp_p</span><span class="p">));</span>
 <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>if read fail,return NULL,or return data pointer;</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">Config_FileOperation</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config_path</span> <span class="o">=</span> <span class="n">CONFIG_PATH</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">file</span>   <span class="o">*</span><span class="n">filp</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>int oldfsuid=0,oldfsgid=0;</p></td><td class="code"><div class="highlight"><pre>    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">set_fs</span> <span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
    <span class="cm">/* Can&#39;t do this anymore, so we rely on correct filesystem permissions:</span>

<span class="cm">//DIVIDER</span>
<span class="cm">    oldfsuid=current-&gt;fsuid;</span>
<span class="cm">    oldfsgid=current-&gt;fsgid;</span>
<span class="cm">    current-&gt;fsuid = 0;</span>
<span class="cm">    current-&gt;fsgid = 0;</span>
<span class="cm">    */</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>Make sure a caller can read or write power as root</p></td><td class="code"><div class="highlight"><pre>      <span class="n">filp</span> <span class="o">=</span> <span class="n">filp_open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span> <span class="p">{</span>
	     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Config_FileOperation file Not exist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	     <span class="n">result</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
             <span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	  <span class="p">}</span>

     <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="o">||!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">))</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;file %s cann&#39;t readable or writable?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">config_path</span><span class="p">);</span>
	  <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	  <span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
     	<span class="p">}</span>

    <span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;allocate mem for file fail?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;read file error?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">error1:</span>
  <span class="k">if</span><span class="p">(</span><span class="n">filp_close</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span><span class="nb">NULL</span><span class="p">))</span>
       <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Config_FileOperation:close file fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">error2:</span>
  <span class="n">set_fs</span> <span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">  current-&gt;fsuid=oldfsuid;</span>
<span class="cm">  current-&gt;fsgid=oldfsgid;</span>
<span class="cm">  */</span>

<span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">buffer</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
  <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>open file</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">Read_config_file</span><span class="p">(</span><span class="n">PSDevice</span> <span class="n">pDevice</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmpbuffer</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>return --->-1:fail;  >=0:successful</p></td><td class="code"><div class="highlight"><pre> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">config_file</span><span class="p">.</span><span class="n">ZoneType</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">config_file</span><span class="p">.</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">config_file</span><span class="p">.</span><span class="n">eEncryptionStatus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="n">buffer</span> <span class="o">=</span> <span class="n">Config_FileOperation</span><span class="p">(</span><span class="n">pDevice</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">result</span> <span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
     <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>init config setting</p></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Config_FileGetParameter</span><span class="p">(</span><span class="s">&quot;ZONETYPE&quot;</span><span class="p">,</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="s">&quot;USA&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">config_file</span><span class="p">.</span><span class="n">ZoneType</span><span class="o">=</span><span class="n">ZoneType_USA</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="s">&quot;JAPAN&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">config_file</span><span class="p">.</span><span class="n">ZoneType</span><span class="o">=</span><span class="n">ZoneType_Japan</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="s">&quot;EUROPE&quot;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">config_file</span><span class="p">.</span><span class="n">ZoneType</span><span class="o">=</span><span class="n">ZoneType_Europe</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown Zonetype[%s]?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">tmpbuffer</span><span class="p">);</span>
   <span class="p">}</span>
 <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>get zonetype</p></td><td class="code"><div class="highlight"><pre>  <span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">));</span>
       <span class="k">if</span><span class="p">(</span><span class="n">Config_FileGetParameter</span><span class="p">(</span><span class="s">&quot;AUTHENMODE&quot;</span><span class="p">,</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="n">buffer</span><span class="p">)</span><span class="o">==</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">config_file</span><span class="p">.</span><span class="n">eAuthenMode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
       <span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">));</span>
       <span class="k">if</span><span class="p">(</span><span class="n">Config_FileGetParameter</span><span class="p">(</span><span class="s">&quot;ENCRYPTIONMODE&quot;</span><span class="p">,</span><span class="n">tmpbuffer</span><span class="p">,</span><span class="n">buffer</span><span class="p">)</span><span class="o">==</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">config_file</span><span class="p">.</span><span class="n">eEncryptionStatus</span><span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
       <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span>         <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>     <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">u32</span>              <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">int</span>              <span class="n">ii</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
    <span class="n">BYTE</span>             <span class="n">pbyData</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">};</span>
    <span class="n">BYTE</span>             <span class="n">byTmpMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span>              <span class="n">rc</span><span class="p">;</span>


	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">CONTROLnsRequestIn</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                            <span class="n">MESSAGE_TYPE_READ</span><span class="p">,</span>
                            <span class="n">MAC_REG_RCR</span><span class="p">,</span>
                            <span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span>
                            <span class="mi">1</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="n">byTmpMode</span>
                            <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">=</span> <span class="n">byTmpMode</span><span class="p">;</span>

    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;pDevice-&gt;byRxMode in= %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>         <span class="c1">// Set promiscuous.</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_ERR</span><span class="p">,</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Promiscuous mode enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>get other parameter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_MULTICAST</span><span class="o">|</span><span class="n">RCR_BROADCAST</span><span class="o">|</span><span class="n">RCR_UNICAST</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">multicast_limit</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">CONTROLnsRequestOut</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span>
                            <span class="n">MESSAGE_TYPE_WRITE</span><span class="p">,</span>
                            <span class="n">MAC_REG_MAR0</span><span class="p">,</span>
                            <span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span>
                            <span class="mi">8</span><span class="p">,</span>
                            <span class="n">pbyData</span>
                            <span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_MULTICAST</span><span class="o">|</span><span class="n">RCR_BROADCAST</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">bit_nr</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">;</span>
            <span class="n">mc_filter</span><span class="p">[</span><span class="n">bit_nr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_nr</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">MACvWriteMultiAddr</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ii</span><span class="p">));</span>
             <span class="n">MACvWriteMultiAddr</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ii</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RCR_UNICAST</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_MULTICAST</span><span class="o">|</span><span class="n">RCR_BROADCAST</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Unconditionally log net taps.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_MULTICAST</span><span class="o">|</span><span class="n">RCR_BROADCAST</span><span class="p">);</span>
        <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RCR_UNICAST</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ControlvWriteByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span> <span class="n">MAC_REG_RCR</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span><span class="p">);</span>
    <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;pDevice-&gt;byRxMode out= %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">byRxMode</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">device_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PSDevice</span> <span class="n">pDevice</span><span class="o">=</span><span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>  <span class="nf">device_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">PSDevice</span>	        <span class="n">pDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSDevice</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">PSMgmtObject</span>        <span class="n">pMgmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">sMgmtObj</span><span class="p">);</span>
    <span class="n">PSCmdRequest</span>        <span class="n">pReq</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>If AP mode, don't enable RCR_UNICAST. Since hw only compare addr1 with local mac.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="n">wrq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span>                 <span class="n">rc</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SIOCGIWNAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwname</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWNWID</span>:
	<span class="k">case</span> <span class="n">SIOCGIWNWID</span>:     <span class="c1">//0x8b03  support</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>BOOL                bCommit = FALSE;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWFREQ</span>:
	    <span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Set frequency/channel</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWFREQ</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Get frequency/channel</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWESSID</span>:

		<span class="p">{</span>
			<span class="kt">char</span> <span class="n">essid</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">essid</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
					   <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwessid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">),</span> <span class="n">essid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Set desired network name (ESSID)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWESSID</span>:

		<span class="p">{</span>
			<span class="kt">char</span> <span class="n">essid</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">iwctl_giwessid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">),</span> <span class="n">essid</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
						         <span class="n">essid</span><span class="p">,</span>
						         <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWAP</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>Get current network name (ESSID)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWAP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>Get current Access Point (BSSID)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWNICKN</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWNICKN </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>Set desired station name</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWNICKN</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWNICKN </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>Get current station name</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWRATE</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwrate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Set the desired bit-rate</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWRATE</span>:
		<span class="n">iwctl_giwrate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Get the current bit-rate</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWRTS</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwrts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rts</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Set the desired RTS threshold</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWRTS</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwrts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rts</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Get the current RTS threshold</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWFRAG</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwfrag</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frag</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>Set the desired fragmentation threshold</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWFRAG</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwfrag</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frag</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Get the current fragmentation threshold</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWMODE</span>:
    	<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>Set mode of operation</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWMODE</span>:
		<span class="n">iwctl_giwmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>Get mode of operation</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWENCODE</span>:
		<span class="p">{</span>
            <span class="kt">char</span> <span class="n">abyKey</span><span class="p">[</span><span class="n">WLAN_WEP232_KEYLEN</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>


				<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">abyKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WLAN_WEP232_KEYLEN</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">abyKey</span><span class="p">,</span>
				                  <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
				                  <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwencode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">),</span> <span class="n">abyKey</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>Set WEP keys and mode</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWENCODE</span>:

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">{</span>
		    <span class="kt">char</span> <span class="n">abyKey</span><span class="p">[</span><span class="n">WLAN_WEP232_KEYLEN</span><span class="p">];</span>

		    <span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwencode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">),</span> <span class="n">abyKey</span><span class="p">);</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
						        <span class="n">abyKey</span><span class="p">,</span>
						        <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span><span class="p">))</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>Get the WEP keys and mode</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWTXPOW</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWTXPOW </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWTXPOW</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWTXPOW </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWRETRY</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwretry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">retry</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWRETRY</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwretry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">retry</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>Get the current Tx-Power</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWRANGE</span>:

		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">iw_range</span> <span class="n">range</span><span class="p">;</span>

			<span class="n">iwctl_giwrange</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">range</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">)))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWPOWER</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwpower</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">power</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">SIOCSIWPOWER</span>:

		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwpower</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">power</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">SIOCGIWSENS</span>:

	    <span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwsens</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sens</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWSENS</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWSENS </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWAPLIST</span>:
	    <span class="p">{</span>
            <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IW_MAX_AP</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">))];</span>

		    <span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwaplist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="n">buffer</span><span class="p">);</span>
		        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
					                <span class="n">buffer</span><span class="p">,</span>
					               <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">+</span>  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">)))</span>
				        <span class="p">))</span>
				    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		        <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>


<span class="cp">#ifdef WIRELESS_SPY</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>Get range of parameters</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCSIWSPY</span>:

        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWSPY </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>Set the spy list</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">SIOCGIWSPY</span>:

        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWSPY </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#endif </span><span class="c1">// WIRELESS_SPY</span>

	<span class="k">case</span> <span class="n">SIOCGIWPRIV</span>:
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWPRIV </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">		if(wrq-&gt;u.data.pointer) {</span>
<span class="cm">			wrq-&gt;u.data.length = sizeof(iwctl_private_args) / sizeof( iwctl_private_args[0]);</span>

<span class="cm">			if(copy_to_user(wrq-&gt;u.data.pointer,</span>
<span class="cm">					(u_char *) iwctl_private_args,</span>
<span class="cm">					sizeof(iwctl_private_args)))</span>
<span class="cm">				rc = -EFAULT;</span>
<span class="cm">		}</span>
<span class="cm">*/</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef  WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
	<span class="k">case</span> <span class="n">SIOCSIWAUTH</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWAUTH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwauth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">param</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWAUTH</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWAUTH </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwauth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">param</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWGENIE</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWGENIE </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwgenie</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWGENIE</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWGENIE </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwgenie</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWENCODEEXT</span>:
		<span class="p">{</span>
			<span class="kt">char</span> <span class="n">extra</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">)</span><span class="o">+</span><span class="n">MAX_KEY_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWENCODEEXT </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">){</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">)</span><span class="o">+</span><span class="n">MAX_KEY_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">)</span><span class="o">+</span> <span class="n">MAX_KEY_LEN</span><span class="p">)){</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span><span class="p">)){</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwencodeext</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">),</span> <span class="n">extra</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIWENCODEEXT</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCGIWENCODEEXT </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_giwencodeext</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">encoding</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIWMLME</span>:
		<span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot; SIOCSIWMLME </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iwctl_siwmlme</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">),</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#endif </span><span class="c1">// #ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>

    <span class="k">case</span> <span class="n">IOCTL_CMD_TEST</span>:

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
        <span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSCmdRequest</span><span class="p">)</span><span class="n">rq</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>Get the spy list</p></td><td class="code"><div class="highlight"><pre>          <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">wResult</span> <span class="o">=</span> <span class="n">MAGIC_CODE</span><span class="p">;</span>         <span class="c1">//Linking status:0x3142</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>20080130-01,<Remark> by Mike Liu
if(pDevice->bLinkPass==TRUE)</p></td><td class="code"><div class="highlight"><pre>        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">IOCTL_CMD_SET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(((</span><span class="n">PSCmdRequest</span><span class="p">)</span><span class="n">rq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wCmdCode</span> <span class="o">!=</span><span class="n">WLAN_CMD_SET_WPA</span><span class="p">))</span>
		<span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCmdBusy</span><span class="p">)))</span> <span class="p">{</span>
		    <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	    <span class="p">}</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">private_ioctl</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
        <span class="n">clear_bit</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">uCmdBusy</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">IOCTL_CMD_HOSTAPD</span>:

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">vt6656_hostap_ioctl</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">IOCTL_CMD_WPA</span>:

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_FLAGS_OPENED</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">wpa_ioctl</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCETHTOOL</span>:
        <span class="k">return</span> <span class="n">ethtool_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>20080130-02,<Remark> by Mike Liu
 else
 pReq->wResult = MAGIC_CODE+1;    //disconnect status:0x3143</p></td><td class="code"><div class="highlight"><pre>	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
        <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Ioctl command not support..%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>


    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCommit</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eConfigMode</span> <span class="o">==</span> <span class="n">WMAC_CONFIG_AP</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
           <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_RUN_AP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
           <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="p">{</span>
           <span class="n">DBG_PRT</span><span class="p">(</span><span class="n">MSG_LEVEL_DEBUG</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;Commit the settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>All other calls are currently unsupported</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">if</span> <span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">&amp;&amp;</span>
		  <span class="n">memcmp</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrSSID</span><span class="p">,</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">,</span><span class="n">WLAN_IEHDR_LEN</span> <span class="o">+</span> <span class="n">WLAN_SSID_MAXLEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span> <span class="n">WLAN_CMD_DISASSOCIATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
           <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bLinkPass</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	   <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eCurrState</span> <span class="o">=</span> <span class="n">WMAC_STATE_IDLE</span><span class="p">;</span>
	   <span class="n">memset</span><span class="p">(</span><span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyCurrBSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		 <span class="p">}</span>
           <span class="n">ControlvMaskByte</span><span class="p">(</span><span class="n">pDevice</span><span class="p">,</span><span class="n">MESSAGE_REQUEST_MACREG</span><span class="p">,</span><span class="n">MAC_REG_PAPEDELAY</span><span class="p">,</span><span class="n">LEDSTS_STS</span><span class="p">,</span><span class="n">LEDSTS_SLOW</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>2007-1121-01<Modify>by EinsnLiu</p></td><td class="code"><div class="highlight"><pre>           <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef  WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT</span>
           <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">eScanType</span> <span class="o">=</span> <span class="n">WMAC_SCAN_ACTIVE</span><span class="p">;</span>
	   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bWPASuppWextEnabled</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_BSSID_SCAN</span><span class="p">,</span>
				 <span class="n">pMgmt</span><span class="o">-&gt;</span><span class="n">abyDesireSSID</span><span class="p">);</span>
		<span class="n">bScheduleCommand</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pDevice</span><span class="p">,</span>
				 <span class="n">WLAN_CMD_SSID</span><span class="p">,</span>
				 <span class="nb">NULL</span><span class="p">);</span>
           <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">bCommit</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ethtool_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">useraddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ethcmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethcmd</span><span class="p">,</span> <span class="n">useraddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ethcmd</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">ethcmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GDRVINFO</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="n">ETHTOOL_GDRVINFO</span><span class="p">};</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">DEVICE_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">version</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">useraddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">vt6656_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">vt6656_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">DEVICE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">vt6656_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">vt6656_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">vt6656_table</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">vt6656_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">vt6656_resume</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">vt6656_driver</span><span class="p">);</span>

</pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>End Modify</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
