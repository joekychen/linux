<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › android › binder.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>binder.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* binder.c</span>
<span class="cm"> *</span>
<span class="cm"> * Android IPC Subsystem</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007-2008 Google, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2, as published by the Free Software Foundation, and</span>
<span class="cm"> * may be copied, distributed, and modified under those terms.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;linux/fdtable.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/nsproxy.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/rbtree.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;binder.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">binder_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">binder_deferred_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">binder_mmap_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">HLIST_HEAD</span><span class="p">(</span><span class="n">binder_procs</span><span class="p">);</span>
<span class="k">static</span> <span class="n">HLIST_HEAD</span><span class="p">(</span><span class="n">binder_deferred_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">HLIST_HEAD</span><span class="p">(</span><span class="n">binder_dead_nodes</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">binder_debugfs_dir_entry_root</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">binder_debugfs_dir_entry_proc</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">binder_context_mgr_node</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uid_t</span> <span class="n">binder_context_mgr_uid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">binder_last_id</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">binder_deferred_workqueue</span><span class="p">;</span>

<span class="cp">#define BINDER_DEBUG_ENTRY(name) \</span>
<span class="cp">static int binder_##name##_open(struct inode *inode, struct file *file) \</span>
<span class="cp">{ \</span>
<span class="cp">	return single_open(file, binder_##name##_show, inode-&gt;i_private); \</span>
<span class="cp">} \</span>
<span class="cp">\</span>
<span class="cp">static const struct file_operations binder_##name##_fops = { \</span>
<span class="cp">	.owner = THIS_MODULE, \</span>
<span class="cp">	.open = binder_##name##_open, \</span>
<span class="cp">	.read = seq_read, \</span>
<span class="cp">	.llseek = seq_lseek, \</span>
<span class="cp">	.release = single_release, \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">binder_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">);</span>
<span class="n">BINDER_DEBUG_ENTRY</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>

<span class="cm">/* This is only defined in include/asm-arm/sizes.h */</span>
<span class="cp">#ifndef SZ_1K</span>
<span class="cp">#define SZ_1K                               0x400</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef SZ_4M</span>
<span class="cp">#define SZ_4M                               0x400000</span>
<span class="cp">#endif</span>

<span class="cp">#define FORBIDDEN_MMAP_FLAGS                (VM_WRITE)</span>

<span class="cp">#define BINDER_SMALL_BUF_SIZE (PAGE_SIZE * 64)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">BINDER_DEBUG_USER_ERROR</span>             <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_FAILED_TRANSACTION</span>     <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_DEAD_TRANSACTION</span>       <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_OPEN_CLOSE</span>             <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_DEAD_BINDER</span>            <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_DEATH_NOTIFICATION</span>     <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_READ_WRITE</span>             <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_USER_REFS</span>              <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_THREADS</span>                <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_TRANSACTION</span>            <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_TRANSACTION_COMPLETE</span>   <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_FREE_BUFFER</span>            <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_INTERNAL_REFS</span>          <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_BUFFER_ALLOC</span>           <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_PRIORITY_CAP</span>           <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span>
	<span class="n">BINDER_DEBUG_BUFFER_ALLOC_ASYNC</span>     <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">binder_debug_mask</span> <span class="o">=</span> <span class="n">BINDER_DEBUG_USER_ERROR</span> <span class="o">|</span>
	<span class="n">BINDER_DEBUG_FAILED_TRANSACTION</span> <span class="o">|</span> <span class="n">BINDER_DEBUG_DEAD_TRANSACTION</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug_mask</span><span class="p">,</span> <span class="n">binder_debug_mask</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">binder_debug_no_lock</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">proc_no_lock</span><span class="p">,</span> <span class="n">binder_debug_no_lock</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">binder_user_error_wait</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">binder_stop_on_user_error</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_set_stop_on_user_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">param_set_int</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">binder_stop_on_user_error</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_user_error_wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_param_call</span><span class="p">(</span><span class="n">stop_on_user_error</span><span class="p">,</span> <span class="n">binder_set_stop_on_user_error</span><span class="p">,</span>
	<span class="n">param_get_int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_stop_on_user_error</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">);</span>

<span class="cp">#define binder_debug(mask, x...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (binder_debug_mask &amp; mask) \</span>
<span class="cp">			printk(KERN_INFO x); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define binder_user_error(x...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (binder_debug_mask &amp; BINDER_DEBUG_USER_ERROR) \</span>
<span class="cp">			printk(KERN_INFO x); \</span>
<span class="cp">		if (binder_stop_on_user_error) \</span>
<span class="cp">			binder_stop_on_user_error = 2; \</span>
<span class="cp">	} while (0)</span>

<span class="k">enum</span> <span class="n">binder_stat_types</span> <span class="p">{</span>
	<span class="n">BINDER_STAT_PROC</span><span class="p">,</span>
	<span class="n">BINDER_STAT_THREAD</span><span class="p">,</span>
	<span class="n">BINDER_STAT_NODE</span><span class="p">,</span>
	<span class="n">BINDER_STAT_REF</span><span class="p">,</span>
	<span class="n">BINDER_STAT_DEATH</span><span class="p">,</span>
	<span class="n">BINDER_STAT_TRANSACTION</span><span class="p">,</span>
	<span class="n">BINDER_STAT_TRANSACTION_COMPLETE</span><span class="p">,</span>
	<span class="n">BINDER_STAT_COUNT</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">binder_stats</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">br</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">BR_FAILED_REPLY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bc</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">BC_DEAD_BINDER_DONE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">obj_created</span><span class="p">[</span><span class="n">BINDER_STAT_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">obj_deleted</span><span class="p">[</span><span class="n">BINDER_STAT_COUNT</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_stats</span> <span class="n">binder_stats</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">binder_stats_deleted</span><span class="p">(</span><span class="k">enum</span> <span class="n">binder_stat_types</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">binder_stats</span><span class="p">.</span><span class="n">obj_deleted</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">binder_stats_created</span><span class="p">(</span><span class="k">enum</span> <span class="n">binder_stat_types</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">binder_stats</span><span class="p">.</span><span class="n">obj_created</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">binder_transaction_log_entry</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">debug_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">call_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">from_proc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">from_thread</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_proc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_thread</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offsets_size</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">binder_transaction_log</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">full</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_transaction_log_entry</span> <span class="n">entry</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_transaction_log</span> <span class="n">binder_transaction_log</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_transaction_log</span> <span class="n">binder_transaction_log_failed</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_transaction_log_entry</span> <span class="o">*</span><span class="nf">binder_transaction_log_add</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">binder_transaction_log</span> <span class="o">*</span><span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_transaction_log_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">log</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="n">log</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">));</span>
	<span class="n">log</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">log</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">log</span><span class="o">-&gt;</span><span class="n">full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">binder_work</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">BINDER_WORK_TRANSACTION</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">BINDER_WORK_TRANSACTION_COMPLETE</span><span class="p">,</span>
		<span class="n">BINDER_WORK_NODE</span><span class="p">,</span>
		<span class="n">BINDER_WORK_DEAD_BINDER</span><span class="p">,</span>
		<span class="n">BINDER_WORK_DEAD_BINDER_AND_CLEAR</span><span class="p">,</span>
		<span class="n">BINDER_WORK_CLEAR_DEATH_NOTIFICATION</span><span class="p">,</span>
	<span class="p">}</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">binder_node</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">debug_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_work</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rb_node</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">dead_node</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">refs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">internal_strong_refs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">local_weak_refs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">local_strong_refs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cookie</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">has_strong_ref</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pending_strong_ref</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">has_weak_ref</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pending_weak_ref</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">has_async_transaction</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">accept_fds</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">min_priority</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">async_todo</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">binder_ref_death</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_work</span> <span class="n">work</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cookie</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">binder_ref</span> <span class="p">{</span>
	<span class="cm">/* Lookups needed: */</span>
	<span class="cm">/*   node + proc =&gt; ref (transaction) */</span>
	<span class="cm">/*   desc + proc =&gt; ref (transaction, inc/dec ref) */</span>
	<span class="cm">/*   node =&gt; refs + procs (proc exit) */</span>
	<span class="kt">int</span> <span class="n">debug_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rb_node_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rb_node_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">node_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">strong</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">weak</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_ref_death</span> <span class="o">*</span><span class="n">death</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span> <span class="cm">/* free and allocated entries by address */</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rb_node</span><span class="p">;</span> <span class="cm">/* free entry by size or allocated entry */</span>
				<span class="cm">/* by address */</span>
	<span class="kt">unsigned</span> <span class="n">free</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">allow_user_free</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">async_transaction</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">debug_id</span><span class="o">:</span><span class="mi">29</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">transaction</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">target_node</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">offsets_size</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">binder_deferred_state</span> <span class="p">{</span>
	<span class="n">BINDER_DEFERRED_PUT_FILES</span>    <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">BINDER_DEFERRED_FLUSH</span>        <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">BINDER_DEFERRED_RELEASE</span>      <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">binder_proc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">proc_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="n">threads</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="n">nodes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="n">refs_by_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="n">refs_by_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">vma_vm_mm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">deferred_work_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">deferred_work</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">ptrdiff_t</span> <span class="n">user_buffer_offset</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">buffers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="n">free_buffers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="n">allocated_buffers</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">free_async_space</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buffer_size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">buffer_free</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">todo</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">delivered_death</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_threads</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">requested_threads</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">requested_threads_started</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ready_threads</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">default_priority</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_entry</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">BINDER_LOOPER_STATE_REGISTERED</span>  <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">BINDER_LOOPER_STATE_ENTERED</span>     <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">BINDER_LOOPER_STATE_EXITED</span>      <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">BINDER_LOOPER_STATE_INVALID</span>     <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">BINDER_LOOPER_STATE_WAITING</span>     <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">BINDER_LOOPER_STATE_NEED_RETURN</span> <span class="o">=</span> <span class="mh">0x20</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">binder_thread</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rb_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">looper</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">transaction_stack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">todo</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">return_error</span><span class="p">;</span> <span class="cm">/* Write failed, return error code in read buf */</span>
	<span class="kt">uint32_t</span> <span class="n">return_error2</span><span class="p">;</span> <span class="cm">/* Write failed, return error code in read */</span>
		<span class="cm">/* buffer. Used when sending a reply to a dead process that */</span>
		<span class="cm">/* we are also waiting on */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_stats</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">debug_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_work</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">from_parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">to_proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="n">to_thread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">to_parent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">need_reply</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* unsigned is_dead:1; */</span>	<span class="cm">/* not used at the moment */</span>

	<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">code</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">long</span>	<span class="n">priority</span><span class="p">;</span>
	<span class="kt">long</span>	<span class="n">saved_priority</span><span class="p">;</span>
	<span class="n">uid_t</span>	<span class="n">sender_euid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">binder_defer_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">binder_deferred_state</span> <span class="n">defer</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * copied from get_unused_fd_flags</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">task_get_unused_fd_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdtable</span> <span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rlim_cur</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">files</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMFILE</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>

<span class="nl">repeat:</span>
	<span class="n">fdt</span> <span class="o">=</span> <span class="n">files_fdtable</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
	<span class="n">fd</span> <span class="o">=</span> <span class="n">find_next_zero_bit</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">open_fds</span><span class="p">,</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">max_fds</span><span class="p">,</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">next_fd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * N.B. For clone tasks sharing a files structure, this test</span>
<span class="cm">	 * will limit the total number of files that can be opened.</span>
<span class="cm">	 */</span>
	<span class="n">rlim_cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock_task_sighand</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irqs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">rlim</span><span class="p">[</span><span class="n">RLIMIT_NOFILE</span><span class="p">].</span><span class="n">rlim_cur</span><span class="p">;</span>
		<span class="n">unlock_task_sighand</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irqs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="n">rlim_cur</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Do we need to expand the fd array or fd set?  */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">expand_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we needed to expand the fs array we</span>
<span class="cm">		 * might have blocked - try again.</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMFILE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__set_open_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fdt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_CLOEXEC</span><span class="p">)</span>
		<span class="n">__set_close_on_exec</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fdt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__clear_close_on_exec</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fdt</span><span class="p">);</span>
	<span class="n">files</span><span class="o">-&gt;</span><span class="n">next_fd</span> <span class="o">=</span> <span class="n">fd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if 1</span>
	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;get_unused_fd: slot %d not NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
		<span class="n">fdt</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * copied from fd_install</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">task_fd_install</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdtable</span> <span class="o">*</span><span class="n">fdt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">files</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
	<span class="n">fdt</span> <span class="o">=</span> <span class="n">files_fdtable</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">[</span><span class="n">fd</span><span class="p">],</span> <span class="n">file</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * copied from __put_unused_fd in open.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__put_unused_fd</span><span class="p">(</span><span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fdtable</span> <span class="o">*</span><span class="n">fdt</span> <span class="o">=</span> <span class="n">files_fdtable</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
	<span class="n">__clear_open_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fdt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">next_fd</span><span class="p">)</span>
		<span class="n">files</span><span class="o">-&gt;</span><span class="n">next_fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * copied from sys_close</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">task_close_fd</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdtable</span> <span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">files</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
	<span class="n">fdt</span> <span class="o">=</span> <span class="n">files_fdtable</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">max_fds</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="n">filp</span> <span class="o">=</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">[</span><span class="n">fd</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">__clear_close_on_exec</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fdt</span><span class="p">);</span>
	<span class="n">__put_unused_fd</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">filp_close</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">files</span><span class="p">);</span>

	<span class="cm">/* can&#39;t restart close syscall because file table entry was cleared */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">||</span>
		     <span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTNOINTR</span> <span class="o">||</span>
		     <span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTNOHAND</span> <span class="o">||</span>
		     <span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTART_RESTARTBLOCK</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_set_nice</span><span class="p">(</span><span class="kt">long</span> <span class="n">nice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">min_nice</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">nice</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_user_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">nice</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">min_nice</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">-</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">rlim</span><span class="p">[</span><span class="n">RLIMIT_NICE</span><span class="p">].</span><span class="n">rlim_cur</span><span class="p">;</span>
	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_PRIORITY_CAP</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d: nice value %ld not allowed use &quot;</span>
		     <span class="s">&quot;%ld instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="n">min_nice</span><span class="p">);</span>
	<span class="n">set_user_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">min_nice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_nice</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d RLIMIT_NICE not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">binder_buffer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">list_entry</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_insert_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">new_buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_buffers</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buffer_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">new_buffer_size</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>

	<span class="n">new_buffer_size</span> <span class="o">=</span> <span class="n">binder_buffer_size</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">new_buffer</span><span class="p">);</span>

	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d: add free buffer, size %zd, &quot;</span>
		     <span class="s">&quot;at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">new_buffer_size</span><span class="p">,</span> <span class="n">new_buffer</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>

		<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">binder_buffer_size</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_buffer_size</span> <span class="o">&lt;</span> <span class="n">buffer_size</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_buffers</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_insert_allocated_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">new_buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">allocated_buffers</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_buffer</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_buffer</span> <span class="o">&gt;</span> <span class="n">buffer</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">allocated_buffers</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="nf">binder_buffer_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
						  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">allocated_buffers</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">kern_ptr</span><span class="p">;</span>

	<span class="n">kern_ptr</span> <span class="o">=</span> <span class="n">user_ptr</span> <span class="o">-</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">user_buffer_offset</span>
		<span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kern_ptr</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kern_ptr</span> <span class="o">&gt;</span> <span class="n">buffer</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_update_page_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">allocate</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">page_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_page_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_struct</span> <span class="n">tmp_area</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>

	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d: %s pages %p-%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
		     <span class="n">allocate</span> <span class="o">?</span> <span class="s">&quot;allocate&quot;</span> <span class="o">:</span> <span class="s">&quot;free&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">start</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="p">)</span>
		<span class="n">mm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mm</span> <span class="o">=</span> <span class="n">get_task_mm</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">vma</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">vma</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="n">mm</span> <span class="o">!=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">vma_vm_mm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;binder: %d: vma mm and task mm mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="n">vma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allocate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_range</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: %d: binder_alloc_buf failed to &quot;</span>
		       <span class="s">&quot;map pages in userspace, no vma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_vma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">page_addr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">page_addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">page_addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">page_array_ptr</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[(</span><span class="n">page_addr</span> <span class="o">-</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">];</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">page</span><span class="p">);</span>
		<span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: %d: binder_alloc_buf failed &quot;</span>
			       <span class="s">&quot;for page at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_alloc_page_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp_area</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">page_addr</span><span class="p">;</span>
		<span class="n">tmp_area</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="cm">/* guard page? */</span><span class="p">;</span>
		<span class="n">page_array_ptr</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">map_vm_area</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_area</span><span class="p">,</span> <span class="n">PAGE_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_array_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: %d: binder_alloc_buf failed &quot;</span>
			       <span class="s">&quot;to map page at %p in kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_map_kernel_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">user_page_addr</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">page_addr</span> <span class="o">+</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">user_buffer_offset</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vm_insert_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">user_page_addr</span><span class="p">,</span> <span class="n">page</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: %d: binder_alloc_buf failed &quot;</span>
			       <span class="s">&quot;to map page at %lx in userspace</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">user_page_addr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_vm_insert_page_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* vm_insert_page does not seem to increment the refcount */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">mmput</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_range:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">page_addr</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">page_addr</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">;</span>
	     <span class="n">page_addr</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[(</span><span class="n">page_addr</span> <span class="o">-</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="p">)</span>
			<span class="n">zap_page_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">page_addr</span> <span class="o">+</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">user_buffer_offset</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">err_vm_insert_page_failed:</span>
		<span class="n">unmap_kernel_range</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page_addr</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="nl">err_map_kernel_failed:</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="o">*</span><span class="n">page</span><span class="p">);</span>
		<span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_alloc_page_failed:</span>
		<span class="p">;</span>
	<span class="p">}</span>
<span class="nl">err_no_vma:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">mmput</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="nf">binder_alloc_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
					      <span class="kt">size_t</span> <span class="n">data_size</span><span class="p">,</span>
					      <span class="kt">size_t</span> <span class="n">offsets_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_async</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_buffers</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buffer_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">best_fit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">has_page_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">end_page_addr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">vma</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: %d: binder_alloc_buf, no vma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">data_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span> <span class="o">+</span>
		<span class="n">ALIGN</span><span class="p">(</span><span class="n">offsets_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">data_size</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">offsets_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d: got transaction with invalid &quot;</span>
			<span class="s">&quot;size %zd-%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">offsets_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_async</span> <span class="o">&amp;&amp;</span>
	    <span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_async_space</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d: binder_alloc_buf size %zd&quot;</span>
			     <span class="s">&quot;failed, no async space left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
		<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">binder_buffer_size</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_fit</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">buffer_size</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">best_fit</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best_fit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: %d: binder_alloc_buf size %zd failed, &quot;</span>
		       <span class="s">&quot;no address space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">best_fit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">binder_buffer_size</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d: binder_alloc_buf size %zd got buff&quot;</span>
		     <span class="s">&quot;er %p size %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">);</span>

	<span class="n">has_page_addr</span> <span class="o">=</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">buffer_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;=</span> <span class="n">buffer_size</span><span class="p">)</span>
			<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* no room for other buffers */</span>
		<span class="k">else</span>
			<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">end_page_addr</span> <span class="o">=</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PAGE_ALIGN</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">buffer_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end_page_addr</span> <span class="o">&gt;</span> <span class="n">has_page_addr</span><span class="p">)</span>
		<span class="n">end_page_addr</span> <span class="o">=</span> <span class="n">has_page_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">binder_update_page_range</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PAGE_ALIGN</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">end_page_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rb_erase</span><span class="p">(</span><span class="n">best_fit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_buffers</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">binder_insert_allocated_buffer</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_size</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">new_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">new_buffer</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">binder_insert_free_buffer</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">new_buffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d: binder_alloc_buf size %zd got &quot;</span>
		     <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">offsets_size</span> <span class="o">=</span> <span class="n">offsets_size</span><span class="p">;</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">async_transaction</span> <span class="o">=</span> <span class="n">is_async</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_async</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_async_space</span> <span class="o">-=</span> <span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">);</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC_ASYNC</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d: binder_alloc_buf size %zd &quot;</span>
			     <span class="s">&quot;async free %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_async_space</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">buffer_start_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buffer</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">buffer_end_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_delete_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_page_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_page_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_end_page</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="o">==</span> <span class="n">buffer_start_page</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_page_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_end_page</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="o">==</span> <span class="n">buffer_end_page</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
			<span class="n">free_page_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d: merge free, buffer %p &quot;</span>
			     <span class="s">&quot;share page with %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_start_page</span><span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="o">==</span> <span class="n">buffer_end_page</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">free_page_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer_start_page</span><span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">buffer_start_page</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
				<span class="n">free_page_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d: merge free, buffer&quot;</span>
				     <span class="s">&quot; %p share page with %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				     <span class="n">buffer</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free_page_start</span> <span class="o">||</span> <span class="n">free_page_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d: merge free, buffer %p do &quot;</span>
			     <span class="s">&quot;not share page%s%s with with %p or %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">free_page_start</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; end&quot;</span><span class="p">,</span>
			     <span class="n">free_page_end</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; start&quot;</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
		<span class="n">binder_update_page_range</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">free_page_start</span> <span class="o">?</span>
			<span class="n">buffer_start_page</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">:</span> <span class="n">buffer_end_page</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span>
			<span class="p">(</span><span class="n">free_page_end</span> <span class="o">?</span> <span class="n">buffer_end_page</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">buffer_start_page</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_free_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">;</span>

	<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">binder_buffer_size</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span> <span class="o">+</span>
		<span class="n">ALIGN</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d: binder_free_buf %p size %zd buffer&quot;</span>
		     <span class="s">&quot;_size %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">buffer_size</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span> <span class="o">&lt;</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span> <span class="o">&gt;</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">async_transaction</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_async_space</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">);</span>

		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC_ASYNC</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d: binder_free_buf size %zd &quot;</span>
			     <span class="s">&quot;async free %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_async_space</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">binder_update_page_range</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PAGE_ALIGN</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">buffer_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">),</span>
		<span class="nb">NULL</span><span class="p">);</span>
	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">allocated_buffers</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_buffers</span><span class="p">);</span>
			<span class="n">binder_delete_free_buffer</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">binder_delete_free_buffer</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_buffers</span><span class="p">);</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">binder_insert_free_buffer</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="nf">binder_get_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
					   <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_node</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">node</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="nf">binder_new_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
					   <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
					   <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_node</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">binder_stats_created</span><span class="p">(</span><span class="n">BINDER_STAT_NODE</span><span class="p">);</span>
	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span> <span class="o">=</span> <span class="o">++</span><span class="n">binder_last_id</span><span class="p">;</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_WORK_NODE</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">async_todo</span><span class="p">);</span>
	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_INTERNAL_REFS</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d:%d node %d u%p c%p created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
		     <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">node</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_inc_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">int</span> <span class="n">strong</span><span class="p">,</span> <span class="kt">int</span> <span class="n">internal</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">target_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strong</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target_list</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">node</span><span class="o">-&gt;</span><span class="n">internal_strong_refs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">binder_context_mgr_node</span> <span class="o">&amp;&amp;</span>
			    <span class="n">node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: invalid inc strong &quot;</span>
					<span class="s">&quot;node for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">internal_strong_refs</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span> <span class="o">&amp;&amp;</span> <span class="n">target_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="n">target_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">has_weak_ref</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: invalid inc weak node &quot;</span>
					<span class="s">&quot;for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="n">target_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_dec_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">int</span> <span class="n">strong</span><span class="p">,</span> <span class="kt">int</span> <span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strong</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="p">)</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">internal_strong_refs</span><span class="o">--</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span> <span class="o">||</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">internal_strong_refs</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span> <span class="o">||</span> <span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span> <span class="o">||</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">has_weak_ref</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span>
				<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_INTERNAL_REFS</span><span class="p">,</span>
					     <span class="s">&quot;binder: refless node %d deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hlist_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">dead_node</span><span class="p">);</span>
				<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_INTERNAL_REFS</span><span class="p">,</span>
					     <span class="s">&quot;binder: dead node %d deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_NODE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="nf">binder_get_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
					 <span class="kt">uint32_t</span> <span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_desc</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref</span><span class="p">,</span> <span class="n">rb_node_desc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&lt;</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&gt;</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">ref</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="nf">binder_get_ref_for_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_node</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">new_ref</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref</span><span class="p">,</span> <span class="n">rb_node_node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">&lt;</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">&gt;</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">ref</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_ref</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ref</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">binder_stats_created</span><span class="p">(</span><span class="n">BINDER_STAT_REF</span><span class="p">);</span>
	<span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">debug_id</span> <span class="o">=</span> <span class="o">++</span><span class="n">binder_last_id</span><span class="p">;</span>
	<span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
	<span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">rb_node_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">rb_node_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_node</span><span class="p">);</span>

	<span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">binder_context_mgr_node</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_desc</span><span class="p">);</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref</span><span class="p">,</span> <span class="n">rb_node_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&gt;</span> <span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_desc</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref</span><span class="p">,</span> <span class="n">rb_node_desc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&lt;</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&gt;</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">rb_node_desc</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">rb_node_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">node_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">);</span>

		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_INTERNAL_REFS</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d new ref %d desc %d for &quot;</span>
			     <span class="s">&quot;node %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
			     <span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_INTERNAL_REFS</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d new ref %d desc %d for &quot;</span>
			     <span class="s">&quot;dead node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
			      <span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">new_ref</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_delete_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_INTERNAL_REFS</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d delete ref %d desc %d for &quot;</span>
		     <span class="s">&quot;node %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
		     <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>

	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">rb_node_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_desc</span><span class="p">);</span>
	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">rb_node_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span><span class="p">)</span>
		<span class="n">binder_dec_node</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hlist_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node_entry</span><span class="p">);</span>
	<span class="n">binder_dec_node</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_DEAD_BINDER</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d delete ref %d desc %d &quot;</span>
			     <span class="s">&quot;has death notification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
			     <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="p">);</span>
		<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_DEATH</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_REF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_inc_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="kt">int</span> <span class="n">strong</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">target_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strong</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">binder_inc_node</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">target_list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">binder_inc_node</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">target_list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_dec_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="kt">int</span> <span class="n">strong</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strong</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d invalid dec strong, &quot;</span>
					  <span class="s">&quot;ref %d desc %d s %d w %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ref</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
					  <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">binder_dec_node</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d invalid dec weak, &quot;</span>
					  <span class="s">&quot;ref %d desc %d s %d w %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ref</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
					  <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">binder_delete_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_pop_transaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="n">target_thread</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span> <span class="o">!=</span> <span class="n">t</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">!=</span> <span class="n">target_thread</span><span class="p">);</span>
		<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span> <span class="o">=</span>
			<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="o">-&gt;</span><span class="n">from_parent</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">need_reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_TRANSACTION</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_send_failed_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
				     <span class="kt">uint32_t</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="n">target_thread</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target_thread</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target_thread</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">!=</span> <span class="n">BR_OK</span> <span class="o">&amp;&amp;</span>
			   <span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">return_error2</span> <span class="o">==</span> <span class="n">BR_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">return_error2</span> <span class="o">=</span>
					<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">return_error</span><span class="p">;</span>
				<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_OK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">==</span> <span class="n">BR_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_FAILED_TRANSACTION</span><span class="p">,</span>
					     <span class="s">&quot;binder: send failed reply for &quot;</span>
					     <span class="s">&quot;transaction %d to %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					      <span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

				<span class="n">binder_pop_transaction</span><span class="p">(</span><span class="n">target_thread</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
				<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">=</span> <span class="n">error_code</span><span class="p">;</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: reply failed, target &quot;</span>
					<span class="s">&quot;thread, %d:%d, has error code %d &quot;</span>
					<span class="s">&quot;already</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">return_error</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from_parent</span><span class="p">;</span>

			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_FAILED_TRANSACTION</span><span class="p">,</span>
				     <span class="s">&quot;binder: send failed reply &quot;</span>
				     <span class="s">&quot;for transaction %d, target dead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>

			<span class="n">binder_pop_transaction</span><span class="p">(</span><span class="n">target_thread</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_DEAD_BINDER</span><span class="p">,</span>
					     <span class="s">&quot;binder: reply failed,&quot;</span>
					     <span class="s">&quot; no target thread at root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_DEAD_BINDER</span><span class="p">,</span>
				     <span class="s">&quot;binder: reply failed, no target &quot;</span>
				     <span class="s">&quot;thread -- retry %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_transaction_buffer_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					      <span class="kt">size_t</span> <span class="o">*</span><span class="n">failed_at</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="o">*</span><span class="n">offp</span><span class="p">,</span> <span class="o">*</span><span class="n">off_end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">debug_id</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">;</span>

	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d buffer release %d, size %zd-%zd, failed at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
		     <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">,</span> <span class="n">failed_at</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="p">)</span>
		<span class="n">binder_dec_node</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">offp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">failed_at</span><span class="p">)</span>
		<span class="n">off_end</span> <span class="o">=</span> <span class="n">failed_at</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">off_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">offp</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">offp</span> <span class="o">&lt;</span> <span class="n">off_end</span><span class="p">;</span> <span class="n">offp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">flat_binder_object</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">offp</span> <span class="o">&gt;</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="o">*</span><span class="n">offp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: transaction release %d bad&quot;</span>
					<span class="s">&quot;offset %zd, size %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">debug_id</span><span class="p">,</span>
					<span class="o">*</span><span class="n">offp</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">flat_binder_object</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="o">*</span><span class="n">offp</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BINDER_TYPE_BINDER</span>:
		<span class="k">case</span> <span class="n">BINDER_TYPE_WEAK_BINDER</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">binder_get_node</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">binder</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: transaction release %d&quot;</span>
				       <span class="s">&quot; bad node %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">debug_id</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">binder</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
				     <span class="s">&quot;        node %d u%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">binder_dec_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_TYPE_BINDER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BINDER_TYPE_HANDLE</span>:
		<span class="k">case</span> <span class="n">BINDER_TYPE_WEAK_HANDLE</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span> <span class="n">binder_get_ref</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: transaction release %d&quot;</span>
				       <span class="s">&quot; bad handle %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">debug_id</span><span class="p">,</span>
				       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
				     <span class="s">&quot;        ref %d desc %d (node %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
			<span class="n">binder_dec_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_TYPE_HANDLE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BINDER_TYPE_FD</span>:
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
				     <span class="s">&quot;        fd %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">failed_at</span><span class="p">)</span>
				<span class="n">task_close_fd</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: transaction release %d bad &quot;</span>
			       <span class="s">&quot;object type %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">debug_id</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_transaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">binder_transaction_data</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_work</span> <span class="o">*</span><span class="n">tcomplete</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="o">*</span><span class="n">offp</span><span class="p">,</span> <span class="o">*</span><span class="n">off_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">target_proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="n">target_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">target_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">target_list</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">target_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">in_reply_to</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_transaction_log_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">return_error</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">binder_transaction_log_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_transaction_log</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">call_type</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="o">!!</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">from_proc</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">from_thread</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">target_handle</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">offsets_size</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_reply_to</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_reply_to</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got reply transaction &quot;</span>
					  <span class="s">&quot;with no transaction stack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_empty_call_stack</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">binder_set_nice</span><span class="p">(</span><span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">saved_priority</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">!=</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got reply transaction &quot;</span>
				<span class="s">&quot;with bad transaction stack,&quot;</span>
				<span class="s">&quot; transaction %d has target %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
				<span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">to_proc</span> <span class="o">?</span>
				<span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">to_proc</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">?</span>
				<span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">to_thread</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
			<span class="n">in_reply_to</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_bad_call_stack</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span> <span class="o">=</span> <span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">to_parent</span><span class="p">;</span>
		<span class="n">target_thread</span> <span class="o">=</span> <span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target_thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_DEAD_REPLY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_dead_binder</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span> <span class="o">!=</span> <span class="n">in_reply_to</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got reply transaction &quot;</span>
				<span class="s">&quot;with bad target transaction stack %d, &quot;</span>
				<span class="s">&quot;expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span> <span class="o">?</span>
				<span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="o">-&gt;</span><span class="n">debug_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
			<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
			<span class="n">in_reply_to</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">target_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_dead_binder</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">target_proc</span> <span class="o">=</span> <span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="n">binder_get_ref</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got &quot;</span>
					<span class="s">&quot;transaction to invalid handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
				<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_invalid_target_handle</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target_node</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">target_node</span> <span class="o">=</span> <span class="n">binder_context_mgr_node</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_DEAD_REPLY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_no_context_mgr_node</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">to_node</span> <span class="o">=</span> <span class="n">target_node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">;</span>
		<span class="n">target_proc</span> <span class="o">=</span> <span class="n">target_node</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target_proc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_DEAD_REPLY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_dead_binder</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">!=</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got new &quot;</span>
					<span class="s">&quot;transaction with bad transaction stack&quot;</span>
					<span class="s">&quot;, transaction %d has target %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
					<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">to_proc</span> <span class="o">?</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">to_proc</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">?</span>
					<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">to_thread</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_bad_call_stack</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">==</span> <span class="n">target_proc</span><span class="p">)</span>
					<span class="n">target_thread</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">from_parent</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">=</span> <span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
		<span class="n">target_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">;</span>
		<span class="n">target_wait</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">target_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target_proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">;</span>
		<span class="n">target_wait</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target_proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">to_proc</span> <span class="o">=</span> <span class="n">target_proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>

	<span class="cm">/* TODO: reuse incoming transaction for reply */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc_t_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">binder_stats_created</span><span class="p">(</span><span class="n">BINDER_STAT_TRANSACTION</span><span class="p">);</span>

	<span class="n">tcomplete</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcomplete</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcomplete</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc_tcomplete_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">binder_stats_created</span><span class="p">(</span><span class="n">BINDER_STAT_TRANSACTION_COMPLETE</span><span class="p">);</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span> <span class="o">=</span> <span class="o">++</span><span class="n">binder_last_id</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">debug_id</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d:%d BC_REPLY %d -&gt; %d:%d, &quot;</span>
			     <span class="s">&quot;data %p-%p size %zd-%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
			     <span class="n">target_proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">target_thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
			     <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">offsets</span><span class="p">,</span>
			     <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d:%d BC_TRANSACTION %d -&gt; &quot;</span>
			     <span class="s">&quot;%d - node %d, data %p-%p size %zd-%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
			     <span class="n">target_proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">target_node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
			     <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">offsets</span><span class="p">,</span>
			     <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">))</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">sender_euid</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">to_proc</span> <span class="o">=</span> <span class="n">target_proc</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">=</span> <span class="n">target_thread</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">task_nice</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">binder_alloc_buf</span><span class="p">(</span><span class="n">target_proc</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span>
		<span class="n">tr</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">,</span> <span class="o">!</span><span class="n">reply</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_binder_alloc_buf_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">allow_user_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">debug_id</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span> <span class="o">=</span> <span class="n">target_node</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_node</span><span class="p">)</span>
		<span class="n">binder_inc_node</span><span class="p">(</span><span class="n">target_node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">offp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got transaction with invalid &quot;</span>
			<span class="s">&quot;data ptr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_copy_data_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">offp</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">offsets</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got transaction with invalid &quot;</span>
			<span class="s">&quot;offsets ptr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_copy_data_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got transaction with &quot;</span>
			<span class="s">&quot;invalid offsets size, %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">);</span>
		<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_bad_offset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">off_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">offp</span> <span class="o">+</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">offp</span> <span class="o">&lt;</span> <span class="n">off_end</span><span class="p">;</span> <span class="n">offp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">flat_binder_object</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">offp</span> <span class="o">&gt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="o">*</span><span class="n">offp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got transaction with &quot;</span>
				<span class="s">&quot;invalid offset, %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="o">*</span><span class="n">offp</span><span class="p">);</span>
			<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_bad_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">flat_binder_object</span> <span class="o">*</span><span class="p">)(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="o">*</span><span class="n">offp</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BINDER_TYPE_BINDER</span>:
		<span class="k">case</span> <span class="n">BINDER_TYPE_WEAK_BINDER</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">binder_get_node</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">binder</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">node</span> <span class="o">=</span> <span class="n">binder_new_node</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">binder</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">err_binder_new_node_failed</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">min_priority</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAT_BINDER_FLAG_PRIORITY_MASK</span><span class="p">;</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">accept_fds</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAT_BINDER_FLAG_ACCEPTS_FDS</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">!=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d sending u%p &quot;</span>
					<span class="s">&quot;node %d, cookie mismatch %p != %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					<span class="n">fp</span><span class="o">-&gt;</span><span class="n">binder</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
					<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_binder_get_ref_for_node_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="n">binder_get_ref_for_node</span><span class="p">(</span><span class="n">target_proc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_binder_get_ref_for_node_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_TYPE_BINDER</span><span class="p">)</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_TYPE_HANDLE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_TYPE_WEAK_HANDLE</span><span class="p">;</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">binder_inc_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_TYPE_HANDLE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>

			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
				     <span class="s">&quot;        node %d u%p -&gt; ref %d desc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
				     <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BINDER_TYPE_HANDLE</span>:
		<span class="k">case</span> <span class="n">BINDER_TYPE_WEAK_HANDLE</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span> <span class="n">binder_get_ref</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got &quot;</span>
					<span class="s">&quot;transaction with invalid &quot;</span>
					<span class="s">&quot;handle, %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
				<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_binder_get_ref_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">==</span> <span class="n">target_proc</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_TYPE_HANDLE</span><span class="p">)</span>
					<span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_TYPE_BINDER</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_TYPE_WEAK_BINDER</span><span class="p">;</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">binder</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
				<span class="n">binder_inc_node</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_TYPE_BINDER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
					     <span class="s">&quot;        ref %d desc %d -&gt; node %d u%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
					     <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">new_ref</span><span class="p">;</span>
				<span class="n">new_ref</span> <span class="o">=</span> <span class="n">binder_get_ref_for_node</span><span class="p">(</span><span class="n">target_proc</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">err_binder_get_ref_for_node_failed</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
				<span class="n">binder_inc_ref</span><span class="p">(</span><span class="n">new_ref</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_TYPE_HANDLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
					     <span class="s">&quot;        ref %d desc %d -&gt; ref %d desc %d (node %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
					     <span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BINDER_TYPE_FD</span>: <span class="p">{</span>
			<span class="kt">int</span> <span class="n">target_fd</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">in_reply_to</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ACCEPT_FDS</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got reply with fd, %ld, but target does not allow fds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
					<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">err_fd_not_allowed</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_node</span><span class="o">-&gt;</span><span class="n">accept_fds</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got transaction with fd, %ld, but target does not allow fds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
				<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_fd_not_allowed</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">file</span> <span class="o">=</span> <span class="n">fget</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got transaction with invalid fd, %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
				<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_fget_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target_fd</span> <span class="o">=</span> <span class="n">task_get_unused_fd_flags</span><span class="p">(</span><span class="n">target_proc</span><span class="p">,</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
				<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_get_unused_fd_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">task_fd_install</span><span class="p">(</span><span class="n">target_proc</span><span class="p">,</span> <span class="n">target_fd</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
				     <span class="s">&quot;        fd %ld -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">target_fd</span><span class="p">);</span>
			<span class="cm">/* TODO: fput? */</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">target_fd</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d got transactio&quot;</span>
				<span class="s">&quot;n with invalid object type, %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_FAILED_REPLY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_bad_object_type</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">async_transaction</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">binder_pop_transaction</span><span class="p">(</span><span class="n">target_thread</span><span class="p">,</span> <span class="n">in_reply_to</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">async_transaction</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">need_reply</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">from_parent</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="p">;</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">target_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">async_transaction</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target_node</span><span class="o">-&gt;</span><span class="n">has_async_transaction</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">target_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target_node</span><span class="o">-&gt;</span><span class="n">async_todo</span><span class="p">;</span>
			<span class="n">target_wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">target_node</span><span class="o">-&gt;</span><span class="n">has_async_transaction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_WORK_TRANSACTION</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="n">target_list</span><span class="p">);</span>
	<span class="n">tcomplete</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_WORK_TRANSACTION_COMPLETE</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcomplete</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_wait</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="n">target_wait</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_get_unused_fd_failed:</span>
<span class="nl">err_fget_failed:</span>
<span class="nl">err_fd_not_allowed:</span>
<span class="nl">err_binder_get_ref_for_node_failed:</span>
<span class="nl">err_binder_get_ref_failed:</span>
<span class="nl">err_binder_new_node_failed:</span>
<span class="nl">err_bad_object_type:</span>
<span class="nl">err_bad_offset:</span>
<span class="nl">err_copy_data_failed:</span>
	<span class="n">binder_transaction_buffer_release</span><span class="p">(</span><span class="n">target_proc</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">offp</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">binder_free_buf</span><span class="p">(</span><span class="n">target_proc</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<span class="nl">err_binder_alloc_buf_failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tcomplete</span><span class="p">);</span>
	<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_TRANSACTION_COMPLETE</span><span class="p">);</span>
<span class="nl">err_alloc_tcomplete_failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_TRANSACTION</span><span class="p">);</span>
<span class="nl">err_alloc_t_failed:</span>
<span class="nl">err_bad_call_stack:</span>
<span class="nl">err_empty_call_stack:</span>
<span class="nl">err_dead_binder:</span>
<span class="nl">err_invalid_target_handle:</span>
<span class="nl">err_no_context_mgr_node:</span>
	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_FAILED_TRANSACTION</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d:%d transaction failed %d, size %zd-%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">return_error</span><span class="p">,</span>
		     <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_transaction_log_entry</span> <span class="o">*</span><span class="n">fe</span><span class="p">;</span>
		<span class="n">fe</span> <span class="o">=</span> <span class="n">binder_transaction_log_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_transaction_log_failed</span><span class="p">);</span>
		<span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">!=</span> <span class="n">BR_OK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_reply_to</span><span class="p">)</span> <span class="p">{</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_TRANSACTION_COMPLETE</span><span class="p">;</span>
		<span class="n">binder_send_failed_reply</span><span class="p">(</span><span class="n">in_reply_to</span><span class="p">,</span> <span class="n">return_error</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">=</span> <span class="n">return_error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">binder_thread_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
			<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">signed</span> <span class="kt">long</span> <span class="o">*</span><span class="n">consumed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="o">*</span><span class="n">consumed</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">==</span> <span class="n">BR_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">binder_stats</span><span class="p">.</span><span class="n">bc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">binder_stats</span><span class="p">.</span><span class="n">bc</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">proc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bc</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span>
			<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bc</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BC_INCREFS</span>:
		<span class="k">case</span> <span class="n">BC_ACQUIRE</span>:
		<span class="k">case</span> <span class="n">BC_RELEASE</span>:
		<span class="k">case</span> <span class="n">BC_DECREFS</span>: <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">target</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">debug_string</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">binder_context_mgr_node</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_INCREFS</span> <span class="o">||</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_ACQUIRE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ref</span> <span class="o">=</span> <span class="n">binder_get_ref_for_node</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span>
					       <span class="n">binder_context_mgr_node</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">!=</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:&quot;</span>
						<span class="s">&quot;%d tried to acquire &quot;</span>
						<span class="s">&quot;reference to desc 0, &quot;</span>
						<span class="s">&quot;got %d instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
						<span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ref</span> <span class="o">=</span> <span class="n">binder_get_ref</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d refcou&quot;</span>
					<span class="s">&quot;nt change on invalid ref %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">BC_INCREFS</span>:
				<span class="n">debug_string</span> <span class="o">=</span> <span class="s">&quot;IncRefs&quot;</span><span class="p">;</span>
				<span class="n">binder_inc_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BC_ACQUIRE</span>:
				<span class="n">debug_string</span> <span class="o">=</span> <span class="s">&quot;Acquire&quot;</span><span class="p">;</span>
				<span class="n">binder_inc_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BC_RELEASE</span>:
				<span class="n">debug_string</span> <span class="o">=</span> <span class="s">&quot;Release&quot;</span><span class="p">;</span>
				<span class="n">binder_dec_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BC_DECREFS</span>:
			<span class="nl">default:</span>
				<span class="n">debug_string</span> <span class="o">=</span> <span class="s">&quot;DecRefs&quot;</span><span class="p">;</span>
				<span class="n">binder_dec_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_USER_REFS</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d %s ref %d desc %d s %d w %d for node %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">debug_string</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
				     <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">BC_INCREFS_DONE</span>:
		<span class="k">case</span> <span class="n">BC_ACQUIRE_DONE</span>: <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">node_ptr</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">node_ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">binder_get_node</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">node_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d &quot;</span>
					<span class="s">&quot;%s u%p no match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					<span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_INCREFS_DONE</span> <span class="o">?</span>
					<span class="s">&quot;BC_INCREFS_DONE&quot;</span> <span class="o">:</span>
					<span class="s">&quot;BC_ACQUIRE_DONE&quot;</span><span class="p">,</span>
					<span class="n">node_ptr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">!=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d %s u%p node %d&quot;</span>
					<span class="s">&quot; cookie mismatch %p != %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					<span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_INCREFS_DONE</span> <span class="o">?</span>
					<span class="s">&quot;BC_INCREFS_DONE&quot;</span> <span class="o">:</span> <span class="s">&quot;BC_ACQUIRE_DONE&quot;</span><span class="p">,</span>
					<span class="n">node_ptr</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
					<span class="n">cookie</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_ACQUIRE_DONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">pending_strong_ref</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d &quot;</span>
						<span class="s">&quot;BC_ACQUIRE_DONE node %d has &quot;</span>
						<span class="s">&quot;no pending acquire request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
						<span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">pending_strong_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">pending_weak_ref</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d &quot;</span>
						<span class="s">&quot;BC_INCREFS_DONE node %d has &quot;</span>
						<span class="s">&quot;no pending increfs request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
						<span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">pending_weak_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">binder_dec_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_ACQUIRE_DONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_USER_REFS</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d %s node %d ls %d lw %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				     <span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_INCREFS_DONE</span> <span class="o">?</span> <span class="s">&quot;BC_INCREFS_DONE&quot;</span> <span class="o">:</span> <span class="s">&quot;BC_ACQUIRE_DONE&quot;</span><span class="p">,</span>
				     <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">BC_ATTEMPT_ACQUIRE</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: BC_ATTEMPT_ACQUIRE not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BC_ACQUIRE_RESULT</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: BC_ACQUIRE_RESULT not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BC_FREE_BUFFER</span>: <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data_ptr</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data_ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

			<span class="n">buffer</span> <span class="o">=</span> <span class="n">binder_buffer_lookup</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d &quot;</span>
					<span class="s">&quot;BC_FREE_BUFFER u%p no match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">allow_user_free</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d &quot;</span>
					<span class="s">&quot;BC_FREE_BUFFER u%p matched &quot;</span>
					<span class="s">&quot;unreturned buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_FREE_BUFFER</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d BC_FREE_BUFFER u%p found buffer %d for %s transaction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
				     <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">?</span> <span class="s">&quot;active&quot;</span> <span class="o">:</span> <span class="s">&quot;finished&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">async_transaction</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="o">-&gt;</span><span class="n">has_async_transaction</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="o">-&gt;</span><span class="n">async_todo</span><span class="p">))</span>
					<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="o">-&gt;</span><span class="n">has_async_transaction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">list_move_tail</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="o">-&gt;</span><span class="n">async_todo</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">binder_transaction_buffer_release</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">binder_free_buf</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">BC_TRANSACTION</span>:
		<span class="k">case</span> <span class="n">BC_REPLY</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_transaction_data</span> <span class="n">tr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span>
			<span class="n">binder_transaction</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_REPLY</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">BC_REGISTER_LOOPER</span>:
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_THREADS</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d BC_REGISTER_LOOPER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="n">BINDER_LOOPER_STATE_ENTERED</span><span class="p">)</span> <span class="p">{</span>
				<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">|=</span> <span class="n">BINDER_LOOPER_STATE_INVALID</span><span class="p">;</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d ERROR:&quot;</span>
					<span class="s">&quot; BC_REGISTER_LOOPER called &quot;</span>
					<span class="s">&quot;after BC_ENTER_LOOPER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">requested_threads</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">|=</span> <span class="n">BINDER_LOOPER_STATE_INVALID</span><span class="p">;</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d ERROR:&quot;</span>
					<span class="s">&quot; BC_REGISTER_LOOPER called &quot;</span>
					<span class="s">&quot;without request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">requested_threads</span><span class="o">--</span><span class="p">;</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">requested_threads_started</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">|=</span> <span class="n">BINDER_LOOPER_STATE_REGISTERED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BC_ENTER_LOOPER</span>:
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_THREADS</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d BC_ENTER_LOOPER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="n">BINDER_LOOPER_STATE_REGISTERED</span><span class="p">)</span> <span class="p">{</span>
				<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">|=</span> <span class="n">BINDER_LOOPER_STATE_INVALID</span><span class="p">;</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d ERROR:&quot;</span>
					<span class="s">&quot; BC_ENTER_LOOPER called after &quot;</span>
					<span class="s">&quot;BC_REGISTER_LOOPER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">|=</span> <span class="n">BINDER_LOOPER_STATE_ENTERED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BC_EXIT_LOOPER</span>:
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_THREADS</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d BC_EXIT_LOOPER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">|=</span> <span class="n">BINDER_LOOPER_STATE_EXITED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BC_REQUEST_DEATH_NOTIFICATION</span>:
		<span class="k">case</span> <span class="n">BC_CLEAR_DEATH_NOTIFICATION</span>: <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">target</span><span class="p">;</span>
			<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cookie</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">binder_ref_death</span> <span class="o">*</span><span class="n">death</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="n">binder_get_ref</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d %s &quot;</span>
					<span class="s">&quot;invalid ref %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					<span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_REQUEST_DEATH_NOTIFICATION</span> <span class="o">?</span>
					<span class="s">&quot;BC_REQUEST_DEATH_NOTIFICATION&quot;</span> <span class="o">:</span>
					<span class="s">&quot;BC_CLEAR_DEATH_NOTIFICATION&quot;</span><span class="p">,</span>
					<span class="n">target</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_DEATH_NOTIFICATION</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d %s %p ref %d desc %d s %d w %d for node %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				     <span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_REQUEST_DEATH_NOTIFICATION</span> <span class="o">?</span>
				     <span class="s">&quot;BC_REQUEST_DEATH_NOTIFICATION&quot;</span> <span class="o">:</span>
				     <span class="s">&quot;BC_CLEAR_DEATH_NOTIFICATION&quot;</span><span class="p">,</span>
				     <span class="n">cookie</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span>
				     <span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BC_REQUEST_DEATH_NOTIFICATION</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%&quot;</span>
						<span class="s">&quot;d BC_REQUEST_DEATH_NOTI&quot;</span>
						<span class="s">&quot;FICATION death notific&quot;</span>
						<span class="s">&quot;ation already set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">death</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">death</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">death</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_ERROR</span><span class="p">;</span>
					<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_FAILED_TRANSACTION</span><span class="p">,</span>
						     <span class="s">&quot;binder: %d:%d &quot;</span>
						     <span class="s">&quot;BC_REQUEST_DEATH_NOTIFICATION failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">binder_stats_created</span><span class="p">(</span><span class="n">BINDER_STAT_DEATH</span><span class="p">);</span>
				<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
				<span class="n">death</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span> <span class="o">=</span> <span class="n">death</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_WORK_DEAD_BINDER</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BINDER_LOOPER_STATE_REGISTERED</span> <span class="o">|</span> <span class="n">BINDER_LOOPER_STATE_ENTERED</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
						<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%&quot;</span>
						<span class="s">&quot;d BC_CLEAR_DEATH_NOTIFI&quot;</span>
						<span class="s">&quot;CATION death notificat&quot;</span>
						<span class="s">&quot;ion not active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">death</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">!=</span> <span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%&quot;</span>
						<span class="s">&quot;d BC_CLEAR_DEATH_NOTIFI&quot;</span>
						<span class="s">&quot;CATION death notificat&quot;</span>
						<span class="s">&quot;ion cookie mismatch &quot;</span>
						<span class="s">&quot;%p != %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
						<span class="n">death</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_WORK_CLEAR_DEATH_NOTIFICATION</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BINDER_LOOPER_STATE_REGISTERED</span> <span class="o">|</span> <span class="n">BINDER_LOOPER_STATE_ENTERED</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
						<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">BUG_ON</span><span class="p">(</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">BINDER_WORK_DEAD_BINDER</span><span class="p">);</span>
					<span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_WORK_DEAD_BINDER_AND_CLEAR</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BC_DEAD_BINDER_DONE</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_work</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
			<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cookie</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">binder_ref_death</span> <span class="o">*</span><span class="n">death</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">delivered_death</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">binder_ref_death</span> <span class="o">*</span><span class="n">tmp_death</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref_death</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp_death</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">==</span> <span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">death</span> <span class="o">=</span> <span class="n">tmp_death</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_DEAD_BINDER</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d BC_DEAD_BINDER_DONE %p found %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">death</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">death</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d BC_DEAD&quot;</span>
					<span class="s">&quot;_BINDER_DONE %p not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_WORK_DEAD_BINDER_AND_CLEAR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_WORK_CLEAR_DEATH_NOTIFICATION</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BINDER_LOOPER_STATE_REGISTERED</span> <span class="o">|</span> <span class="n">BINDER_LOOPER_STATE_ENTERED</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
					<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: %d:%d unknown command %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">consumed</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">binder_stat_br</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
		    <span class="kt">uint32_t</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">binder_stats</span><span class="p">.</span><span class="n">br</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">binder_stats</span><span class="p">.</span><span class="n">br</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">proc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">br</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">br</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_has_proc_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="n">BINDER_LOOPER_STATE_NEED_RETURN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_has_thread_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">)</span> <span class="o">||</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">!=</span> <span class="n">BR_OK</span> <span class="o">||</span>
		<span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="n">BINDER_LOOPER_STATE_NEED_RETURN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_thread_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
			      <span class="kt">void</span>  <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
			      <span class="kt">signed</span> <span class="kt">long</span> <span class="o">*</span><span class="n">consumed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">non_block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="o">*</span><span class="n">consumed</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_for_proc_work</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">consumed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">BR_NOOP</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">retry:</span>
	<span class="n">wait_for_proc_work</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
				<span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">!=</span> <span class="n">BR_OK</span> <span class="o">&amp;&amp;</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error2</span> <span class="o">!=</span> <span class="n">BR_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error2</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error2</span> <span class="o">=</span> <span class="n">BR_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">|=</span> <span class="n">BINDER_LOOPER_STATE_WAITING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_proc_work</span><span class="p">)</span>
		<span class="n">proc</span><span class="o">-&gt;</span><span class="n">ready_threads</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_proc_work</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BINDER_LOOPER_STATE_REGISTERED</span> <span class="o">|</span>
					<span class="n">BINDER_LOOPER_STATE_ENTERED</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">binder_user_error</span><span class="p">(</span><span class="s">&quot;binder: %d:%d ERROR: Thread waiting &quot;</span>
				<span class="s">&quot;for process work before calling BC_REGISTER_&quot;</span>
				<span class="s">&quot;LOOPER or BC_ENTER_LOOPER (state %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span><span class="p">);</span>
			<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">binder_user_error_wait</span><span class="p">,</span>
						 <span class="n">binder_stop_on_user_error</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">binder_set_nice</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">default_priority</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">non_block</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">binder_has_proc_work</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_exclusive</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">binder_has_proc_work</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">non_block</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">binder_has_thread_work</span><span class="p">(</span><span class="kr">thread</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">binder_has_thread_work</span><span class="p">(</span><span class="kr">thread</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_proc_work</span><span class="p">)</span>
		<span class="n">proc</span><span class="o">-&gt;</span><span class="n">ready_threads</span><span class="o">--</span><span class="p">;</span>
	<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BINDER_LOOPER_STATE_WAITING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">binder_transaction_data</span> <span class="n">tr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">binder_work</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">))</span>
			<span class="n">w</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_work</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">wait_for_proc_work</span><span class="p">)</span>
			<span class="n">w</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_work</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">-</span> <span class="n">buffer</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="n">BINDER_LOOPER_STATE_NEED_RETURN</span><span class="p">))</span> <span class="cm">/* no data added */</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BINDER_WORK_TRANSACTION</span>: <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_transaction</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BINDER_WORK_TRANSACTION_COMPLETE</span>: <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_TRANSACTION_COMPLETE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>

			<span class="n">binder_stat_br</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION_COMPLETE</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d BR_TRANSACTION_COMPLETE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_TRANSACTION_COMPLETE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BINDER_WORK_NODE</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_node</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
			<span class="kt">uint32_t</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_NOOP</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd_name</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">strong</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">internal_strong_refs</span> <span class="o">||</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">weak</span> <span class="o">=</span> <span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">)</span> <span class="o">||</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span> <span class="o">||</span> <span class="n">strong</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">weak</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">has_weak_ref</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_INCREFS</span><span class="p">;</span>
				<span class="n">cmd_name</span> <span class="o">=</span> <span class="s">&quot;BR_INCREFS&quot;</span><span class="p">;</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">has_weak_ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">pending_weak_ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strong</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_ACQUIRE</span><span class="p">;</span>
				<span class="n">cmd_name</span> <span class="o">=</span> <span class="s">&quot;BR_ACQUIRE&quot;</span><span class="p">;</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">pending_strong_ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strong</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_RELEASE</span><span class="p">;</span>
				<span class="n">cmd_name</span> <span class="o">=</span> <span class="s">&quot;BR_RELEASE&quot;</span><span class="p">;</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">weak</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">has_weak_ref</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_DECREFS</span><span class="p">;</span>
				<span class="n">cmd_name</span> <span class="o">=</span> <span class="s">&quot;BR_DECREFS&quot;</span><span class="p">;</span>
				<span class="n">node</span><span class="o">-&gt;</span><span class="n">has_weak_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">BR_NOOP</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

				<span class="n">binder_stat_br</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
				<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_USER_REFS</span><span class="p">,</span>
					     <span class="s">&quot;binder: %d:%d %s %d u%p c%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd_name</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">weak</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strong</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_INTERNAL_REFS</span><span class="p">,</span>
						     <span class="s">&quot;binder: %d:%d node %d u%p c%p deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
						     <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
					<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
					<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_NODE</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_INTERNAL_REFS</span><span class="p">,</span>
						     <span class="s">&quot;binder: %d:%d node %d u%p c%p state unchanged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span>
						     <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BINDER_WORK_DEAD_BINDER</span>:
		<span class="k">case</span> <span class="n">BINDER_WORK_DEAD_BINDER_AND_CLEAR</span>:
		<span class="k">case</span> <span class="n">BINDER_WORK_CLEAR_DEATH_NOTIFICATION</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_ref_death</span> <span class="o">*</span><span class="n">death</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">cmd</span><span class="p">;</span>

			<span class="n">death</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref_death</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_WORK_CLEAR_DEATH_NOTIFICATION</span><span class="p">)</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_CLEAR_DEATH_NOTIFICATION_DONE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_DEAD_BINDER</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_DEATH_NOTIFICATION</span><span class="p">,</span>
				     <span class="s">&quot;binder: %d:%d %s %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				      <span class="n">cmd</span> <span class="o">==</span> <span class="n">BR_DEAD_BINDER</span> <span class="o">?</span>
				      <span class="s">&quot;BR_DEAD_BINDER&quot;</span> <span class="o">:</span>
				      <span class="s">&quot;BR_CLEAR_DEATH_NOTIFICATION_DONE&quot;</span><span class="p">,</span>
				      <span class="n">death</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BINDER_WORK_CLEAR_DEATH_NOTIFICATION</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">death</span><span class="p">);</span>
				<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_DEATH</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">delivered_death</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BR_DEAD_BINDER</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span> <span class="cm">/* DEAD_BINDER notifications can cause transactions */</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">target_node</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="p">;</span>
			<span class="n">tr</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target_node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="n">tr</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span>  <span class="n">target_node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">saved_priority</span> <span class="o">=</span> <span class="n">task_nice</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">target_node</span><span class="o">-&gt;</span><span class="n">min_priority</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">))</span>
				<span class="n">binder_set_nice</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">)</span> <span class="o">||</span>
				 <span class="n">t</span><span class="o">-&gt;</span><span class="n">saved_priority</span> <span class="o">&gt;</span> <span class="n">target_node</span><span class="o">-&gt;</span><span class="n">min_priority</span><span class="p">)</span>
				<span class="n">binder_set_nice</span><span class="p">(</span><span class="n">target_node</span><span class="o">-&gt;</span><span class="n">min_priority</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_TRANSACTION</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tr</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">tr</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">BR_REPLY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tr</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
		<span class="n">tr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">tr</span><span class="p">.</span><span class="n">sender_euid</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">sender_euid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">sender</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">;</span>
			<span class="n">tr</span><span class="p">.</span><span class="n">sender_pid</span> <span class="o">=</span> <span class="n">task_tgid_nr_ns</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span>
							<span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">pid_ns</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tr</span><span class="p">.</span><span class="n">sender_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tr</span><span class="p">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">;</span>
		<span class="n">tr</span><span class="p">.</span><span class="n">offsets_size</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">;</span>
		<span class="n">tr</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">user_buffer_offset</span><span class="p">;</span>
		<span class="n">tr</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">offsets</span> <span class="o">=</span> <span class="n">tr</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">buffer</span> <span class="o">+</span>
					<span class="n">ALIGN</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span>

		<span class="n">binder_stat_br</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_TRANSACTION</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d:%d %s %d %d:%d, cmd %d&quot;</span>
			     <span class="s">&quot;size %zd-%zd ptr %p-%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BR_TRANSACTION</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;BR_TRANSACTION&quot;</span> <span class="o">:</span>
			     <span class="s">&quot;BR_REPLY&quot;</span><span class="p">,</span>
			     <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">?</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">?</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">,</span>
			     <span class="n">tr</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">tr</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">offsets</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">allow_user_free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BR_TRANSACTION</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">to_parent</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">;</span>
			<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_TRANSACTION</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>

	<span class="o">*</span><span class="n">consumed</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">requested_threads</span> <span class="o">+</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">ready_threads</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">proc</span><span class="o">-&gt;</span><span class="n">requested_threads_started</span> <span class="o">&lt;</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">max_threads</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BINDER_LOOPER_STATE_REGISTERED</span> <span class="o">|</span>
	     <span class="n">BINDER_LOOPER_STATE_ENTERED</span><span class="p">))</span> <span class="cm">/* the user-space code fails to */</span>
	     <span class="cm">/*spawn a new thread if we leave this out */</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proc</span><span class="o">-&gt;</span><span class="n">requested_threads</span><span class="o">++</span><span class="p">;</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_THREADS</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d:%d BR_SPAWN_LOOPER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">BR_SPAWN_LOOPER</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_release_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_work</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_work</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BINDER_WORK_TRANSACTION</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

			<span class="n">t</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_transaction</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_ONE_WAY</span><span class="p">))</span>
				<span class="n">binder_send_failed_reply</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">BR_DEAD_REPLY</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BINDER_WORK_TRANSACTION_COMPLETE</span>: <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_TRANSACTION_COMPLETE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="nf">binder_get_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="kr">thread</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_thread</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kr">thread</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="kr">thread</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">binder_stats_created</span><span class="p">(</span><span class="n">BINDER_STAT_THREAD</span><span class="p">);</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
		<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">);</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">|=</span> <span class="n">BINDER_LOOPER_STATE_NEED_RETURN</span><span class="p">;</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">=</span> <span class="n">BR_OK</span><span class="p">;</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error2</span> <span class="o">=</span> <span class="n">BR_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kr">thread</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_free_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">send_reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">active_transactions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">==</span> <span class="kr">thread</span><span class="p">)</span>
		<span class="n">send_reply</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">active_transactions</span><span class="o">++</span><span class="p">;</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_DEAD_TRANSACTION</span><span class="p">,</span>
			     <span class="s">&quot;binder: release %d:%d transaction %d &quot;</span>
			     <span class="s">&quot;%s, still active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
			     <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">==</span> <span class="kr">thread</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">==</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">to_proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">to_parent</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">==</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from_parent</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">send_reply</span><span class="p">)</span>
		<span class="n">binder_send_failed_reply</span><span class="p">(</span><span class="n">send_reply</span><span class="p">,</span> <span class="n">BR_DEAD_REPLY</span><span class="p">);</span>
	<span class="n">binder_release_work</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_THREAD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">active_transactions</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">binder_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_for_proc_work</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="kr">thread</span> <span class="o">=</span> <span class="n">binder_get_thread</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>

	<span class="n">wait_for_proc_work</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		<span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">return_error</span> <span class="o">==</span> <span class="n">BR_OK</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_proc_work</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">binder_has_proc_work</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">POLLIN</span><span class="p">;</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">binder_has_proc_work</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">POLLIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">binder_has_thread_work</span><span class="p">(</span><span class="kr">thread</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">POLLIN</span><span class="p">;</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">binder_has_thread_work</span><span class="p">(</span><span class="kr">thread</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">POLLIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">binder_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="cm">/*printk(KERN_INFO &quot;binder_ioctl: %d:%d %x %lx\n&quot;, proc-&gt;pid, current-&gt;pid, cmd, arg);*/</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">binder_user_error_wait</span><span class="p">,</span> <span class="n">binder_stop_on_user_error</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="kr">thread</span> <span class="o">=</span> <span class="n">binder_get_thread</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BINDER_WRITE_READ</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_write_read</span> <span class="n">bwr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_write_read</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bwr</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bwr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_READ_WRITE</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d:%d write %ld at %08lx, read %ld at %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">bwr</span><span class="p">.</span><span class="n">write_size</span><span class="p">,</span> <span class="n">bwr</span><span class="p">.</span><span class="n">write_buffer</span><span class="p">,</span>
			     <span class="n">bwr</span><span class="p">.</span><span class="n">read_size</span><span class="p">,</span> <span class="n">bwr</span><span class="p">.</span><span class="n">read_buffer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bwr</span><span class="p">.</span><span class="n">write_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">binder_thread_write</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">write_buffer</span><span class="p">,</span> <span class="n">bwr</span><span class="p">.</span><span class="n">write_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bwr</span><span class="p">.</span><span class="n">write_consumed</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bwr</span><span class="p">.</span><span class="n">read_consumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bwr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bwr</span><span class="p">)))</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bwr</span><span class="p">.</span><span class="n">read_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">binder_thread_read</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">bwr</span><span class="p">.</span><span class="n">read_buffer</span><span class="p">,</span> <span class="n">bwr</span><span class="p">.</span><span class="n">read_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bwr</span><span class="p">.</span><span class="n">read_consumed</span><span class="p">,</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">))</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bwr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bwr</span><span class="p">)))</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_READ_WRITE</span><span class="p">,</span>
			     <span class="s">&quot;binder: %d:%d wrote %ld of %ld, read return %ld of %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">bwr</span><span class="p">.</span><span class="n">write_consumed</span><span class="p">,</span> <span class="n">bwr</span><span class="p">.</span><span class="n">write_size</span><span class="p">,</span>
			     <span class="n">bwr</span><span class="p">.</span><span class="n">read_consumed</span><span class="p">,</span> <span class="n">bwr</span><span class="p">.</span><span class="n">read_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bwr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bwr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">BINDER_SET_MAX_THREADS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">max_threads</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">max_threads</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BINDER_SET_CONTEXT_MGR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">binder_context_mgr_node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: BINDER_SET_CONTEXT_MGR already set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">binder_context_mgr_uid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">binder_context_mgr_uid</span> <span class="o">!=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: BINDER_SET_&quot;</span>
				       <span class="s">&quot;CONTEXT_MGR bad uid %d != %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">current</span><span class="o">-&gt;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">,</span>
				       <span class="n">binder_context_mgr_uid</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">binder_context_mgr_uid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">;</span>
		<span class="n">binder_context_mgr_node</span> <span class="o">=</span> <span class="n">binder_new_node</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">binder_context_mgr_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">binder_context_mgr_node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">binder_context_mgr_node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">binder_context_mgr_node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">binder_context_mgr_node</span><span class="o">-&gt;</span><span class="n">has_weak_ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BINDER_THREAD_EXIT</span>:
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_THREADS</span><span class="p">,</span> <span class="s">&quot;binder: %d:%d exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">binder_free_thread</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
		<span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BINDER_VERSION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_version</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">BINDER_CURRENT_PROTOCOL_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">binder_version</span> <span class="o">*</span><span class="p">)</span><span class="n">ubuf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol_version</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="p">)</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BINDER_LOOPER_STATE_NEED_RETURN</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">binder_user_error_wait</span><span class="p">,</span> <span class="n">binder_stop_on_user_error</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;binder: %d:%d ioctl %x %lx returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_vma_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_OPEN_CLOSE</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d open vm area %lx-%lx (%ld K) vma %lx pagep %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">SZ_1K</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pgprot_val</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_vma_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_OPEN_CLOSE</span><span class="p">,</span>
		     <span class="s">&quot;binder: %d close vm area %lx-%lx (%ld K) vma %lx pagep %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">SZ_1K</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pgprot_val</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">));</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">vma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">vma_vm_mm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">binder_defer_work</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">BINDER_DEFERRED_PUT_FILES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">binder_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">binder_vma_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">binder_vma_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_struct</span> <span class="o">*</span><span class="n">area</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">failure_string</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SZ_4M</span><span class="p">)</span>
		<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">+</span> <span class="n">SZ_4M</span><span class="p">;</span>

	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_OPEN_CLOSE</span><span class="p">,</span>
		     <span class="s">&quot;binder_mmap: %d %lx-%lx (%ld K) vma %lx pagep %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">SZ_1K</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pgprot_val</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">FORBIDDEN_MMAP_FLAGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">failure_string</span> <span class="o">=</span> <span class="s">&quot;bad vm_flags&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_bad_arg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|</span> <span class="n">VM_DONTCOPY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VM_MAYWRITE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_mmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">failure_string</span> <span class="o">=</span> <span class="s">&quot;already mapped&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_already_mapped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">area</span> <span class="o">=</span> <span class="n">get_vm_area</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">VM_IOREMAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">failure_string</span> <span class="o">=</span> <span class="s">&quot;get_vm_area&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_get_vm_area_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">user_buffer_offset</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_mmap_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CPU_CACHE_VIPT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_is_vipt_aliasing</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">CACHE_COLOUR</span><span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">^</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;binder_mmap: %d %lx-%lx maps %p bad alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
			<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">failure_string</span> <span class="o">=</span> <span class="s">&quot;alloc page array&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc_pages_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">binder_vm_ops</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">binder_update_page_range</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">vma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">failure_string</span> <span class="o">=</span> <span class="s">&quot;alloc small buf&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc_small_buf_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">binder_insert_free_buffer</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_async_space</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">files</span> <span class="o">=</span> <span class="n">get_files_struct</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">);</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="p">;</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">vma_vm_mm</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">;</span>

	<span class="cm">/*printk(KERN_INFO &quot;binder_mmap: %d %lx-%lx maps %p\n&quot;,</span>
<span class="cm">		 proc-&gt;pid, vma-&gt;vm_start, vma-&gt;vm_end, proc-&gt;buffer);*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_alloc_small_buf_failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_alloc_pages_failed:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_mmap_lock</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_get_vm_area_failed:</span>
<span class="nl">err_already_mapped:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_mmap_lock</span><span class="p">);</span>
<span class="nl">err_bad_arg:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder_mmap: %d %lx-%lx %s failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span> <span class="n">failure_string</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">nodp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>

	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_OPEN_CLOSE</span><span class="p">,</span> <span class="s">&quot;binder_open: %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">current</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">proc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">proc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">get_task_struct</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">default_priority</span> <span class="o">=</span> <span class="n">task_nice</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="n">binder_stats_created</span><span class="p">(</span><span class="n">BINDER_STAT_PROC</span><span class="p">);</span>
	<span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">proc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_procs</span><span class="p">);</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">delivered_death</span><span class="p">);</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">binder_debugfs_dir_entry_proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">strbuf</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strbuf</span><span class="p">),</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">proc</span><span class="o">-&gt;</span><span class="n">debugfs_entry</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="n">binder_debugfs_dir_entry_proc</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_proc_fops</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">binder_defer_work</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">BINDER_DEFERRED_FLUSH</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_deferred_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wake_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">);</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_thread</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">|=</span> <span class="n">BINDER_LOOPER_STATE_NEED_RETURN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span> <span class="o">&amp;</span> <span class="n">BINDER_LOOPER_STATE_WAITING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="n">wake_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wake_up_interruptible_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_OPEN_CLOSE</span><span class="p">,</span>
		     <span class="s">&quot;binder_flush: %d woke %d threads</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
		     <span class="n">wake_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">nodp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">debugfs_entry</span><span class="p">);</span>
	<span class="n">binder_defer_work</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">BINDER_DEFERRED_RELEASE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_deferred_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">threads</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">incoming_refs</span><span class="p">,</span> <span class="n">outgoing_refs</span><span class="p">,</span> <span class="n">buffers</span><span class="p">,</span> <span class="n">active_transactions</span><span class="p">,</span> <span class="n">page_count</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">vma</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">);</span>

	<span class="n">hlist_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">proc_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">binder_context_mgr_node</span> <span class="o">&amp;&amp;</span> <span class="n">binder_context_mgr_node</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">==</span> <span class="n">proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_DEAD_BINDER</span><span class="p">,</span>
			     <span class="s">&quot;binder_release: %d context_mgr_node gone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">binder_context_mgr_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">threads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">active_transactions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_thread</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="n">threads</span><span class="o">++</span><span class="p">;</span>
		<span class="n">active_transactions</span> <span class="o">+=</span> <span class="n">binder_free_thread</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nodes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">incoming_refs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_node</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>

		<span class="n">nodes</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_NODE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">death</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">dead_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_dead_nodes</span><span class="p">);</span>

			<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">,</span> <span class="n">node_entry</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">incoming_refs</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">death</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BINDER_WORK_DEAD_BINDER</span><span class="p">;</span>
						<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
						<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">BUG</span><span class="p">();</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_DEAD_BINDER</span><span class="p">,</span>
				     <span class="s">&quot;binder: node %d now dead, &quot;</span>
				     <span class="s">&quot;refs %d, death %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span>
				     <span class="n">incoming_refs</span><span class="p">,</span> <span class="n">death</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">outgoing_refs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_desc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref</span><span class="p">,</span>
						  <span class="n">rb_node_desc</span><span class="p">);</span>
		<span class="n">outgoing_refs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">binder_delete_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">binder_release_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
	<span class="n">buffers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">allocated_buffers</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span>
							<span class="n">rb_node</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;binder: release proc %d, &quot;</span>
			       <span class="s">&quot;transaction %d, not freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
			<span class="cm">/*BUG();*/</span>
		<span class="p">}</span>
		<span class="n">binder_free_buf</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
		<span class="n">buffers</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_PROC</span><span class="p">);</span>

	<span class="n">page_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">page_addr</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
				<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_BUFFER_ALLOC</span><span class="p">,</span>
					     <span class="s">&quot;binder_release: %d: &quot;</span>
					     <span class="s">&quot;page %d at %p not freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					     <span class="n">page_addr</span><span class="p">);</span>
				<span class="n">unmap_kernel_range</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page_addr</span><span class="p">,</span>
					<span class="n">PAGE_SIZE</span><span class="p">);</span>
				<span class="n">__free_page</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">page_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">put_task_struct</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">);</span>

	<span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_OPEN_CLOSE</span><span class="p">,</span>
		     <span class="s">&quot;binder_release: %d threads %d, nodes %d (ref %d), &quot;</span>
		     <span class="s">&quot;refs %d, active transactions %d, buffers %d, &quot;</span>
		     <span class="s">&quot;pages %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">threads</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">incoming_refs</span><span class="p">,</span> <span class="n">outgoing_refs</span><span class="p">,</span>
		     <span class="n">active_transactions</span><span class="p">,</span> <span class="n">buffers</span><span class="p">,</span> <span class="n">page_count</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">binder_deferred_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">defer</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_deferred_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_deferred_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">proc</span> <span class="o">=</span> <span class="n">hlist_entry</span><span class="p">(</span><span class="n">binder_deferred_list</span><span class="p">.</span><span class="n">first</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">binder_proc</span><span class="p">,</span> <span class="n">deferred_work_node</span><span class="p">);</span>
			<span class="n">hlist_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">deferred_work_node</span><span class="p">);</span>
			<span class="n">defer</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">deferred_work</span><span class="p">;</span>
			<span class="n">proc</span><span class="o">-&gt;</span><span class="n">deferred_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">defer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_deferred_lock</span><span class="p">);</span>

		<span class="n">files</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">defer</span> <span class="o">&amp;</span> <span class="n">BINDER_DEFERRED_PUT_FILES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">files</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">files</span><span class="p">)</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">files</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">defer</span> <span class="o">&amp;</span> <span class="n">BINDER_DEFERRED_FLUSH</span><span class="p">)</span>
			<span class="n">binder_deferred_flush</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">defer</span> <span class="o">&amp;</span> <span class="n">BINDER_DEFERRED_RELEASE</span><span class="p">)</span>
			<span class="n">binder_deferred_release</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span> <span class="cm">/* frees proc */</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">files</span><span class="p">)</span>
			<span class="n">put_files_struct</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">proc</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">binder_deferred_work</span><span class="p">,</span> <span class="n">binder_deferred_func</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">binder_defer_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">binder_deferred_state</span> <span class="n">defer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_deferred_lock</span><span class="p">);</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">deferred_work</span> <span class="o">|=</span> <span class="n">defer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hlist_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">deferred_work_node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">deferred_work_node</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">binder_deferred_list</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">binder_deferred_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_deferred_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_deferred_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_transaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		   <span class="s">&quot;%s %d: %p from %d:%d to %d:%d code %x flags %x pri %ld r%d&quot;</span><span class="p">,</span>
		   <span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">?</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">?</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">to_proc</span> <span class="o">?</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">to_proc</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">?</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">to_thread</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">need_reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; buffer free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; node %d&quot;</span><span class="p">,</span>
			   <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">target_node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; size %zd:%zd data %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">,</span>
		   <span class="n">t</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">binder_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s %d: %p size %zd:%zd %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">prefix</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		   <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">,</span>
		   <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">?</span> <span class="s">&quot;active&quot;</span> <span class="o">:</span> <span class="s">&quot;delivered&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">transaction_prefix</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">binder_work</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BINDER_WORK_TRANSACTION</span>:
		<span class="n">t</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_transaction</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
		<span class="n">print_binder_transaction</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">transaction_prefix</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BINDER_WORK_TRANSACTION_COMPLETE</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%stransaction complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BINDER_WORK_NODE</span>:
		<span class="n">node</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_node</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%snode work %d: u%p c%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">prefix</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BINDER_WORK_DEAD_BINDER</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%shas dead binder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BINDER_WORK_DEAD_BINDER_AND_CLEAR</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%shas cleared dead binder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BINDER_WORK_CLEAR_DEATH_NOTIFICATION</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%shas cleared death notification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%sunknown work: type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">print_always</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_work</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">header_pos</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  thread %d: l %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">looper</span><span class="p">);</span>
	<span class="n">header_pos</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">transaction_stack</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">==</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_binder_transaction</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
						 <span class="s">&quot;    outgoing transaction&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">from_parent</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">to_thread</span> <span class="o">==</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_binder_transaction</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
						 <span class="s">&quot;    incoming transaction&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">to_parent</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">print_binder_transaction</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    bad transaction&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="n">t</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_binder_work</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">,</span> <span class="s">&quot;    pending transaction&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print_always</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="n">header_pos</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">start_pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_work</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">,</span> <span class="n">node_entry</span><span class="p">)</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  node %d: u%p c%p hs %d hw %d ls %d lw %d is %d iw %d&quot;</span><span class="p">,</span>
		   <span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span>
		   <span class="n">node</span><span class="o">-&gt;</span><span class="n">has_strong_ref</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">has_weak_ref</span><span class="p">,</span>
		   <span class="n">node</span><span class="o">-&gt;</span><span class="n">local_strong_refs</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">local_weak_refs</span><span class="p">,</span>
		   <span class="n">node</span><span class="o">-&gt;</span><span class="n">internal_strong_refs</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; proc&quot;</span><span class="p">);</span>
		<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">,</span> <span class="n">node_entry</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %d&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">async_todo</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
		<span class="n">print_binder_work</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">,</span>
				  <span class="s">&quot;    pending async transaction&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  ref %d: desc %d %snode %d s %d w %d d %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ref</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;dead &quot;</span><span class="p">,</span>
		   <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">death</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print_all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_work</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">header_pos</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;proc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">header_pos</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">);</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
		<span class="n">print_binder_thread</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_thread</span><span class="p">,</span>
						<span class="n">rb_node</span><span class="p">),</span> <span class="n">print_all</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_node</span><span class="p">,</span>
						    <span class="n">rb_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_all</span> <span class="o">||</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">has_async_transaction</span><span class="p">)</span>
			<span class="n">print_binder_node</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">print_all</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_desc</span><span class="p">);</span>
		     <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
		     <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
			<span class="n">print_binder_ref</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref</span><span class="p">,</span>
						     <span class="n">rb_node_desc</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">allocated_buffers</span><span class="p">);</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
		<span class="n">print_binder_buffer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  buffer&quot;</span><span class="p">,</span>
				    <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_buffer</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">));</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
		<span class="n">print_binder_work</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="s">&quot;  pending transaction&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">delivered_death</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  has delivered dead binder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print_all</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="n">header_pos</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">start_pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">binder_return_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;BR_ERROR&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_OK&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_TRANSACTION&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_REPLY&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_ACQUIRE_RESULT&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_DEAD_REPLY&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_TRANSACTION_COMPLETE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_INCREFS&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_ACQUIRE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_RELEASE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_DECREFS&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_ATTEMPT_ACQUIRE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_NOOP&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_SPAWN_LOOPER&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_FINISHED&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_DEAD_BINDER&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_CLEAR_DEATH_NOTIFICATION_DONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BR_FAILED_REPLY&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">binder_command_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;BC_TRANSACTION&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_REPLY&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_ACQUIRE_RESULT&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_FREE_BUFFER&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_INCREFS&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_ACQUIRE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_RELEASE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_DECREFS&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_INCREFS_DONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_ACQUIRE_DONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_ATTEMPT_ACQUIRE&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_REGISTER_LOOPER&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_ENTER_LOOPER&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_EXIT_LOOPER&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_REQUEST_DEATH_NOTIFICATION&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_CLEAR_DEATH_NOTIFICATION&quot;</span><span class="p">,</span>
	<span class="s">&quot;BC_DEAD_BINDER_DONE&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">binder_objstat_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;proc&quot;</span><span class="p">,</span>
	<span class="s">&quot;thread&quot;</span><span class="p">,</span>
	<span class="s">&quot;node&quot;</span><span class="p">,</span>
	<span class="s">&quot;ref&quot;</span><span class="p">,</span>
	<span class="s">&quot;death&quot;</span><span class="p">,</span>
	<span class="s">&quot;transaction&quot;</span><span class="p">,</span>
	<span class="s">&quot;transaction_complete&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">binder_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bc</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">binder_command_strings</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s%s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
				   <span class="n">binder_command_strings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">bc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">binder_return_strings</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s%s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
				   <span class="n">binder_return_strings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">obj_created</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">binder_objstat_strings</span><span class="p">));</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">obj_created</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">obj_deleted</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">obj_created</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">obj_created</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">obj_deleted</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s%s: active %d total %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
				<span class="n">binder_objstat_strings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">obj_created</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">obj_deleted</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">obj_created</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_proc_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_work</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">weak</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;proc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">);</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  threads: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  requested threads: %d+%d/%d</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;  ready threads %d</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;  free async space %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">requested_threads</span><span class="p">,</span>
			<span class="n">proc</span><span class="o">-&gt;</span><span class="n">requested_threads_started</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">max_threads</span><span class="p">,</span>
			<span class="n">proc</span><span class="o">-&gt;</span><span class="n">ready_threads</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">free_async_space</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  nodes: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strong</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">weak</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">refs_by_desc</span><span class="p">);</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">binder_ref</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">binder_ref</span><span class="p">,</span>
						  <span class="n">rb_node_desc</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">strong</span> <span class="o">+=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">strong</span><span class="p">;</span>
		<span class="n">weak</span> <span class="o">+=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">weak</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  refs: %d s %d w %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">weak</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">allocated_buffers</span><span class="p">);</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  buffers: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BINDER_WORK_TRANSACTION</span>:
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  pending transactions: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">print_binder_stats</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">binder_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_lock</span> <span class="o">=</span> <span class="o">!</span><span class="n">binder_debug_no_lock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;binder state:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_dead_nodes</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;dead nodes:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_dead_nodes</span><span class="p">,</span> <span class="n">dead_node</span><span class="p">)</span>
		<span class="n">print_binder_node</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_procs</span><span class="p">,</span> <span class="n">proc_node</span><span class="p">)</span>
		<span class="n">print_binder_proc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_stats_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_lock</span> <span class="o">=</span> <span class="o">!</span><span class="n">binder_debug_no_lock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;binder stats:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">print_binder_stats</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_stats</span><span class="p">);</span>

	<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_procs</span><span class="p">,</span> <span class="n">proc_node</span><span class="p">)</span>
		<span class="n">print_binder_proc_stats</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">proc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_transactions_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_lock</span> <span class="o">=</span> <span class="o">!</span><span class="n">binder_debug_no_lock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;binder transactions:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binder_procs</span><span class="p">,</span> <span class="n">proc_node</span><span class="p">)</span>
		<span class="n">print_binder_proc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_lock</span> <span class="o">=</span> <span class="o">!</span><span class="n">binder_debug_no_lock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;binder proc state:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_binder_proc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_binder_transaction_log_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">binder_transaction_log_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		   <span class="s">&quot;%d: %s from %d:%d to %d:%d node %d handle %d size %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">e</span><span class="o">-&gt;</span><span class="n">debug_id</span><span class="p">,</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">call_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;reply&quot;</span> <span class="o">:</span>
		   <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">call_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;async&quot;</span> <span class="o">:</span> <span class="s">&quot;call &quot;</span><span class="p">),</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">from_proc</span><span class="p">,</span>
		   <span class="n">e</span><span class="o">-&gt;</span><span class="n">from_thread</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_proc</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_thread</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_node</span><span class="p">,</span>
		   <span class="n">e</span><span class="o">-&gt;</span><span class="n">target_handle</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offsets_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_transaction_log_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">binder_transaction_log</span> <span class="o">*</span><span class="n">log</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="o">-&gt;</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">log</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">log</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">print_binder_transaction_log_entry</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">log</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">log</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">print_binder_transaction_log_entry</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">log</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">binder_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">binder_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">binder_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">binder_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">binder_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">binder_flush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">binder_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">binder_miscdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;binder&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">binder_fops</span>
<span class="p">};</span>

<span class="n">BINDER_DEBUG_ENTRY</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="n">BINDER_DEBUG_ENTRY</span><span class="p">(</span><span class="n">stats</span><span class="p">);</span>
<span class="n">BINDER_DEBUG_ENTRY</span><span class="p">(</span><span class="n">transactions</span><span class="p">);</span>
<span class="n">BINDER_DEBUG_ENTRY</span><span class="p">(</span><span class="n">transaction_log</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">binder_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">binder_deferred_workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;binder&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">binder_deferred_workqueue</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">binder_debugfs_dir_entry_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;binder&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">binder_debugfs_dir_entry_root</span><span class="p">)</span>
		<span class="n">binder_debugfs_dir_entry_proc</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span>
						 <span class="n">binder_debugfs_dir_entry_root</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binder_miscdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">binder_debugfs_dir_entry_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;state&quot;</span><span class="p">,</span>
				    <span class="n">S_IRUGO</span><span class="p">,</span>
				    <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">binder_state_fops</span><span class="p">);</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;stats&quot;</span><span class="p">,</span>
				    <span class="n">S_IRUGO</span><span class="p">,</span>
				    <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">binder_stats_fops</span><span class="p">);</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;transactions&quot;</span><span class="p">,</span>
				    <span class="n">S_IRUGO</span><span class="p">,</span>
				    <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">binder_transactions_fops</span><span class="p">);</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;transaction_log&quot;</span><span class="p">,</span>
				    <span class="n">S_IRUGO</span><span class="p">,</span>
				    <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">binder_transaction_log</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">binder_transaction_log_fops</span><span class="p">);</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;failed_transaction_log&quot;</span><span class="p">,</span>
				    <span class="n">S_IRUGO</span><span class="p">,</span>
				    <span class="n">binder_debugfs_dir_entry_root</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">binder_transaction_log_failed</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">binder_transaction_log_fops</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">binder_init</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
