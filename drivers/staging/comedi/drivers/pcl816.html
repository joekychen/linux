<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › pcl816.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pcl816.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   comedi/drivers/pcl816.c</span>

<span class="cm">   Author:  Juan Grigera &lt;juan@grigera.com.ar&gt;</span>
<span class="cm">	    based on pcl818 by Michal Dobes &lt;dobes@tesnet.cz&gt; and bits of pcl812</span>

<span class="cm">   hardware driver for Advantech cards:</span>
<span class="cm">    card:   PCL-816, PCL814B</span>
<span class="cm">    driver: pcl816</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">Driver: pcl816</span>
<span class="cm">Description: Advantech PCL-816 cards, PCL-814</span>
<span class="cm">Author: Juan Grigera &lt;juan@grigera.com.ar&gt;</span>
<span class="cm">Devices: [Advantech] PCL-816 (pcl816), PCL-814B (pcl814b)</span>
<span class="cm">Status: works</span>
<span class="cm">Updated: Tue,  2 Apr 2002 23:15:21 -0800</span>

<span class="cm">PCL 816 and 814B have 16 SE/DIFF ADCs, 16 DACs, 16 DI and 16 DO.</span>
<span class="cm">Differences are at resolution (16 vs 12 bits).</span>

<span class="cm">The driver support AI command mode, other subdevices not written.</span>

<span class="cm">Analog output and digital input and output are not supported.</span>

<span class="cm">Configuration Options:</span>
<span class="cm">  [0] - IO Base</span>
<span class="cm">  [1] - IRQ	(0=disable, 2, 3, 4, 5, 6, 7)</span>
<span class="cm">  [2] - DMA	(0=disable, 1, 3)</span>
<span class="cm">  [3] - 0, 10=10MHz clock for 8254</span>
<span class="cm">	    1= 1MHz clock for 8254</span>

<span class="cm">*/</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mc146818rtc.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &quot;8253.h&quot;</span>

<span class="cp">#define DEBUG(x) x</span>

<span class="cm">/* boards constants */</span>
<span class="cm">/* IO space len */</span>
<span class="cp">#define PCLx1x_RANGE 16</span>

<span class="cm">/* #define outb(x,y)  printk(&quot;OUTB(%x, 200+%d)\n&quot;, x,y-0x200); outb(x,y) */</span>

<span class="cm">/* INTEL 8254 counters */</span>
<span class="cp">#define PCL816_CTR0 4</span>
<span class="cp">#define PCL816_CTR1 5</span>
<span class="cp">#define PCL816_CTR2 6</span>
<span class="cm">/* R: counter read-back register W: counter control */</span>
<span class="cp">#define PCL816_CTRCTL 7</span>

<span class="cm">/* R: A/D high byte W: A/D range control */</span>
<span class="cp">#define PCL816_RANGE 9</span>
<span class="cm">/* W: clear INT request */</span>
<span class="cp">#define PCL816_CLRINT 10</span>
<span class="cm">/* R: next mux scan channel W: mux scan channel &amp; range control pointer */</span>
<span class="cp">#define PCL816_MUX 11</span>
<span class="cm">/* R/W: operation control register */</span>
<span class="cp">#define PCL816_CONTROL 12</span>

<span class="cm">/* R: return status byte  W: set DMA/IRQ */</span>
<span class="cp">#define PCL816_STATUS 13</span>
<span class="cp">#define PCL816_STATUS_DRDY_MASK 0x80</span>

<span class="cm">/* R: low byte of A/D W: soft A/D trigger */</span>
<span class="cp">#define PCL816_AD_LO 8</span>
<span class="cm">/* R: high byte of A/D W: A/D range control */</span>
<span class="cp">#define PCL816_AD_HI 9</span>

<span class="cm">/* type of interrupt handler */</span>
<span class="cp">#define INT_TYPE_AI1_INT 1</span>
<span class="cp">#define INT_TYPE_AI1_DMA 2</span>
<span class="cp">#define INT_TYPE_AI3_INT 4</span>
<span class="cp">#define INT_TYPE_AI3_DMA 5</span>
<span class="cp">#ifdef unused</span>
<span class="cp">#define INT_TYPE_AI1_DMA_RTC 9</span>
<span class="cp">#define INT_TYPE_AI3_DMA_RTC 10</span>

<span class="cm">/* RTC stuff... */</span>
<span class="cp">#define RTC_IRQ		8</span>
<span class="cp">#define RTC_IO_EXTENT	0x10</span>
<span class="cp">#endif</span>

<span class="cp">#define MAGIC_DMA_WORD 0x5a5a</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pcl816</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="p">{</span>
						       <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
						       <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
						       <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
						       <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
						       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
						       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
						       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
						       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
						       <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pcl816_board</span> <span class="p">{</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>	<span class="cm">/*  board name */</span>
	<span class="kt">int</span> <span class="n">n_ranges</span><span class="p">;</span>		<span class="cm">/*  len of range list */</span>
	<span class="kt">int</span> <span class="n">n_aichan</span><span class="p">;</span>		<span class="cm">/*  num of A/D chans in diferencial mode */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_ns_min</span><span class="p">;</span>	<span class="cm">/*  minimal allowed delay between samples (in ns) */</span>
	<span class="kt">int</span> <span class="n">n_aochan</span><span class="p">;</span>		<span class="cm">/*  num of D/A chans */</span>
	<span class="kt">int</span> <span class="n">n_dichan</span><span class="p">;</span>		<span class="cm">/*  num of DI chans */</span>
	<span class="kt">int</span> <span class="n">n_dochan</span><span class="p">;</span>		<span class="cm">/*  num of DO chans */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">ai_range_type</span><span class="p">;</span>	<span class="cm">/*  default A/D rangelist */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">ao_range_type</span><span class="p">;</span>	<span class="cm">/*  default D/A rangelist */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_range</span><span class="p">;</span>	<span class="cm">/*  len of IO space */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IRQbits</span><span class="p">;</span>	<span class="cm">/*  allowed interrupts */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DMAbits</span><span class="p">;</span>	<span class="cm">/*  allowed DMA chans */</span>
	<span class="kt">int</span> <span class="n">ai_maxdata</span><span class="p">;</span>		<span class="cm">/*  maxdata for A/D */</span>
	<span class="kt">int</span> <span class="n">ao_maxdata</span><span class="p">;</span>		<span class="cm">/*  maxdata for D/A */</span>
	<span class="kt">int</span> <span class="n">ai_chanlist</span><span class="p">;</span>	<span class="cm">/*  allowed len of channel list A/D */</span>
	<span class="kt">int</span> <span class="n">ao_chanlist</span><span class="p">;</span>	<span class="cm">/*  allowed len of channel list D/A */</span>
	<span class="kt">int</span> <span class="n">i8254_osc_base</span><span class="p">;</span>	<span class="cm">/*  1/frequency of on board oscilator in ns */</span>
<span class="p">};</span>

<span class="cp">#define devpriv ((struct pcl816_private *)dev-&gt;private)</span>
<span class="cp">#define this_board ((const struct pcl816_board *)dev-&gt;board_ptr)</span>

<span class="cp">#ifdef unused</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">RTC_lock</span><span class="p">;</span>	<span class="cm">/* RTC lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">RTC_timer_lock</span><span class="p">;</span>	<span class="cm">/* RTC int lock */</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">pcl816_private</span> <span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>	<span class="cm">/*  used DMA, 0=don&#39;t use DMA */</span>
	<span class="kt">int</span> <span class="n">dma_rtc</span><span class="p">;</span>		<span class="cm">/*  1=RTC used with DMA, 0=no RTC alloc */</span>
<span class="cp">#ifdef unused</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtc_iobase</span><span class="p">;</span>	<span class="cm">/*  RTC port region */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtc_iosize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtc_irq</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dmabuf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  pointers to begin of DMA buffers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmapages</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  len of DMA buffers in PAGE_SIZEs */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  hardware address of DMA buffers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwdmasize</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  len of DMA buffers in Bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmasamplsize</span><span class="p">;</span>	<span class="cm">/*  size in samples hwdmasize[0]/2 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_top_dma</span><span class="p">;</span>	<span class="cm">/*  DMA pointer in last RTC int */</span>
	<span class="kt">int</span> <span class="n">next_dma_buf</span><span class="p">;</span>	<span class="cm">/*  which DMA buffer will be used next round */</span>
	<span class="kt">long</span> <span class="n">dma_runs_to_end</span><span class="p">;</span>	<span class="cm">/*  how many we must permorm DMA transfer to end of record */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_dma_run</span><span class="p">;</span>	<span class="cm">/*  how many bytes we must transfer on last DMA page */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_scans</span><span class="p">;</span>	<span class="cm">/*  len of scanlist */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ai_neverending</span><span class="p">;</span>	<span class="cm">/*  if=1, then we do neverending record (you must use cancel()) */</span>
	<span class="kt">int</span> <span class="n">irq_free</span><span class="p">;</span>		<span class="cm">/*  1=have allocated IRQ */</span>
	<span class="kt">int</span> <span class="n">irq_blocked</span><span class="p">;</span>	<span class="cm">/*  1=IRQ now uses any subdev */</span>
<span class="cp">#ifdef unused</span>
	<span class="kt">int</span> <span class="n">rtc_irq_blocked</span><span class="p">;</span>	<span class="cm">/*  1=we now do AI with DMA&amp;RTC */</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">irq_was_now_closed</span><span class="p">;</span>	<span class="cm">/*  when IRQ finish, there&#39;s stored int816_mode for last interrupt */</span>
	<span class="kt">int</span> <span class="n">int816_mode</span><span class="p">;</span>	<span class="cm">/*  who now uses IRQ - 1=AI1 int, 2=AI1 dma, 3=AI3 int, 4AI3 dma */</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">last_int_sub</span><span class="p">;</span>	<span class="cm">/*  ptr to subdevice which now finish */</span>
	<span class="kt">int</span> <span class="n">ai_act_scan</span><span class="p">;</span>	<span class="cm">/*  how many scans we finished */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_act_chanlist</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="cm">/*  MUX setting for actual AI operations */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_act_chanlist_len</span><span class="p">;</span>	<span class="cm">/*  how long is actual MUX list */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_act_chanlist_pos</span><span class="p">;</span>	<span class="cm">/*  actual position in MUX list */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_n_chan</span><span class="p">;</span>		<span class="cm">/*  how many channels per scan */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_poll_ptr</span><span class="p">;</span>	<span class="cm">/*  how many sampes transfer poll */</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">sub_ai</span><span class="p">;</span>	<span class="cm">/*  ptr to AI subdevice */</span>
<span class="cp">#ifdef unused</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">rtc_irq_timer</span><span class="p">;</span>	<span class="cm">/*  timer for RTC sanity check */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtc_freq</span><span class="p">;</span>	<span class="cm">/*  RTC int freq */</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">check_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chanlen</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">setup_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seglen</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pcl816_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">start_pacer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor2</span><span class="p">);</span>
<span class="cp">#ifdef unused</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_rtc_irq_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pcl816_ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pcl816_ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   ANALOG INPUT MODE0, 816 cards, slow version</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl816_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;mode 0 analog input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*  software trigger, DMA and INT off */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">);</span>
	<span class="cm">/*  clear INT (conversion end) flag */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CLRINT</span><span class="p">);</span>

	<span class="cm">/*  Set the input channel */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_MUX</span><span class="p">);</span>
	<span class="cm">/* select gain */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_RANGE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_AD_LO</span><span class="p">);</span>	<span class="cm">/* start conversion */</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">PCL816_STATUS_DRDY_MASK</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*  return read value */</span>
				<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
					  <span class="n">PCL816_AD_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_AD_LO</span><span class="p">)));</span>
				<span class="cm">/* clear INT (conversion end) flag */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CLRINT</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*  Return timeout error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D insn timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* clear INT (conversion end) flag */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CLRINT</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   analog input interrupt mode 1 &amp; 3, 818 cards</span>
<span class="cm">   one sample per interrupt version</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl816_ai_mode13_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">low</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* wait max 50us */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="n">PCL816_STATUS_DRDY_MASK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/*  timeout, bail error */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D mode1/3 IRQ without DRDY!&quot;</span><span class="p">);</span>
		<span class="n">pcl816_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/*  get the sample */</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_AD_LO</span><span class="p">);</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_AD_HI</span><span class="p">);</span>

	<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist_pos</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist_len</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">)</span>
					<span class="cm">/* all data sampled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* all data sampled */</span>
			<span class="n">pcl816_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   analog input dma mode 1 &amp; 3, 816 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">transfer_from_dma_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">short</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">bufptr</span><span class="o">++</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist_pos</span> <span class="o">&gt;=</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">)</span>
						<span class="cm">/*  all data sampled */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pcl816_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_BLOCK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl816_ai_mode13_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">,</span> <span class="n">this_dma_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">this_dma_buf</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">;</span>

	<span class="cm">/*  switch dma bufs */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">;</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
		<span class="n">dma_flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
<span class="cm">/* clear_dma_ff (devpriv-&gt;dma); */</span>
		<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
							 <span class="n">next_dma_buf</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_dma_run</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dma_flags</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span><span class="o">--</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="n">this_dma_buf</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span><span class="p">;</span>
	<span class="n">bufptr</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">transfer_from_dma_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">    INT procedure</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl816</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&lt;I&gt;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;premature interrupt&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int816_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INT_TYPE_AI1_DMA</span>:
	<span class="k">case</span> <span class="n">INT_TYPE_AI3_DMA</span>:
		<span class="k">return</span> <span class="n">interrupt_pcl816_ai_mode13_dma</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">INT_TYPE_AI1_INT</span>:
	<span class="k">case</span> <span class="n">INT_TYPE_AI3_INT</span>:
		<span class="k">return</span> <span class="n">interrupt_pcl816_ai_mode13_int</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_free</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int816_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_was_now_closed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_was_now_closed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/*  comedi_error(dev,&quot;last IRQ..&quot;); */</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad IRQ!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ from unknown source!&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   COMMAND MODE</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl816_cmdtest_out</span><span class="p">(</span><span class="kt">int</span> <span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcl816 e=%d startsrc=%x scansrc=%x convsrc=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcl816 e=%d startarg=%d scanarg=%d convarg=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcl816 e=%d stopsrc=%x scanend=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcl816 e=%d stoparg=%d scanendarg=%d chanlistlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">e</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl816_ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">divisor1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">divisor2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcl816 pcl812_ai_cmdtest</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="n">pcl816_cmdtest_out</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	     <span class="p">);</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_EXT</span> <span class="o">|</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * step 2: make sure trigger sources</span>
<span class="cm">	 * are unique and mutually compatible</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">=</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>


	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TRIG_EXT */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TRIG_NONE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>


	<span class="cm">/* step 4: fix up any arguments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">divisor1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor2</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
					  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>


	<span class="cm">/* step 5: complain about special chanlist considerations */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/*  incorrect channels list */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl816_ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">divisor2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dma_flags</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">dmairq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seglen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cm">/* if(cmd-&gt;chanlist_len&gt;MAX_CHANLIST_LEN) return -EINVAL; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>

		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor1</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">divisor2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
					  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>

		<span class="cm">/*  PCL816 crash if any divisor is set to 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divisor1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">divisor1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">divisor2</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divisor2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">divisor2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">divisor1</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  stop pacer */</span>

	<span class="n">seglen</span> <span class="o">=</span> <span class="n">check_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seglen</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">setup_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">,</span> <span class="n">seglen</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_was_now_closed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  don&#39;t we want wake up every scan? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;pl816: You wankt WAKE_EOS but I dont want handle it&quot;</span><span class="p">);</span>
		<span class="cm">/*               devpriv-&gt;ai_eos=1; */</span>
		<span class="cm">/* if (devpriv-&gt;ai_n_chan==1) */</span>
		<span class="cm">/*       devpriv-&gt;dma=0; // DMA is useless for this situation */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  how many */</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist_len</span> <span class="o">*</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist_len</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>

			<span class="cm">/*  how many DMA pages we must fill */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="cm">/* on last dma transfer must be moved */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_dma_run</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">%</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
		<span class="n">dma_flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dma_flags</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">divisor1</span><span class="p">,</span> <span class="n">divisor2</span><span class="p">);</span>
	<span class="n">dmairq</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int816_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI1_DMA</span><span class="p">;</span>

		<span class="cm">/*  Pacer+IRQ+DMA */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x32</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">);</span>

		<span class="cm">/*  write irq and DMA to card */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">dmairq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_STATUS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int816_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI3_DMA</span><span class="p">;</span>

		<span class="cm">/*  Ext trig+IRQ+DMA */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x34</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">);</span>

		<span class="cm">/*  write irq to card */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">dmairq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_STATUS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;pcl816 END: pcl812_ai_cmd()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl816_ai_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  poll is valid only for DMA transfer */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top1</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>	<span class="cm">/*  where is now DMA */</span>
		<span class="n">top2</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">top1</span> <span class="o">==</span> <span class="n">top2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top1</span> <span class="o">!=</span> <span class="n">top2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  where is now DMA in buffer */</span>
	<span class="n">top1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">top1</span><span class="p">;</span>
	<span class="n">top1</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/*  sample position */</span>
	<span class="n">top2</span> <span class="o">=</span> <span class="n">top1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/*  no new samples */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">transfer_from_dma_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">],</span>
			      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span><span class="p">,</span> <span class="n">top2</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span> <span class="o">=</span> <span class="n">top1</span><span class="p">;</span>	<span class="cm">/*  new buffer position */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_count</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> cancel any mode 1-4 AI</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl816_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* DEBUG(printk(&quot;pcl816_ai_cancel()\n&quot;);) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int816_mode</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef unused</span>
		<span class="k">case</span> <span class="n">INT_TYPE_AI1_DMA_RTC</span>:
		<span class="k">case</span> <span class="n">INT_TYPE_AI3_DMA_RTC</span>:
			<span class="n">set_rtc_irq_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  stop RTC */</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq_timer</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">INT_TYPE_AI1_DMA</span>:
		<span class="k">case</span> <span class="n">INT_TYPE_AI3_DMA</span>:
			<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">INT_TYPE_AI1_INT</span>:
		<span class="k">case</span> <span class="n">INT_TYPE_AI3_INT</span>:
			<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x73</span><span class="p">,</span>
			     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">);</span>	<span class="cm">/* Stop A/D */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">);</span>	<span class="cm">/* Stop A/D */</span>

			<span class="cm">/* Stop pacer */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTRCTL</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTRCTL</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_AD_LO</span><span class="p">);</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_AD_LO</span><span class="p">);</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_AD_HI</span><span class="p">);</span>

			<span class="cm">/* clear INT request */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CLRINT</span><span class="p">);</span>

			<span class="cm">/* Stop A/D */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_was_now_closed</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int816_mode</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int816_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_int_sub</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
<span class="cm">/* s-&gt;busy = 0; */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;comedi: pcl816_ai_cancel() successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> chech for PCL816</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl816_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_MUX</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_MUX</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* there isn&#39;t card */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_MUX</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_MUX</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* there isn&#39;t card */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_MUX</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x18</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* there isn&#39;t card */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/*  ok, card exist */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> reset whole PCL-816 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl816_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* outb (0, dev-&gt;iobase + PCL818_DA_LO);         DAC=0V */</span>
<span class="cm">/* outb (0, dev-&gt;iobase + PCL818_DA_HI); */</span>
<span class="cm">/* udelay (1); */</span>
<span class="cm">/* outb (0, dev-&gt;iobase + PCL818_DO_HI);        DO=$0000 */</span>
<span class="cm">/* outb (0, dev-&gt;iobase + PCL818_DO_LO); */</span>
<span class="cm">/* udelay (1); */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CONTROL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_MUX</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CLRINT</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTRCTL</span><span class="p">);</span>	<span class="cm">/* Stop pacer */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTRCTL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTRCTL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_RANGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> Start/stop pacer onboard pacer</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">start_pacer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span><span class="p">,</span>
	    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x32</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTRCTL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTR0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTR0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*  set counter 2 as mode 3 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xb4</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTRCTL</span><span class="p">);</span>
	<span class="cm">/*  set counter 1 as mode 3 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x74</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTRCTL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;mode %d, divisor1 %d, divisor2 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">divisor1</span><span class="p">,</span>
			<span class="n">divisor2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">divisor2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTR2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">divisor2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTR2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">divisor1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTR1</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">divisor1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_CTR1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clear pending interrupts (just in case) */</span>
<span class="cm">/* outb(0, dev-&gt;iobase + PCL816_CLRINT); */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> Check if channel list from user is builded correctly</span>
<span class="cm"> If it&#39;s ok, then return non-zero length of repeated segment of channel list</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chanlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chansegment</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nowmustbechan</span><span class="p">,</span> <span class="n">seglen</span><span class="p">,</span> <span class="n">segpos</span><span class="p">;</span>

	<span class="cm">/*  correct channel and range number check itself comedi/range.c */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanlen</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;range/channel list is empty!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanlen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  first channel is every time ok */</span>
		<span class="n">chansegment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seglen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chanlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">seglen</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  build part of chanlist */</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%d. %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				     <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				     <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]));)</span>

			<span class="cm">/*  we detect loop, this must by finish */</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">nowmustbechan</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">chanlen</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nowmustbechan</span> <span class="o">!=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="cm">/*  channel list isn&#39;t continuous :-( */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;comedi%d: pcl816: channel list must &quot;</span>
				       <span class="s">&quot;be continuous! chanlist[%i]=%d but &quot;</span>
				       <span class="s">&quot;must be %d or %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">nowmustbechan</span><span class="p">,</span>
				       <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*  well, this is next correct channel in list */</span>
			<span class="n">chansegment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="cm">/*  check whole chanlist */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">segpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chanlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d %d=%d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">]),</span>
				     <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">]),</span>
				     <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				     <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]));)</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">chansegment</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;comedi%d: pcl816: bad channel or range&quot;</span>
				       <span class="s">&quot; number! chanlist[%i]=%d,%d,%d and not&quot;</span>
				       <span class="s">&quot; %d,%d,%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				       <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				       <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				       <span class="n">CR_AREF</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				       <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">]),</span>
				       <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">]),</span>
				       <span class="n">CR_AREF</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">]));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  chan/gain list is strange */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seglen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">seglen</span><span class="p">;</span>	<span class="cm">/*  we can serve this with MUX logic */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> Program scan/gain logic with channel list.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setup_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seglen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist_len</span> <span class="o">=</span> <span class="n">seglen</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">seglen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  store range list to card */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_MUX</span><span class="p">);</span>
		<span class="cm">/* select gain */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_RANGE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* select channel interval to scan */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chanlist</span><span class="p">[</span><span class="n">seglen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL816_MUX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef unused</span>
<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">  Enable(1)/disable(0) periodic interrupts from RTC</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rtc_irq_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTC_timer_lock</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTC_timer_lock</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTC_timer_lock</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTC_timer_lock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">RTC_timer_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTC_timer_lock</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">save_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cli</span><span class="p">();</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">CMOS_READ</span><span class="p">(</span><span class="n">RTC_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">RTC_PIE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTC_PIE</span><span class="p">;</span>

	<span class="n">CMOS_WRITE</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">RTC_CONTROL</span><span class="p">);</span>
	<span class="n">CMOS_READ</span><span class="p">(</span><span class="n">RTC_INTR_FLAGS</span><span class="p">);</span>
	<span class="n">restore_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl816_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pages</span><span class="p">;</span>
	<span class="cm">/* int i; */</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="cm">/* claim our I/O space */</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;comedi%d: pcl816:  board=%s, ioport=0x%03lx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
	       <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">io_range</span><span class="p">,</span> <span class="s">&quot;pcl816&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;I/O port conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcl816_check</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;, I cann&#39;t detect board. FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcl816_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>	<span class="cm">/* Can&#39;t alloc mem */</span>

	<span class="cm">/* set up some name stuff */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="cm">/* grab our IRQ */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">IRQbits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* board support IRQ */</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* we want to use IRQ */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">IRQbits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;, IRQ %u is out of allowed range, &quot;</span>
				     <span class="s">&quot;DISABLING IT&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
				<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Bad IRQ */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span>
				    <span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">interrupt_pcl816</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pcl816&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;, unable to allocate IRQ %u, &quot;</span>
					     <span class="s">&quot;DISABLING IT&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
					<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Can&#39;t use IRQ */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;, irq=%u&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>	<span class="cm">/* 1=we have allocated irq */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* number of subdevice which use IRQ */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int816_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* mode of irq */</span>

<span class="cp">#ifdef unused</span>
	<span class="cm">/* grab RTC for DMA operations */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  we want to use DMA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTC_lock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">RTC_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">RTC_IO_EXTENT</span><span class="p">,</span>
					    <span class="s">&quot;pcl816 (RTC)&quot;</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">no_rtc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span> <span class="o">=</span> <span class="n">RTC_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iosize</span> <span class="o">=</span> <span class="n">RTC_IO_EXTENT</span><span class="p">;</span>
		<span class="n">RTC_lock</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef UNTESTED_CODE</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_irq</span><span class="p">(</span><span class="n">RTC_IRQ</span><span class="p">,</span> <span class="n">interrupt_pcl816_ai_mode13_dma_rtc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="s">&quot;pcl816 DMA (RTC)&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq</span> <span class="o">=</span> <span class="n">RTC_IRQ</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, dma_irq=%u&quot;</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTC_lock</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RTC_lock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span><span class="p">)</span>
					<span class="n">release_region</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span><span class="p">,</span>
						       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iosize</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iosize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pcl816: RTC code missing&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="p">}</span>

<span class="nl">no_rtc:</span>
<span class="cp">#endif</span>
	<span class="cm">/* grab our DMA */</span>
	<span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_free</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_dma</span><span class="p">;</span>	<span class="cm">/* if we haven&#39;t IRQ, we can&#39;t use DMA */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">DMAbits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* board support DMA */</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_dma</span><span class="p">;</span>	<span class="cm">/* DMA disabled */</span>

		<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">DMAbits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, DMA is out of allowed range, FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* Bad DMA */</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;pcl816&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;, unable to allocate DMA %u, FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* DMA isn&#39;t free */</span>
		<span class="p">}</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;, dma=%u&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">pages</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* we need 16KB */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">__get_dma_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">pages</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, unable to allocate DMA buffer, FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * maybe experiment with try_to_free_pages()</span>
<span class="cm">			 * will help ....</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* no buffer :-( */</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pages</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="cm">/* printk(&quot;%d %d %ld, &quot;,devpriv-&gt;dmapages[0],devpriv-&gt;hwdmasize[0],PAGE_SIZE); */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  we must do duble buff :-( */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">__get_dma_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">pages</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;, unable to allocate DMA buffer, &quot;</span>
				       <span class="s">&quot;FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pages</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">no_dma:</span>

<span class="cm">/*  if (this_board-&gt;n_aochan &gt; 0)</span>
<span class="cm">    subdevs[1] = COMEDI_SUBD_AO;</span>
<span class="cm">  if (this_board-&gt;n_dichan &gt; 0)</span>
<span class="cm">    subdevs[2] = COMEDI_SUBD_DI;</span>
<span class="cm">  if (this_board-&gt;n_dochan &gt; 0)</span>
<span class="cm">    subdevs[3] = COMEDI_SUBD_DO;</span>
<span class="cm">*/</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">sub_ai</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
		<span class="cm">/* printk (&quot;, %dchans DIFF DAC - %d&quot;, s-&gt;n_chan, i); */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_maxdata</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_range_type</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">pcl816_ai_cancel</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">pcl816_ai_cmdtest</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">pcl816_ai_cmd</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">pcl816_ai_poll</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pcl816_ai_insn_read</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">case COMEDI_SUBD_AO:</span>
<span class="c">	s-&gt;subdev_flags = SDF_WRITABLE | SDF_GROUND;</span>
<span class="c">	s-&gt;n_chan = this_board-&gt;n_aochan;</span>
<span class="c">	s-&gt;maxdata = this_board-&gt;ao_maxdata;</span>
<span class="c">	s-&gt;len_chanlist = this_board-&gt;ao_chanlist;</span>
<span class="c">	s-&gt;range_table = this_board-&gt;ao_range_type;</span>
<span class="c">	break;</span>

<span class="c">case COMEDI_SUBD_DI:</span>
<span class="c">	s-&gt;subdev_flags = SDF_READABLE;</span>
<span class="c">	s-&gt;n_chan = this_board-&gt;n_dichan;</span>
<span class="c">	s-&gt;maxdata = 1;</span>
<span class="c">	s-&gt;len_chanlist = this_board-&gt;n_dichan;</span>
<span class="c">	s-&gt;range_table = &amp;range_digital;</span>
<span class="c">	break;</span>

<span class="c">case COMEDI_SUBD_DO:</span>
<span class="c">	s-&gt;subdev_flags = SDF_WRITABLE;</span>
<span class="c">	s-&gt;n_chan = this_board-&gt;n_dochan;</span>
<span class="c">	s-&gt;maxdata = 1;</span>
<span class="c">	s-&gt;len_chanlist = this_board-&gt;n_dochan;</span>
<span class="c">	s-&gt;range_table = &amp;range_digital;</span>
<span class="c">	break;</span>
<span class="cp">#endif</span>

	<span class="n">pcl816_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl816_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcl816_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">sub_ai</span><span class="p">);</span>
		<span class="n">pcl816_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">free_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">free_pages</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">free_pages</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#ifdef unused</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">RTC_lock</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span><span class="p">)</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span><span class="p">,</span>
					       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iosize</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">io_range</span><span class="p">);</span>
<span class="cp">#ifdef unused</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span><span class="p">)</span>
		<span class="n">RTC_lock</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcl816_board</span> <span class="n">boardtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;pcl816&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl816</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">range_pcl816</span><span class="p">,</span> <span class="n">PCLx1x_RANGE</span><span class="p">,</span>
	 <span class="mh">0x00fc</span><span class="p">,</span>		<span class="cm">/*  IRQ mask */</span>
	 <span class="mh">0x0a</span><span class="p">,</span>			<span class="cm">/*  DMA mask */</span>
	 <span class="mh">0xffff</span><span class="p">,</span>		<span class="cm">/*  16-bit card */</span>
	 <span class="mh">0xffff</span><span class="p">,</span>		<span class="cm">/*  D/A maxdata */</span>
	 <span class="mi">1024</span><span class="p">,</span>
	 <span class="mi">1</span><span class="p">,</span>			<span class="cm">/*  ao chan list */</span>
	 <span class="mi">100</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcl814b&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl816</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">range_pcl816</span><span class="p">,</span> <span class="n">PCLx1x_RANGE</span><span class="p">,</span>
	 <span class="mh">0x00fc</span><span class="p">,</span>
	 <span class="mh">0x0a</span><span class="p">,</span>
	 <span class="mh">0x3fff</span><span class="p">,</span>		<span class="cm">/* 14 bit card */</span>
	 <span class="mh">0x3fff</span><span class="p">,</span>
	 <span class="mi">1024</span><span class="p">,</span>
	 <span class="mi">1</span><span class="p">,</span>
	 <span class="mi">100</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">pcl816_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;pcl816&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">pcl816_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">pcl816_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">board_name</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">boardtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_names</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">boardtypes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcl816_board</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_driver</span><span class="p">(</span><span class="n">pcl816_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
