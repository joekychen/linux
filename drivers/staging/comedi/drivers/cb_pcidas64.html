<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › cb_pcidas64.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cb_pcidas64.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/drivers/cb_pcidas64.c</span>
<span class="cm">    This is a driver for the ComputerBoards/MeasurementComputing PCI-DAS</span>
<span class="cm">    64xx, 60xx, and 4020 cards.</span>

<span class="cm">    Author:  Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;</span>
<span class="cm">    Copyright (C) 2001, 2002 Frank Mori Hess</span>

<span class="cm">    Thanks also go to the following people:</span>

<span class="cm">    Steve Rosenbluth, for providing the source code for</span>
<span class="cm">    his pci-das6402 driver, and source code for working QNX pci-6402</span>
<span class="cm">    drivers by Greg Laird and Mariusz Bogacz.  None of the code was</span>
<span class="cm">    used directly here, but it was useful as an additional source of</span>
<span class="cm">    documentation on how to program the boards.</span>

<span class="cm">    John Sims, for much testing and feedback on pcidas-4020 support.</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 1997-8 David A. Schleef &lt;ds@schleef.org&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">************************************************************************/</span>

<span class="cm">/*</span>

<span class="cm">Driver: cb_pcidas64</span>
<span class="cm">Description: MeasurementComputing PCI-DAS64xx, 60XX, and 4020 series with the PLX 9080 PCI controller</span>
<span class="cm">Author: Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;</span>
<span class="cm">Status: works</span>
<span class="cm">Updated: 2002-10-09</span>
<span class="cm">Devices: [Measurement Computing] PCI-DAS6402/16 (cb_pcidas64),</span>
<span class="cm">  PCI-DAS6402/12, PCI-DAS64/M1/16, PCI-DAS64/M2/16,</span>
<span class="cm">  PCI-DAS64/M3/16, PCI-DAS6402/16/JR, PCI-DAS64/M1/16/JR,</span>
<span class="cm">  PCI-DAS64/M2/16/JR, PCI-DAS64/M3/16/JR, PCI-DAS64/M1/14,</span>
<span class="cm">  PCI-DAS64/M2/14, PCI-DAS64/M3/14, PCI-DAS6013, PCI-DAS6014,</span>
<span class="cm">  PCI-DAS6023, PCI-DAS6025, PCI-DAS6030,</span>
<span class="cm">  PCI-DAS6031, PCI-DAS6032, PCI-DAS6033, PCI-DAS6034,</span>
<span class="cm">  PCI-DAS6035, PCI-DAS6036, PCI-DAS6040, PCI-DAS6052,</span>
<span class="cm">  PCI-DAS6070, PCI-DAS6071, PCI-DAS4020/12</span>

<span class="cm">Configuration options:</span>
<span class="cm">   [0] - PCI bus of device (optional)</span>
<span class="cm">   [1] - PCI slot of device (optional)</span>

<span class="cm">These boards may be autocalibrated with the comedi_calibrate utility.</span>

<span class="cm">To select the bnc trigger input on the 4020 (instead of the dio input),</span>
<span class="cm">specify a nonzero channel in the chanspec.  If you wish to use an external</span>
<span class="cm">master clock on the 4020, you may do so by setting the scan_begin_src</span>
<span class="cm">to TRIG_OTHER, and using an INSN_CONFIG_TIMER_1 configuration insn</span>
<span class="cm">to configure the divisor to use for the external clock.</span>

<span class="cm">Some devices are not identified because the PCI device IDs are not yet</span>
<span class="cm">known. If you have such a board, please file a bug report at</span>
<span class="cm">https://bugs.comedi.org.</span>

<span class="cm">*/</span>

<span class="cm">/*</span>

<span class="cm">TODO:</span>
<span class="cm">	make it return error if user attempts an ai command that uses the</span>
<span class="cm">		external queue, and an ao command simultaneously</span>
<span class="cm">	user counter subdevice</span>
<span class="cm">	there are a number of boards this driver will support when they are</span>
<span class="cm">		fully released, but does not yet since the pci device id numbers</span>
<span class="cm">		are not yet available.</span>
<span class="cm">	support prescaled 100khz clock for slow pacing (not available on 6000 series?)</span>
<span class="cm">	make ao fifo size adjustable like ai fifo</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;comedi_pci.h&quot;</span>
<span class="cp">#include &quot;8253.h&quot;</span>
<span class="cp">#include &quot;8255.h&quot;</span>
<span class="cp">#include &quot;plx9080.h&quot;</span>
<span class="cp">#include &quot;comedi_fc.h&quot;</span>

<span class="cp">#undef PCIDAS64_DEBUG		</span><span class="cm">/*  disable debugging code */</span><span class="cp"></span>
<span class="cm">/* #define PCIDAS64_DEBUG         enable debugging code */</span>

<span class="cp">#ifdef PCIDAS64_DEBUG</span>
<span class="cp">#define DEBUG_PRINT(format, args...)  printk(format , ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define DEBUG_PRINT(format, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#define TIMER_BASE 25		</span><span class="cm">/*  40MHz master clock */</span><span class="cp"></span>
<span class="cp">#define PRESCALED_TIMER_BASE	10000	</span><span class="cm">/*  100kHz &#39;prescaled&#39; clock for slow acquisition, maybe I&#39;ll support this someday */</span><span class="cp"></span>
<span class="cp">#define DMA_BUFFER_SIZE 0x1000</span>

<span class="cp">#define PCI_VENDOR_ID_COMPUTERBOARDS	0x1307</span>

<span class="cm">/* maximum value that can be loaded into board&#39;s 24-bit counters*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">max_counter_value</span> <span class="o">=</span> <span class="mh">0xffffff</span><span class="p">;</span>

<span class="cm">/* PCI-DAS64xxx base addresses */</span>

<span class="cm">/* indices of base address regions */</span>
<span class="k">enum</span> <span class="n">base_address_regions</span> <span class="p">{</span>
	<span class="n">PLX9080_BADDRINDEX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MAIN_BADDRINDEX</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">DIO_COUNTER_BADDRINDEX</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* priv(dev)-&gt;main_iobase registers */</span>
<span class="k">enum</span> <span class="n">write_only_registers</span> <span class="p">{</span>
	<span class="n">INTR_ENABLE_REG</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="cm">/*  interrupt enable register */</span>
	<span class="n">HW_CONFIG_REG</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>	<span class="cm">/*  hardware config register */</span>
	<span class="n">DAQ_SYNC_REG</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
	<span class="n">DAQ_ATRIG_LOW_4020_REG</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
	<span class="n">ADC_CONTROL0_REG</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>	<span class="cm">/*  adc control register 0 */</span>
	<span class="n">ADC_CONTROL1_REG</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>	<span class="cm">/*  adc control register 1 */</span>
	<span class="n">CALIBRATION_REG</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="n">ADC_SAMPLE_INTERVAL_LOWER_REG</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">,</span>	<span class="cm">/*  lower 16 bits of adc sample interval counter */</span>
	<span class="n">ADC_SAMPLE_INTERVAL_UPPER_REG</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>	<span class="cm">/*  upper 8 bits of adc sample interval counter */</span>
	<span class="n">ADC_DELAY_INTERVAL_LOWER_REG</span> <span class="o">=</span> <span class="mh">0x1a</span><span class="p">,</span>	<span class="cm">/*  lower 16 bits of delay interval counter */</span>
	<span class="n">ADC_DELAY_INTERVAL_UPPER_REG</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>	<span class="cm">/*  upper 8 bits of delay interval counter */</span>
	<span class="n">ADC_COUNT_LOWER_REG</span> <span class="o">=</span> <span class="mh">0x1e</span><span class="p">,</span>	<span class="cm">/*  lower 16 bits of hardware conversion/scan counter */</span>
	<span class="n">ADC_COUNT_UPPER_REG</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>	<span class="cm">/*  upper 8 bits of hardware conversion/scan counter */</span>
	<span class="n">ADC_START_REG</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>	<span class="cm">/*  software trigger to start acquisition */</span>
	<span class="n">ADC_CONVERT_REG</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>	<span class="cm">/*  initiates single conversion */</span>
	<span class="n">ADC_QUEUE_CLEAR_REG</span> <span class="o">=</span> <span class="mh">0x26</span><span class="p">,</span>	<span class="cm">/*  clears adc queue */</span>
	<span class="n">ADC_QUEUE_LOAD_REG</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>	<span class="cm">/*  loads adc queue */</span>
	<span class="n">ADC_BUFFER_CLEAR_REG</span> <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
	<span class="n">ADC_QUEUE_HIGH_REG</span> <span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>	<span class="cm">/*  high channel for internal queue, use adc_chan_bits() inline above */</span>
	<span class="n">DAC_CONTROL0_REG</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>	<span class="cm">/*  dac control register 0 */</span>
	<span class="n">DAC_CONTROL1_REG</span> <span class="o">=</span> <span class="mh">0x52</span><span class="p">,</span>	<span class="cm">/*  dac control register 0 */</span>
	<span class="n">DAC_SAMPLE_INTERVAL_LOWER_REG</span> <span class="o">=</span> <span class="mh">0x54</span><span class="p">,</span>	<span class="cm">/*  lower 16 bits of dac sample interval counter */</span>
	<span class="n">DAC_SAMPLE_INTERVAL_UPPER_REG</span> <span class="o">=</span> <span class="mh">0x56</span><span class="p">,</span>	<span class="cm">/*  upper 8 bits of dac sample interval counter */</span>
	<span class="n">DAC_SELECT_REG</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="n">DAC_START_REG</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">,</span>
	<span class="n">DAC_BUFFER_CLEAR_REG</span> <span class="o">=</span> <span class="mh">0x66</span><span class="p">,</span>	<span class="cm">/*  clear dac buffer */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dac_convert_reg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mh">0x70</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dac_lsb_4020_reg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mh">0x70</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dac_msb_4020_reg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mh">0x72</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">read_only_registers</span> <span class="p">{</span>
	<span class="n">HW_STATUS_REG</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="cm">/*  hardware status register, reading this apparently clears pending interrupts as well */</span>
	<span class="n">PIPE1_READ_REG</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">ADC_READ_PNTR_REG</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="n">LOWER_XFER_REG</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">ADC_WRITE_PNTR_REG</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
	<span class="n">PREPOST_REG</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">read_write_registers</span> <span class="p">{</span>
	<span class="n">I8255_4020_REG</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>	<span class="cm">/*  8255 offset, for 4020 only */</span>
	<span class="n">ADC_QUEUE_FIFO_REG</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>	<span class="cm">/*  external channel/gain queue, uses same bits as ADC_QUEUE_LOAD_REG */</span>
	<span class="n">ADC_FIFO_REG</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>	<span class="cm">/* adc data fifo */</span>
	<span class="n">DAC_FIFO_REG</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">,</span>	<span class="cm">/* dac data fifo, has weird interactions with external channel queue */</span>
<span class="p">};</span>

<span class="cm">/* priv(dev)-&gt;dio_counter_iobase registers */</span>
<span class="k">enum</span> <span class="n">dio_counter_registers</span> <span class="p">{</span>
	<span class="n">DIO_8255_OFFSET</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="n">DO_REG</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">DI_REG</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>
	<span class="n">DIO_DIRECTION_60XX_REG</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">DIO_DATA_60XX_REG</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* bit definitions for write-only registers */</span>

<span class="k">enum</span> <span class="n">intr_enable_contents</span> <span class="p">{</span>
	<span class="n">ADC_INTR_SRC_MASK</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>	<span class="cm">/*  bits that set adc interrupt source */</span>
	<span class="n">ADC_INTR_QFULL_BITS</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="cm">/*  interrupt fifo quater full */</span>
	<span class="n">ADC_INTR_EOC_BITS</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>	<span class="cm">/*  interrupt end of conversion */</span>
	<span class="n">ADC_INTR_EOSCAN_BITS</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>	<span class="cm">/*  interrupt end of scan */</span>
	<span class="n">ADC_INTR_EOSEQ_BITS</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>	<span class="cm">/*  interrupt end of sequence (probably wont use this it&#39;s pretty fancy) */</span>
	<span class="n">EN_ADC_INTR_SRC_BIT</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>	<span class="cm">/*  enable adc interrupt source */</span>
	<span class="n">EN_ADC_DONE_INTR_BIT</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>	<span class="cm">/*  enable adc acquisition done interrupt */</span>
	<span class="n">DAC_INTR_SRC_MASK</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">DAC_INTR_QEMPTY_BITS</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="n">DAC_INTR_HIGH_CHAN_BITS</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">EN_DAC_INTR_SRC_BIT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/*  enable dac interrupt source */</span>
	<span class="n">EN_DAC_DONE_INTR_BIT</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">EN_ADC_ACTIVE_INTR_BIT</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>	<span class="cm">/*  enable adc active interrupt */</span>
	<span class="n">EN_ADC_STOP_INTR_BIT</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>	<span class="cm">/*  enable adc stop trigger interrupt */</span>
	<span class="n">EN_DAC_ACTIVE_INTR_BIT</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>	<span class="cm">/*  enable dac active interrupt */</span>
	<span class="n">EN_DAC_UNDERRUN_BIT</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>	<span class="cm">/*  enable dac underrun status bit */</span>
	<span class="n">EN_ADC_OVERRUN_BIT</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>	<span class="cm">/*  enable adc overrun status bit */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">hw_config_contents</span> <span class="p">{</span>
	<span class="n">MASTER_CLOCK_4020_MASK</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>	<span class="cm">/*  bits that specify master clock source for 4020 */</span>
	<span class="n">INTERNAL_CLOCK_4020_BITS</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>	<span class="cm">/*  use 40 MHz internal master clock for 4020 */</span>
	<span class="n">BNC_CLOCK_4020_BITS</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>	<span class="cm">/*  use BNC input for master clock */</span>
	<span class="n">EXT_CLOCK_4020_BITS</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>	<span class="cm">/*  use dio input for master clock */</span>
	<span class="n">EXT_QUEUE_BIT</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>	<span class="cm">/*  use external channel/gain queue (more versatile than internal queue) */</span>
	<span class="n">SLOW_DAC_BIT</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>	<span class="cm">/*  use 225 nanosec strobe when loading dac instead of 50 nanosec */</span>
	<span class="n">HW_CONFIG_DUMMY_BITS</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>	<span class="cm">/*  bit with unknown function yet given as default value in pci-das64 manual */</span>
	<span class="n">DMA_CH_SELECT_BIT</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>	<span class="cm">/*  bit selects channels 1/0 for analog input/output, otherwise 0/1 */</span>
	<span class="n">FIFO_SIZE_REG</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>	<span class="cm">/*  allows adjustment of fifo sizes */</span>
	<span class="n">DAC_FIFO_SIZE_MASK</span> <span class="o">=</span> <span class="mh">0xff00</span><span class="p">,</span>	<span class="cm">/*  bits that set dac fifo size */</span>
	<span class="n">DAC_FIFO_BITS</span> <span class="o">=</span> <span class="mh">0xf800</span><span class="p">,</span>	<span class="cm">/* 8k sample ao fifo */</span>
<span class="p">};</span>
<span class="cp">#define DAC_FIFO_SIZE 0x2000</span>

<span class="k">enum</span> <span class="n">daq_atrig_low_4020_contents</span> <span class="p">{</span>
	<span class="n">EXT_AGATE_BNC_BIT</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>	<span class="cm">/*  use trig/ext clk bnc input for analog gate signal */</span>
	<span class="n">EXT_STOP_TRIG_BNC_BIT</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>	<span class="cm">/*  use trig/ext clk bnc input for external stop trigger signal */</span>
	<span class="n">EXT_START_TRIG_BNC_BIT</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>	<span class="cm">/*  use trig/ext clk bnc input for external start trigger signal */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span> <span class="nf">analog_trig_low_threshold_bits</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">threshold</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">adc_control0_contents</span> <span class="p">{</span>
	<span class="n">ADC_GATE_SRC_MASK</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>	<span class="cm">/*  bits that select gate */</span>
	<span class="n">ADC_SOFT_GATE_BITS</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>	<span class="cm">/*  software gate */</span>
	<span class="n">ADC_EXT_GATE_BITS</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>	<span class="cm">/*  external digital gate */</span>
	<span class="n">ADC_ANALOG_GATE_BITS</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>	<span class="cm">/*  analog level gate */</span>
	<span class="n">ADC_GATE_LEVEL_BIT</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>	<span class="cm">/*  level-sensitive gate (for digital) */</span>
	<span class="n">ADC_GATE_POLARITY_BIT</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>	<span class="cm">/*  gate active low */</span>
	<span class="n">ADC_START_TRIG_SOFT_BITS</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">ADC_START_TRIG_EXT_BITS</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">ADC_START_TRIG_ANALOG_BITS</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">ADC_START_TRIG_MASK</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">ADC_START_TRIG_FALLING_BIT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/*  trig 1 uses falling edge */</span>
	<span class="n">ADC_EXT_CONV_FALLING_BIT</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>	<span class="cm">/*  external pacing uses falling edge */</span>
	<span class="n">ADC_SAMPLE_COUNTER_EN_BIT</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>	<span class="cm">/*  enable hardware scan counter */</span>
	<span class="n">ADC_DMA_DISABLE_BIT</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>	<span class="cm">/*  disables dma */</span>
	<span class="n">ADC_ENABLE_BIT</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>	<span class="cm">/*  master adc enable */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">adc_control1_contents</span> <span class="p">{</span>
	<span class="n">ADC_QUEUE_CONFIG_BIT</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>	<span class="cm">/*  should be set for boards with &gt; 16 channels */</span>
	<span class="n">CONVERT_POLARITY_BIT</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">EOC_POLARITY_BIT</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">ADC_SW_GATE_BIT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/*  software gate of adc */</span>
	<span class="n">ADC_DITHER_BIT</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>	<span class="cm">/*  turn on extra noise for dithering */</span>
	<span class="n">RETRIGGER_BIT</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>
	<span class="n">ADC_LO_CHANNEL_4020_MASK</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">,</span>
	<span class="n">ADC_HI_CHANNEL_4020_MASK</span> <span class="o">=</span> <span class="mh">0xc00</span><span class="p">,</span>
	<span class="n">TWO_CHANNEL_4020_BITS</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>	<span class="cm">/*  two channel mode for 4020 */</span>
	<span class="n">FOUR_CHANNEL_4020_BITS</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>	<span class="cm">/*  four channel mode for 4020 */</span>
	<span class="n">CHANNEL_MODE_4020_MASK</span> <span class="o">=</span> <span class="mh">0x3000</span><span class="p">,</span>
	<span class="n">ADC_MODE_MASK</span> <span class="o">=</span> <span class="mh">0xf000</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span> <span class="nf">adc_lo_chan_4020_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span> <span class="nf">adc_hi_chan_4020_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span> <span class="nf">adc_mode_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">calibration_contents</span> <span class="p">{</span>
	<span class="n">SELECT_8800_BIT</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">SELECT_8402_64XX_BIT</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">SELECT_1590_60XX_BIT</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">CAL_EN_64XX_BIT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/*  calibration enable for 64xx series */</span>
	<span class="n">SERIAL_DATA_IN_BIT</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">SERIAL_CLOCK_BIT</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="n">CAL_EN_60XX_BIT</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>	<span class="cm">/*  calibration enable for 60xx series */</span>
	<span class="n">CAL_GAIN_BIT</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>
<span class="p">};</span>
<span class="cm">/* calibration sources for 6025 are:</span>
<span class="cm"> *  0 : ground</span>
<span class="cm"> *  1 : 10V</span>
<span class="cm"> *  2 : 5V</span>
<span class="cm"> *  3 : 0.5V</span>
<span class="cm"> *  4 : 0.05V</span>
<span class="cm"> *  5 : ground</span>
<span class="cm"> *  6 : dac channel 0</span>
<span class="cm"> *  7 : dac channel 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span> <span class="nf">adc_src_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">source</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span> <span class="nf">adc_convert_chan_4020_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">adc_queue_load_contents</span> <span class="p">{</span>
	<span class="n">UNIP_BIT</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>	<span class="cm">/*  unipolar/bipolar bit */</span>
	<span class="n">ADC_SE_DIFF_BIT</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>	<span class="cm">/*  single-ended/ differential bit */</span>
	<span class="n">ADC_COMMON_BIT</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>	<span class="cm">/*  non-referenced single-ended (common-mode input) */</span>
	<span class="n">QUEUE_EOSEQ_BIT</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>	<span class="cm">/*  queue end of sequence */</span>
	<span class="n">QUEUE_EOSCAN_BIT</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>	<span class="cm">/*  queue end of scan */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span> <span class="nf">adc_chan_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dac_control0_contents</span> <span class="p">{</span>
	<span class="n">DAC_ENABLE_BIT</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>	<span class="cm">/*  dac controller enable bit */</span>
	<span class="n">DAC_CYCLIC_STOP_BIT</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">DAC_WAVEFORM_MODE_BIT</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="n">DAC_EXT_UPDATE_FALLING_BIT</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">DAC_EXT_UPDATE_ENABLE_BIT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">WAVEFORM_TRIG_MASK</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">WAVEFORM_TRIG_DISABLED_BITS</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="n">WAVEFORM_TRIG_SOFT_BITS</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">WAVEFORM_TRIG_EXT_BITS</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">WAVEFORM_TRIG_ADC1_BITS</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">WAVEFORM_TRIG_FALLING_BIT</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="n">WAVEFORM_GATE_LEVEL_BIT</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">WAVEFORM_GATE_ENABLE_BIT</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">WAVEFORM_GATE_SELECT_BIT</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dac_control1_contents</span> <span class="p">{</span>
	<span class="n">DAC_WRITE_POLARITY_BIT</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>	<span class="cm">/* board-dependent setting */</span>
	<span class="n">DAC1_EXT_REF_BIT</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>
	<span class="n">DAC0_EXT_REF_BIT</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="n">DAC_OUTPUT_ENABLE_BIT</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>	<span class="cm">/*  dac output enable bit */</span>
	<span class="n">DAC_UPDATE_POLARITY_BIT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/* board-dependent setting */</span>
	<span class="n">DAC_SW_GATE_BIT</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">DAC1_UNIPOLAR_BIT</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="n">DAC0_UNIPOLAR_BIT</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* bit definitions for read-only registers */</span>
<span class="k">enum</span> <span class="n">hw_status_contents</span> <span class="p">{</span>
	<span class="n">DAC_UNDERRUN_BIT</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">ADC_OVERRUN_BIT</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">DAC_ACTIVE_BIT</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">ADC_ACTIVE_BIT</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="n">DAC_INTR_PENDING_BIT</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">ADC_INTR_PENDING_BIT</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">DAC_DONE_BIT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">ADC_DONE_BIT</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">EXT_INTR_PENDING_BIT</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="n">ADC_STOP_BIT</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span> <span class="nf">pipe_full_bits</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">hw_status_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hw_status_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dma_chain_flag_bits</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">prepost_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">prepost_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">adc_upper_read_ptr_code</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">prepost_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">prepost_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">adc_upper_write_ptr_code</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">prepost_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">prepost_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* I2C addresses for 4020 */</span>
<span class="k">enum</span> <span class="n">i2c_addresses</span> <span class="p">{</span>
	<span class="n">RANGE_CAL_I2C_ADDR</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">CALDAC0_I2C_ADDR</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
	<span class="n">CALDAC1_I2C_ADDR</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">range_cal_i2c_contents</span> <span class="p">{</span>
	<span class="n">ADC_SRC_4020_MASK</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">,</span>	<span class="cm">/*  bits that set what source the adc converter measures */</span>
	<span class="n">BNC_TRIG_THRESHOLD_0V_BIT</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>	<span class="cm">/*  make bnc trig/ext clock threshold 0V instead of 2.5V */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint8_t</span> <span class="nf">adc_src_4020_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ADC_SRC_4020_MASK</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint8_t</span> <span class="nf">attenuate_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  attenuate channel (+-5V input range) */</span>
	<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* analog input ranges for 64xx boards */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">ai_ranges_64xx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">)</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* analog input ranges for 60xx boards */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">ai_ranges_60xx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">4</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* analog input ranges for 6030, etc boards */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">ai_ranges_6030</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">14</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* analog input ranges for 6052, etc boards */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">ai_ranges_6052</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">15</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.25</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* analog input ranges for 4020 board */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">ai_ranges_4020</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* analog output ranges */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">ao_ranges_64xx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">4</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ao_range_code_64xx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x1</span><span class="p">,</span>
	<span class="mh">0x2</span><span class="p">,</span>
	<span class="mh">0x3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">ao_ranges_60xx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ao_range_code_60xx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">ao_ranges_6030</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ao_range_code_6030</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">ao_ranges_4020</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ao_range_code_4020</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x1</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">register_layout</span> <span class="p">{</span>
	<span class="n">LAYOUT_60XX</span><span class="p">,</span>
	<span class="n">LAYOUT_64XX</span><span class="p">,</span>
	<span class="n">LAYOUT_4020</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hw_fifo_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_segments</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_segment_length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sample_packing_ratio</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">fifo_size_reg_mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pcidas64_board</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">device_id</span><span class="p">;</span>		<span class="cm">/*  pci device id */</span>
	<span class="kt">int</span> <span class="n">ai_se_chans</span><span class="p">;</span>	<span class="cm">/*  number of ai inputs in single-ended mode */</span>
	<span class="kt">int</span> <span class="n">ai_bits</span><span class="p">;</span>		<span class="cm">/*  analog input resolution */</span>
	<span class="kt">int</span> <span class="n">ai_speed</span><span class="p">;</span>		<span class="cm">/*  fastest conversion period in ns */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">ai_range_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ao_nchan</span><span class="p">;</span>		<span class="cm">/*  number of analog out channels */</span>
	<span class="kt">int</span> <span class="n">ao_bits</span><span class="p">;</span>		<span class="cm">/*  analog output resolution */</span>
	<span class="kt">int</span> <span class="n">ao_scan_speed</span><span class="p">;</span>	<span class="cm">/*  analog output speed (for a scan, not conversion) */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">ao_range_table</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ao_range_code</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hw_fifo_info</span> <span class="o">*</span><span class="k">const</span> <span class="n">ai_fifo</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">register_layout</span> <span class="n">layout</span><span class="p">;</span>	<span class="cm">/*  different board families have slightly different registers */</span>
	<span class="kt">unsigned</span> <span class="n">has_8255</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hw_fifo_info</span> <span class="n">ai_fifo_4020</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_segments</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_segment_length</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sample_packing_ratio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size_reg_mask</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hw_fifo_info</span> <span class="n">ai_fifo_64xx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_segments</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_segment_length</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sample_packing_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size_reg_mask</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hw_fifo_info</span> <span class="n">ai_fifo_60xx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_segments</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_segment_length</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sample_packing_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size_reg_mask</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* maximum number of dma transfers we will chain together into a ring</span>
<span class="cm"> * (and the maximum number of dma buffers we maintain) */</span>
<span class="cp">#define MAX_AI_DMA_RING_COUNT (0x80000 / DMA_BUFFER_SIZE)</span>
<span class="cp">#define MIN_AI_DMA_RING_COUNT (0x10000 / DMA_BUFFER_SIZE)</span>
<span class="cp">#define AO_DMA_RING_COUNT (0x10000 / DMA_BUFFER_SIZE)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ai_dma_ring_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcidas64_board</span> <span class="o">*</span><span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MAX_AI_DMA_RING_COUNT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">MIN_AI_DMA_RING_COUNT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bytes_in_sample</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcidas64_board</span> <span class="n">pcidas64_boards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6402/16&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x1d</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_64XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6402/12&quot;</span><span class="p">,</span>	<span class="cm">/*  XXX check */</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x1e</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_64XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das64/m1/16&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x35</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_64XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das64/m2/16&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x36</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_64XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das64/m3/16&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">333</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_64XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_64xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6013&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x78</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6014&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x79</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6023&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x5d</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6025&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x5e</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6030&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x5f</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6031&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6032&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6033&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x62</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6034&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x63</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6035&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6036&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x6f</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6040&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x65</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_6052</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6052&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x66</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">3333</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">3333</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_6052</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6070&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x67</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_6052</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das6071&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_60XX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_6052</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_6030</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_60xx</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-das4020/12&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x52</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/*  no hardware pacing on ao */</span>
	 <span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">LAYOUT_4020</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_ranges_4020</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ao_ranges_4020</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_code</span> <span class="o">=</span> <span class="n">ao_range_code_4020</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai_fifo_4020</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;pci-das6402/16/jr&quot;,</span>
<span class="c">	 .device_id = 0		/*  XXX, */</span>
<span class="c">	 .ai_se_chans = 64,</span>
<span class="c">	 .ai_bits = 16,</span>
<span class="c">	 .ai_speed = 5000,</span>
<span class="c">	 .ao_nchan = 0,</span>
<span class="c">	 .ao_scan_speed = 10000,</span>
<span class="c">	 .layout = LAYOUT_64XX,</span>
<span class="c">	 .ai_range_table = &amp;ai_ranges_64xx,</span>
<span class="c">	 .ai_fifo = ai_fifo_64xx,</span>
<span class="c">	 .has_8255 = 1,</span>
<span class="c">	 },</span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;pci-das64/m1/16/jr&quot;,</span>
<span class="c">	 .device_id = 0		/*  XXX, */</span>
<span class="c">	 .ai_se_chans = 64,</span>
<span class="c">	 .ai_bits = 16,</span>
<span class="c">	 .ai_speed = 1000,</span>
<span class="c">	 .ao_nchan = 0,</span>
<span class="c">	 .ao_scan_speed = 10000,</span>
<span class="c">	 .layout = LAYOUT_64XX,</span>
<span class="c">	 .ai_range_table = &amp;ai_ranges_64xx,</span>
<span class="c">	 .ai_fifo = ai_fifo_64xx,</span>
<span class="c">	 .has_8255 = 1,</span>
<span class="c">	 },</span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;pci-das64/m2/16/jr&quot;,</span>
<span class="c">	 .device_id = 0		/*  XXX, */</span>
<span class="c">	 .ai_se_chans = 64,</span>
<span class="c">	 .ai_bits = 16,</span>
<span class="c">	 .ai_speed = 500,</span>
<span class="c">	 .ao_nchan = 0,</span>
<span class="c">	 .ao_scan_speed = 10000,</span>
<span class="c">	 .layout = LAYOUT_64XX,</span>
<span class="c">	 .ai_range_table = &amp;ai_ranges_64xx,</span>
<span class="c">	 .ai_fifo = ai_fifo_64xx,</span>
<span class="c">	 .has_8255 = 1,</span>
<span class="c">	 },</span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;pci-das64/m3/16/jr&quot;,</span>
<span class="c">	 .device_id = 0		/*  XXX, */</span>
<span class="c">	 .ai_se_chans = 64,</span>
<span class="c">	 .ai_bits = 16,</span>
<span class="c">	 .ai_speed = 333,</span>
<span class="c">	 .ao_nchan = 0,</span>
<span class="c">	 .ao_scan_speed = 10000,</span>
<span class="c">	 .layout = LAYOUT_64XX,</span>
<span class="c">	 .ai_range_table = &amp;ai_ranges_64xx,</span>
<span class="c">	 .ai_fifo = ai_fifo_64xx,</span>
<span class="c">	 .has_8255 = 1,</span>
<span class="c">	 },</span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;pci-das64/m1/14&quot;,</span>
<span class="c">	 .device_id = 0,	/*  XXX */</span>
<span class="c">	 .ai_se_chans = 64,</span>
<span class="c">	 .ai_bits = 14,</span>
<span class="c">	 .ai_speed = 1000,</span>
<span class="c">	 .ao_nchan = 2,</span>
<span class="c">	 .ao_scan_speed = 10000,</span>
<span class="c">	 .layout = LAYOUT_64XX,</span>
<span class="c">	 .ai_range_table = &amp;ai_ranges_64xx,</span>
<span class="c">	 .ai_fifo = ai_fifo_64xx,</span>
<span class="c">	 .has_8255 = 1,</span>
<span class="c">	 },</span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;pci-das64/m2/14&quot;,</span>
<span class="c">	 .device_id = 0,	/*  XXX */</span>
<span class="c">	 .ai_se_chans = 64,</span>
<span class="c">	 .ai_bits = 14,</span>
<span class="c">	 .ai_speed = 500,</span>
<span class="c">	 .ao_nchan = 2,</span>
<span class="c">	 .ao_scan_speed = 10000,</span>
<span class="c">	 .layout = LAYOUT_64XX,</span>
<span class="c">	 .ai_range_table = &amp;ai_ranges_64xx,</span>
<span class="c">	 .ai_fifo = ai_fifo_64xx,</span>
<span class="c">	 .has_8255 = 1,</span>
<span class="c">	 },</span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;pci-das64/m3/14&quot;,</span>
<span class="c">	 .device_id = 0,	/*  XXX */</span>
<span class="c">	 .ai_se_chans = 64,</span>
<span class="c">	 .ai_bits = 14,</span>
<span class="c">	 .ai_speed = 333,</span>
<span class="c">	 .ao_nchan = 2,</span>
<span class="c">	 .ao_scan_speed = 10000,</span>
<span class="c">	 .layout = LAYOUT_64XX,</span>
<span class="c">	 .ai_range_table = &amp;ai_ranges_64xx,</span>
<span class="c">	 .ai_fifo = ai_fifo_64xx,</span>
<span class="c">	 .has_8255 = 1,</span>
<span class="c">	 },</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pcidas64_board</span> <span class="o">*</span><span class="nf">board</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pcidas64_board</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">se_diff_bit_6xxx</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">use_differential</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_64XX</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">use_differential</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_60XX</span> <span class="o">&amp;&amp;</span> <span class="n">use_differential</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ADC_SE_DIFF_BIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ext_clock_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>	<span class="cm">/*  master clock divisor to use for scans with external master clock */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chanspec</span><span class="p">;</span>	<span class="cm">/*  chanspec for master clock input when used as scan begin src */</span>
<span class="p">};</span>

<span class="cm">/* this structure is for data unique to this hardware driver. */</span>
<span class="k">struct</span> <span class="n">pcidas64_private</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">hw_dev</span><span class="p">;</span>	<span class="cm">/*  pointer to board&#39;s pci_dev struct */</span>
	<span class="cm">/*  base addresses (physical) */</span>
	<span class="n">resource_size_t</span> <span class="n">plx9080_phys_iobase</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">main_phys_iobase</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">dio_counter_phys_iobase</span><span class="p">;</span>
	<span class="cm">/*  base addresses (ioremapped) */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">plx9080_iobase</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">main_iobase</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dio_counter_iobase</span><span class="p">;</span>
	<span class="cm">/*  local address (used by dma controller) */</span>
	<span class="kt">uint32_t</span> <span class="n">local0_iobase</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">local1_iobase</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_count</span><span class="p">;</span>	<span class="cm">/*  number of analog input samples remaining */</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">ai_buffer</span><span class="p">[</span><span class="n">MAX_AI_DMA_RING_COUNT</span><span class="p">];</span>	<span class="cm">/*  dma buffers for analog input */</span>
	<span class="n">dma_addr_t</span> <span class="n">ai_buffer_bus_addr</span><span class="p">[</span><span class="n">MAX_AI_DMA_RING_COUNT</span><span class="p">];</span>	<span class="cm">/*  physical addresses of ai dma buffers */</span>
	<span class="k">struct</span> <span class="n">plx_dma_desc</span> <span class="o">*</span><span class="n">ai_dma_desc</span><span class="p">;</span>	<span class="cm">/*  array of ai dma descriptors read by plx9080, allocated to get proper alignment */</span>
	<span class="n">dma_addr_t</span> <span class="n">ai_dma_desc_bus_addr</span><span class="p">;</span>	<span class="cm">/*  physical address of ai dma descriptor array */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_dma_index</span><span class="p">;</span>	<span class="cm">/*  index of the ai dma descriptor/buffer that is currently being used */</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">ao_buffer</span><span class="p">[</span><span class="n">AO_DMA_RING_COUNT</span><span class="p">];</span>	<span class="cm">/*  dma buffers for analog output */</span>
	<span class="n">dma_addr_t</span> <span class="n">ao_buffer_bus_addr</span><span class="p">[</span><span class="n">AO_DMA_RING_COUNT</span><span class="p">];</span>	<span class="cm">/*  physical addresses of ao dma buffers */</span>
	<span class="k">struct</span> <span class="n">plx_dma_desc</span> <span class="o">*</span><span class="n">ao_dma_desc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ao_dma_desc_bus_addr</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_dma_index</span><span class="p">;</span>	<span class="cm">/*  keeps track of buffer where the next ao sample should go */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ao_count</span><span class="p">;</span>	<span class="cm">/*  number of analog output samples remaining */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_value</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  remember what the analog outputs are set to, to allow readback */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hw_revision</span><span class="p">;</span>	<span class="cm">/*  stc chip hardware revision number */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intr_enable_bits</span><span class="p">;</span>	<span class="cm">/*  last bits sent to INTR_ENABLE_REG register */</span>
	<span class="k">volatile</span> <span class="kt">uint16_t</span> <span class="n">adc_control1_bits</span><span class="p">;</span>	<span class="cm">/*  last bits sent to ADC_CONTROL1_REG register */</span>
	<span class="k">volatile</span> <span class="kt">uint16_t</span> <span class="n">fifo_size_bits</span><span class="p">;</span>	<span class="cm">/*  last bits sent to FIFO_SIZE_REG register */</span>
	<span class="k">volatile</span> <span class="kt">uint16_t</span> <span class="n">hw_config_bits</span><span class="p">;</span>	<span class="cm">/*  last bits sent to HW_CONFIG_REG register */</span>
	<span class="k">volatile</span> <span class="kt">uint16_t</span> <span class="n">dac_control1_bits</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">plx_control_bits</span><span class="p">;</span>	<span class="cm">/*  last bits written to plx9080 control register */</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">plx_intcsr_bits</span><span class="p">;</span>	<span class="cm">/*  last bits written to plx interrupt control and status register */</span>
	<span class="k">volatile</span> <span class="kt">int</span> <span class="n">calibration_source</span><span class="p">;</span>	<span class="cm">/*  index of calibration source readable through ai ch0 */</span>
	<span class="k">volatile</span> <span class="kt">uint8_t</span> <span class="n">i2c_cal_range_bits</span><span class="p">;</span>	<span class="cm">/*  bits written to i2c calibration/range register */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ext_trig_falling</span><span class="p">;</span>	<span class="cm">/*  configure digital triggers to trigger on falling edge */</span>
	<span class="cm">/*  states of various devices stored to enable read-back */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ad8402_state</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caldac_state</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">volatile</span> <span class="kt">short</span> <span class="n">ai_cmd_running</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_fifo_segment_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext_clock_info</span> <span class="n">ext_clock</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">ao_bounce_buffer</span><span class="p">[</span><span class="n">DAC_FIFO_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* inline function that makes it easier to</span>
<span class="cm"> * access the private structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pcidas64_private</span> <span class="o">*</span><span class="nf">priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ai_config_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ao_readback_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ao_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ao_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trig_num</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ao_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">handle_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ao_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dio_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dio_callback_4020</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">di_rbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_wbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dio_60xx_config_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dio_60xx_wbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">calib_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">calib_write_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ad8402_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ad8402_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ad8402_write_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eeprom_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">check_adc_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">get_divisor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">caldac_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">caldac_8800_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span>
			     <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">);</span>
<span class="cm">/* static int dac_1590_write(struct comedi_device *dev, unsigned int dac_a, unsigned int dac_b); */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">caldac_i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caldac_channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">abort_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">disable_plx_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_ai_fifo_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_samples</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_fifo_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_ai_fifo_segment_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">disable_ai_pacing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">disable_ai_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">enable_ai_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">get_ao_divisor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">load_ao_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ai_range_bits_6xxx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">range_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_krange</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_range_table</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">[</span><span class="n">range_index</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">10000000</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5000000</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2000000</span>:
	<span class="k">case</span> <span class="mi">2500000</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1000000</span>:
	<span class="k">case</span> <span class="mi">1250000</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">500000</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">200000</span>:
	<span class="k">case</span> <span class="mi">250000</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x500</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">100000</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x600</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">50000</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x700</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug! in ai_range_bits_6xxx&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">+=</span> <span class="mh">0x900</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hw_revision</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">uint16_t</span> <span class="n">hw_status_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">hw_status_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">hw_status_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_dac_range_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">volatile</span> <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">range</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_range_code</span><span class="p">[</span><span class="n">range</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug! bad channel?&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">)</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug! bad range code?&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">channel</span><span class="p">));</span>
	<span class="o">*</span><span class="n">bits</span> <span class="o">|=</span> <span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">channel</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ao_cmd_is_supported</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pcidas64_board</span> <span class="o">*</span><span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ao_nchan</span> <span class="o">&amp;&amp;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">LAYOUT_4020</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initialize plx9080 chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_plx9080</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">plx_iobase</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span><span class="p">;</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">=</span>
	    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_CONTROL_REG</span><span class="p">);</span>

	<span class="cm">/*  plx9080 dump */</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx interrupt status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_INTRCS_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx id bits 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_ID_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx control reg 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx mode/arbitration reg 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_MARB_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx region0 reg 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_REGION0_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx region1 reg 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_REGION1_REG</span><span class="p">));</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx revision 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_REVISION_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx dma channel 0 mode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_MODE_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx dma channel 1 mode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_MODE_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx dma channel 0 pci address 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_PCI_ADDRESS_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx dma channel 0 local address 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_LOCAL_ADDRESS_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx dma channel 0 transfer size 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_TRANSFER_SIZE_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx dma channel 0 descriptor 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_DESCRIPTOR_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx dma channel 0 command status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_CS_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx dma channel 0 threshold 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_THRESHOLD_REG</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx bigend 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_BIGEND_REG</span><span class="p">));</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">BIGEND_DMA0</span> <span class="o">|</span> <span class="n">BIGEND_DMA1</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_BIGEND_REG</span><span class="p">);</span>

	<span class="n">disable_plx_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">abort_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">abort_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*  configure dma0 mode */</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*  enable ready input, not sure if this is necessary */</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_DMA_EN_READYIN_BIT</span><span class="p">;</span>
	<span class="cm">/*  enable bterm, not sure if this is necessary */</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_EN_BTERM_BIT</span><span class="p">;</span>
	<span class="cm">/*  enable dma chaining */</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_EN_CHAIN_BIT</span><span class="p">;</span>
	<span class="cm">/*  enable interrupt on dma done (probably don&#39;t need this, since chain never finishes) */</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_EN_DMA_DONE_INTR_BIT</span><span class="p">;</span>
	<span class="cm">/*  don&#39;t increment local address during transfers (we are transferring from a fixed fifo register) */</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_LOCAL_ADDR_CONST_BIT</span><span class="p">;</span>
	<span class="cm">/*  route dma interrupt to pci bus */</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_DMA_INTR_PCI_BIT</span><span class="p">;</span>
	<span class="cm">/*  enable demand mode */</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_DEMAND_MODE_BIT</span><span class="p">;</span>
	<span class="cm">/*  enable local burst mode */</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_DMA_LOCAL_BURST_EN_BIT</span><span class="p">;</span>
	<span class="cm">/*  4020 uses 32 bit dma */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_LOCAL_BUS_32_WIDE_BITS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/*  localspace0 bus is 16 bits wide */</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">PLX_LOCAL_BUS_16_WIDE_BITS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_MODE_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ao_cmd_is_supported</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">plx_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_MODE_REG</span><span class="p">);</span>

	<span class="cm">/*  enable interrupts on plx 9080 */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_intcsr_bits</span> <span class="o">|=</span>
	    <span class="n">ICS_AERR</span> <span class="o">|</span> <span class="n">ICS_PERR</span> <span class="o">|</span> <span class="n">ICS_PIE</span> <span class="o">|</span> <span class="n">ICS_PLIE</span> <span class="o">|</span> <span class="n">ICS_PAIE</span> <span class="o">|</span> <span class="n">ICS_LIE</span> <span class="o">|</span>
	    <span class="n">ICS_DMA0_E</span> <span class="o">|</span> <span class="n">ICS_DMA1_E</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_intcsr_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_INTRCS_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Allocate and initialize the subdevice structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_subdevices</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dio_8255_iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* analog input subdevice */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_DITHER</span> <span class="o">|</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_60XX</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_COMMON</span> <span class="o">|</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_64XX</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
	<span class="cm">/* XXX Number of inputs in differential mode is ignored */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_se_chans</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_range_table</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">ai_rinsn</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="n">ai_config_insn</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">ai_cmd</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">ai_cmdtest</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">ai_cancel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">data</span><span class="p">;</span>
		<span class="cm">/*  set adc to read from inputs (not internal calibration sources) */</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">=</span> <span class="n">adc_src_4020_bits</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="cm">/*  set channels to +-5 volt input ranges */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">|=</span> <span class="n">attenuate_bit</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span><span class="p">;</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RANGE_CAL_I2C_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* analog output subdevice */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_nchan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span>
		    <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_CMD_WRITE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_nchan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_range_table</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">ao_readback_insn</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">ao_winsn</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ao_cmd_is_supported</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">ao_cmdtest</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">ao_cmd</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_nchan</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">ao_cancel</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  digital input */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_64XX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">di_rbits</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="cm">/*  digital output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_64XX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">do_wbits</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="cm">/* 8255 */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">has_8255</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dio_8255_iobase</span> <span class="o">=</span>
			    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">I8255_4020_REG</span><span class="p">;</span>
			<span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">dio_callback_4020</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dio_8255_iobase</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dio_8255_iobase</span> <span class="o">=</span>
			    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span> <span class="o">+</span> <span class="n">DIO_8255_OFFSET</span><span class="p">;</span>
			<span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">dio_callback</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dio_8255_iobase</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="cm">/*  8 channel dio for 60xx */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_60XX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DIO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="n">dio_60xx_config_insn</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">dio_60xx_wbits</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="cm">/*  caldac */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_CALIB</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">calib_read_insn</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">calib_write_insn</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">caldac_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/*  2 channel ad8402 potentiometer */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_64XX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_CALIB</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">ad8402_read_insn</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">ad8402_write_insn</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ad8402_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="cm">/* serial EEPROM, if present */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_CONTROL_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CTL_EECHK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_MEMORY</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">eeprom_read_insn</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="cm">/*  user counter subd XXX */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_plx_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_intcsr_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_intcsr_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_INTRCS_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_stc_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*  bit should be set for 6025, although docs say boards with &lt;= 16 chans should be cleared XXX */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">|=</span> <span class="n">ADC_QUEUE_CONFIG_BIT</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_CONTROL1_REG</span><span class="p">);</span>

	<span class="cm">/*  6402/16 manual says this register must be initialized to 0xff? */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_SAMPLE_INTERVAL_UPPER_REG</span><span class="p">);</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">SLOW_DAC_BIT</span> <span class="o">|</span> <span class="n">DMA_CH_SELECT_BIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">INTERNAL_CLOCK_4020_BITS</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">HW_CONFIG_REG</span><span class="p">);</span>

	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAQ_SYNC_REG</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*  set fifos to maximum size */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fifo_size_bits</span> <span class="o">|=</span> <span class="n">DAC_FIFO_BITS</span><span class="p">;</span>
	<span class="n">set_ai_fifo_segment_length</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo</span><span class="o">-&gt;</span><span class="n">max_segment_length</span><span class="p">);</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dac_control1_bits</span> <span class="o">=</span> <span class="n">DAC_OUTPUT_ENABLE_BIT</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intr_enable_bits</span> <span class="o">=</span>	<span class="cm">/* EN_DAC_INTR_SRC_BIT | DAC_INTR_QEMPTY_BITS | */</span>
	    <span class="n">EN_DAC_DONE_INTR_BIT</span> <span class="o">|</span> <span class="n">EN_DAC_UNDERRUN_BIT</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intr_enable_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">INTR_ENABLE_REG</span><span class="p">);</span>

	<span class="n">disable_ai_pacing</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_and_init_dma_members</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*  alocate pci dma buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ai_dma_ring_count</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="n">DMA_BUFFER_SIZE</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_buffer_bus_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AO_DMA_RING_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ao_cmd_is_supported</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span>
						 <span class="n">DMA_BUFFER_SIZE</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span>
						 <span class="n">ao_buffer_bus_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*  allocate dma descriptors */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">plx_dma_desc</span><span class="p">)</span> <span class="o">*</span>
				 <span class="n">ai_dma_ring_count</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)),</span>
				 <span class="o">&amp;</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc_bus_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;ai dma descriptors start at bus addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc_bus_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ao_cmd_is_supported</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span> <span class="o">=</span>
		    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">plx_dma_desc</span><span class="p">)</span> <span class="o">*</span>
					 <span class="n">AO_DMA_RING_COUNT</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc_bus_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;ao dma descriptors start at bus addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc_bus_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*  initialize dma descriptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ai_dma_ring_count</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_start_addr</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_buffer_bus_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">local_start_addr</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">local1_iobase</span> <span class="o">+</span>
					<span class="n">ADC_FIFO_REG</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">local_start_addr</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">local0_iobase</span> <span class="o">+</span>
					<span class="n">ADC_FIFO_REG</span><span class="p">);</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">transfer_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc_bus_addr</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span>
								     <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
								    <span class="n">ai_dma_ring_count</span>
								    <span class="p">(</span><span class="n">board</span>
								     <span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="o">*</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span>
				<span class="n">PLX_DESC_IN_PCI_BIT</span> <span class="o">|</span> <span class="n">PLX_INTR_TERM_COUNT</span> <span class="o">|</span>
				<span class="n">PLX_XFER_LOCAL_TO_PCI</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ao_cmd_is_supported</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AO_DMA_RING_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_start_addr</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_buffer_bus_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">local_start_addr</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">local0_iobase</span> <span class="o">+</span>
					<span class="n">DAC_FIFO_REG</span><span class="p">);</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">transfer_size</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc_bus_addr</span> <span class="o">+</span>
					 <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">AO_DMA_RING_COUNT</span><span class="p">))</span> <span class="o">*</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span>
					<span class="n">PLX_DESC_IN_PCI_BIT</span> <span class="o">|</span>
					<span class="n">PLX_INTR_TERM_COUNT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">warn_external_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;AO command and AI external channel queue cannot be used simultaneously.&quot;</span><span class="p">);</span>
	<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;Use internal AI channel queue (channels must be consecutive and use same range/aref)&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attach is called by the Comedi core to configure the driver</span>
<span class="cm"> * for a particular board.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">local_range</span><span class="p">,</span> <span class="n">local_decode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate the private structure area.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcidas64_private</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Probe the device to determine what device in the series it is.</span>
<span class="cm"> */</span>

	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">pcidev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  is it not a computer boards card? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*  loop through cards supported by this driver */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pcidas64_boards</span><span class="p">);</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcidas64_boards</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">device_id</span> <span class="o">!=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*  was a particular bus/slot requested? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/*  are we on the wrong bus/slot? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">=</span> <span class="n">pcidas64_boards</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;No supported ComputerBoards/MeasurementComputing card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;Found %s on bus %i, slot %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comedi_pci_enable</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;failed to enable PCI device and request regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="cm">/* Initialize dev-&gt;board_name */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_phys_iobase</span> <span class="o">=</span>
	    <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PLX9080_BADDRINDEX</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_phys_iobase</span> <span class="o">=</span>
	    <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">MAIN_BADDRINDEX</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_phys_iobase</span> <span class="o">=</span>
	    <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DIO_COUNTER_BADDRINDEX</span><span class="p">);</span>

	<span class="cm">/*  remap, won&#39;t work with 2.0 kernels but who cares */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_phys_iobase</span><span class="p">,</span>
					    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span>
							     <span class="n">PLX9080_BADDRINDEX</span><span class="p">));</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">=</span>
	    <span class="n">ioremap</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_phys_iobase</span><span class="p">,</span>
		    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">MAIN_BADDRINDEX</span><span class="p">));</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span> <span class="o">=</span>
	    <span class="n">ioremap</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_phys_iobase</span><span class="p">,</span>
		    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DIO_COUNTER_BADDRINDEX</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;failed to remap io memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; plx9080 remapped to 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; main remapped to 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; diocounter remapped to 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span><span class="p">);</span>

	<span class="cm">/*  figure out what local addresses are */</span>
	<span class="n">local_range</span> <span class="o">=</span>
	    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_LAS0RNG_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LRNG_MEM_MASK</span><span class="p">;</span>
	<span class="n">local_decode</span> <span class="o">=</span>
	    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span>
		  <span class="n">PLX_LAS0MAP_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">local_range</span> <span class="o">&amp;</span> <span class="n">LMAP_MEM_MASK</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">local0_iobase</span> <span class="o">=</span>
	    <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_phys_iobase</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">local_range</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">local_decode</span><span class="p">;</span>
	<span class="n">local_range</span> <span class="o">=</span>
	    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_LAS1RNG_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LRNG_MEM_MASK</span><span class="p">;</span>
	<span class="n">local_decode</span> <span class="o">=</span>
	    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span>
		  <span class="n">PLX_LAS1MAP_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">local_range</span> <span class="o">&amp;</span> <span class="n">LMAP_MEM_MASK</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">local1_iobase</span> <span class="o">=</span>
	    <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_phys_iobase</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">local_range</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">local_decode</span><span class="p">;</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; local 0 io addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">local0_iobase</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; local 1 io addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">local1_iobase</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">alloc_and_init_dma_members</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">=</span>
	    <span class="n">hw_revision</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">HW_STATUS_REG</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;stc hardware revision %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_revision</span><span class="p">);</span>
	<span class="n">init_plx9080</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init_stc_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*  get irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="s">&quot;cb_pcidas64&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate irq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;irq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">setup_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">disable_plx_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span><span class="p">);</span>
			<span class="cm">/*  free pci dma buffers */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ai_dma_ring_count</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span>
							    <span class="n">DMA_BUFFER_SIZE</span><span class="p">,</span>
							    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span>
							    <span class="n">ai_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							    <span class="n">priv</span>
							    <span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_buffer_bus_addr</span>
							    <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AO_DMA_RING_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span>
							    <span class="n">DMA_BUFFER_SIZE</span><span class="p">,</span>
							    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span>
							    <span class="n">ao_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							    <span class="n">priv</span>
							    <span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_buffer_bus_addr</span>
							    <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="cm">/*  free dma descriptors */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span><span class="p">)</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span>
						    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">plx_dma_desc</span><span class="p">)</span>
						    <span class="o">*</span>
						    <span class="n">ai_dma_ring_count</span><span class="p">(</span><span class="n">board</span>
								      <span class="p">(</span><span class="n">dev</span><span class="p">)),</span>
						    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span><span class="p">,</span>
						    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span>
						    <span class="n">ai_dma_desc_bus_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">)</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span>
						    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">plx_dma_desc</span><span class="p">)</span>
						    <span class="o">*</span> <span class="n">AO_DMA_RING_COUNT</span><span class="p">,</span>
						    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">,</span>
						    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span>
						    <span class="n">ao_dma_desc_bus_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_phys_iobase</span><span class="p">)</span>
				<span class="n">comedi_pci_disable</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">);</span>

			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">)</span>
		<span class="n">subdev_8255_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">aref</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;chanspec 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">aref</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/*  disable card&#39;s analog input interrupt sources and pacing */</span>
	<span class="cm">/*  4020 generates dac done interrupts even though they are disabled */</span>
	<span class="n">disable_ai_pacing</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">&amp;</span> <span class="n">CR_ALT_FILTER</span><span class="p">)</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">|=</span> <span class="n">ADC_DITHER_BIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_DITHER_BIT</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_CONTROL1_REG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  use internal queue */</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EXT_QUEUE_BIT</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">HW_CONFIG_REG</span><span class="p">);</span>

		<span class="cm">/*  ALT_SOURCE is internal calibration reference */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">&amp;</span> <span class="n">CR_ALT_SOURCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cal_en_bit</span><span class="p">;</span>

			<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;reading calibration source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_60XX</span><span class="p">)</span>
				<span class="n">cal_en_bit</span> <span class="o">=</span> <span class="n">CAL_EN_60XX_BIT</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cal_en_bit</span> <span class="o">=</span> <span class="n">CAL_EN_64XX_BIT</span><span class="p">;</span>
			<span class="cm">/*  select internal reference source to connect to channel 0 */</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">cal_en_bit</span> <span class="o">|</span>
			       <span class="n">adc_src_bits</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">calibration_source</span><span class="p">),</span>
			       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*  make sure internal calibration source is turned off */</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*  load internal queue */</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*  set gain */</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">ai_range_bits_6xxx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="cm">/*  set single-ended / differential */</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">se_diff_bit_6xxx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">aref</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aref</span> <span class="o">==</span> <span class="n">AREF_COMMON</span><span class="p">)</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">ADC_COMMON_BIT</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">adc_chan_bits</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
		<span class="cm">/*  set stop channel */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">adc_chan_bits</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_QUEUE_HIGH_REG</span><span class="p">);</span>
		<span class="cm">/*  set start channel, and rest of settings */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_QUEUE_LOAD_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">old_cal_range_bits</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span><span class="p">;</span>

		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_SRC_4020_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">&amp;</span> <span class="n">CR_ALT_SOURCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;reading calibration source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">|=</span>
			    <span class="n">adc_src_4020_bits</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">calibration_source</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* select BNC inputs */</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">|=</span> <span class="n">adc_src_4020_bits</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*  select range */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">|=</span> <span class="n">attenuate_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">attenuate_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
		<span class="cm">/*  update calibration/range i2c register only if necessary, as it is very slow */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_cal_range_bits</span> <span class="o">!=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">i2c_data</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span><span class="p">;</span>
			<span class="n">i2c_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RANGE_CAL_I2C_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_data</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="n">i2c_data</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* 4020 manual asks that sample interval register to be set before writing to convert register.</span>
<span class="cm">		 * Using somewhat arbitrary setting of 4 master clock ticks = 0.1 usec */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_SAMPLE_INTERVAL_UPPER_REG</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_SAMPLE_INTERVAL_LOWER_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*  clear adc buffer (inside loop for 4020 sake) */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_BUFFER_CLEAR_REG</span><span class="p">);</span>

		<span class="cm">/* trigger conversion, bits sent only matter for 4020 */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">adc_convert_chan_4020_bits</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)),</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_CONVERT_REG</span><span class="p">);</span>

		<span class="cm">/*  wait for data */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">HW_STATUS_REG</span><span class="p">);</span>
			<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; pipe bits 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe_full_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span>
					  <span class="n">ADC_WRITE_PNTR_REG</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pipe_full_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; looped %i times waiting for data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; analog input read insn timed out&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span> <span class="o">+</span>
				  <span class="n">ADC_FIFO_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">PIPE1_READ_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_config_calibration_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">source</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_calibration_sources</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_60XX</span><span class="p">)</span>
		<span class="n">num_calibration_sources</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">num_calibration_sources</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">num_calibration_sources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;invalid calibration source: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">source</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;setting calibration source to %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">calibration_source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_config_block_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hw_fifo_info</span> <span class="o">*</span><span class="k">const</span> <span class="n">fifo</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">requested_block_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">requested_block_size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">requested_block_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fifo_size</span> <span class="o">=</span>
		    <span class="n">requested_block_size</span> <span class="o">*</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">num_segments</span> <span class="o">/</span> <span class="n">bytes_in_sample</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">set_ai_fifo_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fifo_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">block_size</span> <span class="o">=</span> <span class="n">ai_fifo_size</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">/</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">num_segments</span> <span class="o">*</span> <span class="n">bytes_in_sample</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_config_master_clock_4020</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">COMEDI_EV_SCAN_BEGIN</span>:
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ext_clock</span><span class="p">.</span><span class="n">divisor</span> <span class="o">=</span> <span class="n">divisor</span><span class="p">;</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ext_clock</span><span class="p">.</span><span class="n">chanspec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span> <span class="o">?</span> <span class="n">retval</span> <span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* XXX could add support for 60xx series */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_config_master_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LAYOUT_4020</span>:
		<span class="k">return</span> <span class="n">ai_config_master_clock_4020</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_config_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_ALT_SOURCE</span>:
		<span class="k">return</span> <span class="n">ai_config_calibration_source</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_BLOCK_SIZE</span>:
		<span class="k">return</span> <span class="n">ai_config_block_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_TIMER_1</span>:
		<span class="k">return</span> <span class="n">ai_config_master_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_arg</span><span class="p">,</span> <span class="n">tmp_arg2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aref</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">triggers</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">triggers</span> <span class="o">=</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
		<span class="n">triggers</span> <span class="o">|=</span> <span class="n">TRIG_OTHER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">triggers</span> <span class="o">|=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">triggers</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">triggers</span> <span class="o">=</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
		<span class="n">triggers</span> <span class="o">|=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">triggers</span> <span class="o">|=</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">triggers</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_EXT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* step 2: make sure trigger sources are unique and mutually compatible */</span>

	<span class="cm">/*  uniqueness check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_OTHER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*  compatibility check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_speed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_speed</span><span class="p">;</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*  if scans are timed faster than conversion rate allows */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span>
				    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
					    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span>
					    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
					<span class="n">err</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_COUNT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_NONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
		<span class="n">tmp_arg2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">check_adc_timing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_arg2</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*  make sure user is doesn&#39;t change analog reference mid chanlist */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aref</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aref</span> <span class="o">!=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;all elements in chanlist must use the same analog reference&quot;</span><span class="p">);</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*  check 4020 chanlist */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span>
				    <span class="n">first_channel</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						     <span class="s">&quot;chanlist must use consecutive channels&quot;</span><span class="p">);</span>
					<span class="n">err</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;chanlist cannot be 3 channels long, use 1, 2, or 4 channels&quot;</span><span class="p">);</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">use_hw_sample_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* disable for now until I work out a race */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&lt;=</span> <span class="n">max_counter_value</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_sample_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  set software count */</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  load hardware conversion counter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_hw_sample_counter</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_COUNT_LOWER_REG</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_COUNT_UPPER_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_COUNT_LOWER_REG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dma_transfer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_samples</span><span class="p">;</span>

	<span class="n">num_samples</span> <span class="o">=</span>
	    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo_segment_length</span> <span class="o">*</span>
	    <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo</span><span class="o">-&gt;</span><span class="n">sample_packing_ratio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_samples</span> <span class="o">&gt;</span> <span class="n">DMA_BUFFER_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span>
		<span class="n">num_samples</span> <span class="o">=</span> <span class="n">DMA_BUFFER_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">num_samples</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_ai_pacing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">disable_ai_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_SW_GATE_BIT</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_CONTROL1_REG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* disable pacing, triggering, etc */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">ADC_DMA_DISABLE_BIT</span> <span class="o">|</span> <span class="n">ADC_SOFT_GATE_BITS</span> <span class="o">|</span> <span class="n">ADC_GATE_LEVEL_BIT</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_CONTROL0_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_ai_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intr_enable_bits</span> <span class="o">&amp;=</span>
	    <span class="o">~</span><span class="n">EN_ADC_INTR_SRC_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EN_ADC_DONE_INTR_BIT</span> <span class="o">&amp;</span>
	    <span class="o">~</span><span class="n">EN_ADC_ACTIVE_INTR_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EN_ADC_STOP_INTR_BIT</span> <span class="o">&amp;</span>
	    <span class="o">~</span><span class="n">EN_ADC_OVERRUN_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ADC_INTR_SRC_MASK</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intr_enable_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">INTR_ENABLE_REG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;intr enable bits 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intr_enable_bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_ai_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">EN_ADC_OVERRUN_BIT</span> <span class="o">|</span> <span class="n">EN_ADC_DONE_INTR_BIT</span> <span class="o">|</span>
	    <span class="n">EN_ADC_ACTIVE_INTR_BIT</span> <span class="o">|</span> <span class="n">EN_ADC_STOP_INTR_BIT</span><span class="p">;</span>
	<span class="cm">/*  Use pio transfer and interrupt on end of conversion if TRIG_WAKE_EOS flag is set. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  4020 doesn&#39;t support pio transfers except for fifo dregs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">ADC_INTR_EOSCAN_BITS</span> <span class="o">|</span> <span class="n">EN_ADC_INTR_SRC_BIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intr_enable_bits</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intr_enable_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">INTR_ENABLE_REG</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;intr enable bits 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intr_enable_bits</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">ai_convert_counter_6xxx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  supposed to load counter with desired divisor minus 3 */</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">/</span> <span class="n">TIMER_BASE</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">ai_scan_counter_6xxx</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="cm">/*  figure out how long we need to delay at end of scan */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">-</span>
			 <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		    <span class="o">/</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_FOLLOW</span>:
		<span class="n">count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">/</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">ai_convert_counter_4020</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
		<span class="n">divisor</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">/</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_OTHER</span>:
		<span class="n">divisor</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ext_clock</span><span class="p">.</span><span class="n">divisor</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/*  should never happen */</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug! failed to set ai pacing!&quot;</span><span class="p">);</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  supposed to load counter with desired divisor minus 2 for 4020 */</span>
	<span class="k">return</span> <span class="n">divisor</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">select_master_clock_4020</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  select internal/external master clock */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASTER_CLOCK_4020_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_OTHER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">chanspec</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ext_clock</span><span class="p">.</span><span class="n">chanspec</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span> <span class="o">|=</span> <span class="n">BNC_CLOCK_4020_BITS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span> <span class="o">|=</span> <span class="n">EXT_CLOCK_4020_BITS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span> <span class="o">|=</span> <span class="n">INTERNAL_CLOCK_4020_BITS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">HW_CONFIG_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">select_master_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LAYOUT_4020</span>:
		<span class="n">select_master_clock_4020</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dma_start_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*  spinlock for plx dma control/status reg */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">PLX_DMA_EN_BIT</span> <span class="o">|</span> <span class="n">PLX_DMA_START_BIT</span> <span class="o">|</span>
		       <span class="n">PLX_CLEAR_DMA_INTR_BIT</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_CS_REG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">PLX_DMA_EN_BIT</span> <span class="o">|</span> <span class="n">PLX_DMA_START_BIT</span> <span class="o">|</span>
		       <span class="n">PLX_CLEAR_DMA_INTR_BIT</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_CS_REG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_ai_pacing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">convert_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scan_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">check_adc_timing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">select_master_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">convert_counter</span> <span class="o">=</span> <span class="n">ai_convert_counter_4020</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">convert_counter</span> <span class="o">=</span> <span class="n">ai_convert_counter_6xxx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">scan_counter</span> <span class="o">=</span> <span class="n">ai_scan_counter_6xxx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*  load lower 16 bits of convert interval */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">convert_counter</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_SAMPLE_INTERVAL_LOWER_REG</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;convert counter 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">convert_counter</span><span class="p">);</span>
	<span class="cm">/*  load upper 8 bits of convert interval */</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">convert_counter</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_SAMPLE_INTERVAL_UPPER_REG</span><span class="p">);</span>
	<span class="cm">/*  load lower 16 bits of scan delay */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">scan_counter</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_DELAY_INTERVAL_LOWER_REG</span><span class="p">);</span>
	<span class="cm">/*  load upper 8 bits of scan delay */</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">scan_counter</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_DELAY_INTERVAL_UPPER_REG</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;scan counter 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scan_counter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">use_internal_queue_6xxx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">!=</span>
		    <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">!=</span>
		    <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_channel_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_internal_queue_6xxx</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EXT_QUEUE_BIT</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span><span class="p">,</span>
			       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">HW_CONFIG_REG</span><span class="p">);</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/*  set channel */</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">adc_chan_bits</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
			<span class="cm">/*  set gain */</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">ai_range_bits_6xxx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
			<span class="cm">/*  set single-ended / differential */</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">se_diff_bit_6xxx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						 <span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span>
						 <span class="n">AREF_DIFF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">AREF_COMMON</span><span class="p">)</span>
				<span class="n">bits</span> <span class="o">|=</span> <span class="n">ADC_COMMON_BIT</span><span class="p">;</span>
			<span class="cm">/*  set stop channel */</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">adc_chan_bits</span>
			       <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])),</span>
			       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_QUEUE_HIGH_REG</span><span class="p">);</span>
			<span class="cm">/*  set start channel, and rest of settings */</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span>
			       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_QUEUE_LOAD_REG</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*  use external queue */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">warn_external_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span> <span class="o">|=</span> <span class="n">EXT_QUEUE_BIT</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_config_bits</span><span class="p">,</span>
			       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">HW_CONFIG_REG</span><span class="p">);</span>
			<span class="cm">/*  clear DAC buffer to prevent weird interactions */</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
			       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_BUFFER_CLEAR_REG</span><span class="p">);</span>
			<span class="cm">/*  clear queue pointer */</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_QUEUE_CLEAR_REG</span><span class="p">);</span>
			<span class="cm">/*  load external queue */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/*  set channel */</span>
				<span class="n">bits</span> <span class="o">|=</span>
				    <span class="n">adc_chan_bits</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
				<span class="cm">/*  set gain */</span>
				<span class="n">bits</span> <span class="o">|=</span> <span class="n">ai_range_bits_6xxx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span>
								    <span class="n">chanlist</span>
								    <span class="p">[</span><span class="n">i</span><span class="p">]));</span>
				<span class="cm">/*  set single-ended / differential */</span>
				<span class="n">bits</span> <span class="o">|=</span> <span class="n">se_diff_bit_6xxx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							 <span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span>
								 <span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span>
							 <span class="n">AREF_DIFF</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="n">AREF_COMMON</span><span class="p">)</span>
					<span class="n">bits</span> <span class="o">|=</span> <span class="n">ADC_COMMON_BIT</span><span class="p">;</span>
				<span class="cm">/*  mark end of queue */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">bits</span> <span class="o">|=</span> <span class="n">QUEUE_EOSCAN_BIT</span> <span class="o">|</span>
					    <span class="n">QUEUE_EOSEQ_BIT</span><span class="p">;</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span>
				       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span>
				       <span class="n">ADC_QUEUE_FIFO_REG</span><span class="p">);</span>
				<span class="n">DEBUG_PRINT</span>
				    <span class="p">(</span><span class="s">&quot;wrote 0x%x to external channel queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">bits</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* doing a queue clear is not specified in board docs,</span>
<span class="cm">			 * but required for reliable operation */</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_QUEUE_CLEAR_REG</span><span class="p">);</span>
			<span class="cm">/*  prime queue holding register */</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_QUEUE_LOAD_REG</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">old_cal_range_bits</span> <span class="o">=</span>
		    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span><span class="p">;</span>

		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_SRC_4020_MASK</span><span class="p">;</span>
		<span class="cm">/* select BNC inputs */</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">|=</span> <span class="n">adc_src_4020_bits</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="cm">/*  select ranges */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">|=</span>
				    <span class="n">attenuate_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="n">attenuate_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*  update calibration/range i2c register only if necessary, as it is very slow */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_cal_range_bits</span> <span class="o">!=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">i2c_data</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i2c_cal_range_bits</span><span class="p">;</span>
			<span class="n">i2c_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RANGE_CAL_I2C_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_data</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="n">i2c_data</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">load_first_dma_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_channel</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">descriptor_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The transfer size, pci address, and local address registers</span>
<span class="cm">	 * are supposedly unused during chained dma,</span>
<span class="cm">	 * but I have found that left over values from last operation</span>
<span class="cm">	 * occasionally cause problems with transfer of first dma</span>
<span class="cm">	 * block.  Initializing them to zero seems to fix the problem. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_TRANSFER_SIZE_REG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_PCI_ADDRESS_REG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_LOCAL_ADDRESS_REG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">descriptor_bits</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_DESCRIPTOR_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_TRANSFER_SIZE_REG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_PCI_ADDRESS_REG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_LOCAL_ADDRESS_REG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">descriptor_bits</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_DESCRIPTOR_REG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">disable_ai_pacing</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">abort_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">setup_channel_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/*  make sure internal calibration source is turned off */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>

	<span class="n">set_ai_pacing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">setup_sample_counters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">enable_ai_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* set mode, allow conversions through software gate */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">|=</span> <span class="n">ADC_SW_GATE_BIT</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_DITHER_BIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_MODE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">|=</span> <span class="n">adc_mode_bits</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>	<span class="cm">/*  good old mode 13 */</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">|=</span> <span class="n">adc_mode_bits</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>	<span class="cm">/*  mode 8.  What else could you need? */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CHANNEL_MODE_4020_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">|=</span> <span class="n">FOUR_CHANNEL_4020_BITS</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">|=</span> <span class="n">TWO_CHANNEL_4020_BITS</span><span class="p">;</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_LO_CHANNEL_4020_MASK</span><span class="p">;</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">|=</span>
		    <span class="n">adc_lo_chan_4020_bits</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_HI_CHANNEL_4020_MASK</span><span class="p">;</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span> <span class="o">|=</span>
		    <span class="n">adc_hi_chan_4020_bits</span><span class="p">(</span><span class="n">CR_CHAN</span>
					  <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span>
					   <span class="n">chanlist</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_CONTROL1_REG</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;control1 bits 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">adc_control1_bits</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*  clear adc buffer */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_BUFFER_CLEAR_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*  set dma transfer size */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ai_dma_ring_count</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">transfer_size</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_transfer_size</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>

		<span class="cm">/*  give location of first dma descriptor */</span>
		<span class="n">load_first_dma_descriptor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					  <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_desc_bus_addr</span> <span class="o">|</span>
					  <span class="n">PLX_DESC_IN_PCI_BIT</span> <span class="o">|</span>
					  <span class="n">PLX_INTR_TERM_COUNT</span> <span class="o">|</span>
					  <span class="n">PLX_XFER_LOCAL_TO_PCI</span><span class="p">);</span>

		<span class="n">dma_start_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set source for external triggers */</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">))</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">EXT_START_TRIG_BNC_BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">))</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">EXT_STOP_TRIG_BNC_BIT</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAQ_ATRIG_LOW_4020_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* enable pacing, triggering, etc */</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">ADC_ENABLE_BIT</span> <span class="o">|</span> <span class="n">ADC_SOFT_GATE_BITS</span> <span class="o">|</span> <span class="n">ADC_GATE_LEVEL_BIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">ADC_DMA_DISABLE_BIT</span><span class="p">;</span>
	<span class="cm">/*  set start trigger */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">ADC_START_TRIG_EXT_BITS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">ADC_START_TRIG_FALLING_BIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">ADC_START_TRIG_SOFT_BITS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_hw_sample_counter</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">ADC_SAMPLE_COUNTER_EN_BIT</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_CONTROL0_REG</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;control0 bits 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*  start acquisition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_START_REG</span><span class="p">);</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;soft trig</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* read num_samples from 16 bit wide ai fifo */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pio_drain_ai_fifo_16</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">prepost_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read_segment</span><span class="p">,</span> <span class="n">read_index</span><span class="p">,</span> <span class="n">write_segment</span><span class="p">,</span> <span class="n">write_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_samples</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/*  get least significant 15 bits */</span>
		<span class="n">read_index</span> <span class="o">=</span>
		    <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_READ_PNTR_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
		<span class="n">write_index</span> <span class="o">=</span>
		    <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_WRITE_PNTR_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
		<span class="cm">/* Get most significant bits (grey code).  Different boards use different code</span>
<span class="cm">		 * so use a scheme that doesn&#39;t depend on encoding.  This read must</span>
<span class="cm">		 * occur after reading least significant 15 bits to avoid race</span>
<span class="cm">		 * with fifo switching to next segment. */</span>
		<span class="n">prepost_bits</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">PREPOST_REG</span><span class="p">);</span>

		<span class="cm">/* if read and write pointers are not on the same fifo segment, read to the</span>
<span class="cm">		 * end of the read segment */</span>
		<span class="n">read_segment</span> <span class="o">=</span> <span class="n">adc_upper_read_ptr_code</span><span class="p">(</span><span class="n">prepost_bits</span><span class="p">);</span>
		<span class="n">write_segment</span> <span class="o">=</span> <span class="n">adc_upper_write_ptr_code</span><span class="p">(</span><span class="n">prepost_bits</span><span class="p">);</span>

		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; rd seg %i, wrt seg %i, rd idx %i, wrt idx %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">read_segment</span><span class="p">,</span> <span class="n">write_segment</span><span class="p">,</span> <span class="n">read_index</span><span class="p">,</span>
			    <span class="n">write_index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_segment</span> <span class="o">!=</span> <span class="n">write_segment</span><span class="p">)</span>
			<span class="n">num_samples</span> <span class="o">=</span>
			    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo_segment_length</span> <span class="o">-</span> <span class="n">read_index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">num_samples</span> <span class="o">=</span> <span class="n">write_index</span> <span class="o">-</span> <span class="n">read_index</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">num_samples</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span><span class="p">)</span>
				<span class="n">num_samples</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span><span class="p">;</span>

			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span> <span class="o">-=</span> <span class="n">num_samples</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_samples</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;cb_pcidas64: bug! num_samples &lt; 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; read %i samples from fifo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
					    <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span>
						  <span class="n">ADC_FIFO_REG</span><span class="p">));</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">read_segment</span> <span class="o">!=</span> <span class="n">write_segment</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read from 32 bit wide ai fifo of 4020 - deal with insane grey coding of pointers.</span>
<span class="cm"> * The pci-4020 hardware only supports</span>
<span class="cm"> * dma transfers (it only supports the use of pio for draining the last remaining</span>
<span class="cm"> * points from the fifo when a data acquisition operation has completed).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pio_drain_ai_fifo_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_transfer</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fifo_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write_code</span> <span class="o">=</span>
	    <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_WRITE_PNTR_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read_code</span> <span class="o">=</span>
	    <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_READ_PNTR_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_transfer</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span><span class="p">)</span>
			<span class="n">max_transfer</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">read_code</span> <span class="o">!=</span> <span class="n">write_code</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_transfer</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">fifo_data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span> <span class="o">+</span> <span class="n">ADC_FIFO_REG</span><span class="p">);</span>
		<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fifo_data</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_transfer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">fifo_data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">read_code</span> <span class="o">=</span>
		    <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_READ_PNTR_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span> <span class="o">-=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* empty fifo */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pio_drain_ai_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
		<span class="n">pio_drain_ai_fifo_32</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pio_drain_ai_fifo_16</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drain_dma_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">next_transfer_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pci_addr_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">pci_addr_reg</span> <span class="o">=</span>
		    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_PCI_ADDRESS_REG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pci_addr_reg</span> <span class="o">=</span>
		    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_PCI_ADDRESS_REG</span><span class="p">;</span>

	<span class="cm">/*  loop until we have read all the full buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">next_transfer_addr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pci_addr_reg</span><span class="p">);</span>
	     <span class="p">(</span><span class="n">next_transfer_addr</span> <span class="o">&lt;</span>
	      <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_buffer_bus_addr</span><span class="p">[</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_index</span><span class="p">]</span>
	      <span class="o">||</span> <span class="n">next_transfer_addr</span> <span class="o">&gt;=</span>
	      <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_buffer_bus_addr</span><span class="p">[</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_index</span><span class="p">]</span> <span class="o">+</span>
	      <span class="n">DMA_BUFFER_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ai_dma_ring_count</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  transfer data from dma buffer to comedi buffer */</span>
		<span class="n">num_samples</span> <span class="o">=</span> <span class="n">dma_transfer_size</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">num_samples</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span><span class="p">)</span>
				<span class="n">num_samples</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span><span class="p">;</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span> <span class="o">-=</span> <span class="n">num_samples</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="p">,</span>
					  <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_buffer</span><span class="p">[</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span>
							       <span class="n">ai_dma_index</span><span class="p">],</span>
					  <span class="n">num_samples</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_index</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_index</span> <span class="o">+</span>
		     <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ai_dma_ring_count</span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;next buffer addr 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span>
			    <span class="n">ai_buffer_bus_addr</span><span class="p">[</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_dma_index</span><span class="p">]);</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;pci addr reg 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">next_transfer_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* XXX check for dma ring buffer overrun (use end-of-chain bit to mark last</span>
<span class="cm">	 * unused buffer) */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ai_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plx_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">dma1_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*  check for fifo overrun */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ADC_OVERRUN_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fifo overrun&quot;</span><span class="p">);</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  spin lock makes sure no one else changes plx dma control reg */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dma1_status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_CS_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plx_status</span> <span class="o">&amp;</span> <span class="n">ICS_DMA1_A</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  dma chan 1 interrupt */</span>
		<span class="n">writeb</span><span class="p">((</span><span class="n">dma1_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_EN_BIT</span><span class="p">)</span> <span class="o">|</span> <span class="n">PLX_CLEAR_DMA_INTR_BIT</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_CS_REG</span><span class="p">);</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;dma1 status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma1_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma1_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_EN_BIT</span><span class="p">)</span>
			<span class="n">drain_dma_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; cleared dma ch1 interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ADC_DONE_BIT</span><span class="p">)</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;adc done interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*  drain fifo with pio */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ADC_DONE_BIT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ADC_INTR_PENDING_BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">LAYOUT_4020</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;pio fifo drain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">pio_drain_ai_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*  if we are have all the data, then quit */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ADC_STOP_BIT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfc_handle_events</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">prev_ao_dma_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buffer_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">buffer_index</span> <span class="o">=</span> <span class="n">AO_DMA_RING_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buffer_index</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buffer_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">last_ao_dma_load_completed</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buffer_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transfer_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dma_status</span><span class="p">;</span>

	<span class="n">buffer_index</span> <span class="o">=</span> <span class="n">prev_ao_dma_index</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dma_status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_CS_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dma_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_DONE_BIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">transfer_address</span> <span class="o">=</span>
	    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_PCI_ADDRESS_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transfer_address</span> <span class="o">!=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_buffer_bus_addr</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ao_stopped_by_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_count</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_ao_dma_load_completed</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ao_dma_needs_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dma_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dma_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_DONE_BIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dma_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_EN_BIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_ao_dma_load_completed</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">restart_ao_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_desc_bits</span><span class="p">;</span>

	<span class="n">dma_desc_bits</span> <span class="o">=</span>
	    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_DESCRIPTOR_REG</span><span class="p">);</span>
	<span class="n">dma_desc_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_END_OF_CHAIN_BIT</span><span class="p">;</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;restarting ao dma, descriptor reg 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_desc_bits</span><span class="p">);</span>
	<span class="n">load_first_dma_descriptor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dma_desc_bits</span><span class="p">);</span>

	<span class="n">dma_start_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ao_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plx_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">dma0_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* board might not support ao, in which case write_subdev is NULL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/*  spin lock makes sure no one else changes plx dma control reg */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dma0_status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_CS_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plx_status</span> <span class="o">&amp;</span> <span class="n">ICS_DMA0_A</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  dma chan 0 interrupt */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dma0_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_EN_BIT</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dma0_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_DONE_BIT</span><span class="p">))</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">PLX_DMA_EN_BIT</span> <span class="o">|</span> <span class="n">PLX_CLEAR_DMA_INTR_BIT</span><span class="p">,</span>
			       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_CS_REG</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">PLX_CLEAR_DMA_INTR_BIT</span><span class="p">,</span>
			       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_CS_REG</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;dma0 status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma0_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma0_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_EN_BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">load_ao_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="cm">/* try to recover from dma end-of-chain event */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ao_dma_needs_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma0_status</span><span class="p">))</span>
				<span class="n">restart_ao_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; cleared dma ch0 interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DAC_DONE_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ao_stopped_by_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;plx dma0 desc reg 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span>
				  <span class="n">PLX_DMA0_DESCRIPTOR_REG</span><span class="p">));</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;plx dma0 address reg 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span>
				  <span class="n">PLX_DMA0_PCI_ADDRESS_REG</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">cfc_handle_events</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">handle_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">plx_status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">plx_bits</span><span class="p">;</span>

	<span class="n">plx_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_INTRCS_REG</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">HW_STATUS_REG</span><span class="p">);</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;cb_pcidas64: hw status 0x%x &quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;plx status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">plx_status</span><span class="p">);</span>

	<span class="cm">/* an interrupt before all the postconfig stuff gets done could</span>
<span class="cm">	 * cause a NULL dereference if we continue through the</span>
<span class="cm">	 * interrupt handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;cb_pcidas64: premature interrupt, ignoring&quot;</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">handle_ai_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">plx_status</span><span class="p">);</span>
	<span class="n">handle_ao_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">plx_status</span><span class="p">);</span>

	<span class="cm">/*  clear possible plx9080 interrupt sources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plx_status</span> <span class="o">&amp;</span> <span class="n">ICS_LDIA</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  clear local doorbell interrupt */</span>
		<span class="n">plx_bits</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DBR_OUT_REG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">plx_bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DBR_OUT_REG</span><span class="p">);</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot; cleared local doorbell bits 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">plx_bits</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;exiting handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">abort_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*  spinlock for plx dma control/status reg */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">plx9080_abort_dma</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">disable_ai_pacing</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">abort_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;ai canceled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/*  do some initializing */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_CONTROL0_REG</span><span class="p">);</span>

	<span class="cm">/*  set range */</span>
	<span class="n">set_dac_range_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dac_control1_bits</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">range</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dac_control1_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_CONTROL1_REG</span><span class="p">);</span>

	<span class="cm">/*  write to channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">dac_lsb_4020_reg</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">dac_msb_4020_reg</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">dac_convert_reg</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*  remember output value */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_value</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ao_readback_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_value</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_dac_control0_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">DAC_ENABLE_BIT</span> <span class="o">|</span> <span class="n">WAVEFORM_GATE_LEVEL_BIT</span> <span class="o">|</span>
	    <span class="n">WAVEFORM_GATE_ENABLE_BIT</span> <span class="o">|</span> <span class="n">WAVEFORM_GATE_SELECT_BIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">WAVEFORM_TRIG_EXT_BITS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">WAVEFORM_TRIG_FALLING_BIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">WAVEFORM_TRIG_SOFT_BITS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">DAC_EXT_UPDATE_ENABLE_BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">DAC_EXT_UPDATE_FALLING_BIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_CONTROL0_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_dac_control1_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">range</span><span class="p">;</span>

		<span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">set_dac_range_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dac_control1_bits</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
				   <span class="n">range</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dac_control1_bits</span> <span class="o">|=</span> <span class="n">DAC_SW_GATE_BIT</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dac_control1_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_CONTROL1_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_dac_select_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_channel</span><span class="p">,</span> <span class="n">last_channel</span><span class="p">;</span>

	<span class="n">first_channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">last_channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_channel</span> <span class="o">&lt;</span> <span class="n">first_channel</span><span class="p">)</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug! last ao channel &lt; first ao channel&quot;</span><span class="p">);</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_channel</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">last_channel</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_SELECT_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_dac_interval_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">divisor</span> <span class="o">=</span> <span class="n">get_ao_divisor</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">&gt;</span> <span class="n">max_counter_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug! ao divisor too big&quot;</span><span class="p">);</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="n">max_counter_value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">divisor</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_SAMPLE_INTERVAL_LOWER_REG</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">divisor</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_SAMPLE_INTERVAL_UPPER_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">load_ao_dma_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">,</span> <span class="n">buffer_index</span><span class="p">,</span> <span class="n">prev_buffer_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_bits</span><span class="p">;</span>

	<span class="n">buffer_index</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_index</span><span class="p">;</span>
	<span class="n">prev_buffer_index</span> <span class="o">=</span> <span class="n">prev_ao_dma_index</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;attempting to load ao buffer %i (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_index</span><span class="p">,</span>
		    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_buffer_bus_addr</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">]);</span>

	<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">comedi_buf_read_n_available</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_bytes</span> <span class="o">&gt;</span> <span class="n">DMA_BUFFER_SIZE</span><span class="p">)</span>
		<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">DMA_BUFFER_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">num_bytes</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_count</span><span class="p">)</span>
		<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_count</span><span class="p">;</span>
	<span class="n">num_bytes</span> <span class="o">-=</span> <span class="n">num_bytes</span> <span class="o">%</span> <span class="n">bytes_in_sample</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;loading %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_bytes</span><span class="p">);</span>

	<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">cfc_read_array_from_buffer</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span><span class="p">,</span>
					       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span>
					       <span class="n">ao_buffer</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">],</span>
					       <span class="n">num_bytes</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">].</span><span class="n">transfer_size</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">num_bytes</span><span class="p">);</span>
	<span class="cm">/* set end of chain bit so we catch underruns */</span>
	<span class="n">next_bits</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">].</span><span class="n">next</span><span class="p">);</span>
	<span class="n">next_bits</span> <span class="o">|=</span> <span class="n">PLX_END_OF_CHAIN_BIT</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">next_bits</span><span class="p">);</span>
	<span class="cm">/* clear end of chain bit on previous buffer now that we have set it</span>
<span class="cm">	 * for the last buffer */</span>
	<span class="n">next_bits</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="n">prev_buffer_index</span><span class="p">].</span><span class="n">next</span><span class="p">);</span>
	<span class="n">next_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_END_OF_CHAIN_BIT</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc</span><span class="p">[</span><span class="n">prev_buffer_index</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">next_bits</span><span class="p">);</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">AO_DMA_RING_COUNT</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_count</span> <span class="o">-=</span> <span class="n">num_bytes</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">num_bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">load_ao_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_transfer_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pci_addr_reg</span> <span class="o">=</span>
	    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_PCI_ADDRESS_REG</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buffer_index</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">buffer_index</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_index</span><span class="p">;</span>
		<span class="cm">/* don&#39;t overwrite data that hasn&#39;t been transferred yet */</span>
		<span class="n">next_transfer_addr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pci_addr_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_transfer_addr</span> <span class="o">&gt;=</span>
		    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_buffer_bus_addr</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">]</span>
		    <span class="o">&amp;&amp;</span> <span class="n">next_transfer_addr</span> <span class="o">&lt;</span>
		    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_buffer_bus_addr</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">]</span> <span class="o">+</span>
		    <span class="n">DMA_BUFFER_SIZE</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">load_ao_dma_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">num_bytes</span> <span class="o">&gt;=</span> <span class="n">DMA_BUFFER_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prep_ao_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* clear queue pointer too, since external queue has</span>
<span class="cm">	 * weird interactions with ao fifo */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">ADC_QUEUE_CLEAR_REG</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_BUFFER_CLEAR_REG</span><span class="p">);</span>

	<span class="n">num_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAC_FIFO_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">bytes_in_sample</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">num_bytes</span> <span class="o">/</span> <span class="n">bytes_in_sample</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_count</span><span class="p">)</span>
		<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_count</span> <span class="o">*</span> <span class="n">bytes_in_sample</span><span class="p">;</span>
	<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">cfc_read_array_from_buffer</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span><span class="p">,</span>
					       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_bounce_buffer</span><span class="p">,</span>
					       <span class="n">num_bytes</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="n">bytes_in_sample</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_bounce_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_FIFO_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_count</span> <span class="o">-=</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="n">bytes_in_sample</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">load_ao_dma_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_bytes</span> <span class="o">&gt;=</span> <span class="n">DMA_BUFFER_SIZE</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">load_ao_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">dma_start_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">external_ai_queue_in_use</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_internal_queue_6xxx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ao_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">external_ai_queue_in_use</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">warn_external_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* disable analog output system during setup */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_CONTROL0_REG</span><span class="p">);</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>

	<span class="n">set_dac_select_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">set_dac_interval_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">load_first_dma_descriptor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_dma_desc_bus_addr</span> <span class="o">|</span>
				  <span class="n">PLX_DESC_IN_PCI_BIT</span> <span class="o">|</span> <span class="n">PLX_INTR_TERM_COUNT</span><span class="p">);</span>

	<span class="n">set_dac_control1_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="n">ao_inttrig</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ao_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trig_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trig_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">prep_ao_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>

	<span class="n">set_dac_control0_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_INT</span><span class="p">)</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_START_REG</span><span class="p">);</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ao_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_INT</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* step 2: make sure trigger sources are unique and mutually compatible */</span>

	<span class="cm">/*  uniqueness check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_INT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*  compatibility check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_scan_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ao_scan_speed</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_ao_divisor</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
				   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_counter_value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">max_counter_value</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
		    <span class="n">get_divisor</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">*</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">first_channel</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;chanlist must use consecutive channels&quot;</span><span class="p">);</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ao_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">DAC_CONTROL0_REG</span><span class="p">);</span>
	<span class="n">abort_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dio_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iobase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;wrote 0x%x to port %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dio_callback_4020</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iobase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">di_rbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span> <span class="o">+</span> <span class="n">DI_REG</span><span class="p">);</span>
	<span class="n">bits</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_wbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="cm">/*  zero bits we are going to change */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/*  set new bits */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span> <span class="o">+</span> <span class="n">DO_REG</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dio_60xx_config_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_INPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_OUTPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_QUERY</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="n">COMEDI_OUTPUT</span> <span class="o">:</span> <span class="n">COMEDI_INPUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span> <span class="o">+</span> <span class="n">DIO_DIRECTION_60XX_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dio_60xx_wbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span> <span class="o">+</span> <span class="n">DIO_DATA_60XX_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dio_counter_iobase</span> <span class="o">+</span> <span class="n">DIO_DATA_60XX_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">caldac_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">caldac_state</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LAYOUT_60XX</span>:
	<span class="k">case</span> <span class="n">LAYOUT_64XX</span>:
		<span class="n">caldac_8800_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LAYOUT_4020</span>:
		<span class="n">caldac_i2c_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calib_write_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* return immediately if setting hasn&#39;t changed, since</span>
<span class="cm">	 * programming these things is slow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">caldac_state</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">caldac_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calib_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">caldac_state</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad8402_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bitstream_length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">register_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitstream</span> <span class="o">=</span> <span class="p">((</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ad8402_udelay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ad8402_state</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">register_bits</span> <span class="o">=</span> <span class="n">SELECT_8402_64XX_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ad8402_udelay</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">register_bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bitstream_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">bit</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitstream</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
			<span class="n">register_bits</span> <span class="o">|=</span> <span class="n">SERIAL_DATA_IN_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">register_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SERIAL_DATA_IN_BIT</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ad8402_udelay</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">register_bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ad8402_udelay</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">register_bits</span> <span class="o">|</span> <span class="n">SERIAL_CLOCK_BIT</span><span class="p">,</span>
		       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">ad8402_udelay</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* for pci-das6402/16, channel 0 is analog input gain and channel 1 is offset */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad8402_write_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* return immediately if setting hasn&#39;t changed, since</span>
<span class="cm">	 * programming these things is slow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ad8402_state</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ad8402_state</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ad8402_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad8402_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ad8402_state</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bitstream_length</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">read_command</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitstream</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_command</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="k">const</span> <span class="n">plx_control_addr</span> <span class="o">=</span>
	    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span> <span class="n">PLX_CONTROL_REG</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">value_length</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">eeprom_udelay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">eeprom_udelay</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CTL_EE_CLK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CTL_EE_CS</span><span class="p">;</span>
	<span class="cm">/*  make sure we don&#39;t send anything to the i2c bus on 4020 */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">|=</span> <span class="n">CTL_USERO</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
	<span class="cm">/*  activate serial eeprom */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">eeprom_udelay</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">|=</span> <span class="n">CTL_EE_CS</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>

	<span class="cm">/*  write read command and desired memory address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bitstream_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">bit</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  set bit to be written */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">eeprom_udelay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitstream</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">|=</span> <span class="n">CTL_EE_W</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CTL_EE_W</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
		<span class="cm">/*  clock in bit */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">eeprom_udelay</span><span class="p">);</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">|=</span> <span class="n">CTL_EE_CLK</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">eeprom_udelay</span><span class="p">);</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CTL_EE_CLK</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*  read back value from eeprom memory location */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">value_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">bit</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  clock out bit */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">eeprom_udelay</span><span class="p">);</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">|=</span> <span class="n">CTL_EE_CLK</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">eeprom_udelay</span><span class="p">);</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CTL_EE_CLK</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">eeprom_udelay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">plx_control_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CTL_EE_R</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  deactivate eeprom serial input */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">eeprom_udelay</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CTL_EE_CS</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_eeprom</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* utility function that rounds desired timing to an achievable time, and</span>
<span class="cm"> * sets cmd members appropriately.</span>
<span class="cm"> * adc paces conversions from master clock by dividing by (x + 3) where x is 24 bit number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_adc_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">convert_divisor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scan_divisor</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">min_convert_divisor</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">max_convert_divisor</span> <span class="o">=</span>
	    <span class="n">max_counter_value</span> <span class="o">+</span> <span class="n">min_convert_divisor</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">min_scan_divisor_4020</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">max_scan_divisor</span><span class="p">,</span> <span class="n">min_scan_divisor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">LAYOUT_4020</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">convert_divisor</span> <span class="o">=</span>
			    <span class="n">get_divisor</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">convert_divisor</span> <span class="o">&gt;</span> <span class="n">max_convert_divisor</span><span class="p">)</span>
				<span class="n">convert_divisor</span> <span class="o">=</span> <span class="n">max_convert_divisor</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">convert_divisor</span> <span class="o">&lt;</span> <span class="n">min_convert_divisor</span><span class="p">)</span>
				<span class="n">convert_divisor</span> <span class="o">=</span> <span class="n">min_convert_divisor</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">convert_divisor</span> <span class="o">*</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scan_divisor</span> <span class="o">=</span> <span class="n">get_divisor</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  XXX check for integer overflows */</span>
			<span class="n">min_scan_divisor</span> <span class="o">=</span> <span class="n">convert_divisor</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
			<span class="n">max_scan_divisor</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">convert_divisor</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">max_counter_value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">min_scan_divisor</span> <span class="o">=</span> <span class="n">min_scan_divisor_4020</span><span class="p">;</span>
			<span class="n">max_scan_divisor</span> <span class="o">=</span> <span class="n">max_counter_value</span> <span class="o">+</span> <span class="n">min_scan_divisor</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scan_divisor</span> <span class="o">&gt;</span> <span class="n">max_scan_divisor</span><span class="p">)</span>
			<span class="n">scan_divisor</span> <span class="o">=</span> <span class="n">max_scan_divisor</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scan_divisor</span> <span class="o">&lt;</span> <span class="n">min_scan_divisor</span><span class="p">)</span>
			<span class="n">scan_divisor</span> <span class="o">=</span> <span class="n">min_scan_divisor</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">scan_divisor</span> <span class="o">*</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Gets nearest achievable timing given master clock speed, does not</span>
<span class="cm"> * take into account possible minimum/maximum divisor values.  Used</span>
<span class="cm"> * by other timing checking functions. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_divisor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
		<span class="n">divisor</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns</span> <span class="o">+</span> <span class="n">TIMER_BASE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
		<span class="n">divisor</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">/</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
	<span class="nl">default:</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns</span> <span class="o">+</span> <span class="n">TIMER_BASE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">TIMER_BASE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">divisor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_ao_divisor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_divisor</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* adjusts the size of hardware fifo (which determines block size for dma xfers) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_ai_fifo_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_fifo_entries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hw_fifo_info</span> <span class="o">*</span><span class="k">const</span> <span class="n">fifo</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo</span><span class="p">;</span>

	<span class="n">num_fifo_entries</span> <span class="o">=</span> <span class="n">num_samples</span> <span class="o">/</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sample_packing_ratio</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">set_ai_fifo_segment_length</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">num_fifo_entries</span> <span class="o">/</span>
					    <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">num_segments</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">num_samples</span> <span class="o">=</span> <span class="n">retval</span> <span class="o">*</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">num_segments</span> <span class="o">*</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sample_packing_ratio</span><span class="p">;</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;set hardware fifo size to %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">num_samples</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* query length of fifo */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ai_fifo_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo_segment_length</span> <span class="o">*</span>
	    <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo</span><span class="o">-&gt;</span><span class="n">num_segments</span> <span class="o">*</span>
	    <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo</span><span class="o">-&gt;</span><span class="n">sample_packing_ratio</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_ai_fifo_segment_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">increment_size</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hw_fifo_info</span> <span class="o">*</span><span class="k">const</span> <span class="n">fifo</span> <span class="o">=</span> <span class="n">board</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_increments</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">&lt;</span> <span class="n">increment_size</span><span class="p">)</span>
		<span class="n">num_entries</span> <span class="o">=</span> <span class="n">increment_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">&gt;</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">max_segment_length</span><span class="p">)</span>
		<span class="n">num_entries</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">max_segment_length</span><span class="p">;</span>

	<span class="cm">/*  1 == 256 entries, 2 == 512 entries, etc */</span>
	<span class="n">num_increments</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">+</span> <span class="n">increment_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">increment_size</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">num_increments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_size_reg_mask</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fifo_size_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_size_reg_mask</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fifo_size_bits</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fifo_size_bits</span><span class="p">,</span>
	       <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">FIFO_SIZE_REG</span><span class="p">);</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo_segment_length</span> <span class="o">=</span> <span class="n">num_increments</span> <span class="o">*</span> <span class="n">increment_size</span><span class="p">;</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;set hardware fifo segment length to %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo_segment_length</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_fifo_segment_length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* pci-6025 8800 caldac:</span>
<span class="cm"> * address 0 == dac channel 0 offset</span>
<span class="cm"> * address 1 == dac channel 0 gain</span>
<span class="cm"> * address 2 == dac channel 1 offset</span>
<span class="cm"> * address 3 == dac channel 1 gain</span>
<span class="cm"> * address 4 == fine adc offset</span>
<span class="cm"> * address 5 == coarse adc offset</span>
<span class="cm"> * address 6 == coarse adc gain</span>
<span class="cm"> * address 7 == fine adc gain</span>
<span class="cm"> */</span>
<span class="cm">/* pci-6402/16 uses all 8 channels for dac:</span>
<span class="cm"> * address 0 == dac channel 0 fine gain</span>
<span class="cm"> * address 1 == dac channel 0 coarse gain</span>
<span class="cm"> * address 2 == dac channel 0 coarse offset</span>
<span class="cm"> * address 3 == dac channel 1 coarse offset</span>
<span class="cm"> * address 4 == dac channel 1 fine gain</span>
<span class="cm"> * address 5 == dac channel 1 coarse gain</span>
<span class="cm"> * address 6 == dac channel 0 fine offset</span>
<span class="cm"> * address 7 == dac channel 1 fine offset</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">caldac_8800_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span>
			     <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">num_caldac_channels</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bitstream_length</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitstream</span> <span class="o">=</span> <span class="p">((</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">register_bits</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">caldac_8800_udelay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">num_caldac_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;illegal caldac channel&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bitstream_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">bit</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">register_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitstream</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
			<span class="n">register_bits</span> <span class="o">|=</span> <span class="n">SERIAL_DATA_IN_BIT</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">caldac_8800_udelay</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">register_bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>
		<span class="n">register_bits</span> <span class="o">|=</span> <span class="n">SERIAL_CLOCK_BIT</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">caldac_8800_udelay</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">register_bits</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">caldac_8800_udelay</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">SELECT_8800_BIT</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">caldac_8800_udelay</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">main_iobase</span> <span class="o">+</span> <span class="n">CALIBRATION_REG</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">caldac_8800_udelay</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 4020 caldacs */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">caldac_i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caldac_channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">serial_bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">i2c_addr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pointer_bits</span> <span class="p">{</span>
		<span class="cm">/*  manual has gain and offset bits switched */</span>
		<span class="n">OFFSET_0_2</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
		<span class="n">GAIN_0_2</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
		<span class="n">OFFSET_1_3</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
		<span class="n">GAIN_1_3</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">enum</span> <span class="n">data_bits</span> <span class="p">{</span>
		<span class="n">NOT_CLEAR_REGISTERS</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">caldac_channel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/*  chan 0 offset */</span>
		<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">CALDAC0_I2C_ADDR</span><span class="p">;</span>
		<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OFFSET_0_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/*  chan 1 offset */</span>
		<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">CALDAC0_I2C_ADDR</span><span class="p">;</span>
		<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OFFSET_1_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/*  chan 2 offset */</span>
		<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">CALDAC1_I2C_ADDR</span><span class="p">;</span>
		<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OFFSET_0_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:		<span class="cm">/*  chan 3 offset */</span>
		<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">CALDAC1_I2C_ADDR</span><span class="p">;</span>
		<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OFFSET_1_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:		<span class="cm">/*  chan 0 gain */</span>
		<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">CALDAC0_I2C_ADDR</span><span class="p">;</span>
		<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GAIN_0_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:		<span class="cm">/*  chan 1 gain */</span>
		<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">CALDAC0_I2C_ADDR</span><span class="p">;</span>
		<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GAIN_1_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:		<span class="cm">/*  chan 2 gain */</span>
		<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">CALDAC1_I2C_ADDR</span><span class="p">;</span>
		<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GAIN_0_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:		<span class="cm">/*  chan 3 gain */</span>
		<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">CALDAC1_I2C_ADDR</span><span class="p">;</span>
		<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GAIN_1_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid caldac channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOT_CLEAR_REGISTERS</span> <span class="o">|</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">serial_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i2c_addr</span><span class="p">,</span> <span class="n">serial_bytes</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Their i2c requires a huge delay on setting clock or data high for some reason */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">i2c_high_udelay</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">i2c_low_udelay</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="cm">/* set i2c data line high or low */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_set_sda</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">data_bit</span> <span class="o">=</span> <span class="n">CTL_EE_W</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">plx_control_addr</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span>
					 <span class="n">PLX_CONTROL_REG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  set data line high */</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data_bit</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">i2c_high_udelay</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/*  set data line low */</span>

		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">|=</span> <span class="n">data_bit</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">i2c_low_udelay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* set i2c clock line high or low */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_set_scl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">clock_bit</span> <span class="o">=</span> <span class="n">CTL_USERO</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">plx_control_addr</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx9080_iobase</span> <span class="o">+</span>
					 <span class="n">PLX_CONTROL_REG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  set clock line high */</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clock_bit</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">i2c_high_udelay</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/*  set clock line low */</span>

		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">|=</span> <span class="n">clock_bit</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span><span class="p">,</span> <span class="n">plx_control_addr</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">i2c_low_udelay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">bit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;writing to i2c byte 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">num_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">bit</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_set_scl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">))</span>
			<span class="n">i2c_set_sda</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">i2c_set_sda</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">i2c_set_scl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* we can&#39;t really read the lines, so fake it */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_read_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_set_scl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">i2c_set_sda</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">i2c_set_scl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/*  return fake acknowledge bit */</span>
<span class="p">}</span>

<span class="cm">/* send start bit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_set_scl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">i2c_set_sda</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">i2c_set_sda</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* send stop bit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_set_scl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">i2c_set_sda</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">i2c_set_scl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">i2c_set_sda</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">bitstream</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">read_bit</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>

<span class="cm">/* XXX need mutex to prevent simultaneous attempts to access eeprom and i2c bus */</span>

	<span class="cm">/*  make sure we dont send anything to eeprom */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plx_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CTL_EE_CS</span><span class="p">;</span>

	<span class="n">i2c_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">i2c_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*  send address and write bit */</span>
	<span class="n">bitstream</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">read_bit</span><span class="p">;</span>
	<span class="n">i2c_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bitstream</span><span class="p">);</span>

	<span class="cm">/*  get acknowledge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_read_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i2c write failed: no acknowledge&quot;</span><span class="p">);</span>
		<span class="n">i2c_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  write data bytes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_write_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_read_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i2c write failed: no acknowledge&quot;</span><span class="p">);</span>
			<span class="n">i2c_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">i2c_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">cb_pcidas64_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;cb_pcidas64&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cb_pcidas64_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb_pcidas64_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">cb_pcidas64_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">cb_pcidas64_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x001d</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x001e</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0037</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x005d</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x005e</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x005f</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0061</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0063</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0064</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0067</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x006f</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0079</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">cb_pcidas64_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cb_pcidas64_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cb_pcidas64&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">cb_pcidas64_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">cb_pcidas64_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cb_pcidas64_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_pci_driver</span><span class="p">(</span><span class="n">cb_pcidas64_driver</span><span class="p">,</span> <span class="n">cb_pcidas64_pci_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
