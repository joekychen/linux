<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › ni_labpc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ni_labpc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/drivers/ni_labpc.c</span>
<span class="cm">    Driver for National Instruments Lab-PC series boards and compatibles</span>
<span class="cm">    Copyright (C) 2001, 2002, 2003 Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">************************************************************************</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">Driver: ni_labpc</span>
<span class="cm">Description: National Instruments Lab-PC (&amp; compatibles)</span>
<span class="cm">Author: Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;</span>
<span class="cm">Devices: [National Instruments] Lab-PC-1200 (labpc-1200),</span>
<span class="cm">  Lab-PC-1200AI (labpc-1200ai), Lab-PC+ (lab-pc+), PCI-1200 (ni_labpc)</span>
<span class="cm">Status: works</span>

<span class="cm">Tested with lab-pc-1200.  For the older Lab-PC+, not all input ranges</span>
<span class="cm">and analog references will work, the available ranges/arefs will</span>
<span class="cm">depend on how you have configured the jumpers on your board</span>
<span class="cm">(see your owner&#39;s manual).</span>

<span class="cm">Kernel-level ISA plug-and-play support for the lab-pc-1200</span>
<span class="cm">boards has not</span>
<span class="cm">yet been added to the driver, mainly due to the fact that</span>
<span class="cm">I don&#39;t know the device id numbers.  If you have one</span>
<span class="cm">of these boards,</span>
<span class="cm">please file a bug report at http://comedi.org/ </span>
<span class="cm">so I can get the necessary information from you.</span>

<span class="cm">The 1200 series boards have onboard calibration dacs for correcting</span>
<span class="cm">analog input/output offsets and gains.  The proper settings for these</span>
<span class="cm">caldacs are stored on the board&#39;s eeprom.  To read the caldac values</span>
<span class="cm">from the eeprom and store them into a file that can be then be used by</span>
<span class="cm">comedilib, use the comedi_calibrate program.</span>

<span class="cm">Configuration options - ISA boards:</span>
<span class="cm">  [0] - I/O port base address</span>
<span class="cm">  [1] - IRQ (optional, required for timed or externally triggered conversions)</span>
<span class="cm">  [2] - DMA channel (optional)</span>

<span class="cm">Configuration options - PCI boards:</span>
<span class="cm">  [0] - bus (optional)</span>
<span class="cm">  [1] - slot (optional)</span>

<span class="cm">The Lab-pc+ has quirky chanlist requirements</span>
<span class="cm">when scanning multiple channels.  Multiple channel scan</span>
<span class="cm">sequence must start at highest channel, then decrement down to</span>
<span class="cm">channel 0.  The rest of the cards can scan down like lab-pc+ or scan</span>
<span class="cm">up from channel zero.  Chanlists consisting of all one channel</span>
<span class="cm">are also legal, and allow you to pace conversions in bursts.</span>

<span class="cm">*/</span>

<span class="cm">/*</span>

<span class="cm">NI manuals:</span>
<span class="cm">341309a (labpc-1200 register manual)</span>
<span class="cm">340914a (pci-1200)</span>
<span class="cm">320502b (lab-pc+)</span>

<span class="cm">*/</span>

<span class="cp">#undef LABPC_DEBUG</span>
<span class="cm">/* #define LABPC_DEBUG    enable debugging messages */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &quot;8253.h&quot;</span>
<span class="cp">#include &quot;8255.h&quot;</span>
<span class="cp">#include &quot;mite.h&quot;</span>
<span class="cp">#include &quot;comedi_fc.h&quot;</span>
<span class="cp">#include &quot;ni_labpc.h&quot;</span>

<span class="cp">#define DRV_NAME &quot;ni_labpc&quot;</span>

<span class="cm">/* size of io region used by board */</span>
<span class="cp">#define LABPC_SIZE           32</span>
<span class="cm">/* 2 MHz master clock */</span>
<span class="cp">#define LABPC_TIMER_BASE            500</span>

<span class="cm">/* Registers for the lab-pc+ */</span>

<span class="cm">/* write-only registers */</span>
<span class="cp">#define COMMAND1_REG	0x0</span>
<span class="cp">#define   ADC_GAIN_MASK	(0x7 &lt;&lt; 4)</span>
<span class="cp">#define   ADC_CHAN_BITS(x)	((x) &amp; 0x7)</span>
<span class="cm">/* enables multi channel scans */</span>
<span class="cp">#define   ADC_SCAN_EN_BIT	0x80</span>
<span class="cp">#define COMMAND2_REG	0x1</span>
<span class="cm">/* enable pretriggering (used in conjunction with SWTRIG) */</span>
<span class="cp">#define   PRETRIG_BIT	0x1</span>
<span class="cm">/* enable paced conversions on external trigger */</span>
<span class="cp">#define   HWTRIG_BIT	0x2</span>
<span class="cm">/* enable paced conversions */</span>
<span class="cp">#define   SWTRIG_BIT	0x4</span>
<span class="cm">/* use two cascaded counters for pacing */</span>
<span class="cp">#define   CASCADE_BIT	0x8</span>
<span class="cp">#define   DAC_PACED_BIT(channel)	(0x40 &lt;&lt; ((channel) &amp; 0x1))</span>
<span class="cp">#define COMMAND3_REG	0x2</span>
<span class="cm">/* enable dma transfers */</span>
<span class="cp">#define   DMA_EN_BIT	0x1</span>
<span class="cm">/* enable interrupts for 8255 */</span>
<span class="cp">#define   DIO_INTR_EN_BIT	0x2</span>
<span class="cm">/* enable dma terminal count interrupt */</span>
<span class="cp">#define   DMATC_INTR_EN_BIT	0x4</span>
<span class="cm">/* enable timer interrupt */</span>
<span class="cp">#define   TIMER_INTR_EN_BIT	0x8</span>
<span class="cm">/* enable error interrupt */</span>
<span class="cp">#define   ERR_INTR_EN_BIT	0x10</span>
<span class="cm">/* enable fifo not empty interrupt */</span>
<span class="cp">#define   ADC_FNE_INTR_EN_BIT	0x20</span>
<span class="cp">#define ADC_CONVERT_REG	0x3</span>
<span class="cp">#define DAC_LSB_REG(channel)	(0x4 + 2 * ((channel) &amp; 0x1))</span>
<span class="cp">#define DAC_MSB_REG(channel)	(0x5 + 2 * ((channel) &amp; 0x1))</span>
<span class="cp">#define ADC_CLEAR_REG	0x8</span>
<span class="cp">#define DMATC_CLEAR_REG	0xa</span>
<span class="cp">#define TIMER_CLEAR_REG	0xc</span>
<span class="cm">/* 1200 boards only */</span>
<span class="cp">#define COMMAND6_REG	0xe</span>
<span class="cm">/* select ground or common-mode reference */</span>
<span class="cp">#define   ADC_COMMON_BIT	0x1</span>
<span class="cm">/*  adc unipolar */</span>
<span class="cp">#define   ADC_UNIP_BIT	0x2</span>
<span class="cm">/*  dac unipolar */</span>
<span class="cp">#define   DAC_UNIP_BIT(channel)	(0x4 &lt;&lt; ((channel) &amp; 0x1))</span>
<span class="cm">/* enable fifo half full interrupt */</span>
<span class="cp">#define   ADC_FHF_INTR_EN_BIT	0x20</span>
<span class="cm">/* enable interrupt on end of hardware count */</span>
<span class="cp">#define   A1_INTR_EN_BIT	0x40</span>
<span class="cm">/* scan up from channel zero instead of down to zero */</span>
<span class="cp">#define   ADC_SCAN_UP_BIT 0x80</span>
<span class="cp">#define COMMAND4_REG	0xf</span>
<span class="cm">/* enables &#39;interval&#39; scanning */</span>
<span class="cp">#define   INTERVAL_SCAN_EN_BIT	0x1</span>
<span class="cm">/* enables external signal on counter b1 output to trigger scan */</span>
<span class="cp">#define   EXT_SCAN_EN_BIT	0x2</span>
<span class="cm">/* chooses direction (output or input) for EXTCONV* line */</span>
<span class="cp">#define   EXT_CONVERT_OUT_BIT	0x4</span>
<span class="cm">/* chooses differential inputs for adc (in conjunction with board jumper) */</span>
<span class="cp">#define   ADC_DIFF_BIT	0x8</span>
<span class="cp">#define   EXT_CONVERT_DISABLE_BIT	0x10</span>
<span class="cm">/* 1200 boards only, calibration stuff */</span>
<span class="cp">#define COMMAND5_REG	0x1c</span>
<span class="cm">/* enable eeprom for write */</span>
<span class="cp">#define   EEPROM_WRITE_UNPROTECT_BIT	0x4</span>
<span class="cm">/* enable dithering */</span>
<span class="cp">#define   DITHER_EN_BIT	0x8</span>
<span class="cm">/* load calibration dac */</span>
<span class="cp">#define   CALDAC_LOAD_BIT	0x10</span>
<span class="cm">/* serial clock - rising edge writes, falling edge reads */</span>
<span class="cp">#define   SCLOCK_BIT	0x20</span>
<span class="cm">/* serial data bit for writing to eeprom or calibration dacs */</span>
<span class="cp">#define   SDATA_BIT	0x40</span>
<span class="cm">/* enable eeprom for read/write */</span>
<span class="cp">#define   EEPROM_EN_BIT	0x80</span>
<span class="cp">#define INTERVAL_COUNT_REG	0x1e</span>
<span class="cp">#define INTERVAL_LOAD_REG	0x1f</span>
<span class="cp">#define   INTERVAL_LOAD_BITS	0x1</span>

<span class="cm">/* read-only registers */</span>
<span class="cp">#define STATUS1_REG	0x0</span>
<span class="cm">/* data is available in fifo */</span>
<span class="cp">#define   DATA_AVAIL_BIT	0x1</span>
<span class="cm">/* overrun has occurred */</span>
<span class="cp">#define   OVERRUN_BIT	0x2</span>
<span class="cm">/* fifo overflow */</span>
<span class="cp">#define   OVERFLOW_BIT	0x4</span>
<span class="cm">/* timer interrupt has occurred */</span>
<span class="cp">#define   TIMER_BIT	0x8</span>
<span class="cm">/* dma terminal count has occurred */</span>
<span class="cp">#define   DMATC_BIT	0x10</span>
<span class="cm">/* external trigger has occurred */</span>
<span class="cp">#define   EXT_TRIG_BIT	0x40</span>
<span class="cm">/* 1200 boards only */</span>
<span class="cp">#define STATUS2_REG	0x1d</span>
<span class="cm">/* programmable eeprom serial output */</span>
<span class="cp">#define   EEPROM_OUT_BIT	0x1</span>
<span class="cm">/* counter A1 terminal count */</span>
<span class="cp">#define   A1_TC_BIT	0x2</span>
<span class="cm">/* fifo not half full */</span>
<span class="cp">#define   FNHF_BIT	0x4</span>
<span class="cp">#define ADC_FIFO_REG	0xa</span>

<span class="cp">#define DIO_BASE_REG	0x10</span>
<span class="cp">#define COUNTER_A_BASE_REG	0x14</span>
<span class="cp">#define COUNTER_A_CONTROL_REG	(COUNTER_A_BASE_REG + 0x3)</span>
<span class="cm">/* check modes put conversion pacer output in harmless state (a0 mode 2) */</span>
<span class="cp">#define   INIT_A0_BITS	0x14</span>
<span class="cm">/* put hardware conversion counter output in harmless state (a1 mode 0) */</span>
<span class="cp">#define   INIT_A1_BITS	0x70</span>
<span class="cp">#define COUNTER_B_BASE_REG	0x18</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">labpc_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_drain_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">labpc_drain_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_isa_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">labpc_drain_dregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_ao_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_calib_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_calib_write_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_eeprom_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_eeprom_write_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">labpc_adc_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">labpc_suggest_transfer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_COMEDI_PCI_DRIVERS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_dio_mem_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">labpc_serial_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bits</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">labpc_serial_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">labpc_eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">labpc_eeprom_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">labpc_eeprom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">write_caldac</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">scan_mode</span> <span class="p">{</span>
	<span class="n">MODE_SINGLE_CHAN</span><span class="p">,</span>
	<span class="n">MODE_SINGLE_CHAN_INTERVAL</span><span class="p">,</span>
	<span class="n">MODE_MULT_CHAN_UP</span><span class="p">,</span>
	<span class="n">MODE_MULT_CHAN_DOWN</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* analog input ranges */</span>
<span class="cp">#define NUM_LABPC_PLUS_AI_RANGES 16</span>
<span class="cm">/* indicates unipolar ranges */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">labpc_plus_is_unipolar</span><span class="p">[</span><span class="n">NUM_LABPC_PLUS_AI_RANGES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* map range index to gain bits */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">labpc_plus_ai_gain_bits</span><span class="p">[</span><span class="n">NUM_LABPC_PLUS_AI_RANGES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x60</span><span class="p">,</span>
	<span class="mh">0x70</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x60</span><span class="p">,</span>
	<span class="mh">0x70</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_labpc_plus_ai</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">NUM_LABPC_PLUS_AI_RANGES</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.25</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define NUM_LABPC_1200_AI_RANGES 14</span>
<span class="cm">/* indicates unipolar ranges */</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">labpc_1200_is_unipolar</span><span class="p">[</span><span class="n">NUM_LABPC_1200_AI_RANGES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">labpc_1200_is_unipolar</span><span class="p">);</span>

<span class="cm">/* map range index to gain bits */</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">labpc_1200_ai_gain_bits</span><span class="p">[</span><span class="n">NUM_LABPC_1200_AI_RANGES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x60</span><span class="p">,</span>
	<span class="mh">0x70</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x60</span><span class="p">,</span>
	<span class="mh">0x70</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">labpc_1200_ai_gain_bits</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_labpc_1200_ai</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">NUM_LABPC_1200_AI_RANGES</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.25</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">range_labpc_1200_ai</span><span class="p">);</span>

<span class="cm">/* analog output ranges */</span>
<span class="cp">#define AO_RANGE_IS_UNIPOLAR 0x1</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_labpc_ao</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* functions that do inb/outb and readb/writeb so we can use</span>
<span class="cm"> * function pointers to decide which to use */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">labpc_inb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">labpc_outb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">labpc_readb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">labpc_writeb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">labpc_board_struct</span> <span class="n">labpc_boards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lab-pc-1200&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa_bustype</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">register_layout</span> <span class="o">=</span> <span class="n">labpc_1200_layout</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_ao</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_labpc_1200_ai</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_code</span> <span class="o">=</span> <span class="n">labpc_1200_ai_gain_bits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_is_unipolar</span> <span class="o">=</span> <span class="n">labpc_1200_is_unipolar</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_scan_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">memory_mapped_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lab-pc-1200ai&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa_bustype</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">register_layout</span> <span class="o">=</span> <span class="n">labpc_1200_layout</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_ao</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_labpc_1200_ai</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_code</span> <span class="o">=</span> <span class="n">labpc_1200_ai_gain_bits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_is_unipolar</span> <span class="o">=</span> <span class="n">labpc_1200_is_unipolar</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_scan_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">memory_mapped_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lab-pc+&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">12000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa_bustype</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">register_layout</span> <span class="o">=</span> <span class="n">labpc_plus_layout</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_ao</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_labpc_plus_ai</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_code</span> <span class="o">=</span> <span class="n">labpc_plus_ai_gain_bits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_is_unipolar</span> <span class="o">=</span> <span class="n">labpc_plus_is_unipolar</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_scan_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">memory_mapped_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="cp">#ifdef CONFIG_COMEDI_PCI_DRIVERS</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-1200&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x161</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">pci_bustype</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">register_layout</span> <span class="o">=</span> <span class="n">labpc_1200_layout</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_ao</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_labpc_1200_ai</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_code</span> <span class="o">=</span> <span class="n">labpc_1200_ai_gain_bits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_is_unipolar</span> <span class="o">=</span> <span class="n">labpc_1200_is_unipolar</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_scan_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">memory_mapped_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="cm">/* dummy entry so pci board works when comedi_config is passed driver name */</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">pci_bustype</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Useful for shorthand access to the particular board structure</span>
<span class="cm"> */</span>
<span class="cp">#define thisboard ((struct labpc_board_struct *)dev-&gt;board_ptr)</span>

<span class="cm">/* size in bytes of dma buffer */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">dma_buffer_size</span> <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span>
<span class="cm">/* 2 bytes per sample */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sample_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="cp">#define devpriv ((struct labpc_private *)dev-&gt;private)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">driver_labpc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">labpc_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">labpc_common_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_names</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">labpc_boards</span><span class="p">),</span>
	<span class="p">.</span><span class="n">board_name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">labpc_boards</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">labpc_board_struct</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_COMEDI_PCI_DRIVERS</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">labpc_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x161</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">labpc_pci_table</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COMEDI_PCI_DRIVERS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">labpc_counter_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_address</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">counter_number</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">memory_mapped_io</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i8254_mm_load</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">base_address</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">counter_number</span><span class="p">,</span>
				     <span class="n">count</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">i8254_load</span><span class="p">(</span><span class="n">base_address</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">counter_number</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">labpc_common_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">isr_flags</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_flags</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">short</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: ni_labpc: %s, io 0x%lx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
								<span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">iobase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, irq %u&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, dma %u&quot;</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iobase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;io base address is zero!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  request io regions for isa boards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">isa_bustype</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check if io addresses are available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">LABPC_SIZE</span><span class="p">,</span>
				    <span class="n">driver_labpc</span><span class="p">.</span><span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;I/O port conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">memory_mapped_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span> <span class="o">=</span> <span class="n">labpc_readb</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span> <span class="o">=</span> <span class="n">labpc_writeb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span> <span class="o">=</span> <span class="n">labpc_inb</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span> <span class="o">=</span> <span class="n">labpc_outb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* initialize board&#39;s command registers */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND1_REG</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND2_REG</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND3_REG</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND4_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND6_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* grab our IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">pci_bustype</span>
		    <span class="o">||</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">pcmcia_bustype</span><span class="p">)</span>
			<span class="n">isr_flags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">labpc_interrupt</span><span class="p">,</span> <span class="n">isr_flags</span><span class="p">,</span>
				<span class="n">driver_labpc</span><span class="p">.</span><span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to allocate irq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
	<span class="cm">/* grab dma channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; invalid dma channel %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allocate dma buffer */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="n">dma_buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; failed to allocate dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">driver_labpc</span><span class="p">.</span><span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; failed to allocate dma channel %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dma_chan</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">;</span>
		<span class="n">dma_flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dma_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* analog input subdevice */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span>
	    <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_COMMON</span> <span class="o">|</span> <span class="n">SDF_DIFF</span> <span class="o">|</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 12 bit resolution */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_range_table</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">labpc_ai_cmd</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">labpc_ai_cmdtest</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">labpc_ai_rinsn</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">labpc_cancel</span><span class="p">;</span>

	<span class="cm">/* analog output */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">has_ao</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Could provide command support, except it only has a</span>
<span class="cm">		 * one sample hardware buffer for analog output and no</span>
<span class="cm">		 * underrun flag.</span>
<span class="cm">		 */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">NUM_AO_CHAN</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/*  12 bit resolution */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_labpc_ao</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">labpc_ao_rinsn</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">labpc_ao_winsn</span><span class="p">;</span>
		<span class="cm">/* initialize analog outputs to a known value */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">lsb</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAC_LSB_REG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">msb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAC_MSB_REG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 8255 dio */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/*  if board uses io memory we have to give a custom callback</span>
<span class="cm">	 * function to the 8255 driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">memory_mapped_io</span><span class="p">)</span>
		<span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">labpc_dio_mem_callback</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DIO_BASE_REG</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DIO_BASE_REG</span><span class="p">);</span>

	<span class="cm">/*  calibration subdevices for boards that have one */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_CALIB</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">labpc_calib_read_insn</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">labpc_calib_write_insn</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">write_caldac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="cm">/* EEPROM */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_MEMORY</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">EEPROM_SIZE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">labpc_eeprom_read_insn</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">labpc_eeprom_write_insn</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">eeprom_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labpc_eeprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#ifdef LABPC_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; eeprom:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %i:0x%x &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">eeprom_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">labpc_common_attach</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_COMEDI_PCI_DRIVERS</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* allocate and initialize dev-&gt;private */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">labpc_private</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* get base address, irq etc. based on bustype */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">isa_bustype</span>:
<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
		<span class="n">iobase</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">dma_chan</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; this driver has not been built with ISA DMA &quot;</span>
								<span class="s">&quot;support.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_bustype</span>:
<span class="cp">#ifdef CONFIG_COMEDI_PCI_DRIVERS</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">labpc_find_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mite_setup</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">iobase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">mite_irq</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; this driver has not been built with PCI &quot;</span>
								<span class="s">&quot;support.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pcmcia_bustype</span>:
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot; this driver does not support pcmcia cards, use ni_labpc_cs.o</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bug! couldn&#39;t determine board type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">labpc_common_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* adapted from ni_pcimio for finding mite based boards (pc-1200) */</span>
<span class="cp">#ifdef CONFIG_COMEDI_PCI_DRIVERS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mite_struct</span> <span class="o">*</span><span class="n">mite</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mite</span> <span class="o">=</span> <span class="n">mite_devices</span><span class="p">;</span> <span class="n">mite</span><span class="p">;</span> <span class="n">mite</span> <span class="o">=</span> <span class="n">mite</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
<span class="cm">/* if bus/slot are specified then make sure we have the right bus/slot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">||</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">!=</span> <span class="n">mite</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span>
			    <span class="o">||</span> <span class="n">slot</span> <span class="o">!=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">driver_labpc</span><span class="p">.</span><span class="n">num_names</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">labpc_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bustype</span> <span class="o">!=</span> <span class="n">pci_bustype</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mite_device_id</span><span class="p">(</span><span class="n">mite</span><span class="p">)</span> <span class="o">==</span> <span class="n">labpc_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span> <span class="o">=</span> <span class="n">mite</span><span class="p">;</span>
<span class="cm">/* fixup board pointer, in case we were using the dummy &quot;ni_labpc&quot; entry */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">labpc_boards</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;no device found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mite_list_devices</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">labpc_common_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">)</span>
		<span class="n">subdev_8255_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
	<span class="cm">/* only free stuff if it has been allocated by _attach */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">isa_bustype</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">LABPC_SIZE</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_COMEDI_PCI_DRIVERS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">)</span>
		<span class="n">mite_unsetup</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">labpc_common_detach</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">labpc_clear_adc_fifo</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_CLEAR_REG</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_FIFO_REG</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_FIFO_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SWTRIG_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HWTRIG_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PRETRIG_BIT</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND2_REG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND3_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">scan_mode</span> <span class="nf">labpc_ai_scan_mode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MODE_SINGLE_CHAN</span><span class="p">;</span>

	<span class="cm">/* chanlist may be NULL during cmdtest. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MODE_MULT_CHAN_UP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">MODE_SINGLE_CHAN_INTERVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">MODE_MULT_CHAN_UP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">MODE_MULT_CHAN_DOWN</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ni_labpc: bug! this should never happen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_ai_chanlist_invalid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">aref</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_SINGLE_CHAN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_SINGLE_CHAN_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				     <span class="s">&quot;ni_labpc: chanlist too long for single channel interval mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">aref</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MODE_SINGLE_CHAN_INTERVAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;channel scanning order specified in chanlist is not supported by hardware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MODE_MULT_CHAN_UP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;channel scanning order specified in chanlist is not supported by hardware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MODE_MULT_CHAN_DOWN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;channel scanning order specified in chanlist is not supported by hardware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ni_labpc: bug! in chanlist check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">range</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				     <span class="s">&quot;entries in chanlist must all have the same range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">aref</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				     <span class="s">&quot;entries in chanlist must all have the same reference</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_use_continuous_mode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_SINGLE_CHAN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">labpc_ai_convert_period</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_SINGLE_CHAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">labpc_set_ai_convert_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_SINGLE_CHAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&gt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">labpc_ai_scan_period</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_SINGLE_CHAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">labpc_set_ai_scan_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_SINGLE_CHAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stop_mask</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_FOLLOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">stop_mask</span> <span class="o">=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span><span class="p">)</span>
		<span class="n">stop_mask</span> <span class="o">|=</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">stop_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* step 2: make sure trigger sources are unique and mutually compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* can&#39;t have external stop and start triggers at once */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">==</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_speed</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* make sure scan timing is not too fast */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span>
		    <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_speed</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
			    <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_speed</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* stop source */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_COUNT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_NONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * TRIG_EXT doesn&#39;t care since it doesn&#39;t</span>
<span class="cm">		 * trigger off a numbered channel</span>
<span class="cm">		 */</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
	<span class="n">labpc_adc_timing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">||</span> <span class="n">tmp2</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_chanlist_invalid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">aref</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">transfer_type</span> <span class="n">xfer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no irq assigned, cannot perform command&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">aref</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* make sure board is disabled before setting up acquisition */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SWTRIG_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HWTRIG_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PRETRIG_BIT</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND2_REG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND3_REG</span><span class="p">);</span>

	<span class="cm">/*  initialize software conversion count */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>

	<span class="cm">/*  setup hardware conversion counter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * load counter a1 with count of 3</span>
<span class="cm">		 * (pc+ manual says this is minimum allowed) using mode 0</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">labpc_counter_load</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COUNTER_A_BASE_REG</span><span class="p">,</span>
					 <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error loading counter a1&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>			<span class="cm">/*</span>
<span class="cm">				 * otherwise, just put a1 in mode 0</span>
<span class="cm">				 * with no count to set its output low</span>
<span class="cm">				 */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">INIT_A1_BITS</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COUNTER_A_CONTROL_REG</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
	<span class="cm">/*  figure out what method we will use to transfer data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span> <span class="o">&amp;&amp;</span>	<span class="cm">/*  need a dma channel allocated */</span>
		<span class="cm">/*</span>
<span class="cm">		 * dma unsafe at RT priority,</span>
<span class="cm">		 * and too much setup time for TRIG_WAKE_EOS for</span>
<span class="cm">		 */</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRIG_WAKE_EOS</span> <span class="o">|</span> <span class="n">TRIG_RT</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="cm">/*  only available on the isa boards */</span>
	    <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">isa_bustype</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">isa_dma_transfer</span><span class="p">;</span>
		<span class="cm">/* pc-plus has no fifo-half full interrupt */</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span> <span class="o">&amp;&amp;</span>
		   <span class="cm">/*  wake-end-of-scan should interrupt on fifo not empty */</span>
		   <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		   <span class="cm">/*  make sure we are taking more than just a few points */</span>
		   <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">||</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">fifo_half_full_transfer</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">fifo_not_empty_transfer</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">current_transfer</span> <span class="o">=</span> <span class="n">xfer</span><span class="p">;</span>

	<span class="cm">/*  setup command6 register for 1200 boards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  reference inputs to ground or common? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aref</span> <span class="o">!=</span> <span class="n">AREF_GROUND</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">|=</span> <span class="n">ADC_COMMON_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_COMMON_BIT</span><span class="p">;</span>
		<span class="cm">/*  bipolar or unipolar range? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_range_is_unipolar</span><span class="p">[</span><span class="n">range</span><span class="p">])</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">|=</span> <span class="n">ADC_UNIP_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_UNIP_BIT</span><span class="p">;</span>
		<span class="cm">/*  interrupt on fifo half full? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfer</span> <span class="o">==</span> <span class="n">fifo_half_full_transfer</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">|=</span> <span class="n">ADC_FHF_INTR_EN_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_FHF_INTR_EN_BIT</span><span class="p">;</span>
		<span class="cm">/*  enable interrupt on counter a1 terminal count? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">|=</span> <span class="n">A1_INTR_EN_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">A1_INTR_EN_BIT</span><span class="p">;</span>
		<span class="cm">/*  are we scanning up or down through channels? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_MULT_CHAN_UP</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">|=</span> <span class="n">ADC_SCAN_UP_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_SCAN_UP_BIT</span><span class="p">;</span>
		<span class="cm">/*  write to register */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND6_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setup channel list, etc (command1 register) */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_MULT_CHAN_UP</span><span class="p">)</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="cm">/* munge channel bits for differential / scan disabled mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MODE_SINGLE_CHAN</span> <span class="o">&amp;&amp;</span> <span class="n">aref</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span>
		<span class="n">channel</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span> <span class="o">|=</span> <span class="n">ADC_CHAN_BITS</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span> <span class="o">|=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_range_code</span><span class="p">[</span><span class="n">range</span><span class="p">];</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND1_REG</span><span class="p">);</span>
	<span class="cm">/* manual says to set scan enable bit on second pass */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_MULT_CHAN_UP</span> <span class="o">||</span>
	    <span class="n">labpc_ai_scan_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_MULT_CHAN_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span> <span class="o">|=</span> <span class="n">ADC_SCAN_EN_BIT</span><span class="p">;</span>
		<span class="cm">/* need a brief delay before enabling scan, or scan</span>
<span class="cm">		 * list will get screwed when you switch</span>
<span class="cm">		 * between scan up to scan down mode - dunno why */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND1_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*  setup any external triggering/pacing (command4 register) */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span> <span class="o">|=</span> <span class="n">EXT_CONVERT_DISABLE_BIT</span><span class="p">;</span>
	<span class="cm">/* XXX should discard first scan when using interval scanning</span>
<span class="cm">	 * since manual says it is not synced with scan clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_use_continuous_mode</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span> <span class="o">|=</span> <span class="n">INTERVAL_SCAN_EN_BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span> <span class="o">|=</span> <span class="n">EXT_SCAN_EN_BIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  single-ended/differential */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aref</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span> <span class="o">|=</span> <span class="n">ADC_DIFF_BIT</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND4_REG</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">,</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">INTERVAL_COUNT_REG</span><span class="p">);</span>
	<span class="cm">/*  load count */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">INTERVAL_LOAD_BITS</span><span class="p">,</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">INTERVAL_LOAD_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  set up pacing */</span>
		<span class="n">labpc_adc_timing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="cm">/*  load counter b0 in mode 3 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">labpc_counter_load</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COUNTER_B_BASE_REG</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error loading counter b0&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*  set up conversion pacing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_convert_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  load counter a0 in mode 2 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">labpc_counter_load</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COUNTER_A_BASE_REG</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error loading counter a0&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">INIT_A0_BITS</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COUNTER_A_CONTROL_REG</span><span class="p">);</span>

	<span class="cm">/*  set up scan pacing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  load counter b1 in mode 2 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">labpc_counter_load</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COUNTER_B_BASE_REG</span><span class="p">,</span>
					 <span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error loading counter b1&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">labpc_clear_adc_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
	<span class="cm">/*  set up dma transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfer</span> <span class="o">==</span> <span class="n">isa_dma_transfer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="cm">/* clear flip-flop to make sure 2-byte registers for</span>
<span class="cm">		 * count and address get set correctly */</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span>
			     <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">));</span>
		<span class="cm">/*  set appropriate size of transfer */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span> <span class="o">=</span> <span class="n">labpc_suggest_transfer_size</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="n">sample_size</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span> <span class="o">=</span>
			    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="n">sample_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>
		<span class="cm">/*  enable board&#39;s dma */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span> <span class="o">|=</span> <span class="n">DMA_EN_BIT</span> <span class="o">|</span> <span class="n">DMATC_INTR_EN_BIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_EN_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMATC_INTR_EN_BIT</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*  enable error interrupts */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span> <span class="o">|=</span> <span class="n">ERR_INTR_EN_BIT</span><span class="p">;</span>
	<span class="cm">/*  enable fifo not empty interrupt? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfer</span> <span class="o">==</span> <span class="n">fifo_not_empty_transfer</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span> <span class="o">|=</span> <span class="n">ADC_FNE_INTR_EN_BIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_FNE_INTR_EN_BIT</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND3_REG</span><span class="p">);</span>

	<span class="cm">/*  startup acquisition */</span>

	<span class="cm">/*  command2 reg */</span>
	<span class="cm">/*  use 2 cascaded counters for pacing */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">|=</span> <span class="n">CASCADE_BIT</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">|=</span> <span class="n">HWTRIG_BIT</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PRETRIG_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SWTRIG_BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_NOW</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">|=</span> <span class="n">SWTRIG_BIT</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PRETRIG_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HWTRIG_BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug with start_src&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">|=</span> <span class="n">HWTRIG_BIT</span> <span class="o">|</span> <span class="n">PRETRIG_BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_COUNT</span>:
	<span class="k">case</span> <span class="n">TRIG_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug with stop_src&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND2_REG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* interrupt service routine */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">labpc_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;premature interrupt&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* read board status */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">STATUS1_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status2_bits</span> <span class="o">=</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">STATUS2_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMATC_BIT</span> <span class="o">|</span> <span class="n">TIMER_BIT</span> <span class="o">|</span> <span class="n">OVERFLOW_BIT</span> <span class="o">|</span>
				      <span class="n">OVERRUN_BIT</span> <span class="o">|</span> <span class="n">DATA_AVAIL_BIT</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status2_bits</span> <span class="o">&amp;</span> <span class="n">A1_TC_BIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status2_bits</span> <span class="o">&amp;</span> <span class="n">FNHF_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span> <span class="o">&amp;</span> <span class="n">OVERRUN_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear error interrupt */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_CLEAR_REG</span><span class="p">);</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;overrun&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">current_transfer</span> <span class="o">==</span> <span class="n">isa_dma_transfer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * if a dma terminal count of external stop trigger</span>
<span class="cm">		 * has occurred</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span> <span class="o">&amp;</span> <span class="n">DMATC_BIT</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span>
		     <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status2_bits</span> <span class="o">&amp;</span> <span class="n">A1_TC_BIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">handle_isa_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">labpc_drain_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span> <span class="o">&amp;</span> <span class="n">TIMER_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;handled timer interrupt?&quot;</span><span class="p">);</span>
		<span class="cm">/*  clear it */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">TIMER_CLEAR_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span> <span class="o">&amp;</span> <span class="n">OVERFLOW_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  clear error interrupt */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_CLEAR_REG</span><span class="p">);</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;overflow&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  handle external stop trigger */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status2_bits</span> <span class="o">&amp;</span> <span class="n">A1_TC_BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">labpc_drain_dregs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">labpc_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* TRIG_COUNT end of acquisition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">labpc_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* read all available samples from ai fifo */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_drain_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">STATUS1_REG</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span> <span class="o">&amp;</span> <span class="n">DATA_AVAIL_BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  quit if we have all the data we want */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_FIFO_REG</span><span class="p">);</span>
		<span class="n">msb</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_FIFO_REG</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">lsb</span><span class="p">;</span>
		<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span> <span class="o">=</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">STATUS1_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ai timeout, fifo never empties&quot;</span><span class="p">);</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">labpc_drain_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_points</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">leftover</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status1_bits</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="cm">/* clear flip-flop to make sure 2-byte registers for</span>
<span class="cm">	 * count and address get set correctly */</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>

	<span class="cm">/*  figure out how many points to read */</span>
	<span class="n">max_points</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span> <span class="o">/</span> <span class="n">sample_size</span><span class="p">;</span>
	<span class="cm">/* residue is the number of points left to be done on the dma</span>
<span class="cm">	 * transfer.  It should always be zero at this point unless</span>
<span class="cm">	 * the stop_src is set to external triggering.</span>
<span class="cm">	 */</span>
	<span class="n">residue</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">)</span> <span class="o">/</span> <span class="n">sample_size</span><span class="p">;</span>
	<span class="n">num_points</span> <span class="o">=</span> <span class="n">max_points</span> <span class="o">-</span> <span class="n">residue</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">num_points</span> <span class="o">&amp;&amp;</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">num_points</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="cm">/*  figure out how many points will be stored next time */</span>
	<span class="n">leftover</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leftover</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span> <span class="o">/</span> <span class="n">sample_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">num_points</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leftover</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="n">num_points</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leftover</span> <span class="o">&gt;</span> <span class="n">max_points</span><span class="p">)</span>
			<span class="n">leftover</span> <span class="o">=</span> <span class="n">max_points</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write data to comedi buffer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_points</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-=</span> <span class="n">num_points</span><span class="p">;</span>

	<span class="cm">/*  set address and count for next transfer */</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">));</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">leftover</span> <span class="o">*</span> <span class="n">sample_size</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_BLOCK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_isa_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">labpc_drain_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>

	<span class="cm">/*  clear dma tc interrupt */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DMATC_CLEAR_REG</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* makes sure all data acquired by board is transferred to comedi (used</span>
<span class="cm"> * when acquisition is terminated by stop_src == TRIG_EXT). */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">labpc_drain_dregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">current_transfer</span> <span class="o">==</span> <span class="n">isa_dma_transfer</span><span class="p">)</span>
		<span class="n">labpc_drain_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">labpc_drain_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*  disable timed conversions */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SWTRIG_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HWTRIG_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PRETRIG_BIT</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND2_REG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*  disable interrupt generation and dma */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command3_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND3_REG</span><span class="p">);</span>

	<span class="cm">/* set gain and channel */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span> <span class="o">|=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_range_code</span><span class="p">[</span><span class="n">range</span><span class="p">];</span>
	<span class="cm">/* munge channel bits for differential/scan disabled mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span>
		<span class="n">chan</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span> <span class="o">|=</span> <span class="n">ADC_CHAN_BITS</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command1_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND1_REG</span><span class="p">);</span>

	<span class="cm">/* setup command6 register for 1200 boards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  reference inputs to ground or common? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AREF_GROUND</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">|=</span> <span class="n">ADC_COMMON_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_COMMON_BIT</span><span class="p">;</span>
		<span class="cm">/* bipolar or unipolar range? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_range_is_unipolar</span><span class="p">[</span><span class="n">range</span><span class="p">])</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">|=</span> <span class="n">ADC_UNIP_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_UNIP_BIT</span><span class="p">;</span>
		<span class="cm">/* don&#39;t interrupt on fifo half full */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_FHF_INTR_EN_BIT</span><span class="p">;</span>
		<span class="cm">/* don&#39;t enable interrupt on counter a1 terminal count? */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">A1_INTR_EN_BIT</span><span class="p">;</span>
		<span class="cm">/* write to register */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND6_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* setup command4 register */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span> <span class="o">|=</span> <span class="n">EXT_CONVERT_DISABLE_BIT</span><span class="p">;</span>
	<span class="cm">/* single-ended/differential */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span> <span class="o">|=</span> <span class="n">ADC_DIFF_BIT</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command4_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND4_REG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize pacer counter output to make sure it doesn&#39;t</span>
<span class="cm">	 * cause any problems</span>
<span class="cm">	 */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">INIT_A0_BITS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COUNTER_A_CONTROL_REG</span><span class="p">);</span>

	<span class="n">labpc_clear_adc_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* trigger conversion */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_CONVERT_REG</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
					       <span class="n">STATUS1_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DATA_AVAIL_BIT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_FIFO_REG</span><span class="p">);</span>
		<span class="n">msb</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ADC_FIFO_REG</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">lsb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* analog output insn */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* turn off pacing of analog output channel */</span>
	<span class="cm">/* note: hardware bug in daqcard-1200 means pacing cannot</span>
<span class="cm">	 * be independently enabled/disabled for its the two channels */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAC_PACED_BIT</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command2_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND2_REG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* set range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">register_layout</span> <span class="o">==</span> <span class="n">labpc_1200_layout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">&amp;</span> <span class="n">AO_RANGE_IS_UNIPOLAR</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">|=</span> <span class="n">DAC_UNIP_BIT</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAC_UNIP_BIT</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
		<span class="cm">/*  write to register */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command6_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND6_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* send data */</span>
	<span class="n">lsb</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAC_LSB_REG</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">msb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAC_MSB_REG</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

	<span class="cm">/* remember value for readback */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_value</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* analog output readback insn */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_ao_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_value</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_calib_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">caldac</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_calib_write_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="n">write_caldac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_eeprom_read_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">eeprom_data</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_eeprom_write_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*  only allow writes to user area of eeprom */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;eeprom writes are only allowed to channels 16 through 127 (the pointer and user areas)&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">labpc_eeprom_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
<span class="cm">/* utility function that suggests a dma transfer size in bytes */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">labpc_suggest_transfer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">cmd</span><span class="p">.</span><span class="n">convert_arg</span><span class="p">;</span>
	<span class="cm">/* return some default value */</span>
	<span class="k">else</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="cm">/* make buffer fill in no more than 1/3 second */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_size</span><span class="p">;</span>

	<span class="cm">/* set a minimum and maximum size allowed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">dma_buffer_size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">dma_buffer_size</span> <span class="o">-</span> <span class="n">dma_buffer_size</span> <span class="o">%</span> <span class="n">sample_size</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">sample_size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* figures out what counter values to use based on command */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">labpc_adc_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* max value for 16 bit counter in mode 2 */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max_counter_value</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="cm">/* min value for 16 bit counter in mode 2 */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">min_counter_value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base_period</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if both convert and scan triggers are TRIG_TIMER, then they</span>
<span class="cm">	 * both rely on counter b0</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_convert_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">labpc_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * pick the lowest b0 divisor value we can (for maximum input</span>
<span class="cm">		 * clock speed on convert and scan counters)</span>
<span class="cm">		 */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b0</span> <span class="o">=</span> <span class="p">(</span><span class="n">labpc_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
		    <span class="p">(</span><span class="n">LABPC_TIMER_BASE</span> <span class="o">*</span> <span class="n">max_counter_value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b0</span> <span class="o">&lt;</span> <span class="n">min_counter_value</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b0</span> <span class="o">=</span> <span class="n">min_counter_value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b0</span> <span class="o">&gt;</span> <span class="n">max_counter_value</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b0</span> <span class="o">=</span> <span class="n">max_counter_value</span><span class="p">;</span>

		<span class="n">base_period</span> <span class="o">=</span> <span class="n">LABPC_TIMER_BASE</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b0</span><span class="p">;</span>

		<span class="cm">/*  set a0 for conversion frequency and b1 for scan frequency */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">labpc_ai_convert_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span>
			     <span class="p">(</span><span class="n">base_period</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">base_period</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">labpc_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span>
			     <span class="p">(</span><span class="n">base_period</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">base_period</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">labpc_ai_convert_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">base_period</span> <span class="o">-</span>
							     <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">base_period</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">labpc_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">base_period</span> <span class="o">-</span>
							  <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">base_period</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span> <span class="o">=</span>
			    <span class="n">labpc_ai_convert_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">/</span> <span class="n">base_period</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span> <span class="o">=</span>
			    <span class="n">labpc_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">/</span> <span class="n">base_period</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*  make sure a0 and b1 values are acceptable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span> <span class="o">&lt;</span> <span class="n">min_counter_value</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span> <span class="o">=</span> <span class="n">min_counter_value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span> <span class="o">&gt;</span> <span class="n">max_counter_value</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span> <span class="o">=</span> <span class="n">max_counter_value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span> <span class="o">&lt;</span> <span class="n">min_counter_value</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span> <span class="o">=</span> <span class="n">min_counter_value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span> <span class="o">&gt;</span> <span class="n">max_counter_value</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span> <span class="o">=</span> <span class="n">max_counter_value</span><span class="p">;</span>
		<span class="cm">/*  write corrected timings to command */</span>
		<span class="n">labpc_set_ai_convert_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
					    <span class="n">base_period</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span><span class="p">);</span>
		<span class="n">labpc_set_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
					 <span class="n">base_period</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * if only one TRIG_TIMER is used, we can employ the generic</span>
<span class="cm">		 * cascaded timing functions</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scan_period</span><span class="p">;</span>

		<span class="n">scan_period</span> <span class="o">=</span> <span class="n">labpc_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * calculate cascaded counter values</span>
<span class="cm">		 * that give desired scan timing</span>
<span class="cm">		 */</span>
		<span class="n">i8253_cascade_ns_to_timer_2div</span><span class="p">(</span><span class="n">LABPC_TIMER_BASE</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b1</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b0</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="n">scan_period</span><span class="p">,</span>
					       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="n">labpc_set_ai_scan_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">scan_period</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">labpc_ai_convert_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">convert_period</span><span class="p">;</span>

		<span class="n">convert_period</span> <span class="o">=</span> <span class="n">labpc_ai_convert_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * calculate cascaded counter values</span>
<span class="cm">		 * that give desired conversion timing</span>
<span class="cm">		 */</span>
		<span class="n">i8253_cascade_ns_to_timer_2div</span><span class="p">(</span><span class="n">LABPC_TIMER_BASE</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_a0</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor_b0</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="n">convert_period</span><span class="p">,</span>
					       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="n">labpc_set_ai_convert_period</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">convert_period</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_dio_mem_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">port</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">readb</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">port</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* lowlevel write to eeprom/dac */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">labpc_serial_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">value_width</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  clear serial clock */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCLOCK_BIT</span><span class="p">;</span>
		<span class="cm">/*  send bits most significant bit first */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">value_width</span> <span class="o">-</span> <span class="n">i</span><span class="p">)))</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">|=</span> <span class="n">SDATA_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDATA_BIT</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
		<span class="cm">/*  set clock to load bit */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">|=</span> <span class="n">SCLOCK_BIT</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* lowlevel read from eeprom */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">labpc_serial_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">value_width</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/*  number of bits wide values are */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">value_width</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  set serial clock */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">|=</span> <span class="n">SCLOCK_BIT</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
		<span class="cm">/*  clear clock bit */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCLOCK_BIT</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
		<span class="cm">/*  read bits most significant bit first */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status2_bits</span> <span class="o">=</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">STATUS2_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">status2_bits</span> <span class="o">&amp;</span> <span class="n">EEPROM_OUT_BIT</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">value_width</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">labpc_eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="cm">/*  bits to tell eeprom to expect a read */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">read_instruction</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="cm">/*  8 bit write lengths to eeprom */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">write_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/*  enable read/write to eeprom */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_EN_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">|=</span> <span class="n">EEPROM_EN_BIT</span> <span class="o">|</span> <span class="n">EEPROM_WRITE_UNPROTECT_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>

	<span class="cm">/*  send read instruction */</span>
	<span class="n">labpc_serial_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">read_instruction</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
	<span class="cm">/*  send 8 bit address to read from */</span>
	<span class="n">labpc_serial_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
	<span class="cm">/*  read result */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">labpc_serial_in</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*  disable read/write to eeprom */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_EN_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EEPROM_WRITE_UNPROTECT_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">labpc_eeprom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">write_enable_instruction</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">write_instruction</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">write_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/*  8 bit write lengths to eeprom */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">write_in_progress_bit</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*  make sure there isn&#39;t already a write in progress */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">labpc_eeprom_read_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">write_in_progress_bit</span><span class="p">)</span> <span class="o">==</span>
		    <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;eeprom write timed out&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  update software copy of eeprom */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">eeprom_data</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/*  enable read/write to eeprom */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_EN_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">|=</span> <span class="n">EEPROM_EN_BIT</span> <span class="o">|</span> <span class="n">EEPROM_WRITE_UNPROTECT_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>

	<span class="cm">/*  send write_enable instruction */</span>
	<span class="n">labpc_serial_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">write_enable_instruction</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_EN_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>

	<span class="cm">/*  send write instruction */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">|=</span> <span class="n">EEPROM_EN_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
	<span class="n">labpc_serial_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">write_instruction</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
	<span class="cm">/*  send 8 bit address to write to */</span>
	<span class="n">labpc_serial_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
	<span class="cm">/*  write value */</span>
	<span class="n">labpc_serial_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_EN_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>

	<span class="cm">/*  disable read/write to eeprom */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_EN_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EEPROM_WRITE_UNPROTECT_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">labpc_eeprom_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">read_status_instruction</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">write_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/*  8 bit write lengths to eeprom */</span>

	<span class="cm">/*  enable read/write to eeprom */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_EN_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">|=</span> <span class="n">EEPROM_EN_BIT</span> <span class="o">|</span> <span class="n">EEPROM_WRITE_UNPROTECT_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>

	<span class="cm">/*  send read status instruction */</span>
	<span class="n">labpc_serial_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">read_status_instruction</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
	<span class="cm">/*  read result */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">labpc_serial_in</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*  disable read/write to eeprom */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EEPROM_EN_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EEPROM_WRITE_UNPROTECT_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* writes to 8 bit calibration dacs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_caldac</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">caldac</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">caldac</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/*  clear caldac load bit and make sure we don&#39;t write to eeprom */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span>
	    <span class="o">~</span><span class="n">CALDAC_LOAD_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EEPROM_EN_BIT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EEPROM_WRITE_UNPROTECT_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>

	<span class="cm">/*  write 4 bit channel */</span>
	<span class="n">labpc_serial_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/*  write 8 bit caldac value */</span>
	<span class="n">labpc_serial_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/*  set and clear caldac bit to load caldac value */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">|=</span> <span class="n">CALDAC_LOAD_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CALDAC_LOAD_BIT</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">command5_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">COMMAND5_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMEDI_PCI_DRIVERS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">driver_labpc_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_labpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">driver_labpc_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">driver_labpc_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">labpc_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver_labpc_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_labpc_pci_remove</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">driver_labpc_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">comedi_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_labpc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">driver_labpc_pci_driver</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">driver_labpc</span><span class="p">.</span><span class="n">driver_name</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_labpc_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">driver_labpc_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_labpc_pci_driver</span><span class="p">);</span>
	<span class="n">comedi_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_labpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">driver_labpc_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">driver_labpc_cleanup_module</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">driver_labpc_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_labpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">driver_labpc_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_labpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">driver_labpc_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">driver_labpc_cleanup_module</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
