<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › pcl812.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pcl812.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * comedi/drivers/pcl812.c</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Michal Dobes &lt;dobes@tesnet.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * hardware driver for Advantech cards</span>
<span class="cm"> *  card:   PCL-812, PCL-812PG, PCL-813, PCL-813B</span>
<span class="cm"> *  driver: pcl812,  pcl812pg,  pcl813,  pcl813b</span>
<span class="cm"> * and for ADlink cards</span>
<span class="cm"> *  card:   ACL-8112DG, ACL-8112HG, ACL-8112PG, ACL-8113, ACL-8216</span>
<span class="cm"> *  driver: acl8112dg,  acl8112hg,  acl8112pg,  acl8113,  acl8216</span>
<span class="cm"> * and for ICP DAS cards</span>
<span class="cm"> *  card:   ISO-813, A-821PGH, A-821PGL, A-821PGL-NDA, A-822PGH, A-822PGL,</span>
<span class="cm"> *  driver: iso813,  a821pgh,  a-821pgl, a-821pglnda,  a822pgh,  a822pgl,</span>
<span class="cm"> *  card:   A-823PGH, A-823PGL, A-826PG</span>
<span class="cm"> * driver:  a823pgh,  a823pgl,  a826pg</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Driver: pcl812</span>
<span class="cm"> * Description: Advantech PCL-812/PG, PCL-813/B,</span>
<span class="cm"> *	     ADLink ACL-8112DG/HG/PG, ACL-8113, ACL-8216,</span>
<span class="cm"> *	     ICP DAS A-821PGH/PGL/PGL-NDA, A-822PGH/PGL, A-823PGH/PGL, A-826PG,</span>
<span class="cm"> *	     ICP DAS ISO-813</span>
<span class="cm"> * Author: Michal Dobes &lt;dobes@tesnet.cz&gt;</span>
<span class="cm"> * Devices: [Advantech] PCL-812 (pcl812), PCL-812PG (pcl812pg),</span>
<span class="cm"> *	PCL-813 (pcl813), PCL-813B (pcl813b), [ADLink] ACL-8112DG (acl8112dg),</span>
<span class="cm"> *	ACL-8112HG (acl8112hg), ACL-8113 (acl-8113), ACL-8216 (acl8216),</span>
<span class="cm"> *	[ICP] ISO-813 (iso813), A-821PGH (a821pgh), A-821PGL (a821pgl),</span>
<span class="cm"> *	A-821PGL-NDA (a821pclnda), A-822PGH (a822pgh), A-822PGL (a822pgl),</span>
<span class="cm"> *	A-823PGH (a823pgh), A-823PGL (a823pgl), A-826PG (a826pg)</span>
<span class="cm"> * Updated: Mon, 06 Aug 2007 12:03:15 +0100</span>
<span class="cm"> * Status: works (I hope. My board fire up under my hands</span>
<span class="cm"> *	       and I cann&#39;t test all features.)</span>
<span class="cm"> *</span>
<span class="cm"> * This driver supports insn and cmd interfaces. Some boards support only insn</span>
<span class="cm"> * because their hardware don&#39;t allow more (PCL-813/B, ACL-8113, ISO-813).</span>
<span class="cm"> * Data transfer over DMA is supported only when you measure only one</span>
<span class="cm"> * channel, this is too hardware limitation of these boards.</span>
<span class="cm"> *</span>
<span class="cm"> * Options for PCL-812:</span>
<span class="cm"> *   [0] - IO Base</span>
<span class="cm"> *   [1] - IRQ  (0=disable, 2, 3, 4, 5, 6, 7; 10, 11, 12, 14, 15)</span>
<span class="cm"> *   [2] - DMA  (0=disable, 1, 3)</span>
<span class="cm"> *   [3] - 0=trigger source is internal 8253 with 2MHz clock</span>
<span class="cm"> *         1=trigger source is external</span>
<span class="cm"> *   [4] - 0=A/D input range is +/-10V</span>
<span class="cm"> *	   1=A/D input range is +/-5V</span>
<span class="cm"> *	   2=A/D input range is +/-2.5V</span>
<span class="cm"> *	   3=A/D input range is +/-1.25V</span>
<span class="cm"> *	   4=A/D input range is +/-0.625V</span>
<span class="cm"> *	   5=A/D input range is +/-0.3125V</span>
<span class="cm"> *   [5] - 0=D/A outputs 0-5V  (internal reference -5V)</span>
<span class="cm"> *	   1=D/A outputs 0-10V (internal reference -10V)</span>
<span class="cm"> *	   2=D/A outputs unknown (external reference)</span>
<span class="cm"> *</span>
<span class="cm"> * Options for PCL-812PG, ACL-8112PG:</span>
<span class="cm"> *   [0] - IO Base</span>
<span class="cm"> *   [1] - IRQ  (0=disable, 2, 3, 4, 5, 6, 7; 10, 11, 12, 14, 15)</span>
<span class="cm"> *   [2] - DMA  (0=disable, 1, 3)</span>
<span class="cm"> *   [3] - 0=trigger source is internal 8253 with 2MHz clock</span>
<span class="cm"> *	   1=trigger source is external</span>
<span class="cm"> *   [4] - 0=A/D have max +/-5V input</span>
<span class="cm"> *	   1=A/D have max +/-10V input</span>
<span class="cm"> *   [5] - 0=D/A outputs 0-5V  (internal reference -5V)</span>
<span class="cm"> *	   1=D/A outputs 0-10V (internal reference -10V)</span>
<span class="cm"> *	   2=D/A outputs unknown (external reference)</span>
<span class="cm"> *</span>
<span class="cm"> * Options for ACL-8112DG/HG, A-822PGL/PGH, A-823PGL/PGH, ACL-8216, A-826PG:</span>
<span class="cm"> *   [0] - IO Base</span>
<span class="cm"> *   [1] - IRQ  (0=disable, 2, 3, 4, 5, 6, 7; 10, 11, 12, 14, 15)</span>
<span class="cm"> *   [2] - DMA  (0=disable, 1, 3)</span>
<span class="cm"> *   [3] - 0=trigger source is internal 8253 with 2MHz clock</span>
<span class="cm"> *	   1=trigger source is external</span>
<span class="cm"> *   [4] - 0=A/D channels are S.E.</span>
<span class="cm"> *	   1=A/D channels are DIFF</span>
<span class="cm"> *   [5] - 0=D/A outputs 0-5V  (internal reference -5V)</span>
<span class="cm"> *	   1=D/A outputs 0-10V (internal reference -10V)</span>
<span class="cm"> *	   2=D/A outputs unknown (external reference)</span>
<span class="cm"> *</span>
<span class="cm"> * Options for A-821PGL/PGH:</span>
<span class="cm"> *   [0] - IO Base</span>
<span class="cm"> *   [1] - IRQ  (0=disable, 2, 3, 4, 5, 6, 7)</span>
<span class="cm"> *   [2] - 0=A/D channels are S.E.</span>
<span class="cm"> *	   1=A/D channels are DIFF</span>
<span class="cm"> *   [3] - 0=D/A output 0-5V  (internal reference -5V)</span>
<span class="cm"> *	   1=D/A output 0-10V (internal reference -10V)</span>
<span class="cm"> *</span>
<span class="cm"> * Options for A-821PGL-NDA:</span>
<span class="cm"> *   [0] - IO Base</span>
<span class="cm"> *   [1] - IRQ  (0=disable, 2, 3, 4, 5, 6, 7)</span>
<span class="cm"> *   [2] - 0=A/D channels are S.E.</span>
<span class="cm"> *	   1=A/D channels are DIFF</span>
<span class="cm"> *</span>
<span class="cm"> * Options for PCL-813:</span>
<span class="cm"> *   [0] - IO Base</span>
<span class="cm"> *</span>
<span class="cm"> * Options for PCL-813B:</span>
<span class="cm"> *   [0] - IO Base</span>
<span class="cm"> *   [1] - 0= bipolar inputs</span>
<span class="cm"> *	   1= unipolar inputs</span>
<span class="cm"> *</span>
<span class="cm"> * Options for ACL-8113, ISO-813:</span>
<span class="cm"> *   [0] - IO Base</span>
<span class="cm"> *   [1] - 0= 10V bipolar inputs</span>
<span class="cm"> *	   1= 10V unipolar inputs</span>
<span class="cm"> *	   2= 20V bipolar inputs</span>
<span class="cm"> *	   3= 20V unipolar inputs</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &quot;8253.h&quot;</span>

<span class="cm">/* if this is defined then a lot of messages is printed */</span>
<span class="cp">#undef PCL812_EXTDEBUG</span>

<span class="cm">/* hardware types of the cards */</span>
<span class="cp">#define boardPCL812PG	      0	</span><span class="cm">/* and ACL-8112PG */</span><span class="cp"></span>
<span class="cp">#define boardPCL813B	      1</span>
<span class="cp">#define boardPCL812	      2</span>
<span class="cp">#define boardPCL813	      3</span>
<span class="cp">#define boardISO813	      5</span>
<span class="cp">#define boardACL8113	      6</span>
<span class="cp">#define boardACL8112	      7 </span><span class="cm">/* ACL-8112DG/HG, A-822PGL/PGH, A-823PGL/PGH */</span><span class="cp"></span>
<span class="cp">#define boardACL8216	      8	</span><span class="cm">/* and ICP DAS A-826PG */</span><span class="cp"></span>
<span class="cp">#define boardA821	      9	</span><span class="cm">/* PGH, PGL, PGL/NDA versions */</span><span class="cp"></span>

<span class="cp">#define PCLx1x_IORANGE	     16</span>

<span class="cp">#define PCL812_CTR0	      0</span>
<span class="cp">#define PCL812_CTR1	      1</span>
<span class="cp">#define PCL812_CTR2	      2</span>
<span class="cp">#define PCL812_CTRCTL	      3</span>
<span class="cp">#define PCL812_AD_LO	      4</span>
<span class="cp">#define PCL812_DA1_LO	      4</span>
<span class="cp">#define PCL812_AD_HI	      5</span>
<span class="cp">#define PCL812_DA1_HI	      5</span>
<span class="cp">#define PCL812_DA2_LO	      6</span>
<span class="cp">#define PCL812_DI_LO	      6</span>
<span class="cp">#define PCL812_DA2_HI	      7</span>
<span class="cp">#define PCL812_DI_HI	      7</span>
<span class="cp">#define PCL812_CLRINT	      8</span>
<span class="cp">#define PCL812_GAIN	      9</span>
<span class="cp">#define PCL812_MUX	     10</span>
<span class="cp">#define PCL812_MODE	     11</span>
<span class="cp">#define PCL812_CNTENABLE     10</span>
<span class="cp">#define PCL812_SOFTTRIG	     12</span>
<span class="cp">#define PCL812_DO_LO	     13</span>
<span class="cp">#define PCL812_DO_HI	     14</span>

<span class="cp">#define PCL812_DRDY	   0x10	</span><span class="cm">/* =0 data ready */</span><span class="cp"></span>

<span class="cp">#define ACL8216_STATUS	      8	</span><span class="cm">/* 5. bit signalize data ready */</span><span class="cp"></span>

<span class="cp">#define ACL8216_DRDY	   0x20	</span><span class="cm">/* =0 data ready */</span><span class="cp"></span>

<span class="cp">#define MAX_CHANLIST_LEN    256	</span><span class="cm">/* length of scan list */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pcl812pg_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="p">{</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.3125</span><span class="p">),</span>
							    <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pcl812pg2_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range812_bipolar1_25</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
							       <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							       <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range812_bipolar0_625</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
								<span class="n">BIP_RANGE</span>
								<span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
								<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range812_bipolar0_3125</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
								 <span class="n">BIP_RANGE</span>
								 <span class="p">(</span><span class="mf">0.3125</span><span class="p">),</span>
								 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pcl813b_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							   <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pcl813b2_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							    <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							    <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							    <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							    <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							    <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_iso813_1_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="p">{</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.3125</span><span class="p">),</span>
							    <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_iso813_1_2_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="p">{</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							      <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_iso813_2_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							    <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_iso813_2_2_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							      <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_acl8113_1_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_acl8113_1_2_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							       <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_acl8113_2_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_acl8113_2_2_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="p">{</span>
							       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							       <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_acl8112dg_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_acl8112hg_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">12</span><span class="p">,</span> <span class="p">{</span>
							      <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							      <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
							      <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
							      <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.005</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							      <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
							      <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							      <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							      <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							      <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
							      <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_a821pgh_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.005</span><span class="p">),</span>
							   <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pcl812_board</span> <span class="p">{</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>	<span class="cm">/*  board name */</span>
	<span class="kt">int</span> <span class="n">board_type</span><span class="p">;</span>		<span class="cm">/*  type of this board */</span>
	<span class="kt">int</span> <span class="n">n_aichan</span><span class="p">;</span>		<span class="cm">/*  num of AI chans in S.E. */</span>
	<span class="kt">int</span> <span class="n">n_aichan_diff</span><span class="p">;</span>	<span class="cm">/*  DIFF num of chans */</span>
	<span class="kt">int</span> <span class="n">n_aochan</span><span class="p">;</span>		<span class="cm">/*  num of DA chans */</span>
	<span class="kt">int</span> <span class="n">n_dichan</span><span class="p">;</span>		<span class="cm">/*  DI and DO chans */</span>
	<span class="kt">int</span> <span class="n">n_dochan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ai_maxdata</span><span class="p">;</span>		<span class="cm">/*  AI resolution */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_ns_min</span><span class="p">;</span>	<span class="cm">/*  max sample speed of card v ns */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i8254_osc_base</span><span class="p">;</span>	<span class="cm">/*  clock base */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">rangelist_ai</span><span class="p">;</span>	<span class="cm">/*  rangelist for A/D */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">rangelist_ao</span><span class="p">;</span>	<span class="cm">/*  rangelist for D/A */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IRQbits</span><span class="p">;</span>	<span class="cm">/*  allowed IRQ */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DMAbits</span><span class="p">;</span>	<span class="cm">/*  allowed DMA chans */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">io_range</span><span class="p">;</span>	<span class="cm">/*  iorange for this board */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">haveMPC508</span><span class="p">;</span>	<span class="cm">/*  1=board use MPC508A multiplexor */</span>
<span class="p">};</span>

<span class="cp">#define this_board ((const struct pcl812_board *)dev-&gt;board_ptr)</span>

<span class="k">struct</span> <span class="n">pcl812_private</span> <span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valid</span><span class="p">;</span>	<span class="cm">/*  =1 device is OK */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dma</span><span class="p">;</span>	<span class="cm">/*  &gt;0 use dma ( usedDMA channel) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">use_diff</span><span class="p">;</span>	<span class="cm">/*  =1 diff inputs */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">use_MPC</span><span class="p">;</span>	<span class="cm">/*  1=board uses MPC508A multiplexor */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">use_ext_trg</span><span class="p">;</span>	<span class="cm">/*  1=board uses external trigger */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">range_correction</span><span class="p">;</span>	<span class="cm">/*  =1 we must add 1 to range number */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_chan_reg</span><span class="p">;</span>	<span class="cm">/*  lastly used chan/gain pair */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_gain_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mode_reg_int</span><span class="p">;</span>	<span class="cm">/*  there is stored INT number for some card */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ai_neverending</span><span class="p">;</span>	<span class="cm">/*  =1 we do unlimited AI */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ai_eos</span><span class="p">;</span>	<span class="cm">/*  1=EOS wake up */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ai_dma</span><span class="p">;</span>	<span class="cm">/*  =1 we use DMA */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_poll_ptr</span><span class="p">;</span>	<span class="cm">/*  how many sampes transfer poll */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_scans</span><span class="p">;</span>	<span class="cm">/*  len of scanlist */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_act_scan</span><span class="p">;</span>	<span class="cm">/*  how many scans we finished */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_chanlist</span><span class="p">[</span><span class="n">MAX_CHANLIST_LEN</span><span class="p">];</span>	<span class="cm">/*  our copy of channel/range list */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_n_chan</span><span class="p">;</span>	<span class="cm">/*  how many channels is measured */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_flags</span><span class="p">;</span>	<span class="cm">/*  flaglist */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_data_len</span><span class="p">;</span>	<span class="cm">/*  len of data buffer */</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">ai_data</span><span class="p">;</span>		<span class="cm">/*  data buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_is16b</span><span class="p">;</span>	<span class="cm">/*  =1 we have 16 bit card */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dmabuf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  PTR to DMA buf */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmapages</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  how many pages we have allocated */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  HW PTR to DMA buf */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwdmasize</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  DMA buf size in bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  how many bytes DMA transfer */</span>
	<span class="kt">int</span> <span class="n">next_dma_buf</span><span class="p">;</span>	<span class="cm">/*  which buffer is next to use */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_runs_to_end</span><span class="p">;</span>	<span class="cm">/*  how many times we must switch DMA buffers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_dma_run</span><span class="p">;</span>	<span class="cm">/*  how many bytes to transfer on last DMA buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_812_ai_mode0_rangewait</span><span class="p">;</span>	<span class="cm">/*  setling time for gain */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_readback</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  data for AO readback */</span>
<span class="p">};</span>

<span class="cp">#define devpriv ((struct pcl812_private *)dev-&gt;private)</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">start_pacer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor2</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">setup_range_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rangechan</span><span class="p">,</span> <span class="kt">char</span> <span class="n">wait</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pcl812_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="cm">/* select software trigger */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mode_reg_int</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>
	<span class="cm">/*  select channel and renge */</span>
	<span class="n">setup_range_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start conversion */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_SOFTTRIG</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* wait max 50us, it must finish under 33us */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_AD_HI</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="n">PCL812_DRDY</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">conv_finish</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;comedi%d: pcl812: (%s at 0x%lx) A/D insn read timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mode_reg_int</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

<span class="nl">conv_finish:</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_AD_LO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mode_reg_int</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">acl8216_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* select software trigger */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>
	<span class="cm">/*  select channel and renge */</span>
	<span class="n">setup_range_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start conversion */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_SOFTTRIG</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* wait max 50us, it must finish under 33us */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ACL8216_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACL8216_DRDY</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">conv_finish</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;comedi%d: pcl812: (%s at 0x%lx) A/D insn read timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

<span class="nl">conv_finish:</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
			 <span class="n">PCL812_AD_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_AD_LO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_ao_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">?</span> <span class="n">PCL812_DA2_LO</span> <span class="o">:</span> <span class="n">PCL812_DA1_LO</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="p">(</span><span class="n">chan</span> <span class="o">?</span> <span class="n">PCL812_DA2_HI</span> <span class="o">:</span> <span class="n">PCL812_DA1_HI</span><span class="p">));</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_ao_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_di_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DI_LO</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DI_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_do_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DO_LO</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DO_HI</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef PCL812_EXTDEBUG</span>
<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl812_cmdtest_out</span><span class="p">(</span><span class="kt">int</span> <span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcl812 e=%d startsrc=%x scansrc=%x convsrc=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcl812 e=%d startarg=%d scanarg=%d convarg=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcl812 e=%d stopsrc=%x scanend=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcl812 e=%d stoparg=%d scanendarg=%d &quot;</span>
	       <span class="s">&quot;chanlistlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">divisor1</span><span class="p">,</span> <span class="n">divisor2</span><span class="p">;</span>

<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pcl812 EDBG: BGN: pcl812_ai_cmdtest(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pcl812_cmdtest_out</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">use_ext_trg</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
		<span class="n">pcl812_cmdtest_out</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;pcl812 EDBG: BGN: pcl812_ai_cmdtest(...) err=%d ret=1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * step 2: make sure trigger sources are</span>
<span class="cm">	 * unique and mutually compatible</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">use_ext_trg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">=</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">=</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
		<span class="n">pcl812_cmdtest_out</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;pcl812 EDBG: BGN: pcl812_ai_cmdtest(...) err=%d ret=2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TRIG_EXT */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="n">MAX_CHANLIST_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TRIG_NONE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
		<span class="n">pcl812_cmdtest_out</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;pcl812 EDBG: BGN: pcl812_ai_cmdtest(...) err=%d ret=3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor1</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">divisor2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
					  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;pcl812 EDBG: BGN: pcl812_ai_cmdtest(...) err=%d ret=4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">divisor2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dma_flags</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: BGN: pcl812_ai_cmd(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">use_ext_trg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="n">MAX_CHANLIST_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">divisor1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor2</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
					  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  stop pacer */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">);</span>
	<span class="cm">/*  select first channel and range */</span>
	<span class="n">setup_range_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  check if we can use DMA transfer */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/*  we cann&#39;t use DMA :-( */</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*  don&#39;t we want wake up every scan? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_eos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*  DMA is useless for this situation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  we use EOS, so adapt DMA buffer to one scan */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_eos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*  how many samples we must transfer? */</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">*</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>

				<span class="cm">/*  how many DMA pages we must fill */</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">=</span>
					<span class="n">bytes</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

				<span class="cm">/* on last dma transfer must be moved */</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_dma_run</span> <span class="o">=</span>
					<span class="n">bytes</span> <span class="o">%</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_dma_run</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_eos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_eos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
		<span class="n">dma_flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dma_flags</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;pcl812 EDBG:   DMA %d PTR 0x%0x/0x%0x LEN %u/%u EOS %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_eos</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
		<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">divisor1</span><span class="p">,</span> <span class="n">divisor2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span><span class="p">)</span>					<span class="cm">/*  let&#39;s go! */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mode_reg_int</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>
	<span class="k">else</span>							<span class="cm">/*  let&#39;s go! */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mode_reg_int</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>

<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: END: pcl812_ai_cmd(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl812_ai_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_chan</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>		<span class="cm">/* wait max 50us, it must finish under 33us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_is16b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ACL8216_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACL8216_DRDY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x0fff</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_AD_HI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCL812_DRDY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;comedi%d: pcl812: (%s at 0x%lx) &quot;</span>
		     <span class="s">&quot;A/D cmd IRQ without DRDY!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
		<span class="n">pcl812_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_AD_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_AD_LO</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="cm">/* Set up next channel. Added by abbotti 2010-01-20, but untested. */</span>
	<span class="n">next_chan</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_chan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">)</span>
		<span class="n">next_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="p">]</span> <span class="o">!=</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">[</span><span class="n">next_chan</span><span class="p">])</span>
		<span class="n">setup_range_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">[</span><span class="n">next_chan</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="n">next_chan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_chan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* one scan done */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">))</span>
							<span class="cm">/* all data sampled */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pcl812_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">transfer_from_dma_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">short</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/*  get one sample */</span>
		<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">bufptr</span><span class="o">++</span><span class="p">]);</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">)</span>
							<span class="cm">/* all data sampled */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pcl812_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl812_ai_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">;</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: BGN: interrupt_pcl812_ai_dma(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
	    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">;</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
	<span class="n">dma_flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_eos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
			      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
							      <span class="n">next_dma_buf</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_dma_run</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dma_flags</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>

	<span class="n">bufptr</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">transfer_from_dma_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: END: interrupt_pcl812_ai_dma(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl812</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;spurious interrupt&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">interrupt_pcl812_ai_dma</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">interrupt_pcl812_ai_int</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_ai_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  poll is valid only for DMA transfer */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  where is now DMA */</span>
		<span class="n">top1</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span><span class="p">);</span>
		<span class="n">top2</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">top1</span> <span class="o">==</span> <span class="n">top2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top1</span> <span class="o">!=</span> <span class="n">top2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  where is now DMA in buffer */</span>
	<span class="n">top1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabytestomove</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">]</span> <span class="o">-</span> <span class="n">top1</span><span class="p">;</span>
	<span class="n">top1</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/*  sample position */</span>
	<span class="n">top2</span> <span class="o">=</span> <span class="n">top1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/*  no new samples */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">transfer_from_dma_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span>
						      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">],</span>
			      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span><span class="p">,</span> <span class="n">top2</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_poll_ptr</span> <span class="o">=</span> <span class="n">top1</span><span class="p">;</span>	<span class="cm">/*  new buffer position */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_count</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_range_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rangechan</span><span class="p">,</span> <span class="kt">char</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">chan_reg</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">rangechan</span><span class="p">);</span>	<span class="cm">/*  normal board */</span>
							<span class="cm">/*  gain index */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gain_reg</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">rangechan</span><span class="p">)</span> <span class="o">+</span>
				 <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">range_correction</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chan_reg</span> <span class="o">==</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">old_chan_reg</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gain_reg</span> <span class="o">==</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">old_gain_reg</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/*  we can return, no change */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">old_chan_reg</span> <span class="o">=</span> <span class="n">chan_reg</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">old_gain_reg</span> <span class="o">=</span> <span class="n">gain_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">use_MPC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">use_diff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan_reg</span> <span class="o">=</span> <span class="n">chan_reg</span> <span class="o">|</span> <span class="mh">0x30</span><span class="p">;</span>	<span class="cm">/*  DIFF inputs */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan_reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
							<span class="cm">/*  SE inputs 8-15 */</span>
				<span class="n">chan_reg</span> <span class="o">=</span> <span class="n">chan_reg</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="k">else</span>
							<span class="cm">/*  SE inputs 0-7 */</span>
				<span class="n">chan_reg</span> <span class="o">=</span> <span class="n">chan_reg</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">chan_reg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MUX</span><span class="p">);</span>	<span class="cm">/* select channel */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">gain_reg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_GAIN</span><span class="p">);</span>	<span class="cm">/* select gain */</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX this depends on selected range and can be very long for</span>
<span class="cm">		 * some high gain ranges!</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">max_812_ai_mode0_rangewait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_pacer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor2</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: BGN: start_pacer(%d,%u,%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
	       <span class="n">divisor1</span><span class="p">,</span> <span class="n">divisor2</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xb4</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CTRCTL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x74</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CTRCTL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">divisor2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CTR2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">divisor2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CTR2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">divisor1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CTR1</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">divisor1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CTR1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: END: start_pacer(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">free_pages</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">free_pages</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">free_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">io_range</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: BGN: pcl812_ai_cancel(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_dma</span><span class="p">)</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>
							<span class="cm">/* Stop A/D */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mode_reg_int</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>
	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  stop 8254 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: END: pcl812_ai_cancel(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl812_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: BGN: pcl812_reset(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MUX</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">range_correction</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_GAIN</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">old_chan_reg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/*  invalidate chain/gain memory */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">old_gain_reg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">boardPCL812PG</span>:
	<span class="k">case</span> <span class="n">boardPCL812</span>:
	<span class="k">case</span> <span class="n">boardACL8112</span>:
	<span class="k">case</span> <span class="n">boardACL8216</span>:
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DA2_LO</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DA2_HI</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">boardA821</span>:
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DA1_LO</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DA1_HI</span><span class="p">);</span>
		<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  stop 8254 */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DO_HI</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_DO_LO</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mode_reg_int</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_MODE</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL812_CLRINT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">boardPCL813B</span>:
	<span class="k">case</span> <span class="n">boardPCL813</span>:
	<span class="k">case</span> <span class="n">boardISO813</span>:
	<span class="k">case</span> <span class="n">boardACL8113</span>:
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="cp">#ifdef PCL812_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcl812 EDBG: END: pcl812_reset(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl812_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">subdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_subdevices</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi%d: pcl812:  board=%s, ioport=0x%03lx&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">io_range</span><span class="p">,</span> <span class="s">&quot;pcl812&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;I/O port conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcl812_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>	<span class="cm">/* Can&#39;t alloc mem */</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">IRQbits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* board support IRQ */</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* we want to use IRQ */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">IRQbits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;, IRQ %u is out of allowed range, &quot;</span>
				     <span class="s">&quot;DISABLING IT&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
				<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Bad IRQ */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span>
				    <span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">interrupt_pcl812</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pcl812&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;, unable to allocate IRQ %u, &quot;</span>
					     <span class="s">&quot;DISABLING IT&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
					<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Can&#39;t use IRQ */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;, irq=%u&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_dma</span><span class="p">;</span>	<span class="cm">/* if we haven&#39;t IRQ, we can&#39;t use DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">DMAbits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* board support DMA */</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">DMAbits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, DMA is out of allowed range, FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* Bad DMA */</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;pcl812&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;, unable to allocate DMA %u, FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dma</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* DMA isn&#39;t free */</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;, dma=%u&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">pages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* we want 8KB */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">__get_dma_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">pages</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, unable to allocate DMA buffer, FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * maybe experiment with try_to_free_pages()</span>
<span class="cm">			 * will help ....</span>
<span class="cm">			 */</span>
			<span class="n">free_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* no buffer :-( */</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pages</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">__get_dma_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">pages</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;, unable to allocate DMA buffer, FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">free_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pages</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">no_dma:</span>

	<span class="n">n_subdevices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n_subdevices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">subdev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* analog input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">boardA821</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan_diff</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">use_diff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">boardACL8112</span>:
		<span class="k">case</span> <span class="n">boardACL8216</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan_diff</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">use_diff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_maxdata</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">MAX_CHANLIST_LEN</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">rangelist_ai</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">boardACL8216</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">acl8216_ai_insn_read</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pcl812_ai_insn_read</span><span class="p">;</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">use_MPC</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">haveMPC508</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">pcl812_ai_cancel</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">pcl812_ai_cmdtest</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">pcl812_ai_cmd</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">pcl812_ai_poll</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">boardPCL812PG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pcl812pg2_ai</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">boardPCL812</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar10</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar2_5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range812_bipolar1_25</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range812_bipolar0_625</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range812_bipolar0_3125</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar10</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;, incorrect range number %d, changing &quot;</span>
				     <span class="s">&quot;to 0 (+/-10V)&quot;</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">boardPCL813B</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pcl813b2_ai</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">boardISO813</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_iso813_1_ai</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_iso813_1_2_ai</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_iso813_2_ai</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">range_correction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_iso813_2_2_ai</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">range_correction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_iso813_1_ai</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;, incorrect range number %d, &quot;</span>
				     <span class="s">&quot;changing to 0 &quot;</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">boardACL8113</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_acl8113_1_ai</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_acl8113_1_2_ai</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_acl8113_2_ai</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">range_correction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_acl8113_2_2_ai</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">range_correction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_acl8113_1_ai</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;, incorrect range number %d, &quot;</span>
				     <span class="s">&quot;changing to 0 &quot;</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* analog output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">rangelist_ao</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pcl812_ao_insn_read</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">pcl812_ao_insn_write</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">boardA821</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unipolar10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">boardPCL812</span>:
		<span class="k">case</span> <span class="n">boardACL8112</span>:
		<span class="k">case</span> <span class="n">boardPCL812PG</span>:
		<span class="k">case</span> <span class="n">boardACL8216</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unipolar10</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* digital input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">pcl812_di_insn_bits</span><span class="p">;</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* digital output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">pcl812_do_insn_bits</span><span class="p">;</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">boardACL8216</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_is16b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">boardPCL812PG</span>:
	<span class="k">case</span> <span class="n">boardPCL812</span>:
	<span class="k">case</span> <span class="n">boardACL8112</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">max_812_ai_mode0_rangewait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="cm">/*  we use external trigger */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">use_ext_trg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">boardA821</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">max_812_ai_mode0_rangewait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mode_reg_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">boardPCL813B</span>:
	<span class="k">case</span> <span class="n">boardPCL813</span>:
	<span class="k">case</span> <span class="n">boardISO813</span>:
	<span class="k">case</span> <span class="n">boardACL8113</span>:
		<span class="cm">/* maybe there must by greatest timeout */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">max_812_ai_mode0_rangewait</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pcl812_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl812_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcl812_board</span> <span class="n">boardtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;pcl812&quot;</span><span class="p">,</span> <span class="n">boardPCL812</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">33000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_bipolar10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcl812pg&quot;</span><span class="p">,</span> <span class="n">boardPCL812PG</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">33000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl812pg_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;acl8112pg&quot;</span><span class="p">,</span> <span class="n">boardPCL812PG</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl812pg_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;acl8112dg&quot;</span><span class="p">,</span> <span class="n">boardACL8112</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_acl8112dg_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;acl8112hg&quot;</span><span class="p">,</span> <span class="n">boardACL8112</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_acl8112hg_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;a821pgl&quot;</span><span class="p">,</span> <span class="n">boardA821</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl813b_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0x000c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;a821pglnda&quot;</span><span class="p">,</span> <span class="n">boardA821</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl813b_ai</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="mh">0x000c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;a821pgh&quot;</span><span class="p">,</span> <span class="n">boardA821</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_a821pgh_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0x000c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;a822pgl&quot;</span><span class="p">,</span> <span class="n">boardACL8112</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_acl8112dg_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;a822pgh&quot;</span><span class="p">,</span> <span class="n">boardACL8112</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_acl8112hg_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;a823pgl&quot;</span><span class="p">,</span> <span class="n">boardACL8112</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">8000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_acl8112dg_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;a823pgh&quot;</span><span class="p">,</span> <span class="n">boardACL8112</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">8000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_acl8112hg_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcl813&quot;</span><span class="p">,</span> <span class="n">boardPCL813</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl813b_ai</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcl813b&quot;</span><span class="p">,</span> <span class="n">boardPCL813B</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl813b_ai</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;acl8113&quot;</span><span class="p">,</span> <span class="n">boardACL8113</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_acl8113_1_ai</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;iso813&quot;</span><span class="p">,</span> <span class="n">boardISO813</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span>
	 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_iso813_1_ai</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;acl8216&quot;</span><span class="p">,</span> <span class="n">boardACL8216</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl813b2_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;a826pg&quot;</span><span class="p">,</span> <span class="n">boardACL8216</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
	 <span class="mi">10000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl813b2_ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="mh">0xdcfc</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">PCLx1x_IORANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">pcl812_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;pcl812&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">pcl812_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">pcl812_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">board_name</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">boardtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_names</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">boardtypes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcl812_board</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_driver</span><span class="p">(</span><span class="n">pcl812_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
