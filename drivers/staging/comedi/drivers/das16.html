<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › das16.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>das16.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/drivers/das16.c</span>
<span class="cm">    DAS16 driver</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 2000 David A. Schleef &lt;ds@schleef.org&gt;</span>
<span class="cm">    Copyright (C) 2000 Chris R. Baugher &lt;baugher@enteract.com&gt;</span>
<span class="cm">    Copyright (C) 2001,2002 Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">************************************************************************</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">Driver: das16</span>
<span class="cm">Description: DAS16 compatible boards</span>
<span class="cm">Author: Sam Moore, Warren Jasper, ds, Chris Baugher, Frank Hess, Roman Fietze</span>
<span class="cm">Devices: [Keithley Metrabyte] DAS-16 (das-16), DAS-16G (das-16g),</span>
<span class="cm">  DAS-16F (das-16f), DAS-1201 (das-1201), DAS-1202 (das-1202),</span>
<span class="cm">  DAS-1401 (das-1401), DAS-1402 (das-1402), DAS-1601 (das-1601),</span>
<span class="cm">  DAS-1602 (das-1602),</span>
<span class="cm">  [ComputerBoards] PC104-DAS16/JR (pc104-das16jr),</span>
<span class="cm">  PC104-DAS16JR/16 (pc104-das16jr/16),</span>
<span class="cm">  CIO-DAS16JR/16 (cio-das16jr/16),</span>
<span class="cm">  CIO-DAS16/JR (cio-das16/jr), CIO-DAS1401/12 (cio-das1401/12),</span>
<span class="cm">  CIO-DAS1402/12 (cio-das1402/12), CIO-DAS1402/16 (cio-das1402/16),</span>
<span class="cm">  CIO-DAS1601/12 (cio-das1601/12), CIO-DAS1602/12 (cio-das1602/12),</span>
<span class="cm">  CIO-DAS1602/16 (cio-das1602/16), CIO-DAS16/330 (cio-das16/330)</span>
<span class="cm">Status: works</span>
<span class="cm">Updated: 2003-10-12</span>

<span class="cm">A rewrite of the das16 and das1600 drivers.</span>
<span class="cm">Options:</span>
<span class="cm">	[0] - base io address</span>
<span class="cm">	[1] - irq (does nothing, irq is not used anymore)</span>
<span class="cm">	[2] - dma (optional, required for comedi_command support)</span>
<span class="cm">	[3] - master clock speed in MHz (optional, 1 or 10, ignored if</span>
<span class="cm">		board can probe clock, defaults to 1)</span>
<span class="cm">	[4] - analog input range lowest voltage in microvolts (optional,</span>
<span class="cm">		only useful if your board does not have software</span>
<span class="cm">		programmable gain)</span>
<span class="cm">	[5] - analog input range highest voltage in microvolts (optional,</span>
<span class="cm">		only useful if board does not have software programmable</span>
<span class="cm">		gain)</span>
<span class="cm">	[6] - analog output range lowest voltage in microvolts (optional)</span>
<span class="cm">	[7] - analog output range highest voltage in microvolts (optional)</span>
<span class="cm">	[8] - use timer mode for DMA.  Timer mode is needed e.g. for</span>
<span class="cm">		buggy DMA controllers in NS CS5530A (Geode Companion), and for</span>
<span class="cm">		&#39;jr&#39; cards that lack a hardware fifo.  This option is no</span>
<span class="cm">		longer needed, since timer mode is _always_ used.</span>

<span class="cm">Passing a zero for an option is the same as leaving it unspecified.</span>

<span class="cm">*/</span>
<span class="cm">/*</span>

<span class="cm">Testing and debugging help provided by Daniel Koch.</span>

<span class="cm">Keithley Manuals:</span>
<span class="cm">	2309.PDF (das16)</span>
<span class="cm">	4919.PDF (das1400, 1600)</span>
<span class="cm">	4922.PDF (das-1400)</span>
<span class="cm">	4923.PDF (das1200, 1400, 1600)</span>

<span class="cm">Computer boards manuals also available from their website</span>
<span class="cm">www.measurementcomputing.com</span>

<span class="cm">*/</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &quot;8253.h&quot;</span>
<span class="cp">#include &quot;8255.h&quot;</span>
<span class="cp">#include &quot;comedi_fc.h&quot;</span>

<span class="cp">#undef DEBUG</span>
<span class="cm">/* #define DEBUG */</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DEBUG_PRINT(format, args...)	\</span>
<span class="cp">	printk(KERN_DEBUG &quot;das16: &quot; format, ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define DEBUG_PRINT(format, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#define DAS16_SIZE 20		</span><span class="cm">/*  number of ioports */</span><span class="cp"></span>
<span class="cp">#define DAS16_DMA_SIZE 0xff00	</span><span class="cm">/*  size in bytes of allocated dma buffer */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm">    cio-das16.pdf</span>

<span class="cm">    &quot;das16&quot;</span>
<span class="cm">    &quot;das16/f&quot;</span>

<span class="cm">  0	a/d bits 0-3		start 12 bit</span>
<span class="cm">  1	a/d bits 4-11		unused</span>
<span class="cm">  2	mux read		mux set</span>
<span class="cm">  3	di 4 bit		do 4 bit</span>
<span class="cm">  4	unused			ao0_lsb</span>
<span class="cm">  5	unused			ao0_msb</span>
<span class="cm">  6	unused			ao1_lsb</span>
<span class="cm">  7	unused			ao1_msb</span>
<span class="cm">  8	status eoc uni/bip	interrupt reset</span>
<span class="cm">  9	dma, int, trig ctrl	set dma, int</span>
<span class="cm">  a	pacer control		unused</span>
<span class="cm">  b	reserved		reserved</span>
<span class="cm">  cdef	8254</span>
<span class="cm">  0123	8255</span>

<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">    cio-das16jr.pdf</span>

<span class="cm">    &quot;das16jr&quot;</span>

<span class="cm">  0	a/d bits 0-3		start 12 bit</span>
<span class="cm">  1	a/d bits 4-11		unused</span>
<span class="cm">  2	mux read		mux set</span>
<span class="cm">  3	di 4 bit		do 4 bit</span>
<span class="cm">  4567	unused			unused</span>
<span class="cm">  8	status eoc uni/bip	interrupt reset</span>
<span class="cm">  9	dma, int, trig ctrl	set dma, int</span>
<span class="cm">  a	pacer control		unused</span>
<span class="cm">  b	gain status		gain control</span>
<span class="cm">  cdef	8254</span>

<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">    cio-das16jr_16.pdf</span>

<span class="cm">    &quot;das16jr_16&quot;</span>

<span class="cm">  0	a/d bits 0-7		start 16 bit</span>
<span class="cm">  1	a/d bits 8-15		unused</span>
<span class="cm">  2	mux read		mux set</span>
<span class="cm">  3	di 4 bit		do 4 bit</span>
<span class="cm">  4567	unused			unused</span>
<span class="cm">  8	status eoc uni/bip	interrupt reset</span>
<span class="cm">  9	dma, int, trig ctrl	set dma, int</span>
<span class="cm">  a	pacer control		unused</span>
<span class="cm">  b	gain status		gain control</span>
<span class="cm">  cdef	8254</span>

<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">    cio-das160x-1x.pdf</span>

<span class="cm">    &quot;das1601/12&quot;</span>
<span class="cm">    &quot;das1602/12&quot;</span>
<span class="cm">    &quot;das1602/16&quot;</span>

<span class="cm">  0	a/d bits 0-3		start 12 bit</span>
<span class="cm">  1	a/d bits 4-11		unused</span>
<span class="cm">  2	mux read		mux set</span>
<span class="cm">  3	di 4 bit		do 4 bit</span>
<span class="cm">  4	unused			ao0_lsb</span>
<span class="cm">  5	unused			ao0_msb</span>
<span class="cm">  6	unused			ao1_lsb</span>
<span class="cm">  7	unused			ao1_msb</span>
<span class="cm">  8	status eoc uni/bip	interrupt reset</span>
<span class="cm">  9	dma, int, trig ctrl	set dma, int</span>
<span class="cm">  a	pacer control		unused</span>
<span class="cm">  b	gain status		gain control</span>
<span class="cm">  cdef	8254</span>
<span class="cm">  400	8255</span>
<span class="cm">  404	unused			conversion enable</span>
<span class="cm">  405	unused			burst enable</span>
<span class="cm">  406	unused			das1600 enable</span>
<span class="cm">  407	status</span>

<span class="cm">*/</span>

<span class="cm">/*  size in bytes of a sample from board */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sample_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="cp">#define DAS16_TRIG		0</span>
<span class="cp">#define DAS16_AI_LSB		0</span>
<span class="cp">#define DAS16_AI_MSB		1</span>
<span class="cp">#define DAS16_MUX		2</span>
<span class="cp">#define DAS16_DIO		3</span>
<span class="cp">#define DAS16_AO_LSB(x)	((x) ? 6 : 4)</span>
<span class="cp">#define DAS16_AO_MSB(x)	((x) ? 7 : 5)</span>
<span class="cp">#define DAS16_STATUS		8</span>
<span class="cp">#define   BUSY			(1&lt;&lt;7)</span>
<span class="cp">#define   UNIPOLAR			(1&lt;&lt;6)</span>
<span class="cp">#define   DAS16_MUXBIT			(1&lt;&lt;5)</span>
<span class="cp">#define   DAS16_INT			(1&lt;&lt;4)</span>
<span class="cp">#define DAS16_CONTROL		9</span>
<span class="cp">#define   DAS16_INTE			(1&lt;&lt;7)</span>
<span class="cp">#define   DAS16_IRQ(x)			(((x) &amp; 0x7) &lt;&lt; 4)</span>
<span class="cp">#define   DMA_ENABLE			(1&lt;&lt;2)</span>
<span class="cp">#define   PACING_MASK	0x3</span>
<span class="cp">#define   INT_PACER		0x03</span>
<span class="cp">#define   EXT_PACER			0x02</span>
<span class="cp">#define   DAS16_SOFT		0x00</span>
<span class="cp">#define DAS16_PACER		0x0A</span>
<span class="cp">#define   DAS16_CTR0			(1&lt;&lt;1)</span>
<span class="cp">#define   DAS16_TRIG0			(1&lt;&lt;0)</span>
<span class="cp">#define   BURST_LEN_BITS(x)			(((x) &amp; 0xf) &lt;&lt; 4)</span>
<span class="cp">#define DAS16_GAIN		0x0B</span>
<span class="cp">#define DAS16_CNTR0_DATA		0x0C</span>
<span class="cp">#define DAS16_CNTR1_DATA		0x0D</span>
<span class="cp">#define DAS16_CNTR2_DATA		0x0E</span>
<span class="cp">#define DAS16_CNTR_CONTROL	0x0F</span>
<span class="cp">#define   DAS16_TERM_CNT	0x00</span>
<span class="cp">#define   DAS16_ONE_SHOT	0x02</span>
<span class="cp">#define   DAS16_RATE_GEN	0x04</span>
<span class="cp">#define   DAS16_CNTR_LSB_MSB	0x30</span>
<span class="cp">#define   DAS16_CNTR0		0x00</span>
<span class="cp">#define   DAS16_CNTR1		0x40</span>
<span class="cp">#define   DAS16_CNTR2		0x80</span>

<span class="cp">#define DAS1600_CONV		0x404</span>
<span class="cp">#define   DAS1600_CONV_DISABLE		0x40</span>
<span class="cp">#define DAS1600_BURST		0x405</span>
<span class="cp">#define   DAS1600_BURST_VAL		0x40</span>
<span class="cp">#define DAS1600_ENABLE		0x406</span>
<span class="cp">#define   DAS1600_ENABLE_VAL		0x40</span>
<span class="cp">#define DAS1600_STATUS_B	0x407</span>
<span class="cp">#define   DAS1600_BME		0x40</span>
<span class="cp">#define   DAS1600_ME		0x20</span>
<span class="cp">#define   DAS1600_CD			0x10</span>
<span class="cp">#define   DAS1600_WS			0x02</span>
<span class="cp">#define   DAS1600_CLK_10MHZ		0x01</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_das1x01_bip</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
							    <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_das1x01_unip</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_das1x02_bip</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							    <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							    <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_das1x02_unip</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_das16jr</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span>
						<span class="cm">/*  also used by 16/330 */</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							<span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							<span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							<span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							<span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_das16jr_16</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="p">{</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							   <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">das16jr_gainlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">das16jr_16_gainlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">das1600_gainlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">das16_pg_none</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">das16_pg_16jr</span><span class="p">,</span>
	<span class="n">das16_pg_16jr_16</span><span class="p">,</span>
	<span class="n">das16_pg_1601</span><span class="p">,</span>
	<span class="n">das16_pg_1602</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="k">const</span> <span class="n">das16_gainlists</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="n">das16jr_gainlist</span><span class="p">,</span>
	<span class="n">das16jr_16_gainlist</span><span class="p">,</span>
	<span class="n">das1600_gainlist</span><span class="p">,</span>
	<span class="n">das1600_gainlist</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="k">const</span> <span class="n">das16_ai_uni_lranges</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das16jr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das16jr_16</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das1x01_unip</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das1x02_unip</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="k">const</span> <span class="n">das16_ai_bip_lranges</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das16jr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das16jr_16</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das1x01_bip</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das1x02_bip</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">munge_info</span> <span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">byte</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">have_byte</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">das16_board</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ai</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_nbits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_speed</span><span class="p">;</span>	<span class="cm">/*  max conversion speed in nanosec */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_pg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ao</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_nbits</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">do_</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i8255_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i8254_offset</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DAS16_TIMEOUT 1000</span>

<span class="cm">/* Period for timer interrupt in jiffies.  It&#39;s a function</span>
<span class="cm"> * to deal with possibility of dynamic HZ patches  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">timer_period</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">20</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">das16_private_struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_unipolar</span><span class="p">;</span>	<span class="cm">/*  unipolar flag */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_singleended</span><span class="p">;</span>	<span class="cm">/*  single ended flag */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clockbase</span><span class="p">;</span>	<span class="cm">/*  master clock speed in ns */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_state</span><span class="p">;</span>	<span class="cm">/*  dma, interrupt and trigger control bits */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adc_byte_count</span><span class="p">;</span>	<span class="cm">/*  number of bytes remaining */</span>
	<span class="cm">/*  divisor dividing master clock to get conversion frequency */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span><span class="p">;</span>
	<span class="cm">/*  divisor dividing master clock to get conversion frequency */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_chan</span><span class="p">;</span>	<span class="cm">/*  dma channel */</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">dma_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_buffer_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">current_buffer</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_transfer_size</span><span class="p">;</span>	<span class="cm">/*  target number of bytes to transfer per dma shot */</span>
	<span class="cm">/**</span>
<span class="cm">	 * user-defined analog input and output ranges</span>
<span class="cm">	 * defined from config options</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">user_ai_range_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">user_ao_range_table</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>	<span class="cm">/*  for timed interrupt */</span>
	<span class="k">volatile</span> <span class="kt">short</span> <span class="n">timer_running</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">short</span> <span class="n">timer_mode</span><span class="p">;</span>	<span class="cm">/*  true if using timer mode */</span>
<span class="p">};</span>
<span class="cp">#define devpriv ((struct das16_private_struct *)(dev-&gt;private))</span>
<span class="cp">#define thisboard ((struct das16_board *)(dev-&gt;board_ptr))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das16_cmd_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gain</span><span class="p">,</span> <span class="n">start_chan</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* make sure triggers are valid */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
	<span class="cm">/*  if board supports burst mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="cm">/*  if board supports burst mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * step 2: make sure trigger sources are unique and</span>
<span class="cm">	 * mutually compatible</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*  make sure scan_begin_src and convert_src dont conflict */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* internal trigger */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  check against maximum frequency */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span>
		    <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_speed</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
			    <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_speed</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_speed</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/*  step 4: fix up arguments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="cm">/*  set divisors, correct timing arguments */</span>
		<span class="n">i8253_cascade_ns_to_timer_2div</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clockbase</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor1</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor2</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">),</span>
					       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
		<span class="cm">/*  set divisors, correct timing arguments */</span>
		<span class="n">i8253_cascade_ns_to_timer_2div</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clockbase</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor1</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor2</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">),</span>
					       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*  check channel/gain list against card&#39;s limitations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gain</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">start_chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span>
			    <span class="p">(</span><span class="n">start_chan</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;entries in chanlist must be &quot;</span>
						<span class="s">&quot;consecutive channels, &quot;</span>
						<span class="s">&quot;counting upwards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">gain</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;entries in chanlist must all &quot;</span>
						<span class="s">&quot;have the same gain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* utility function that suggests a dma transfer size in bytes */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">das16_suggest_transfer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>

	<span class="cm">/* if we are using timer interrupt, we don&#39;t care how long it</span>
<span class="cm">	 * will take to complete transfer since it will be interrupted</span>
<span class="cm">	 * by timer interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DAS16_DMA_SIZE</span><span class="p">;</span>

	<span class="cm">/* otherwise, we are relying on dma terminal count interrupt,</span>
<span class="cm">	 * so pick a reasonable size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">cmd</span><span class="p">.</span><span class="n">convert_arg</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000000</span> <span class="o">/</span> <span class="n">cmd</span><span class="p">.</span><span class="n">scan_begin_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">.</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="cm">/*  return some default value */</span>
	<span class="k">else</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">sample_size</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">.</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*  make buffer fill in no more than 1/3 second */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  set a minimum and maximum size allowed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">DAS16_DMA_SIZE</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">DAS16_DMA_SIZE</span> <span class="o">-</span> <span class="n">DAS16_DMA_SIZE</span> <span class="o">%</span> <span class="n">sample_size</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">sample_size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">adc_byte_count</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">adc_byte_count</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">das16_set_pacer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">rounding_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i8253_cascade_ns_to_timer_2div</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clockbase</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor1</span><span class="p">),</span>
				       <span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ns</span><span class="p">,</span>
				       <span class="n">rounding_flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>

	<span class="cm">/* Write the values of ctr1 and ctr2 into counters 1 and 2 */</span>
	<span class="n">i8254_load</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CNTR0_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">i8254_load</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CNTR0_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">divisor2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das16_cmd_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">range</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span>
				       <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;irq (or use of &#39;timer mode&#39;) dma required to &quot;</span>
							<span class="s">&quot;execute comedi_cmd&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_RT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isa dma transfers cannot be performed with &quot;</span>
							<span class="s">&quot;TRIG_RT, aborting&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">adc_byte_count</span> <span class="o">=</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">);</span>

	<span class="cm">/*  disable conversions for das1600 mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">DAS1600_CONV_DISABLE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_CONV</span><span class="p">);</span>

	<span class="cm">/*  set scan limits */</span>
	<span class="n">byte</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">byte</span> <span class="o">|=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_MUX</span><span class="p">);</span>

	<span class="cm">/* set gain (this is also burst rate register but according to</span>
<span class="cm">	 * computer boards manual, burst rate does nothing, even on</span>
<span class="cm">	 * keithley cards) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_pg</span> <span class="o">!=</span> <span class="n">das16_pg_none</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">das16_gainlists</span><span class="p">[</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_pg</span><span class="p">])[</span><span class="n">range</span><span class="p">],</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_GAIN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set counter mode and counts */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span>
	    <span class="n">das16_set_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;pacer period: %d ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">);</span>

	<span class="cm">/* enable counters */</span>
	<span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Enable burst mode if appropriate. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">DAS1600_BURST_VAL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_BURST</span><span class="p">);</span>
			<span class="cm">/*  set burst length */</span>
			<span class="n">byte</span> <span class="o">|=</span> <span class="n">BURST_LEN_BITS</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_BURST</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_PACER</span><span class="p">);</span>

	<span class="cm">/*  set up dma transfer */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="cm">/* clear flip-flop to make sure 2-byte registers for</span>
<span class="cm">	 * count and address get set correctly */</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">current_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer_addr</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">current_buffer</span><span class="p">]);</span>
	<span class="cm">/*  set appropriate size of transfer */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span> <span class="o">=</span> <span class="n">das16_suggest_transfer_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*  set up interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timer_period</span><span class="p">();</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAS16_INTE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* clear interrupt bit */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_STATUS</span><span class="p">);</span>
		<span class="cm">/* enable interrupts */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">|=</span> <span class="n">DAS16_INTE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">|=</span> <span class="n">DMA_ENABLE</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PACING_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">|=</span> <span class="n">EXT_PACER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">|=</span> <span class="n">INT_PACER</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CONTROL</span><span class="p">);</span>

	<span class="cm">/* Enable conversions if using das1600 mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_CONV</span><span class="p">);</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das16_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* disable interrupts, dma and pacer clocked conversions */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAS16_INTE</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PACING_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_ENABLE</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">)</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>

	<span class="cm">/*  disable SW timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_mode</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable burst mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_BURST</span><span class="p">);</span>


	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">das16_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_STATUS</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CONTROL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_PACER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CNTR_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das16_ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msb</span><span class="p">,</span> <span class="n">lsb</span><span class="p">;</span>

	<span class="cm">/*  disable interrupts and pacing */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAS16_INTE</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_ENABLE</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PACING_MASK</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CONTROL</span><span class="p">);</span>

	<span class="cm">/* set multiplexer */</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">|=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_MUX</span><span class="p">);</span>

	<span class="cm">/* set gain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_pg</span> <span class="o">!=</span> <span class="n">das16_pg_none</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">das16_gainlists</span><span class="p">[</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_pg</span><span class="p">])[</span><span class="n">range</span><span class="p">],</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_GAIN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* trigger conversion */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_TRIG</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DAS16_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BUSY</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">DAS16_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;das16: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msb</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_AI_MSB</span><span class="p">);</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_AI_LSB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_nbits</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lsb</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">lsb</span> <span class="o">|</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das16_di_rbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_DIO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das16_do_wbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wbits</span><span class="p">;</span>

	<span class="cm">/*  only set bits that have been masked */</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">wbits</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="cm">/*  zero bits that have been masked */</span>
	<span class="n">wbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/*  set masked bits */</span>
	<span class="n">wbits</span> <span class="o">|=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">wbits</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wbits</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_DIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das16_ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_nbits</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lsb</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lsb</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_AO_LSB</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">msb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_AO_MSB</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* the pc104-das16jr (at least) has problems if the dma</span>
<span class="cm">	transfer is interrupted in the middle of transferring</span>
<span class="cm">	a 16 bit sample, so this function takes care to get</span>
<span class="cm">	an even transfer count after disabling dma</span>
<span class="cm">	channel.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">disable_dma_on_even</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">residue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">disable_limit</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">enable_timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">residue</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">disable_limit</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">residue</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">enable_timeout</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">new_residue</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">new_residue</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_residue</span> <span class="o">!=</span> <span class="n">residue</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="n">residue</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">disable_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get an even dma transfer, &quot;</span>
							<span class="s">&quot;could be trouble.&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">residue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">das16_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_flags</span><span class="p">,</span> <span class="n">spin_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_bytes</span><span class="p">,</span> <span class="n">residue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buffer_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;premature interrupt&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  initialize async here to make sure it is not NULL */</span>
	<span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt with no dma channel?&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">spin_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">&amp;</span> <span class="n">DMA_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">spin_flags</span><span class="p">);</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;interrupt while dma disabled?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">residue</span> <span class="o">=</span> <span class="n">disable_dma_on_even</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*  figure out how many points to read */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">residue</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;residue &gt; transfer size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">num_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span> <span class="o">-</span> <span class="n">residue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span>
					<span class="n">num_bytes</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">adc_byte_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">adc_byte_count</span><span class="p">;</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer_index</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">current_buffer</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">current_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">current_buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">adc_byte_count</span> <span class="o">-=</span> <span class="n">num_bytes</span><span class="p">;</span>

	<span class="cm">/*  figure out how many bytes for next transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">adc_byte_count</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">adc_byte_count</span><span class="p">;</span>

	<span class="cm">/*  re-enable  dma */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">COMEDI_CB_EOA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer_addr</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">current_buffer</span><span class="p">]);</span>
		<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_transfer_size</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="cm">/* reenable conversions for das1600 mode, (stupid hardware) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x400</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_CONV</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dma_flags</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">spin_flags</span><span class="p">);</span>

	<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
				  <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">],</span> <span class="n">num_bytes</span><span class="p">);</span>

	<span class="n">cfc_handle_events</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">das16_dma_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DAS16_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;spurious interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear interrupt */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_STATUS</span><span class="p">);</span>
	<span class="n">das16_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">das16_timer_interrupt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">das16_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_running</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timer_period</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reg_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;********DAS1600 REGISTER DUMP********</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS16_MUX: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_MUX</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS16_DIO: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_DIO</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS16_STATUS: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_STATUS</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS16_CONTROL: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CONTROL</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS16_PACER: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_PACER</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS16_GAIN: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_GAIN</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS16_CNTR_CONTROL: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CNTR_CONTROL</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS1600_CONV: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_CONV</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS1600_BURST: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_BURST</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS1600_ENABLE: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_ENABLE</span><span class="p">));</span>
	<span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;DAS1600_STATUS_B: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_STATUS_B</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das16_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diobits</span><span class="p">;</span>

	<span class="cm">/* status is available on all boards */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UNIPOLAR</span><span class="p">))</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_unipolar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_unipolar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DAS16_MUXBIT</span><span class="p">))</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_singleended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_singleended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="cm">/* diobits indicates boards */</span>

	<span class="n">diobits</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_DIO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; id bits are 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">diobits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">diobits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; requested board&#39;s id bits are 0x%x (ignore)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das1600_mode_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_STATUS_B</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DAS1600_CLK_10MHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clockbase</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; 10MHz pacer clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clockbase</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; 1MHz pacer clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reg_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">das16_ai_munge</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_chan_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">array</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_nbits</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Options list:</span>
<span class="cm"> *   0  I/O base</span>
<span class="cm"> *   1  IRQ</span>
<span class="cm"> *   2  DMA</span>
<span class="cm"> *   3  Clock speed (in MHz)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">das16_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timer_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_krange</span> <span class="o">*</span><span class="n">user_ai_range</span><span class="p">,</span> <span class="o">*</span><span class="n">user_ao_range</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	irq = it-&gt;options[1];</span>
<span class="c">	timer_mode = it-&gt;options[8];</span>
<span class="cp">#endif</span>
	<span class="cm">/* always use time_mode since using irq can drop samples while</span>
<span class="cm">	 * waiting for dma done interrupt (due to hardware limitations) */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">timer_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_mode</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi%d: das16:&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>

	<span class="cm">/*  check that clock setting is valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Invalid option.  Master clock must be set &quot;</span>
							<span class="s">&quot;to 1 or 10 (MHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">das16_private_struct</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; 0x%04lx-0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="s">&quot;das16&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; I/O port conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; 0x%04lx-0x%04lx 0x%04lx-0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">iobase</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="mh">0x0f</span><span class="p">,</span>
		       <span class="n">iobase</span> <span class="o">+</span> <span class="mh">0x400</span><span class="p">,</span>
		       <span class="n">iobase</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;das16&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; I/O port conflict:  0x%04lx-0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">iobase</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="mh">0x400</span><span class="p">,</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">,</span>
				    <span class="s">&quot;das16&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; I/O port conflict:  0x%04lx-0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">iobase</span> <span class="o">+</span> <span class="mh">0x400</span><span class="p">,</span>
			       <span class="n">iobase</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="cm">/*  probe id bits to make sure they are consistent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">das16_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">it</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; id bits do not match selected board, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="cm">/*  get master clock speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clockbase</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clockbase</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/*  1 MHz default */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">das1600_mode_detect</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* now for the irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">das16_dma_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;das16&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; ( irq = %u )&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; ( no irq )&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; invalid irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  initialize dma */</span>
	<span class="n">dma_chan</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">dma_chan</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  allocate dma buffers */</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="n">DAS16_DMA_SIZE</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span> <span class="s">&quot;das16&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; failed to allocate dma channel %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dma_chan</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; ( dma = %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; ( no dma )</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; invalid dma channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  get any user-defined input range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_pg</span> <span class="o">==</span> <span class="n">das16_pg_none</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">||</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span> <span class="p">{</span>
		<span class="cm">/*  allocate single-range range table */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ai_range_table</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_lrange</span><span class="p">)</span> <span class="o">+</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_krange</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="cm">/*  initialize ai range */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ai_range_table</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">user_ai_range</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ai_range_table</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">;</span>
		<span class="n">user_ai_range</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">user_ai_range</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">user_ai_range</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UNIT_volt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  get any user-defined output range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">||</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/*  allocate single-range range table */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ao_range_table</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_lrange</span><span class="p">)</span> <span class="o">+</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_krange</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="cm">/*  initialize ao range */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ao_range_table</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">user_ao_range</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ao_range_table</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">;</span>
		<span class="n">user_ao_range</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">user_ao_range</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">user_ao_range</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UNIT_volt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">));</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">das16_timer_interrupt</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">timer_mode</span> <span class="o">=</span> <span class="n">timer_mode</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="cm">/* ai */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_singleended</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_nbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ai_range_table</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*  user defined ai range */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ai_range_table</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_unipolar</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">das16_ai_uni_lranges</span><span class="p">[</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_pg</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">das16_ai_bip_lranges</span><span class="p">[</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_pg</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">das16_cmd_test</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">das16_cmd_exec</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">das16_cancel</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">munge</span> <span class="o">=</span> <span class="n">das16_ai_munge</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* ao */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_nbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*  user defined ao range */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ao_range_table</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ao_range_table</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">;</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* di */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">do_</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">do_</span><span class="p">;</span>
		<span class="cm">/*  initialize digital output lines */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_DIO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* 8255 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">i8255_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">i8255_offset</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">das16_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* set the interrupt level */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">=</span> <span class="n">DAS16_IRQ</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS16_CONTROL</span><span class="p">);</span>

	<span class="cm">/*  turn on das1600 mode if available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">DAS1600_ENABLE_VAL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_ENABLE</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_CONV</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS1600_BURST</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">das16_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">das16_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">)</span>
		<span class="n">subdev_8255_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">DAS16_DMA_SIZE</span><span class="p">,</span>
						    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						    <span class="n">devpriv</span><span class="o">-&gt;</span>
						    <span class="n">dma_buffer_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">)</span>
			<span class="n">free_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ai_range_table</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">user_ao_range_table</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mh">0x400</span><span class="p">,</span>
				       <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">das16_board</span> <span class="n">das16_boards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;das-16&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">15000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;das-16g&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">15000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;das-16f&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">8500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das16&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">20000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das16/f&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das16/jr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">7692</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_16jr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pc104-das16jr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">3300</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_16jr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das16jr/16&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_16jr_16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pc104-das16jr/16&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_16jr_16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;das-1201&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">20000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;das-1202&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;das-1401&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1601</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;das-1402&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1602</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;das-1601&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1601</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;das-1602&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1602</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das1401/12&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">6250</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1601</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das1402/12&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">6250</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1602</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das1402/16&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1602</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das1601/12&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">6250</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1601</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das1602/12&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1602</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das1602/16&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_1602</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="n">das16_ao_winsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x408</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cio-das16/330&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai</span>		<span class="o">=</span> <span class="n">das16_ai_rinsn</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_nbits</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_speed</span>	<span class="o">=</span> <span class="mi">3030</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pg</span>		<span class="o">=</span> <span class="n">das16_pg_16jr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">di</span>		<span class="o">=</span> <span class="n">das16_di_rbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_</span>		<span class="o">=</span> <span class="n">das16_do_wbits</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8255_offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">i8254_offset</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mh">0xf0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">das16_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;das16&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">das16_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">das16_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">board_name</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">das16_boards</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_names</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">das16_boards</span><span class="p">),</span>
	<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">das16_boards</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<span class="p">};</span>
<span class="n">module_comedi_driver</span><span class="p">(</span><span class="n">das16_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
