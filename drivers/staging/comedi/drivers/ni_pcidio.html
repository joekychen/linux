<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › ni_pcidio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ni_pcidio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/drivers/ni_pcidio.c</span>
<span class="cm">    driver for National Instruments PCI-DIO-96/PCI-6508</span>
<span class="cm">		National Instruments PCI-DIO-32HS</span>
<span class="cm">		National Instruments PCI-6503</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 1999,2002 David A. Schleef &lt;ds@schleef.org&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">Driver: ni_pcidio</span>
<span class="cm">Description: National Instruments PCI-DIO32HS, PCI-DIO96, PCI-6533, PCI-6503</span>
<span class="cm">Author: ds</span>
<span class="cm">Status: works</span>
<span class="cm">Devices: [National Instruments] PCI-DIO-32HS (ni_pcidio), PXI-6533,</span>
<span class="cm">  PCI-DIO-96, PCI-DIO-96B, PXI-6508, PCI-6503, PCI-6503B, PCI-6503X,</span>
<span class="cm">  PXI-6503, PCI-6533, PCI-6534</span>
<span class="cm">Updated: Mon, 09 Jan 2012 14:27:23 +0000</span>

<span class="cm">The DIO-96 appears as four 8255 subdevices.  See the 8255</span>
<span class="cm">driver notes for details.</span>

<span class="cm">The DIO32HS board appears as one subdevice, with 32 channels.</span>
<span class="cm">Each channel is individually I/O configurable.  The channel order</span>
<span class="cm">is 0=A0, 1=A1, 2=A2, ... 8=B0, 16=C0, 24=D0.  The driver only</span>
<span class="cm">supports simple digital I/O; no handshaking is supported.</span>

<span class="cm">DMA mostly works for the PCI-DIO32HS, but only in timed input mode.</span>

<span class="cm">The PCI-DIO-32HS/PCI-6533 has a configurable external trigger. Setting</span>
<span class="cm">scan_begin_arg to 0 or CR_EDGE triggers on the leading edge. Setting</span>
<span class="cm">scan_begin_arg to CR_INVERT or (CR_EDGE | CR_INVERT) triggers on the</span>
<span class="cm">trailing edge.</span>

<span class="cm">This driver could be easily modified to support AT-MIO32HS and</span>
<span class="cm">AT-MIO96.</span>

<span class="cm">The PCI-6534 requires a firmware upload after power-up to work, the</span>
<span class="cm">firmware data and instructions for loading it with comedi_config</span>
<span class="cm">it are contained in the</span>
<span class="cm">comedi_nonfree_firmware tarball available from http://www.comedi.org</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">   This driver is for both the NI PCI-DIO-32HS and the PCI-DIO-96,</span>
<span class="cm">   which have very different architectures.  But, since the &#39;96 is</span>
<span class="cm">   so simple, it is included here.</span>

<span class="cm">   Manuals (available from ftp://ftp.natinst.com/support/manuals)</span>

<span class="cm">	320938c.pdf	PCI-DIO-96/PXI-6508/PCI-6503 User Manual</span>
<span class="cm">	321464b.pdf	AT/PCI-DIO-32HS User Manual</span>
<span class="cm">	341329A.pdf	PCI-6533 Register-Level Programmer Manual</span>
<span class="cm">	341330A.pdf	DAQ-DIO Technical Reference Manual</span>

<span class="cm"> */</span>

<span class="cp">#define USE_DMA</span>
<span class="cm">/* #define DEBUG 1 */</span>
<span class="cm">/* #define DEBUG_FLAGS */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &quot;mite.h&quot;</span>
<span class="cp">#include &quot;8255.h&quot;</span>

<span class="cp">#undef DPRINTK</span>
<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DPRINTK(format, args...)	printk(format, ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(format, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#define PCI_DIO_SIZE 4096</span>
<span class="cp">#define PCI_MITE_SIZE 4096</span>

<span class="cm">/* defines for the PCI-DIO-96 */</span>

<span class="cp">#define NIDIO_8255_BASE(x)	((x)*4)</span>
<span class="cp">#define NIDIO_A 0</span>
<span class="cp">#define NIDIO_B 4</span>
<span class="cp">#define NIDIO_C 8</span>
<span class="cp">#define NIDIO_D 12</span>

<span class="cm">/* defines for the PCI-DIO-32HS */</span>

<span class="cp">#define Window_Address			4	</span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#define Interrupt_And_Window_Status	4	</span><span class="cm">/* R */</span><span class="cp"></span>
<span class="cp">#define IntStatus1				(1&lt;&lt;0)</span>
<span class="cp">#define IntStatus2				(1&lt;&lt;1)</span>
<span class="cp">#define WindowAddressStatus_mask		0x7c</span>

<span class="cp">#define Master_DMA_And_Interrupt_Control 5	</span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#define InterruptLine(x)			((x)&amp;3)</span>
<span class="cp">#define OpenInt				(1&lt;&lt;2)</span>
<span class="cp">#define Group_Status			5	</span><span class="cm">/* R */</span><span class="cp"></span>
<span class="cp">#define DataLeft				(1&lt;&lt;0)</span>
<span class="cp">#define Req					(1&lt;&lt;2)</span>
<span class="cp">#define StopTrig				(1&lt;&lt;3)</span>

<span class="cp">#define Group_1_Flags			6	</span><span class="cm">/* R */</span><span class="cp"></span>
<span class="cp">#define Group_2_Flags			7	</span><span class="cm">/* R */</span><span class="cp"></span>
<span class="cp">#define TransferReady				(1&lt;&lt;0)</span>
<span class="cp">#define CountExpired				(1&lt;&lt;1)</span>
<span class="cp">#define Waited				(1&lt;&lt;5)</span>
<span class="cp">#define PrimaryTC				(1&lt;&lt;6)</span>
<span class="cp">#define SecondaryTC				(1&lt;&lt;7)</span>
  <span class="cm">/* #define SerialRose */</span>
  <span class="cm">/* #define ReqRose */</span>
  <span class="cm">/* #define Paused */</span>

<span class="cp">#define Group_1_First_Clear		6	</span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#define Group_2_First_Clear		7	</span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#define ClearWaited				(1&lt;&lt;3)</span>
<span class="cp">#define ClearPrimaryTC			(1&lt;&lt;4)</span>
<span class="cp">#define ClearSecondaryTC			(1&lt;&lt;5)</span>
<span class="cp">#define DMAReset				(1&lt;&lt;6)</span>
<span class="cp">#define FIFOReset				(1&lt;&lt;7)</span>
<span class="cp">#define ClearAll				0xf8</span>

<span class="cp">#define Group_1_FIFO			8	</span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#define Group_2_FIFO			12	</span><span class="cm">/* W */</span><span class="cp"></span>

<span class="cp">#define Transfer_Count			20</span>
<span class="cp">#define Chip_ID_D			24</span>
<span class="cp">#define Chip_ID_I			25</span>
<span class="cp">#define Chip_ID_O			26</span>
<span class="cp">#define Chip_Version			27</span>
<span class="cp">#define Port_IO(x)			(28+(x))</span>
<span class="cp">#define Port_Pin_Directions(x)		(32+(x))</span>
<span class="cp">#define Port_Pin_Mask(x)		(36+(x))</span>
<span class="cp">#define Port_Pin_Polarities(x)		(40+(x))</span>

<span class="cp">#define Master_Clock_Routing		45</span>
<span class="cp">#define RTSIClocking(x)			(((x)&amp;3)&lt;&lt;4)</span>

<span class="cp">#define Group_1_Second_Clear		46	</span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#define Group_2_Second_Clear		47	</span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#define ClearExpired				(1&lt;&lt;0)</span>

<span class="cp">#define Port_Pattern(x)			(48+(x))</span>

<span class="cp">#define Data_Path			64</span>
<span class="cp">#define FIFOEnableA		(1&lt;&lt;0)</span>
<span class="cp">#define FIFOEnableB		(1&lt;&lt;1)</span>
<span class="cp">#define FIFOEnableC		(1&lt;&lt;2)</span>
<span class="cp">#define FIFOEnableD		(1&lt;&lt;3)</span>
<span class="cp">#define Funneling(x)		(((x)&amp;3)&lt;&lt;4)</span>
<span class="cp">#define GroupDirection	(1&lt;&lt;7)</span>

<span class="cp">#define Protocol_Register_1		65</span>
<span class="cp">#define OpMode				Protocol_Register_1</span>
<span class="cp">#define RunMode(x)		((x)&amp;7)</span>
<span class="cp">#define Numbered		(1&lt;&lt;3)</span>

<span class="cp">#define Protocol_Register_2		66</span>
<span class="cp">#define ClockReg			Protocol_Register_2</span>
<span class="cp">#define ClockLine(x)		(((x)&amp;3)&lt;&lt;5)</span>
<span class="cp">#define InvertStopTrig	(1&lt;&lt;7)</span>
<span class="cp">#define DataLatching(x)       (((x)&amp;3)&lt;&lt;5)</span>

<span class="cp">#define Protocol_Register_3		67</span>
<span class="cp">#define Sequence			Protocol_Register_3</span>

<span class="cp">#define Protocol_Register_14		68	</span><span class="cm">/* 16 bit */</span><span class="cp"></span>
<span class="cp">#define ClockSpeed			Protocol_Register_14</span>

<span class="cp">#define Protocol_Register_4		70</span>
<span class="cp">#define ReqReg				Protocol_Register_4</span>
<span class="cp">#define ReqConditioning(x)	(((x)&amp;7)&lt;&lt;3)</span>

<span class="cp">#define Protocol_Register_5		71</span>
<span class="cp">#define BlockMode			Protocol_Register_5</span>

<span class="cp">#define FIFO_Control			72</span>
<span class="cp">#define ReadyLevel(x)		((x)&amp;7)</span>

<span class="cp">#define Protocol_Register_6		73</span>
<span class="cp">#define LinePolarities			Protocol_Register_6</span>
<span class="cp">#define InvertAck		(1&lt;&lt;0)</span>
<span class="cp">#define InvertReq		(1&lt;&lt;1)</span>
<span class="cp">#define InvertClock		(1&lt;&lt;2)</span>
<span class="cp">#define InvertSerial		(1&lt;&lt;3)</span>
<span class="cp">#define OpenAck		(1&lt;&lt;4)</span>
<span class="cp">#define OpenClock		(1&lt;&lt;5)</span>

<span class="cp">#define Protocol_Register_7		74</span>
<span class="cp">#define AckSer				Protocol_Register_7</span>
<span class="cp">#define AckLine(x)		(((x)&amp;3)&lt;&lt;2)</span>
<span class="cp">#define ExchangePins		(1&lt;&lt;7)</span>

<span class="cp">#define Interrupt_Control		75</span>
  <span class="cm">/* bits same as flags */</span>

<span class="cp">#define DMA_Line_Control_Group1		76</span>
<span class="cp">#define DMA_Line_Control_Group2		108</span>
<span class="cm">/* channel zero is none */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">primary_DMAChannel_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">secondary_DMAChannel_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define Transfer_Size_Control		77</span>
<span class="cp">#define TransferWidth(x)	((x)&amp;3)</span>
<span class="cp">#define TransferLength(x)	(((x)&amp;3)&lt;&lt;3)</span>
<span class="cp">#define RequireRLevel		(1&lt;&lt;5)</span>

<span class="cp">#define Protocol_Register_15		79</span>
<span class="cp">#define DAQOptions			Protocol_Register_15</span>
<span class="cp">#define StartSource(x)			((x)&amp;0x3)</span>
<span class="cp">#define InvertStart				(1&lt;&lt;2)</span>
<span class="cp">#define StopSource(x)				(((x)&amp;0x3)&lt;&lt;3)</span>
<span class="cp">#define ReqStart				(1&lt;&lt;6)</span>
<span class="cp">#define PreStart				(1&lt;&lt;7)</span>

<span class="cp">#define Pattern_Detection		81</span>
<span class="cp">#define DetectionMethod			(1&lt;&lt;0)</span>
<span class="cp">#define InvertMatch				(1&lt;&lt;1)</span>
<span class="cp">#define IE_Pattern_Detection			(1&lt;&lt;2)</span>

<span class="cp">#define Protocol_Register_9		82</span>
<span class="cp">#define ReqDelay			Protocol_Register_9</span>

<span class="cp">#define Protocol_Register_10		83</span>
<span class="cp">#define ReqNotDelay			Protocol_Register_10</span>

<span class="cp">#define Protocol_Register_11		84</span>
<span class="cp">#define AckDelay			Protocol_Register_11</span>

<span class="cp">#define Protocol_Register_12		85</span>
<span class="cp">#define AckNotDelay			Protocol_Register_12</span>

<span class="cp">#define Protocol_Register_13		86</span>
<span class="cp">#define Data1Delay			Protocol_Register_13</span>

<span class="cp">#define Protocol_Register_8		88	</span><span class="cm">/* 32 bit */</span><span class="cp"></span>
<span class="cp">#define StartDelay			Protocol_Register_8</span>

<span class="k">enum</span> <span class="n">pci_6534_firmware_registers</span> <span class="p">{</span>	<span class="cm">/* 16 bit */</span>
	<span class="n">Firmware_Control_Register</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="n">Firmware_Status_Register</span> <span class="o">=</span> <span class="mh">0x104</span><span class="p">,</span>
	<span class="n">Firmware_Data_Register</span> <span class="o">=</span> <span class="mh">0x108</span><span class="p">,</span>
	<span class="n">Firmware_Mask_Register</span> <span class="o">=</span> <span class="mh">0x10c</span><span class="p">,</span>
	<span class="n">Firmware_Debug_Register</span> <span class="o">=</span> <span class="mh">0x110</span><span class="p">,</span>
<span class="p">};</span>
<span class="cm">/* main fpga registers (32 bit)*/</span>
<span class="k">enum</span> <span class="n">pci_6534_fpga_registers</span> <span class="p">{</span>
	<span class="n">FPGA_Control1_Register</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>
	<span class="n">FPGA_Control2_Register</span> <span class="o">=</span> <span class="mh">0x204</span><span class="p">,</span>
	<span class="n">FPGA_Irq_Mask_Register</span> <span class="o">=</span> <span class="mh">0x208</span><span class="p">,</span>
	<span class="n">FPGA_Status_Register</span> <span class="o">=</span> <span class="mh">0x20c</span><span class="p">,</span>
	<span class="n">FPGA_Signature_Register</span> <span class="o">=</span> <span class="mh">0x210</span><span class="p">,</span>
	<span class="n">FPGA_SCALS_Counter_Register</span> <span class="o">=</span> <span class="mh">0x280</span><span class="p">,</span>	<span class="cm">/*write-clear */</span>
	<span class="n">FPGA_SCAMS_Counter_Register</span> <span class="o">=</span> <span class="mh">0x284</span><span class="p">,</span>	<span class="cm">/*write-clear */</span>
	<span class="n">FPGA_SCBLS_Counter_Register</span> <span class="o">=</span> <span class="mh">0x288</span><span class="p">,</span>	<span class="cm">/*write-clear */</span>
	<span class="n">FPGA_SCBMS_Counter_Register</span> <span class="o">=</span> <span class="mh">0x28c</span><span class="p">,</span>	<span class="cm">/*write-clear */</span>
	<span class="n">FPGA_Temp_Control_Register</span> <span class="o">=</span> <span class="mh">0x2a0</span><span class="p">,</span>
	<span class="n">FPGA_DAR_Register</span> <span class="o">=</span> <span class="mh">0x2a8</span><span class="p">,</span>
	<span class="n">FPGA_ELC_Read_Register</span> <span class="o">=</span> <span class="mh">0x2b8</span><span class="p">,</span>
	<span class="n">FPGA_ELC_Write_Register</span> <span class="o">=</span> <span class="mh">0x2bc</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">FPGA_Control_Bits</span> <span class="p">{</span>
	<span class="n">FPGA_Enable_Bit</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define TIMER_BASE 50		</span><span class="cm">/* nanoseconds */</span><span class="cp"></span>

<span class="cp">#ifdef USE_DMA</span>
<span class="cp">#define IntEn (CountExpired|Waited|PrimaryTC|SecondaryTC)</span>
<span class="cp">#else</span>
<span class="cp">#define IntEn (TransferReady|CountExpired|Waited|PrimaryTC|SecondaryTC)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_pcidio_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">nidio_board</span> <span class="p">{</span>

	<span class="kt">int</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_8255</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_diodaq</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uses_firmware</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nidio_board</span> <span class="n">nidio_boards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x1150</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-dio-32hs&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x1320</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pxi-6533&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x12b0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-6534&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">uses_firmware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x0160</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-dio-96&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x1630</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-dio-96b&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x13c0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pxi-6508&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-6503&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x1250</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-6503b&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x17d0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci-6503x&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mh">0x1800</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pxi-6503&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_8255</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">is_diodaq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define n_nidio_boards ARRAY_SIZE(nidio_boards)</span>
<span class="cp">#define this_board ((const struct nidio_board *)dev-&gt;board_ptr)</span>

<span class="k">struct</span> <span class="n">nidio96_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mite_struct</span> <span class="o">*</span><span class="n">mite</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boardtype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">OpModeBits</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mite_channel</span> <span class="o">*</span><span class="n">di_mite_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mite_dma_descriptor_ring</span> <span class="o">*</span><span class="n">di_mite_ring</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">mite_channel_lock</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define devpriv ((struct nidio96_private *)dev-&gt;private)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_pcidio_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_pcidio_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_pcidio_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_pcidio_ns_to_timer</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">nanosec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">round_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_mite_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_FLAGS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_pcidio_print_flags</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_pcidio_print_status</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define ni_pcidio_print_flags(x)</span>
<span class="cp">#define ni_pcidio_print_status(x)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_request_di_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span> <span class="o">=</span>
	    <span class="n">mite_request_channel_in_range</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">,</span>
					  <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_ring</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to reserve mite dma channel.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">COMEDI_INPUT</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">primary_DMAChannel_bits</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">secondary_DMAChannel_bits</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">),</span>
	       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">DMA_Line_Control_Group1</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_pcidio_release_di_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mite_dma_disarm</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">);</span>
		<span class="n">mite_dma_reset</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">);</span>
		<span class="n">mite_release_channel</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">primary_DMAChannel_bits</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">secondary_DMAChannel_bits</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">DMA_Line_Control_Group1</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nidio96_8255_cb</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">port</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">readb</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">port</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ni_pcidio_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span>
	    <span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span>
			     <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ni_pcidio_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">)</span>
		<span class="n">mite_sync_input_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_count</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nidio_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mite_struct</span> <span class="o">*</span><span class="n">mite</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">;</span>

	<span class="cm">/* int i, j; */</span>
	<span class="kt">long</span> <span class="kt">int</span> <span class="n">AuxData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">data1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">data2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* interrupcions parasites */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* assume it&#39;s from another card */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Lock to avoid race with comedi_poll */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
		       <span class="n">Interrupt_And_Window_Status</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Group_1_Flags</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ni_pcidio_interrupt: status=0x%02x,flags=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">status</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ni_pcidio_print_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ni_pcidio_print_status</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* printk(&quot;buf[0]=%08x\n&quot;,*(unsigned int *)async-&gt;prealloc_buf); */</span>
	<span class="cm">/* printk(&quot;buf[4096]=%08x\n&quot;,</span>
<span class="cm">	       *(unsigned int *)(async-&gt;prealloc_buf+4096)); */</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">)</span>
		<span class="n">m_status</span> <span class="o">=</span> <span class="n">mite_get_status</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">);</span>
<span class="cp">#ifdef MITE_DEBUG</span>
	<span class="n">mite_print_chsr</span><span class="p">(</span><span class="n">m_status</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* printk(&quot;mite_bytes_transferred: %d\n&quot;,</span>
<span class="cm">	       mite_bytes_transferred(mite,DI_DMA_CHAN)); */</span>

	<span class="cm">/* mite_dump_regs(mite); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_status</span> <span class="o">&amp;</span> <span class="n">CHSR_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m_status</span> <span class="o">&amp;</span> <span class="n">CHSR_LINKC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">CHOR_CLRLC</span><span class="p">,</span>
			       <span class="n">mite</span><span class="o">-&gt;</span><span class="n">mite_io_addr</span> <span class="o">+</span>
			       <span class="n">MITE_CHOR</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
			<span class="n">mite_sync_input_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
			<span class="cm">/* XXX need to byteswap */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CHSR_INT</span> <span class="o">|</span> <span class="n">CHSR_LINKC</span> <span class="o">|</span> <span class="n">CHSR_DONE</span> <span class="o">|</span> <span class="n">CHSR_DRDY</span> <span class="o">|</span>
				 <span class="n">CHSR_DRQ1</span> <span class="o">|</span> <span class="n">CHSR_MRDY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;unknown mite interrupt, disabling IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
			<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DataLeft</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">work</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;too much work in interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span>
			       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
			       <span class="n">Master_DMA_And_Interrupt_Control</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">IntEn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TransferReady</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* DPRINTK(&quot;TransferReady\n&quot;); */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TransferReady</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">work</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">work</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;too much work in interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span>
					       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
					       <span class="n">Master_DMA_And_Interrupt_Control</span>
					      <span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">AuxData</span> <span class="o">=</span>
				    <span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
					  <span class="n">Group_1_FIFO</span><span class="p">);</span>
				<span class="n">data1</span> <span class="o">=</span> <span class="n">AuxData</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">AuxData</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">data1</span><span class="p">);</span>
				<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
				<span class="cm">/* DPRINTK(&quot;read:%d, %d\n&quot;,data1,data2); */</span>
				<span class="n">flags</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
					      <span class="n">Group_1_Flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* DPRINTK(&quot;buf_int_count: %d\n&quot;,</span>
<span class="cm">				async-&gt;buf_int_count); */</span>
			<span class="cm">/* DPRINTK(&quot;1) IntEn=%d,flags=%d,status=%d\n&quot;,</span>
<span class="cm">				IntEn,flags,status); */</span>
			<span class="cm">/* ni_pcidio_print_flags(flags); */</span>
			<span class="cm">/* ni_pcidio_print_status(status); */</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_BLOCK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CountExpired</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CountExpired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">ClearExpired</span><span class="p">,</span>
			       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
			       <span class="n">Group_1_Second_Clear</span><span class="p">);</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>

			<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">OpMode</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">Waited</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Waited</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">ClearWaited</span><span class="p">,</span>
			       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
			       <span class="n">Group_1_First_Clear</span><span class="p">);</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PrimaryTC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;PrimaryTC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">ClearPrimaryTC</span><span class="p">,</span>
			       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
			       <span class="n">Group_1_First_Clear</span><span class="p">);</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SecondaryTC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;SecondaryTC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">ClearSecondaryTC</span><span class="p">,</span>
			       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
			       <span class="n">Group_1_First_Clear</span><span class="p">);</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		else {</span>
<span class="c">			printk(&quot;ni_pcidio: unknown interrupt\n&quot;);</span>
<span class="c">			async-&gt;events |= COMEDI_CB_ERROR | COMEDI_CB_EOA;</span>
<span class="c">			writeb(0x00,</span>
<span class="c">			       devpriv-&gt;mite-&gt;daq_io_addr +</span>
<span class="c">			       Master_DMA_And_Interrupt_Control);</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Group_1_Flags</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
			       <span class="n">Interrupt_And_Window_Status</span><span class="p">);</span>
		<span class="cm">/* DPRINTK(&quot;loop end: IntEn=0x%02x,flags=0x%02x,&quot;</span>
<span class="cm">			&quot;status=0x%02x\n&quot;, IntEn, flags, status); */</span>
		<span class="cm">/* ni_pcidio_print_flags(flags); */</span>
		<span class="cm">/* ni_pcidio_print_status(status); */</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">ni_pcidio_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (!tag) {</span>
<span class="c">		writeb(0x03,</span>
<span class="c">		       devpriv-&gt;mite-&gt;daq_io_addr +</span>
<span class="c">		       Master_DMA_And_Interrupt_Control);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG_FLAGS</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">flags_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;TransferReady&quot;</span><span class="p">,</span> <span class="s">&quot;CountExpired&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">,</span> <span class="s">&quot;3&quot;</span><span class="p">,</span>
	<span class="s">&quot;4&quot;</span><span class="p">,</span> <span class="s">&quot;Waited&quot;</span><span class="p">,</span> <span class="s">&quot;PrimaryTC&quot;</span><span class="p">,</span> <span class="s">&quot;SecondaryTC&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_pcidio_print_flags</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;group_1_flags:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">flags_strings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">status_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;DataLeft1&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved1&quot;</span><span class="p">,</span> <span class="s">&quot;Req1&quot;</span><span class="p">,</span> <span class="s">&quot;StopTrig1&quot;</span><span class="p">,</span>
	<span class="s">&quot;DataLeft2&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved2&quot;</span><span class="p">,</span> <span class="s">&quot;Req2&quot;</span><span class="p">,</span> <span class="s">&quot;StopTrig2&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_pcidio_print_status</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;group_status:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">status_strings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef unused</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">n_int</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Group_Status</span><span class="p">);</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Group_1_Flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_int</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;status 0x%02x flags 0x%02x time %06d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Group_1_FIFO</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Group_1_Flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Group_1_Flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_int</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;new status 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="n">n_int</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_OUTPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_INPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_QUERY</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span>
		     <span class="n">io_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)))</span> <span class="o">?</span> <span class="n">COMEDI_OUTPUT</span> <span class="o">:</span>
		    <span class="n">COMEDI_INPUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Port_Pin_Directions</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Port_IO</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Port_IO</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span> <span class="o">|</span> <span class="n">TRIG_INT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* step 2: make sure trigger sources are unique and mutually</span>
<span class="cm">	compatible */</span>

	<span class="cm">/* note that mutual compatibility is not an issue here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_INT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* same for both TRIG_INT and TRIG_NOW */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#define MAX_SPEED	(TIMER_BASE)	</span><span class="cm">/* in nanoseconds */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">MAX_SPEED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">MAX_SPEED</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* no minimum speed */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TRIG_EXT */</span>
		<span class="cm">/* should be level/edge, hi/lo specification here */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CR_EDGE</span> <span class="o">|</span> <span class="n">CR_INVERT</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">CR_EDGE</span> <span class="o">|</span> <span class="n">CR_INVERT</span><span class="p">);</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no limit */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TRIG_NONE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">ni_pcidio_ns_to_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
				      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_ns_to_timer</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">nanosec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">round_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">divider</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">TIMER_BASE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">round_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
	<span class="nl">default:</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">nanosec</span> <span class="o">+</span> <span class="n">base</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">base</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
		<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">nanosec</span><span class="p">)</span> <span class="o">/</span> <span class="n">base</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
		<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">nanosec</span> <span class="o">+</span> <span class="n">base</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">base</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">nanosec</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="n">divider</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">divider</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* XXX configure ports for input */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Port_Pin_Directions</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable fifos A B C D */</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Data_Path</span><span class="p">);</span>

		<span class="cm">/* set transfer width a 32 bits */</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">TransferWidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">TransferLength</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Transfer_Size_Control</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Data_Path</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">TransferWidth</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">TransferLength</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Transfer_Size_Control</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* protocol configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* page 4-5, &quot;input with internal REQs&quot; */</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">OpMode</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ClockReg</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Sequence</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ReqReg</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">BlockMode</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">LinePolarities</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">AckSer</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ni_pcidio_ns_to_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
					     <span class="n">TRIG_ROUND_NEAREST</span><span class="p">),</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">StartDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ReqDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ReqNotDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">AckDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">AckNotDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Data1Delay</span><span class="p">);</span>
		<span class="cm">/* manual, page 4-5: ClockSpeed comment is incorrectly listed</span>
<span class="cm">		 * on DAQOptions */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ClockSpeed</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">DAQOptions</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TRIG_EXT */</span>
		<span class="cm">/* page 4-5, &quot;input with external REQs&quot; */</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">OpMode</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ClockReg</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Sequence</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ReqReg</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">BlockMode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Leading Edge pulse mode */</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">LinePolarities</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Trailing Edge pulse mode */</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">LinePolarities</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">AckSer</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">StartDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ReqDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ReqNotDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">AckDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">AckNotDelay</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Data1Delay</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">ClockSpeed</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">DAQOptions</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Transfer_Count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* XXX */</span>
	<span class="p">}</span>

<span class="cp">#ifdef USE_DMA</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">ClearPrimaryTC</span> <span class="o">|</span> <span class="n">ClearSecondaryTC</span><span class="p">,</span>
	       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Group_1_First_Clear</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">setup_mite_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">DMA_Line_Control_Group1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">DMA_Line_Control_Group2</span><span class="p">);</span>

	<span class="cm">/* clear and enable interrupts */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Group_1_First_Clear</span><span class="p">);</span>
	<span class="cm">/* writeb(ClearExpired,</span>
<span class="cm">	       devpriv-&gt;mite-&gt;daq_io_addr+Group_1_Second_Clear); */</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">IntEn</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Interrupt_Control</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span>
	       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Master_DMA_And_Interrupt_Control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">OpModeBits</span> <span class="o">=</span> <span class="n">DataLatching</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">RunMode</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TRIG_TIMER */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">OpModeBits</span> <span class="o">=</span> <span class="n">Numbered</span> <span class="o">|</span> <span class="n">RunMode</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start */</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">OpModeBits</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">OpMode</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TRIG_INT */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="n">ni_pcidio_inttrig</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ni_pcidio: command started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_mite_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_pcidio_request_di_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* write alloc the entire buffer */</span>
	<span class="n">comedi_buf_write_alloc</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mite_prep_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">mite_dma_arm</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_chan</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trignum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">OpModeBits</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">OpMode</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span>
	       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Master_DMA_And_Interrupt_Control</span><span class="p">);</span>
	<span class="n">ni_pcidio_release_di_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_pcidio_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mite_buf_change</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_ring</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_buf</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_6534_load_fpga</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fpga_index</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">fpga_index</span><span class="p">,</span>
	       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Firmware_Control_Register</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xc0</span> <span class="o">|</span> <span class="n">fpga_index</span><span class="p">,</span>
	       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Firmware_Control_Register</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
		    <span class="n">Firmware_Status_Register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ni_pcidio: failed to load fpga %i, &quot;</span>
		       <span class="s">&quot;waiting for status 0x2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fpga_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">fpga_index</span><span class="p">,</span>
	       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Firmware_Control_Register</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Firmware_Status_Register</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="mh">0x3</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ni_pcidio: failed to load fpga %i, &quot;</span>
		       <span class="s">&quot;waiting for status 0x3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fpga_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">value</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Firmware_Data_Register</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
			    <span class="n">Firmware_Status_Register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		     <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_pcidio: failed to load word into fpga %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fpga_index</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
			<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Firmware_Control_Register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_6534_reset_fpga</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fpga_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_6534_load_fpga</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fpga_index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_6534_reset_fpgas</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Firmware_Control_Register</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_6534_reset_fpga</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Firmware_Mask_Register</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_6534_init_main_fpga</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">FPGA_Control1_Register</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">FPGA_Control2_Register</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">FPGA_SCALS_Counter_Register</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">FPGA_SCAMS_Counter_Register</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">FPGA_SCBLS_Counter_Register</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">FPGA_SCBMS_Counter_Register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_6534_upload_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">options</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">main_fpga_data</span><span class="p">,</span> <span class="o">*</span><span class="n">scarab_a_data</span><span class="p">,</span> <span class="o">*</span><span class="n">scarab_b_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">main_fpga_data_len</span><span class="p">,</span> <span class="n">scarab_a_data_len</span><span class="p">,</span> <span class="n">scarab_b_data_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA_LENGTH</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_6534_reset_fpgas</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">main_fpga_data</span> <span class="o">=</span> <span class="n">comedi_aux_data</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">main_fpga_data_len</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA0_LENGTH</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_6534_load_fpga</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">main_fpga_data</span><span class="p">,</span> <span class="n">main_fpga_data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">pci_6534_init_main_fpga</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">scarab_a_data</span> <span class="o">=</span> <span class="n">comedi_aux_data</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">scarab_a_data_len</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA1_LENGTH</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_6534_load_fpga</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scarab_a_data</span><span class="p">,</span> <span class="n">scarab_a_data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">scarab_b_data</span> <span class="o">=</span> <span class="n">comedi_aux_data</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">scarab_b_data_len</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA2_LENGTH</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_6534_load_fpga</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scarab_b_data</span><span class="p">,</span> <span class="n">scarab_b_data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nidio_find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mite_struct</span> <span class="o">*</span><span class="n">mite</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mite</span> <span class="o">=</span> <span class="n">mite_devices</span><span class="p">;</span> <span class="n">mite</span><span class="p">;</span> <span class="n">mite</span> <span class="o">=</span> <span class="n">mite</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">||</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">!=</span> <span class="n">mite</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">||</span>
			    <span class="n">slot</span> <span class="o">!=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_nidio_boards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mite_device_id</span><span class="p">(</span><span class="n">mite</span><span class="p">)</span> <span class="o">==</span> <span class="n">nidio_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">=</span> <span class="n">nidio_boards</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span> <span class="o">=</span> <span class="n">mite</span><span class="p">;</span>

				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;no device found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mite_list_devices</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nidio_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_subdevices</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi%d: nidio:&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nidio96_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nidio_find_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mite_setup</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;error setting up mite</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">comedi_set_hw_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_ring</span> <span class="o">=</span> <span class="n">mite_alloc_ring</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">mite_irq</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">uses_firmware</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_6534_upload_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">is_diodaq</span><span class="p">)</span>
		<span class="n">n_subdevices</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_8255</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">n_subdevices</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n_subdevices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">is_diodaq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_8255</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					 <span class="n">nidio96_8255_cb</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span>
							 <span class="n">daq_io_addr</span> <span class="o">+</span>
							 <span class="n">NIDIO_8255_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; rev=%d&quot;</span><span class="p">,</span>
		       <span class="n">readb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Chip_Version</span><span class="p">));</span>

		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DIO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span>
		    <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_LSAMPL</span> <span class="o">|</span> <span class="n">SDF_PACKED</span> <span class="o">|</span>
		    <span class="n">SDF_CMD_READ</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_pcidio_insn_config</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_pcidio_insn_bits</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_pcidio_cmd</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_pcidio_cmdtest</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_pcidio_cancel</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>	<span class="cm">/* XXX */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_change</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_pcidio_change</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async_dma_dir</span> <span class="o">=</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_pcidio_poll</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Port_IO</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Port_Pin_Directions</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span> <span class="n">Port_Pin_Mask</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

		<span class="cm">/* disable interrupts on board */</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">daq_io_addr</span> <span class="o">+</span>
		       <span class="n">Master_DMA_And_Interrupt_Control</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">nidio_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="s">&quot;ni_pcidio&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot; irq not available&quot;</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nidio_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">is_diodaq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_8255</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">subdev_8255_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mite_free_ring</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_ring</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">di_mite_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">)</span>
			<span class="n">mite_unsetup</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">ni_pcidio_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;ni_pcidio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">nidio_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">nidio_detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ni_pcidio_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ni_pcidio_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">ni_pcidio_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">ni_pcidio_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x1150</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x1320</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x12b0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x0160</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x1630</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x13c0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x1250</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x17d0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NI</span><span class="p">,</span> <span class="mh">0x1800</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ni_pcidio_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ni_pcidio_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ni_pcidio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">ni_pcidio_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ni_pcidio_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ni_pcidio_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_pci_driver</span><span class="p">(</span><span class="n">ni_pcidio_driver</span><span class="p">,</span> <span class="n">ni_pcidio_pci_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
