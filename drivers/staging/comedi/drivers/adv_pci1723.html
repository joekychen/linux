<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › adv_pci1723.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>adv_pci1723.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>
<span class="cm">   comedi/drivers/pci1723.c</span>

<span class="cm">   COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">   Copyright (C) 2000 David A. Schleef &lt;ds@schleef.org&gt;</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">   (at your option) any later version.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; if not, write to the Free Software</span>
<span class="cm">   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*******************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm">Driver: adv_pci1723</span>
<span class="cm">Description: Advantech PCI-1723</span>
<span class="cm">Author: yonggang &lt;rsmgnu@gmail.com&gt;, Ian Abbott &lt;abbotti@mev.co.uk&gt;</span>
<span class="cm">Devices: [Advantech] PCI-1723 (adv_pci1723)</span>
<span class="cm">Updated: Mon, 14 Apr 2008 15:12:56 +0100</span>
<span class="cm">Status: works</span>

<span class="cm">Configuration Options:</span>
<span class="cm">  [0] - PCI bus of device (optional)</span>
<span class="cm">  [1] - PCI slot of device (optional)</span>

<span class="cm">  If bus/slot is not specified, the first supported</span>
<span class="cm">  PCI device found will be used.</span>

<span class="cm">Subdevice 0 is 8-channel AO, 16-bit, range +/- 10 V.</span>

<span class="cm">Subdevice 1 is 16-channel DIO.  The channels are configurable as input or</span>
<span class="cm">output in 2 groups (0 to 7, 8 to 15).  Configuring any channel implicitly</span>
<span class="cm">configures all channels in the same group.</span>

<span class="cm">TODO:</span>

<span class="cm">1. Add the two milliamp ranges to the AO subdevice (0 to 20 mA, 4 to 20 mA).</span>
<span class="cm">2. Read the initial ranges and values of the AO subdevice at start-up instead</span>
<span class="cm">   of reinitializing them.</span>
<span class="cm">3. Implement calibration.</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &quot;comedi_pci.h&quot;</span>

<span class="cp">#define PCI_VENDOR_ID_ADVANTECH		0x13fe	</span><span class="cm">/* Advantech PCI vendor ID */</span><span class="cp"></span>

<span class="cm">/* hardware types of the cards */</span>
<span class="cp">#define TYPE_PCI1723 0</span>

<span class="cp">#define IORANGE_1723  0x2A</span>

<span class="cm">/* all the registers for the pci1723 board */</span>
<span class="cp">#define PCI1723_DA(N)   ((N)&lt;&lt;1)	</span><span class="cm">/* W: D/A register N (0 to 7) */</span><span class="cp"></span>

<span class="cp">#define PCI1723_SYN_SET  0x12		</span><span class="cm">/* synchronized set register */</span><span class="cp"></span>
<span class="cp">#define PCI1723_ALL_CHNNELE_SYN_STROBE  0x12</span>
					<span class="cm">/* synchronized status register */</span>

<span class="cp">#define PCI1723_RANGE_CALIBRATION_MODE 0x14</span>
					<span class="cm">/* range and calibration mode */</span>
<span class="cp">#define PCI1723_RANGE_CALIBRATION_STATUS 0x14</span>
					<span class="cm">/* range and calibration status */</span>

<span class="cp">#define PCI1723_CONTROL_CMD_CALIBRATION_FUN 0x16</span>
						<span class="cm">/*</span>
<span class="cm">						 * SADC control command for</span>
<span class="cm">						 * calibration function</span>
<span class="cm">						 */</span>
<span class="cp">#define PCI1723_STATUS_CMD_CALIBRATION_FUN 0x16</span>
						<span class="cm">/*</span>
<span class="cm">						 * SADC control status for</span>
<span class="cm">						 * calibration function</span>
<span class="cm">						 */</span>

<span class="cp">#define PCI1723_CALIBRATION_PARA_STROBE 0x18</span>
					<span class="cm">/* Calibration parameter strobe */</span>

<span class="cp">#define PCI1723_DIGITAL_IO_PORT_SET 0x1A	</span><span class="cm">/* Digital I/O port setting */</span><span class="cp"></span>
<span class="cp">#define PCI1723_DIGITAL_IO_PORT_MODE 0x1A	</span><span class="cm">/* Digital I/O port mode */</span><span class="cp"></span>

<span class="cp">#define PCI1723_WRITE_DIGITAL_OUTPUT_CMD 0x1C</span>
					<span class="cm">/* Write digital output command */</span>
<span class="cp">#define PCI1723_READ_DIGITAL_INPUT_DATA 0x1C	</span><span class="cm">/* Read digital input data */</span><span class="cp"></span>

<span class="cp">#define PCI1723_WRITE_CAL_CMD 0x1E		</span><span class="cm">/* Write calibration command */</span><span class="cp"></span>
<span class="cp">#define PCI1723_READ_CAL_STATUS 0x1E		</span><span class="cm">/* Read calibration status */</span><span class="cp"></span>

<span class="cp">#define PCI1723_SYN_STROBE 0x20			</span><span class="cm">/* Synchronized strobe */</span><span class="cp"></span>

<span class="cp">#define PCI1723_RESET_ALL_CHN_STROBE 0x22</span>
					<span class="cm">/* Reset all D/A channels strobe */</span>

<span class="cp">#define PCI1723_RESET_CAL_CONTROL_STROBE 0x24</span>
						<span class="cm">/*</span>
<span class="cm">						 * Reset the calibration</span>
<span class="cm">						 * controller strobe</span>
<span class="cm">						 */</span>

<span class="cp">#define PCI1723_CHANGE_CHA_OUTPUT_TYPE_STROBE 0x26</span>
						<span class="cm">/*</span>
<span class="cm">						 * Change D/A channels output</span>
<span class="cm">						 * type strobe</span>
<span class="cm">						 */</span>

<span class="cp">#define PCI1723_SELECT_CALIBRATION 0x28	</span><span class="cm">/* Select the calibration Ref_V */</span><span class="cp"></span>

<span class="cm">/* static unsigned short pci_list_builded=0;      =1 list of card is know */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pci1723</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
							<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Board descriptions for pci1723 boards.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pci1723_board</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vendor_id</span><span class="p">;</span>		<span class="cm">/* PCI vendor a device ID of card */</span>
	<span class="kt">int</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iorange</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cardtype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_aochan</span><span class="p">;</span>		<span class="cm">/* num of D/A chans */</span>
	<span class="kt">int</span> <span class="n">n_diochan</span><span class="p">;</span>		<span class="cm">/* num of DIO chans */</span>
	<span class="kt">int</span> <span class="n">ao_maxdata</span><span class="p">;</span>		<span class="cm">/* resolution of D/A */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">rangelist_ao</span><span class="p">;</span>	<span class="cm">/* rangelist for D/A */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci1723_board</span> <span class="n">boardtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci1723&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ADVANTECH</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x1723</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iorange</span> <span class="o">=</span> <span class="n">IORANGE_1723</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">cardtype</span> <span class="o">=</span> <span class="n">TYPE_PCI1723</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_aochan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">n_diochan</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_maxdata</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">rangelist_ao</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pci1723</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* This structure is for data unique to this hardware driver. */</span>
<span class="k">struct</span> <span class="n">pci1723_private</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>		<span class="cm">/* card is usable; */</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">da_range</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* D/A output range for each channel */</span>

	<span class="kt">short</span> <span class="n">ao_data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* data output buffer */</span>
<span class="p">};</span>

<span class="cm">/* The following macro to make it easy to access the private structure. */</span>
<span class="cp">#define devpriv ((struct pci1723_private *)dev-&gt;private)</span>

<span class="cp">#define this_board boardtypes</span>

<span class="cm">/*</span>
<span class="cm"> * The pci1723 card reset;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci1723_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adv_pci1723 EDBG: BGN: pci1723_reset(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_SYN_SET</span><span class="p">);</span>
					       <span class="cm">/* set synchronous output mode */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set all outputs to 0V */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_DA</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="cm">/* set all ranges to +/- 10V */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">da_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">da_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">),</span>
		     <span class="n">PCI1723_RANGE_CALIBRATION_MODE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_CHANGE_CHA_OUTPUT_TYPE_STROBE</span><span class="p">);</span>
							    <span class="cm">/* update ranges */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_SYN_STROBE</span><span class="p">);</span>	    <span class="cm">/* update outputs */</span>

	<span class="cm">/* set asynchronous output mode */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_SYN_SET</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adv_pci1723 EDBG: END: pci1723_reset(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci1723_insn_read_ao</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot; adv_PCI1723 DEBUG: pci1723_insn_read_ao() -----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  analog data output;</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci1723_ao_write_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;PCI1723: the pci1723_ao_write_winsn() ------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_DA</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  digital i/o config/query</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci1723_dio_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dio_mode</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x00FF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0xFF00</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_INPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_OUTPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_QUERY</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">?</span> <span class="n">COMEDI_OUTPUT</span> <span class="o">:</span> <span class="n">COMEDI_INPUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update hardware DIO mode */</span>
	<span class="n">dio_mode</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>	<span class="cm">/* low byte output, high byte output */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dio_mode</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>	<span class="cm">/* low byte input */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dio_mode</span> <span class="o">|=</span> <span class="mh">0x0002</span><span class="p">;</span>	<span class="cm">/* high byte input */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">dio_mode</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_DIGITAL_IO_PORT_SET</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  digital i/o bits read/write</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci1723_dio_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_WRITE_DIGITAL_OUTPUT_CMD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_READ_DIGITAL_INPUT_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci1723_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">subdev</span><span class="p">,</span> <span class="n">n_subdevices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pci_bus</span><span class="p">,</span> <span class="n">pci_slot</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opt_bus</span><span class="p">,</span> <span class="n">opt_slot</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: adv_pci1723: board=%s&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">opt_bus</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">opt_slot</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci1723_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - Allocation failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Look for matching PCI device */</span>
	<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;not found!&quot;</span><span class="p">;</span>
	<span class="n">pcidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="p">(</span><span class="n">pcidev</span> <span class="o">=</span>
			<span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ADVANTECH</span><span class="p">,</span>
				       <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">pcidev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Found matching vendor/device. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt_bus</span> <span class="o">||</span> <span class="n">opt_slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check bus/slot. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_bus</span> <span class="o">!=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span>
			    <span class="o">||</span> <span class="n">opt_slot</span> <span class="o">!=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* no match */</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Look for device that isn&#39;t in use.</span>
<span class="cm">		 * Enable PCI device and request regions.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comedi_pci_enable</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;adv_pci1723&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">errstr</span> <span class="o">=</span>
			    <span class="s">&quot;failed to enable PCI device and request regions!&quot;</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcidev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt_bus</span> <span class="o">||</span> <span class="n">opt_slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; - Card at b:s %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">opt_bus</span><span class="p">,</span> <span class="n">opt_slot</span><span class="p">,</span> <span class="n">errstr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; - Card %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errstr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_bus</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">pci_slot</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">pci_func</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;, b:s:f=%d:%d:%d, io=0x%4x&quot;</span><span class="p">,</span>
					   <span class="n">pci_bus</span><span class="p">,</span> <span class="n">pci_slot</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>

	<span class="n">n_subdevices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_diochan</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n_subdevices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - Allocation failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci1723_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">subdev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITEABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_COMMON</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ao_maxdata</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">rangelist_ao</span><span class="p">;</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">pci1723_ao_write_winsn</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pci1723_insn_read_ao</span><span class="p">;</span>

		<span class="cm">/* read DIO config */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_DIGITAL_IO_PORT_MODE</span><span class="p">)</span>
								       <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:	<span class="cm">/* low byte output, high byte output */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:	<span class="cm">/* low byte input, high byte output */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="mh">0xFF00</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:	<span class="cm">/* low byte output, high byte input */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="mh">0x00FF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:	<span class="cm">/* low byte input, high byte input */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* read DIO port state */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI1723_READ_DIGITAL_INPUT_DATA</span><span class="p">);</span>

		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_diochan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DIO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span>
		    <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_COMMON</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_diochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_diochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="n">pci1723_dio_insn_config</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">pci1723_dio_insn_bits</span><span class="p">;</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pci1723_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci1723_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
			<span class="n">pci1723_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
				<span class="n">comedi_pci_disable</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">adv_pci1723_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;adv_pci1723&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">pci1723_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">pci1723_detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">adv_pci1723_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adv_pci1723_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">adv_pci1723_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">adv_pci1723_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ADVANTECH</span><span class="p">,</span> <span class="mh">0x1723</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">adv_pci1723_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">adv_pci1723_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;adv_pci1723&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">adv_pci1723_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">adv_pci1723_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">adv_pci1723_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_pci_driver</span><span class="p">(</span><span class="n">adv_pci1723_driver</span><span class="p">,</span> <span class="n">adv_pci1723_pci_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
