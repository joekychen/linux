<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › plx9080.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>plx9080.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* plx9080.h</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002,2003 Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * I modified this file from the plx9060.h header for the</span>
<span class="cm"> * wanXL device driver in the linux kernel,</span>
<span class="cm"> * for the register offsets and bit definitions.  Made minor modifications,</span>
<span class="cm"> * added plx9080 registers and</span>
<span class="cm"> * stripped out stuff that was specifically for the wanXL driver.</span>
<span class="cm"> * Note: I&#39;ve only made sure the definitions are correct as far</span>
<span class="cm"> * as I make use of them.  There are still various plx9060-isms</span>
<span class="cm"> * left in this header file.</span>
<span class="cm"> *</span>
<span class="cm"> ********************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999 RG Studio s.c.</span>
<span class="cm"> * Written by Krzysztof Halasa &lt;khc@rgstudio.com.pl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Portions (C) SBE Inc., used by permission.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __COMEDI_PLX9080_H</span>
<span class="cp">#define __COMEDI_PLX9080_H</span>

<span class="cm">/*  descriptor block used for chained dma transfers */</span>
<span class="k">struct</span> <span class="n">plx_dma_desc</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">pci_start_addr</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">local_start_addr</span><span class="p">;</span>
	<span class="cm">/* transfer_size is in bytes, only first 23 bits of register are used */</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">transfer_size</span><span class="p">;</span>
	<span class="cm">/* address of next descriptor (quad word aligned), plus some</span>
<span class="cm">	 * additional bits (see PLX_DMA0_DESCRIPTOR_REG) */</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************</span>
<span class="cm">**            Register Offsets and Bit Definitions</span>
<span class="cm">**</span>
<span class="cm">** Note: All offsets zero relative.  IE. Some standard base address</span>
<span class="cm">** must be added to the Register Number to properly access the register.</span>
<span class="cm">**</span>
<span class="cm">**********************************************************************/</span>

<span class="cp">#define PLX_LAS0RNG_REG         0x0000	</span><span class="cm">/* L, Local Addr Space 0 Range Register */</span><span class="cp"></span>
<span class="cp">#define PLX_LAS1RNG_REG         0x00f0	</span><span class="cm">/* L, Local Addr Space 1 Range Register */</span><span class="cp"></span>
<span class="cp">#define  LRNG_IO           0x00000001	</span><span class="cm">/* Map to: 1=I/O, 0=Mem */</span><span class="cp"></span>
<span class="cp">#define  LRNG_ANY32        0x00000000	</span><span class="cm">/* Locate anywhere in 32 bit */</span><span class="cp"></span>
<span class="cp">#define  LRNG_LT1MB        0x00000002	</span><span class="cm">/* Locate in 1st meg */</span><span class="cp"></span>
<span class="cp">#define  LRNG_ANY64        0x00000004	</span><span class="cm">/* Locate anywhere in 64 bit */</span><span class="cp"></span>
<span class="cp">#define  LRNG_MEM_MASK     0xfffffff0	</span><span class="cm">/*  bits that specify range for memory io */</span><span class="cp"></span>
<span class="cp">#define  LRNG_IO_MASK     0xfffffffa	</span><span class="cm">/*  bits that specify range for normal io */</span><span class="cp"></span>

<span class="cp">#define PLX_LAS0MAP_REG         0x0004	</span><span class="cm">/* L, Local Addr Space 0 Remap Register */</span><span class="cp"></span>
<span class="cp">#define PLX_LAS1MAP_REG         0x00f4	</span><span class="cm">/* L, Local Addr Space 1 Remap Register */</span><span class="cp"></span>
<span class="cp">#define  LMAP_EN           0x00000001	</span><span class="cm">/* Enable slave decode */</span><span class="cp"></span>
<span class="cp">#define  LMAP_MEM_MASK     0xfffffff0	</span><span class="cm">/*  bits that specify decode for memory io */</span><span class="cp"></span>
<span class="cp">#define  LMAP_IO_MASK     0xfffffffa	</span><span class="cm">/*  bits that specify decode bits for normal io */</span><span class="cp"></span>

<span class="cm">/* Mode/Arbitration Register.</span>
<span class="cm">*/</span>
<span class="cp">#define PLX_MARB_REG         0x8	</span><span class="cm">/* L, Local Arbitration Register */</span><span class="cp"></span>
<span class="cp">#define PLX_DMAARB_REG      0xac</span>
<span class="k">enum</span> <span class="n">marb_bits</span> <span class="p">{</span>
	<span class="n">MARB_LLT_MASK</span> <span class="o">=</span> <span class="mh">0x000000ff</span><span class="p">,</span>	<span class="cm">/* Local Bus Latency Timer */</span>
	<span class="n">MARB_LPT_MASK</span> <span class="o">=</span> <span class="mh">0x0000ff00</span><span class="p">,</span>	<span class="cm">/* Local Bus Pause Timer */</span>
	<span class="n">MARB_LTEN</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>	<span class="cm">/* Latency Timer Enable */</span>
	<span class="n">MARB_LPEN</span> <span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span>	<span class="cm">/* Pause Timer Enable */</span>
	<span class="n">MARB_BREQ</span> <span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>	<span class="cm">/* Local Bus BREQ Enable */</span>
	<span class="n">MARB_DMA_PRIORITY_MASK</span> <span class="o">=</span> <span class="mh">0x00180000</span><span class="p">,</span>
	<span class="n">MARB_LBDS_GIVE_UP_BUS_MODE</span> <span class="o">=</span> <span class="mh">0x00200000</span><span class="p">,</span>	<span class="cm">/* local bus direct slave give up bus mode */</span>
	<span class="n">MARB_DS_LLOCK_ENABLE</span> <span class="o">=</span> <span class="mh">0x00400000</span><span class="p">,</span>	<span class="cm">/* direct slave LLOCKo# enable */</span>
	<span class="n">MARB_PCI_REQUEST_MODE</span> <span class="o">=</span> <span class="mh">0x00800000</span><span class="p">,</span>
	<span class="n">MARB_PCIv21_MODE</span> <span class="o">=</span> <span class="mh">0x01000000</span><span class="p">,</span>	<span class="cm">/* pci specification v2.1 mode */</span>
	<span class="n">MARB_PCI_READ_NO_WRITE_MODE</span> <span class="o">=</span> <span class="mh">0x02000000</span><span class="p">,</span>
	<span class="n">MARB_PCI_READ_WITH_WRITE_FLUSH_MODE</span> <span class="o">=</span> <span class="mh">0x04000000</span><span class="p">,</span>
	<span class="n">MARB_GATE_TIMER_WITH_BREQ</span> <span class="o">=</span> <span class="mh">0x08000000</span><span class="p">,</span>	<span class="cm">/* gate local bus latency timer with BREQ */</span>
	<span class="n">MARB_PCI_READ_NO_FLUSH_MODE</span> <span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span>
	<span class="n">MARB_USE_SUBSYSTEM_IDS</span> <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define PLX_BIGEND_REG 0xc</span>
<span class="k">enum</span> <span class="n">bigend_bits</span> <span class="p">{</span>
	<span class="n">BIGEND_CONFIG</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>	<span class="cm">/* use big endian ordering for configuration register accesses */</span>
	<span class="n">BIGEND_DIRECT_MASTER</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">BIGEND_DIRECT_SLAVE_LOCAL0</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">BIGEND_ROM</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="n">BIGEND_BYTE_LANE</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>	<span class="cm">/* use byte lane consisting of most significant bits instead of least significant */</span>
	<span class="n">BIGEND_DIRECT_SLAVE_LOCAL1</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">BIGEND_DMA1</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">BIGEND_DMA0</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Note: The Expansion ROM  stuff is only relevant to the PC environment.</span>
<span class="cm">**       This expansion ROM code is executed by the host CPU at boot time.</span>
<span class="cm">**       For this reason no bit definitions are provided here.</span>
<span class="cm">*/</span>
<span class="cp">#define PLX_ROMRNG_REG         0x0010	</span><span class="cm">/* L, Expn ROM Space Range Register */</span><span class="cp"></span>
<span class="cp">#define PLX_ROMMAP_REG         0x0014	</span><span class="cm">/* L, Local Addr Space Range Register */</span><span class="cp"></span>

<span class="cp">#define PLX_REGION0_REG         0x0018	</span><span class="cm">/* L, Local Bus Region 0 Descriptor */</span><span class="cp"></span>
<span class="cp">#define  RGN_WIDTH         0x00000002	</span><span class="cm">/* Local bus width bits */</span><span class="cp"></span>
<span class="cp">#define  RGN_8BITS         0x00000000	</span><span class="cm">/* 08 bit Local Bus */</span><span class="cp"></span>
<span class="cp">#define  RGN_16BITS        0x00000001	</span><span class="cm">/* 16 bit Local Bus */</span><span class="cp"></span>
<span class="cp">#define  RGN_32BITS        0x00000002	</span><span class="cm">/* 32 bit Local Bus */</span><span class="cp"></span>
<span class="cp">#define  RGN_MWS           0x0000003C	</span><span class="cm">/* Memory Access Wait States */</span><span class="cp"></span>
<span class="cp">#define  RGN_0MWS          0x00000000</span>
<span class="cp">#define  RGN_1MWS          0x00000004</span>
<span class="cp">#define  RGN_2MWS          0x00000008</span>
<span class="cp">#define  RGN_3MWS          0x0000000C</span>
<span class="cp">#define  RGN_4MWS          0x00000010</span>
<span class="cp">#define  RGN_6MWS          0x00000018</span>
<span class="cp">#define  RGN_8MWS          0x00000020</span>
<span class="cp">#define  RGN_MRE           0x00000040	</span><span class="cm">/* Memory Space Ready Input Enable */</span><span class="cp"></span>
<span class="cp">#define  RGN_MBE           0x00000080	</span><span class="cm">/* Memory Space Bterm Input Enable */</span><span class="cp"></span>
<span class="cp">#define  RGN_READ_PREFETCH_DISABLE 0x00000100</span>
<span class="cp">#define  RGN_ROM_PREFETCH_DISABLE 0x00000200</span>
<span class="cp">#define  RGN_READ_PREFETCH_COUNT_ENABLE 0x00000400</span>
<span class="cp">#define  RGN_RWS           0x003C0000	</span><span class="cm">/* Expn ROM Wait States */</span><span class="cp"></span>
<span class="cp">#define  RGN_RRE           0x00400000	</span><span class="cm">/* ROM Space Ready Input Enable */</span><span class="cp"></span>
<span class="cp">#define  RGN_RBE           0x00800000	</span><span class="cm">/* ROM Space Bterm Input Enable */</span><span class="cp"></span>
<span class="cp">#define  RGN_MBEN          0x01000000	</span><span class="cm">/* Memory Space Burst Enable */</span><span class="cp"></span>
<span class="cp">#define  RGN_RBEN          0x04000000	</span><span class="cm">/* ROM Space Burst Enable */</span><span class="cp"></span>
<span class="cp">#define  RGN_THROT         0x08000000	</span><span class="cm">/* De-assert TRDY when FIFO full */</span><span class="cp"></span>
<span class="cp">#define  RGN_TRD           0xF0000000	</span><span class="cm">/* Target Ready Delay /8 */</span><span class="cp"></span>

<span class="cp">#define PLX_REGION1_REG         0x00f8	</span><span class="cm">/* L, Local Bus Region 1 Descriptor */</span><span class="cp"></span>

<span class="cp">#define PLX_DMRNG_REG          0x001C	</span><span class="cm">/* L, Direct Master Range Register */</span><span class="cp"></span>

<span class="cp">#define PLX_LBAPMEM_REG        0x0020	</span><span class="cm">/* L, Lcl Base Addr for PCI mem space */</span><span class="cp"></span>

<span class="cp">#define PLX_LBAPIO_REG         0x0024	</span><span class="cm">/* L, Lcl Base Addr for PCI I/O space */</span><span class="cp"></span>

<span class="cp">#define PLX_DMMAP_REG          0x0028	</span><span class="cm">/* L, Direct Master Remap Register */</span><span class="cp"></span>
<span class="cp">#define  DMM_MAE           0x00000001	</span><span class="cm">/* Direct Mstr Memory Acc Enable */</span><span class="cp"></span>
<span class="cp">#define  DMM_IAE           0x00000002	</span><span class="cm">/* Direct Mstr I/O Acc Enable */</span><span class="cp"></span>
<span class="cp">#define  DMM_LCK           0x00000004	</span><span class="cm">/* LOCK Input Enable */</span><span class="cp"></span>
<span class="cp">#define  DMM_PF4           0x00000008	</span><span class="cm">/* Prefetch 4 Mode Enable */</span><span class="cp"></span>
<span class="cp">#define  DMM_THROT         0x00000010	</span><span class="cm">/* Assert IRDY when read FIFO full */</span><span class="cp"></span>
<span class="cp">#define  DMM_PAF0          0x00000000	</span><span class="cm">/* Programmable Almost fill level */</span><span class="cp"></span>
<span class="cp">#define  DMM_PAF1          0x00000020	</span><span class="cm">/* Programmable Almost fill level */</span><span class="cp"></span>
<span class="cp">#define  DMM_PAF2          0x00000040	</span><span class="cm">/* Programmable Almost fill level */</span><span class="cp"></span>
<span class="cp">#define  DMM_PAF3          0x00000060	</span><span class="cm">/* Programmable Almost fill level */</span><span class="cp"></span>
<span class="cp">#define  DMM_PAF4          0x00000080	</span><span class="cm">/* Programmable Almost fill level */</span><span class="cp"></span>
<span class="cp">#define  DMM_PAF5          0x000000A0	</span><span class="cm">/* Programmable Almost fill level */</span><span class="cp"></span>
<span class="cp">#define  DMM_PAF6          0x000000C0	</span><span class="cm">/* Programmable Almost fill level */</span><span class="cp"></span>
<span class="cp">#define  DMM_PAF7          0x000000D0	</span><span class="cm">/* Programmable Almost fill level */</span><span class="cp"></span>
<span class="cp">#define  DMM_MAP           0xFFFF0000	</span><span class="cm">/* Remap Address Bits */</span><span class="cp"></span>

<span class="cp">#define PLX_CAR_REG            0x002C	</span><span class="cm">/* L, Configuration Address Register */</span><span class="cp"></span>
<span class="cp">#define  CAR_CT0           0x00000000	</span><span class="cm">/* Config Type 0 */</span><span class="cp"></span>
<span class="cp">#define  CAR_CT1           0x00000001	</span><span class="cm">/* Config Type 1 */</span><span class="cp"></span>
<span class="cp">#define  CAR_REG           0x000000FC	</span><span class="cm">/* Register Number Bits */</span><span class="cp"></span>
<span class="cp">#define  CAR_FUN           0x00000700	</span><span class="cm">/* Function Number Bits */</span><span class="cp"></span>
<span class="cp">#define  CAR_DEV           0x0000F800	</span><span class="cm">/* Device Number Bits */</span><span class="cp"></span>
<span class="cp">#define  CAR_BUS           0x00FF0000	</span><span class="cm">/* Bus Number Bits */</span><span class="cp"></span>
<span class="cp">#define  CAR_CFG           0x80000000	</span><span class="cm">/* Config Spc Access Enable */</span><span class="cp"></span>

<span class="cp">#define PLX_DBR_IN_REG         0x0060	</span><span class="cm">/* L, PCI to Local Doorbell Register */</span><span class="cp"></span>

<span class="cp">#define PLX_DBR_OUT_REG        0x0064	</span><span class="cm">/* L, Local to PCI Doorbell Register */</span><span class="cp"></span>

<span class="cp">#define PLX_INTRCS_REG         0x0068	</span><span class="cm">/* L, Interrupt Control/Status Reg */</span><span class="cp"></span>
<span class="cp">#define  ICS_AERR          0x00000001	</span><span class="cm">/* Assert LSERR on ABORT */</span><span class="cp"></span>
<span class="cp">#define  ICS_PERR          0x00000002	</span><span class="cm">/* Assert LSERR on Parity Error */</span><span class="cp"></span>
<span class="cp">#define  ICS_SERR          0x00000004	</span><span class="cm">/* Generate PCI SERR# */</span><span class="cp"></span>
<span class="cp">#define  ICS_MBIE          0x00000008	</span><span class="cm">/*  mailbox interrupt enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_PIE           0x00000100	</span><span class="cm">/* PCI Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_PDIE          0x00000200	</span><span class="cm">/* PCI Doorbell Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_PAIE          0x00000400	</span><span class="cm">/* PCI Abort Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_PLIE          0x00000800	</span><span class="cm">/* PCI Local Int Enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_RAE           0x00001000	</span><span class="cm">/* Retry Abort Enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_PDIA          0x00002000	</span><span class="cm">/* PCI Doorbell Interrupt Active */</span><span class="cp"></span>
<span class="cp">#define  ICS_PAIA          0x00004000	</span><span class="cm">/* PCI Abort Interrupt Active */</span><span class="cp"></span>
<span class="cp">#define  ICS_LIA           0x00008000	</span><span class="cm">/* Local Interrupt Active */</span><span class="cp"></span>
<span class="cp">#define  ICS_LIE           0x00010000	</span><span class="cm">/* Local Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_LDIE          0x00020000	</span><span class="cm">/* Local Doorbell Int Enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_DMA0_E        0x00040000	</span><span class="cm">/* DMA #0 Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_DMA1_E        0x00080000	</span><span class="cm">/* DMA #1 Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define  ICS_LDIA          0x00100000	</span><span class="cm">/* Local Doorbell Int Active */</span><span class="cp"></span>
<span class="cp">#define  ICS_DMA0_A        0x00200000	</span><span class="cm">/* DMA #0 Interrupt Active */</span><span class="cp"></span>
<span class="cp">#define  ICS_DMA1_A        0x00400000	</span><span class="cm">/* DMA #1 Interrupt Active */</span><span class="cp"></span>
<span class="cp">#define  ICS_BIA           0x00800000	</span><span class="cm">/* BIST Interrupt Active */</span><span class="cp"></span>
<span class="cp">#define  ICS_TA_DM         0x01000000	</span><span class="cm">/* Target Abort - Direct Master */</span><span class="cp"></span>
<span class="cp">#define  ICS_TA_DMA0       0x02000000	</span><span class="cm">/* Target Abort - DMA #0 */</span><span class="cp"></span>
<span class="cp">#define  ICS_TA_DMA1       0x04000000	</span><span class="cm">/* Target Abort - DMA #1 */</span><span class="cp"></span>
<span class="cp">#define  ICS_TA_RA         0x08000000	</span><span class="cm">/* Target Abort - Retry Timeout */</span><span class="cp"></span>
<span class="cp">#define  ICS_MBIA(x)       (0x10000000 &lt;&lt; ((x) &amp; 0x3))	</span><span class="cm">/*  mailbox x is active */</span><span class="cp"></span>

<span class="cp">#define PLX_CONTROL_REG        0x006C	</span><span class="cm">/* L, EEPROM Cntl &amp; PCI Cmd Codes */</span><span class="cp"></span>
<span class="cp">#define  CTL_RDMA          0x0000000E	</span><span class="cm">/* DMA Read Command */</span><span class="cp"></span>
<span class="cp">#define  CTL_WDMA          0x00000070	</span><span class="cm">/* DMA Write Command */</span><span class="cp"></span>
<span class="cp">#define  CTL_RMEM          0x00000600	</span><span class="cm">/* Memory Read Command */</span><span class="cp"></span>
<span class="cp">#define  CTL_WMEM          0x00007000	</span><span class="cm">/* Memory Write Command */</span><span class="cp"></span>
<span class="cp">#define  CTL_USERO         0x00010000	</span><span class="cm">/* USERO output pin control bit */</span><span class="cp"></span>
<span class="cp">#define  CTL_USERI         0x00020000	</span><span class="cm">/* USERI input pin bit */</span><span class="cp"></span>
<span class="cp">#define  CTL_EE_CLK        0x01000000	</span><span class="cm">/* EEPROM Clock line */</span><span class="cp"></span>
<span class="cp">#define  CTL_EE_CS         0x02000000	</span><span class="cm">/* EEPROM Chip Select */</span><span class="cp"></span>
<span class="cp">#define  CTL_EE_W          0x04000000	</span><span class="cm">/* EEPROM Write bit */</span><span class="cp"></span>
<span class="cp">#define  CTL_EE_R          0x08000000	</span><span class="cm">/* EEPROM Read bit */</span><span class="cp"></span>
<span class="cp">#define  CTL_EECHK         0x10000000	</span><span class="cm">/* EEPROM Present bit */</span><span class="cp"></span>
<span class="cp">#define  CTL_EERLD         0x20000000	</span><span class="cm">/* EEPROM Reload Register */</span><span class="cp"></span>
<span class="cp">#define  CTL_RESET         0x40000000	</span><span class="cm">/* !! Adapter Reset !! */</span><span class="cp"></span>
<span class="cp">#define  CTL_READY         0x80000000	</span><span class="cm">/* Local Init Done */</span><span class="cp"></span>

<span class="cp">#define PLX_ID_REG	0x70	</span><span class="cm">/*  hard-coded plx vendor and device ids */</span><span class="cp"></span>

<span class="cp">#define PLX_REVISION_REG	0x74	</span><span class="cm">/*  silicon revision */</span><span class="cp"></span>

<span class="cp">#define PLX_DMA0_MODE_REG	0x80	</span><span class="cm">/*  dma channel 0 mode register */</span><span class="cp"></span>
<span class="cp">#define PLX_DMA1_MODE_REG	0x94	</span><span class="cm">/*  dma channel 0 mode register */</span><span class="cp"></span>
<span class="cp">#define  PLX_LOCAL_BUS_16_WIDE_BITS	0x1</span>
<span class="cp">#define  PLX_LOCAL_BUS_32_WIDE_BITS	0x3</span>
<span class="cp">#define  PLX_LOCAL_BUS_WIDTH_MASK	0x3</span>
<span class="cp">#define  PLX_DMA_EN_READYIN_BIT	0x40	</span><span class="cm">/*  enable ready in input */</span><span class="cp"></span>
<span class="cp">#define  PLX_EN_BTERM_BIT	0x80	</span><span class="cm">/*  enable BTERM# input */</span><span class="cp"></span>
<span class="cp">#define  PLX_DMA_LOCAL_BURST_EN_BIT	0x100	</span><span class="cm">/*  enable local burst mode */</span><span class="cp"></span>
<span class="cp">#define  PLX_EN_CHAIN_BIT	0x200	</span><span class="cm">/*  enables chaining */</span><span class="cp"></span>
<span class="cp">#define  PLX_EN_DMA_DONE_INTR_BIT	0x400	</span><span class="cm">/*  enables interrupt on dma done */</span><span class="cp"></span>
<span class="cp">#define  PLX_LOCAL_ADDR_CONST_BIT	0x800	</span><span class="cm">/*  hold local address constant (don&#39;t increment) */</span><span class="cp"></span>
<span class="cp">#define  PLX_DEMAND_MODE_BIT	0x1000	</span><span class="cm">/*  enables demand-mode for dma transfer */</span><span class="cp"></span>
<span class="cp">#define  PLX_EOT_ENABLE_BIT	0x4000</span>
<span class="cp">#define  PLX_STOP_MODE_BIT 0x8000</span>
<span class="cp">#define  PLX_DMA_INTR_PCI_BIT	0x20000	</span><span class="cm">/*  routes dma interrupt to pci bus (instead of local bus) */</span><span class="cp"></span>

<span class="cp">#define PLX_DMA0_PCI_ADDRESS_REG	0x84	</span><span class="cm">/*  pci address that dma transfers start at */</span><span class="cp"></span>
<span class="cp">#define PLX_DMA1_PCI_ADDRESS_REG	0x98</span>

<span class="cp">#define PLX_DMA0_LOCAL_ADDRESS_REG	0x88	</span><span class="cm">/*  local address that dma transfers start at */</span><span class="cp"></span>
<span class="cp">#define PLX_DMA1_LOCAL_ADDRESS_REG	0x9c</span>

<span class="cp">#define PLX_DMA0_TRANSFER_SIZE_REG	0x8c	</span><span class="cm">/*  number of bytes to transfer (first 23 bits) */</span><span class="cp"></span>
<span class="cp">#define PLX_DMA1_TRANSFER_SIZE_REG	0xa0</span>

<span class="cp">#define PLX_DMA0_DESCRIPTOR_REG	0x90	</span><span class="cm">/*  descriptor pointer register */</span><span class="cp"></span>
<span class="cp">#define PLX_DMA1_DESCRIPTOR_REG	0xa4</span>
<span class="cp">#define  PLX_DESC_IN_PCI_BIT	0x1	</span><span class="cm">/*  descriptor is located in pci space (not local space) */</span><span class="cp"></span>
<span class="cp">#define  PLX_END_OF_CHAIN_BIT	0x2	</span><span class="cm">/*  end of chain bit */</span><span class="cp"></span>
<span class="cp">#define  PLX_INTR_TERM_COUNT	0x4	</span><span class="cm">/*  interrupt when this descriptor&#39;s transfer is finished */</span><span class="cp"></span>
<span class="cp">#define  PLX_XFER_LOCAL_TO_PCI 0x8	</span><span class="cm">/*  transfer from local to pci bus (not pci to local) */</span><span class="cp"></span>

<span class="cp">#define PLX_DMA0_CS_REG	0xa8	</span><span class="cm">/*  command status register */</span><span class="cp"></span>
<span class="cp">#define PLX_DMA1_CS_REG	0xa9</span>
<span class="cp">#define  PLX_DMA_EN_BIT	0x1	</span><span class="cm">/*  enable dma channel */</span><span class="cp"></span>
<span class="cp">#define  PLX_DMA_START_BIT	0x2	</span><span class="cm">/*  start dma transfer */</span><span class="cp"></span>
<span class="cp">#define  PLX_DMA_ABORT_BIT	0x4	</span><span class="cm">/*  abort dma transfer */</span><span class="cp"></span>
<span class="cp">#define  PLX_CLEAR_DMA_INTR_BIT	0x8	</span><span class="cm">/*  clear dma interrupt */</span><span class="cp"></span>
<span class="cp">#define  PLX_DMA_DONE_BIT	0x10	</span><span class="cm">/*  transfer done status bit */</span><span class="cp"></span>

<span class="cp">#define PLX_DMA0_THRESHOLD_REG	0xb0	</span><span class="cm">/*  command status register */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Accesses near the end of memory can cause the PLX chip</span>
<span class="cm"> * to pre-fetch data off of end-of-ram.  Limit the size of</span>
<span class="cm"> * memory so host-side accesses cannot occur.</span>
<span class="cm"> */</span>

<span class="cp">#define PLX_PREFETCH   32</span>

<span class="cm">/*</span>
<span class="cm"> * The PCI Interface, via the PCI-9060 Chip, has up to eight (8) Mailbox</span>
<span class="cm"> * Registers.  The PUTS (Power-Up Test Suite) handles the board-side</span>
<span class="cm"> * interface/interaction using the first 4 registers.  Specifications for</span>
<span class="cm"> * the use of the full PUTS&#39; command and status interface is contained</span>
<span class="cm"> * within a separate SBE PUTS Manual.  The Host-Side Device Driver only</span>
<span class="cm"> * uses a subset of the full PUTS interface.</span>
<span class="cm"> */</span>

<span class="cm">/*****************************************/</span>
<span class="cm">/***    MAILBOX #(-1) - MEM ACCESS STS ***/</span>
<span class="cm">/*****************************************/</span>

<span class="cp">#define MBX_STS_VALID      0x57584744	</span><span class="cm">/* &#39;WXGD&#39; */</span><span class="cp"></span>
<span class="cp">#define MBX_STS_DILAV      0x44475857	</span><span class="cm">/* swapped = &#39;DGXW&#39; */</span><span class="cp"></span>

<span class="cm">/*****************************************/</span>
<span class="cm">/***    MAILBOX #0  -  PUTS STATUS     ***/</span>
<span class="cm">/*****************************************/</span>

<span class="cp">#define MBX_STS_MASK       0x000000ff	</span><span class="cm">/* PUTS Status Register bits */</span><span class="cp"></span>
<span class="cp">#define MBX_STS_TMASK      0x0000000f	</span><span class="cm">/* register bits for TEST number */</span><span class="cp"></span>

<span class="cp">#define MBX_STS_PCIRESET   0x00000100	</span><span class="cm">/* Host issued PCI reset request */</span><span class="cp"></span>
<span class="cp">#define MBX_STS_BUSY       0x00000080	</span><span class="cm">/* PUTS is in progress */</span><span class="cp"></span>
<span class="cp">#define MBX_STS_ERROR      0x00000040	</span><span class="cm">/* PUTS has failed */</span><span class="cp"></span>
<span class="cp">#define MBX_STS_RESERVED   0x000000c0	</span><span class="cm">/* Undefined -&gt; status in transition.</span>
<span class="cm">					   We are in process of changing</span>
<span class="cm">					   bits; we SET Error bit before</span>
<span class="cm">					   RESET of Busy bit */</span><span class="cp"></span>

<span class="cp">#define MBX_RESERVED_5     0x00000020	</span><span class="cm">/* FYI: reserved/unused bit */</span><span class="cp"></span>
<span class="cp">#define MBX_RESERVED_4     0x00000010	</span><span class="cm">/* FYI: reserved/unused bit */</span><span class="cp"></span>

<span class="cm">/******************************************/</span>
<span class="cm">/***    MAILBOX #1  -  PUTS COMMANDS    ***/</span>
<span class="cm">/******************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Any attempt to execute an unimplement command results in the PUTS</span>
<span class="cm"> * interface executing a NOOP and continuing as if the offending command</span>
<span class="cm"> * completed normally.  Note: this supplies a simple method to interrogate</span>
<span class="cm"> * mailbox command processing functionality.</span>
<span class="cm"> */</span>

<span class="cp">#define MBX_CMD_MASK       0xffff0000	</span><span class="cm">/* PUTS Command Register bits */</span><span class="cp"></span>

<span class="cp">#define MBX_CMD_ABORTJ     0x85000000	</span><span class="cm">/* abort and jump */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_RESETP     0x86000000	</span><span class="cm">/* reset and pause at start */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_PAUSE      0x87000000	</span><span class="cm">/* pause immediately */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_PAUSEC     0x88000000	</span><span class="cm">/* pause on completion */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_RESUME     0x89000000	</span><span class="cm">/* resume operation */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_STEP       0x8a000000	</span><span class="cm">/* single step tests */</span><span class="cp"></span>

<span class="cp">#define MBX_CMD_BSWAP      0x8c000000	</span><span class="cm">/* identify byte swap scheme */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_BSWAP_0    0x8c000000	</span><span class="cm">/* use scheme 0 */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_BSWAP_1    0x8c000001	</span><span class="cm">/* use scheme 1 */</span><span class="cp"></span>

<span class="cp">#define MBX_CMD_SETHMS     0x8d000000	</span><span class="cm">/* setup host memory access window</span>
<span class="cm">					   size */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_SETHBA     0x8e000000	</span><span class="cm">/* setup host memory access base</span>
<span class="cm">					   address */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_MGO        0x8f000000	</span><span class="cm">/* perform memory setup and continue</span>
<span class="cm">					   (IE. Done) */</span><span class="cp"></span>
<span class="cp">#define MBX_CMD_NOOP       0xFF000000	</span><span class="cm">/* dummy, illegal command */</span><span class="cp"></span>

<span class="cm">/*****************************************/</span>
<span class="cm">/***    MAILBOX #2  -  MEMORY SIZE     ***/</span>
<span class="cm">/*****************************************/</span>

<span class="cp">#define MBX_MEMSZ_MASK     0xffff0000	</span><span class="cm">/* PUTS Memory Size Register bits */</span><span class="cp"></span>

<span class="cp">#define MBX_MEMSZ_128KB    0x00020000	</span><span class="cm">/* 128 kilobyte board */</span><span class="cp"></span>
<span class="cp">#define MBX_MEMSZ_256KB    0x00040000	</span><span class="cm">/* 256 kilobyte board */</span><span class="cp"></span>
<span class="cp">#define MBX_MEMSZ_512KB    0x00080000	</span><span class="cm">/* 512 kilobyte board */</span><span class="cp"></span>
<span class="cp">#define MBX_MEMSZ_1MB      0x00100000	</span><span class="cm">/* 1 megabyte board */</span><span class="cp"></span>
<span class="cp">#define MBX_MEMSZ_2MB      0x00200000	</span><span class="cm">/* 2 megabyte board */</span><span class="cp"></span>
<span class="cp">#define MBX_MEMSZ_4MB      0x00400000	</span><span class="cm">/* 4 megabyte board */</span><span class="cp"></span>
<span class="cp">#define MBX_MEMSZ_8MB      0x00800000	</span><span class="cm">/* 8 megabyte board */</span><span class="cp"></span>
<span class="cp">#define MBX_MEMSZ_16MB     0x01000000	</span><span class="cm">/* 16 megabyte board */</span><span class="cp"></span>

<span class="cm">/***************************************/</span>
<span class="cm">/***    MAILBOX #2  -  BOARD TYPE    ***/</span>
<span class="cm">/***************************************/</span>

<span class="cp">#define MBX_BTYPE_MASK          0x0000ffff	</span><span class="cm">/* PUTS Board Type Register */</span><span class="cp"></span>
<span class="cp">#define MBX_BTYPE_FAMILY_MASK   0x0000ff00	</span><span class="cm">/* PUTS Board Family Register */</span><span class="cp"></span>
<span class="cp">#define MBX_BTYPE_SUBTYPE_MASK  0x000000ff	</span><span class="cm">/* PUTS Board Subtype */</span><span class="cp"></span>

<span class="cp">#define MBX_BTYPE_PLX9060       0x00000100	</span><span class="cm">/* PLX family type */</span><span class="cp"></span>
<span class="cp">#define MBX_BTYPE_PLX9080       0x00000300	</span><span class="cm">/* PLX wanXL100s family type */</span><span class="cp"></span>

<span class="cp">#define MBX_BTYPE_WANXL_4       0x00000104	</span><span class="cm">/* wanXL400, 4-port */</span><span class="cp"></span>
<span class="cp">#define MBX_BTYPE_WANXL_2       0x00000102	</span><span class="cm">/* wanXL200, 2-port */</span><span class="cp"></span>
<span class="cp">#define MBX_BTYPE_WANXL_1s      0x00000301	</span><span class="cm">/* wanXL100s, 1-port */</span><span class="cp"></span>
<span class="cp">#define MBX_BTYPE_WANXL_1t      0x00000401	</span><span class="cm">/* wanXL100T1, 1-port */</span><span class="cp"></span>

<span class="cm">/*****************************************/</span>
<span class="cm">/***    MAILBOX #3  -  SHMQ MAILBOX    ***/</span>
<span class="cm">/*****************************************/</span>

<span class="cp">#define MBX_SMBX_MASK           0x000000ff	</span><span class="cm">/* PUTS SHMQ Mailbox bits */</span><span class="cp"></span>

<span class="cm">/***************************************/</span>
<span class="cm">/***    GENERIC HOST-SIDE DRIVER     ***/</span>
<span class="cm">/***************************************/</span>

<span class="cp">#define MBX_ERR    0</span>
<span class="cp">#define MBX_OK     1</span>

<span class="cm">/* mailbox check routine - type of testing */</span>
<span class="cp">#define MBXCHK_STS      0x00	</span><span class="cm">/* check for PUTS status */</span><span class="cp"></span>
<span class="cp">#define MBXCHK_NOWAIT   0x01	</span><span class="cm">/* dont care about PUTS status */</span><span class="cp"></span>

<span class="cm">/* system allocates this many bytes for address mapping mailbox space */</span>
<span class="cp">#define MBX_ADDR_SPACE_360 0x80	</span><span class="cm">/* wanXL100s/200/400 */</span><span class="cp"></span>
<span class="cp">#define MBX_ADDR_MASK_360 (MBX_ADDR_SPACE_360-1)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">plx9080_abort_dma</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iobase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma_cs_addr</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">dma_status</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">dma_cs_addr</span> <span class="o">=</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PLX_DMA1_CS_REG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dma_cs_addr</span> <span class="o">=</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PLX_DMA0_CS_REG</span><span class="p">;</span>

	<span class="cm">/*  abort dma transfer if necessary */</span>
	<span class="n">dma_status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">dma_cs_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dma_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_EN_BIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*  wait to make sure done bit is zero */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">dma_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_DONE_BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">dma_status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">dma_cs_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;plx9080: cancel() timed out waiting for dma %i done clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  disable and abort channel */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">PLX_DMA_ABORT_BIT</span><span class="p">,</span> <span class="n">dma_cs_addr</span><span class="p">);</span>
	<span class="cm">/*  wait for dma done bit */</span>
	<span class="n">dma_status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">dma_cs_addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">dma_status</span> <span class="o">&amp;</span> <span class="n">PLX_DMA_DONE_BIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">dma_status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">dma_cs_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;plx9080: cancel() timed out waiting for dma %i done set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __COMEDI_PLX9080_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
