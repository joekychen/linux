<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › amplc_pci224.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>amplc_pci224.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/drivers/amplc_pci224.c</span>
<span class="cm">    Driver for Amplicon PCI224 and PCI234 AO boards.</span>

<span class="cm">    Copyright (C) 2005 MEV Ltd. &lt;http://www.mev.co.uk/&gt;</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 1998,2000 David A. Schleef &lt;ds@schleef.org&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">Driver: amplc_pci224</span>
<span class="cm">Description: Amplicon PCI224, PCI234</span>
<span class="cm">Author: Ian Abbott &lt;abbotti@mev.co.uk&gt;</span>
<span class="cm">Devices: [Amplicon] PCI224 (amplc_pci224 or pci224),</span>
<span class="cm">  PCI234 (amplc_pci224 or pci234)</span>
<span class="cm">Updated: Wed, 22 Oct 2008 12:25:08 +0100</span>
<span class="cm">Status: works, but see caveats</span>

<span class="cm">Supports:</span>

<span class="cm">  - ao_insn read/write</span>
<span class="cm">  - ao_do_cmd mode with the following sources:</span>

<span class="cm">    - start_src         TRIG_INT        TRIG_EXT</span>
<span class="cm">    - scan_begin_src    TRIG_TIMER      TRIG_EXT</span>
<span class="cm">    - convert_src       TRIG_NOW</span>
<span class="cm">    - scan_end_src      TRIG_COUNT</span>
<span class="cm">    - stop_src          TRIG_COUNT      TRIG_EXT        TRIG_NONE</span>

<span class="cm">    The channel list must contain at least one channel with no repeated</span>
<span class="cm">    channels.  The scan end count must equal the number of channels in</span>
<span class="cm">    the channel list.</span>

<span class="cm">    There is only one external trigger source so only one of start_src,</span>
<span class="cm">    scan_begin_src or stop_src may use TRIG_EXT.</span>

<span class="cm">Configuration options - PCI224:</span>
<span class="cm">  [0] - PCI bus of device (optional).</span>
<span class="cm">  [1] - PCI slot of device (optional).</span>
<span class="cm">          If bus/slot is not specified, the first available PCI device</span>
<span class="cm">          will be used.</span>
<span class="cm">  [2] - Select available ranges according to jumper LK1.  All channels</span>
<span class="cm">        are set to the same range:</span>
<span class="cm">        0=Jumper position 1-2 (factory default), 4 software-selectable</span>
<span class="cm">          internal voltage references, giving 4 bipolar and 4 unipolar</span>
<span class="cm">          ranges:</span>
<span class="cm">            [-10V,+10V], [-5V,+5V], [-2.5V,+2.5V], [-1.25V,+1.25V],</span>
<span class="cm">            [0,+10V], [0,+5V], [0,+2.5V], [0,1.25V].</span>
<span class="cm">        1=Jumper position 2-3, 1 external voltage reference, giving</span>
<span class="cm">          1 bipolar and 1 unipolar range:</span>
<span class="cm">            [-Vext,+Vext], [0,+Vext].</span>

<span class="cm">Configuration options - PCI234:</span>
<span class="cm">  [0] - PCI bus of device (optional).</span>
<span class="cm">  [1] - PCI slot of device (optional).</span>
<span class="cm">          If bus/slot is not specified, the first available PCI device</span>
<span class="cm">          will be used.</span>
<span class="cm">  [2] - Select internal or external voltage reference according to</span>
<span class="cm">        jumper LK1.  This affects all channels:</span>
<span class="cm">        0=Jumper position 1-2 (factory default), Vref=5V internal.</span>
<span class="cm">        1=Jumper position 2-3, Vref=Vext external.</span>
<span class="cm">  [3] - Select channel 0 range according to jumper LK2:</span>
<span class="cm">        0=Jumper position 2-3 (factory default), range [-2*Vref,+2*Vref]</span>
<span class="cm">          (10V bipolar when options[2]=0).</span>
<span class="cm">        1=Jumper position 1-2, range [-Vref,+Vref]</span>
<span class="cm">          (5V bipolar when options[2]=0).</span>
<span class="cm">  [4] - Select channel 1 range according to jumper LK3: cf. options[3].</span>
<span class="cm">  [5] - Select channel 2 range according to jumper LK4: cf. options[3].</span>
<span class="cm">  [6] - Select channel 3 range according to jumper LK5: cf. options[3].</span>

<span class="cm">Passing a zero for an option is the same as leaving it unspecified.</span>

<span class="cm">Caveats:</span>

<span class="cm">  1) All channels on the PCI224 share the same range.  Any change to the</span>
<span class="cm">     range as a result of insn_write or a streaming command will affect</span>
<span class="cm">     the output voltages of all channels, including those not specified</span>
<span class="cm">     by the instruction or command.</span>

<span class="cm">  2) For the analog output command,  the first scan may be triggered</span>
<span class="cm">     falsely at the start of acquisition.  This occurs when the DAC scan</span>
<span class="cm">     trigger source is switched from &#39;none&#39; to &#39;timer&#39; (scan_begin_src =</span>
<span class="cm">     TRIG_TIMER) or &#39;external&#39; (scan_begin_src == TRIG_EXT) at the start</span>
<span class="cm">     of acquisition and the trigger source is at logic level 1 at the</span>
<span class="cm">     time of the switch.  This is very likely for TRIG_TIMER.  For</span>
<span class="cm">     TRIG_EXT, it depends on the state of the external line and whether</span>
<span class="cm">     the CR_INVERT flag has been set.  The remaining scans are triggered</span>
<span class="cm">     correctly.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &quot;comedi_pci.h&quot;</span>

<span class="cp">#include &quot;comedi_fc.h&quot;</span>
<span class="cp">#include &quot;8253.h&quot;</span>

<span class="cp">#define DRIVER_NAME	&quot;amplc_pci224&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * PCI IDs.</span>
<span class="cm"> */</span>
<span class="cp">#define PCI_VENDOR_ID_AMPLICON 0x14dc</span>
<span class="cp">#define PCI_DEVICE_ID_AMPLICON_PCI224 0x0007</span>
<span class="cp">#define PCI_DEVICE_ID_AMPLICON_PCI234 0x0008</span>
<span class="cp">#define PCI_DEVICE_ID_INVALID 0xffff</span>

<span class="cm">/*</span>
<span class="cm"> * PCI224/234 i/o space 1 (PCIBAR2) registers.</span>
<span class="cm"> */</span>
<span class="cp">#define PCI224_IO1_SIZE	0x20	</span><span class="cm">/* Size of i/o space 1 (8-bit registers) */</span><span class="cp"></span>
<span class="cp">#define PCI224_Z2_CT0	0x14	</span><span class="cm">/* 82C54 counter/timer 0 */</span><span class="cp"></span>
<span class="cp">#define PCI224_Z2_CT1	0x15	</span><span class="cm">/* 82C54 counter/timer 1 */</span><span class="cp"></span>
<span class="cp">#define PCI224_Z2_CT2	0x16	</span><span class="cm">/* 82C54 counter/timer 2 */</span><span class="cp"></span>
<span class="cp">#define PCI224_Z2_CTC	0x17	</span><span class="cm">/* 82C54 counter/timer control word */</span><span class="cp"></span>
<span class="cp">#define PCI224_ZCLK_SCE	0x1A	</span><span class="cm">/* Group Z Clock Configuration Register */</span><span class="cp"></span>
<span class="cp">#define PCI224_ZGAT_SCE	0x1D	</span><span class="cm">/* Group Z Gate Configuration Register */</span><span class="cp"></span>
<span class="cp">#define PCI224_INT_SCE	0x1E	</span><span class="cm">/* ISR Interrupt source mask register */</span><span class="cp"></span>
				<span class="cm">/* /Interrupt status */</span>

<span class="cm">/*</span>
<span class="cm"> * PCI224/234 i/o space 2 (PCIBAR3) 16-bit registers.</span>
<span class="cm"> */</span>
<span class="cp">#define PCI224_IO2_SIZE	0x10	</span><span class="cm">/* Size of i/o space 2 (16-bit registers). */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACDATA	0x00	</span><span class="cm">/* (w-o) DAC FIFO data. */</span><span class="cp"></span>
<span class="cp">#define PCI224_SOFTTRIG	0x00	</span><span class="cm">/* (r-o) DAC software scan trigger. */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON	0x02	</span><span class="cm">/* (r/w) DAC status/configuration. */</span><span class="cp"></span>
<span class="cp">#define PCI224_FIFOSIZ	0x04	</span><span class="cm">/* (w-o) FIFO size for wraparound mode. */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCEN	0x06	</span><span class="cm">/* (w-o) DAC channel enable register. */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * DACCON values.</span>
<span class="cm"> */</span>
<span class="cm">/* (r/w) Scan trigger. */</span>
<span class="cp">#define PCI224_DACCON_TRIG_MASK		(7 &lt;&lt; 0)</span>
<span class="cp">#define PCI224_DACCON_TRIG_NONE		(0 &lt;&lt; 0)	</span><span class="cm">/* none */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_TRIG_SW		(1 &lt;&lt; 0)	</span><span class="cm">/* software trig */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_TRIG_EXTP		(2 &lt;&lt; 0)	</span><span class="cm">/* ext +ve edge */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_TRIG_EXTN		(3 &lt;&lt; 0)	</span><span class="cm">/* ext -ve edge */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_TRIG_Z2CT0	(4 &lt;&lt; 0)	</span><span class="cm">/* Z2 CT0 out */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_TRIG_Z2CT1	(5 &lt;&lt; 0)	</span><span class="cm">/* Z2 CT1 out */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_TRIG_Z2CT2	(6 &lt;&lt; 0)	</span><span class="cm">/* Z2 CT2 out */</span><span class="cp"></span>
<span class="cm">/* (r/w) Polarity (PCI224 only, PCI234 always bipolar!). */</span>
<span class="cp">#define PCI224_DACCON_POLAR_MASK	(1 &lt;&lt; 3)</span>
<span class="cp">#define PCI224_DACCON_POLAR_UNI		(0 &lt;&lt; 3)	</span><span class="cm">/* range [0,Vref] */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_POLAR_BI		(1 &lt;&lt; 3)	</span><span class="cm">/* range [-Vref,Vref] */</span><span class="cp"></span>
<span class="cm">/* (r/w) Internal Vref (PCI224 only, when LK1 in position 1-2). */</span>
<span class="cp">#define PCI224_DACCON_VREF_MASK		(3 &lt;&lt; 4)</span>
<span class="cp">#define PCI224_DACCON_VREF_1_25		(0 &lt;&lt; 4)	</span><span class="cm">/* Vref = 1.25V */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_VREF_2_5		(1 &lt;&lt; 4)	</span><span class="cm">/* Vref = 2.5V */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_VREF_5		(2 &lt;&lt; 4)	</span><span class="cm">/* Vref = 5V */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_VREF_10		(3 &lt;&lt; 4)	</span><span class="cm">/* Vref = 10V */</span><span class="cp"></span>
<span class="cm">/* (r/w) Wraparound mode enable (to play back stored waveform). */</span>
<span class="cp">#define PCI224_DACCON_FIFOWRAP		(1 &lt;&lt; 7)</span>
<span class="cm">/* (r/w) FIFO enable.  It MUST be set! */</span>
<span class="cp">#define PCI224_DACCON_FIFOENAB		(1 &lt;&lt; 8)</span>
<span class="cm">/* (r/w) FIFO interrupt trigger level (most values are not very useful). */</span>
<span class="cp">#define PCI224_DACCON_FIFOINTR_MASK	(7 &lt;&lt; 9)</span>
<span class="cp">#define PCI224_DACCON_FIFOINTR_EMPTY	(0 &lt;&lt; 9)	</span><span class="cm">/* when empty */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_FIFOINTR_NEMPTY	(1 &lt;&lt; 9)	</span><span class="cm">/* when not empty */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_FIFOINTR_NHALF	(2 &lt;&lt; 9)	</span><span class="cm">/* when not half full */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_FIFOINTR_HALF	(3 &lt;&lt; 9)	</span><span class="cm">/* when half full */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_FIFOINTR_NFULL	(4 &lt;&lt; 9)	</span><span class="cm">/* when not full */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_FIFOINTR_FULL	(5 &lt;&lt; 9)	</span><span class="cm">/* when full */</span><span class="cp"></span>
<span class="cm">/* (r-o) FIFO fill level. */</span>
<span class="cp">#define PCI224_DACCON_FIFOFL_MASK	(7 &lt;&lt; 12)</span>
<span class="cp">#define PCI224_DACCON_FIFOFL_EMPTY	(1 &lt;&lt; 12)	</span><span class="cm">/* 0 */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_FIFOFL_ONETOHALF	(0 &lt;&lt; 12)	</span><span class="cm">/* [1,2048] */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_FIFOFL_HALFTOFULL	(4 &lt;&lt; 12)	</span><span class="cm">/* [2049,4095] */</span><span class="cp"></span>
<span class="cp">#define PCI224_DACCON_FIFOFL_FULL	(6 &lt;&lt; 12)	</span><span class="cm">/* 4096 */</span><span class="cp"></span>
<span class="cm">/* (r-o) DAC busy flag. */</span>
<span class="cp">#define PCI224_DACCON_BUSY		(1 &lt;&lt; 15)</span>
<span class="cm">/* (w-o) FIFO reset. */</span>
<span class="cp">#define PCI224_DACCON_FIFORESET		(1 &lt;&lt; 12)</span>
<span class="cm">/* (w-o) Global reset (not sure what it does). */</span>
<span class="cp">#define PCI224_DACCON_GLOBALRESET	(1 &lt;&lt; 13)</span>

<span class="cm">/*</span>
<span class="cm"> * DAC FIFO size.</span>
<span class="cm"> */</span>
<span class="cp">#define PCI224_FIFO_SIZE	4096</span>

<span class="cm">/*</span>
<span class="cm"> * DAC FIFO guaranteed minimum room available, depending on reported fill level.</span>
<span class="cm"> * The maximum room available depends on the reported fill level and how much</span>
<span class="cm"> * has been written!</span>
<span class="cm"> */</span>
<span class="cp">#define PCI224_FIFO_ROOM_EMPTY		PCI224_FIFO_SIZE</span>
<span class="cp">#define PCI224_FIFO_ROOM_ONETOHALF	(PCI224_FIFO_SIZE / 2)</span>
<span class="cp">#define PCI224_FIFO_ROOM_HALFTOFULL	1</span>
<span class="cp">#define PCI224_FIFO_ROOM_FULL		0</span>

<span class="cm">/*</span>
<span class="cm"> * Counter/timer clock input configuration sources.</span>
<span class="cm"> */</span>
<span class="cp">#define CLK_CLK		0	</span><span class="cm">/* reserved (channel-specific clock) */</span><span class="cp"></span>
<span class="cp">#define CLK_10MHZ	1	</span><span class="cm">/* internal 10 MHz clock */</span><span class="cp"></span>
<span class="cp">#define CLK_1MHZ	2	</span><span class="cm">/* internal 1 MHz clock */</span><span class="cp"></span>
<span class="cp">#define CLK_100KHZ	3	</span><span class="cm">/* internal 100 kHz clock */</span><span class="cp"></span>
<span class="cp">#define CLK_10KHZ	4	</span><span class="cm">/* internal 10 kHz clock */</span><span class="cp"></span>
<span class="cp">#define CLK_1KHZ	5	</span><span class="cm">/* internal 1 kHz clock */</span><span class="cp"></span>
<span class="cp">#define CLK_OUTNM1	6	</span><span class="cm">/* output of channel-1 modulo total */</span><span class="cp"></span>
<span class="cp">#define CLK_EXT		7	</span><span class="cm">/* external clock */</span><span class="cp"></span>
<span class="cm">/* Macro to construct clock input configuration register value. */</span>
<span class="cp">#define CLK_CONFIG(chan, src)	((((chan) &amp; 3) &lt;&lt; 3) | ((src) &amp; 7))</span>
<span class="cm">/* Timebases in ns. */</span>
<span class="cp">#define TIMEBASE_10MHZ		100</span>
<span class="cp">#define TIMEBASE_1MHZ		1000</span>
<span class="cp">#define TIMEBASE_100KHZ		10000</span>
<span class="cp">#define TIMEBASE_10KHZ		100000</span>
<span class="cp">#define TIMEBASE_1KHZ		1000000</span>

<span class="cm">/*</span>
<span class="cm"> * Counter/timer gate input configuration sources.</span>
<span class="cm"> */</span>
<span class="cp">#define GAT_VCC		0	</span><span class="cm">/* VCC (i.e. enabled) */</span><span class="cp"></span>
<span class="cp">#define GAT_GND		1	</span><span class="cm">/* GND (i.e. disabled) */</span><span class="cp"></span>
<span class="cp">#define GAT_EXT		2	</span><span class="cm">/* reserved (external gate input) */</span><span class="cp"></span>
<span class="cp">#define GAT_NOUTNM2	3	</span><span class="cm">/* inverted output of channel-2 modulo total */</span><span class="cp"></span>
<span class="cm">/* Macro to construct gate input configuration register value. */</span>
<span class="cp">#define GAT_CONFIG(chan, src)	((((chan) &amp; 3) &lt;&lt; 3) | ((src) &amp; 7))</span>

<span class="cm">/*</span>
<span class="cm"> * Summary of CLK_OUTNM1 and GAT_NOUTNM2 connections for PCI224 and PCI234:</span>
<span class="cm"> *</span>
<span class="cm"> *              Channel&#39;s       Channel&#39;s</span>
<span class="cm"> *              clock input     gate input</span>
<span class="cm"> * Channel      CLK_OUTNM1      GAT_NOUTNM2</span>
<span class="cm"> * -------      ----------      -----------</span>
<span class="cm"> * Z2-CT0       Z2-CT2-OUT      /Z2-CT1-OUT</span>
<span class="cm"> * Z2-CT1       Z2-CT0-OUT      /Z2-CT2-OUT</span>
<span class="cm"> * Z2-CT2       Z2-CT1-OUT      /Z2-CT0-OUT</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt enable/status bits</span>
<span class="cm"> */</span>
<span class="cp">#define PCI224_INTR_EXT		0x01	</span><span class="cm">/* rising edge on external input */</span><span class="cp"></span>
<span class="cp">#define PCI224_INTR_DAC		0x04	</span><span class="cm">/* DAC (FIFO) interrupt */</span><span class="cp"></span>
<span class="cp">#define PCI224_INTR_Z2CT1	0x20	</span><span class="cm">/* rising edge on Z2-CT1 output */</span><span class="cp"></span>

<span class="cp">#define PCI224_INTR_EDGE_BITS	(PCI224_INTR_EXT | PCI224_INTR_Z2CT1)</span>
<span class="cp">#define PCI224_INTR_LEVEL_BITS	PCI224_INTR_DACFIFO</span>

<span class="cm">/*</span>
<span class="cm"> * Handy macros.</span>
<span class="cm"> */</span>

<span class="cm">/* Combine old and new bits. */</span>
<span class="cp">#define COMBINE(old, new, mask)	(((old) &amp; ~(mask)) | ((new) &amp; (mask)))</span>

<span class="cm">/* A generic null function pointer value.  */</span>
<span class="cp">#define NULLFUNC	0</span>

<span class="cm">/* Current CPU.  XXX should this be hard_smp_processor_id()? */</span>
<span class="cp">#define THISCPU		smp_processor_id()</span>

<span class="cm">/* State bits for use with atomic bit operations. */</span>
<span class="cp">#define AO_CMD_STARTED	0</span>

<span class="cm">/*</span>
<span class="cm"> * Range tables.</span>
<span class="cm"> */</span>

<span class="cm">/* The software selectable internal ranges for PCI224 (option[2] == 0). */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pci224_internal</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
	 <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hwrange_pci224_internal</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCI224_DACCON_POLAR_BI</span> <span class="o">|</span> <span class="n">PCI224_DACCON_VREF_10</span><span class="p">,</span>
	<span class="n">PCI224_DACCON_POLAR_BI</span> <span class="o">|</span> <span class="n">PCI224_DACCON_VREF_5</span><span class="p">,</span>
	<span class="n">PCI224_DACCON_POLAR_BI</span> <span class="o">|</span> <span class="n">PCI224_DACCON_VREF_2_5</span><span class="p">,</span>
	<span class="n">PCI224_DACCON_POLAR_BI</span> <span class="o">|</span> <span class="n">PCI224_DACCON_VREF_1_25</span><span class="p">,</span>
	<span class="n">PCI224_DACCON_POLAR_UNI</span> <span class="o">|</span> <span class="n">PCI224_DACCON_VREF_10</span><span class="p">,</span>
	<span class="n">PCI224_DACCON_POLAR_UNI</span> <span class="o">|</span> <span class="n">PCI224_DACCON_VREF_5</span><span class="p">,</span>
	<span class="n">PCI224_DACCON_POLAR_UNI</span> <span class="o">|</span> <span class="n">PCI224_DACCON_VREF_2_5</span><span class="p">,</span>
	<span class="n">PCI224_DACCON_POLAR_UNI</span> <span class="o">|</span> <span class="n">PCI224_DACCON_VREF_1_25</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The software selectable external ranges for PCI224 (option[2] == 1). */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pci224_external</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">RANGE_ext</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* bipolar [-Vref,+Vref] */</span>
	 <span class="n">RANGE_ext</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* unipolar [0,+Vref] */</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hwrange_pci224_external</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCI224_DACCON_POLAR_BI</span><span class="p">,</span>
	<span class="n">PCI224_DACCON_POLAR_UNI</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The hardware selectable Vref*2 external range for PCI234</span>
<span class="cm"> * (option[2] == 1, option[3+n] == 0). */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pci234_ext2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">RANGE_ext</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* The hardware selectable Vref external range for PCI234</span>
<span class="cm"> * (option[2] == 1, option[3+n] == 1). */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pci234_ext</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">RANGE_ext</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* This serves for all the PCI234 ranges. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hwrange_pci234</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCI224_DACCON_POLAR_BI</span><span class="p">,</span>	<span class="cm">/* bipolar - hardware ignores it! */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Board descriptions.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">pci224_model</span> <span class="p">{</span> <span class="n">any_model</span><span class="p">,</span> <span class="n">pci224_model</span><span class="p">,</span> <span class="n">pci234_model</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">pci224_board</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">devid</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pci224_model</span> <span class="n">model</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_chans</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_bits</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci224_board</span> <span class="n">pci224_boards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci224&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">devid</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_AMPLICON_PCI224</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pci224_model</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci234&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">devid</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_AMPLICON_PCI234</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pci234_model</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_chans</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">devid</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_INVALID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">any_model</span><span class="p">,</span>	<span class="cm">/* wildcard */</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Useful for shorthand access to the particular board structure</span>
<span class="cm"> */</span>
<span class="cp">#define thisboard ((struct pci224_board *)dev-&gt;board_ptr)</span>

<span class="cm">/* this structure is for data unique to this hardware driver.  If</span>
<span class="cm">   several hardware drivers keep similar information in this structure,</span>
<span class="cm">   feel free to suggest moving the variable to the struct comedi_device struct.  */</span>
<span class="k">struct</span> <span class="n">pci224_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>	<span class="cm">/* PCI device */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">hwrange</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">ao_spinlock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ao_readback</span><span class="p">;</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">ao_scan_vals</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ao_scan_order</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr_cpuid</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">intr_running</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">daccon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cached_div1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cached_div2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_stop_count</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">ao_stop_continuous</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ao_enab</span><span class="p">;</span>	<span class="cm">/* max 16 channels so &#39;short&#39; will do */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">intsce</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define devpriv ((struct pci224_private *)dev-&gt;private)</span>

<span class="cm">/*</span>
<span class="cm"> * Called from the &#39;insn_write&#39; function to perform a single write.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pci224_ao_set_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">range</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mangled</span><span class="p">;</span>

	<span class="cm">/* Store unmangled data for readback. */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="cm">/* Enable the channel. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chan</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCEN</span><span class="p">);</span>
	<span class="cm">/* Set range and reset FIFO. */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwrange</span><span class="p">[</span><span class="n">range</span><span class="p">],</span>
				  <span class="p">(</span><span class="n">PCI224_DACCON_POLAR_MASK</span> <span class="o">|</span>
				   <span class="n">PCI224_DACCON_VREF_MASK</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">|</span> <span class="n">PCI224_DACCON_FIFORESET</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCON</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Mangle the data.  The hardware expects:</span>
<span class="cm">	 * - bipolar: 16-bit 2&#39;s complement</span>
<span class="cm">	 * - unipolar: 16-bit unsigned</span>
<span class="cm">	 */</span>
	<span class="n">mangled</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_bits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">&amp;</span> <span class="n">PCI224_DACCON_POLAR_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">PCI224_DACCON_POLAR_BI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mangled</span> <span class="o">^=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Write mangled data to the FIFO. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">mangled</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACDATA</span><span class="p">);</span>
	<span class="cm">/* Trigger the conversion. */</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_SOFTTRIG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;insn_write&#39; function for AO subdevice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci224_ao_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">range</span><span class="p">;</span>

	<span class="cm">/* Unpack channel and range. */</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* Writing a list of values to an AO channel is probably not</span>
<span class="cm">	 * very useful, but that&#39;s how the interface is defined. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pci224_ao_set_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;insn_read&#39; function for AO subdevice.</span>
<span class="cm"> *</span>
<span class="cm"> * N.B. The value read will not be valid if the DAC channel has</span>
<span class="cm"> * never been written successfully since the device was attached</span>
<span class="cm"> * or since the channel has been used by an AO streaming write</span>
<span class="cm"> * command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci224_ao_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>


	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Just a wrapper for the inline function &#39;i8253_cascade_ns_to_timer&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pci224_cascade_ns_to_timer</span><span class="p">(</span><span class="kt">int</span> <span class="n">osc_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">d1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">d2</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nanosec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">round_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">osc_base</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">nanosec</span><span class="p">,</span> <span class="n">round_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Kills a command running on the AO subdevice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci224_ao_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AO_CMD_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Kill the interrupts. */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_INT_SCE</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Interrupt routine may or may not be running.  We may or may not</span>
<span class="cm">	 * have been called from the interrupt routine (directly or</span>
<span class="cm">	 * indirectly via a comedi_events() callback routine).  It&#39;s highly</span>
<span class="cm">	 * unlikely that we&#39;ve been called from some other interrupt routine</span>
<span class="cm">	 * but who knows what strange things coders get up to!</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the interrupt routine is currently running, wait for it to</span>
<span class="cm">	 * finish, unless we appear to have been called via the interrupt</span>
<span class="cm">	 * routine.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intr_running</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intr_cpuid</span> <span class="o">!=</span> <span class="n">THISCPU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Reconfigure DAC for insn_write usage. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCEN</span><span class="p">);</span>	<span class="cm">/* Disable channels. */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span><span class="p">,</span>
				  <span class="n">PCI224_DACCON_TRIG_SW</span> <span class="o">|</span>
				  <span class="n">PCI224_DACCON_FIFOINTR_EMPTY</span><span class="p">,</span>
				  <span class="n">PCI224_DACCON_TRIG_MASK</span> <span class="o">|</span>
				  <span class="n">PCI224_DACCON_FIFOINTR_MASK</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">|</span> <span class="n">PCI224_DACCON_FIFORESET</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handles start of acquisition for the AO subdevice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci224_ao_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">AO_CMD_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_continuous</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* An empty acquisition! */</span>
		<span class="n">pci224_ao_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Enable interrupts. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span> <span class="o">=</span> <span class="n">PCI224_INTR_EXT</span> <span class="o">|</span> <span class="n">PCI224_INTR_DAC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span> <span class="o">=</span> <span class="n">PCI224_INTR_DAC</span><span class="p">;</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_INT_SCE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handles interrupts from the DAC FIFO.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci224_ao_handle_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_scans</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">room</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dacstat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes_per_scan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes_per_scan</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Shouldn&#39;t get here! */</span>
		<span class="n">bytes_per_scan</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Determine number of scans available in buffer. */</span>
	<span class="n">num_scans</span> <span class="o">=</span> <span class="n">comedi_buf_read_n_available</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="o">/</span> <span class="n">bytes_per_scan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_continuous</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fixed number of scans. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_scans</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_count</span><span class="p">)</span>
			<span class="n">num_scans</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_count</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* Determine how much room is in the FIFO (in samples). */</span>
	<span class="n">dacstat</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCON</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dacstat</span> <span class="o">&amp;</span> <span class="n">PCI224_DACCON_FIFOFL_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI224_DACCON_FIFOFL_EMPTY</span>:
		<span class="n">room</span> <span class="o">=</span> <span class="n">PCI224_FIFO_ROOM_EMPTY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_continuous</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FIFO empty at end of counted acquisition. */</span>
			<span class="n">pci224_ao_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
			<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI224_DACCON_FIFOFL_ONETOHALF</span>:
		<span class="n">room</span> <span class="o">=</span> <span class="n">PCI224_FIFO_ROOM_ONETOHALF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI224_DACCON_FIFOFL_HALFTOFULL</span>:
		<span class="n">room</span> <span class="o">=</span> <span class="n">PCI224_FIFO_ROOM_HALFTOFULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">room</span> <span class="o">=</span> <span class="n">PCI224_FIFO_ROOM_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="o">&gt;=</span> <span class="n">PCI224_FIFO_ROOM_ONETOHALF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIFO is less than half-full. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_scans</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Nothing left to put in the FIFO. */</span>
			<span class="n">pci224_ao_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: &quot;</span>
			       <span class="s">&quot;AO buffer underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Determine how many new scans can be put in the FIFO. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span>
		<span class="n">room</span> <span class="o">/=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>

	<span class="cm">/* Determine how many scans to process. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_scans</span> <span class="o">&gt;</span> <span class="n">room</span><span class="p">)</span>
		<span class="n">num_scans</span> <span class="o">=</span> <span class="n">room</span><span class="p">;</span>

	<span class="cm">/* Process scans. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">num_scans</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfc_read_array_from_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					   <span class="n">bytes_per_scan</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_vals</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_order</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
			     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACDATA</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_continuous</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_count</span> <span class="o">-=</span> <span class="n">num_scans</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Change FIFO interrupt trigger level to wait</span>
<span class="cm">			 * until FIFO is empty.</span>
<span class="cm">			 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span><span class="p">,</span>
						  <span class="n">PCI224_DACCON_FIFOINTR_EMPTY</span><span class="p">,</span>
						  <span class="n">PCI224_DACCON_FIFOINTR_MASK</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCON</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">&amp;</span> <span class="n">PCI224_DACCON_TRIG_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">PCI224_DACCON_TRIG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">trig</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This is the initial DAC FIFO interrupt at the</span>
<span class="cm">		 * start of the acquisition.  The DAC&#39;s scan trigger</span>
<span class="cm">		 * has been set to &#39;none&#39; up until now.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Now that data has been written to the FIFO, the</span>
<span class="cm">		 * DAC&#39;s scan trigger source can be set to the</span>
<span class="cm">		 * correct value.</span>
<span class="cm">		 *</span>
<span class="cm">		 * BUG: The first scan will be triggered immediately</span>
<span class="cm">		 * if the scan trigger source is at logic level 1.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">trig</span> <span class="o">=</span> <span class="n">PCI224_DACCON_TRIG_Z2CT0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* cmd-&gt;scan_begin_src == TRIG_EXT */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span>
				<span class="n">trig</span> <span class="o">=</span> <span class="n">PCI224_DACCON_TRIG_EXTN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">trig</span> <span class="o">=</span> <span class="n">PCI224_DACCON_TRIG_EXTP</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span><span class="p">,</span> <span class="n">trig</span><span class="p">,</span>
					  <span class="n">PCI224_DACCON_TRIG_MASK</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCON</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Internal trigger function to start acquisition on AO subdevice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci224_ao_inttrig_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trignum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="n">NULLFUNC</span><span class="p">;</span>
	<span class="n">pci224_ao_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_SCAN_PERIOD		0xFFFFFFFFU</span>
<span class="cp">#define MIN_SCAN_PERIOD		2500</span>
<span class="cp">#define CONVERT_PERIOD		625</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;do_cmdtest&#39; function for AO subdevice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci224_ao_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Step 1: make sure trigger sources are trivially valid. */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_INT</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_EXT</span> <span class="o">|</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_EXT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Step 2: make sure trigger sources are unique and mutually</span>
<span class="cm">	 * compatible. */</span>

	<span class="cm">/* these tests are true if more than one _src bit is set */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* There&#39;s only one external trigger signal (which makes these</span>
<span class="cm">	 * tests easier).  Only one thing can use it. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Step 3: make sure arguments are trivially compatible. */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_INT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="cm">/* Force to external trigger 0. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_FLAGS_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						 <span class="o">~</span><span class="n">CR_FLAGS_MASK</span><span class="p">);</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The only flag allowed is CR_EDGE, which is ignored. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="n">CR_FLAGS_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_EDGE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						 <span class="n">CR_FLAGS_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_EDGE</span><span class="p">);</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&gt;</span> <span class="n">MAX_SCAN_PERIOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">MAX_SCAN_PERIOD</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="n">CONVERT_PERIOD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">MIN_SCAN_PERIOD</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">MIN_SCAN_PERIOD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="cm">/* Force to external trigger 0. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_FLAGS_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						      <span class="o">~</span><span class="n">CR_FLAGS_MASK</span><span class="p">);</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Only allow flags CR_EDGE and CR_INVERT.  Ignore CR_EDGE. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="n">CR_FLAGS_MASK</span> <span class="o">&amp;</span>
		     <span class="o">~</span><span class="p">(</span><span class="n">CR_EDGE</span> <span class="o">|</span> <span class="n">CR_INVERT</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						      <span class="n">CR_FLAGS_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CR_EDGE</span>
									<span class="o">|</span>
									<span class="n">CR_INVERT</span><span class="p">));</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* cmd-&gt;convert_src == TRIG_NOW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* cmd-&gt;scan_end_arg == TRIG_COUNT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_COUNT</span>:
		<span class="cm">/* Any count allowed. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="cm">/* Force to external trigger 0. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_FLAGS_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="o">~</span><span class="n">CR_FLAGS_MASK</span><span class="p">);</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The only flag allowed is CR_EDGE, which is ignored. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&amp;</span> <span class="n">CR_FLAGS_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_EDGE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">CR_FLAGS_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_EDGE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_NONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* Step 4: fix up any arguments. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">div1</span><span class="p">,</span> <span class="n">div2</span><span class="p">,</span> <span class="n">round</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">round_mode</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="cm">/* Check whether to use a single timer. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">round_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
		<span class="nl">default:</span>
			<span class="n">round</span> <span class="o">=</span> <span class="n">TIMEBASE_10MHZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
			<span class="n">round</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
			<span class="n">round</span> <span class="o">=</span> <span class="n">TIMEBASE_10MHZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Be careful to avoid overflow! */</span>
		<span class="n">div2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">/</span> <span class="n">TIMEBASE_10MHZ</span><span class="p">;</span>
		<span class="n">div2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">round</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">%</span> <span class="n">TIMEBASE_10MHZ</span><span class="p">)</span> <span class="o">/</span>
		    <span class="n">TIMEBASE_10MHZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div2</span> <span class="o">&lt;=</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* A single timer will suffice. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">div2</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">div2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">div2</span> <span class="o">*</span> <span class="n">TIMEBASE_10MHZ</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">div2</span> <span class="o">||</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">TIMEBASE_10MHZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Overflow! */</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">MAX_SCAN_PERIOD</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Use two timers. */</span>
			<span class="n">div1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cached_div1</span><span class="p">;</span>
			<span class="n">div2</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cached_div2</span><span class="p">;</span>
			<span class="n">pci224_cascade_ns_to_timer</span><span class="p">(</span><span class="n">TIMEBASE_10MHZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div2</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
						   <span class="n">round_mode</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cached_div1</span> <span class="o">=</span> <span class="n">div1</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cached_div2</span> <span class="o">=</span> <span class="n">div2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Step 5: check channel list. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">range</span><span class="p">;</span>
		<span class="k">enum</span> <span class="p">{</span> <span class="n">range_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dupchan_err</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">};</span>
		<span class="kt">unsigned</span> <span class="n">errors</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check all channels have the same range index.  Don&#39;t care</span>
<span class="cm">		 * about analogue reference, as we can&#39;t configure it.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Check the list has no duplicate channels.</span>
<span class="cm">		 */</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">))</span>
				<span class="n">errors</span> <span class="o">|=</span> <span class="n">dupchan_err</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">!=</span> <span class="n">range</span><span class="p">)</span>
				<span class="n">errors</span> <span class="o">|=</span> <span class="n">range_err</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&amp;</span> <span class="n">dupchan_err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;comedi%d: &quot;</span> <span class="n">DRIVER_NAME</span>
					<span class="s">&quot;: ao_cmdtest: &quot;</span>
					<span class="s">&quot;entries in chanlist must contain no &quot;</span>
					<span class="s">&quot;duplicate channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&amp;</span> <span class="n">range_err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;comedi%d: &quot;</span> <span class="n">DRIVER_NAME</span>
					<span class="s">&quot;: ao_cmdtest: &quot;</span>
					<span class="s">&quot;entries in chanlist must all have &quot;</span>
					<span class="s">&quot;the same range index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;do_cmd&#39; function for AO subdevice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci224_ao_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Cannot handle null/empty chanlist. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>


	<span class="cm">/* Determine which channels are enabled and their load order.  */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_enab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_enab</span> <span class="o">|=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="p">)</span>
				<span class="n">rank</span><span class="o">++</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_order</span><span class="p">[</span><span class="n">rank</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set enabled channels. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_enab</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCEN</span><span class="p">);</span>

	<span class="cm">/* Determine range and polarity.  All channels the same.  */</span>
	<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set DAC range and polarity.</span>
<span class="cm">	 * Set DAC scan trigger source to &#39;none&#39;.</span>
<span class="cm">	 * Set DAC FIFO interrupt trigger level to &#39;not half full&#39;.</span>
<span class="cm">	 * Reset DAC FIFO.</span>
<span class="cm">	 *</span>
<span class="cm">	 * N.B. DAC FIFO interrupts are currently disabled.</span>
<span class="cm">	 */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">=</span> <span class="n">COMBINE</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				   <span class="n">hwrange</span><span class="p">[</span><span class="n">range</span><span class="p">]</span> <span class="o">|</span> <span class="n">PCI224_DACCON_TRIG_NONE</span> <span class="o">|</span>
				   <span class="n">PCI224_DACCON_FIFOINTR_NHALF</span><span class="p">),</span>
				  <span class="p">(</span><span class="n">PCI224_DACCON_POLAR_MASK</span> <span class="o">|</span>
				   <span class="n">PCI224_DACCON_VREF_MASK</span> <span class="o">|</span>
				   <span class="n">PCI224_DACCON_TRIG_MASK</span> <span class="o">|</span>
				   <span class="n">PCI224_DACCON_FIFOINTR_MASK</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">|</span> <span class="n">PCI224_DACCON_FIFORESET</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">div1</span><span class="p">,</span> <span class="n">div2</span><span class="p">,</span> <span class="n">round</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">round_mode</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">;</span>

		<span class="cm">/* Check whether to use a single timer. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">round_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
		<span class="nl">default:</span>
			<span class="n">round</span> <span class="o">=</span> <span class="n">TIMEBASE_10MHZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
			<span class="n">round</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
			<span class="n">round</span> <span class="o">=</span> <span class="n">TIMEBASE_10MHZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Be careful to avoid overflow! */</span>
		<span class="n">div2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">/</span> <span class="n">TIMEBASE_10MHZ</span><span class="p">;</span>
		<span class="n">div2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">round</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">%</span> <span class="n">TIMEBASE_10MHZ</span><span class="p">)</span> <span class="o">/</span>
		    <span class="n">TIMEBASE_10MHZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div2</span> <span class="o">&lt;=</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* A single timer will suffice. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">div2</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">div2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">div2</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">div1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Flag that single timer to be used. */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Use two timers. */</span>
			<span class="n">div1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cached_div1</span><span class="p">;</span>
			<span class="n">div2</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cached_div2</span><span class="p">;</span>
			<span class="n">pci224_cascade_ns_to_timer</span><span class="p">(</span><span class="n">TIMEBASE_10MHZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div2</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">ns</span><span class="p">,</span> <span class="n">round_mode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The output of timer Z2-0 will be used as the scan trigger</span>
<span class="cm">		 * source.</span>
<span class="cm">		 */</span>
		<span class="cm">/* Make sure Z2-0 is gated on.  */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">GAT_CONFIG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GAT_VCC</span><span class="p">),</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_ZGAT_SCE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Not cascading.  Z2-0 needs 10 MHz clock. */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CLK_CONFIG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CLK_10MHZ</span><span class="p">),</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_ZCLK_SCE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Cascading with Z2-2. */</span>
			<span class="cm">/* Make sure Z2-2 is gated on.  */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">GAT_CONFIG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">GAT_VCC</span><span class="p">),</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_ZGAT_SCE</span><span class="p">);</span>
			<span class="cm">/* Z2-2 needs 10 MHz clock. */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CLK_CONFIG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">CLK_10MHZ</span><span class="p">),</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_ZCLK_SCE</span><span class="p">);</span>
			<span class="cm">/* Load Z2-2 mode (2) and counter (div1). */</span>
			<span class="n">i8254_load</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_Z2_CT0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="mi">2</span><span class="p">,</span> <span class="n">div1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="cm">/* Z2-0 is clocked from Z2-2&#39;s output. */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CLK_CONFIG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CLK_OUTNM1</span><span class="p">),</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_ZCLK_SCE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Load Z2-0 mode (2) and counter (div2). */</span>
		<span class="n">i8254_load</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_Z2_CT0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">div2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sort out end of acquisition.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_COUNT</span>:
		<span class="cm">/* Fixed number of scans.  */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_continuous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Continuous scans. */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_continuous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_stop_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sort out start of acquisition.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_INT</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci224_ao_inttrig_start</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="cm">/* Enable external interrupt trigger to start acquisition. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span> <span class="o">|=</span> <span class="n">PCI224_INTR_EXT</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_INT_SCE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;cancel&#39; function for AO subdevice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci224_ao_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci224_ao_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;munge&#39; data for AO command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pci224_ao_munge</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">array</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* The hardware expects 16-bit numbers. */</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_bits</span><span class="p">;</span>
	<span class="cm">/* Channels will be all bipolar or all unipolar. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwrange</span><span class="p">[</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">&amp;</span>
	     <span class="n">PCI224_DACCON_POLAR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI224_DACCON_POLAR_UNI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unipolar */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Bipolar */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Munge the data. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pci224_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">intstat</span><span class="p">,</span> <span class="n">valid_intstat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">curenab</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">intstat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_INT_SCE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">valid_intstat</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span> <span class="o">&amp;</span> <span class="n">intstat</span><span class="p">;</span>
		<span class="cm">/* Temporarily disable interrupt sources. */</span>
		<span class="n">curenab</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">intstat</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">curenab</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_INT_SCE</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intr_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intr_cpuid</span> <span class="o">=</span> <span class="n">THISCPU</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid_intstat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">valid_intstat</span> <span class="o">&amp;</span> <span class="n">PCI224_INTR_EXT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI224_INTR_EXT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
					<span class="n">pci224_ao_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
					<span class="n">pci224_ao_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">valid_intstat</span> <span class="o">&amp;</span> <span class="n">PCI224_INTR_DAC</span><span class="p">)</span>
				<span class="n">pci224_ao_handle_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="cm">/* Reenable interrupt sources. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curenab</span> <span class="o">!=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span><span class="p">,</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_INT_SCE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intr_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function looks for a board matching the supplied PCI device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci224_board</span>
<span class="o">*</span><span class="nf">pci224_find_pci_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pci224_boards</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">pci224_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devid</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">pci224_boards</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function looks for a PCI device matching the requested board name,</span>
<span class="cm"> * bus and slot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci224_find_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">**</span><span class="n">pci_dev_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pci_dev_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Look for matching PCI device. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AMPLICON</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	     <span class="n">pci_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AMPLICON</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
				      <span class="n">pci_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If bus/slot specified, check them. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">||</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">!=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span>
			    <span class="o">||</span> <span class="n">slot</span> <span class="o">!=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">any_model</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Match any supported model. */</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">pci224_board</span> <span class="o">*</span><span class="n">board_ptr</span><span class="p">;</span>
			<span class="n">board_ptr</span> <span class="o">=</span> <span class="n">pci224_find_pci_board</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">board_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Change board_ptr to matched board. */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">=</span> <span class="n">board_ptr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Match specific model name. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">!=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Found a match. */</span>
		<span class="o">*</span><span class="n">pci_dev_p</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* No match found. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">||</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: error! &quot;</span>
		       <span class="s">&quot;no %s found at pci %02x:%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: error! no %s found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Common part of attach and attach_pci.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci224_attach_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">comedi_pci_enable</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;comedi%d: error! cannot enable PCI device &quot;</span>
		       <span class="s">&quot;and request regions!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_spinlock</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* Allocate readback buffer for AO channels. */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span>
				       <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_chans</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>


	<span class="cm">/* Allocate buffer to hold values for AO channel scan. */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_vals</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span>
					<span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_chans</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_vals</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>


	<span class="cm">/* Allocate buffer to hold AO channel scan order. */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_order</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_order</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span>
					 <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_chans</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_order</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>


	<span class="cm">/* Disable interrupt sources. */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">intsce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase1</span> <span class="o">+</span> <span class="n">PCI224_INT_SCE</span><span class="p">);</span>

	<span class="cm">/* Initialize the DAC hardware. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">PCI224_DACCON_GLOBALRESET</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCON</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCEN</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_FIFOSIZ</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCI224_DACCON_TRIG_SW</span> <span class="o">|</span> <span class="n">PCI224_DACCON_POLAR_BI</span> <span class="o">|</span>
			   <span class="n">PCI224_DACCON_FIFOENAB</span> <span class="o">|</span>
			   <span class="n">PCI224_DACCON_FIFOINTR_EMPTY</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daccon</span> <span class="o">|</span> <span class="n">PCI224_DACCON_FIFORESET</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI224_DACCON</span><span class="p">);</span>

	<span class="cm">/* Allocate subdevices.  There is only one!  */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: error! out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Analog output subdevice. */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_CMD_WRITE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_chans</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci224_ao_insn_write</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci224_ao_insn_read</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci224_ao_cmd</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci224_ao_cmdtest</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci224_ao_cancel</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">munge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci224_ao_munge</span><span class="p">;</span>

	<span class="cm">/* Sort out channel range options. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">pci234_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PCI234 range options. */</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">**</span><span class="n">range_table_list</span><span class="p">;</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table_list</span> <span class="o">=</span> <span class="n">range_table_list</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">,</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table_list</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">options</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					       <span class="s">&quot;comedi%d: %s: warning! bad options[%u]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
					       <span class="n">options</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">COMEDI_NDEVCONFOPTS</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">options</span> <span class="o">&amp;&amp;</span>
			    <span class="n">options</span><span class="p">[</span><span class="mi">3</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">range_table_list</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pci234_ext</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">range_table_list</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar5</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">range_table_list</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>
					    <span class="o">&amp;</span><span class="n">range_pci234_ext2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">range_table_list</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar10</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwrange</span> <span class="o">=</span> <span class="n">hwrange_pci234</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* PCI224 range options. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pci224_external</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwrange</span> <span class="o">=</span> <span class="n">hwrange_pci224_external</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;comedi%d: %s: warning! &quot;</span>
				       <span class="s">&quot;bad options[2]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pci224_internal</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwrange</span> <span class="o">=</span> <span class="n">hwrange_pci224_internal</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">pci224_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: error! &quot;</span>
			       <span class="s">&quot;unable to allocate irq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi%d: %s &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(pci %s) &quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(irq %u%s) &quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; UNAVAILABLE&quot;</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(no irq) &quot;</span><span class="p">);</span>


	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci224_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: %s: attach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci224_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: error! out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci224_find_pci</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pci224_attach_common</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci224_attach_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: %s: attach_pci %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
	       <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci224_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: error! out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">=</span> <span class="n">pci224_find_pci_board</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;comedi%d: %s: BUG! cannot determine board type!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pci224_attach_common</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci224_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* AO subdevice */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_vals</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_scan_order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
				<span class="n">comedi_pci_disable</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">amplc_pci224_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;amplc_pci224&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">pci224_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">pci224_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach_pci</span>	<span class="o">=</span> <span class="n">pci224_attach_pci</span><span class="p">,</span>
	<span class="p">.</span><span class="n">board_name</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pci224_boards</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci224_board</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_names</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pci224_boards</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">amplc_pci224_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span>
						   <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amplc_pci224_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">amplc_pci224_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">amplc_pci224_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AMPLICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_AMPLICON_PCI224</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AMPLICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_AMPLICON_PCI234</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">amplc_pci224_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">amplc_pci224_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;amplc_pci224&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">amplc_pci224_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">amplc_pci224_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">amplc_pci224_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_pci_driver</span><span class="p">(</span><span class="n">amplc_pci224_driver</span><span class="p">,</span> <span class="n">amplc_pci224_pci_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
