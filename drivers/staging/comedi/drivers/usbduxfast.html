<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › usbduxfast.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>usbduxfast.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 2004 Bernd Porr, Bernd.Porr@f2s.com</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * I must give credit here to Chris Baugher who</span>
<span class="cm"> * wrote the driver for AT-MIO-16d. I used some parts of this</span>
<span class="cm"> * driver. I also must give credits to David Brownell</span>
<span class="cm"> * who supported me with the USB development.</span>
<span class="cm"> *</span>
<span class="cm"> * Bernd Porr</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Revision history:</span>
<span class="cm"> * 0.9: Dropping the first data packet which seems to be from the last transfer.</span>
<span class="cm"> *      Buffer overflows in the FX2 are handed over to comedi.</span>
<span class="cm"> * 0.92: Dropping now 4 packets. The quad buffer has to be emptied.</span>
<span class="cm"> *       Added insn command basically for testing. Sample rate is</span>
<span class="cm"> *       1MHz/16ch=62.5kHz</span>
<span class="cm"> * 0.99: Ian Abbott pointed out a bug which has been corrected. Thanks!</span>
<span class="cm"> * 0.99a: added external trigger.</span>
<span class="cm"> * 1.00: added firmware kernel request to the driver which fixed</span>
<span class="cm"> *       udev coldplug problem</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &quot;comedi_fc.h&quot;</span>
<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#define DRIVER_VERSION &quot;v1.0&quot;</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Bernd Porr, BerndPorr@f2s.com&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;USB-DUXfast, BerndPorr@f2s.com&quot;</span>
<span class="cp">#define BOARDNAME &quot;usbduxfast&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * timeout for the USB-transfer</span>
<span class="cm"> */</span>
<span class="cp">#define EZTIMEOUT	30</span>

<span class="cm">/*</span>
<span class="cm"> * constants for &quot;firmware&quot; upload and download</span>
<span class="cm"> */</span>
<span class="cp">#define USBDUXFASTSUB_FIRMWARE	0xA0</span>
<span class="cp">#define VENDOR_DIR_IN		0xC0</span>
<span class="cp">#define VENDOR_DIR_OUT		0x40</span>

<span class="cm">/*</span>
<span class="cm"> * internal addresses of the 8051 processor</span>
<span class="cm"> */</span>
<span class="cp">#define USBDUXFASTSUB_CPUCS	0xE600</span>

<span class="cm">/*</span>
<span class="cm"> * max lenghth of the transfer-buffer for software upload</span>
<span class="cm"> */</span>
<span class="cp">#define TB_LEN	0x2000</span>

<span class="cm">/*</span>
<span class="cm"> * input endpoint number</span>
<span class="cm"> */</span>
<span class="cp">#define BULKINEP	6</span>

<span class="cm">/*</span>
<span class="cm"> * endpoint for the A/D channellist: bulk OUT</span>
<span class="cm"> */</span>
<span class="cp">#define CHANNELLISTEP	4</span>

<span class="cm">/*</span>
<span class="cm"> * number of channels</span>
<span class="cm"> */</span>
<span class="cp">#define NUMCHANNELS	32</span>

<span class="cm">/*</span>
<span class="cm"> * size of the waveform descriptor</span>
<span class="cm"> */</span>
<span class="cp">#define WAVESIZE	0x20</span>

<span class="cm">/*</span>
<span class="cm"> * size of one A/D value</span>
<span class="cm"> */</span>
<span class="cp">#define SIZEADIN	(sizeof(int16_t))</span>

<span class="cm">/*</span>
<span class="cm"> * size of the input-buffer IN BYTES</span>
<span class="cm"> */</span>
<span class="cp">#define SIZEINBUF	512</span>

<span class="cm">/*</span>
<span class="cm"> * 16 bytes</span>
<span class="cm"> */</span>
<span class="cp">#define SIZEINSNBUF	512</span>

<span class="cm">/*</span>
<span class="cm"> * size of the buffer for the dux commands in bytes</span>
<span class="cm"> */</span>
<span class="cp">#define SIZEOFDUXBUFFER	256</span>

<span class="cm">/*</span>
<span class="cm"> * number of in-URBs which receive the data: min=5</span>
<span class="cm"> */</span>
<span class="cp">#define NUMOFINBUFFERSHIGH	10</span>

<span class="cm">/*</span>
<span class="cm"> * total number of usbduxfast devices</span>
<span class="cm"> */</span>
<span class="cp">#define NUMUSBDUXFAST	16</span>

<span class="cm">/*</span>
<span class="cm"> * number of subdevices</span>
<span class="cm"> */</span>
<span class="cp">#define N_SUBDEVICES	1</span>

<span class="cm">/*</span>
<span class="cm"> * analogue in subdevice</span>
<span class="cm"> */</span>
<span class="cp">#define SUBDEV_AD	0</span>

<span class="cm">/*</span>
<span class="cm"> * min delay steps for more than one channel</span>
<span class="cm"> * basically when the mux gives up ;-)</span>
<span class="cm"> *</span>
<span class="cm"> * steps at 30MHz in the FX2</span>
<span class="cm"> */</span>
<span class="cp">#define MIN_SAMPLING_PERIOD	9</span>

<span class="cm">/*</span>
<span class="cm"> * max number of 1/30MHz delay steps</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_SAMPLING_PERIOD	500</span>

<span class="cm">/*</span>
<span class="cm"> * number of received packets to ignore before we start handing data</span>
<span class="cm"> * over to comedi, it&#39;s quad buffering and we have to ignore 4 packets</span>
<span class="cm"> */</span>
<span class="cp">#define PACKETS_TO_IGNORE	4</span>

<span class="cm">/*</span>
<span class="cm"> * comedi constants</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_usbduxfast_ai_range</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.75</span><span class="p">),</span> <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * private structure of one subdevice</span>
<span class="cm"> *</span>
<span class="cm"> * this is the structure which holds all the data of this driver</span>
<span class="cm"> * one sub device just now: A/D</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">attached</span><span class="p">;</span>		<span class="cm">/* is attached? */</span>
	<span class="kt">int</span> <span class="n">probed</span><span class="p">;</span>		<span class="cm">/* is it associated with a subdevice? */</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>	<span class="cm">/* pointer to the usb-device */</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urbIn</span><span class="p">;</span>	<span class="cm">/* BULK-transfer handling: urb */</span>
	<span class="kt">int8_t</span> <span class="o">*</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">int16_t</span> <span class="o">*</span><span class="n">insnBuffer</span><span class="p">;</span>	<span class="cm">/* input buffer for single insn */</span>
	<span class="kt">int</span> <span class="n">ifnum</span><span class="p">;</span>		<span class="cm">/* interface number */</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>	<span class="cm">/* interface structure */</span>
	<span class="cm">/* comedi device for the interrupt context */</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">comedidev</span><span class="p">;</span>
	<span class="kt">short</span> <span class="kt">int</span> <span class="n">ai_cmd_running</span><span class="p">;</span>	<span class="cm">/* asynchronous command is running */</span>
	<span class="kt">short</span> <span class="kt">int</span> <span class="n">ai_continous</span><span class="p">;</span>	<span class="cm">/* continous acquisition */</span>
	<span class="kt">long</span> <span class="kt">int</span> <span class="n">ai_sample_count</span><span class="p">;</span>	<span class="cm">/* number of samples to acquire */</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">dux_commands</span><span class="p">;</span>	<span class="cm">/* commands */</span>
	<span class="kt">int</span> <span class="n">ignore</span><span class="p">;</span>		<span class="cm">/* counter which ignores the first</span>
<span class="cm">				   buffers */</span>
	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">sem</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The pointer to the private usb-data of the driver</span>
<span class="cm"> * is also the private data for the comedi-device.</span>
<span class="cm"> * This has to be global as the usb subsystem needs</span>
<span class="cm"> * global variables. The other reason is that this</span>
<span class="cm"> * structure must be there _before_ any comedi</span>
<span class="cm"> * command is issued. The usb subsystem must be</span>
<span class="cm"> * initialised before comedi can access it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">NUMUSBDUXFAST</span><span class="p">];</span>

<span class="k">static</span> <span class="n">DEFINE_SEMAPHORE</span><span class="p">(</span><span class="n">start_stop_sem</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">driver_usbduxfast</span><span class="p">;</span>	<span class="cm">/* see below for initializer */</span>

<span class="cm">/*</span>
<span class="cm"> * bulk transfers to usbduxfast</span>
<span class="cm"> */</span>
<span class="cp">#define SENDADCOMMANDS            0</span>
<span class="cp">#define SENDINITEP6               1</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_dux_commands</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">nsent</span><span class="p">;</span>

	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_type</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: usbduxfast: dux_commands: &quot;</span><span class="p">,</span>
	       <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">SIZEOFDUXBUFFER</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">tmp</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
			   <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">CHANNELLISTEP</span><span class="p">),</span>
			   <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">,</span> <span class="n">SIZEOFDUXBUFFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nsent</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: could not transmit dux_commands to&quot;</span>
		       <span class="s">&quot;the usb-device, err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stops the data acquision.</span>
<span class="cm"> * It should be safe to call this function from any context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfastsub_unlink_InURBs</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udfs</span> <span class="o">&amp;&amp;</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* waits until a running transfer is over */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="p">);</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi: usbduxfast: unlinked InURB: res=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This will stop a running acquisition operation.</span>
<span class="cm"> * Is called from within this driver from both the</span>
<span class="cm"> * interrupt context and from comedi.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfast_ai_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_unlink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi?: usbduxfast_ai_stop: udfs=NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi: usbduxfast_ai_stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_unlink</span><span class="p">)</span>
		<span class="cm">/* stop aquistion */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbduxfastsub_unlink_InURBs</span><span class="p">(</span><span class="n">udfs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This will cancel a running acquisition operation.</span>
<span class="cm"> * This is called by comedi but never from inside the driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfast_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* force unlink of all urbs */</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi: usbduxfast_ai_cancel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">udfs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi: usbduxfast_ai_cancel: udfs=NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">probed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* unlink */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbduxfast_ai_stop</span><span class="p">(</span><span class="n">udfs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * analogue IN</span>
<span class="cm"> * interrupt service routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbduxfastsub_ai_Irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">this_comedidev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="cm">/* sanity checks - is the urb there? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast_: ao int-handler called &quot;</span>
		       <span class="s">&quot;with urb=NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* the context variable points to the subdevice */</span>
	<span class="n">this_comedidev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_comedidev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast_: urb context is a NULL &quot;</span>
		       <span class="s">&quot;pointer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* the private structure of the subdevice is usbduxfastsub_s */</span>
	<span class="n">udfs</span> <span class="o">=</span> <span class="n">this_comedidev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast_: private of comedi &quot;</span>
		       <span class="s">&quot;subdev is a NULL pointer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* are we running a command? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * not running a command</span>
<span class="cm">		 * do not continue execution if no asynchronous command</span>
<span class="cm">		 * is running in particular not resubmit</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no comedi device there */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* subdevice which is the AD converter */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">this_comedidev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">SUBDEV_AD</span><span class="p">;</span>

	<span class="cm">/* first we test if something unusual has just happened */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * happens after an unlink command or when the device</span>
<span class="cm">		 * is plugged out</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNABORTED</span>:
		<span class="cm">/* tell this comedi */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="cm">/* stop the transfer w/o unlink */</span>
		<span class="n">usbduxfast_ai_stop</span><span class="p">(</span><span class="n">udfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;comedi%d: usbduxfast: non-zero urb status received in &quot;</span>
		       <span class="s">&quot;ai intr context: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">usbduxfast_ai_stop</span><span class="p">(</span><span class="n">udfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_continous</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not continuous, fixed number of samples */</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_sample_count</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * we have send only a fraction of the bytes</span>
<span class="cm">				 * received</span>
<span class="cm">				 */</span>
				<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
							  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
							  <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_sample_count</span>
							  <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
				<span class="n">usbduxfast_ai_stop</span><span class="p">(</span><span class="n">udfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="cm">/* tell comedi that the acquistion is over */</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
				<span class="n">comedi_event</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_sample_count</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* write the full buffer to comedi */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
						<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* buffer overflow */</span>
			<span class="n">usbduxfast_ai_stop</span><span class="p">(</span><span class="n">udfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* tell comedi that data is there */</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* ignore this packet */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * command is still running</span>
<span class="cm">	 * resubmit urb for BULK transfer</span>
<span class="cm">	 */</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: usbduxfast: urb resubm failed: %d&quot;</span><span class="p">,</span>
		       <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">usbduxfast_ai_stop</span><span class="p">(</span><span class="n">udfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfastsub_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">local_transfer_buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="cm">/* 7f92 to zero */</span>
	<span class="n">local_transfer_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* bRequest, &quot;Firmware&quot; */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">USBDUXFASTSUB_FIRMWARE</span><span class="p">,</span>
			      <span class="n">VENDOR_DIR_OUT</span><span class="p">,</span>	  <span class="cm">/* bmRequestType */</span>
			      <span class="n">USBDUXFASTSUB_CPUCS</span><span class="p">,</span>    <span class="cm">/* Value */</span>
			      <span class="mh">0x0000</span><span class="p">,</span>	<span class="cm">/* Index */</span>
			      <span class="cm">/* address of the transfer buffer */</span>
			      <span class="n">local_transfer_buffer</span><span class="p">,</span>
			      <span class="mi">1</span><span class="p">,</span>      <span class="cm">/* Length */</span>
			      <span class="n">EZTIMEOUT</span><span class="p">);</span>    <span class="cm">/* Timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;comedi_: usbduxfast_: control msg failed (start)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfastsub_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">local_transfer_buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="cm">/* 7f92 to one */</span>
	<span class="n">local_transfer_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* bRequest, &quot;Firmware&quot; */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">USBDUXFASTSUB_FIRMWARE</span><span class="p">,</span>
			      <span class="n">VENDOR_DIR_OUT</span><span class="p">,</span>	<span class="cm">/* bmRequestType */</span>
			      <span class="n">USBDUXFASTSUB_CPUCS</span><span class="p">,</span>	<span class="cm">/* Value */</span>
			      <span class="mh">0x0000</span><span class="p">,</span>	<span class="cm">/* Index */</span>
			      <span class="n">local_transfer_buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Length */</span>
			      <span class="n">EZTIMEOUT</span><span class="p">);</span>	<span class="cm">/* Timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast: control msg failed &quot;</span>
		       <span class="s">&quot;(stop)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfastsub_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">local_transfer_buffer</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">startAddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi: usbduxfast: uploading %d bytes&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; to addr %d, first byte=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">startAddr</span><span class="p">,</span> <span class="n">local_transfer_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="cm">/* brequest, firmware */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">USBDUXFASTSUB_FIRMWARE</span><span class="p">,</span>
			      <span class="n">VENDOR_DIR_OUT</span><span class="p">,</span>	<span class="cm">/* bmRequestType */</span>
			      <span class="n">startAddr</span><span class="p">,</span>	<span class="cm">/* value */</span>
			      <span class="mh">0x0000</span><span class="p">,</span>	 <span class="cm">/* index */</span>
			      <span class="cm">/* our local safe buffer */</span>
			      <span class="n">local_transfer_buffer</span><span class="p">,</span>
			      <span class="n">len</span><span class="p">,</span>	<span class="cm">/* length */</span>
			      <span class="n">EZTIMEOUT</span><span class="p">);</span>      <span class="cm">/* timeout */</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi_: usbduxfast: result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast: uppload failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfastsub_submit_InURBs</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="p">,</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
			  <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">BULKINEP</span><span class="p">),</span>
			  <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
			  <span class="n">SIZEINBUF</span><span class="p">,</span> <span class="n">usbduxfastsub_ai_Irq</span><span class="p">,</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: usbduxfast: submitting in-urb: &quot;</span>
	       <span class="s">&quot;0x%p,0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
	       <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast: ai: usb_submit_urb error&quot;</span>
		       <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfast_ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">int</span> <span class="n">steps</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minSamplPer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">probed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: usbduxfast_ai_cmdtest</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: usbduxfast: convert_arg=%u &quot;</span>
	       <span class="s">&quot;scan_begin_arg=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span> <span class="o">|</span> <span class="n">TRIG_INT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_FOLLOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">stop_mask</span> <span class="o">=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">stop_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * step 2: make sure trigger sources are unique and mutually compatible</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_INT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* can&#39;t have external stop and start triggers at once */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">minSamplPer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">minSamplPer</span> <span class="o">=</span> <span class="n">MIN_SAMPLING_PERIOD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">steps</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="mi">30</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">minSamplPer</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
			<span class="n">steps</span> <span class="o">=</span> <span class="n">minSamplPer</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_SAMPLING_PERIOD</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
			<span class="n">steps</span> <span class="o">=</span> <span class="n">MAX_SAMPLING_PERIOD</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

		<span class="cm">/* calc arg again */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">/</span> <span class="mi">30</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* stop source */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_COUNT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_NONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * TRIG_EXT doesn&#39;t care since it doesn&#39;t trigger</span>
<span class="cm">		 * off a numbered channel</span>
<span class="cm">		 */</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfast_ai_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">probed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: usbduxfast_ai_inttrig</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trignum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: usbduxfast_ai_inttrig: invalid&quot;</span>
		       <span class="s">&quot; trignum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbduxfastsub_submit_InURBs</span><span class="p">(</span><span class="n">udfs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: usbduxfast_ai_inttrig: &quot;</span>
			       <span class="s">&quot;urbSubmit: err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: ai_inttrig but acqu is already&quot;</span>
		       <span class="s">&quot; running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * offsets for the GPIF bytes</span>
<span class="cm"> * the first byte is the command byte</span>
<span class="cm"> */</span>
<span class="cp">#define LENBASE	(1+0x00)</span>
<span class="cp">#define OPBASE	(1+0x08)</span>
<span class="cp">#define OUTBASE	(1+0x10)</span>
<span class="cp">#define LOGBASE	(1+0x18)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfast_ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">steps</span><span class="p">,</span> <span class="n">steps_tmp</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: usbduxfast_ai_cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">udfs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">probed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: ai_cmd not possible. Another ai_cmd&quot;</span>
		       <span class="s">&quot; is running.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set current channel of the running acquisition to zero */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ignore the first buffers from the device if there</span>
<span class="cm">	 * is an error condition</span>
<span class="cm">	 */</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ignore</span> <span class="o">=</span> <span class="n">PACKETS_TO_IGNORE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gain</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: cmd is accepting &quot;</span>
				       <span class="s">&quot;only consecutive channels.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
				<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">gain</span> <span class="o">!=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: the gain must be&quot;</span>
				       <span class="s">&quot; the same for all channels.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
				<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">NUMCHANNELS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: channel list too&quot;</span>
				       <span class="s">&quot; long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: usbduxfast: &quot;</span>
		       <span class="s">&quot;scan_begin_src==TRIG_TIMER not valid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="n">MIN_SAMPLING_PERIOD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: usbduxfast: ai_cmd: steps=%ld, &quot;</span>
		       <span class="s">&quot;scan_begin_arg=%d. Not properly tested by cmdtest?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&gt;</span> <span class="n">MAX_SAMPLING_PERIOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: usbduxfast: ai_cmd: sampling rate &quot;</span>
		       <span class="s">&quot;too low.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: usbduxfast: ai_cmd: TRIG_EXT only&quot;</span>
		       <span class="s">&quot; with 1 or 16 channels possible.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: usbduxfast: steps=%ld, convert_arg=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * one channel</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * for external trigger: looping in this state until</span>
<span class="cm">		 * the RDY0 pin becomes zero</span>
<span class="cm">		 */</span>

		<span class="cm">/* we loop here until ready has been set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* branch back to state 0 */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="cm">/* deceision state w/o data */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
			<span class="cm">/* RDY0 = 0 */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* we just proceed to state 1 */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="n">MIN_SAMPLING_PERIOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* for fast single channel aqu without mux */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * we just stay here at state 1 and rexecute</span>
<span class="cm">				 * the same state this gives us 30MHz sampling</span>
<span class="cm">				 * rate</span>
<span class="cm">				 */</span>

				<span class="cm">/* branch back to state 1 */</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x89</span><span class="p">;</span>
				<span class="cm">/* deceision state with data */</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				    <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
				<span class="cm">/* doesn&#39;t matter */</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * we loop through two states: data and delay</span>
<span class="cm">				 * max rate is 15MHz</span>
<span class="cm">				 */</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="cm">/* data */</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				    <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
				<span class="cm">/* doesn&#39;t matter */</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* branch back to state 1 */</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
				<span class="cm">/* deceision state w/o data */</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				    <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
				<span class="cm">/* doesn&#39;t matter */</span>
				<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * we loop through 3 states: 2x delay and 1x data</span>
<span class="cm">			 * this gives a min sampling rate of 60kHz</span>
<span class="cm">			 */</span>

			<span class="cm">/* we have 1 state with duration 1 */</span>
			<span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* do the first part of the delay */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* and the second part */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">-</span> <span class="n">steps</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* get the data and branch back */</span>

			<span class="cm">/* branch back to state 1 */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
			<span class="cm">/* deceision state w data */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
			<span class="cm">/* doesn&#39;t matter */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*</span>
<span class="cm">		 * two channels</span>
<span class="cm">		 * commit data to the FIFO</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* data */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* we have 1 state with duration 1: state 0 */</span>
		<span class="n">steps_tmp</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="cm">/* do the first part of the delay */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps_tmp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* count */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFE</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* and the second part */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps_tmp</span> <span class="o">-</span> <span class="n">steps_tmp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* data */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * we have 2 states with duration 1: step 6 and</span>
<span class="cm">		 * the IDLE state</span>
<span class="cm">		 */</span>
		<span class="n">steps_tmp</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="cm">/* do the first part of the delay */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps_tmp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* reset */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* and the second part */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps_tmp</span> <span class="o">-</span> <span class="n">steps_tmp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/*</span>
<span class="cm">		 * three channels</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * commit data to the FIFO and do the first part</span>
<span class="cm">			 * of the delay</span>
<span class="cm">			 */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* data */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="cm">/* no change */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

			<span class="cm">/* do the second part of the delay */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">steps</span> <span class="o">-</span> <span class="n">steps</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* no data */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* count */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			    <span class="mh">0xFE</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* 2 steps with duration 1: the idele step and step 6: */</span>
		<span class="n">steps_tmp</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* commit data to the FIFO and do the first part of the delay */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps_tmp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* data */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="cm">/* do the second part of the delay */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps_tmp</span> <span class="o">-</span> <span class="n">steps_tmp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* no data */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* reset */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * we loop here until ready has been set</span>
<span class="cm">			 */</span>

			<span class="cm">/* branch back to state 0 */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="cm">/* deceision state w/o data */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="cm">/* reset */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
			<span class="cm">/* RDY0 = 0 */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * we just proceed to state 1</span>
<span class="cm">			 */</span>

			<span class="cm">/* 30us reset pulse */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* reset */</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* commit data to the FIFO */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* data */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* we have 2 states with duration 1 */</span>
		<span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* do the first part of the delay */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFE</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* and the second part */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">-</span> <span class="n">steps</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* branch back to state 1 */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
		<span class="cm">/* deceision state w/o data */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
		<span class="cm">/* doesn&#39;t matter */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi %d: unsupported combination of &quot;</span>
		       <span class="s">&quot;channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi %d: sending commands to the usb device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* 0 means that the AD commands are sent */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">send_dux_commands</span><span class="p">(</span><span class="n">udfs</span><span class="p">,</span> <span class="n">SENDADCOMMANDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: adc command could not be submitted.&quot;</span>
		       <span class="s">&quot;Aborting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_sample_count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_sample_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: &quot;</span>
			       <span class="s">&quot;(cmd-&gt;stop_arg)*(cmd-&gt;scan_end_arg)&lt;1, &quot;</span>
			       <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_continous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* continous acquisition */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_continous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_sample_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* enable this acquisition operation */</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbduxfastsub_submit_InURBs</span><span class="p">(</span><span class="n">udfs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* fixme: unlink here?? */</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TRIG_INT</span>
<span class="cm">		 * don&#39;t enable the acquision operation</span>
<span class="cm">		 * wait for an internal signal</span>
<span class="cm">		 */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="n">usbduxfast_ai_inttrig</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mode 0 is used to get a single conversion on demand.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfast_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">actual_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">rngmask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">;</span>

	<span class="n">udfs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: ai_insn_read: no usb dev.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: ai_insn_read, insn-&gt;n=%d, &quot;</span>
	       <span class="s">&quot;insn-&gt;subdev=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">probed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: ai_insn_read not possible. Async &quot;</span>
		       <span class="s">&quot;Command is running.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* sample one channel */</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="cm">/* set command for the first channel */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rngmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* commit data to the FIFO */</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* data */</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* do the first part of the delay */</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFE</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFE</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFE</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFE</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* second part */</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LENBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OPBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">OUTBASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">rngmask</span><span class="p">;</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">[</span><span class="n">LOGBASE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi %d: sending commands to the usb device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* 0 means that the AD commands are sent */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">send_dux_commands</span><span class="p">(</span><span class="n">udfs</span><span class="p">,</span> <span class="n">SENDADCOMMANDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: adc command could not be submitted.&quot;</span>
		       <span class="s">&quot;Aborting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi%d: usbduxfast: submitting in-urb: &quot;</span>
	       <span class="s">&quot;0x%p,0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">comedidev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
	       <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PACKETS_TO_IGNORE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
				   <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">BULKINEP</span><span class="p">),</span>
				   <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">SIZEINBUF</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">actual_length</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: insn timeout. No data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* data points */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
				   <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">BULKINEP</span><span class="p">),</span>
				   <span class="n">udfs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">SIZEINBUF</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">actual_length</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: insn data error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">actual_length</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: insn data packet &quot;</span>
			       <span class="s">&quot;corrupted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">))[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define FIRMWARE_MAX_LEN 0x2000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">firmwareUpload</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">usbduxfastsub</span><span class="p">,</span>
			  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">firmwareBinary</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sizeFirmware</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">fwBuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">firmwareBinary</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sizeFirmware</span> <span class="o">&gt;</span> <span class="n">FIRMWARE_MAX_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbduxfastsub</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;comedi_: usbduxfast firmware binary it too large for FX2.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we generate a local buffer for the firmware */</span>
	<span class="n">fwBuf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">firmwareBinary</span><span class="p">,</span> <span class="n">sizeFirmware</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fwBuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbduxfastsub</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;comedi_: mem alloc for firmware failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbduxfastsub_stop</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbduxfastsub</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;comedi_: can not stop firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fwBuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbduxfastsub_upload</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">,</span> <span class="n">fwBuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeFirmware</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbduxfastsub</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;comedi_: firmware upload failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fwBuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbduxfastsub_start</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbduxfastsub</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;comedi_: can not start firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fwBuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fwBuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tidy_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi_: usbduxfast: tiding up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* shows the usb subsystem that the driver is down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">)</span>
		<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* waits until a running transfer is over */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span><span class="p">);</span>
		<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">urbIn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">insnBuffer</span><span class="p">);</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">insnBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span><span class="p">);</span>
	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">dux_commands</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">udfs</span><span class="o">-&gt;</span><span class="n">ai_cmd_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbduxfast_firmware_request_complete_handler</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span>
							 <span class="o">*</span><span class="n">fw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">usbduxfastsub_tmp</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">uinterf</span> <span class="o">=</span> <span class="n">usbduxfastsub_tmp</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we need to upload the firmware here because fw will be</span>
<span class="cm">	 * freed once we&#39;ve left this function</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">firmwareUpload</span><span class="p">(</span><span class="n">usbduxfastsub_tmp</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uinterf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Could not upload firmware (err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">comedi_usb_auto_config</span><span class="p">(</span><span class="n">uinterf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_usbduxfast</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate memory for the urbs and initialise them</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfastsub_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">uinterf</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">uinterf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast_: This driver needs&quot;</span>
		       <span class="s">&quot;USB 2.0 to operate. Aborting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi_: usbduxfast_: finding a free structure for &quot;</span>
	       <span class="s">&quot;the usb-device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
	<span class="cm">/* look for a free place in the usbduxfast array */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMUSBDUXFAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">probed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* no more space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Too many usbduxfast-devices connected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMFILE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi_: usbduxfast: usbduxfastsub[%d] is ready to &quot;</span>
	       <span class="s">&quot;connect to comedi.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">sem</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* save a pointer to the usb device */</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>

	<span class="cm">/* save the interface itself */</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">interface</span> <span class="o">=</span> <span class="n">uinterf</span><span class="p">;</span>
	<span class="cm">/* get the interface number from the interface */</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ifnum</span> <span class="o">=</span> <span class="n">uinterf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * hand the private data over to the usb subsystem</span>
<span class="cm">	 * will be needed for disconnect</span>
<span class="cm">	 */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">uinterf</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi_: usbduxfast: ifnum=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ifnum</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* create space for the commands going to the usb device */</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">dux_commands</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SIZEOFDUXBUFFER</span><span class="p">,</span>
						    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">dux_commands</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast: error alloc space for &quot;</span>
		       <span class="s">&quot;dac commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tidy_up</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* create space of the instruction buffer */</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">insnBuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SIZEINSNBUF</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">insnBuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast: could not alloc space &quot;</span>
		       <span class="s">&quot;for insnBuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tidy_up</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* setting to alternate setting 1: enabling bulk ep */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usbdev</span><span class="p">,</span>
			      <span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ifnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast%d: could not switch to &quot;</span>
		       <span class="s">&quot;alternate setting 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">tidy_up</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">urbIn</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">urbIn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast%d: Could not alloc.&quot;</span>
		       <span class="s">&quot;urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">tidy_up</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SIZEINBUF</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast%d: could not alloc. &quot;</span>
		       <span class="s">&quot;transb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">tidy_up</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* we&#39;ve reached the bottom of the function */</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware_nowait</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span>
				      <span class="n">FW_ACTION_HOTPLUG</span><span class="p">,</span>
				      <span class="s">&quot;usbduxfast_firmware.bin&quot;</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">GFP_KERNEL</span><span class="p">,</span>
				      <span class="n">usbduxfastsub</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span>
				      <span class="n">usbduxfast_firmware_request_complete_handler</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not load firmware (err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi_: usbduxfast%d has been successfully &quot;</span>
	       <span class="s">&quot;initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="cm">/* success */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbduxfastsub_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">udfs</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast: disconnect called with &quot;</span>
		       <span class="s">&quot;null pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">usbdev</span> <span class="o">!=</span> <span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi_: usbduxfast: BUG! called with wrong &quot;</span>
		       <span class="s">&quot;ptr!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">comedi_usb_auto_unconfig</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="n">tidy_up</span><span class="p">(</span><span class="n">udfs</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udfs</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;comedi_: usbduxfast: disconnected from the usb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * is called when comedi-config is called</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbduxfast_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * find a valid device which has been detected by the</span>
<span class="cm">	 * probe function of the usb</span>
<span class="cm">	 */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMUSBDUXFAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">probed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: usbduxfast: error: attach failed, &quot;</span>
		       <span class="s">&quot;no usbduxfast devs connected to the usb bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">sem</span><span class="p">));</span>
	<span class="cm">/* pointer back to the corresponding comedi device */</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">comedidev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* trying to upload the firmware into the chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comedi_aux_data</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA_LENGTH</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">firmwareUpload</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
			       <span class="n">comedi_aux_data</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA_LENGTH</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">BOARDNAME</span><span class="p">;</span>

	<span class="cm">/* set number of subdevices */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span> <span class="o">=</span> <span class="n">N_SUBDEVICES</span><span class="p">;</span>

	<span class="cm">/* allocate space for the subdevices */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">N_SUBDEVICES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: usbduxfast: error alloc space for &quot;</span>
		       <span class="s">&quot;subdev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">sem</span><span class="p">));</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi%d: usbduxfast: usb-device %d is attached to &quot;</span>
	       <span class="s">&quot;comedi.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="cm">/* private structure is also simply the usb-structure */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">usbduxfastsub</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="cm">/* the first subdevice is the A/D converter */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">SUBDEV_AD</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * the URBs get the comedi subdevice which is responsible for reading</span>
<span class="cm">	 * this is the subdevice which reads data</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="cm">/* the subdevice receives as private structure the usb-structure */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* analog input */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
	<span class="cm">/* readable and ref is to ground */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
	<span class="cm">/* 16 channels */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="cm">/* length of the channellist */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="cm">/* callback functions */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">usbduxfast_ai_insn_read</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">usbduxfast_ai_cmdtest</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">usbduxfast_ai_cmd</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">usbduxfast_ai_cancel</span><span class="p">;</span>
	<span class="cm">/* max value from the A/D converter (12bit+1 bit for overflow) */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="cm">/* range table to convert to physical units */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_usbduxfast_ai_range</span><span class="p">;</span>

	<span class="cm">/* finally decide that it&#39;s attached */</span>
	<span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">attached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbduxfastsub</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">sem</span><span class="p">));</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi%d: successfully attached to usbduxfast.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbduxfast_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbduxfastsub_s</span> <span class="o">*</span><span class="n">usb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">usb</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">usb</span><span class="o">-&gt;</span><span class="n">comedidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_stop_sem</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * main driver struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">driver_usbduxfast</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;usbduxfast&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">usbduxfast_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">usbduxfast_detach</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Table with the USB-devices: just now only testing IDs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">usbduxfastsub_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* { USB_DEVICE(0x4b4, 0x8613) }, testing */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x13d8</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">)},</span>	<span class="cm">/* real ID */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x13d8</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">)},</span>	<span class="cm">/* real ID */</span>
	<span class="p">{}</span>			<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">usbduxfastsub_table</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The usbduxfastsub-driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">usbduxfastsub_driver</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef COMEDI_HAVE_USB_DRIVER_OWNER</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">BOARDNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">usbduxfastsub_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">usbduxfastsub_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">usbduxfastsub_table</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Can&#39;t use the nice macro as I have also to initialise the USB subsystem:</span>
<span class="cm"> * registering the usb-system _and_ the comedi-driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_usbduxfast</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="n">KBUILD_MODNAME</span> <span class="s">&quot;: &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot;:&quot;</span> <span class="n">DRIVER_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbduxfastsub_driver</span><span class="p">);</span>
	<span class="n">comedi_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_usbduxfast</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deregistering the comedi driver and the usb-subsystem</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_usbduxfast</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_usbduxfast</span><span class="p">);</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbduxfastsub_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_usbduxfast</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_usbduxfast</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
