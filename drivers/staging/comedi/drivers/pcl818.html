<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › pcl818.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pcl818.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   comedi/drivers/pcl818.c</span>

<span class="cm">   Author:  Michal Dobes &lt;dobes@tesnet.cz&gt;</span>

<span class="cm">   hardware driver for Advantech cards:</span>
<span class="cm">    card:   PCL-818L, PCL-818H, PCL-818HD, PCL-818HG, PCL-818, PCL-718</span>
<span class="cm">    driver: pcl818l,  pcl818h,  pcl818hd,  pcl818hg,  pcl818,  pcl718</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">Driver: pcl818</span>
<span class="cm">Description: Advantech PCL-818 cards, PCL-718</span>
<span class="cm">Author: Michal Dobes &lt;dobes@tesnet.cz&gt;</span>
<span class="cm">Devices: [Advantech] PCL-818L (pcl818l), PCL-818H (pcl818h),</span>
<span class="cm">  PCL-818HD (pcl818hd), PCL-818HG (pcl818hg), PCL-818 (pcl818),</span>
<span class="cm">  PCL-718 (pcl718)</span>
<span class="cm">Status: works</span>

<span class="cm">All cards have 16 SE/8 DIFF ADCs, one or two DACs, 16 DI and 16 DO.</span>
<span class="cm">Differences are only at maximal sample speed, range list and FIFO</span>
<span class="cm">support.</span>
<span class="cm">The driver support AI mode 0, 1, 3 other subdevices (AO, DI, DO) support</span>
<span class="cm">only mode 0. If DMA/FIFO/INT are disabled then AI support only mode 0.</span>
<span class="cm">PCL-818HD and PCL-818HG support 1kword FIFO. Driver support this FIFO</span>
<span class="cm">but this code is untested.</span>
<span class="cm">A word or two about DMA. Driver support DMA operations at two ways:</span>
<span class="cm">1) DMA uses two buffers and after one is filled then is generated</span>
<span class="cm">   INT and DMA restart with second buffer. With this mode I&#39;m unable run</span>
<span class="cm">   more that 80Ksamples/secs without data dropouts on K6/233.</span>
<span class="cm">2) DMA uses one buffer and run in autoinit mode and the data are</span>
<span class="cm">   from DMA buffer moved on the fly with 2kHz interrupts from RTC.</span>
<span class="cm">   This mode is used if the interrupt 8 is available for allocation.</span>
<span class="cm">   If not, then first DMA mode is used. With this I can run at</span>
<span class="cm">   full speed one card (100ksamples/secs) or two cards with</span>
<span class="cm">   60ksamples/secs each (more is problem on account of ISA limitations).</span>
<span class="cm">   To use this mode you must have compiled  kernel with disabled</span>
<span class="cm">   &quot;Enhanced Real Time Clock Support&quot;.</span>
<span class="cm">   Maybe you can have problems if you use xntpd or similar.</span>
<span class="cm">   If you&#39;ve data dropouts with DMA mode 2 then:</span>
<span class="cm">    a) disable IDE DMA</span>
<span class="cm">    b) switch text mode console to fb.</span>

<span class="cm">   Options for PCL-818L:</span>
<span class="cm">    [0] - IO Base</span>
<span class="cm">    [1] - IRQ	(0=disable, 2, 3, 4, 5, 6, 7)</span>
<span class="cm">    [2] - DMA	(0=disable, 1, 3)</span>
<span class="cm">    [3] - 0, 10=10MHz clock for 8254</span>
<span class="cm">              1= 1MHz clock for 8254</span>
<span class="cm">    [4] - 0,  5=A/D input  -5V.. +5V</span>
<span class="cm">          1, 10=A/D input -10V..+10V</span>
<span class="cm">    [5] - 0,  5=D/A output 0-5V  (internal reference -5V)</span>
<span class="cm">          1, 10=D/A output 0-10V (internal reference -10V)</span>
<span class="cm">	  2    =D/A output unknown (external reference)</span>

<span class="cm">   Options for PCL-818, PCL-818H:</span>
<span class="cm">    [0] - IO Base</span>
<span class="cm">    [1] - IRQ	(0=disable, 2, 3, 4, 5, 6, 7)</span>
<span class="cm">    [2] - DMA	(0=disable, 1, 3)</span>
<span class="cm">    [3] - 0, 10=10MHz clock for 8254</span>
<span class="cm">              1= 1MHz clock for 8254</span>
<span class="cm">    [4] - 0,  5=D/A output 0-5V  (internal reference -5V)</span>
<span class="cm">          1, 10=D/A output 0-10V (internal reference -10V)</span>
<span class="cm">	  2    =D/A output unknown (external reference)</span>

<span class="cm">   Options for PCL-818HD, PCL-818HG:</span>
<span class="cm">    [0] - IO Base</span>
<span class="cm">    [1] - IRQ	(0=disable, 2, 3, 4, 5, 6, 7)</span>
<span class="cm">    [2] - DMA/FIFO  (-1=use FIFO, 0=disable both FIFO and DMA,</span>
<span class="cm">                      1=use DMA ch 1, 3=use DMA ch 3)</span>
<span class="cm">    [3] - 0, 10=10MHz clock for 8254</span>
<span class="cm">              1= 1MHz clock for 8254</span>
<span class="cm">    [4] - 0,  5=D/A output 0-5V  (internal reference -5V)</span>
<span class="cm">          1, 10=D/A output 0-10V (internal reference -10V)</span>
<span class="cm">   	  2    =D/A output unknown (external reference)</span>

<span class="cm">   Options for PCL-718:</span>
<span class="cm">    [0] - IO Base</span>
<span class="cm">    [1] - IRQ	(0=disable, 2, 3, 4, 5, 6, 7)</span>
<span class="cm">    [2] - DMA	(0=disable, 1, 3)</span>
<span class="cm">    [3] - 0, 10=10MHz clock for 8254</span>
<span class="cm">              1= 1MHz clock for 8254</span>
<span class="cm">    [4] -     0=A/D Range is +/-10V</span>
<span class="cm">	      1=             +/-5V</span>
<span class="cm">	      2=             +/-2.5V</span>
<span class="cm">	      3=             +/-1V</span>
<span class="cm">	      4=             +/-0.5V</span>
<span class="cm">	      5=  	     user defined bipolar</span>
<span class="cm">	      6=	     0-10V</span>
<span class="cm">	      7=	     0-5V</span>
<span class="cm"> 	      8=	     0-2V</span>
<span class="cm">	      9=	     0-1V</span>
<span class="cm">	     10=	     user defined unipolar</span>
<span class="cm">    [5] - 0,  5=D/A outputs 0-5V  (internal reference -5V)</span>
<span class="cm">          1, 10=D/A outputs 0-10V (internal reference -10V)</span>
<span class="cm">	      2=D/A outputs unknown (external reference)</span>
<span class="cm">    [6] - 0, 60=max  60kHz A/D sampling</span>
<span class="cm">          1,100=max 100kHz A/D sampling (PCL-718 with Option 001 installed)</span>

<span class="cm">*/</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mc146818rtc.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &quot;8253.h&quot;</span>

<span class="cm">/* #define PCL818_MODE13_AO 1 */</span>

<span class="cm">/* boards constants */</span>

<span class="cp">#define boardPCL818L 0</span>
<span class="cp">#define boardPCL818H 1</span>
<span class="cp">#define boardPCL818HD 2</span>
<span class="cp">#define boardPCL818HG 3</span>
<span class="cp">#define boardPCL818 4</span>
<span class="cp">#define boardPCL718 5</span>

<span class="cm">/* IO space len */</span>
<span class="cp">#define PCLx1x_RANGE 16</span>
<span class="cm">/* IO space len if we use FIFO */</span>
<span class="cp">#define PCLx1xFIFO_RANGE 32</span>

<span class="cm">/* W: clear INT request */</span>
<span class="cp">#define PCL818_CLRINT 8</span>
<span class="cm">/* R: return status byte */</span>
<span class="cp">#define PCL818_STATUS 8</span>
<span class="cm">/* R: A/D high byte W: A/D range control */</span>
<span class="cp">#define PCL818_RANGE 1</span>
<span class="cm">/* R: next mux scan channel W: mux scan channel &amp; range control pointer */</span>
<span class="cp">#define PCL818_MUX 2</span>
<span class="cm">/* R/W: operation control register */</span>
<span class="cp">#define PCL818_CONTROL 9</span>
<span class="cm">/* W: counter enable */</span>
<span class="cp">#define PCL818_CNTENABLE 10</span>

<span class="cm">/* R: low byte of A/D W: soft A/D trigger */</span>
<span class="cp">#define PCL818_AD_LO 0</span>
<span class="cm">/* R: high byte of A/D W: A/D range control */</span>
<span class="cp">#define PCL818_AD_HI 1</span>
<span class="cm">/* W: D/A low&amp;high byte */</span>
<span class="cp">#define PCL818_DA_LO 4</span>
<span class="cp">#define PCL818_DA_HI 5</span>
<span class="cm">/* R: low&amp;high byte of DI */</span>
<span class="cp">#define PCL818_DI_LO 3</span>
<span class="cp">#define PCL818_DI_HI 11</span>
<span class="cm">/* W: low&amp;high byte of DO */</span>
<span class="cp">#define PCL818_DO_LO 3</span>
<span class="cp">#define PCL818_DO_HI 11</span>
<span class="cm">/* W: PCL718 second D/A */</span>
<span class="cp">#define PCL718_DA2_LO 6</span>
<span class="cp">#define PCL718_DA2_HI 7</span>
<span class="cm">/* counters */</span>
<span class="cp">#define PCL818_CTR0 12</span>
<span class="cp">#define PCL818_CTR1 13</span>
<span class="cp">#define PCL818_CTR2 14</span>
<span class="cm">/* W: counter control */</span>
<span class="cp">#define PCL818_CTRCTL 15</span>

<span class="cm">/* W: fifo enable/disable */</span>
<span class="cp">#define PCL818_FI_ENABLE 6</span>
<span class="cm">/* W: fifo interrupt clear */</span>
<span class="cp">#define PCL818_FI_INTCLR 20</span>
<span class="cm">/* W: fifo interrupt clear */</span>
<span class="cp">#define PCL818_FI_FLUSH 25</span>
<span class="cm">/* R: fifo status */</span>
<span class="cp">#define PCL818_FI_STATUS 25</span>
<span class="cm">/* R: one record from FIFO */</span>
<span class="cp">#define PCL818_FI_DATALO 23</span>
<span class="cp">#define PCL818_FI_DATAHI 23</span>

<span class="cm">/* type of interrupt handler */</span>
<span class="cp">#define INT_TYPE_AI1_INT 1</span>
<span class="cp">#define INT_TYPE_AI1_DMA 2</span>
<span class="cp">#define INT_TYPE_AI1_FIFO 3</span>
<span class="cp">#define INT_TYPE_AI3_INT 4</span>
<span class="cp">#define INT_TYPE_AI3_DMA 5</span>
<span class="cp">#define INT_TYPE_AI3_FIFO 6</span>
<span class="cp">#ifdef PCL818_MODE13_AO</span>
<span class="cp">#define INT_TYPE_AO1_INT 7</span>
<span class="cp">#define INT_TYPE_AO3_INT 8</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef unused</span>
<span class="cm">/* RTC stuff... */</span>
<span class="cp">#define INT_TYPE_AI1_DMA_RTC 9</span>
<span class="cp">#define INT_TYPE_AI3_DMA_RTC 10</span>

<span class="cp">#define RTC_IRQ 	8</span>
<span class="cp">#define RTC_IO_EXTENT	0x10</span>
<span class="cp">#endif</span>

<span class="cp">#define MAGIC_DMA_WORD 0x5a5a</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pcl818h_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							   <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pcl818hg_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.005</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pcl818l_l_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pcl818l_h_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range718_bipolar1</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range718_bipolar0_5</span> <span class="o">=</span>
    <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range718_unipolar2</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">2</span><span class="p">),}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range718_unipolar1</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),}</span> <span class="p">};</span>

<span class="cp">#ifdef unused</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">RTC_lock</span><span class="p">;</span>	<span class="cm">/* RTC lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">RTC_timer_lock</span><span class="p">;</span>	<span class="cm">/* RTC int lock */</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">pcl818_board</span> <span class="p">{</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>	<span class="cm">/*  driver name */</span>
	<span class="kt">int</span> <span class="n">n_ranges</span><span class="p">;</span>		<span class="cm">/*  len of range list */</span>
	<span class="kt">int</span> <span class="n">n_aichan_se</span><span class="p">;</span>	<span class="cm">/*  num of A/D chans in single ended  mode */</span>
	<span class="kt">int</span> <span class="n">n_aichan_diff</span><span class="p">;</span>	<span class="cm">/*  num of A/D chans in diferencial mode */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns_min</span><span class="p">;</span>	<span class="cm">/*  minimal allowed delay between samples (in ns) */</span>
	<span class="kt">int</span> <span class="n">n_aochan</span><span class="p">;</span>		<span class="cm">/*  num of D/A chans */</span>
	<span class="kt">int</span> <span class="n">n_dichan</span><span class="p">;</span>		<span class="cm">/*  num of DI chans */</span>
	<span class="kt">int</span> <span class="n">n_dochan</span><span class="p">;</span>		<span class="cm">/*  num of DO chans */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">ai_range_type</span><span class="p">;</span>	<span class="cm">/*  default A/D rangelist */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">ao_range_type</span><span class="p">;</span>	<span class="cm">/*  default D/A rangelist */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_range</span><span class="p">;</span>	<span class="cm">/*  len of IO space */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IRQbits</span><span class="p">;</span>	<span class="cm">/*  allowed interrupts */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DMAbits</span><span class="p">;</span>	<span class="cm">/*  allowed DMA chans */</span>
	<span class="kt">int</span> <span class="n">ai_maxdata</span><span class="p">;</span>		<span class="cm">/*  maxdata for A/D */</span>
	<span class="kt">int</span> <span class="n">ao_maxdata</span><span class="p">;</span>		<span class="cm">/*  maxdata for D/A */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fifo</span><span class="p">;</span>	<span class="cm">/*  1=board has FIFO */</span>
	<span class="kt">int</span> <span class="n">is_818</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pcl818_private</span> <span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>	<span class="cm">/*  used DMA, 0=don&#39;t use DMA */</span>
	<span class="kt">int</span> <span class="n">dma_rtc</span><span class="p">;</span>		<span class="cm">/*  1=RTC used with DMA, 0=no RTC alloc */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_range</span><span class="p">;</span>
<span class="cp">#ifdef unused</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtc_iobase</span><span class="p">;</span>	<span class="cm">/*  RTC port region */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtc_iosize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtc_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">rtc_irq_timer</span><span class="p">;</span>	<span class="cm">/*  timer for RTC sanity check */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtc_freq</span><span class="p">;</span>	<span class="cm">/*  RTC int freq */</span>
	<span class="kt">int</span> <span class="n">rtc_irq_blocked</span><span class="p">;</span>	<span class="cm">/*  1=we now do AI with DMA&amp;RTC */</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dmabuf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  pointers to begin of DMA buffers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmapages</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  len of DMA buffers in PAGE_SIZEs */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  hardware address of DMA buffers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwdmasize</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  len of DMA buffers in Bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmasamplsize</span><span class="p">;</span>	<span class="cm">/*  size in samples hwdmasize[0]/2 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_top_dma</span><span class="p">;</span>	<span class="cm">/*  DMA pointer in last RTC int */</span>
	<span class="kt">int</span> <span class="n">next_dma_buf</span><span class="p">;</span>	<span class="cm">/*  which DMA buffer will be used next round */</span>
	<span class="kt">long</span> <span class="n">dma_runs_to_end</span><span class="p">;</span>	<span class="cm">/*  how many we must permorm DMA transfer to end of record */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_dma_run</span><span class="p">;</span>	<span class="cm">/*  how many bytes we must transfer on last DMA page */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">neverending_ai</span><span class="p">;</span>	<span class="cm">/*  if=1, then we do neverending record (you must use cancel()) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns_min</span><span class="p">;</span>	<span class="cm">/*  manimal allowed delay between samples (in us) for actual card */</span>
	<span class="kt">int</span> <span class="n">i8253_osc_base</span><span class="p">;</span>	<span class="cm">/*  1/frequency of on board oscilator in ns */</span>
	<span class="kt">int</span> <span class="n">irq_free</span><span class="p">;</span>		<span class="cm">/*  1=have allocated IRQ */</span>
	<span class="kt">int</span> <span class="n">irq_blocked</span><span class="p">;</span>	<span class="cm">/*  1=IRQ now uses any subdev */</span>
	<span class="kt">int</span> <span class="n">irq_was_now_closed</span><span class="p">;</span>	<span class="cm">/*  when IRQ finish, there&#39;s stored int818_mode for last interrupt */</span>
	<span class="kt">int</span> <span class="n">ai_mode</span><span class="p">;</span>		<span class="cm">/*  who now uses IRQ - 1=AI1 int, 2=AI1 dma, 3=AI3 int, 4AI3 dma */</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">last_int_sub</span><span class="p">;</span>	<span class="cm">/*  ptr to subdevice which now finish */</span>
	<span class="kt">int</span> <span class="n">ai_act_scan</span><span class="p">;</span>	<span class="cm">/*  how many scans we finished */</span>
	<span class="kt">int</span> <span class="n">ai_act_chan</span><span class="p">;</span>	<span class="cm">/*  actual position in actual scan */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">act_chanlist</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="cm">/*  MUX setting for actual AI operations */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">act_chanlist_len</span><span class="p">;</span>	<span class="cm">/*  how long is actual MUX list */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">act_chanlist_pos</span><span class="p">;</span>	<span class="cm">/*  actual position in MUX list */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_scans</span><span class="p">;</span>	<span class="cm">/*  len of scanlist */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_n_chan</span><span class="p">;</span>	<span class="cm">/*  how many channels is measured */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ai_chanlist</span><span class="p">;</span>	<span class="cm">/*  actaul chanlist */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_flags</span><span class="p">;</span>	<span class="cm">/*  flaglist */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_data_len</span><span class="p">;</span>	<span class="cm">/*  len of data buffer */</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">ai_data</span><span class="p">;</span>		<span class="cm">/*  data buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_timer1</span><span class="p">;</span>	<span class="cm">/*  timers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_timer2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">sub_ai</span><span class="p">;</span>	<span class="cm">/*  ptr to AI subdevice */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">usefifo</span><span class="p">;</span>	<span class="cm">/*  1=use fifo */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_readback</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">muxonechan</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span>	<span class="cm">/*  used for gain list programming */</span>
	<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>

<span class="cp">#define devpriv ((struct pcl818_private *)dev-&gt;private)</span>
<span class="cp">#define this_board ((const struct pcl818_board *)dev-&gt;board_ptr)</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">setup_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seglen</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">check_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">start_pacer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor2</span><span class="p">);</span>

<span class="cp">#ifdef unused</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_rtc_irq_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtc_dropped_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rtc_setfreq_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">freq</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   ANALOG INPUT MODE0, 818 cards, slow version</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* software trigger, DMA and INT off */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>

	<span class="cm">/* select channel */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">muxonechan</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_MUX</span><span class="p">);</span>

	<span class="cm">/* select gain */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_RANGE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* clear INT (conversion end) flag */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CLRINT</span><span class="p">);</span>

		<span class="cm">/* start conversion */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_AD_LO</span><span class="p">);</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">conv_finish</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D insn timeout&quot;</span><span class="p">);</span>
		<span class="cm">/* clear INT (conversion end) flag */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CLRINT</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">conv_finish:</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_AD_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_AD_LO</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   ANALOG OUTPUT MODE0, 818 cards</span>
<span class="cm">   only one sample per call is supported</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_ao_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_ao_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
		     <span class="p">(</span><span class="n">chan</span> <span class="o">?</span> <span class="n">PCL718_DA2_LO</span> <span class="o">:</span> <span class="n">PCL818_DA_LO</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0ff0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
		     <span class="p">(</span><span class="n">chan</span> <span class="o">?</span> <span class="n">PCL718_DA2_HI</span> <span class="o">:</span> <span class="n">PCL818_DA_HI</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   DIGITAL INPUT MODE0, 818 cards</span>

<span class="cm">   only one sample per call is supported</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_di_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_DI_LO</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_DI_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   DIGITAL OUTPUT MODE0, 818 cards</span>

<span class="cm">   only one sample per call is supported</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_do_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_DO_LO</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_DO_HI</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   analog input interrupt mode 1 &amp; 3, 818 cards</span>
<span class="cm">   one sample per interrupt version</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl818_ai_mode13_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">low</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* wait max 50us */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">conv_finish</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_STATUS</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>
	<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D mode1/3 IRQ without DRDY!&quot;</span><span class="p">);</span>
	<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

<span class="nl">conv_finish:</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_AD_LO</span><span class="p">);</span>
	<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_AD_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">low</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)));</span>	<span class="cm">/*  get one sample */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">low</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="p">])</span> <span class="p">{</span>	<span class="cm">/*  dropout! */</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;comedi: A/D mode1/3 IRQ - channel dropout %x!=%x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">low</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">),</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="p">]);</span>
		<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_len</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  printk(&quot;E&quot;); */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* all data sampled */</span>
			<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   analog input dma mode 1 &amp; 3, 818 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl818_ai_mode13_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  switch dma bufs */</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">||</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
							 <span class="n">next_dma_buf</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_dma_run</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;comedi: A/D mode1/3 IRQ </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span><span class="o">--</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bufptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="n">bufptr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="p">])</span> <span class="p">{</span>	<span class="cm">/*  dropout! */</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;comedi: A/D mode1/3 DMA - channel dropout %d(card)!=%d(chanlist) at %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">bufptr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">),</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="p">],</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="p">);</span>
			<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
			<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">bufptr</span><span class="o">++</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/*  get one sample */</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_len</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* all data sampled */</span>
				<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
				<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="cm">/*  printk(&quot;done int ai13 dma\n&quot;); */</span>
				<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef unused</span>
<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   analog input dma mode 1 &amp; 3 over RTC, 818 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl818_ai_mode13_dma_rtc</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ofs_dats</span><span class="p">;</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* outb(2,0x378); */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INT_TYPE_AI1_DMA_RTC</span>:
	<span class="k">case</span> <span class="n">INT_TYPE_AI3_DMA_RTC</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">CMOS_READ</span><span class="p">(</span><span class="n">RTC_INTR_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq_timer</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_freq</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">top1</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">top2</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">top1</span> <span class="o">==</span> <span class="n">top2</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">top1</span> <span class="o">!=</span> <span class="n">top2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">top1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">top1</span><span class="p">;</span>	<span class="cm">/*  where is now DMA in buffer */</span>
		<span class="n">top1</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ofs_dats</span> <span class="o">=</span> <span class="n">top1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_top_dma</span><span class="p">;</span>	<span class="cm">/*  new samples from last call */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofs_dats</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ofs_dats</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmasamplsize</span><span class="p">)</span> <span class="o">+</span> <span class="n">ofs_dats</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ofs_dats</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>	<span class="cm">/*  exit=no new samples from last call */</span>
		<span class="cm">/*  obsluz data */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_top_dma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmasamplsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dmabuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MAGIC_DMA_WORD</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  DMA overflow! */</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D mode1/3 DMA buffer overflow!&quot;</span><span class="p">);</span>
			<span class="cm">/* printk(&quot;I %d dmabuf[i] %d %d\n&quot;,i,dmabuf[i],devpriv-&gt;dmasamplsize); */</span>
			<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
			<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* printk(&quot;r %ld &quot;,ofs_dats); */</span>

		<span class="n">bufptr</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_top_dma</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ofs_dats</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dmabuf</span><span class="p">[</span><span class="n">bufptr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="p">])</span> <span class="p">{</span>	<span class="cm">/*  dropout! */</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;comedi: A/D mode1/3 DMA - channel dropout %d!=%d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">dmabuf</span><span class="p">[</span><span class="n">bufptr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">),</span>
				     <span class="n">devpriv</span><span class="o">-&gt;</span>
				     <span class="n">act_chanlist</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="p">]);</span>
				<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span>
				    <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
				<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">[</span><span class="n">bufptr</span><span class="o">++</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/*  get one sample */</span>
			<span class="n">bufptr</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmasamplsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">&gt;=</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* all data sampled */</span>
					<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
					<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
					<span class="cm">/* printk(&quot;done int ai13 dma\n&quot;); */</span>
					<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
				<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_top_dma</span> <span class="o">=</span> <span class="n">bufptr</span><span class="p">;</span>
		<span class="n">bufptr</span><span class="o">--</span><span class="p">;</span>
		<span class="n">bufptr</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmasamplsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dmabuf</span><span class="p">[</span><span class="n">bufptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAGIC_DMA_WORD</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="cm">/* outb(0,0x378); */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* outb(0,0x378); */</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   analog input interrupt mode 1 &amp; 3, 818HD/HG cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl818_ai_mode13_fifo</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_INTCLR</span><span class="p">);</span>	<span class="cm">/*  clear fifo int request */</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D mode1/3 FIFO overflow!&quot;</span><span class="p">);</span>
		<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D mode1/3 FIFO interrupt without data!&quot;</span><span class="p">);</span>
		<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_DATALO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="p">])</span> <span class="p">{</span>	<span class="cm">/*  dropout! */</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;comedi: A/D mode1/3 FIFO - channel dropout %d!=%d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">),</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="p">]);</span>
			<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
			<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_DATAHI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>	<span class="cm">/*  get one sample */</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_len</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* all data sampled */</span>
				<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
				<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">    INT procedure</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pcl818</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;premature interrupt&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* printk(&quot;I\n&quot;); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_was_now_closed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span> <span class="o">&amp;&amp;</span>
						 <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">==</span> <span class="n">INT_TYPE_AI1_DMA</span> <span class="o">||</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">==</span> <span class="n">INT_TYPE_AI3_DMA</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* The cleanup from ai_cancel() has been delayed</span>
<span class="cm">			   until now because the card doesn&#39;t seem to like</span>
<span class="cm">			   being reprogrammed while a DMA transfer is in</span>
<span class="cm">			   progress.</span>
<span class="cm">			 */</span>
			<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>

		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INT_TYPE_AI1_DMA</span>:
	<span class="k">case</span> <span class="n">INT_TYPE_AI3_DMA</span>:
		<span class="k">return</span> <span class="n">interrupt_pcl818_ai_mode13_dma</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">INT_TYPE_AI1_INT</span>:
	<span class="k">case</span> <span class="n">INT_TYPE_AI3_INT</span>:
		<span class="k">return</span> <span class="n">interrupt_pcl818_ai_mode13_int</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">INT_TYPE_AI1_FIFO</span>:
	<span class="k">case</span> <span class="n">INT_TYPE_AI3_FIFO</span>:
		<span class="k">return</span> <span class="n">interrupt_pcl818_ai_mode13_fifo</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
<span class="cp">#ifdef PCL818_MODE13_AO</span>
	<span class="k">case</span> <span class="n">INT_TYPE_AO1_INT</span>:
	<span class="k">case</span> <span class="n">INT_TYPE_AO3_INT</span>:
		<span class="k">return</span> <span class="n">interrupt_pcl818_ao_mode13_int</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_free</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad IRQ!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ from unknown source!&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   ANALOG INPUT MODE 1 or 3 DMA , 818 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl818_ai_mode13dma_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mode13dma_int, mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>	<span class="cm">/*  disable dma */</span>
	<span class="n">bytes</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>	<span class="cm">/*  how many */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/*  how many DMA pages we must fiil */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_dma_run</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">%</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* on last dma transfer must be moved */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">next_dma_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI1_DMA</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x87</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>	<span class="cm">/* Pacer+IRQ+DMA */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI3_DMA</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x86</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>	<span class="cm">/* Ext trig+IRQ+DMA */</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="cp">#ifdef unused</span>
<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   ANALOG INPUT MODE 1 or 3 DMA rtc, 818 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl818_ai_mode13dma_rtc</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">pole</span><span class="p">;</span>

	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span> <span class="o">|</span> <span class="n">DMA_AUTOINIT</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_top_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* devpriv-&gt;hwdmasize[0]; */</span>
	<span class="n">pole</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmasamplsize</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pole</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmasamplsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAGIC_DMA_WORD</span><span class="p">;</span>
<span class="cp">#ifdef unused</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_freq</span> <span class="o">=</span> <span class="n">rtc_setfreq_irq</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
	    <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_freq</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">rtc_dropped_irq</span><span class="p">;</span>

	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq_timer</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int818_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI1_DMA_RTC</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x07</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>	<span class="cm">/* Pacer+DMA */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int818_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI3_DMA_RTC</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x06</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>	<span class="cm">/* Ext trig+DMA */</span>
	<span class="p">};</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   ANALOG INPUT MODE 1 or 3, 818 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_ai_cmd_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">divisor1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">divisor2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seglen</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;pcl818_ai_cmd_mode()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ not defined!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  stop pacer */</span>

	<span class="n">seglen</span> <span class="o">=</span> <span class="n">check_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">,</span>
				    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seglen</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">setup_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">,</span>
			   <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">,</span> <span class="n">seglen</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_was_now_closed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_runs_to_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* well, user want neverending */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8253_osc_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor1</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">divisor2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
					  <span class="n">TRIG_ROUND_NEAREST</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divisor1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* PCL718/818 crash if any divisor is set to 1 */</span>
			<span class="n">divisor1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">divisor2</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divisor2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">divisor2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">divisor1</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CNTENABLE</span><span class="p">);</span>	<span class="cm">/* enable pacer */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/*  DMA */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcl818_ai_mode13dma_int</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#ifdef unused</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pcl818_ai_mode13dma_rtc</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usefifo</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* IRQ */</span>
			<span class="cm">/* printk(&quot;IRQ\n&quot;); */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI1_INT</span><span class="p">;</span>
				<span class="cm">/* Pacer+IRQ */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x83</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI3_INT</span><span class="p">;</span>
				<span class="cm">/* Ext trig+IRQ */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x82</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* FIFO */</span>
			<span class="cm">/* enable FIFO */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_ENABLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI1_FIFO</span><span class="p">;</span>
				<span class="cm">/* Pacer */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AI3_FIFO</span><span class="p">;</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">divisor1</span><span class="p">,</span> <span class="n">divisor2</span><span class="p">);</span>

<span class="cp">#ifdef unused</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INT_TYPE_AI1_DMA_RTC</span>:
	<span class="k">case</span> <span class="n">INT_TYPE_AI3_DMA_RTC</span>:
		<span class="n">set_rtc_irq_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* start RTC */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;pcl818_ai_cmd_mode() end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef unused</span>
<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   ANALOG OUTPUT MODE 1 or 3, 818 cards</span>
<span class="cm">*/</span>
<span class="cp">#ifdef PCL818_MODE13_AO</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_ao_mode13</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">comedi_trig</span> <span class="o">*</span> <span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">divisor1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">divisor2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ not defined!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  stop pacer */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int13_act_scan</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int13_act_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_was_now_closed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8253_osc_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor1</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">divisor2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">trigvar</span><span class="p">,</span>
					  <span class="n">TRIG_ROUND_NEAREST</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divisor1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* PCL818 crash if any divisor is set to 1 */</span>
			<span class="n">divisor1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">divisor2</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divisor2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">divisor2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">divisor1</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CNTENABLE</span><span class="p">);</span>	<span class="cm">/* enable pacer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int818_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AO1_INT</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x83</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>	<span class="cm">/* Pacer+IRQ */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int818_mode</span> <span class="o">=</span> <span class="n">INT_TYPE_AO3_INT</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x82</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>	<span class="cm">/* Ext trig+IRQ */</span>
	<span class="p">};</span>

	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">divisor1</span><span class="p">,</span> <span class="n">divisor2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   ANALOG OUTPUT MODE 1, 818 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_ao_mode1</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">comedi_trig</span> <span class="o">*</span> <span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcl818_ao_mode13</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">   ANALOG OUTPUT MODE 3, 818 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_ao_mode3</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">comedi_trig</span> <span class="o">*</span> <span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcl818_ao_mode13</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> Start/stop pacer onboard pacer</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_pacer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xb4</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CTRCTL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x74</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CTRCTL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">divisor2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CTR2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">divisor2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CTR2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">divisor1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CTR1</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">divisor1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CTR1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> Check if channel list from user is builded correctly</span>
<span class="cm"> If it&#39;s ok, then program scan/gain logic</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chansegment</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nowmustbechan</span><span class="p">,</span> <span class="n">seglen</span><span class="p">,</span> <span class="n">segpos</span><span class="p">;</span>

	<span class="cm">/* correct channel and range number check itself comedi/range.c */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_chan</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;range/channel list is empty!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_chan</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  first channel is every time ok */</span>
		<span class="n">chansegment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="cm">/*  build part of chanlist */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seglen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">seglen</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* printk(&quot;%d. %d * %d\n&quot;,i,</span>
<span class="cm">			 * CR_CHAN(it-&gt;chanlist[i]),CR_RANGE(it-&gt;chanlist[i]));*/</span>

			<span class="cm">/* we detect loop, this must by finish */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">nowmustbechan</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nowmustbechan</span> <span class="o">!=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>	<span class="cm">/*  channel list isn&#39;t continuous :-( */</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;comedi%d: pcl818: channel list must be continuous! chanlist[%i]=%d but must be %d or %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				     <span class="n">nowmustbechan</span><span class="p">,</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*  well, this is next correct channel in list */</span>
			<span class="n">chansegment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="cm">/*  check whole chanlist */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">segpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* printk(&quot;%d %d=%d %d\n&quot;,CR_CHAN(chansegment[i%seglen]),CR_RANGE(chansegment[i%seglen]),CR_CHAN(it-&gt;chanlist[i]),CR_RANGE(it-&gt;chanlist[i])); */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">chansegment</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;comedi%d: pcl818: bad channel or range number! chanlist[%i]=%d,%d,%d and not %d,%d,%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				     <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				     <span class="n">CR_AREF</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				     <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">]),</span>
				     <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">]),</span>
				     <span class="n">CR_AREF</span><span class="p">(</span><span class="n">chansegment</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">seglen</span><span class="p">]));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  chan/gain list is strange */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seglen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;check_channel_list: seglen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seglen</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">seglen</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seglen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_len</span> <span class="o">=</span> <span class="n">seglen</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">seglen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  store range list to card */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">muxonechan</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_MUX</span><span class="p">);</span>	<span class="cm">/* select channel */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_RANGE</span><span class="p">);</span>	<span class="cm">/* select gain */</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* select channel interval to scan */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">seglen</span> <span class="o">-</span>
							       <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_MUX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> Check if board is switched to SE (1) or DIFF(0) mode</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_single_ended</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">PCL818_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">divisor1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">divisor2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* step 2: make sure trigger sources are unique and mutually compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ns_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ns_min</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TRIG_EXT */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TRIG_NONE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8253_osc_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor1</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">divisor2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
					  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ns_min</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ns_min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* step 5: complain about special chanlist considerations */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/*  incorrect channels list */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;pcl818_ai_cmd()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_buf</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_timer1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_timer2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  mode 1, 3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  mode 1 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_timer1</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">pcl818_ai_cmd_mode</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;pcl818_ai_cmd() end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  mode 3 */</span>
			<span class="k">return</span> <span class="n">pcl818_ai_cmd_mode</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> cancel any mode 1-4 AI</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;pcl818_ai_cancel()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_was_now_closed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef unused</span>
		<span class="k">case</span> <span class="n">INT_TYPE_AI1_DMA_RTC</span>:
		<span class="k">case</span> <span class="n">INT_TYPE_AI3_DMA_RTC</span>:
			<span class="n">set_rtc_irq_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  stop RTC */</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq_timer</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">INT_TYPE_AI1_DMA</span>:
		<span class="k">case</span> <span class="n">INT_TYPE_AI3_DMA</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span> <span class="o">||</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span> <span class="o">&amp;&amp;</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* wait for running dma transfer to end, do cleanup in interrupt */</span>
				<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">disable_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">INT_TYPE_AI1_INT</span>:
		<span class="k">case</span> <span class="n">INT_TYPE_AI3_INT</span>:
		<span class="k">case</span> <span class="n">INT_TYPE_AI1_FIFO</span>:
		<span class="k">case</span> <span class="n">INT_TYPE_AI3_FIFO</span>:
<span class="cp">#ifdef PCL818_MODE13_AO</span>
		<span class="k">case</span> <span class="n">INT_TYPE_AO1_INT</span>:
		<span class="k">case</span> <span class="n">INT_TYPE_AO3_INT</span>:
<span class="cp">#endif</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x73</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>	<span class="cm">/* Stop A/D */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_AD_LO</span><span class="p">);</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_AD_LO</span><span class="p">);</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_AD_HI</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CLRINT</span><span class="p">);</span>	<span class="cm">/* clear INT request */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>	<span class="cm">/* Stop A/D */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usefifo</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  FIFO shutdown */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_INTCLR</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_FLUSH</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_ENABLE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">last_int_sub</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">neverending_ai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_was_now_closed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">end:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;pcl818_ai_cancel() end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> chech for PCL818</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_MUX</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_MUX</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* there isn&#39;t card */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_MUX</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_MUX</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* there isn&#39;t card */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_MUX</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x18</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* there isn&#39;t card */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/*  ok, card exist */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm"> reset whole PCL-818 cards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl818_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usefifo</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  FIFO shutdown */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_INTCLR</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_FLUSH</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_FI_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_DA_LO</span><span class="p">);</span>	<span class="cm">/*  DAC=0V */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_DA_HI</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_DO_HI</span><span class="p">);</span>	<span class="cm">/*  DO=$0000 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_DO_LO</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CONTROL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CNTENABLE</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_MUX</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CLRINT</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CTRCTL</span><span class="p">);</span>	<span class="cm">/* Stop pacer */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CTRCTL</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_CTRCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">is_818</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL818_RANGE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL718_DA2_LO</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCL718_DA2_HI</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef unused</span>
<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">  Enable(1)/disable(0) periodic interrupts from RTC</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rtc_irq_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTC_timer_lock</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTC_timer_lock</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTC_timer_lock</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTC_timer_lock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">RTC_timer_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTC_timer_lock</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">save_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cli</span><span class="p">();</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">CMOS_READ</span><span class="p">(</span><span class="n">RTC_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">RTC_PIE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTC_PIE</span><span class="p">;</span>

	<span class="n">CMOS_WRITE</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">RTC_CONTROL</span><span class="p">);</span>
	<span class="n">CMOS_READ</span><span class="p">(</span><span class="n">RTC_INTR_FLAGS</span><span class="p">);</span>
	<span class="n">restore_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">  Restart RTC if something stop it (xntpd every 11 mins or large IDE transfers)</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtc_dropped_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int818_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INT_TYPE_AI1_DMA_RTC</span>:
	<span class="k">case</span> <span class="n">INT_TYPE_AI3_DMA_RTC</span>:
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq_timer</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_freq</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
		<span class="n">save_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cli</span><span class="p">();</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">CMOS_READ</span><span class="p">(</span><span class="n">RTC_INTR_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">);</span>	<span class="cm">/* restart */</span>
		<span class="n">restore_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">  Set frequency of interrupts from RTC</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtc_setfreq_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rtc_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tmp</span><span class="p">))</span>
		<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>

	<span class="n">rtc_freq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">save_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cli</span><span class="p">();</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">CMOS_READ</span><span class="p">(</span><span class="n">RTC_FREQ_SELECT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">CMOS_WRITE</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">RTC_FREQ_SELECT</span><span class="p">);</span>
	<span class="n">restore_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rtc_freq</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcl818_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcl818_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>	<span class="cm">/* Can&#39;t alloc mem */</span>

	<span class="cm">/* claim our I/O space */</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span>
	    <span class="p">(</span><span class="s">&quot;comedi%d: pcl818:  board=%s, ioport=0x%03lx&quot;</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_range</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">io_range</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/*  we&#39;ve board with FIFO and we want to use FIFO */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_range</span> <span class="o">=</span> <span class="n">PCLx1xFIFO_RANGE</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usefifo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_range</span><span class="p">,</span> <span class="s">&quot;pcl818&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;I/O port conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcl818_check</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;I can&#39;t detect board. FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up some name stuff */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="cm">/* grab our IRQ */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">IRQbits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* board support IRQ */</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* we want to use IRQ */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">IRQbits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;, IRQ %u is out of allowed range, DISABLING IT&quot;</span><span class="p">,</span>
				     <span class="n">irq</span><span class="p">);</span>
				<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Bad IRQ */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span>
				    <span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">interrupt_pcl818</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pcl818&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;, unable to allocate IRQ %u, DISABLING IT&quot;</span><span class="p">,</span>
					     <span class="n">irq</span><span class="p">);</span>
					<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Can&#39;t use IRQ */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;irq=%u&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* 1=we have allocated irq */</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_blocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* number of subdevice which use IRQ */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* mode of irq */</span>

<span class="cp">#ifdef unused</span>
	<span class="cm">/* grab RTC for DMA operations */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  we want to use DMA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTC_lock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">RTC_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">RTC_IO_EXTENT</span><span class="p">,</span>
					    <span class="s">&quot;pcl818 (RTC)&quot;</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">no_rtc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span> <span class="o">=</span> <span class="n">RTC_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iosize</span> <span class="o">=</span> <span class="n">RTC_IO_EXTENT</span><span class="p">;</span>
		<span class="n">RTC_lock</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_irq</span><span class="p">(</span><span class="n">RTC_IRQ</span><span class="p">,</span> <span class="n">interrupt_pcl818_ai_mode13_dma_rtc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="s">&quot;pcl818 DMA (RTC)&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq</span> <span class="o">=</span> <span class="n">RTC_IRQ</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dma_irq=%u&quot;</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTC_lock</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RTC_lock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span><span class="p">)</span>
					<span class="n">release_region</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span><span class="p">,</span>
						       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iosize</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iosize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">no_rtc:</span>
<span class="cp">#endif</span>
	<span class="cm">/* grab our DMA */</span>
	<span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">irq_free</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_dma</span><span class="p">;</span>	<span class="cm">/* if we haven&#39;t IRQ, we can&#39;t use DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">DMAbits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* board support DMA */</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_dma</span><span class="p">;</span>	<span class="cm">/* DMA disabled */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">DMAbits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DMA is out of allowed range, FAIL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* Bad DMA */</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;pcl818&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* DMA isn&#39;t free */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
		<span class="n">pages</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* we need 16KB */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">__get_dma_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">pages</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="cm">/* maybe experiment with try_to_free_pages() will help .... */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* no buffer :-( */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pages</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="cm">/* printk(&quot;%d %d %ld, &quot;,devpriv-&gt;dmapages[0],devpriv-&gt;hwdmasize[0],PAGE_SIZE); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  we must do duble buff :-( */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">__get_dma_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">pages</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmaptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">hwdmasize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pages</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">no_dma:</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan_se</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">sub_ai</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_single_ended</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan_se</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_COMMON</span> <span class="o">|</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, %dchans S.E. DAC&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan_diff</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, %dchans DIFF DAC&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_maxdata</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_range_type</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">pcl818_ai_cancel</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pcl818_ai_insn_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">irq</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">ai_cmdtest</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">ai_cmd</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">is_818</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">))</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pcl818l_h_ai</span><span class="p">;</span>	<span class="cm">/*  secondary range list jumper selectable */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar10</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar2_5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range718_bipolar1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range718_bipolar0_5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unipolar10</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range718_unipolar2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">9</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range718_unipolar1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ao_maxdata</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ao_range_type</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pcl818_ao_insn_read</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">pcl818_ao_insn_write</span><span class="p">;</span>
<span class="cp">#ifdef unused</span>
<span class="cp">#ifdef PCL818_MODE13_AO</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">trig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcl818_ao_mode1</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">trig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcl818_ao_mode3</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">is_818</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">))</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unipolar10</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">))</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unipolar10</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">pcl818_di_insn_bits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">pcl818_do_insn_bits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* select 1/10MHz oscilator */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8253_osc_base</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8253_osc_base</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/* max sampling speed */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ns_min</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ns_min</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">is_818</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">))</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ns_min</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>	<span class="cm">/* extended PCL718 to 100kHz DAC */</span>
	<span class="p">}</span>

	<span class="n">pcl818_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcl818_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcl818_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">sub_ai</span><span class="p">);</span>
		<span class="n">pcl818_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">free_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">free_pages</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">free_pages</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmapages</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#ifdef unused</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">RTC_lock</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span><span class="p">)</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iobase</span><span class="p">,</span>
					       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtc_iosize</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_rtc</span><span class="p">)</span>
			<span class="n">RTC_lock</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_range</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcl818_board</span> <span class="n">boardtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;pcl818l&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">25000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl818l_l_ai</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span> <span class="n">PCLx1x_RANGE</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">,</span>
	 <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcl818h&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl818h_ai</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span> <span class="n">PCLx1x_RANGE</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">,</span>
	 <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcl818hd&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl818h_ai</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span> <span class="n">PCLx1x_RANGE</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">,</span>
	 <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcl818hg&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl818hg_ai</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span> <span class="n">PCLx1x_RANGE</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">,</span>
	 <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcl818&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl818h_ai</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span> <span class="n">PCLx1x_RANGE</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">,</span>
	 <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcl718&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span> <span class="n">PCLx1x_RANGE</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">,</span>
	 <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/* pcm3718 */</span>
	<span class="p">{</span><span class="s">&quot;pcm3718&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range_pcl818h_ai</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">range_unipolar5</span><span class="p">,</span> <span class="n">PCLx1x_RANGE</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">,</span>
	 <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* XXX ? */</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">pcl818_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;pcl818&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">pcl818_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">pcl818_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">board_name</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">boardtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_names</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">boardtypes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcl818_board</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_driver</span><span class="p">(</span><span class="n">pcl818_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
