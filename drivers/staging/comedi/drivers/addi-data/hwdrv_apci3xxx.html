<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › addi-data › hwdrv_apci3xxx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>hwdrv_apci3xxx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm">@verbatim</span>

<span class="cm">Copyright (C) 2004,2005  ADDI-DATA GmbH for the source code of this module.</span>

<span class="cm">	ADDI-DATA GmbH</span>
<span class="cm">	Dieselstrasse 3</span>
<span class="cm">	D-77833 Ottersweier</span>
<span class="cm">	Tel: +19(0)7223/9493-0</span>
<span class="cm">	Fax: +49(0)7223/9493-92</span>
<span class="cm">	http://www.addi-data.com</span>
<span class="cm">	info@addi-data.com</span>

<span class="cm">This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</span>

<span class="cm">This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</span>

<span class="cm">You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>

<span class="cm">You should also find the complete GPL in the COPYING file accompanying this source code.</span>

<span class="cm">@endverbatim</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | (C) ADDI-DATA GmbH          Dieselstrasse 3      D-77833 Ottersweier  |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Tel : +49 (0) 7223/9493-0     | email    : info@addi-data.com         |</span>
<span class="cm">  | Fax : +49 (0) 7223/9493-92    | Internet : http://www.addi-data.com   |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Project     : APCI-3XXX       | Compiler   : GCC                      |</span>
<span class="cm">  | Module name : hwdrv_apci3xxx.c| Version    : 2.96                     |</span>
<span class="cm">  +-------------------------------+---------------------------------------+</span>
<span class="cm">  | Project manager: S. Weber     | Date       :  15/09/2005              |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Description :APCI3XXX Module.  Hardware abstraction Layer for APCI3XXX|</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  |                             UPDATE&#39;S                                  |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  |   Date   |   Author  |          Description of updates                |</span>
<span class="cm">  +----------+-----------+------------------------------------------------+</span>
<span class="cm">  |          | 		 | 						  |</span>
<span class="cm">  |          |           |						  |</span>
<span class="cm">  +----------+-----------+------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;hwdrv_apci3xxx.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                         ANALOG INPUT FUNCTIONS                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int   i_APCI3XXX_TestConversionStarted                 |</span>
<span class="cm">|                          (struct comedi_device    *dev)                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task                Test if any conversion started                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0 : Conversion not started                             |</span>
<span class="cm">|                     1 : Conversion started                                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_TestConversionStarted</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000UL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80000UL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int   i_APCI3XXX_AnalogInputConfigOperatingMode        |</span>
<span class="cm">|                          (struct comedi_device    *dev,                           |</span>
<span class="cm">|                           struct comedi_subdevice *s,                             |</span>
<span class="cm">|                           struct comedi_insn      *insn,                          |</span>
<span class="cm">|                           unsigned int         *data)                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task           Converting mode and convert time selection                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_SingleDiff  = (unsigned char)  data[1];                       |</span>
<span class="cm">|                     b_TimeBase    = (unsigned char)  data[2]; (0: ns, 1:micros 2:ms)|</span>
<span class="cm">|                    dw_ReloadValue = (unsigned int) data[3];                       |</span>
<span class="cm">|                     ........                                               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :&gt;0 : No error                                           |</span>
<span class="cm">|                    -1 : Single/Diff selection error                        |</span>
<span class="cm">|                    -2 : Convert time base unity selection error            |</span>
<span class="cm">|                    -3 : Convert time value selection error                 |</span>
<span class="cm">|                    -10: Any conversion started                             |</span>
<span class="cm">|                    ....                                                    |</span>
<span class="cm">|                    -100 : Config command error                             |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_AnalogInputConfigOperatingMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
						     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_TimeBase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_SingleDiff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_ReloadValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_TestReloadValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/****************************/</span>
		<span class="cm">/* Get the Singel/Diff flag */</span>
	   <span class="cm">/****************************/</span>

		<span class="n">b_SingleDiff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	   <span class="cm">/****************************/</span>
		<span class="cm">/* Get the time base unitiy */</span>
	   <span class="cm">/****************************/</span>

		<span class="n">b_TimeBase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	   <span class="cm">/*************************************/</span>
		<span class="cm">/* Get the convert time reload value */</span>
	   <span class="cm">/*************************************/</span>

		<span class="n">dw_ReloadValue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	   <span class="cm">/**********************/</span>
		<span class="cm">/* Test the time base */</span>
	   <span class="cm">/**********************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">b_AvailableConvertUnit</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_TimeBase</span><span class="p">))</span> <span class="o">!=</span>
			<span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*******************************/</span>
			<span class="cm">/* Test the convert time value */</span>
	      <span class="cm">/*******************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dw_ReloadValue</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dw_TestReloadValue</span> <span class="o">=</span> <span class="n">dw_ReloadValue</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">b_TimeBase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dw_TestReloadValue</span> <span class="o">=</span>
						<span class="n">dw_TestReloadValue</span> <span class="o">*</span> <span class="mi">1000UL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">b_TimeBase</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dw_TestReloadValue</span> <span class="o">=</span>
						<span class="n">dw_TestReloadValue</span> <span class="o">*</span> <span class="mi">1000000UL</span><span class="p">;</span>
				<span class="p">}</span>

		 <span class="cm">/*******************************/</span>
				<span class="cm">/* Test the convert time value */</span>
		 <span class="cm">/*******************************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dw_TestReloadValue</span> <span class="o">&gt;=</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span>
					<span class="n">ui_MinAcquisitiontimeNs</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">b_SingleDiff</span> <span class="o">==</span> <span class="n">APCI3XXX_SINGLE</span><span class="p">)</span>
						<span class="o">||</span> <span class="p">(</span><span class="n">b_SingleDiff</span> <span class="o">==</span>
							<span class="n">APCI3XXX_DIFF</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">b_SingleDiff</span> <span class="o">==</span> <span class="n">APCI3XXX_SINGLE</span><span class="p">)</span>
						        <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">i_NbrAiChannel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
						    <span class="o">||</span> <span class="p">((</span><span class="n">b_SingleDiff</span> <span class="o">==</span> <span class="n">APCI3XXX_DIFF</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">i_NbrAiChannelDiff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
						    <span class="p">)</span> <span class="p">{</span>
			   <span class="cm">/*******************************/</span>
							<span class="cm">/* Single/Diff selection error */</span>
			   <span class="cm">/*******************************/</span>

							<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Single/Diff selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			   <span class="cm">/**********************************/</span>
							<span class="cm">/* Test if conversion not started */</span>
			   <span class="cm">/**********************************/</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">i_APCI3XXX_TestConversionStarted</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">ui_EocEosConversionTime</span>
									<span class="o">=</span>
									<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
									<span class="n">dw_ReloadValue</span><span class="p">;</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">b_EocEosConversionTimeBase</span>
									<span class="o">=</span>
									<span class="n">b_TimeBase</span><span class="p">;</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">b_SingelDiff</span>
									<span class="o">=</span>
									<span class="n">b_SingleDiff</span><span class="p">;</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">b_AiInitialisation</span>
									<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			      <span class="cm">/*******************************/</span>
								<span class="cm">/* Set the convert timing unit */</span>
			      <span class="cm">/*******************************/</span>

								<span class="n">writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">b_TimeBase</span><span class="p">,</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">36</span><span class="p">);</span>

			      <span class="cm">/**************************/</span>
								<span class="cm">/* Set the convert timing */</span>
			      <span class="cm">/*************************/</span>

								<span class="n">writel</span><span class="p">(</span><span class="n">dw_ReloadValue</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			      <span class="cm">/**************************/</span>
								<span class="cm">/* Any conversion started */</span>
			      <span class="cm">/**************************/</span>

								<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Any conversion started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="n">i_ReturnValue</span> <span class="o">=</span>
									<span class="o">-</span><span class="mi">10</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		       <span class="cm">/*******************************/</span>
						<span class="cm">/* Single/Diff selection error */</span>
		       <span class="cm">/*******************************/</span>

						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Single/Diff selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/************************/</span>
					<span class="cm">/* Time selection error */</span>
		    <span class="cm">/************************/</span>

					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Convert time value selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/************************/</span>
				<span class="cm">/* Time selection error */</span>
		 <span class="cm">/************************/</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Convert time value selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/*****************************/</span>
			<span class="cm">/* Time base selection error */</span>
	      <span class="cm">/*****************************/</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Convert time base unity selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int   i_APCI3XXX_InsnConfigAnalogInput                 |</span>
<span class="cm">|                          (struct comedi_device    *dev,                           |</span>
<span class="cm">|                           struct comedi_subdevice *s,                             |</span>
<span class="cm">|                           struct comedi_insn      *insn,                          |</span>
<span class="cm">|                           unsigned int         *data)                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task           Converting mode and convert time selection                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_ConvertMode = (unsigned char)  data[0];                       |</span>
<span class="cm">|                     b_TimeBase    = (unsigned char)  data[1]; (0: ns, 1:micros 2:ms)|</span>
<span class="cm">|                    dw_ReloadValue = (unsigned int) data[2];                       |</span>
<span class="cm">|                     ........                                               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :&gt;0: No error                                            |</span>
<span class="cm">|                    ....                                                    |</span>
<span class="cm">|                    -100 : Config command error                             |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnConfigAnalogInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">APCI3XXX_CONFIGURATION</span>:
			<span class="n">i_ReturnValue</span> <span class="o">=</span>
				<span class="n">i_APCI3XXX_AnalogInputConfigOperatingMode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">s</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Config command error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int   i_APCI3XXX_InsnReadAnalogInput                   |</span>
<span class="cm">|                          (struct comedi_device    *dev,                           |</span>
<span class="cm">|                           struct comedi_subdevice *s,                             |</span>
<span class="cm">|                           struct comedi_insn      *insn,                          |</span>
<span class="cm">|                           unsigned int         *data)                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task                Read 1 analog input                                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_Range             = CR_RANGE(insn-&gt;chanspec);        |</span>
<span class="cm">|                     b_Channel           = CR_CHAN(insn-&gt;chanspec);         |</span>
<span class="cm">|                     dw_NbrOfAcquisition = insn-&gt;n;                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :&gt;0: No error                                            |</span>
<span class="cm">|                    -3 : Channel selection error                            |</span>
<span class="cm">|                    -4 : Configuration selelection error                    |</span>
<span class="cm">|                    -10: Any conversion started                             |</span>
<span class="cm">|                    ....                                                    |</span>
<span class="cm">|                    -100 : Config command error                             |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnReadAnalogInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Configuration</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Channel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Configuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_AcquisitionCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Interrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*************************************/</span>
	<span class="cm">/* Test if operating mode configured */</span>
	<span class="cm">/*************************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiInitialisation</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***************************/</span>
		<span class="cm">/* Test the channel number */</span>
	   <span class="cm">/***************************/</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">i_NbrAiChannel</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_SingelDiff</span> <span class="o">==</span> <span class="n">APCI3XXX_SINGLE</span><span class="p">))</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">i_NbrAiChannelDiff</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_SingelDiff</span> <span class="o">==</span> <span class="n">APCI3XXX_DIFF</span><span class="p">)))</span> <span class="p">{</span>
	      <span class="cm">/**********************************/</span>
			<span class="cm">/* Test the channel configuration */</span>
	      <span class="cm">/**********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_Configuration</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/***************************/</span>
				<span class="cm">/* Channel not initialised */</span>
		 <span class="cm">/***************************/</span>

				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel %d range %d selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">b_Channel</span><span class="p">,</span> <span class="n">b_Configuration</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/***************************/</span>
			<span class="cm">/* Channel selection error */</span>
	      <span class="cm">/***************************/</span>

			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel %d selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b_Channel</span><span class="p">);</span>
		<span class="p">}</span>

	   <span class="cm">/**************************/</span>
		<span class="cm">/* Test if no error occur */</span>
	   <span class="cm">/**************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/************************/</span>
			<span class="cm">/* Test the buffer size */</span>
	      <span class="cm">/************************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">b_Interrupt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_Interrupt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		 <span class="cm">/**********************************/</span>
				<span class="cm">/* Test if conversion not started */</span>
		 <span class="cm">/**********************************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i_APCI3XXX_TestConversionStarted</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/******************/</span>
					<span class="cm">/* Clear the FIFO */</span>
		    <span class="cm">/******************/</span>

					<span class="n">writel</span><span class="p">(</span><span class="mh">0x10000UL</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

		    <span class="cm">/*******************************/</span>
					<span class="cm">/* Get and save the delay mode */</span>
		    <span class="cm">/*******************************/</span>

					<span class="n">dw_Temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
					<span class="n">dw_Temp</span> <span class="o">=</span> <span class="n">dw_Temp</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFEF0UL</span><span class="p">;</span>

		    <span class="cm">/***********************************/</span>
					<span class="cm">/* Channel configuration selection */</span>
		    <span class="cm">/***********************************/</span>

					<span class="n">writel</span><span class="p">(</span><span class="n">dw_Temp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

		    <span class="cm">/**************************/</span>
					<span class="cm">/* Make the configuration */</span>
		    <span class="cm">/**************************/</span>

					<span class="n">dw_Configuration</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">b_Configuration</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">b_Configuration</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span>
						<span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">b_SingelDiff</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>

		    <span class="cm">/***************************/</span>
					<span class="cm">/* Write the configuration */</span>
		    <span class="cm">/***************************/</span>

					<span class="n">writel</span><span class="p">(</span><span class="n">dw_Configuration</span><span class="p">,</span>
					       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>

		    <span class="cm">/*********************/</span>
					<span class="cm">/* Channel selection */</span>
		    <span class="cm">/*********************/</span>

					<span class="n">writel</span><span class="p">(</span><span class="n">dw_Temp</span> <span class="o">|</span> <span class="mh">0x100UL</span><span class="p">,</span>
					       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
					<span class="n">writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">b_Channel</span><span class="p">,</span>
					       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>

		    <span class="cm">/***********************/</span>
					<span class="cm">/* Restaure delay mode */</span>
		    <span class="cm">/***********************/</span>

					<span class="n">writel</span><span class="p">(</span><span class="n">dw_Temp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

		    <span class="cm">/***********************************/</span>
					<span class="cm">/* Set the number of sequence to 1 */</span>
		    <span class="cm">/***********************************/</span>

					<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>

		    <span class="cm">/***************************/</span>
					<span class="cm">/* Save the interrupt flag */</span>
		    <span class="cm">/***************************/</span>

					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span>
						<span class="n">b_Interrupt</span><span class="p">;</span>

		    <span class="cm">/*******************************/</span>
					<span class="cm">/* Save the number of channels */</span>
		    <span class="cm">/*******************************/</span>

					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		    <span class="cm">/******************************/</span>
					<span class="cm">/* Test if interrupt not used */</span>
		    <span class="cm">/******************************/</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">b_Interrupt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">dw_AcquisitionCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">dw_AcquisitionCpt</span> <span class="o">&lt;</span>
							<span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
							<span class="n">dw_AcquisitionCpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			  <span class="cm">/************************/</span>
							<span class="cm">/* Start the conversion */</span>
			  <span class="cm">/************************/</span>

							<span class="n">writel</span><span class="p">(</span><span class="mh">0x80000UL</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

			  <span class="cm">/****************/</span>
							<span class="cm">/* Wait the EOS */</span>
			  <span class="cm">/****************/</span>

							<span class="k">do</span> <span class="p">{</span>
								<span class="n">dw_Temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
								<span class="n">dw_Temp</span> <span class="o">=</span> <span class="n">dw_Temp</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dw_Temp</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>

			  <span class="cm">/*************************/</span>
							<span class="cm">/* Read the analog value */</span>
			  <span class="cm">/*************************/</span>

							<span class="n">data</span><span class="p">[</span><span class="n">dw_AcquisitionCpt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">28</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		       <span class="cm">/************************/</span>
						<span class="cm">/* Start the conversion */</span>
		       <span class="cm">/************************/</span>

						<span class="n">writel</span><span class="p">(</span><span class="mh">0x180000UL</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/**************************/</span>
					<span class="cm">/* Any conversion started */</span>
		    <span class="cm">/**************************/</span>

					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Any conversion started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*******************/</span>
				<span class="cm">/* Data size error */</span>
		 <span class="cm">/*******************/</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***************************/</span>
		<span class="cm">/* Channel selection error */</span>
	   <span class="cm">/***************************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Operating mode not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     : void v_APCI3XXX_Interrupt (int            irq,         |</span>
<span class="cm">|                                                void           *d)       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              :Interrupt handler for APCI3XXX                          |</span>
<span class="cm">|                    When interrupt occurs this gets called.                 |</span>
<span class="cm">|                    First it finds which interrupt has been generated and   |</span>
<span class="cm">|                    handles  corresponding interrupt                        |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">v_APCI3XXX_Interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_CopyCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/***************************/</span>
	<span class="cm">/* Test if interrupt occur */</span>
	<span class="cm">/***************************/</span>

	<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mh">0x2UL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x2UL</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Reset the interrupt */</span>
	   <span class="cm">/***********************/</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">dw_Status</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>

	   <span class="cm">/*****************************/</span>
		<span class="cm">/* Test if interrupt enabled */</span>
	   <span class="cm">/*****************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/********************************/</span>
			<span class="cm">/* Read all analog inputs value */</span>
	      <span class="cm">/********************************/</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">b_CopyCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">b_CopyCpt</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span><span class="p">;</span>
				<span class="n">b_CopyCpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiReadData</span><span class="p">[</span><span class="n">b_CopyCpt</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">28</span><span class="p">);</span>
			<span class="p">}</span>

	      <span class="cm">/**************************/</span>
			<span class="cm">/* Set the interrupt flag */</span>
	      <span class="cm">/**************************/</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	      <span class="cm">/**********************************************/</span>
			<span class="cm">/* Send a signal to from kernel to user space */</span>
	      <span class="cm">/**********************************************/</span>

			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGIO</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                            ANALOG OUTPUT SUBDEVICE                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int   i_APCI3XXX_InsnWriteAnalogOutput                 |</span>
<span class="cm">|                          (struct comedi_device    *dev,                           |</span>
<span class="cm">|                           struct comedi_subdevice *s,                             |</span>
<span class="cm">|                           struct comedi_insn      *insn,                          |</span>
<span class="cm">|                           unsigned int         *data)                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task                Read 1 analog input                                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_Range    = CR_RANGE(insn-&gt;chanspec);                 |</span>
<span class="cm">|                     b_Channel  = CR_CHAN(insn-&gt;chanspec);                  |</span>
<span class="cm">|                     data[0]    = analog value;                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :&gt;0: No error                                            |</span>
<span class="cm">|                    -3 : Channel selection error                            |</span>
<span class="cm">|                    -4 : Configuration selelection error                    |</span>
<span class="cm">|                    ....                                                    |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnWriteAnalogOutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Range</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Channel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***************************/</span>
		<span class="cm">/* Test the channel number */</span>
	   <span class="cm">/***************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">i_NbrAoChannel</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/**********************************/</span>
			<span class="cm">/* Test the channel configuration */</span>
	      <span class="cm">/**********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_Range</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/***************************/</span>
				<span class="cm">/* Set the range selection */</span>
		 <span class="cm">/***************************/</span>

				<span class="n">writel</span><span class="p">(</span><span class="n">b_Range</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">96</span><span class="p">);</span>

		 <span class="cm">/**************************************************/</span>
				<span class="cm">/* Write the analog value to the selected channel */</span>
		 <span class="cm">/**************************************************/</span>

				<span class="n">writel</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">b_Channel</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">100</span><span class="p">);</span>

		 <span class="cm">/****************************/</span>
				<span class="cm">/* Wait the end of transfer */</span>
		 <span class="cm">/****************************/</span>

				<span class="k">do</span> <span class="p">{</span>
					<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">96</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x100</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/***************************/</span>
				<span class="cm">/* Channel not initialised */</span>
		 <span class="cm">/***************************/</span>

				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel %d range %d selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">b_Channel</span><span class="p">,</span> <span class="n">b_Range</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/***************************/</span>
			<span class="cm">/* Channel selection error */</span>
	      <span class="cm">/***************************/</span>

			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel %d selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b_Channel</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                              TTL FUNCTIONS                                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int   i_APCI3XXX_InsnConfigInitTTLIO                   |</span>
<span class="cm">|                          (struct comedi_device    *dev,                           |</span>
<span class="cm">|                           struct comedi_subdevice *s,                             |</span>
<span class="cm">|                           struct comedi_insn      *insn,                          |</span>
<span class="cm">|                           unsigned int         *data)                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task           You must calling this function be                           |</span>
<span class="cm">|                for you call any other function witch access of TTL.        |</span>
<span class="cm">|                APCI3XXX_TTL_INIT_DIRECTION_PORT2(user inputs for direction)|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_InitType    = (unsigned char) data[0];                        |</span>
<span class="cm">|                     b_Port2Mode   = (unsigned char) data[1];                        |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :&gt;0: No error                                            |</span>
<span class="cm">|                    -1: Port 2 mode selection is wrong                      |</span>
<span class="cm">|                    ....                                                    |</span>
<span class="cm">|                    -100 : Config command error                             |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnConfigInitTTLIO</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Get the command */</span>
		<span class="cm">/* **************** */</span>

		<span class="n">b_Command</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	   <span class="cm">/********************/</span>
		<span class="cm">/* Test the command */</span>
	   <span class="cm">/********************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b_Command</span> <span class="o">==</span> <span class="n">APCI3XXX_TTL_INIT_DIRECTION_PORT2</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/***************************************/</span>
			<span class="cm">/* Test the initialisation buffer size */</span>
	      <span class="cm">/***************************************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">b_Command</span> <span class="o">==</span> <span class="n">APCI3XXX_TTL_INIT_DIRECTION_PORT2</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		 <span class="cm">/*******************/</span>
				<span class="cm">/* Data size error */</span>
		 <span class="cm">/*******************/</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/************************/</span>
			<span class="cm">/* Config command error */</span>
	      <span class="cm">/************************/</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Command selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*********************************************************************************/</span>
	<span class="cm">/* Test if no error occur and APCI3XXX_TTL_INIT_DIRECTION_PORT2 command selected */</span>
	<span class="cm">/*********************************************************************************/</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_Command</span> <span class="o">==</span> <span class="n">APCI3XXX_TTL_INIT_DIRECTION_PORT2</span><span class="p">))</span> <span class="p">{</span>
	   <span class="cm">/**********************/</span>
		<span class="cm">/* Test the direction */</span>
	   <span class="cm">/**********************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
	      <span class="cm">/**************************/</span>
			<span class="cm">/* Save the configuration */</span>
	      <span class="cm">/**************************/</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_TTLPortConfiguration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_TTLPortConfiguration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/************************/</span>
			<span class="cm">/* Port direction error */</span>
	      <span class="cm">/************************/</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 2 direction selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test if no error occur */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***********************************/</span>
		<span class="cm">/* Test if TTL port initilaisation */</span>
	   <span class="cm">/***********************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b_Command</span> <span class="o">==</span> <span class="n">APCI3XXX_TTL_INIT_DIRECTION_PORT2</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*************************/</span>
			<span class="cm">/* Set the configuration */</span>
	      <span class="cm">/*************************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">224</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                        TTL INPUT FUNCTIONS                                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int     i_APCI3XXX_InsnBitsTTLIO                       |</span>
<span class="cm">|                          (struct comedi_device    *dev,                           |</span>
<span class="cm">|                           struct comedi_subdevice *s,                             |</span>
<span class="cm">|                           struct comedi_insn      *insn,                          |</span>
<span class="cm">|                           unsigned int         *data)                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Write the selected output mask and read the status from|</span>
<span class="cm">|                     all TTL channles                                       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : dw_ChannelMask = data [0];                             |</span>
<span class="cm">|                     dw_BitMask     = data [1];                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : data[1] : All TTL channles states                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : &gt;0  : No error                                         |</span>
<span class="cm">|                    -4   : Channel mask error                               |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnBitsTTLIO</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ChannelCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_ChannelMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_BitMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Get the channe and bit mask */</span>
	   <span class="cm">/*******************************/</span>

		<span class="n">dw_ChannelMask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">dw_BitMask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	   <span class="cm">/*************************/</span>
		<span class="cm">/* Test the channel mask */</span>
	   <span class="cm">/*************************/</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">dw_ChannelMask</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">XFF00FF00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_TTLPortConfiguration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_TTLPortConfiguration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span>
							<span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dw_ChannelMask</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">XFF0000</span><span class="p">)</span> <span class="o">==</span>
						<span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
	      <span class="cm">/*********************************/</span>
			<span class="cm">/* Test if set/reset any channel */</span>
	      <span class="cm">/*********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dw_ChannelMask</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/****************************************/</span>
				<span class="cm">/* Test if set/rest any port 0 channels */</span>
		 <span class="cm">/****************************************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dw_ChannelMask</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/*******************************************/</span>
					<span class="cm">/* Read port 0 (first digital output port) */</span>
		    <span class="cm">/*******************************************/</span>

					<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">80</span><span class="p">);</span>

					<span class="k">for</span> <span class="p">(</span><span class="n">b_ChannelCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b_ChannelCpt</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span>
						<span class="n">b_ChannelCpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">dw_ChannelMask</span> <span class="o">&gt;&gt;</span>
								<span class="n">b_ChannelCpt</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">dw_Status</span> <span class="o">=</span>
								<span class="p">(</span><span class="n">dw_Status</span> <span class="o">&amp;</span>
								<span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_ChannelCpt</span><span class="p">)))</span> <span class="o">|</span> <span class="p">(</span><span class="n">dw_BitMask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_ChannelCpt</span><span class="p">));</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">outl</span><span class="p">(</span><span class="n">dw_Status</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">80</span><span class="p">);</span>
				<span class="p">}</span>

		 <span class="cm">/****************************************/</span>
				<span class="cm">/* Test if set/rest any port 2 channels */</span>
		 <span class="cm">/****************************************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dw_ChannelMask</span> <span class="o">&amp;</span> <span class="mh">0xFF0000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dw_BitMask</span> <span class="o">=</span> <span class="n">dw_BitMask</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">dw_ChannelMask</span> <span class="o">=</span> <span class="n">dw_ChannelMask</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		    <span class="cm">/********************************************/</span>
					<span class="cm">/* Read port 2 (second digital output port) */</span>
		    <span class="cm">/********************************************/</span>

					<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">112</span><span class="p">);</span>

					<span class="k">for</span> <span class="p">(</span><span class="n">b_ChannelCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b_ChannelCpt</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span>
						<span class="n">b_ChannelCpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">dw_ChannelMask</span> <span class="o">&gt;&gt;</span>
								<span class="n">b_ChannelCpt</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">dw_Status</span> <span class="o">=</span>
								<span class="p">(</span><span class="n">dw_Status</span> <span class="o">&amp;</span>
								<span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_ChannelCpt</span><span class="p">)))</span> <span class="o">|</span> <span class="p">(</span><span class="n">dw_BitMask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_ChannelCpt</span><span class="p">));</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">outl</span><span class="p">(</span><span class="n">dw_Status</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">112</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

	      <span class="cm">/*******************************************/</span>
			<span class="cm">/* Read port 0 (first digital output port) */</span>
	      <span class="cm">/*******************************************/</span>

			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">80</span><span class="p">);</span>

	      <span class="cm">/******************************************/</span>
			<span class="cm">/* Read port 1 (first digital input port) */</span>
	      <span class="cm">/******************************************/</span>

			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	      <span class="cm">/************************/</span>
			<span class="cm">/* Test if port 2 input */</span>
	      <span class="cm">/************************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_TTLPortConfiguration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="mi">96</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="mi">112</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/************************/</span>
			<span class="cm">/* Config command error */</span>
	      <span class="cm">/************************/</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel mask error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int i_APCI3XXX_InsnReadTTLIO                           |</span>
<span class="cm">|                          (struct comedi_device    *dev,                           |</span>
<span class="cm">|                           struct comedi_subdevice *s,                             |</span>
<span class="cm">|                           struct comedi_insn      *insn,                          |</span>
<span class="cm">|                           unsigned int         *data)                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Read the status from selected channel                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_Channel = CR_CHAN(insn-&gt;chanspec)                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : data[0] : Selected TTL channel state                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0   : No error                                         |</span>
<span class="cm">|                    -3   : Channel selection error                          |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnReadTTLIO</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Channel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pls_ReadData</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Test if read port 0 */</span>
	   <span class="cm">/***********************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*******************************************/</span>
			<span class="cm">/* Read port 0 (first digital output port) */</span>
	      <span class="cm">/*******************************************/</span>

			<span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">80</span><span class="p">);</span>
			<span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">b_Channel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/***********************/</span>
			<span class="cm">/* Test if read port 1 */</span>
	      <span class="cm">/***********************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">b_Channel</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		 <span class="cm">/******************************************/</span>
				<span class="cm">/* Read port 1 (first digital input port) */</span>
		 <span class="cm">/******************************************/</span>

				<span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">64</span><span class="p">);</span>
				<span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">-</span>
						<span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/***********************/</span>
				<span class="cm">/* Test if read port 2 */</span>
		 <span class="cm">/***********************/</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">b_Channel</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
		    <span class="cm">/************************/</span>
					<span class="cm">/* Test if port 2 input */</span>
		    <span class="cm">/************************/</span>

					<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_TTLPortConfiguration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
							<span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
							<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
							<span class="mi">96</span><span class="p">);</span>
						<span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
							<span class="p">(</span><span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>
							<span class="p">(</span><span class="n">b_Channel</span> <span class="o">-</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
							<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
							<span class="mi">112</span><span class="p">);</span>
						<span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
							<span class="p">(</span><span class="n">pls_ReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>
							<span class="p">(</span><span class="n">b_Channel</span> <span class="o">-</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/***************************/</span>
					<span class="cm">/* Channel selection error */</span>
		    <span class="cm">/***************************/</span>

					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel %d selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">b_Channel</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                        TTL OUTPUT FUNCTIONS                                |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int     i_APCI3XXX_InsnWriteTTLIO                      |</span>
<span class="cm">|                          (struct comedi_device    *dev,                           |</span>
<span class="cm">|                           struct comedi_subdevice *s,                             |</span>
<span class="cm">|                           struct comedi_insn      *insn,                          |</span>
<span class="cm">|                           unsigned int         *data)                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Set the state from TTL output channel                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_Channel = CR_CHAN(insn-&gt;chanspec)                    |</span>
<span class="cm">|                     b_State   = data [0]                                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0   : No error                                         |</span>
<span class="cm">|                    -3   : Channel selection error                          |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnWriteTTLIO</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Channel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_State</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b_State</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	   <span class="cm">/***********************/</span>
		<span class="cm">/* Test if read port 0 */</span>
	   <span class="cm">/***********************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*****************************************************************************/</span>
			<span class="cm">/* Read port 0 (first digital output port) and set/reset the selected channel */</span>
	      <span class="cm">/*****************************************************************************/</span>

			<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">80</span><span class="p">);</span>
			<span class="n">dw_Status</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span>
					<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_Channel</span><span class="p">)))</span> <span class="o">|</span> <span class="p">((</span><span class="n">b_State</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">b_Channel</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">dw_Status</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">80</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/***********************/</span>
			<span class="cm">/* Test if read port 2 */</span>
	      <span class="cm">/***********************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">b_Channel</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
		 <span class="cm">/*************************/</span>
				<span class="cm">/* Test if port 2 output */</span>
		 <span class="cm">/*************************/</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_TTLPortConfiguration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
					<span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/*****************************************************************************/</span>
					<span class="cm">/* Read port 2 (first digital output port) and set/reset the selected channel */</span>
		    <span class="cm">/*****************************************************************************/</span>

					<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">112</span><span class="p">);</span>
					<span class="n">dw_Status</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">-</span>
									<span class="mi">16</span><span class="p">))))</span> <span class="o">|</span>
						<span class="p">((</span><span class="n">b_State</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">-</span>
							<span class="mi">16</span><span class="p">));</span>
					<span class="n">outl</span><span class="p">(</span><span class="n">dw_Status</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">112</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/***************************/</span>
					<span class="cm">/* Channel selection error */</span>
		    <span class="cm">/***************************/</span>

					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel %d selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">b_Channel</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/***************************/</span>
				<span class="cm">/* Channel selection error */</span>
		 <span class="cm">/***************************/</span>

				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel %d selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">b_Channel</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                           DIGITAL INPUT SUBDEVICE                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3XXX_InsnReadDigitalInput                     |</span>
<span class="cm">|                                          (struct comedi_device *dev,              |</span>
<span class="cm">|                                           struct comedi_subdevice *s,             |</span>
<span class="cm">|                                           struct comedi_insn *insn,               |</span>
<span class="cm">|                                           unsigned int *data)                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Reads the value of the specified Digital input channel |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_Channel = CR_CHAN(insn-&gt;chanspec) (0 to 3)           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : data[0] : Channel value                                |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0   : No error                                         |</span>
<span class="cm">|                    -3   : Channel selection error                          |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnReadDigitalInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Channel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/***************************/</span>
	<span class="cm">/* Test the channel number */</span>
	<span class="cm">/***************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">&lt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">i_NbrDiChannel</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/************************/</span>
		<span class="cm">/* Test the buffer size */</span>
	   <span class="cm">/************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dw_Temp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dw_Temp</span> <span class="o">&gt;&gt;</span> <span class="n">b_Channel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/*******************/</span>
			<span class="cm">/* Data size error */</span>
	      <span class="cm">/*******************/</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***************************/</span>
		<span class="cm">/* Channel selection error */</span>
	   <span class="cm">/***************************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3XXX_InsnBitsDigitalInput                     |</span>
<span class="cm">|                                          (struct comedi_device *dev,              |</span>
<span class="cm">|                                           struct comedi_subdevice *s,             |</span>
<span class="cm">|                                           struct comedi_insn *insn,               |</span>
<span class="cm">|                                           unsigned int *data)                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Reads the value of the Digital input Port i.e.4channels|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : data[0] : Port value                                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :&gt;0: No error                                            |</span>
<span class="cm">|                    ....                                                    |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnBitsDigitalInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw_Temp</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dw_Temp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                           DIGITAL OUTPUT SUBDEVICE                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>

<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3XXX_InsnBitsDigitalOutput                    |</span>
<span class="cm">|                                          (struct comedi_device *dev,              |</span>
<span class="cm">|                                           struct comedi_subdevice *s,             |</span>
<span class="cm">|                                           struct comedi_insn *insn,               |</span>
<span class="cm">|                                           unsigned int *data)                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Write the selected output mask and read the status from|</span>
<span class="cm">|                     all digital output channles                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : dw_ChannelMask = data [0];                             |</span>
<span class="cm">|                     dw_BitMask     = data [1];                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : data[1] : All digital output channles states           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : &gt;0  : No error                                         |</span>
<span class="cm">|                    -4   : Channel mask error                               |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnBitsDigitalOutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ChannelCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_ChannelMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_BitMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Get the channe and bit mask */</span>
	   <span class="cm">/*******************************/</span>

		<span class="n">dw_ChannelMask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">dw_BitMask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	   <span class="cm">/*************************/</span>
		<span class="cm">/* Test the channel mask */</span>
	   <span class="cm">/*************************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dw_ChannelMask</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">XFFFFFFF0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*********************************/</span>
			<span class="cm">/* Test if set/reset any channel */</span>
	      <span class="cm">/*********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dw_ChannelMask</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/********************************/</span>
				<span class="cm">/* Read the digital output port */</span>
		 <span class="cm">/********************************/</span>

				<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">b_ChannelCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b_ChannelCpt</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">b_ChannelCpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">dw_ChannelMask</span> <span class="o">&gt;&gt;</span> <span class="n">b_ChannelCpt</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dw_Status</span> <span class="o">=</span>
							<span class="p">(</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xF</span> <span class="o">-</span>
								<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_ChannelCpt</span><span class="p">)))</span> <span class="o">|</span> <span class="p">(</span><span class="n">dw_BitMask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_ChannelCpt</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">outl</span><span class="p">(</span><span class="n">dw_Status</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>
			<span class="p">}</span>

	      <span class="cm">/********************************/</span>
			<span class="cm">/* Read the digital output port */</span>
	      <span class="cm">/********************************/</span>

			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/************************/</span>
			<span class="cm">/* Config command error */</span>
	      <span class="cm">/************************/</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel mask error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3XXX_InsnWriteDigitalOutput                   |</span>
<span class="cm">|                                          (struct comedi_device *dev,              |</span>
<span class="cm">|                                           struct comedi_subdevice *s,             |</span>
<span class="cm">|                                           struct comedi_insn *insn,               |</span>
<span class="cm">|                                           unsigned int *data)                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Set the state from digital output channel              |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_Channel = CR_CHAN(insn-&gt;chanspec)                    |</span>
<span class="cm">|                     b_State   = data [0]                                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : &gt;0  : No error                                         |</span>
<span class="cm">|                    -3   : Channel selection error                          |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnWriteDigitalOutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_State</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***************************/</span>
		<span class="cm">/* Test the channel number */</span>
	   <span class="cm">/***************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">i_NbrDoChannel</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*******************/</span>
			<span class="cm">/* Get the command */</span>
	      <span class="cm">/*******************/</span>

			<span class="n">b_State</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	      <span class="cm">/********************************/</span>
			<span class="cm">/* Read the digital output port */</span>
	      <span class="cm">/********************************/</span>

			<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>

			<span class="n">dw_Status</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xF</span> <span class="o">-</span>
					<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_Channel</span><span class="p">)))</span> <span class="o">|</span> <span class="p">((</span><span class="n">b_State</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">b_Channel</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">dw_Status</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/***************************/</span>
			<span class="cm">/* Channel selection error */</span>
	      <span class="cm">/***************************/</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3XXX_InsnReadDigitalOutput                    |</span>
<span class="cm">|                                          (struct comedi_device *dev,              |</span>
<span class="cm">|                                           struct comedi_subdevice *s,             |</span>
<span class="cm">|                                           struct comedi_insn *insn,               |</span>
<span class="cm">|                                           unsigned int *data)                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Read the state from digital output channel             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : b_Channel = CR_CHAN(insn-&gt;chanspec)                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : b_State   = data [0]                                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : &gt;0  : No error                                         |</span>
<span class="cm">|                    -3   : Channel selection error                          |</span>
<span class="cm">|                    -101 : Data size error                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_InsnReadDigitalOutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Test the buffer size */</span>
	<span class="cm">/************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***************************/</span>
		<span class="cm">/* Test the channel number */</span>
	   <span class="cm">/***************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b_Channel</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">i_NbrDoChannel</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/********************************/</span>
			<span class="cm">/* Read the digital output port */</span>
	      <span class="cm">/********************************/</span>

			<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>

			<span class="n">dw_Status</span> <span class="o">=</span> <span class="p">(</span><span class="n">dw_Status</span> <span class="o">&gt;&gt;</span> <span class="n">b_Channel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dw_Status</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/***************************/</span>
			<span class="cm">/* Channel selection error */</span>
	      <span class="cm">/***************************/</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel selection error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*******************/</span>
		<span class="cm">/* Data size error */</span>
	   <span class="cm">/*******************/</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Buffer size error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function   Name   : int i_APCI3XXX_Reset(struct comedi_device *dev)               |                                                         +----------------------------------------------------------------------------+</span>
<span class="cm">| Task              :resets all the registers                                |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev                                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i_APCI3XXX_Reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Cpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*************************/</span>
	<span class="cm">/* Disable the interrupt */</span>
	<span class="cm">/*************************/</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/****************************/</span>
	<span class="cm">/* Reset the interrupt flag */</span>
	<span class="cm">/****************************/</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/***************************/</span>
	<span class="cm">/* Clear the start command */</span>
	<span class="cm">/***************************/</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/*****************************/</span>
	<span class="cm">/* Reset the interrupt flags */</span>
	<span class="cm">/*****************************/</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">16</span><span class="p">),</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/*****************/</span>
	<span class="cm">/* clear the EOS */</span>
	<span class="cm">/*****************/</span>

	<span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>

	<span class="cm">/******************/</span>
	<span class="cm">/* Clear the FIFO */</span>
	<span class="cm">/******************/</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">b_Cpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b_Cpt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">b_Cpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dw_AiBase</span> <span class="o">+</span> <span class="mi">28</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/************************/</span>
	<span class="cm">/* Enable the interrupt */</span>
	<span class="cm">/************************/</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
