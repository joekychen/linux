<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › addi-data › addi_amcc_s5933.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>addi_amcc_s5933.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 2004,2005  ADDI-DATA GmbH for the source code of this module.</span>
<span class="cm"> *</span>
<span class="cm"> *	ADDI-DATA GmbH</span>
<span class="cm"> *	Dieselstrasse 3</span>
<span class="cm"> *	D-77833 Ottersweier</span>
<span class="cm"> *	Tel: +19(0)7223/9493-0</span>
<span class="cm"> *	Fax: +49(0)7223/9493-92</span>
<span class="cm"> *	http://www.addi-data.com</span>
<span class="cm"> *	info@addi-data.com</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> */</span>

<span class="cm">/* Header file for AMCC  s 5933 */</span>

<span class="cp">#ifndef _AMCC_S5933_H_</span>
<span class="cp">#define _AMCC_S5933_H_</span>

<span class="cp">#include &quot;../../comedidev.h&quot;</span>

<span class="cp">#include &quot;../comedi_pci.h&quot;</span>

<span class="cp">#ifdef PCI_SUPPORT_VER1</span>
<span class="cp">#error     No support for 2.1.55 and older</span>
<span class="cp">#endif</span>

<span class="cm">/* written on base0 */</span>
<span class="cp">#define FIFO_ADVANCE_ON_BYTE_2	0x20000000</span>

<span class="cm">/* added for step 6 dma written on base2 */</span>
<span class="cp">#define AMWEN_ENABLE		0x02</span>

<span class="cp">#define A2P_FIFO_WRITE_ENABLE	0x01</span>

<span class="cm">/* for transfer count enable bit */</span>
<span class="cp">#define AGCSTS_TC_ENABLE	0x10000000</span>

<span class="cm">/*</span>
<span class="cm"> * ADDON RELATED ADDITIONS</span>
<span class="cm"> */</span>
<span class="cm">/* Constant */</span>
<span class="cp">#define APCI3120_ENABLE_TRANSFER_ADD_ON_LOW		0x00</span>
<span class="cp">#define APCI3120_ENABLE_TRANSFER_ADD_ON_HIGH		0x1200</span>
<span class="cp">#define APCI3120_A2P_FIFO_MANAGEMENT			0x04000400L</span>
<span class="cp">#define APCI3120_AMWEN_ENABLE				0x02</span>
<span class="cp">#define APCI3120_A2P_FIFO_WRITE_ENABLE			0x01</span>
<span class="cp">#define APCI3120_FIFO_ADVANCE_ON_BYTE_2			0x20000000L</span>
<span class="cp">#define APCI3120_ENABLE_WRITE_TC_INT			0x00004000L</span>
<span class="cp">#define APCI3120_CLEAR_WRITE_TC_INT			0x00040000L</span>
<span class="cp">#define APCI3120_DISABLE_AMWEN_AND_A2P_FIFO_WRITE	0x0</span>
<span class="cp">#define APCI3120_DISABLE_BUS_MASTER_ADD_ON		0x0</span>
<span class="cp">#define APCI3120_DISABLE_BUS_MASTER_PCI			0x0</span>

<span class="cm">/* ADD_ON ::: this needed since apci supports 16 bit interface to add on */</span>
<span class="cp">#define APCI3120_ADD_ON_AGCSTS_LOW	0x3C</span>
<span class="cp">#define APCI3120_ADD_ON_AGCSTS_HIGH	(APCI3120_ADD_ON_AGCSTS_LOW + 2)</span>
<span class="cp">#define APCI3120_ADD_ON_MWAR_LOW	0x24</span>
<span class="cp">#define APCI3120_ADD_ON_MWAR_HIGH	(APCI3120_ADD_ON_MWAR_LOW + 2)</span>
<span class="cp">#define APCI3120_ADD_ON_MWTC_LOW	0x058</span>
<span class="cp">#define APCI3120_ADD_ON_MWTC_HIGH	(APCI3120_ADD_ON_MWTC_LOW + 2)</span>

<span class="cm">/* AMCC */</span>
<span class="cp">#define APCI3120_AMCC_OP_MCSR		0x3C</span>
<span class="cp">#define APCI3120_AMCC_OP_REG_INTCSR	0x38</span>

<span class="cm">/*</span>
<span class="cm"> * AMCC Operation Register Offsets - PCI</span>
<span class="cm"> */</span>
<span class="cp">#define AMCC_OP_REG_OMB1		0x00</span>
<span class="cp">#define AMCC_OP_REG_OMB2		0x04</span>
<span class="cp">#define AMCC_OP_REG_OMB3		0x08</span>
<span class="cp">#define AMCC_OP_REG_OMB4		0x0c</span>
<span class="cp">#define AMCC_OP_REG_IMB1		0x10</span>
<span class="cp">#define AMCC_OP_REG_IMB2		0x14</span>
<span class="cp">#define AMCC_OP_REG_IMB3		0x18</span>
<span class="cp">#define AMCC_OP_REG_IMB4		0x1c</span>
<span class="cp">#define AMCC_OP_REG_FIFO		0x20</span>
<span class="cp">#define AMCC_OP_REG_MWAR		0x24</span>
<span class="cp">#define AMCC_OP_REG_MWTC		0x28</span>
<span class="cp">#define AMCC_OP_REG_MRAR		0x2c</span>
<span class="cp">#define AMCC_OP_REG_MRTC		0x30</span>
<span class="cp">#define AMCC_OP_REG_MBEF		0x34</span>
<span class="cp">#define AMCC_OP_REG_INTCSR		0x38</span>
<span class="cm">/* int source */</span>
<span class="cp">#define  AMCC_OP_REG_INTCSR_SRC		(AMCC_OP_REG_INTCSR + 2)</span>
<span class="cm">/* FIFO ctrl */</span>
<span class="cp">#define  AMCC_OP_REG_INTCSR_FEC		(AMCC_OP_REG_INTCSR + 3)</span>
<span class="cp">#define AMCC_OP_REG_MCSR		0x3c</span>
<span class="cm">/* Data in byte 2 */</span>
<span class="cp">#define  AMCC_OP_REG_MCSR_NVDATA	(AMCC_OP_REG_MCSR + 2)</span>
<span class="cm">/* Command in byte 3 */</span>
<span class="cp">#define  AMCC_OP_REG_MCSR_NVCMD		(AMCC_OP_REG_MCSR + 3)</span>

<span class="cp">#define AMCC_FIFO_DEPTH_DWORD	8</span>
<span class="cp">#define AMCC_FIFO_DEPTH_BYTES	(8 * sizeof(u32))</span>

<span class="cm">/*</span>
<span class="cm"> * AMCC Operation Registers Size - PCI</span>
<span class="cm"> */</span>
<span class="cp">#define AMCC_OP_REG_SIZE	 64	</span><span class="cm">/* in bytes */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * AMCC Operation Register Offsets - Add-on</span>
<span class="cm"> */</span>
<span class="cp">#define AMCC_OP_REG_AIMB1	0x00</span>
<span class="cp">#define AMCC_OP_REG_AIMB2	0x04</span>
<span class="cp">#define AMCC_OP_REG_AIMB3	0x08</span>
<span class="cp">#define AMCC_OP_REG_AIMB4	0x0c</span>
<span class="cp">#define AMCC_OP_REG_AOMB1	0x10</span>
<span class="cp">#define AMCC_OP_REG_AOMB2	0x14</span>
<span class="cp">#define AMCC_OP_REG_AOMB3	0x18</span>
<span class="cp">#define AMCC_OP_REG_AOMB4	0x1c</span>
<span class="cp">#define AMCC_OP_REG_AFIFO	0x20</span>
<span class="cp">#define AMCC_OP_REG_AMWAR	0x24</span>
<span class="cp">#define AMCC_OP_REG_APTA	0x28</span>
<span class="cp">#define AMCC_OP_REG_APTD	0x2c</span>
<span class="cp">#define AMCC_OP_REG_AMRAR	0x30</span>
<span class="cp">#define AMCC_OP_REG_AMBEF	0x34</span>
<span class="cp">#define AMCC_OP_REG_AINT	0x38</span>
<span class="cp">#define AMCC_OP_REG_AGCSTS	0x3c</span>
<span class="cp">#define AMCC_OP_REG_AMWTC	0x58</span>
<span class="cp">#define AMCC_OP_REG_AMRTC	0x5c</span>

<span class="cm">/*</span>
<span class="cm"> * AMCC - Add-on General Control/Status Register</span>
<span class="cm"> */</span>
<span class="cp">#define AGCSTS_CONTROL_MASK	0xfffff000</span>
<span class="cp">#define  AGCSTS_NV_ACC_MASK	0xe0000000</span>
<span class="cp">#define  AGCSTS_RESET_MASK	0x0e000000</span>
<span class="cp">#define  AGCSTS_NV_DA_MASK	0x00ff0000</span>
<span class="cp">#define  AGCSTS_BIST_MASK	0x0000f000</span>
<span class="cp">#define AGCSTS_STATUS_MASK	0x000000ff</span>
<span class="cp">#define  AGCSTS_TCZERO_MASK	0x000000c0</span>
<span class="cp">#define  AGCSTS_FIFO_ST_MASK	0x0000003f</span>

<span class="cp">#define AGCSTS_RESET_MBFLAGS	0x08000000</span>
<span class="cp">#define AGCSTS_RESET_P2A_FIFO	0x04000000</span>
<span class="cp">#define AGCSTS_RESET_A2P_FIFO	0x02000000</span>
<span class="cp">#define AGCSTS_RESET_FIFOS	(AGCSTS_RESET_A2P_FIFO | AGCSTS_RESET_P2A_FIFO)</span>

<span class="cp">#define AGCSTS_A2P_TCOUNT	0x00000080</span>
<span class="cp">#define AGCSTS_P2A_TCOUNT	0x00000040</span>

<span class="cp">#define AGCSTS_FS_P2A_EMPTY	0x00000020</span>
<span class="cp">#define AGCSTS_FS_P2A_HALF	0x00000010</span>
<span class="cp">#define AGCSTS_FS_P2A_FULL	0x00000008</span>

<span class="cp">#define AGCSTS_FS_A2P_EMPTY	0x00000004</span>
<span class="cp">#define AGCSTS_FS_A2P_HALF	0x00000002</span>
<span class="cp">#define AGCSTS_FS_A2P_FULL	0x00000001</span>

<span class="cm">/*</span>
<span class="cm"> * AMCC - Add-on Interrupt Control/Status Register</span>
<span class="cm"> */</span>
<span class="cp">#define AINT_INT_MASK		0x00ff0000</span>
<span class="cp">#define AINT_SEL_MASK		0x0000ffff</span>
<span class="cp">#define  AINT_IS_ENSEL_MASK	0x00001f1f</span>

<span class="cp">#define AINT_INT_ASSERTED	0x00800000</span>
<span class="cp">#define AINT_BM_ERROR		0x00200000</span>
<span class="cp">#define AINT_BIST_INT		0x00100000</span>

<span class="cp">#define AINT_RT_COMPLETE	0x00080000</span>
<span class="cp">#define AINT_WT_COMPLETE	0x00040000</span>

<span class="cp">#define AINT_OUT_MB_INT		0x00020000</span>
<span class="cp">#define AINT_IN_MB_INT		0x00010000</span>

<span class="cp">#define AINT_READ_COMPL		0x00008000</span>
<span class="cp">#define AINT_WRITE_COMPL	0x00004000</span>

<span class="cp">#define AINT_OMB_ENABLE 	0x00001000</span>
<span class="cp">#define AINT_OMB_SELECT 	0x00000c00</span>
<span class="cp">#define AINT_OMB_BYTE		0x00000300</span>

<span class="cp">#define AINT_IMB_ENABLE 	0x00000010</span>
<span class="cp">#define AINT_IMB_SELECT 	0x0000000c</span>
<span class="cp">#define AINT_IMB_BYTE		0x00000003</span>

<span class="cm">/* Enable Bus Mastering */</span>
<span class="cp">#define EN_A2P_TRANSFERS	0x00000400</span>
<span class="cm">/* FIFO Flag Reset */</span>
<span class="cp">#define RESET_A2P_FLAGS		0x04000000L</span>
<span class="cm">/* FIFO Relative Priority */</span>
<span class="cp">#define A2P_HI_PRIORITY		0x00000100L</span>
<span class="cm">/* Identify Interrupt Sources */</span>
<span class="cp">#define ANY_S593X_INT		0x00800000L</span>
<span class="cp">#define READ_TC_INT		0x00080000L</span>
<span class="cp">#define WRITE_TC_INT		0x00040000L</span>
<span class="cp">#define IN_MB_INT		0x00020000L</span>
<span class="cp">#define MASTER_ABORT_INT	0x00100000L</span>
<span class="cp">#define TARGET_ABORT_INT	0x00200000L</span>
<span class="cp">#define BUS_MASTER_INT		0x00200000L</span>

<span class="cm">/****************************************************************************/</span>

<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vendor</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pci_bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pci_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pci_func</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">io_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ptr to root list of all amcc devices */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc_devices</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">i_ADDIDATADeviceID</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x15B8</span><span class="p">,</span> <span class="mh">0x10E8</span> <span class="p">};</span>

<span class="cm">/****************************************************************************/</span>

<span class="kt">void</span> <span class="n">v_pci_card_list_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_vendor</span><span class="p">,</span> <span class="kt">char</span> <span class="n">display</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">v_pci_card_list_cleanup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_vendor</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">ptr_find_free_pci_card_by_device</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vendor_id</span><span class="p">,</span>
						       <span class="kt">unsigned</span> <span class="kt">short</span>
						       <span class="n">device_id</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">i_find_free_pci_card_by_position</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vendor_id</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device_id</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_bus</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_slot</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">**</span><span class="n">card</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">ptr_select_and_alloc_pci_card</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vendor_id</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device_id</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_bus</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_slot</span><span class="p">,</span>
						    <span class="kt">int</span> <span class="n">i_Master</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">pci_card_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">master</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">i_pci_card_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">v_pci_card_list_display</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">i_pci_card_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_slot</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_func</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="o">*</span> <span class="n">io_addr</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">irq</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>

<span class="cm">/* build list of amcc cards in this system */</span>
<span class="kt">void</span> <span class="nf">v_pci_card_list_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_vendor</span><span class="p">,</span> <span class="kt">char</span> <span class="n">display</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_Count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">amcc_devices</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">pcidev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i_Count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_Count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i_Count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_vendor</span> <span class="o">=</span> <span class="n">i_ADDIDATADeviceID</span><span class="p">[</span><span class="n">i_Count</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">pci_vendor</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">amcc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">amcc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">amcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
					<span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">amcc</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">amcc_devices</span> <span class="o">=</span> <span class="n">amcc</span><span class="p">;</span>
				<span class="n">last</span> <span class="o">=</span> <span class="n">amcc</span><span class="p">;</span>

				<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
				<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
				<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
				<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_slot</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
				<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
				<span class="cm">/* Note: resources may be invalid if PCI device</span>
<span class="cm">				 * not enabled, but they are corrected in</span>
<span class="cm">				 * pci_card_alloc. */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="p">)</span>
		<span class="n">v_pci_card_list_display</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* free up list of amcc cards in this system */</span>
<span class="kt">void</span> <span class="nf">v_pci_card_list_cleanup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_vendor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">amcc</span> <span class="o">=</span> <span class="n">amcc_devices</span><span class="p">;</span> <span class="n">amcc</span><span class="p">;</span> <span class="n">amcc</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">amcc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">amcc_devices</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* find first unused card with this device_id */</span>
<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="nf">ptr_find_free_pci_card_by_device</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vendor_id</span><span class="p">,</span>
						       <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">amcc</span> <span class="o">=</span> <span class="n">amcc_devices</span><span class="p">;</span> <span class="n">amcc</span><span class="p">;</span> <span class="n">amcc</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">vendor_id</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">amcc</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* find card on requested position */</span>
<span class="kt">int</span> <span class="nf">i_find_free_pci_card_by_position</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vendor_id</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device_id</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_bus</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_slot</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">**</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">amcc</span> <span class="o">=</span> <span class="n">amcc_devices</span><span class="p">;</span> <span class="n">amcc</span><span class="p">;</span> <span class="n">amcc</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">vendor_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">==</span> <span class="n">pci_bus</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_slot</span> <span class="o">==</span> <span class="n">pci_slot</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">amcc</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* ok, card is found */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - </span><span class="se">\n</span><span class="s">Card on requested position is used b:s %d:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">pci_bus</span><span class="p">,</span> <span class="n">pci_slot</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* card exist but is used */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* no card found */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* mark card as used */</span>
<span class="kt">int</span> <span class="nf">pci_card_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amcc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comedi_pci_enable</span><span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;addi_amcc_s5933&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Resources will be accurate now. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span>
		<span class="n">pci_set_master</span><span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* mark card as free */</span>
<span class="kt">int</span> <span class="nf">i_pci_card_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amcc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">amcc</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">comedi_pci_disable</span><span class="p">(</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* display list of found cards */</span>
<span class="kt">void</span> <span class="nf">v_pci_card_list_display</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;List of pci cards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;bus:slot:func vendor device io_amcc io_daq irq used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">amcc</span> <span class="o">=</span> <span class="n">amcc_devices</span><span class="p">;</span> <span class="n">amcc</span><span class="p">;</span> <span class="n">amcc</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%2d   %2d   %2d  0x%4x 0x%4x   0x%8llx 0x%8llx  %2u  %2d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_slot</span><span class="p">,</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">,</span>
		     <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">amcc</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		     <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* return all card information for driver */</span>
<span class="kt">int</span> <span class="nf">i_pci_card_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">amcc</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_slot</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_func</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="o">*</span> <span class="n">io_addr</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amcc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pci_slot</span> <span class="o">=</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_slot</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="o">*</span><span class="n">irq</span> <span class="o">=</span> <span class="n">amcc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* select and alloc card */</span>
<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="nf">ptr_select_and_alloc_pci_card</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vendor_id</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device_id</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_bus</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_slot</span><span class="p">,</span>
						    <span class="kt">int</span> <span class="n">i_Master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pci_bus</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pci_slot</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* use autodetection */</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">ptr_find_free_pci_card_by_device</span><span class="p">(</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">device_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - Unused card not found in system!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i_find_free_pci_card_by_position</span><span class="p">(</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span>
							 <span class="n">pci_bus</span><span class="p">,</span> <span class="n">pci_slot</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - Card not found on requested position b:s %d:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">pci_bus</span><span class="p">,</span> <span class="n">pci_slot</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - Card on requested position is used b:s %d:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">pci_bus</span><span class="p">,</span> <span class="n">pci_slot</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_card_alloc</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i_Master</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - Can&#39;t allocate card!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">card</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
