<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › addi-data › APCI1710_Chrono.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>APCI1710_Chrono.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm">@verbatim</span>

<span class="cm">Copyright (C) 2004,2005  ADDI-DATA GmbH for the source code of this module.</span>

<span class="cm">	ADDI-DATA GmbH</span>
<span class="cm">	Dieselstrasse 3</span>
<span class="cm">	D-77833 Ottersweier</span>
<span class="cm">	Tel: +19(0)7223/9493-0</span>
<span class="cm">	Fax: +49(0)7223/9493-92</span>
<span class="cm">	http://www.addi-data.com</span>
<span class="cm">	info@addi-data.com</span>

<span class="cm">This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</span>

<span class="cm">This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</span>

<span class="cm">You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>

<span class="cm">You should also find the complete GPL in the COPYING file accompanying this source code.</span>

<span class="cm">@endverbatim</span>
<span class="cm">*/</span>
<span class="cm">/*</span>

<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | (C) ADDI-DATA GmbH          Dieselstraße 3       D-77833 Ottersweier  |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Tel : +49 (0) 7223/9493-0     | email    : info@addi-data.com         |</span>
<span class="cm">  | Fax : +49 (0) 7223/9493-92    | Internet : http://www.addi-data.com   |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Project     : API APCI1710    | Compiler : gcc                        |</span>
<span class="cm">  | Module name : CHRONO.C        | Version  : 2.96                       |</span>
<span class="cm">  +-------------------------------+---------------------------------------+</span>
<span class="cm">  | Project manager: Eric Stolz   | Date     :  02/12/2002                |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Description :   APCI-1710 chronometer module                          |</span>
<span class="cm">  |                                                                       |</span>
<span class="cm">  |                                                                       |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  |                             UPDATES                                   |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  |   Date   |   Author  |          Description of updates                |</span>
<span class="cm">  +----------+-----------+------------------------------------------------+</span>
<span class="cm">  | 29/06/98 | S. Weber  | Digital input / output implementation          |</span>
<span class="cm">  |----------|-----------|------------------------------------------------|</span>
<span class="cm">  | 08/05/00 | Guinot C  | - 0400/0228 All Function in RING 0             |</span>
<span class="cm">  |          |           |   available                                    |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  |          |           |                                                |</span>
<span class="cm">  |          |           |                                                |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                               Included files                               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="cp">#include &quot;APCI1710_Chrono.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_     i_APCI1710_InitChrono                        |</span>
<span class="cm">|                                       (unsigned char_     b_BoardHandle,            |</span>
<span class="cm">|                                        unsigned char_     b_ModulNbr,               |</span>
<span class="cm">|                                        unsigned char_     b_ChronoMode,             |</span>
<span class="cm">|                                        unsigned char_     b_PCIInputClock,          |</span>
<span class="cm">|                                        unsigned char_     b_TimingUnit,             |</span>
<span class="cm">|                                        ULONG_   ul_TimingInterval,         |</span>
<span class="cm">|                                        PULONG_ pul_RealTimingInterval)</span>

<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Configure the chronometer operating mode (b_ChronoMode)|</span>
<span class="cm">|                     from selected module (b_ModulNbr).                     |</span>
<span class="cm">|                     The ul_TimingInterval and ul_TimingUnit determine the  |</span>
<span class="cm">|                     timing base for the measurement.                       |</span>
<span class="cm">|                     The pul_RealTimingInterval return the real timing      |</span>
<span class="cm">|                     value. You must calling this function be for you call  |</span>
<span class="cm">|                     any other function witch access of the chronometer.    |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                     Witch this functionality from the APCI-1710 you have   |</span>
<span class="cm">|                     the possibility to measure the timing witch two event. |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                     The mode 0 and 1 is appropriate for period measurement.|</span>
<span class="cm">|                     The mode 2 and 3 is appropriate for frequent           |</span>
<span class="cm">|                     measurement.                                           |</span>
<span class="cm">|                     The mode 4 to 7 is appropriate for measuring the timing|</span>
<span class="cm">|                     between  two event.                                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_   b_BoardHandle    : Handle of board APCI-1710   |</span>
<span class="cm">| unsigned char_   b_ModulNbr  CR_AREF(insn-&gt;chanspec)  : Module number to configure  |</span>
<span class="cm">|                                                (0 to 3)                    |</span>
<span class="cm">| unsigned char_   b_ChronoMode				data[0]    : Chronometer action mode     |</span>
<span class="cm">|                                                (0 to 7).                   |</span>
<span class="cm">| unsigned char_   b_PCIInputClock			data[1] : Selection from PCI bus clock|</span>
<span class="cm">|                                                - APCI1710_30MHZ :          |</span>
<span class="cm">|                                                  The PC have a PCI bus     |</span>
<span class="cm">|                                                  clock from 30 MHz         |</span>
<span class="cm">|                                                - APCI1710_33MHZ :          |</span>
<span class="cm">|                                                  The PC have a PCI bus     |</span>
<span class="cm">|                                                  clock from 33 MHz         |</span>
<span class="cm">|                                                - APCI1710_40MHZ            |</span>
<span class="cm">|                                                  The APCI-1710 have a      |</span>
<span class="cm">|                                                  integrated 40Mhz          |</span>
<span class="cm">|                                                  quartz.                   |</span>
<span class="cm">|               unsigned char_   b_TimingUnit	data[2]    : Base timing unity (0 to 4) |</span>
<span class="cm">|                                                 0 : ns                     |</span>
<span class="cm">|                                                 1 : µs                     |</span>
<span class="cm">|                                                 2 : ms                     |</span>
<span class="cm">|                                                 3 : s                      |</span>
<span class="cm">|                                                 4 : mn                     |</span>
<span class="cm">|         ULONG_ ul_TimingInterval : data[3]	 Base timing value.          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : PULONG_  pul_RealTimingInterval : Real  base timing    |</span>
<span class="cm">|                                                       value.</span>
<span class="cm">|                     data[0]</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: Module selection wrong                             |</span>
<span class="cm">|                     -3: The module is not a Chronometer module             |</span>
<span class="cm">|                     -4: Chronometer mode selection is wrong                |</span>
<span class="cm">|                     -5: The selected PCI input clock is wrong              |</span>
<span class="cm">|                     -6: Timing unity selection is wrong                    |</span>
<span class="cm">|                     -7: Base timing selection is wrong                     |</span>
<span class="cm">|                     -8: You can not used the 40MHz clock selection with    |</span>
<span class="cm">|                         this board                                         |</span>
<span class="cm">|                     -9: You can not used the 40MHz clock selection with    |</span>
<span class="cm">|                         this CHRONOS version                               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InsnConfigInitChrono</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_TimerValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_TimingInterval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_RealTimingInterval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">d_RealTimingInterval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_ModeArray</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x06</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="n">b_ChronoMode</span><span class="p">,</span> <span class="n">b_PCIInputClock</span><span class="p">,</span> <span class="n">b_TimingUnit</span><span class="p">;</span>

	<span class="n">b_ModulNbr</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">b_ChronoMode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">b_PCIInputClock</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">b_TimingUnit</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ul_TimingInterval</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Test if chronometer */</span>
	   <span class="cm">/***********************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_CHRONOMETER</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*****************************/</span>
			<span class="cm">/* Test the chronometer mode */</span>
	      <span class="cm">/*****************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_ChronoMode</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/**************************/</span>
				<span class="cm">/* Test the PCI bus clock */</span>
		 <span class="cm">/**************************/</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_30MHZ</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_33MHZ</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">))</span> <span class="p">{</span>
		    <span class="cm">/*************************/</span>
					<span class="cm">/* Test the timing unity */</span>
		    <span class="cm">/*************************/</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		       <span class="cm">/**********************************/</span>
						<span class="cm">/* Test the base timing selection */</span>
		       <span class="cm">/**********************************/</span>

						<span class="k">if</span> <span class="p">(((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_30MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">66</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_30MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">143165576UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_30MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">143165UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_30MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">143UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_30MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">2UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_33MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_33MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">130150240UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_33MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">130150UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_33MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">130UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_33MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">2UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">107374182UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">107374UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">107UL</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnit</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span> <span class="mi">1UL</span><span class="p">)))</span> <span class="p">{</span>
			  <span class="cm">/**************************/</span>
							<span class="cm">/* Test the board version */</span>
			  <span class="cm">/**************************/</span>

							<span class="k">if</span> <span class="p">(((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">b_BoardVersion</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">!=</span> <span class="n">APCI1710_40MHZ</span><span class="p">))</span> <span class="p">{</span>
			     <span class="cm">/************************/</span>
								<span class="cm">/* Test the TOR version */</span>
			     <span class="cm">/************************/</span>

								<span class="k">if</span> <span class="p">(((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x3131</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">!=</span> <span class="n">APCI1710_40MHZ</span><span class="p">))</span> <span class="p">{</span>
									<span class="n">fpu_begin</span>
										<span class="p">();</span>

				<span class="cm">/****************************************/</span>
									<span class="cm">/* Calculate the timer 0 division fator */</span>
				<span class="cm">/****************************************/</span>

									<span class="k">switch</span> <span class="p">(</span><span class="n">b_TimingUnit</span><span class="p">)</span> <span class="p">{</span>
				   <span class="cm">/******/</span>
										<span class="cm">/* ns */</span>
				   <span class="cm">/******/</span>

									<span class="k">case</span> <span class="mi">0</span>:

					   <span class="cm">/******************/</span>
										<span class="cm">/* Timer 0 factor */</span>
					   <span class="cm">/******************/</span>

										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="p">(</span><span class="n">ul_TimingInterval</span>
											<span class="o">*</span>
											<span class="p">(</span><span class="mf">0.001</span> <span class="o">*</span> <span class="n">b_PCIInputClock</span><span class="p">));</span>

					   <span class="cm">/*******************/</span>
										<span class="cm">/* Round the value */</span>
					   <span class="cm">/*******************/</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimingInterval</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="n">ul_TimerValue</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

					   <span class="cm">/*****************************/</span>
										<span class="cm">/* Calculate the real timing */</span>
					   <span class="cm">/*****************************/</span>

										<span class="n">ul_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="p">(</span><span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span><span class="mf">0.001</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">));</span>
										<span class="n">d_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span><span class="mf">0.001</span>
											<span class="o">*</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="n">b_PCIInputClock</span><span class="p">);</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_RealTimingInterval</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="p">{</span>
											<span class="n">ul_RealTimingInterval</span>
												<span class="o">=</span>
												<span class="n">ul_RealTimingInterval</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

										<span class="n">ul_TimingInterval</span>
											<span class="o">=</span>
											<span class="n">ul_TimingInterval</span>
											<span class="o">-</span>
											<span class="mi">1</span><span class="p">;</span>
										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">-</span>
											<span class="mi">2</span><span class="p">;</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">!=</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
												<span class="p">(</span>
												<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
												<span class="p">(</span><span class="n">ul_TimerValue</span><span class="p">)</span>
												<span class="o">*</span>
												<span class="mf">0.99392</span><span class="p">);</span>
										<span class="p">}</span>

										<span class="k">break</span><span class="p">;</span>

				   <span class="cm">/******/</span>
										<span class="cm">/* æs */</span>
				   <span class="cm">/******/</span>

									<span class="k">case</span> <span class="mi">1</span>:

					   <span class="cm">/******************/</span>
										<span class="cm">/* Timer 0 factor */</span>
					   <span class="cm">/******************/</span>

										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="p">(</span><span class="n">ul_TimingInterval</span>
											<span class="o">*</span>
											<span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">b_PCIInputClock</span><span class="p">));</span>

					   <span class="cm">/*******************/</span>
										<span class="cm">/* Round the value */</span>
					   <span class="cm">/*******************/</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimingInterval</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="n">ul_TimerValue</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

					   <span class="cm">/*****************************/</span>
										<span class="cm">/* Calculate the real timing */</span>
					   <span class="cm">/*****************************/</span>

										<span class="n">ul_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="p">(</span><span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">));</span>
										<span class="n">d_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="mf">1.0</span>
											<span class="o">*</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="n">b_PCIInputClock</span><span class="p">);</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_RealTimingInterval</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="p">{</span>
											<span class="n">ul_RealTimingInterval</span>
												<span class="o">=</span>
												<span class="n">ul_RealTimingInterval</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

										<span class="n">ul_TimingInterval</span>
											<span class="o">=</span>
											<span class="n">ul_TimingInterval</span>
											<span class="o">-</span>
											<span class="mi">1</span><span class="p">;</span>
										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">-</span>
											<span class="mi">2</span><span class="p">;</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">!=</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
												<span class="p">(</span>
												<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
												<span class="p">(</span><span class="n">ul_TimerValue</span><span class="p">)</span>
												<span class="o">*</span>
												<span class="mf">0.99392</span><span class="p">);</span>
										<span class="p">}</span>

										<span class="k">break</span><span class="p">;</span>

				   <span class="cm">/******/</span>
										<span class="cm">/* ms */</span>
				   <span class="cm">/******/</span>

									<span class="k">case</span> <span class="mi">2</span>:

					   <span class="cm">/******************/</span>
										<span class="cm">/* Timer 0 factor */</span>
					   <span class="cm">/******************/</span>

										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="n">ul_TimingInterval</span>
											<span class="o">*</span>
											<span class="p">(</span><span class="mi">1000</span>
											<span class="o">*</span>
											<span class="n">b_PCIInputClock</span><span class="p">);</span>

					   <span class="cm">/*******************/</span>
										<span class="cm">/* Round the value */</span>
					   <span class="cm">/*******************/</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimingInterval</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1000.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="n">ul_TimerValue</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

					   <span class="cm">/*****************************/</span>
										<span class="cm">/* Calculate the real timing */</span>
					   <span class="cm">/*****************************/</span>

										<span class="n">ul_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="p">(</span><span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span><span class="mf">1000.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">));</span>
										<span class="n">d_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span><span class="mf">1000.0</span>
											<span class="o">*</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="n">b_PCIInputClock</span><span class="p">);</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1000.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_RealTimingInterval</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="p">{</span>
											<span class="n">ul_RealTimingInterval</span>
												<span class="o">=</span>
												<span class="n">ul_RealTimingInterval</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

										<span class="n">ul_TimingInterval</span>
											<span class="o">=</span>
											<span class="n">ul_TimingInterval</span>
											<span class="o">-</span>
											<span class="mi">1</span><span class="p">;</span>
										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">-</span>
											<span class="mi">2</span><span class="p">;</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">!=</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
												<span class="p">(</span>
												<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
												<span class="p">(</span><span class="n">ul_TimerValue</span><span class="p">)</span>
												<span class="o">*</span>
												<span class="mf">0.99392</span><span class="p">);</span>
										<span class="p">}</span>

										<span class="k">break</span><span class="p">;</span>

				   <span class="cm">/*****/</span>
										<span class="cm">/* s */</span>
				   <span class="cm">/*****/</span>

									<span class="k">case</span> <span class="mi">3</span>:

					   <span class="cm">/******************/</span>
										<span class="cm">/* Timer 0 factor */</span>
					   <span class="cm">/******************/</span>

										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="p">(</span><span class="n">ul_TimingInterval</span>
											<span class="o">*</span>
											<span class="p">(</span><span class="mf">1000000.0</span>
												<span class="o">*</span>
												<span class="n">b_PCIInputClock</span><span class="p">));</span>

					   <span class="cm">/*******************/</span>
										<span class="cm">/* Round the value */</span>
					   <span class="cm">/*******************/</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimingInterval</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1000000.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="n">ul_TimerValue</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

					   <span class="cm">/*****************************/</span>
										<span class="cm">/* Calculate the real timing */</span>
					   <span class="cm">/*****************************/</span>

										<span class="n">ul_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="p">(</span><span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span><span class="mf">1000000.0</span>
												<span class="o">*</span>
												<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
												<span class="n">b_PCIInputClock</span><span class="p">));</span>
										<span class="n">d_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span><span class="mf">1000000.0</span>
											<span class="o">*</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="n">b_PCIInputClock</span><span class="p">);</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1000000.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_RealTimingInterval</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="p">{</span>
											<span class="n">ul_RealTimingInterval</span>
												<span class="o">=</span>
												<span class="n">ul_RealTimingInterval</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

										<span class="n">ul_TimingInterval</span>
											<span class="o">=</span>
											<span class="n">ul_TimingInterval</span>
											<span class="o">-</span>
											<span class="mi">1</span><span class="p">;</span>
										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">-</span>
											<span class="mi">2</span><span class="p">;</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">!=</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
												<span class="p">(</span>
												<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
												<span class="p">(</span><span class="n">ul_TimerValue</span><span class="p">)</span>
												<span class="o">*</span>
												<span class="mf">0.99392</span><span class="p">);</span>
										<span class="p">}</span>

										<span class="k">break</span><span class="p">;</span>

				   <span class="cm">/******/</span>
										<span class="cm">/* mn */</span>
				   <span class="cm">/******/</span>

									<span class="k">case</span> <span class="mi">4</span>:

					   <span class="cm">/******************/</span>
										<span class="cm">/* Timer 0 factor */</span>
					   <span class="cm">/******************/</span>

										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="p">(</span>
											<span class="p">(</span><span class="n">ul_TimingInterval</span>
												<span class="o">*</span>
												<span class="mi">60</span><span class="p">)</span>
											<span class="o">*</span>
											<span class="p">(</span><span class="mf">1000000.0</span>
												<span class="o">*</span>
												<span class="n">b_PCIInputClock</span><span class="p">));</span>

					   <span class="cm">/*******************/</span>
										<span class="cm">/* Round the value */</span>
					   <span class="cm">/*******************/</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)(</span><span class="n">ul_TimingInterval</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1000000.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="n">ul_TimerValue</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

					   <span class="cm">/*****************************/</span>
										<span class="cm">/* Calculate the real timing */</span>
					   <span class="cm">/*****************************/</span>

										<span class="n">ul_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="p">(</span><span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span><span class="mf">1000000.0</span>
												<span class="o">*</span>
												<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
												<span class="n">b_PCIInputClock</span><span class="p">))</span>
											<span class="o">/</span>
											<span class="mi">60</span><span class="p">;</span>
										<span class="n">d_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="p">(</span>
											<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">/</span>
											<span class="p">(</span><span class="mf">0.001</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">;</span>

										<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)(((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1000000.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_RealTimingInterval</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="p">{</span>
											<span class="n">ul_RealTimingInterval</span>
												<span class="o">=</span>
												<span class="n">ul_RealTimingInterval</span>
												<span class="o">+</span>
												<span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

										<span class="n">ul_TimingInterval</span>
											<span class="o">=</span>
											<span class="n">ul_TimingInterval</span>
											<span class="o">-</span>
											<span class="mi">1</span><span class="p">;</span>
										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">-</span>
											<span class="mi">2</span><span class="p">;</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">!=</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="p">{</span>
											<span class="n">ul_TimerValue</span>
												<span class="o">=</span>
												<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
												<span class="p">(</span>
												<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
												<span class="p">(</span><span class="n">ul_TimerValue</span><span class="p">)</span>
												<span class="o">*</span>
												<span class="mf">0.99392</span><span class="p">);</span>
										<span class="p">}</span>

										<span class="k">break</span><span class="p">;</span>
									<span class="p">}</span>

									<span class="n">fpu_end</span><span class="p">();</span>

				<span class="cm">/****************************/</span>
									<span class="cm">/* Save the PCI input clock */</span>
				<span class="cm">/****************************/</span>

									<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
										<span class="n">b_PCIInputClock</span>
										<span class="o">=</span>
										<span class="n">b_PCIInputClock</span><span class="p">;</span>

				<span class="cm">/*************************/</span>
									<span class="cm">/* Save the timing unity */</span>
				<span class="cm">/*************************/</span>

									<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
										<span class="n">b_TimingUnit</span>
										<span class="o">=</span>
										<span class="n">b_TimingUnit</span><span class="p">;</span>

				<span class="cm">/************************/</span>
									<span class="cm">/* Save the base timing */</span>
				<span class="cm">/************************/</span>

									<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
										<span class="n">d_TimingInterval</span>
										<span class="o">=</span>
										<span class="n">d_RealTimingInterval</span><span class="p">;</span>

				<span class="cm">/****************************/</span>
									<span class="cm">/* Set the chronometer mode */</span>
				<span class="cm">/****************************/</span>

									<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
										<span class="n">dw_ConfigReg</span>
										<span class="o">=</span>
										<span class="n">dw_ModeArray</span>
										<span class="p">[</span><span class="n">b_ChronoMode</span><span class="p">];</span>

				<span class="cm">/***********************/</span>
									<span class="cm">/* Test if 40 MHz used */</span>
				<span class="cm">/***********************/</span>

									<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="p">{</span>
										<span class="n">devpriv</span><span class="o">-&gt;</span>
											<span class="n">s_ModuleInfo</span>
											<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
											<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
											<span class="n">dw_ConfigReg</span>
											<span class="o">=</span>
											<span class="n">devpriv</span><span class="o">-&gt;</span>
											<span class="n">s_ModuleInfo</span>
											<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
											<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
											<span class="n">dw_ConfigReg</span>
											<span class="o">|</span>
											<span class="mh">0x80</span><span class="p">;</span>
									<span class="p">}</span>

									<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_ChronoModuleInfo</span><span class="p">.</span><span class="n">dw_ConfigReg</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

				<span class="cm">/***********************/</span>
									<span class="cm">/* Write timer 0 value */</span>
				<span class="cm">/***********************/</span>

									<span class="n">outl</span><span class="p">(</span><span class="n">ul_TimerValue</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

				<span class="cm">/*********************/</span>
									<span class="cm">/* Chronometer init. */</span>
				<span class="cm">/*********************/</span>

									<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
										<span class="n">b_ChronoInit</span>
										<span class="o">=</span>
										<span class="mi">1</span><span class="p">;</span>
								<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/***********************************************/</span>
									<span class="cm">/* TOR version error for 40MHz clock selection */</span>
				<span class="cm">/***********************************************/</span>

									<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;TOR version error for 40MHz clock selection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
									<span class="n">i_ReturnValue</span>
										<span class="o">=</span>
										<span class="o">-</span><span class="mi">9</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			     <span class="cm">/**************************************************************/</span>
								<span class="cm">/* You can not use the 40MHz clock selection with this board */</span>
			     <span class="cm">/**************************************************************/</span>

								<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;You can not used the 40MHz clock selection with this board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="n">i_ReturnValue</span> <span class="o">=</span>
									<span class="o">-</span><span class="mi">8</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			  <span class="cm">/**********************************/</span>
							<span class="cm">/* Base timing selection is wrong */</span>
			  <span class="cm">/**********************************/</span>

							<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Base timing selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">7</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>	<span class="cm">/*  if ((b_TimingUnit &gt;= 0) &amp;&amp; (b_TimingUnit &lt;= 4)) */</span>
					<span class="k">else</span> <span class="p">{</span>
		       <span class="cm">/***********************************/</span>
						<span class="cm">/* Timing unity selection is wrong */</span>
		       <span class="cm">/***********************************/</span>

						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timing unity selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
					<span class="p">}</span>	<span class="cm">/*  if ((b_TimingUnit &gt;= 0) &amp;&amp; (b_TimingUnit &lt;= 4)) */</span>
				<span class="p">}</span>	<span class="cm">/*  if ((b_PCIInputClock == APCI1710_30MHZ) || (b_PCIInputClock == APCI1710_33MHZ)) */</span>
				<span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/*****************************************/</span>
					<span class="cm">/* The selected PCI input clock is wrong */</span>
		    <span class="cm">/*****************************************/</span>

					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected PCI input clock is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>	<span class="cm">/*  if ((b_PCIInputClock == APCI1710_30MHZ) || (b_PCIInputClock == APCI1710_33MHZ)) */</span>
			<span class="p">}</span>	<span class="cm">/*  if (b_ChronoMode &gt;= 0 &amp;&amp; b_ChronoMode &lt;= 7) */</span>
			<span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/***************************************/</span>
				<span class="cm">/* Chronometer mode selection is wrong */</span>
		 <span class="cm">/***************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Chronometer mode selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/*  if (b_ChronoMode &gt;= 0 &amp;&amp; b_ChronoMode &lt;= 7) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/******************************************/</span>
			<span class="cm">/* The module is not a Chronometer module */</span>
	      <span class="cm">/******************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a Chronometer module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Module number error */</span>
	   <span class="cm">/***********************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ul_RealTimingInterval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_EnableChrono                          |</span>
<span class="cm">|                                               (unsigned char_ b_BoardHandle,        |</span>
<span class="cm">|                                                unsigned char_ b_ModulNbr,           |</span>
<span class="cm">|                                                unsigned char_ b_CycleMode,          |</span>
<span class="cm">|                                                unsigned char_ b_InterruptEnable)</span>
<span class="cm">int i_APCI1710_InsnWriteEnableDisableChrono(struct comedi_device *dev,</span>
<span class="cm">struct comedi_subdevice *s,struct comedi_insn *insn,unsigned int *data)						 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Enable the chronometer from selected module            |</span>
<span class="cm">|                     (b_ModulNbr). You must calling the                     |</span>
<span class="cm">|                     &quot;i_APCI1710_InitChrono&quot; function be for you call this  |</span>
<span class="cm">|                     function.                                              |</span>
<span class="cm">|                     If you enable the chronometer interrupt, the           |</span>
<span class="cm">|                     chronometer generate a interrupt after the stop signal.|</span>
<span class="cm">|                     See function &quot;i_APCI1710_SetBoardIntRoutineX&quot; and the  |</span>
<span class="cm">|                     Interrupt mask description chapter from this manual.   |</span>
<span class="cm">|                     The b_CycleMode parameter determine if you will        |</span>
<span class="cm">|                     measured a single or more cycle.</span>

<span class="cm">|					  Disable the chronometer from selected module           |</span>
<span class="cm">|                     (b_ModulNbr). If you disable the chronometer after a   |</span>
<span class="cm">|                     start signal occur and you restart the chronometer     |</span>
<span class="cm">|                     witch the &quot; i_APCI1710_EnableChrono&quot; function, if no   |</span>
<span class="cm">|                     stop signal occur this start signal is ignored.</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle  : Handle of board APCI-1710       |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr   CR_AREF(chanspec)  : Selected module number (0 to 3) |</span>
<span class="cm">                                  data[0]  ENABle/Disable chrono</span>
<span class="cm">|                     unsigned char_ b_CycleMode    : Selected the chronometer        |</span>
<span class="cm">|                                  data[1]           acquisition mode                |</span>
<span class="cm">|                     unsigned char_ b_InterruptEnable : Enable or disable the        |</span>
<span class="cm">|                                   data[2]            chronometer interrupt.       |</span>
<span class="cm">|                                               APCI1710_ENABLE:             |</span>
<span class="cm">|                                               Enable the chronometer       |</span>
<span class="cm">|                                               interrupt                    |</span>
<span class="cm">|                                               APCI1710_DISABLE:            |</span>
<span class="cm">|                                               Disable the chronometer      |</span>
<span class="cm">|                                               interrupt                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: Module selection wrong                             |</span>
<span class="cm">|                     -3: The module is not a Chronometer module             |</span>
<span class="cm">|                     -4: Chronometer not initialised see function           |</span>
<span class="cm">|                         &quot;i_APCI1710_InitChrono&quot;                            |</span>
<span class="cm">|                     -5: Chronometer acquisition mode cycle is wrong        |</span>
<span class="cm">|                     -6: Interrupt parameter is wrong                       |</span>
<span class="cm">|                     -7: Interrupt function not initialised.                |</span>
<span class="cm">|                         See function &quot;i_APCI1710_SetBoardIntRoutineX&quot;</span>
<span class="cm">                      -8: data[0] wrong input    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InsnWriteEnableDisableChrono</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="n">b_CycleMode</span><span class="p">,</span> <span class="n">b_InterruptEnable</span><span class="p">,</span> <span class="n">b_Action</span><span class="p">;</span>
	<span class="n">b_ModulNbr</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">b_Action</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">b_CycleMode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">b_InterruptEnable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Test if chronometer */</span>
	   <span class="cm">/***********************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_CHRONOMETER</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/***********************************/</span>
			<span class="cm">/* Test if chronometer initialised */</span>
	      <span class="cm">/***********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_ChronoModuleInfo</span><span class="p">.</span><span class="n">b_ChronoInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">b_Action</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">case</span> <span class="n">APCI1710_ENABLE</span>:

		 <span class="cm">/*********************************/</span>
					<span class="cm">/* Test the cycle mode parameter */</span>
		 <span class="cm">/*********************************/</span>

					<span class="k">if</span> <span class="p">((</span><span class="n">b_CycleMode</span> <span class="o">==</span> <span class="n">APCI1710_SINGLE</span><span class="p">)</span>
						<span class="o">||</span> <span class="p">(</span><span class="n">b_CycleMode</span> <span class="o">==</span>
							<span class="n">APCI1710_CONTINUOUS</span><span class="p">))</span> <span class="p">{</span>
		    <span class="cm">/***************************/</span>
						<span class="cm">/* Test the interrupt flag */</span>
		    <span class="cm">/***************************/</span>

						<span class="k">if</span> <span class="p">((</span><span class="n">b_InterruptEnable</span> <span class="o">==</span>
								<span class="n">APCI1710_ENABLE</span><span class="p">)</span>
							<span class="o">||</span> <span class="p">(</span><span class="n">b_InterruptEnable</span> <span class="o">==</span>
								<span class="n">APCI1710_DISABLE</span><span class="p">))</span>
						<span class="p">{</span>

			  <span class="cm">/***************************/</span>
							<span class="cm">/* Save the interrupt flag */</span>
			  <span class="cm">/***************************/</span>

							<span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
								<span class="n">b_InterruptMask</span>
								<span class="o">=</span>
								<span class="n">b_InterruptEnable</span><span class="p">;</span>

			  <span class="cm">/***********************/</span>
							<span class="cm">/* Save the cycle mode */</span>
			  <span class="cm">/***********************/</span>

							<span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
								<span class="n">b_CycleMode</span> <span class="o">=</span>
								<span class="n">b_CycleMode</span><span class="p">;</span>

							<span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
								<span class="n">dw_ConfigReg</span> <span class="o">=</span>
								<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
								<span class="n">dw_ConfigReg</span> <span class="o">&amp;</span>
								<span class="mh">0x8F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&amp;</span>
									<span class="n">b_InterruptEnable</span><span class="p">)</span>
								<span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&amp;</span>
									<span class="n">b_CycleMode</span><span class="p">)</span>
								<span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">;</span>

			  <span class="cm">/*****************************/</span>
							<span class="cm">/* Test if interrupt enabled */</span>
			  <span class="cm">/*****************************/</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">b_InterruptEnable</span> <span class="o">==</span>
								<span class="n">APCI1710_ENABLE</span><span class="p">)</span>
							<span class="p">{</span>
			     <span class="cm">/****************************/</span>
								<span class="cm">/* Clear the interrupt flag */</span>
			     <span class="cm">/****************************/</span>

								<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
									<span class="n">dw_ConfigReg</span><span class="p">,</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_BoardInfos</span><span class="p">.</span>
									<span class="n">ui_Address</span>
									<span class="o">+</span> <span class="mi">32</span> <span class="o">+</span>
									<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>	<span class="cm">/*  Save the current process task structure */</span>
							<span class="p">}</span>

			  <span class="cm">/***********************************/</span>
							<span class="cm">/* Enable or disable the interrupt */</span>
							<span class="cm">/* Enable the chronometer          */</span>
			  <span class="cm">/***********************************/</span>

							<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
								<span class="n">dw_ConfigReg</span><span class="p">,</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_BoardInfos</span><span class="p">.</span>
								<span class="n">ui_Address</span> <span class="o">+</span>
								<span class="mi">16</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			  <span class="cm">/*************************/</span>
							<span class="cm">/* Clear status register */</span>
			  <span class="cm">/*************************/</span>

							<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_BoardInfos</span><span class="p">.</span>
								<span class="n">ui_Address</span> <span class="o">+</span>
								<span class="mi">36</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

						<span class="p">}</span>	<span class="cm">/*  if ((b_InterruptEnable == APCI1710_ENABLE) || (b_InterruptEnable == APCI1710_DISABLE)) */</span>
						<span class="k">else</span> <span class="p">{</span>
		       <span class="cm">/********************************/</span>
							<span class="cm">/* Interrupt parameter is wrong */</span>
		       <span class="cm">/********************************/</span>

							<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Interrupt parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
						<span class="p">}</span>	<span class="cm">/*  if ((b_InterruptEnable == APCI1710_ENABLE) || (b_InterruptEnable == APCI1710_DISABLE)) */</span>
					<span class="p">}</span>	<span class="cm">/*  if ((b_CycleMode == APCI1710_SINGLE) || (b_CycleMode == APCI1710_CONTINUOUS)) */</span>
					<span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/***********************************************/</span>
						<span class="cm">/* Chronometer acquisition mode cycle is wrong */</span>
		    <span class="cm">/***********************************************/</span>

						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Chronometer acquisition mode cycle is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
					<span class="p">}</span>	<span class="cm">/*  if ((b_CycleMode == APCI1710_SINGLE) || (b_CycleMode == APCI1710_CONTINUOUS)) */</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">APCI1710_DISABLE</span>:

					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
						<span class="n">b_InterruptMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
						<span class="n">dw_ConfigReg</span> <span class="o">=</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
						<span class="n">dw_ConfigReg</span> <span class="o">&amp;</span> <span class="mh">0x2F</span><span class="p">;</span>

		 <span class="cm">/***************************/</span>
					<span class="cm">/* Disable the interrupt   */</span>
					<span class="cm">/* Disable the chronometer */</span>
		 <span class="cm">/***************************/</span>

					<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_ChronoModuleInfo</span><span class="p">.</span><span class="n">dw_ConfigReg</span><span class="p">,</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
						<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span>
						<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

		 <span class="cm">/***************************/</span>
					<span class="cm">/* Test if continuous mode */</span>
		 <span class="cm">/***************************/</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
						<span class="n">b_CycleMode</span> <span class="o">==</span>
						<span class="n">APCI1710_CONTINUOUS</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/*************************/</span>
						<span class="cm">/* Clear status register */</span>
		    <span class="cm">/*************************/</span>

						<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
							<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">+</span>
							<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="nl">default:</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Inputs wrong! Enable or Disable chrono</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span>
				<span class="p">}</span>	<span class="cm">/*  switch ENABLE/DISABLE */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*******************************/</span>
				<span class="cm">/* Chronometer not initialised */</span>
		 <span class="cm">/*******************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Chronometer not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/******************************************/</span>
			<span class="cm">/* The module is not a Chronometer module */</span>
	      <span class="cm">/******************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a Chronometer module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Module number error */</span>
	   <span class="cm">/***********************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     :INT	i_APCI1710_InsnReadChrono(struct comedi_device *dev,struct comedi_subdevice *s,</span>
<span class="cm">struct comedi_insn *insn,unsigned int *data)                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Read  functions for Timer                                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InsnReadChrono</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ReadType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="n">b_ReadType</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">b_ReadType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APCI1710_CHRONO_PROGRESS_STATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_GetChronoProgressStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_CHRONO_READVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_ReadChronoValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">unused</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_CHRONO_CONVERTVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_ConvertChronoValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">unused</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_CHRONO_READINTERRUPT</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;In Chrono Read Interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">s_FIFOInterruptParameters</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span><span class="p">].</span><span class="n">b_OldModuleMask</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">s_FIFOInterruptParameters</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span><span class="p">].</span><span class="n">ul_OldInterruptMask</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">s_FIFOInterruptParameters</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span><span class="p">].</span><span class="n">ul_OldCounterLatchValue</span><span class="p">;</span>

			     <span class="cm">/**************************/</span>
		<span class="cm">/* Increment the read FIFO */</span>
			     <span class="cm">/***************************/</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">ui_Read</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">ui_Read</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">APCI1710_SAVE_INTERRUPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ReadType Parameter wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_GetChronoProgressStatus               |</span>
<span class="cm">|                               (unsigned char_    b_BoardHandle,                     |</span>
<span class="cm">|                                unsigned char_    b_ModulNbr,                        |</span>
<span class="cm">|                                unsigned char *_  pb_ChronoStatus)                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the chronometer status (pb_ChronoStatus) from   |</span>
<span class="cm">|                     selected chronometer module (b_ModulNbr).              |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle  : Handle of board APCI-1710       |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr     : Selected module number (0 to 3) |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : PULONG_  pb_ChronoStatus : Return the chronometer      |</span>
<span class="cm">|                                                status.                     |</span>
<span class="cm">|                                                0 : Measurement not started.|</span>
<span class="cm">|                                                    No start signal occur.  |</span>
<span class="cm">|                                                1 : Measurement started.    |</span>
<span class="cm">|                                                    A start signal occur.   |</span>
<span class="cm">|                                                2 : Measurement stopped.    |</span>
<span class="cm">|                                                    A stop signal occur.    |</span>
<span class="cm">|                                                    The measurement is      |</span>
<span class="cm">|                                                    terminate.              |</span>
<span class="cm">|                                                3: A overflow occur. You    |</span>
<span class="cm">|                                                   must change the base     |</span>
<span class="cm">|                                                   timing witch the         |</span>
<span class="cm">|                                                   function                 |</span>
<span class="cm">|                                                   &quot;i_APCI1710_InitChrono&quot;  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: Module selection wrong                             |</span>
<span class="cm">|                     -3: The module is not a Chronometer module             |</span>
<span class="cm">|                     -4: Chronometer not initialised see function           |</span>
<span class="cm">|                         &quot;i_APCI1710_InitChrono&quot;                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_GetChronoProgressStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_ChronoStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Test if chronometer */</span>
	   <span class="cm">/***********************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_CHRONOMETER</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/***********************************/</span>
			<span class="cm">/* Test if chronometer initialised */</span>
	      <span class="cm">/***********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_ChronoModuleInfo</span><span class="p">.</span><span class="n">b_ChronoInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">dw_Status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

		 <span class="cm">/********************/</span>
				<span class="cm">/* Test if overflow */</span>
		 <span class="cm">/********************/</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/******************/</span>
					<span class="cm">/* Overflow occur */</span>
		    <span class="cm">/******************/</span>

					<span class="o">*</span><span class="n">pb_ChronoStatus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 8) == 8) */</span>
				<span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/*******************************/</span>
					<span class="cm">/* Test if measurement stopped */</span>
		    <span class="cm">/*******************************/</span>

					<span class="k">if</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		       <span class="cm">/***********************/</span>
						<span class="cm">/* A stop signal occur */</span>
		       <span class="cm">/***********************/</span>

						<span class="o">*</span><span class="n">pb_ChronoStatus</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 2) == 2) */</span>
					<span class="k">else</span> <span class="p">{</span>
		       <span class="cm">/*******************************/</span>
						<span class="cm">/* Test if measurement started */</span>
		       <span class="cm">/*******************************/</span>

						<span class="k">if</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			  <span class="cm">/************************/</span>
							<span class="cm">/* A start signal occur */</span>
			  <span class="cm">/************************/</span>

							<span class="o">*</span><span class="n">pb_ChronoStatus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 1) == 1) */</span>
						<span class="k">else</span> <span class="p">{</span>
			  <span class="cm">/***************************/</span>
							<span class="cm">/* Measurement not started */</span>
			  <span class="cm">/***************************/</span>

							<span class="o">*</span><span class="n">pb_ChronoStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 1) == 1) */</span>
					<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 2) == 2) */</span>
				<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 8) == 8) */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*******************************/</span>
				<span class="cm">/* Chronometer not initialised */</span>
		 <span class="cm">/*******************************/</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Chronometer not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/******************************************/</span>
			<span class="cm">/* The module is not a Chronometer module */</span>
	      <span class="cm">/******************************************/</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a Chronometer module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Module number error */</span>
	   <span class="cm">/***********************/</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_ReadChronoValue                       |</span>
<span class="cm">|                               (unsigned char_     b_BoardHandle,                    |</span>
<span class="cm">|                                unsigned char_     b_ModulNbr,                       |</span>
<span class="cm">|                                unsigned int_    ui_TimeOut,                        |</span>
<span class="cm">|                                unsigned char *_   pb_ChronoStatus,                   |</span>
<span class="cm">|                                PULONG_ pul_ChronoValue)                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the chronometer status (pb_ChronoStatus) and the|</span>
<span class="cm">|                     timing value (pul_ChronoValue) after a stop signal     |</span>
<span class="cm">|                     occur from selected chronometer module (b_ModulNbr).   |</span>
<span class="cm">|                     This function are only avaible if you have disabled    |</span>
<span class="cm">|                     the interrupt functionality. See function              |</span>
<span class="cm">|                     &quot;i_APCI1710_EnableChrono&quot; and the Interrupt mask       |</span>
<span class="cm">|                     description chapter.                                   |</span>
<span class="cm">|                     You can test the chronometer status witch the          |</span>
<span class="cm">|                     &quot;i_APCI1710_GetChronoProgressStatus&quot; function.         |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                     The returned value from pul_ChronoValue parameter is   |</span>
<span class="cm">|                     not real measured timing.                              |</span>
<span class="cm">|                     You must used the &quot;i_APCI1710_ConvertChronoValue&quot;      |</span>
<span class="cm">|                     function or make this operation for calculate the      |</span>
<span class="cm">|                     timing:                                                |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                     Timing = pul_ChronoValue * pul_RealTimingInterval.     |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                     pul_RealTimingInterval is the returned parameter from  |</span>
<span class="cm">|                     &quot;i_APCI1710_InitChrono&quot; function and the time unity is |</span>
<span class="cm">|                     the b_TimingUnit from &quot;i_APCI1710_InitChrono&quot; function|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle  : Handle of board APCI-1710       |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr     : Selected module number (0 to 3) |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : PULONG_  pb_ChronoStatus : Return the chronometer      |</span>
<span class="cm">|                                                status.                     |</span>
<span class="cm">|                                                0 : Measurement not started.|</span>
<span class="cm">|                                                    No start signal occur.  |</span>
<span class="cm">|                                                1 : Measurement started.    |</span>
<span class="cm">|                                                    A start signal occur.   |</span>
<span class="cm">|                                                2 : Measurement stopped.    |</span>
<span class="cm">|                                                    A stop signal occur.    |</span>
<span class="cm">|                                                    The measurement is      |</span>
<span class="cm">|                                                    terminate.              |</span>
<span class="cm">|                                                3: A overflow occur. You    |</span>
<span class="cm">|                                                   must change the base     |</span>
<span class="cm">|                                                   timing witch the         |</span>
<span class="cm">|                                                   function                 |</span>
<span class="cm">|                                                   &quot;i_APCI1710_InitChrono&quot;  |</span>
<span class="cm">|                     unsigned int *  pul_ChronoValue  : Chronometer timing value.   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: Module selection wrong                             |</span>
<span class="cm">|                     -3: The module is not a Chronometer module             |</span>
<span class="cm">|                     -4: Chronometer not initialised see function           |</span>
<span class="cm">|                         &quot;i_APCI1710_InitChrono&quot;                            |</span>
<span class="cm">|                     -5: Timeout parameter is wrong (0 to 65535)            |</span>
<span class="cm">|                     -6: Interrupt routine installed. You can not read      |</span>
<span class="cm">|                         directly the chronometer measured timing.          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_ReadChronoValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_TimeOut</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_ChronoStatus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pul_ChronoValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_TimeOut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Test if chronometer */</span>
	   <span class="cm">/***********************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_CHRONOMETER</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/***********************************/</span>
			<span class="cm">/* Test if chronometer initialised */</span>
	      <span class="cm">/***********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_ChronoModuleInfo</span><span class="p">.</span><span class="n">b_ChronoInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*****************************/</span>
				<span class="cm">/* Test the timout parameter */</span>
		 <span class="cm">/*****************************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ui_TimeOut</span> <span class="o">&lt;=</span> <span class="mi">65535UL</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			  <span class="cm">/*******************/</span>
						<span class="cm">/* Read the status */</span>
			  <span class="cm">/*******************/</span>

						<span class="n">dw_Status</span> <span class="o">=</span>
							<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
							<span class="n">s_BoardInfos</span><span class="p">.</span>
							<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span>
							<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			  <span class="cm">/********************/</span>
						<span class="cm">/* Test if overflow */</span>
			  <span class="cm">/********************/</span>

						<span class="k">if</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			     <span class="cm">/******************/</span>
							<span class="cm">/* Overflow occur */</span>
			     <span class="cm">/******************/</span>

							<span class="o">*</span><span class="n">pb_ChronoStatus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

			     <span class="cm">/***************************/</span>
							<span class="cm">/* Test if continuous mode */</span>
			     <span class="cm">/***************************/</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
								<span class="n">b_CycleMode</span> <span class="o">==</span>
								<span class="n">APCI1710_CONTINUOUS</span><span class="p">)</span>
							<span class="p">{</span>
				<span class="cm">/*************************/</span>
								<span class="cm">/* Clear status register */</span>
				<span class="cm">/*************************/</span>

								<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
							<span class="p">}</span>

							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 8) == 8) */</span>
						<span class="k">else</span> <span class="p">{</span>
			     <span class="cm">/*******************************/</span>
							<span class="cm">/* Test if measurement stopped */</span>
			     <span class="cm">/*******************************/</span>

							<span class="k">if</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span>
								<span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/***********************/</span>
								<span class="cm">/* A stop signal occur */</span>
				<span class="cm">/***********************/</span>

								<span class="o">*</span><span class="n">pb_ChronoStatus</span>
									<span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="cm">/***************************/</span>
								<span class="cm">/* Test if continnous mode */</span>
				<span class="cm">/***************************/</span>

								<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_ChronoModuleInfo</span><span class="p">.</span>
									<span class="n">b_CycleMode</span>
									<span class="o">==</span>
									<span class="n">APCI1710_CONTINUOUS</span><span class="p">)</span>
								<span class="p">{</span>
				   <span class="cm">/*************************/</span>
									<span class="cm">/* Clear status register */</span>
				   <span class="cm">/*************************/</span>

									<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
								<span class="p">}</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 2) == 2) */</span>
							<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*******************************/</span>
								<span class="cm">/* Test if measurement started */</span>
				<span class="cm">/*******************************/</span>

								<span class="k">if</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				   <span class="cm">/************************/</span>
									<span class="cm">/* A start signal occur */</span>
				   <span class="cm">/************************/</span>

									<span class="o">*</span><span class="n">pb_ChronoStatus</span>
										<span class="o">=</span>
										<span class="mi">1</span><span class="p">;</span>
								<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 1) == 1) */</span>
								<span class="k">else</span> <span class="p">{</span>
				   <span class="cm">/***************************/</span>
									<span class="cm">/* Measurement not started */</span>
				   <span class="cm">/***************************/</span>

									<span class="o">*</span><span class="n">pb_ChronoStatus</span>
										<span class="o">=</span>
										<span class="mi">0</span><span class="p">;</span>
								<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 1) == 1) */</span>
							<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 2) == 2) */</span>
						<span class="p">}</span>	<span class="cm">/*  if ((dw_Status &amp; 8) == 8) */</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">dw_TimeOut</span> <span class="o">==</span> <span class="n">ui_TimeOut</span><span class="p">)</span> <span class="p">{</span>
			     <span class="cm">/*****************/</span>
							<span class="cm">/* Timeout occur */</span>
			     <span class="cm">/*****************/</span>

							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			     <span class="cm">/*************************/</span>
							<span class="cm">/* Increment the timeout */</span>
			     <span class="cm">/*************************/</span>

							<span class="n">dw_TimeOut</span> <span class="o">=</span>
								<span class="n">dw_TimeOut</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

						<span class="p">}</span>
					<span class="p">}</span>	<span class="cm">/*  for (;;) */</span>

		       <span class="cm">/*****************************/</span>
					<span class="cm">/* Test if stop signal occur */</span>
		       <span class="cm">/*****************************/</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pb_ChronoStatus</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			  <span class="cm">/**********************************/</span>
						<span class="cm">/* Read the measured timing value */</span>
			  <span class="cm">/**********************************/</span>

						<span class="o">*</span><span class="n">pul_ChronoValue</span> <span class="o">=</span>
							<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
							<span class="n">s_BoardInfos</span><span class="p">.</span>
							<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span>
							<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

						<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pul_ChronoValue</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="o">*</span><span class="n">pul_ChronoValue</span> <span class="o">=</span>
								<span class="o">*</span><span class="n">pul_ChronoValue</span>
								<span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			  <span class="cm">/*************************/</span>
						<span class="cm">/* Test if timeout occur */</span>
			  <span class="cm">/*************************/</span>

						<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pb_ChronoStatus</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dw_TimeOut</span> <span class="o">==</span>
								<span class="n">ui_TimeOut</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ui_TimeOut</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			     <span class="cm">/*****************/</span>
							<span class="cm">/* Timeout occur */</span>
			     <span class="cm">/*****************/</span>

							<span class="o">*</span><span class="n">pb_ChronoStatus</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/******************************/</span>
					<span class="cm">/* Timeout parameter is wrong */</span>
		    <span class="cm">/******************************/</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timeout parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*******************************/</span>
				<span class="cm">/* Chronometer not initialised */</span>
		 <span class="cm">/*******************************/</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Chronometer not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/******************************************/</span>
			<span class="cm">/* The module is not a Chronometer module */</span>
	      <span class="cm">/******************************************/</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a Chronometer module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Module number error */</span>
	   <span class="cm">/***********************/</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_ConvertChronoValue                    |</span>
<span class="cm">|                               (unsigned char_     b_BoardHandle,                    |</span>
<span class="cm">|                                unsigned char_     b_ModulNbr,                       |</span>
<span class="cm">|                                ULONG_   ul_ChronoValue,                    |</span>
<span class="cm">|                                PULONG_ pul_Hour,                           |</span>
<span class="cm">|                                unsigned char *_   pb_Minute,                         |</span>
<span class="cm">|                                unsigned char *_   pb_Second,                         |</span>
<span class="cm">|                                unsigned int *_  pui_MilliSecond,                    |</span>
<span class="cm">|                                unsigned int *_  pui_MicroSecond,                    |</span>
<span class="cm">|                                unsigned int *_  pui_NanoSecond)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Convert the chronometer measured timing                |</span>
<span class="cm">|                     (ul_ChronoValue) in to h, mn, s, ms, µs, ns.           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_   b_BoardHandle : Handle of board APCI-1710      |</span>
<span class="cm">|                     unsigned char_   b_ModulNbr    : Selected module number (0 to 3)|</span>
<span class="cm">|                     ULONG_ ul_ChronoValue : Measured chronometer timing    |</span>
<span class="cm">|                                             value.                         |</span>
<span class="cm">|                                             See&quot;i_APCI1710_ReadChronoValue&quot;|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : PULONG_   pul_Hour        : Chronometer timing hour    |</span>
<span class="cm">|                     unsigned char *_     pb_Minute      : Chronometer timing minute  |</span>
<span class="cm">|                     unsigned char *_     pb_Second      : Chronometer timing second  |</span>
<span class="cm">|                     unsigned int *_    pui_MilliSecond  : Chronometer timing mini   |</span>
<span class="cm">|                                                 second                     |</span>
<span class="cm">|                     unsigned int *_    pui_MicroSecond : Chronometer timing micro   |</span>
<span class="cm">|                                                 second                     |</span>
<span class="cm">|                     unsigned int *_    pui_NanoSecond  : Chronometer timing nano    |</span>
<span class="cm">|                                                 second                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: Module selection wrong                             |</span>
<span class="cm">|                     -3: The module is not a Chronometer module             |</span>
<span class="cm">|                     -4: Chronometer not initialised see function           |</span>
<span class="cm">|                         &quot;i_APCI1710_InitChrono&quot;                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_ConvertChronoValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_ChronoValue</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pul_Hour</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_Minute</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_Second</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pui_MilliSecond</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pui_MicroSecond</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pui_NanoSecond</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">d_Hour</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">d_Minute</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">d_Second</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">d_MilliSecond</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">d_MicroSecond</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">d_NanoSecond</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Test if chronometer */</span>
	   <span class="cm">/***********************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_CHRONOMETER</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/***********************************/</span>
			<span class="cm">/* Test if chronometer initialised */</span>
	      <span class="cm">/***********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_ChronoModuleInfo</span><span class="p">.</span><span class="n">b_ChronoInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fpu_begin</span><span class="p">();</span>

				<span class="n">d_Hour</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_ChronoValue</span> <span class="o">*</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_ChronoModuleInfo</span><span class="p">.</span><span class="n">d_TimingInterval</span><span class="p">;</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_ChronoModuleInfo</span><span class="p">.</span><span class="n">b_TimingUnit</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">d_Hour</span> <span class="o">=</span> <span class="n">d_Hour</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="mf">1000.0</span><span class="p">;</span>

				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">d_Hour</span> <span class="o">=</span> <span class="n">d_Hour</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="mf">1000.0</span><span class="p">;</span>

				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">d_Hour</span> <span class="o">=</span> <span class="n">d_Hour</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="mf">1000.0</span><span class="p">;</span>

				<span class="k">case</span> <span class="mi">3</span>:
					<span class="n">d_Hour</span> <span class="o">=</span> <span class="n">d_Hour</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="mf">60.0</span><span class="p">;</span>

				<span class="k">case</span> <span class="mi">4</span>:
			    <span class="cm">/**********************/</span>
					<span class="cm">/* Calculate the hour */</span>
			    <span class="cm">/**********************/</span>

					<span class="n">d_Hour</span> <span class="o">=</span> <span class="n">d_Hour</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="mf">60.0</span><span class="p">;</span>
					<span class="o">*</span><span class="n">pul_Hour</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">d_Hour</span><span class="p">;</span>

			    <span class="cm">/************************/</span>
					<span class="cm">/* Calculate the minute */</span>
			    <span class="cm">/************************/</span>

					<span class="n">d_Minute</span> <span class="o">=</span> <span class="n">d_Hour</span> <span class="o">-</span> <span class="o">*</span><span class="n">pul_Hour</span><span class="p">;</span>
					<span class="n">d_Minute</span> <span class="o">=</span> <span class="n">d_Minute</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
					<span class="o">*</span><span class="n">pb_Minute</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">d_Minute</span><span class="p">;</span>

			    <span class="cm">/************************/</span>
					<span class="cm">/* Calculate the second */</span>
			    <span class="cm">/************************/</span>

					<span class="n">d_Second</span> <span class="o">=</span> <span class="n">d_Minute</span> <span class="o">-</span> <span class="o">*</span><span class="n">pb_Minute</span><span class="p">;</span>
					<span class="n">d_Second</span> <span class="o">=</span> <span class="n">d_Second</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
					<span class="o">*</span><span class="n">pb_Second</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">d_Second</span><span class="p">;</span>

			    <span class="cm">/*****************************/</span>
					<span class="cm">/* Calculate the mini second */</span>
			    <span class="cm">/*****************************/</span>

					<span class="n">d_MilliSecond</span> <span class="o">=</span> <span class="n">d_Second</span> <span class="o">-</span> <span class="o">*</span><span class="n">pb_Second</span><span class="p">;</span>
					<span class="n">d_MilliSecond</span> <span class="o">=</span> <span class="n">d_MilliSecond</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
					<span class="o">*</span><span class="n">pui_MilliSecond</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">d_MilliSecond</span><span class="p">;</span>

			    <span class="cm">/******************************/</span>
					<span class="cm">/* Calculate the micro second */</span>
			    <span class="cm">/******************************/</span>

					<span class="n">d_MicroSecond</span> <span class="o">=</span>
						<span class="n">d_MilliSecond</span> <span class="o">-</span>
						<span class="o">*</span><span class="n">pui_MilliSecond</span><span class="p">;</span>
					<span class="n">d_MicroSecond</span> <span class="o">=</span> <span class="n">d_MicroSecond</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
					<span class="o">*</span><span class="n">pui_MicroSecond</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">d_MicroSecond</span><span class="p">;</span>

			    <span class="cm">/******************************/</span>
					<span class="cm">/* Calculate the micro second */</span>
			    <span class="cm">/******************************/</span>

					<span class="n">d_NanoSecond</span> <span class="o">=</span>
						<span class="n">d_MicroSecond</span> <span class="o">-</span>
						<span class="o">*</span><span class="n">pui_MicroSecond</span><span class="p">;</span>
					<span class="n">d_NanoSecond</span> <span class="o">=</span> <span class="n">d_NanoSecond</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
					<span class="o">*</span><span class="n">pui_NanoSecond</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">d_NanoSecond</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">fpu_end</span><span class="p">();</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*******************************/</span>
				<span class="cm">/* Chronometer not initialised */</span>
		 <span class="cm">/*******************************/</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Chronometer not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/******************************************/</span>
			<span class="cm">/* The module is not a Chronometer module */</span>
	      <span class="cm">/******************************************/</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a Chronometer module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Module number error */</span>
	   <span class="cm">/***********************/</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : int i_APCI1710_InsnBitsChronoDigitalIO(struct comedi_device *dev,struct comedi_subdevice *s,</span>
<span class="cm">	struct comedi_insn *insn,unsigned int *data)                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Sets the output witch has been passed with the         |</span>
<span class="cm">|                     parameter b_Channel. Setting an output means setting an|</span>
<span class="cm">|                     output high.                                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle   : Handle of board APCI-1710      |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr      : Selected module number (0 to 3)|</span>
<span class="cm">|                     unsigned char_ b_OutputChannel : Selection from digital output  |</span>
<span class="cm">|                           CR_CHAN()                  channel (0 to 2)               |</span>
<span class="cm">|                                              0 : Channel H                 |</span>
<span class="cm">|                                              1 : Channel A                 |</span>
<span class="cm">|                                              2 : Channel B                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: Module selection wrong                             |</span>
<span class="cm">|                     -3: The module is not a Chronometer module             |</span>
<span class="cm">|                     -4: The selected digital output is wrong               |</span>
<span class="cm">|                     -5: Chronometer not initialised see function           |</span>
<span class="cm">|                         &quot;i_APCI1710_InitChrono&quot;                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_SetChronoChlOff                       |</span>
<span class="cm">|                               (unsigned char_  b_BoardHandle,                       |</span>
<span class="cm">|                                unsigned char_  b_ModulNbr,                          |</span>
<span class="cm">|                                unsigned char_  b_OutputChannel)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Resets the output witch has been passed with the       |</span>
<span class="cm">|                     parameter b_Channel. Resetting an output means setting |</span>
<span class="cm">|                     an output low.                                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle   : Handle of board APCI-1710</span>
<span class="cm">                        data[0] : Chl ON, Chl OFF , Chl Read , Port Read</span>

<span class="cm">|                     unsigned char_ b_ModulNbr  CR_AREF    : Selected module number (0 to 3)|</span>
<span class="cm">|                     unsigned char_ b_OutputChannel CR_CHAN : Selection from digital output  |</span>
<span class="cm">|                                             channel (0 to 2)               |</span>
<span class="cm">|                                              0 : Channel H                 |</span>
<span class="cm">|                                              1 : Channel A                 |</span>
<span class="cm">|                                              2 : Channel B                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: Module selection wrong                             |</span>
<span class="cm">|                     -3: The module is not a Chronometer module             |</span>
<span class="cm">|                     -4: The selected digital output is wrong               |</span>
<span class="cm">|                     -5: Chronometer not initialised see function           |</span>
<span class="cm">|                         &quot;i_APCI1710_InitChrono&quot;                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_ReadChronoChlValue                    |</span>
<span class="cm">|                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">|                                unsigned char_   b_ModulNbr,                         |</span>
<span class="cm">|                                unsigned char_   b_InputChannel,                     |</span>
<span class="cm">|                                unsigned char *_ pb_ChannelStatus)                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the status from selected digital input          |</span>
<span class="cm">|                     (b_InputChannel) from selected chronometer             |</span>
<span class="cm">|                     module (b_ModulNbr).                                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle   : Handle of board APCI-1710      |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr      : Selected module number (0 to 3)|</span>
<span class="cm">|                     unsigned char_ b_InputChannel  : Selection from digital input   |</span>
<span class="cm">|                                             channel (0 to 2)               |</span>
<span class="cm">|                                   CR_CHAN()             0 : Channel E               |</span>
<span class="cm">|                                                1 : Channel F               |</span>
<span class="cm">|                                                2 : Channel G               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_ChannelStatus : Digital input channel status.|</span>
<span class="cm">|                                data[0]                0 : Channel is not active   |</span>
<span class="cm">|                                                1 : Channel is active       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: Module selection wrong                             |</span>
<span class="cm">|                     -3: The module is not a Chronometer module             |</span>
<span class="cm">|                     -4: The selected digital input is wrong                |</span>
<span class="cm">|                     -5: Chronometer not initialised see function           |</span>
<span class="cm">|                         &quot;i_APCI1710_InitChrono&quot;                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_ReadChronoPortValue                   |</span>
<span class="cm">|                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">|                                unsigned char_   b_ModulNbr,                         |</span>
<span class="cm">|                                unsigned char *_ pb_PortValue)                        |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the status from digital inputs port from        |</span>
<span class="cm">|                     selected  (b_ModulNbr) chronometer module.             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle   : Handle of board APCI-1710      |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr      : Selected module number (0 to 3)|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_PortValue   : Digital inputs port status.</span>
<span class="cm">|                     data[0]</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: Module selection wrong                             |</span>
<span class="cm">|                     -3: The module is not a Chronometer module             |</span>
<span class="cm">|                     -4: Chronometer not initialised see function           |</span>
<span class="cm">|                         &quot;i_APCI1710_InitChrono&quot;                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InsnBitsChronoDigitalIO</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="n">b_OutputChannel</span><span class="p">,</span> <span class="n">b_InputChannel</span><span class="p">,</span> <span class="n">b_IOType</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_ChannelStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_PortValue</span><span class="p">;</span>

	<span class="n">b_ModulNbr</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="n">b_IOType</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Test if chronometer */</span>
	   <span class="cm">/***********************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_CHRONOMETER</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/***********************************/</span>
			<span class="cm">/* Test if chronometer initialised */</span>
	      <span class="cm">/***********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_ChronoModuleInfo</span><span class="p">.</span><span class="n">b_ChronoInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/***********************************/</span>
				<span class="cm">/* Test the digital output channel */</span>
		 <span class="cm">/***********************************/</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">b_IOType</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">case</span> <span class="n">APCI1710_CHRONO_SET_CHANNELOFF</span>:

					<span class="n">b_OutputChannel</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">b_OutputChannel</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
							<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
							<span class="p">(</span><span class="n">b_OutputChannel</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
							<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
					<span class="p">}</span>	<span class="cm">/*  if ((b_OutputChannel &gt;= 0) &amp;&amp; (b_OutputChannel &lt;= 2)) */</span>
					<span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/****************************************/</span>
						<span class="cm">/* The selected digital output is wrong */</span>
		    <span class="cm">/****************************************/</span>

						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected digital output is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>

					<span class="p">}</span>	<span class="cm">/*  if ((b_OutputChannel &gt;= 0) &amp;&amp; (b_OutputChannel &lt;= 2)) */</span>

					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">APCI1710_CHRONO_SET_CHANNELON</span>:

					<span class="n">b_OutputChannel</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">b_OutputChannel</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
							<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
							<span class="p">(</span><span class="n">b_OutputChannel</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
							<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
					<span class="p">}</span>	<span class="cm">/*  if ((b_OutputChannel &gt;= 0) &amp;&amp; (b_OutputChannel &lt;= 2)) */</span>
					<span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/****************************************/</span>
						<span class="cm">/* The selected digital output is wrong */</span>
		    <span class="cm">/****************************************/</span>

						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected digital output is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>

					<span class="p">}</span>	<span class="cm">/*  if ((b_OutputChannel &gt;= 0) &amp;&amp; (b_OutputChannel &lt;= 2)) */</span>

					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">APCI1710_CHRONO_READ_CHANNEL</span>:
		 <span class="cm">/**********************************/</span>
					<span class="cm">/* Test the digital input channel */</span>
		 <span class="cm">/**********************************/</span>
					<span class="n">pb_ChannelStatus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="n">b_InputChannel</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">b_InputChannel</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">dw_Status</span> <span class="o">=</span>
							<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
							<span class="n">s_BoardInfos</span><span class="p">.</span>
							<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span>
							<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

						<span class="o">*</span><span class="n">pb_ChannelStatus</span> <span class="o">=</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(((</span><span class="n">dw_Status</span> <span class="o">&gt;&gt;</span>
									<span class="n">b_InputChannel</span><span class="p">)</span>
								<span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>	<span class="cm">/*  if ((b_InputChannel &gt;= 0) &amp;&amp; (b_InputChannel &lt;= 2)) */</span>
					<span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/***************************************/</span>
						<span class="cm">/* The selected digital input is wrong */</span>
		    <span class="cm">/***************************************/</span>

						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected digital input is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
					<span class="p">}</span>	<span class="cm">/*  if ((b_InputChannel &gt;= 0) &amp;&amp; (b_InputChannel &lt;= 2)) */</span>

					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">APCI1710_CHRONO_READ_PORT</span>:

					<span class="n">pb_PortValue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

					<span class="n">dw_Status</span> <span class="o">=</span>
						<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
						<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span>
						<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

					<span class="o">*</span><span class="n">pb_PortValue</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">^</span> <span class="mi">7</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*******************************/</span>
				<span class="cm">/* Chronometer not initialised */</span>
		 <span class="cm">/*******************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Chronometer not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/******************************************/</span>
			<span class="cm">/* The module is not a Chronometer module */</span>
	      <span class="cm">/******************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a Chronometer module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***********************/</span>
		<span class="cm">/* Module number error */</span>
	   <span class="cm">/***********************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
