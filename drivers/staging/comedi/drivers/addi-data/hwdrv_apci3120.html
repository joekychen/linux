<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › addi-data › hwdrv_apci3120.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>hwdrv_apci3120.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm">@verbatim</span>

<span class="cm">Copyright (C) 2004,2005  ADDI-DATA GmbH for the source code of this module.</span>

<span class="cm">	ADDI-DATA GmbH</span>
<span class="cm">	Dieselstrasse 3</span>
<span class="cm">	D-77833 Ottersweier</span>
<span class="cm">	Tel: +19(0)7223/9493-0</span>
<span class="cm">	Fax: +49(0)7223/9493-92</span>
<span class="cm">	http://www.addi-data.com</span>
<span class="cm">	info@addi-data.com</span>

<span class="cm">This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</span>

<span class="cm">This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</span>

<span class="cm">You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>

<span class="cm">You should also find the complete GPL in the COPYING file accompanying this source code.</span>

<span class="cm">@endverbatim</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | (C) ADDI-DATA GmbH          Dieselstrasse 3      D-77833 Ottersweier  |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Tel : +49 (0) 7223/9493-0     | email    : info@addi-data.com         |</span>
<span class="cm">  | Fax : +49 (0) 7223/9493-92    | Internet : http://www.addi-data.com   |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Project     : APCI-3120       | Compiler   : GCC                      |</span>
<span class="cm">  | Module name : hwdrv_apci3120.c| Version    : 2.96                     |</span>
<span class="cm">  +-------------------------------+---------------------------------------+</span>
<span class="cm">  | Project manager: Eric Stolz   | Date       :  02/12/2002              |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Description :APCI3120 Module.  Hardware abstraction Layer for APCI3120|</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  |                             UPDATE&#39;S                                  |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  |   Date   |   Author  |          Description of updates                |</span>
<span class="cm">  +----------+-----------+------------------------------------------------+</span>
<span class="cm">  |          | 		 | 						  |</span>
<span class="cm">  |          |           |						  |</span>
<span class="cm">  +----------+-----------+------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;hwdrv_apci3120.h&quot;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_Temp</span><span class="p">;</span>

<span class="cm">/* FUNCTION DEFINITIONS */</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                           ANALOG INPUT SUBDEVICE   		                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InsnConfigAnalogInput(struct comedi_device *dev,|</span>
<span class="cm">|  struct comedi_subdevice *s,struct comedi_insn *insn,unsigned int *data)					 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Calls card specific function  					     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data      					         		 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_InsnConfigAnalogInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">APCI3120_EOC_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">APCI3120_EOS_MODE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*  Check for Conversion time to be added ?? */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_EocEosConversionTime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">APCI3120_EOS_MODE</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Test the number of the channel */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="o">&gt;=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">i_NbrAiChannel</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bad channel list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">=</span> <span class="n">APCI3120_EOS_MODE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_ENABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
		<span class="cm">/*  Copy channel list and Range List to devpriv */</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiChannelList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/*  EOC */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">=</span> <span class="n">APCI3120_EOC_MODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_ENABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InsnReadAnalogInput(struct comedi_device *dev,  |</span>
<span class="cm">|			struct comedi_subdevice *s,struct comedi_insn *insn, unsigned int *data)	 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              :  card specific function								 |</span>
<span class="cm">|				Reads analog input in synchronous mode               |</span>
<span class="cm">|			  EOC and EOS is selected as per configured              |</span>
<span class="cm">|                     if no conversion time is set uses default conversion   |</span>
<span class="cm">|			  time 10 microsec.					      				 |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data     									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_InsnReadAnalogInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">us_ConvertTiming</span><span class="p">,</span> <span class="n">us_TmpValue</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Tmp</span><span class="p">;</span>

	<span class="cm">/*  fix conversion time to 10 us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_EocEosConversionTime</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;No timer0 Value using 10 us</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">us_ConvertTiming</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">us_ConvertTiming</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_EocEosConversionTime</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>	<span class="cm">/*  nano to useconds */</span>

	<span class="cm">/*  this_board-&gt;ai_read(dev,us_ConvertTiming,insn-&gt;n,&amp;insn-&gt;chanspec,data,insn-&gt;unused[0]); */</span>

	<span class="cm">/*  Clear software registers */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* devpriv-&gt;b_DigitalOutputRegister=0; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">unused</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">222</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  second insn read */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiReadData</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>	<span class="cm">/*  Save the current process task structure */</span>
<span class="cm">/*</span>
<span class="cm"> * Testing if board have the new Quartz and calculate the time value</span>
<span class="cm"> * to set in the timer</span>
<span class="cm"> */</span>

		<span class="n">us_TmpValue</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>

		<span class="cm">/* EL250804: Testing if board APCI3120 have the new Quartz or if it is an APCI3001 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">us_TmpValue</span> <span class="o">&amp;</span> <span class="mh">0x00B0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00B0</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">pc_DriverName</span><span class="p">,</span> <span class="s">&quot;apci3001&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">us_ConvertTiming</span> <span class="o">=</span> <span class="p">(</span><span class="n">us_ConvertTiming</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">us_ConvertTiming</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">us_ConvertTiming</span> <span class="o">*</span> <span class="mi">12926</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">us_TmpValue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">us_TmpValue</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">APCI3120_EOC_MODE</span>:

<span class="cm">/*</span>
<span class="cm"> * Testing the interrupt flag and set the EOC bit Clears the FIFO</span>
<span class="cm"> */</span>
			<span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RESET_FIFO</span><span class="p">);</span>

			<span class="cm">/*  Initialize the sequence array */</span>

			<span class="cm">/* if (!i_APCI3120_SetupChannelList(dev,s,1,chanlist,0))  return -EINVAL; */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i_APCI3120_SetupChannelList</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="cm">/* Initialize Timer 0 mode 4 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_TimerSelectMode</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_TIMER_0_MODE_4</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT1</span><span class="p">);</span>

			<span class="cm">/*  Reset the scan bit and Disables the  EOS, DMA, EOC interrupt */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_SCAN</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">==</span> <span class="n">APCI3120_ENABLE</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* Disables the EOS,DMA and enables the EOC interrupt */</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
					<span class="n">APCI3120_DISABLE_EOS_INT</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">APCI3120_ENABLE_EOC_INT</span><span class="p">;</span>
				<span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
					<span class="n">APCI3120_DISABLE_ALL_INTERRUPT_WITHOUT_TIMER</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

			<span class="cm">/*  Sets gate 0 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">us_OutputRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_CLEAR_PA_PR</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_ENABLE_TIMER0</span><span class="p">;</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

			<span class="cm">/*  Select Timer 0 */</span>
			<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_SELECT_TIMER_0_WORD</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>

			<span class="cm">/* Set the conversion time */</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">us_ConvertTiming</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

			<span class="n">us_TmpValue</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">==</span> <span class="n">APCI3120_DISABLE</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">do</span> <span class="p">{</span>
					<span class="cm">/*  Waiting for the end of conversion */</span>
					<span class="n">us_TmpValue</span> <span class="o">=</span>
						<span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">us_TmpValue</span> <span class="o">&amp;</span> <span class="n">APCI3120_EOC</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">APCI3120_EOC</span><span class="p">);</span>

				<span class="cm">/* Read the result in FIFO  and put it in insn data pointer */</span>
				<span class="n">us_TmpValue</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">us_TmpValue</span><span class="p">;</span>

				<span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RESET_FIFO</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">APCI3120_EOS_MODE</span>:

			<span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
			<span class="cm">/*  Clears the FIFO */</span>
			<span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RESET_FIFO</span><span class="p">);</span>
			<span class="cm">/*  clear PA PR  and disable timer 0 */</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">us_OutputRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_CLEAR_PA_PR</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_DISABLE_TIMER0</span><span class="p">;</span>

			<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i_APCI3120_SetupChannelList</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiChannelList</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="cm">/* Initialize Timer 0 mode 2 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_TimerSelectMode</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_TIMER_0_MODE_2</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT1</span><span class="p">);</span>

			<span class="cm">/* Select Timer 0 */</span>
			<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_SELECT_TIMER_0_WORD</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>

			<span class="cm">/* Set the conversion time */</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">us_ConvertTiming</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

			<span class="cm">/* Set the scan bit */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">|</span> <span class="n">APCI3120_ENABLE_SCAN</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

			<span class="cm">/* If Interrupt function is loaded */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">==</span> <span class="n">APCI3120_ENABLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Disables the EOC,DMA and enables the EOS interrupt */</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
					<span class="n">APCI3120_DISABLE_EOC_INT</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">APCI3120_ENABLE_EOS_INT</span><span class="p">;</span>
				<span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
					<span class="n">APCI3120_DISABLE_ALL_INTERRUPT_WITHOUT_TIMER</span><span class="p">;</span>

			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

			<span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>

			<span class="cm">/* Sets gate 0 */</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">us_OutputRegister</span> <span class="o">|</span> <span class="n">APCI3120_ENABLE_TIMER0</span><span class="p">;</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

			<span class="cm">/* Start conversion */</span>
			<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_START_CONVERSION</span><span class="p">);</span>

			<span class="cm">/* Waiting of end of conversion if interrupt is not installed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">==</span> <span class="n">APCI3120_DISABLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Waiting the end of conversion */</span>
				<span class="k">do</span> <span class="p">{</span>
					<span class="n">us_TmpValue</span> <span class="o">=</span>
						<span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">us_TmpValue</span> <span class="o">&amp;</span> <span class="n">APCI3120_EOS</span><span class="p">)</span> <span class="o">!=</span>
					 <span class="n">APCI3120_EOS</span><span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span><span class="p">;</span>
					<span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Read the result in FIFO and write them in shared memory */</span>
					<span class="n">us_TmpValue</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
					<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">us_TmpValue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">=</span> <span class="n">APCI3120_EOC_MODE</span><span class="p">;</span>	<span class="cm">/*  Restore defaults. */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;inputs wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_EocEosConversionTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  re initializing the variable; */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_StopCyclicAcquisition(struct comedi_device *dev,|</span>
<span class="cm">| 											     struct comedi_subdevice *s)|</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Stops Cyclic acquisition  						     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                                                 					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :0              					                     |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_StopCyclicAcquisition</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  Disable A2P Fifo write and AMWEN signal */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Disable Bus Master ADD ON */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_AGCSTS_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_AGCSTS_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Disable BUS Master PCI */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MCSR</span><span class="p">);</span>

	<span class="cm">/* outl(inl(devpriv-&gt;i_IobaseAmcc+AMCC_OP_REG_INTCSR)&amp;(~AINT_WRITE_COMPL),</span>
<span class="cm">	 * devpriv-&gt;i_IobaseAmcc+AMCC_OP_REG_INTCSR);  stop amcc irqs */</span>

	<span class="cm">/* outl(inl(devpriv-&gt;i_IobaseAmcc+AMCC_OP_REG_MCSR)&amp;(~EN_A2P_TRANSFERS),</span>
<span class="cm">	 * devpriv-&gt;i_IobaseAmcc+AMCC_OP_REG_MCSR);  stop DMA */</span>

	<span class="cm">/* Disable ext trigger */</span>
	<span class="n">i_APCI3120_ExttrigDisable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* stop  counters */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
		<span class="n">us_OutputRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_TIMER0</span> <span class="o">&amp;</span>
		<span class="n">APCI3120_DISABLE_TIMER1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_DISABLE_ALL_TIMER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

	<span class="cm">/* DISABLE_ALL_INTERRUPT */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">APCI3120_DISABLE_ALL_INTERRUPT</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>
	<span class="cm">/* Flush FIFO */</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RESET_FIFO</span><span class="p">);</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiActualScan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiActualScanPosition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiBufferPtr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiContinuous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaActualBuffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiCyclicAcquisition</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">=</span> <span class="n">APCI3120_EOC_MODE</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
	<span class="n">i_APCI3120_Reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_CommandTestAnalogInput(struct comedi_device *dev|</span>
<span class="cm">|			,struct comedi_subdevice *s,struct comedi_cmd *cmd)					 |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Test validity for a command for cyclic anlog input     |</span>
<span class="cm">|                       acquisition  						     			 |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_cmd *cmd              					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :0              					                     |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_CommandTestAnalogInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>		<span class="cm">/*  divisor1,divisor2; */</span>

	<span class="cm">/*  step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* step 2: make sure trigger sources are unique and mutually compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*  step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  Test Delay timing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">ui_MinDelaytimeNs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">ui_MinDelaytimeNs</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  Test Acquisition timing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span>
						<span class="n">ui_MinAcquisitiontimeNs</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span>
					<span class="n">ui_MinAcquisitiontimeNs</span><span class="p">;</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">ui_MinAcquisitiontimeNs</span>
				<span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span>
					<span class="n">ui_MinAcquisitiontimeNs</span><span class="p">;</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">i_AiChannelList</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">i_AiChannelList</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/*  TRIG_NONE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/*  step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     : int i_APCI3120_CommandAnalogInput(struct comedi_device *dev,  |</span>
<span class="cm">|												struct comedi_subdevice *s) |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Does asynchronous acquisition                          |</span>
<span class="cm">|                     Determines the mode 1 or 2.						     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     														 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_CommandAnalogInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* loading private structure with cmd structure inputs */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiFlags</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pui_AiChannelList</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">;</span>

	<span class="cm">/* UPDATE-0.7.57-&gt;0.7.68devpriv-&gt;AiData=s-&gt;async-&gt;data; */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AiData</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_buf</span><span class="p">;</span>
	<span class="cm">/* UPDATE-0.7.57-&gt;0.7.68devpriv-&gt;ui_AiDataLength=s-&gt;async-&gt;data_len; */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiDataLength</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiTimer0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  variables changed to timer0,timer1 */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiTimer1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiContinuous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/*  user want neverending analog acquisition */</span>
	<span class="cm">/*  stopped using cancel */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ExttrigEnable</span> <span class="o">=</span> <span class="n">APCI3120_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ExttrigEnable</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  mode 1 or 3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  mode 1 */</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiTimer0</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>	<span class="cm">/*  timer constant in nano seconds */</span>
			<span class="cm">/* return this_board-&gt;ai_cmd(1,dev,s); */</span>
			<span class="k">return</span> <span class="n">i_APCI3120_CyclicAnalogInput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  mode 2 */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiTimer1</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiTimer0</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>	<span class="cm">/*  variable changed timer2 to timer0 */</span>
		<span class="cm">/* return this_board-&gt;ai_cmd(2,dev,s); */</span>
		<span class="k">return</span> <span class="n">i_APCI3120_CyclicAnalogInput</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :  int i_APCI3120_CyclicAnalogInput(int mode,            |</span>
<span class="cm">|		 	   struct comedi_device * dev,struct comedi_subdevice * s)			 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : This is used for analog input cyclic acquisition       |</span>
<span class="cm">|			  Performs the command operations.                       |</span>
<span class="cm">|			  If DMA is configured does DMA initialization           |</span>
<span class="cm">|			  otherwise does the acquisition with EOS interrupt.     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : 														 |</span>
<span class="cm">|                     														 |</span>
<span class="cm">|                                                 					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_CyclicAnalogInput</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_Tmp</span><span class="p">,</span> <span class="n">ui_DelayTiming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ui_TimerValue1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dmalen0</span> <span class="o">=</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">dmalen1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ui_TimerValue2</span> <span class="o">=</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">ui_TimerValue0</span><span class="p">,</span> <span class="n">ui_ConvertTiming</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">us_TmpValue</span><span class="p">;</span>

	<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
	<span class="cm">/* devpriv-&gt;b_AiCyclicAcquisition=APCI3120_ENABLE; */</span>
	<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

	<span class="cm">/*******************/</span>
	<span class="cm">/* Resets the FIFO */</span>
	<span class="cm">/*******************/</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RESET_FIFO</span><span class="p">);</span>

	<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
	<span class="cm">/* inw(dev-&gt;iobase+APCI3120_RD_STATUS); */</span>
	<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

	<span class="cm">/***************************/</span>
	<span class="cm">/* Acquisition initialized */</span>
	<span class="cm">/***************************/</span>
	<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiCyclicAcquisition</span> <span class="o">=</span> <span class="n">APCI3120_ENABLE</span><span class="p">;</span>
	<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

	<span class="cm">/*  clear software  registers */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* devpriv-&gt;b_DigitalOutputRegister=0; */</span>

	<span class="cm">/* COMMENT JK 07.05.04: Followings calls are in i_APCI3120_StartAnalogInputAcquisition */</span>

	<span class="cm">/****************************/</span>
	<span class="cm">/* Clear Timer Write TC int */</span>
	<span class="cm">/****************************/</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">APCI3120_CLEAR_WRITE_TC_INT</span><span class="p">,</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">APCI3120_AMCC_OP_REG_INTCSR</span><span class="p">);</span>

	<span class="cm">/************************************/</span>
	<span class="cm">/* Clears the timer status register */</span>
	<span class="cm">/************************************/</span>

	<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
	<span class="cm">/* inw(dev-&gt;iobase+APCI3120_TIMER_STATUS_REGISTER); */</span>
	<span class="cm">/* inb(dev-&gt;iobase + APCI3120_TIMER_STATUS_REGISTER); */</span>
	<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Disables All Timer     */</span>
	<span class="cm">/* Sets PR and PA to 0    */</span>
	<span class="cm">/**************************/</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">&amp;</span>
		<span class="n">APCI3120_DISABLE_TIMER0</span> <span class="o">&amp;</span>
		<span class="n">APCI3120_DISABLE_TIMER1</span> <span class="o">&amp;</span> <span class="n">APCI3120_CLEAR_PA_PR</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

	<span class="cm">/*******************/</span>
	<span class="cm">/* Resets the FIFO */</span>
	<span class="cm">/*******************/</span>
	<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RESET_FIFO</span><span class="p">);</span>
	<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiActualScan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiActualScanPosition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiBufferPtr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaActualBuffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*  value for timer2  minus -2 has to be done .....dunno y?? */</span>
	<span class="n">ui_TimerValue2</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ui_ConvertTiming</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiTimer0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ui_DelayTiming</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiTimer1</span><span class="p">;</span>

   <span class="cm">/**********************************/</span>
	<span class="cm">/* Initializes the sequence array */</span>
   <span class="cm">/**********************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i_APCI3120_SetupChannelList</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pui_AiChannelList</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">us_TmpValue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>
<span class="cm">/*** EL241003 : add this section in comment because floats must not be used</span>
<span class="cm">	if((us_TmpValue &amp; 0x00B0)==0x00B0)</span>
<span class="cm">	 {</span>
<span class="cm">		f_ConvertValue=(((float)ui_ConvertTiming * 0.002) - 2);</span>
<span class="cm">		ui_TimerValue0=(unsigned int)f_ConvertValue;</span>
<span class="cm">		if (mode==2)</span>
<span class="cm">		{</span>
<span class="cm">			f_DelayValue     = (((float)ui_DelayTiming * 0.00002) - 2);</span>
<span class="cm">			ui_TimerValue1  =   (unsigned int) f_DelayValue;</span>
<span class="cm">		}</span>
<span class="cm">	 }</span>
<span class="cm">	else</span>
<span class="cm">	 {</span>
<span class="cm">		f_ConvertValue=(((float)ui_ConvertTiming * 0.0012926) - 1);</span>
<span class="cm">		ui_TimerValue0=(unsigned int)f_ConvertValue;</span>
<span class="cm">		if (mode == 2)</span>
<span class="cm">		{</span>
<span class="cm">		     f_DelayValue     = (((float)ui_DelayTiming * 0.000012926) - 1);</span>
<span class="cm">		     ui_TimerValue1  =   (unsigned int) f_DelayValue;</span>
<span class="cm">		}</span>
<span class="cm">	}</span>
<span class="cm">***********************************************************************************************/</span>
<span class="cm">/*** EL241003 Begin : add this section to replace floats calculation by integer calculations **/</span>
	<span class="cm">/* EL250804: Testing if board APCI3120 have the new Quartz or if it is an APCI3001 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">us_TmpValue</span> <span class="o">&amp;</span> <span class="mh">0x00B0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00B0</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">pc_DriverName</span><span class="p">,</span> <span class="s">&quot;apci3001&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ui_TimerValue0</span> <span class="o">=</span> <span class="n">ui_ConvertTiming</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2000</span><span class="p">;</span>
		<span class="n">ui_TimerValue0</span> <span class="o">=</span> <span class="n">ui_TimerValue0</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ui_DelayTiming</span> <span class="o">=</span> <span class="n">ui_DelayTiming</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">ui_TimerValue1</span> <span class="o">=</span> <span class="n">ui_DelayTiming</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">200</span><span class="p">;</span>
			<span class="n">ui_TimerValue1</span> <span class="o">=</span> <span class="n">ui_TimerValue1</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ui_ConvertTiming</span> <span class="o">=</span> <span class="n">ui_ConvertTiming</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">ui_TimerValue0</span> <span class="o">=</span> <span class="n">ui_ConvertTiming</span> <span class="o">*</span> <span class="mi">12926</span> <span class="o">-</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="n">ui_TimerValue0</span> <span class="o">=</span> <span class="n">ui_TimerValue0</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ui_DelayTiming</span> <span class="o">=</span> <span class="n">ui_DelayTiming</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">ui_TimerValue1</span> <span class="o">=</span> <span class="n">ui_DelayTiming</span> <span class="o">*</span> <span class="mi">12926</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ui_TimerValue1</span> <span class="o">=</span> <span class="n">ui_TimerValue1</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/*** EL241003 End ******************************************************************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ExttrigEnable</span> <span class="o">==</span> <span class="n">APCI3120_ENABLE</span><span class="p">)</span>
		<span class="n">i_APCI3120_ExttrigEnable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/*  activate EXT trigger */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/*  init timer0 in mode 2 */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">b_TimerSelectMode</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="n">APCI3120_TIMER_0_MODE_2</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT1</span><span class="p">);</span>

		<span class="cm">/* Select Timer 0 */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_0_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>
		<span class="cm">/* Set the conversion time */</span>
		<span class="n">outw</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">ui_TimerValue0</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*  init timer1 in mode 2 */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">b_TimerSelectMode</span> <span class="o">&amp;</span> <span class="mh">0xF3</span><span class="p">)</span> <span class="o">|</span> <span class="n">APCI3120_TIMER_1_MODE_2</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT1</span><span class="p">);</span>

		<span class="cm">/* Select Timer 1 */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_1_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>
		<span class="cm">/* Set the conversion time */</span>
		<span class="n">outw</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">ui_TimerValue1</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

		<span class="cm">/*  init timer0 in mode 2 */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">b_TimerSelectMode</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">|</span> <span class="n">APCI3120_TIMER_0_MODE_2</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT1</span><span class="p">);</span>

		<span class="cm">/* Select Timer 0 */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_0_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>

		<span class="cm">/* Set the conversion time */</span>
		<span class="n">outw</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">ui_TimerValue0</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/*    ##########common for all modes################# */</span>

	<span class="cm">/***********************/</span>
	<span class="cm">/* Clears the SCAN bit */</span>
	<span class="cm">/***********************/</span>

	<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
	<span class="cm">/* devpriv-&gt;b_ModeSelectRegister=devpriv-&gt;b_ModeSelectRegister | APCI3120_DISABLE_SCAN; */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
		<span class="n">APCI3120_DISABLE_SCAN</span><span class="p">;</span>
	<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

	<span class="cm">/*  If DMA is disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_UseDma</span> <span class="o">==</span> <span class="n">APCI3120_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  disable EOC and enable EOS */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">=</span> <span class="n">APCI3120_EOS_MODE</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_ENABLE</span><span class="p">;</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_EOC_INT</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_ENABLE_EOS_INT</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiContinuous</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * configure Timer2 For counting EOS Reset gate 2 of Timer 2 to</span>
<span class="cm"> * disable it (Set Bit D14 to 0)</span>
<span class="cm"> */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">us_OutputRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_TIMER2</span><span class="p">;</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

			<span class="cm">/*  DISABLE TIMER intERRUPT */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
				<span class="n">APCI3120_DISABLE_TIMER_INT</span> <span class="o">&amp;</span> <span class="mh">0xEF</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

			<span class="cm">/* (1) Init timer 2 in mode 0 and write timer value */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_TimerSelectMode</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_TIMER_2_MODE_0</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT1</span><span class="p">);</span>

			<span class="cm">/* Writing LOW unsigned short */</span>
			<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_SELECT_TIMER_2_LOW_WORD</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">ui_TimerValue2</span><span class="p">),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

			<span class="cm">/* Writing HIGH unsigned short */</span>
			<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_SELECT_TIMER_2_HIGH_WORD</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">ui_TimerValue2</span><span class="p">),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

			<span class="cm">/* (2) Reset FC_TIMER BIT  Clearing timer status register */</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_STATUS_REGISTER</span><span class="p">);</span>
			<span class="cm">/*  enable timer counter and disable watch dog */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">|</span>
				<span class="n">APCI3120_ENABLE_TIMER_COUNTER</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">APCI3120_DISABLE_WATCHDOG</span><span class="p">;</span>
			<span class="cm">/*  select EOS clock input for timer 2 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">|</span>
				<span class="n">APCI3120_TIMER2_SELECT_EOS</span><span class="p">;</span>
			<span class="cm">/*  Enable timer2  interrupt */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">|</span>
				<span class="n">APCI3120_ENABLE_TIMER_INT</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">=</span> <span class="n">APCI3120_COUNTER</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Interrupt</span> <span class="o">=</span> <span class="n">APCI3120_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If DMA Enabled */</span>

		<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
		<span class="cm">/* inw(dev-&gt;iobase+0); reset EOC bit */</span>
		<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">=</span> <span class="n">APCI3120_DMA_MODE</span><span class="p">;</span>

		<span class="cm">/************************************/</span>
		<span class="cm">/* Disables the EOC, EOS interrupt  */</span>
		<span class="cm">/************************************/</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
			<span class="n">APCI3120_DISABLE_EOC_INT</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_EOS_INT</span><span class="p">;</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

		<span class="n">dmalen0</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferSize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">dmalen1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferSize</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiContinuous</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dmalen0</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/*  must we fill full first buffer? */</span>
				<span class="n">dmalen0</span> <span class="o">=</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span> <span class="o">*</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmalen1</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">dmalen0</span><span class="p">))</span>	<span class="cm">/*  and must we fill full second buffer when first is once filled? */</span>
				<span class="n">dmalen1</span> <span class="o">=</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span> <span class="o">*</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">dmalen0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiFlags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  don&#39;t we want wake up every scan? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmalen0</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dmalen0</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">dmalen0</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmalen1</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dmalen1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">dmalen1</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dmalen1</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
					<span class="n">dmalen1</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/*  isn&#39;t output buff smaller that our DMA buff? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmalen0</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiDataLength</span><span class="p">))</span>
				<span class="n">dmalen0</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiDataLength</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmalen1</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiDataLength</span><span class="p">))</span>
				<span class="n">dmalen1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiDataLength</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmalen0</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmalen1</span><span class="p">;</span>

		<span class="cm">/* Initialize DMA */</span>

<span class="cm">/*</span>
<span class="cm"> * Set Transfer count enable bit and A2P_fifo reset bit in AGCSTS</span>
<span class="cm"> * register 1</span>
<span class="cm"> */</span>
		<span class="n">ui_Tmp</span> <span class="o">=</span> <span class="n">AGCSTS_TC_ENABLE</span> <span class="o">|</span> <span class="n">AGCSTS_RESET_A2P_FIFO</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ui_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_AGCSTS</span><span class="p">);</span>

		<span class="cm">/*  changed  since 16 bit interface for add on */</span>
		<span class="cm">/*********************/</span>
		<span class="cm">/* ENABLE BUS MASTER */</span>
		<span class="cm">/*********************/</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_AGCSTS_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ENABLE_TRANSFER_ADD_ON_LOW</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_AGCSTS_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ENABLE_TRANSFER_ADD_ON_HIGH</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * TO VERIFIED BEGIN JK 07.05.04: Comparison between WIN32 and Linux</span>
<span class="cm"> * driver</span>
<span class="cm"> */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

		<span class="cm">/* 2 No change */</span>
		<span class="cm">/* A2P FIFO MANAGEMENT */</span>
		<span class="cm">/* A2P fifo reset &amp; transfer control enable */</span>

		<span class="cm">/***********************/</span>
		<span class="cm">/* A2P FIFO MANAGEMENT */</span>
		<span class="cm">/***********************/</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">APCI3120_A2P_FIFO_MANAGEMENT</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span>
			<span class="n">APCI3120_AMCC_OP_MCSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * 3</span>
<span class="cm"> * beginning address of dma buf The 32 bit address of dma buffer</span>
<span class="cm"> * is converted into two 16 bit addresses Can done by using _attach</span>
<span class="cm"> * and put into into an array array used may be for differnet pages</span>
<span class="cm"> */</span>

		<span class="cm">/*  DMA Start Address Low */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWAR_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_DmaBufferHw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/*************************/</span>
		<span class="cm">/* DMA Start Address High */</span>
		<span class="cm">/*************************/</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWAR_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_DmaBufferHw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">65536</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * 4</span>
<span class="cm"> * amount of bytes to be transferred set transfer count used ADDON</span>
<span class="cm"> * MWTC register commented testing</span>
<span class="cm"> * outl(devpriv-&gt;ui_DmaBufferUsesize[0],</span>
<span class="cm"> * devpriv-&gt;i_IobaseAddon+AMCC_OP_REG_AMWTC);</span>
<span class="cm"> */</span>

		<span class="cm">/**************************/</span>
		<span class="cm">/* Nbr of acquisition LOW */</span>
		<span class="cm">/**************************/</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWTC_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/***************************/</span>
		<span class="cm">/* Nbr of acquisition HIGH */</span>
		<span class="cm">/***************************/</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWTC_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">65536</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * 5</span>
<span class="cm"> * To configure A2P FIFO testing outl(</span>
<span class="cm"> * FIFO_ADVANCE_ON_BYTE_2,devpriv-&gt;i_IobaseAmcc+AMCC_OP_REG_INTCSR);</span>
<span class="cm"> */</span>

		<span class="cm">/******************/</span>
		<span class="cm">/* A2P FIFO RESET */</span>
		<span class="cm">/******************/</span>
<span class="cm">/*</span>
<span class="cm"> * TO VERIFY BEGIN JK 07.05.04: Comparison between WIN32 and Linux</span>
<span class="cm"> * driver</span>
<span class="cm"> */</span>
		<span class="n">outl</span><span class="p">(</span><span class="mh">0x04000000UL</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MCSR</span><span class="p">);</span>
		<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

<span class="cm">/*</span>
<span class="cm"> * 6</span>
<span class="cm"> * ENABLE A2P FIFO WRITE AND ENABLE AMWEN AMWEN_ENABLE |</span>
<span class="cm"> * A2P_FIFO_WRITE_ENABLE (0x01|0x02)=0x03</span>
<span class="cm"> */</span>

		<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
		<span class="cm">/* outw(3,devpriv-&gt;i_IobaseAddon + 4); */</span>
		<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

<span class="cm">/*</span>
<span class="cm"> * 7</span>
<span class="cm"> * initialise end of dma interrupt AINT_WRITE_COMPL =</span>
<span class="cm"> * ENABLE_WRITE_TC_INT(ADDI)</span>
<span class="cm"> */</span>
		<span class="cm">/***************************************************/</span>
		<span class="cm">/* A2P FIFO CONFIGURATE, END OF DMA intERRUPT INIT */</span>
		<span class="cm">/***************************************************/</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">APCI3120_FIFO_ADVANCE_ON_BYTE_2</span> <span class="o">|</span>
				<span class="n">APCI3120_ENABLE_WRITE_TC_INT</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>

		<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
		<span class="cm">/******************************************/</span>
		<span class="cm">/* ENABLE A2P FIFO WRITE AND ENABLE AMWEN */</span>
		<span class="cm">/******************************************/</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>

		<span class="cm">/******************/</span>
		<span class="cm">/* A2P FIFO RESET */</span>
		<span class="cm">/******************/</span>
		<span class="cm">/* BEGIN JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
		<span class="n">outl</span><span class="p">(</span><span class="mh">0x04000000UL</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">APCI3120_AMCC_OP_MCSR</span><span class="p">);</span>
		<span class="cm">/* END JK 07.05.04: Comparison between WIN32 and Linux driver */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_UseDma</span> <span class="o">==</span> <span class="n">APCI3120_DISABLE</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiContinuous</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  set gate 2   to start conversion */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">|</span> <span class="n">APCI3120_ENABLE_TIMER2</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/*  set gate 0   to start conversion */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">|</span> <span class="n">APCI3120_ENABLE_TIMER0</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*  set  gate 0 and gate 1 */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">|</span> <span class="n">APCI3120_ENABLE_TIMER1</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">|</span> <span class="n">APCI3120_ENABLE_TIMER0</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| 			intERNAL FUNCTIONS						                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     : int i_APCI3120_Reset(struct comedi_device *dev)               |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Hardware reset function   						     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : 	struct comedi_device *dev									 |</span>
<span class="cm">|                     														 |</span>
<span class="cm">|                                                 					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_Reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">us_TmpValue</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiCyclicAcquisition</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">=</span> <span class="n">APCI3120_EOC_MODE</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_EocEosConversionTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  set eoc eos conv time to 0 */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_OutputMemoryStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*  variables used in timer subdevice */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Interrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ExttrigEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*  Disable ext trigger */</span>

	<span class="cm">/* Disable all interrupts, watchdog for the anolog output */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

	<span class="cm">/*  Disables all counters, ext trigger and clears PA, PR */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Code to set the all anolog o/p channel to 0v 8191 is decimal</span>
<span class="cm"> * value for zero(0 v)volt in bipolar mode(default)</span>
<span class="cm"> */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">8191</span> <span class="o">|</span> <span class="n">APCI3120_ANALOG_OP_CHANNEL_1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_1</span><span class="p">);</span>	<span class="cm">/* channel 1 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">8191</span> <span class="o">|</span> <span class="n">APCI3120_ANALOG_OP_CHANNEL_2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_1</span><span class="p">);</span>	<span class="cm">/* channel 2 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">8191</span> <span class="o">|</span> <span class="n">APCI3120_ANALOG_OP_CHANNEL_3</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_1</span><span class="p">);</span>	<span class="cm">/* channel 3 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">8191</span> <span class="o">|</span> <span class="n">APCI3120_ANALOG_OP_CHANNEL_4</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_1</span><span class="p">);</span>	<span class="cm">/* channel 4 */</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">8191</span> <span class="o">|</span> <span class="n">APCI3120_ANALOG_OP_CHANNEL_5</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_2</span><span class="p">);</span>	<span class="cm">/* channel 5 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">8191</span> <span class="o">|</span> <span class="n">APCI3120_ANALOG_OP_CHANNEL_6</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_2</span><span class="p">);</span>	<span class="cm">/* channel 6 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">8191</span> <span class="o">|</span> <span class="n">APCI3120_ANALOG_OP_CHANNEL_7</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_2</span><span class="p">);</span>	<span class="cm">/* channel 7 */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">8191</span> <span class="o">|</span> <span class="n">APCI3120_ANALOG_OP_CHANNEL_8</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_2</span><span class="p">);</span>	<span class="cm">/* channel 8 */</span>

	<span class="cm">/*   Reset digital output to L0W */</span>

<span class="cm">/* ES05  outb(0x0,dev-&gt;iobase+APCI3120_DIGITAL_OUTPUT); */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* make a dummy read */</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RESET_FIFO</span><span class="p">);</span>	<span class="cm">/*  flush FIFO */</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>	<span class="cm">/*  flush A/D status register */</span>

	<span class="cm">/* code to reset the RAM sequence */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">us_TmpValue</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* select the location */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">us_TmpValue</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_SEQ_RAM_ADDRESS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     : int i_APCI3120_SetupChannelList(struct comedi_device * dev,   |</span>
<span class="cm">|                     struct comedi_subdevice * s, int n_chan,unsigned int *chanlist|</span>
<span class="cm">|			  ,char check)											 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              :This function will first check channel list is ok or not|</span>
<span class="cm">|and then initialize the sequence RAM with the polarity, Gain,Channel number |</span>
<span class="cm">|If the last argument of function &quot;check&quot;is 1 then it only checks the channel|</span>
<span class="cm">|list is ok or not.												     		 |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device * dev									 |</span>
<span class="cm">|                     struct comedi_subdevice * s									 |</span>
<span class="cm">|                     int n_chan                   					         |</span>
<span class="cm">			  unsigned int *chanlist</span>
<span class="cm">			  char check</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_SetupChannelList</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">char</span> <span class="n">check</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>		<span class="cm">/* , differencial=0, bipolar=0; */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gain</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">us_TmpValue</span><span class="p">;</span>

	<span class="cm">/* correct channel and range number check itself comedi/range.c */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_chan</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check</span><span class="p">)</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;range/channel list is empty!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  All is ok, so we can setup channel/range list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Code  to set the PA and PR...Here it set PA to 0.. */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_CLEAR_PA_PR</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span> <span class="p">((</span><span class="n">n_chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  store range list to card */</span>
		<span class="n">us_TmpValue</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>	<span class="cm">/*  get channel number; */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">APCI3120_BIPOLAR_RANGES</span><span class="p">)</span>
			<span class="n">us_TmpValue</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="o">~</span><span class="n">APCI3120_UNIPOLAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/*  set bipolar */</span>
		<span class="k">else</span>
			<span class="n">us_TmpValue</span> <span class="o">|=</span> <span class="n">APCI3120_UNIPOLAR</span><span class="p">;</span>	<span class="cm">/*  enable unipolar...... */</span>

		<span class="n">gain</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>	<span class="cm">/*  get gain number */</span>
		<span class="n">us_TmpValue</span> <span class="o">|=</span> <span class="p">((</span><span class="n">gain</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* &lt;&lt;4 for G0 and G1 bit in RAM */</span>
		<span class="n">us_TmpValue</span> <span class="o">|=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* To select the RAM LOCATION.... */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">us_TmpValue</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_SEQ_RAM_ADDRESS</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Gain = %i&quot;</span><span class="p">,</span>
			<span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Channel = %i&quot;</span><span class="p">,</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Polarity = %i&quot;</span><span class="p">,</span> <span class="n">us_TmpValue</span> <span class="o">&amp;</span> <span class="n">APCI3120_UNIPOLAR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/*  we can serve this with scan logic */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :	int i_APCI3120_ExttrigEnable(struct comedi_device * dev)    |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : 	Enable the external trigger						     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : 	struct comedi_device * dev									 |</span>
<span class="cm">|                     														 |</span>
<span class="cm">|                                                 					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :      0        					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_ExttrigEnable</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">|=</span> <span class="n">APCI3120_ENABLE_EXT_TRIGGER</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     : 	int i_APCI3120_ExttrigDisable(struct comedi_device * dev)   |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : 	Disables the external trigger					     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : 	struct comedi_device * dev									 |</span>
<span class="cm">|                     														 |</span>
<span class="cm">|                                                 					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :    0          					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_ExttrigDisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">APCI3120_ENABLE_EXT_TRIGGER</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                    intERRUPT FUNCTIONS		    		                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     : void v_APCI3120_Interrupt(int irq, void *d) 								 |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              :Interrupt handler for APCI3120                        	 |</span>
<span class="cm">|			 When interrupt occurs this gets called.                 |</span>
<span class="cm">|			 First it finds which interrupt has been generated and   |</span>
<span class="cm">|			 handles  corresponding interrupt                        |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : 	int irq 											 |</span>
<span class="cm">|                        void *d											 |</span>
<span class="cm">|                                                 					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : void         					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">void</span> <span class="nf">v_APCI3120_Interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">int_daq</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_amcc</span><span class="p">,</span> <span class="n">ui_Check</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">us_TmpValue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_DummyRead</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ui_Check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">int_daq</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">;</span>	<span class="cm">/*  get IRQ reasons */</span>
	<span class="n">int_amcc</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>	<span class="cm">/*  get AMCC int register */</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">int_daq</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">int_amcc</span> <span class="o">&amp;</span> <span class="n">ANY_S593X_INT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ from unknown source&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">int_amcc</span> <span class="o">|</span> <span class="mh">0x00ff0000</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>	<span class="cm">/*  shutdown IRQ reasons in AMCC */</span>

	<span class="n">int_daq</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_daq</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ExttrigEnable</span> <span class="o">==</span> <span class="n">APCI3120_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable ext trigger */</span>
		<span class="n">i_APCI3120_ExttrigDisable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ExttrigEnable</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* clear the timer 2 interrupt */</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_STATUS_REGISTER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_amcc</span> <span class="o">&amp;</span> <span class="n">MASTER_ABORT_INT</span><span class="p">)</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AMCC IRQ - MASTER DMA ABORT!&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_amcc</span> <span class="o">&amp;</span> <span class="n">TARGET_ABORT_INT</span><span class="p">)</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AMCC IRQ - TARGET DMA ABORT!&quot;</span><span class="p">);</span>

	<span class="cm">/*  Ckeck if EOC interrupt */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">int_daq</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">==</span> <span class="n">APCI3120_EOC_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">==</span> <span class="n">APCI3120_ENABLE</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*  Read the AI Value */</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiReadData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGIO</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  send signal to the sample */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Disable EOC Interrupt */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_EOC_INT</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*  Check If EOS interrupt */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">int_daq</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">==</span> <span class="n">APCI3120_EOS_MODE</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">==</span> <span class="n">APCI3120_ENABLE</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  enable this in without DMA ??? */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiCyclicAcquisition</span> <span class="o">==</span> <span class="n">APCI3120_ENABLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ui_Check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">i_APCI3120_InterruptHandleEos</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiActualScan</span><span class="o">++</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">b_ModeSelectRegister</span> <span class="o">|</span>
					<span class="n">APCI3120_ENABLE_EOS_INT</span><span class="p">;</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
					<span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ui_Check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span><span class="p">;</span>
					<span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">us_TmpValue</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiReadData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">us_TmpValue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">=</span> <span class="n">APCI3120_EOC_MODE</span><span class="p">;</span>

				<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGIO</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/*  send signal to the sample */</span>

			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_EOS_INT</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_EocEosInterrupt</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>	<span class="cm">/* Default settings */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">=</span> <span class="n">APCI3120_EOC_MODE</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="cm">/* Timer2 interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_daq</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">APCI3120_COUNTER</span>:

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiCyclicAcquisition</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_EOS_INT</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

			<span class="cm">/*  stop timer 2 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">us_OutputRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_ALL_TIMER</span><span class="p">;</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

			<span class="cm">/* stop timer 0 and timer 1 */</span>
			<span class="n">i_APCI3120_StopCyclicAcquisition</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiCyclicAcquisition</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>

			<span class="cm">/* UPDATE-0.7.57-&gt;0.7.68comedi_done(dev,s); */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
			<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">APCI3120_TIMER</span>:

			<span class="cm">/* Send a signal to from kernel to user space */</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGIO</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">APCI3120_WATCHDOG</span>:

			<span class="cm">/* Send a signal to from kernel to user space */</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGIO</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>

			<span class="cm">/*  disable Timer Interrupt */</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
				<span class="n">APCI3120_DISABLE_TIMER_INT</span><span class="p">;</span>

			<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="n">b_DummyRead</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_STATUS_REGISTER</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">int_daq</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_InterruptMode</span> <span class="o">==</span> <span class="n">APCI3120_DMA_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiCyclicAcquisition</span> <span class="o">==</span> <span class="n">APCI3120_ENABLE</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/****************************/</span>
			<span class="cm">/* Clear Timer Write TC int */</span>
			<span class="cm">/****************************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="n">APCI3120_CLEAR_WRITE_TC_INT</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span>
				<span class="n">APCI3120_AMCC_OP_REG_INTCSR</span><span class="p">);</span>

			<span class="cm">/************************************/</span>
			<span class="cm">/* Clears the timer status register */</span>
			<span class="cm">/************************************/</span>
			<span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_STATUS_REGISTER</span><span class="p">);</span>
			<span class="n">v_APCI3120_InterruptDma</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>	<span class="cm">/*  do some data transfer */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Stops the Timer */</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">us_OutputRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_TIMER0</span> <span class="o">&amp;</span>
				<span class="n">APCI3120_DISABLE_TIMER1</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InterruptHandleEos(struct comedi_device *dev)   |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : This function handles EOS interrupt.                   |</span>
<span class="cm">|                     This function copies the acquired data(from FIFO)      |</span>
<span class="cm">|				to Comedi buffer.		 							 |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     														 |</span>
<span class="cm">|                                                 					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0            					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>


<span class="kt">int</span> <span class="nf">i_APCI3120_InterruptHandleEos</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">n_chan</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofChannels</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">&amp;=</span> <span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>

	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     : void v_APCI3120_InterruptDma(int irq, void *d) 									 |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : This is a handler for the DMA interrupt                |</span>
<span class="cm">|			  This function copies the data to Comedi Buffer.        |</span>
<span class="cm">|			  For continuous DMA it reinitializes the DMA operation. |</span>
<span class="cm">|			  For single mode DMA it stop the acquisition.           |</span>
<span class="cm">|													     			 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : int irq, void *d				 |</span>
<span class="cm">|                     														 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  void        					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">void</span> <span class="nf">v_APCI3120_InterruptDma</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_dma_buf</span><span class="p">,</span> <span class="n">samplesinbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">low_word</span><span class="p">,</span> <span class="n">high_word</span><span class="p">,</span> <span class="n">var</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_Tmp</span><span class="p">;</span>
	<span class="n">samplesinbuf</span> <span class="o">=</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaActualBuffer</span><span class="p">]</span> <span class="o">-</span>
		<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MWTC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">samplesinbuf</span> <span class="o">&lt;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaActualBuffer</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Interrupted DMA transfer!&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samplesinbuf</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Odd count of bytes in DMA ring!&quot;</span><span class="p">);</span>
		<span class="n">i_APCI3120_StopCyclicAcquisition</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiCyclicAcquisition</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">samplesinbuf</span> <span class="o">=</span> <span class="n">samplesinbuf</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/*  number of received samples */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DmaDoubleBuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  switch DMA buffers if is used double buffering */</span>
		<span class="n">next_dma_buf</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaActualBuffer</span><span class="p">;</span>

		<span class="n">ui_Tmp</span> <span class="o">=</span> <span class="n">AGCSTS_TC_ENABLE</span> <span class="o">|</span> <span class="n">AGCSTS_RESET_A2P_FIFO</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ui_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_AGCSTS</span><span class="p">);</span>

		<span class="cm">/*  changed  since 16 bit interface for add on */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_AGCSTS_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ENABLE_TRANSFER_ADD_ON_LOW</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_AGCSTS_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ENABLE_TRANSFER_ADD_ON_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/*  0x1000 is out putted in windows driver */</span>

		<span class="n">var</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_DmaBufferHw</span><span class="p">[</span><span class="n">next_dma_buf</span><span class="p">];</span>
		<span class="n">low_word</span> <span class="o">=</span> <span class="n">var</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_DmaBufferHw</span><span class="p">[</span><span class="n">next_dma_buf</span><span class="p">];</span>
		<span class="n">high_word</span> <span class="o">=</span> <span class="n">var</span> <span class="o">/</span> <span class="mi">65536</span><span class="p">;</span>

		<span class="cm">/* DMA Start Address Low */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWAR_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">low_word</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/* DMA Start Address High */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWAR_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">high_word</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">var</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="n">next_dma_buf</span><span class="p">];</span>
		<span class="n">low_word</span> <span class="o">=</span> <span class="n">var</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="n">next_dma_buf</span><span class="p">];</span>
		<span class="n">high_word</span> <span class="o">=</span> <span class="n">var</span> <span class="o">/</span> <span class="mi">65536</span><span class="p">;</span>

		<span class="cm">/* Nbr of acquisition LOW */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWTC_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">low_word</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/* Nbr of acquisition HIGH */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWTC_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">high_word</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * To configure A2P FIFO</span>
<span class="cm"> * ENABLE A2P FIFO WRITE AND ENABLE AMWEN</span>
<span class="cm"> * AMWEN_ENABLE | A2P_FIFO_WRITE_ENABLE (0x01|0x02)=0x03</span>
<span class="cm"> */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="cm">/* initialise end of dma interrupt  AINT_WRITE_COMPL = ENABLE_WRITE_TC_INT(ADDI) */</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">APCI3120_FIFO_ADVANCE_ON_BYTE_2</span> <span class="o">|</span>
				<span class="n">APCI3120_ENABLE_WRITE_TC_INT</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samplesinbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v_APCI3120_InterruptDmaMoveBlock16bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_DmaBufferVirtual</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">ui_DmaActualBuffer</span><span class="p">],</span> <span class="n">samplesinbuf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiFlags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOS</span><span class="p">;</span>
			<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiContinuous</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiActualScan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiNbrofScans</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  all data sampled */</span>
			<span class="n">i_APCI3120_StopCyclicAcquisition</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_AiCyclicAcquisition</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
			<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DmaDoubleBuffer</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  switch dma buffers */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaActualBuffer</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaActualBuffer</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * restart DMA if is not used double buffering</span>
<span class="cm"> * ADDED REINITIALISE THE DMA</span>
<span class="cm"> */</span>
		<span class="n">ui_Tmp</span> <span class="o">=</span> <span class="n">AGCSTS_TC_ENABLE</span> <span class="o">|</span> <span class="n">AGCSTS_RESET_A2P_FIFO</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">ui_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_AGCSTS</span><span class="p">);</span>

		<span class="cm">/*  changed  since 16 bit interface for add on */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_AGCSTS_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ENABLE_TRANSFER_ADD_ON_LOW</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_AGCSTS_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ENABLE_TRANSFER_ADD_ON_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/*  */</span>
<span class="cm">/*</span>
<span class="cm"> * A2P FIFO MANAGEMENT</span>
<span class="cm"> * A2P fifo reset &amp; transfer control enable</span>
<span class="cm"> */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">APCI3120_A2P_FIFO_MANAGEMENT</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MCSR</span><span class="p">);</span>

		<span class="n">var</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_DmaBufferHw</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">low_word</span> <span class="o">=</span> <span class="n">var</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ul_DmaBufferHw</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">high_word</span> <span class="o">=</span> <span class="n">var</span> <span class="o">/</span> <span class="mi">65536</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWAR_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">low_word</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWAR_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">high_word</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">var</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">low_word</span> <span class="o">=</span> <span class="n">var</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>	<span class="cm">/* changed */</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_DmaBufferUsesize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">high_word</span> <span class="o">=</span> <span class="n">var</span> <span class="o">/</span> <span class="mi">65536</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWTC_LOW</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">low_word</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">APCI3120_ADD_ON_MWTC_HIGH</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">high_word</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * To configure A2P FIFO</span>
<span class="cm"> * ENABLE A2P FIFO WRITE AND ENABLE AMWEN</span>
<span class="cm"> * AMWEN_ENABLE | A2P_FIFO_WRITE_ENABLE (0x01|0x02)=0x03</span>
<span class="cm"> */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAddon</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="cm">/* initialise end of dma interrupt  AINT_WRITE_COMPL = ENABLE_WRITE_TC_INT(ADDI) */</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">APCI3120_FIFO_ADVANCE_ON_BYTE_2</span> <span class="o">|</span>
				<span class="n">APCI3120_ENABLE_WRITE_TC_INT</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i_IobaseAmcc</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :void v_APCI3120_InterruptDmaMoveBlock16bit(comedi_device|</span>
<span class="cm">|*dev,struct comedi_subdevice *s,short *dma,short *data,int n)				     |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : This function copies the data from DMA buffer to the   |</span>
<span class="cm">|				 Comedi buffer  									 |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     short *dma											 |</span>
<span class="cm">|                     short *data,int n          					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : void         					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">void</span> <span class="nf">v_APCI3120_InterruptDmaMoveBlock16bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">short</span> <span class="o">*</span><span class="n">dma_buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiActualScan</span> <span class="o">+=</span>
		<span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">+</span> <span class="n">num_samples</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">+=</span> <span class="n">num_samples</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">%=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ui_AiScanLength</span><span class="p">;</span>

	<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dma_buffer</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                           TIMER SUBDEVICE   		                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InsnConfigTimer(struct comedi_device *dev,          |</span>
<span class="cm">|	struct comedi_subdevice *s,struct comedi_insn *insn,unsigned int *data) 			     |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              :Configure Timer 2  								     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data 										 |</span>
<span class="cm">|                     														 |</span>
<span class="cm">|                      data[0]= TIMER  configure as timer                    |</span>
<span class="cm">|              				 = WATCHDOG configure as watchdog				 |</span>
<span class="cm">|       			  data[1] = Timer constant							 |</span>
<span class="cm">|       			  data[2] = Timer2 interrupt (1)enable or(0) disable |</span>
<span class="cm">|                                                 					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_InsnConfigTimer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_Timervalue2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">us_TmpValue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;config:No timer constant !&quot;</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Interrupt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  save info whether to enable or disable interrupt */</span>

	<span class="n">ui_Timervalue2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/*  convert nano seconds  to u seconds */</span>

	<span class="cm">/* this_board-&gt;timer_config(dev, ui_Timervalue2,(unsigned char)data[0]); */</span>
	<span class="n">us_TmpValue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * EL250804: Testing if board APCI3120 have the new Quartz or if it</span>
<span class="cm"> * is an APCI3001 and calculate the time value to set in the timer</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">us_TmpValue</span> <span class="o">&amp;</span> <span class="mh">0x00B0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00B0</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">pc_DriverName</span><span class="p">,</span> <span class="s">&quot;apci3001&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Calculate the time value to set in the timer */</span>
		<span class="n">ui_Timervalue2</span> <span class="o">=</span> <span class="n">ui_Timervalue2</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Calculate the time value to set in the timer */</span>
		<span class="n">ui_Timervalue2</span> <span class="o">=</span> <span class="n">ui_Timervalue2</span> <span class="o">/</span> <span class="mi">70</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset gate 2 of Timer 2 to disable it (Set Bit D14 to 0) */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_TIMER2</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

	<span class="cm">/*  Disable TIMER Interrupt */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span>
		<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_TIMER_INT</span> <span class="o">&amp;</span> <span class="mh">0xEF</span><span class="p">;</span>

	<span class="cm">/*  Disable Eoc and Eos Interrupts */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span>
		<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_EOC_INT</span> <span class="o">&amp;</span>
		<span class="n">APCI3120_DISABLE_EOS_INT</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">APCI3120_TIMER</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* initialize timer */</span>
		<span class="cm">/* devpriv-&gt;b_ModeSelectRegister=devpriv-&gt;b_ModeSelectRegister |</span>
<span class="cm">		 * APCI3120_ENABLE_TIMER_INT; */</span>

		<span class="cm">/* outb(devpriv-&gt;b_ModeSelectRegister,devpriv-&gt;iobase+APCI3120_WRITE_MODE_SELECT); */</span>

		<span class="cm">/* Set the Timer 2 in mode 2(Timer) */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">b_TimerSelectMode</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="n">APCI3120_TIMER_2_MODE_2</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT1</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the timer 2 for writing the LOW unsigned short of timer</span>
<span class="cm"> * is Delay value You must make a b_tmp variable with</span>
<span class="cm"> * DigitalOutPutRegister because at Address_1+APCI3120_TIMER_CRT0</span>
<span class="cm"> * you can set the digital output and configure the timer 2,and if</span>
<span class="cm"> * you don&#39;t make this, digital output are erase (Set to 0)</span>
<span class="cm"> */</span>

		<span class="cm">/* Writing LOW unsigned short */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_2_LOW_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">ui_Timervalue2</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

		<span class="cm">/* Writing HIGH unsigned short */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_2_HIGH_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">ui_Timervalue2</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>
		<span class="cm">/*  timer2 in Timer mode enabled */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">=</span> <span class="n">APCI3120_TIMER</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/*  Initialize Watch dog */</span>

		<span class="cm">/* Set the Timer 2 in mode 5(Watchdog) */</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">b_TimerSelectMode</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="n">APCI3120_TIMER_2_MODE_5</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_TimerSelectMode</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT1</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the timer 2 for writing the LOW unsigned short of timer</span>
<span class="cm"> * is Delay value You must make a b_tmp variable with</span>
<span class="cm"> * DigitalOutPutRegister because at Address_1+APCI3120_TIMER_CRT0</span>
<span class="cm"> * you can set the digital output and configure the timer 2,and if</span>
<span class="cm"> * you don&#39;t make this, digital output are erase (Set to 0)</span>
<span class="cm"> */</span>

		<span class="cm">/* Writing LOW unsigned short */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_2_LOW_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">ui_Timervalue2</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

		<span class="cm">/* Writing HIGH unsigned short */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_2_HIGH_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">ui_Timervalue2</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>
		<span class="cm">/* watchdog enabled */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">=</span> <span class="n">APCI3120_WATCHDOG</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InsnWriteTimer(struct comedi_device *dev,           |</span>
<span class="cm">|                    struct comedi_subdevice *s, struct comedi_insn *insn,unsigned int *data)  |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              :    To start and stop the timer		                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data                                         |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|				data[0] = 1 (start)                                  |</span>
<span class="cm">|				data[0] = 0 (stop )                                  |</span>
<span class="cm">|	 			data[0] = 2  (write new value)                       |</span>
<span class="cm">|	   			data[1]= new value                                   |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|    				devpriv-&gt;b_Timer2Mode =  0 DISABLE                   |</span>
<span class="cm">|	                     					 1 Timer                     |</span>
<span class="cm">|					 					 2 Watch dog			     |</span>
<span class="cm">|                                                 					         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_InsnWriteTimer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_Timervalue2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">us_TmpValue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">!=</span> <span class="n">APCI3120_WATCHDOG</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">!=</span> <span class="n">APCI3120_TIMER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">write:timer2  not configured &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*  write new value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">!=</span> <span class="n">APCI3120_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;write :timer2  not configured  in TIMER MODE&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">ui_Timervalue2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">ui_Timervalue2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* this_board-&gt;timer_write(dev,data[0],ui_Timervalue2); */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APCI3120_START</span>:

		<span class="cm">/*  Reset FC_TIMER BIT */</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_STATUS_REGISTER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">==</span> <span class="n">APCI3120_TIMER</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* start timer */</span>
			<span class="cm">/* Enable Timer */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="mh">0x0B</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* start watch dog */</span>
			<span class="cm">/* Enable WatchDog */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="mh">0x0B</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">APCI3120_ENABLE_WATCHDOG</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* enable disable interrupt */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Interrupt</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI3120_ENABLE</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">|</span>
				<span class="n">APCI3120_ENABLE_TIMER_INT</span><span class="p">;</span>
			<span class="cm">/*  save the task structure to pass info to user */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
				<span class="n">APCI3120_DISABLE_TIMER_INT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">==</span> <span class="n">APCI3120_TIMER</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* start timer */</span>
			<span class="cm">/* For Timer mode is  Gate2 must be activated   **timer started */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">us_OutputRegister</span> <span class="o">|</span> <span class="n">APCI3120_ENABLE_TIMER2</span><span class="p">;</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI3120_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">==</span> <span class="n">APCI3120_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable timer */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
				<span class="n">APCI3120_DISABLE_TIMER_COUNTER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Disable WatchDog */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span>
				<span class="n">APCI3120_DISABLE_WATCHDOG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*  Disable timer interrupt */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span> <span class="o">=</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">b_ModeSelectRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_TIMER_INT</span><span class="p">;</span>

		<span class="cm">/*  Write above states  to register */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_ModeSelectRegister</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WRITE_MODE_SELECT</span><span class="p">);</span>

		<span class="cm">/*  Reset Gate 2 */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">=</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span> <span class="o">&amp;</span> <span class="n">APCI3120_DISABLE_TIMER_INT</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">us_OutputRegister</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_WR_ADDRESS</span><span class="p">);</span>

		<span class="cm">/*  Reset FC_TIMER BIT */</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_STATUS_REGISTER</span><span class="p">);</span>

		<span class="cm">/* Disable timer */</span>
		<span class="cm">/* devpriv-&gt;b_Timer2Mode=APCI3120_DISABLE;  */</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* write new value to Timer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">!=</span> <span class="n">APCI3120_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;write :timer2  not configured  in TIMER MODE&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*  ui_Timervalue2=data[1]; // passed as argument */</span>
		<span class="n">us_TmpValue</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * EL250804: Testing if board APCI3120 have the new Quartz or if it</span>
<span class="cm"> * is an APCI3001 and calculate the time value to set in the timer</span>
<span class="cm"> */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">us_TmpValue</span> <span class="o">&amp;</span> <span class="mh">0x00B0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00B0</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">pc_DriverName</span><span class="p">,</span> <span class="s">&quot;apci3001&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Calculate the time value to set in the timer */</span>
			<span class="n">ui_Timervalue2</span> <span class="o">=</span> <span class="n">ui_Timervalue2</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Calculate the time value to set in the timer */</span>
			<span class="n">ui_Timervalue2</span> <span class="o">=</span> <span class="n">ui_Timervalue2</span> <span class="o">/</span> <span class="mi">70</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Writing LOW unsigned short */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_2_LOW_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">ui_Timervalue2</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

		<span class="cm">/* Writing HIGH unsigned short */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_2_HIGH_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">ui_Timervalue2</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/*  Not a valid input */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     : int i_APCI3120_InsnReadTimer(struct comedi_device *dev,           |</span>
<span class="cm">|		struct comedi_subdevice *s,struct comedi_insn *insn, unsigned int *data) 		 |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : read the Timer value 				                 	 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : 	struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data 										 |</span>
<span class="cm">|                     														 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :   													 |</span>
<span class="cm">|			for Timer:	data[0]= Timer constant						 |</span>
<span class="cm">|																	 |</span>
<span class="cm">|         		for watchdog: data[0]=0 (still running)                  |</span>
<span class="cm">|	               			  data[0]=1  (run down)            			 |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">i_APCI3120_InsnReadTimer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">us_TmpValue</span><span class="p">,</span> <span class="n">us_TmpValue_2</span><span class="p">,</span> <span class="n">us_StatusValue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">!=</span> <span class="n">APCI3120_WATCHDOG</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">!=</span> <span class="n">APCI3120_TIMER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">read:timer2  not configured &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* this_board-&gt;timer_read(dev,data); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_Timer2Mode</span> <span class="o">==</span> <span class="n">APCI3120_TIMER</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Read the LOW unsigned short of Timer 2 register */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_2_LOW_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>

		<span class="n">us_TmpValue</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

		<span class="cm">/* Read the HIGH unsigned short of Timer 2 register */</span>
		<span class="n">b_Tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">b_DigitalOutputRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">APCI3120_SELECT_TIMER_2_HIGH_WORD</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b_Tmp</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_CRT0</span><span class="p">);</span>

		<span class="n">us_TmpValue_2</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_VALUE</span><span class="p">);</span>

		<span class="cm">/*  combining both words */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">us_TmpValue</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">us_TmpValue_2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/*  Read watch dog status */</span>

		<span class="n">us_StatusValue</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>
		<span class="n">us_StatusValue</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">us_StatusValue</span> <span class="o">&amp;</span> <span class="n">APCI3120_FC_TIMER</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">us_StatusValue</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  RESET FC_TIMER BIT */</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_TIMER_STATUS_REGISTER</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">us_StatusValue</span><span class="p">;</span>	<span class="cm">/*  when data[0] = 1 then the watch dog has rundown */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                           DIGITAL INPUT SUBDEVICE   		                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InsnReadDigitalInput(struct comedi_device *dev,     |</span>
<span class="cm">|			struct comedi_subdevice *s, struct comedi_insn *insn,unsigned int *data)   |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Reads the value of the specified  Digital input channel|</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data 										 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_InsnReadDigitalInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_Chan</span><span class="p">,</span> <span class="n">ui_TmpValue</span><span class="p">;</span>

	<span class="n">ui_Chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>	<span class="cm">/*  channel specified */</span>

	<span class="cm">/* this_board-&gt;di_read(dev,ui_Chan,data); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ui_Chan</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ui_TmpValue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * since only 1 channel reqd to bring it to last bit it is rotated 8</span>
<span class="cm"> * +(chan - 1) times then ANDed with 1 for last bit.</span>
<span class="cm"> */</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ui_TmpValue</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">ui_Chan</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* return 0; */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*       comedi_error(dev,&quot; chan spec wrong&quot;); */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/*  &quot;sorry channel spec wrong &quot; */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InsnBitsDigitalInput(struct comedi_device *dev, |</span>
<span class="cm">|struct comedi_subdevice *s, struct comedi_insn *insn,unsigned int *data)                      |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Reads the value of the Digital input Port i.e.4channels|</span>
<span class="cm">|   value is returned in data[0]											 |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data 										 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">i_APCI3120_InsnBitsDigitalInput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_TmpValue</span><span class="p">;</span>
	<span class="n">ui_TmpValue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_RD_STATUS</span><span class="p">);</span>
	<span class="cm">/*****	state of 4 channels  in the 11, 10, 9, 8   bits of status reg</span>
<span class="cm">			rotated right 8 times to bring them to last four bits</span>
<span class="cm">			ANDed with oxf for  value.</span>
<span class="cm">	*****/</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ui_TmpValue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="cm">/* this_board-&gt;di_bits(dev,data); */</span>
	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                           DIGITAL OUTPUT SUBDEVICE   		                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InsnConfigDigitalOutput(struct comedi_device    |</span>
<span class="cm">| *dev,struct comedi_subdevice *s,struct comedi_insn *insn,unsigned int *data)				 |</span>
<span class="cm">|                                            						         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              :Configure the output memory ON or OFF				     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  :struct comedi_device *dev									 	 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data 										 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_InsnConfigDigitalOutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Not a valid Data !!! ,Data should be 1 or 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_OutputMemoryStatus</span> <span class="o">=</span> <span class="n">APCI3120_ENABLE</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_OutputMemoryStatus</span> <span class="o">=</span> <span class="n">APCI3120_DISABLE</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DigitalOutputRegister</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_OutputMemoryStatus</span><span class="p">)</span>
		<span class="n">ui_Temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* if(!devpriv-&gt;b_OutputMemoryStatus ) */</span>

	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InsnBitsDigitalOutput(struct comedi_device *dev,    |</span>
<span class="cm">|		struct comedi_subdevice *s, struct comedi_insn *insn,unsigned int *data) 		 |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : write diatal output port							     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data 										 |</span>
<span class="cm">|                      data[0]     Value to be written</span>
<span class="cm">|                      data[1]    :1 Set digital o/p ON</span>
<span class="cm">|                      data[1]     2 Set digital o/p OFF with memory ON</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_InsnBitsDigitalOutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">i_DoMaxdata</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Data is not valid !!! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DigitalOutputRegister</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">The parameter passed is in error </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/*  switch(data[1]) */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_DIGITAL_OUTPUT</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DigitalOutputRegister</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name		:int i_APCI3120_InsnWriteDigitalOutput(struct comedi_device *dev,|</span>
<span class="cm">|struct comedi_subdevice *s,struct comedi_insn *insn,unsigned int *data)	|</span>
<span class="cm">|										|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task			: Write digiatl output					|</span>
<span class="cm">| 										|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters	: struct comedi_device *dev				|</span>
<span class="cm">|			struct comedi_subdevice *s			 	|</span>
<span class="cm">|			struct comedi_insn *insn				|</span>
<span class="cm">|			unsigned int *data					|</span>
<span class="cm">			data[0]     Value to be written</span>
<span class="cm">			data[1]    :1 Set digital o/p ON</span>
<span class="cm">			data[1]     2 Set digital o/p OFF with memory ON</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value		:							|</span>
<span class="cm">|										|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_InsnWriteDigitalOutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_Temp1</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_NoOfChannel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>	<span class="cm">/*  get the channel */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Not a valid Data !!! ,Data should be 1 or 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ui_NoOfChannel</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_EeParameters</span><span class="p">.</span><span class="n">i_NbrDoChannel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;This board doesn&#39;t have specified channel !!! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">ui_NoOfChannel</span><span class="p">);</span>
<span class="cm">/* ES05                   data[0]=(data[0]&lt;&lt;4)|ui_Temp; */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DigitalOutputRegister</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">ui_Temp1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ui_Temp1</span> <span class="o">=</span> <span class="n">ui_Temp1</span> <span class="o">&lt;&lt;</span> <span class="n">ui_NoOfChannel</span><span class="p">;</span>
		<span class="n">ui_Temp1</span> <span class="o">=</span> <span class="n">ui_Temp1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="cm">/* ES05                   ui_Temp=ui_Temp|ui_Temp1; */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DigitalOutputRegister</span> <span class="o">=</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DigitalOutputRegister</span> <span class="o">|</span> <span class="n">ui_Temp1</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">ui_NoOfChannel</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="cm">/* ES05                   data[0]=data[0]&amp; ui_Temp; */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DigitalOutputRegister</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">The parameter passed is in error </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/*  switch(data[1]) */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_DIGITAL_OUTPUT</span><span class="p">);</span>

<span class="cm">/* ES05        ui_Temp=data[0] &amp; 0xf0; */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">b_DigitalOutputRegister</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                            ANALOG OUTPUT SUBDEVICE                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function name     :int i_APCI3120_InsnWriteAnalogOutput(struct comedi_device *dev,|</span>
<span class="cm">|struct comedi_subdevice *s, struct comedi_insn *insn,unsigned int *data)			             |</span>
<span class="cm">|                                        									 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Write  analog output   							     |</span>
<span class="cm">|                     										                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : struct comedi_device *dev									 |</span>
<span class="cm">|                     struct comedi_subdevice *s									 |</span>
<span class="cm">|                     struct comedi_insn *insn                                      |</span>
<span class="cm">|                     unsigned int *data  										 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :              					                         |</span>
<span class="cm">|                    													     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI3120_InsnWriteAnalogOutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_Range</span><span class="p">,</span> <span class="n">ui_Channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">us_TmpValue</span><span class="p">;</span>

	<span class="n">ui_Range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">ui_Channel</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* this_board-&gt;ao_write(dev, ui_Range, ui_Channel,data[0]); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ui_Range</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/*  if 1 then unipolar */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((((</span><span class="n">ui_Channel</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>
					<span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8191</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((((</span><span class="n">ui_Channel</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>
					<span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="mi">8192</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/*  if 0 then   bipolar */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((((</span><span class="n">ui_Channel</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * out put n values at the given channel. printk(&quot;\nwaiting for</span>
<span class="cm"> * DA_READY BIT&quot;);</span>
<span class="cm"> */</span>
	<span class="k">do</span> <span class="p">{</span>			<span class="cm">/* Waiting of DA_READY BIT */</span>
		<span class="n">us_TmpValue</span> <span class="o">=</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
				<span class="n">APCI3120_RD_STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">us_TmpValue</span> <span class="o">!=</span> <span class="mh">0x0001</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ui_Channel</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
<span class="cm">/*</span>
<span class="cm"> * for channel 0-3 out at the register 1 (wrDac1-8) data[i]</span>
<span class="cm"> * typecasted to ushort since word write is to be done</span>
<span class="cm"> */</span>
		<span class="n">outw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_1</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cm">/*</span>
<span class="cm"> * for channel 4-7 out at the register 2 (wrDac5-8) data[i]</span>
<span class="cm"> * typecasted to ushort since word write is to be done</span>
<span class="cm"> */</span>
		<span class="n">outw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">APCI3120_ANALOG_OUTPUT_2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
