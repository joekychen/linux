<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › addi-data › APCI1710_INCCPT.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>APCI1710_INCCPT.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm">@verbatim</span>

<span class="cm">Copyright (C) 2004,2005  ADDI-DATA GmbH for the source code of this module.</span>

<span class="cm">	ADDI-DATA GmbH</span>
<span class="cm">	Dieselstrasse 3</span>
<span class="cm">	D-77833 Ottersweier</span>
<span class="cm">	Tel: +19(0)7223/9493-0</span>
<span class="cm">	Fax: +49(0)7223/9493-92</span>
<span class="cm">	http://www.addi-data.com</span>
<span class="cm">	info@addi-data.com</span>

<span class="cm">This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</span>

<span class="cm">This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</span>

<span class="cm">You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>

<span class="cm">You should also find the complete GPL in the COPYING file accompanying this source code.</span>

<span class="cm">@endverbatim</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | (C) ADDI-DATA GmbH          Dieselstraße 3       D-77833 Ottersweier  |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Tel : +49 (0) 7223/9493-0     | email    : info@addi-data.com         |</span>
<span class="cm">  | Fax : +49 (0) 7223/9493-92    | Internet : http://www.addi-data.com   |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Project     : API APCI1710    | Compiler : gcc                        |</span>
<span class="cm">  | Module name : INC_CPT.C       | Version  : 2.96                       |</span>
<span class="cm">  +-------------------------------+---------------------------------------+</span>
<span class="cm">  | Project manager: Eric Stolz   | Date     :  02/12/2002                |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | Description :   APCI-1710 incremental counter module                  |</span>
<span class="cm">  |                                                                       |</span>
<span class="cm">  |                                                                       |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  |                             UPDATES                                   |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  |   Date   |   Author  |          Description of updates                |</span>
<span class="cm">  +----------+-----------+------------------------------------------------+</span>
<span class="cm">  |          |           |                                                |</span>
<span class="cm">  |----------|-----------|------------------------------------------------|</span>
<span class="cm">  | 08/05/00 | Guinot C  | - 0400/0228 All Function in RING 0             |</span>
<span class="cm">  |          |           |   available                                    |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">  | 29/06/01 | Guinot C. | - 1100/0231 -&gt; 0701/0232                       |</span>
<span class="cm">  |          |           | See i_APCI1710_DisableFrequencyMeasurement     |</span>
<span class="cm">  +-----------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">|                               Included files                               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;APCI1710_INCCPT.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| int	i_APCI1710_InsnConfigINCCPT(struct comedi_device *dev,struct comedi_subdevice *s,</span>
<span class="cm">struct comedi_insn *insn,unsigned int *data)</span>

<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Configuration function for INC_CPT                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  :														 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : *data</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InsnConfigINCCPT</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_ConfigType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ui_ConfigType</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">INC_CPT&quot;</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>	<span class="cm">/*  Save the current process task structure */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ui_ConfigType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APCI1710_INCCPT_INITCOUNTER</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_InitCounter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_COUNTERAUTOTEST</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_CounterAutoTest</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_INITINDEX</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_InitIndex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_INITREFERENCE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_InitReference</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_INITEXTERNALSTROBE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_InitExternalStrobe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_INITCOMPARELOGIC</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_InitCompareLogic</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_INITFREQUENCYMEASUREMENT</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_InitFrequencyMeasurement</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Insn Config : Config Parameter Wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_InitCounter                           |</span>
<span class="cm">|                               (unsigned char_          b_BoardHandle,               |</span>
<span class="cm">|                                unsigned char_          b_ModulNbr,                  |</span>
<span class="cm">|                                unsigned char_          b_CounterRange,              |</span>
<span class="cm">|                                unsigned char_          b_FirstCounterModus,         |</span>
<span class="cm">|                                unsigned char_          b_FirstCounterOption,        |</span>
<span class="cm">|                                unsigned char_          b_SecondCounterModus,        |</span>
<span class="cm">|                                unsigned char_          b_SecondCounterOption)       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Configure the counter operating mode from selected     |</span>
<span class="cm">|                     module (b_ModulNbr). You must calling this function be |</span>
<span class="cm">|                     for you call any other function witch access of        |</span>
<span class="cm">|                     counters.                                              |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                          Counter range                                     |</span>
<span class="cm">|                          -------------                                     |</span>
<span class="cm">| +------------------------------------+-----------------------------------+ |</span>
<span class="cm">| | Parameter       Passed value       |        Description                | |</span>
<span class="cm">| |------------------------------------+-----------------------------------| |</span>
<span class="cm">| |b_ModulNbr   APCI1710_16BIT_COUNTER |  The module is configured for     | |</span>
<span class="cm">| |                                    |  two 16-bit counter.              | |</span>
<span class="cm">| |                                    |  - b_FirstCounterModus and        | |</span>
<span class="cm">| |                                    |    b_FirstCounterOption           | |</span>
<span class="cm">| |                                    |    configure the first 16 bit     | |</span>
<span class="cm">| |                                    |    counter.                       | |</span>
<span class="cm">| |                                    |  - b_SecondCounterModus and       | |</span>
<span class="cm">| |                                    |    b_SecondCounterOption          | |</span>
<span class="cm">| |                                    |    configure the second 16 bit    | |</span>
<span class="cm">| |                                    |    counter.                       | |</span>
<span class="cm">| |------------------------------------+-----------------------------------| |</span>
<span class="cm">| |b_ModulNbr   APCI1710_32BIT_COUNTER |  The module is configured for one | |</span>
<span class="cm">| |                                    |  32-bit counter.                  | |</span>
<span class="cm">| |                                    |  - b_FirstCounterModus and        | |</span>
<span class="cm">| |                                    |    b_FirstCounterOption           | |</span>
<span class="cm">| |                                    |    configure the 32 bit counter.  | |</span>
<span class="cm">| |                                    |  - b_SecondCounterModus and       | |</span>
<span class="cm">| |                                    |    b_SecondCounterOption          | |</span>
<span class="cm">| |                                    |    are not used and have no       | |</span>
<span class="cm">| |                                    |    importance.                    | |</span>
<span class="cm">| +------------------------------------+-----------------------------------+ |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                      Counter operating mode                                |</span>
<span class="cm">|                      ----------------------                                |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">| +--------------------+-------------------------+-------------------------+ |</span>
<span class="cm">| |    Parameter       |     Passed value        |    Description          | |</span>
<span class="cm">| |--------------------+-------------------------+-------------------------| |</span>
<span class="cm">| |b_FirstCounterModus | APCI1710_QUADRUPLE_MODE | In the quadruple mode,  | |</span>
<span class="cm">| |       or           |                         | the edge analysis       | |</span>
<span class="cm">| |b_SecondCounterModus|                         | circuit generates a     | |</span>
<span class="cm">| |                    |                         | counting pulse from     | |</span>
<span class="cm">| |                    |                         | each edge of 2 signals  | |</span>
<span class="cm">| |                    |                         | which are phase shifted | |</span>
<span class="cm">| |                    |                         | in relation to each     | |</span>
<span class="cm">| |                    |                         | other.                  | |</span>
<span class="cm">| |--------------------+-------------------------+-------------------------| |</span>
<span class="cm">| |b_FirstCounterModus |   APCI1710_DOUBLE_MODE  | Functions in the same   | |</span>
<span class="cm">| |       or           |                         | way as the quadruple    | |</span>
<span class="cm">| |b_SecondCounterModus|                         | mode, except that only  | |</span>
<span class="cm">| |                    |                         | two of the four edges   | |</span>
<span class="cm">| |                    |                         | are analysed per        | |</span>
<span class="cm">| |                    |                         | period                  | |</span>
<span class="cm">| |--------------------+-------------------------+-------------------------| |</span>
<span class="cm">| |b_FirstCounterModus |   APCI1710_SIMPLE_MODE  | Functions in the same   | |</span>
<span class="cm">| |       or           |                         | way as the quadruple    | |</span>
<span class="cm">| |b_SecondCounterModus|                         | mode, except that only  | |</span>
<span class="cm">| |                    |                         | one of the four edges   | |</span>
<span class="cm">| |                    |                         | is analysed per         | |</span>
<span class="cm">| |                    |                         | period.                 | |</span>
<span class="cm">| |--------------------+-------------------------+-------------------------| |</span>
<span class="cm">| |b_FirstCounterModus |   APCI1710_DIRECT_MODE  | In the direct mode the  | |</span>
<span class="cm">| |       or           |                         | both edge analysis      | |</span>
<span class="cm">| |b_SecondCounterModus|                         | circuits are inactive.  | |</span>
<span class="cm">| |                    |                         | The inputs A, B in the  | |</span>
<span class="cm">| |                    |                         | 32-bit mode or A, B and | |</span>
<span class="cm">| |                    |                         | C, D in the 16-bit mode | |</span>
<span class="cm">| |                    |                         | represent, each, one    | |</span>
<span class="cm">| |                    |                         | clock pulse gate circuit| |</span>
<span class="cm">| |                    |                         | There by frequency and  | |</span>
<span class="cm">| |                    |                         | pulse duration          | |</span>
<span class="cm">| |                    |                         | measurements can be     | |</span>
<span class="cm">| |                    |                         | performed.              | |</span>
<span class="cm">| +--------------------+-------------------------+-------------------------+ |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|       IMPORTANT!                                                           |</span>
<span class="cm">|       If you have configured the module for two 16-bit counter, a mixed    |</span>
<span class="cm">|       mode with a counter in quadruple/double/single mode                  |</span>
<span class="cm">|       and the other counter in direct mode is not possible!                |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|         Counter operating option for quadruple/double/simple mode          |</span>
<span class="cm">|         ---------------------------------------------------------          |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">| +----------------------+-------------------------+------------------------+|</span>
<span class="cm">| |       Parameter      |     Passed value        |  Description           ||</span>
<span class="cm">| |----------------------+-------------------------+------------------------||</span>
<span class="cm">| |b_FirstCounterOption  | APCI1710_HYSTERESIS_ON  | In both edge analysis  ||</span>
<span class="cm">| |        or            |                         | circuits is available  ||</span>
<span class="cm">| |b_SecondCounterOption |                         | one hysteresis circuit.||</span>
<span class="cm">| |                      |                         | It suppresses each     ||</span>
<span class="cm">| |                      |                         | time the first counting||</span>
<span class="cm">| |                      |                         | pulse after a change   ||</span>
<span class="cm">| |                      |                         | of rotation.           ||</span>
<span class="cm">| |----------------------+-------------------------+------------------------||</span>
<span class="cm">| |b_FirstCounterOption  | APCI1710_HYSTERESIS_OFF | The first counting     ||</span>
<span class="cm">| |       or             |                         | pulse is not suppress  ||</span>
<span class="cm">| |b_SecondCounterOption |                         | after a change of      ||</span>
<span class="cm">| |                      |                         | rotation.              ||</span>
<span class="cm">| +----------------------+-------------------------+------------------------+|</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|       IMPORTANT!                                                           |</span>
<span class="cm">|       This option are only avaible if you have selected the direct mode.   |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|               Counter operating option for direct mode                     |</span>
<span class="cm">|               ----------------------------------------                     |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">| +----------------------+--------------------+----------------------------+ |</span>
<span class="cm">| |      Parameter       |     Passed value   |       Description          | |</span>
<span class="cm">| |----------------------+--------------------+----------------------------| |</span>
<span class="cm">| |b_FirstCounterOption  | APCI1710_INCREMENT | The counter increment for  | |</span>
<span class="cm">| |       or             |                    | each counting pulse        | |</span>
<span class="cm">| |b_SecondCounterOption |                    |                            | |</span>
<span class="cm">| |----------------------+--------------------+----------------------------| |</span>
<span class="cm">| |b_FirstCounterOption  | APCI1710_DECREMENT | The counter decrement for  | |</span>
<span class="cm">| |       or             |                    | each counting pulse        | |</span>
<span class="cm">| |b_SecondCounterOption |                    |                            | |</span>
<span class="cm">| +----------------------+--------------------+----------------------------+ |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle         : Handle of board APCI-1710|</span>
<span class="cm">|                     unsigned char_ b_ModulNbr            : Module number to         |</span>
<span class="cm">|                                                   configure (0 to 3)       |</span>
<span class="cm">|                     unsigned char_ b_CounterRange        : Selection form counter   |</span>
<span class="cm">|                                                   range.                   |</span>
<span class="cm">|                     unsigned char_ b_FirstCounterModus   : First counter operating  |</span>
<span class="cm">|                                                   mode.                    |</span>
<span class="cm">|                     unsigned char_ b_FirstCounterOption  : First counter  option.   |</span>
<span class="cm">|                     unsigned char_ b_SecondCounterModus  : Second counter operating |</span>
<span class="cm">|                                                   mode.                    |</span>
<span class="cm">|                     unsigned char_ b_SecondCounterOption : Second counter  option.  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0: No error                                            |</span>
<span class="cm">|                    -1: The handle parameter of the board is wrong          |</span>
<span class="cm">|                    -2: The module is not a counter module                  |</span>
<span class="cm">|                    -3: The selected counter range is wrong.                |</span>
<span class="cm">|                    -4: The selected first counter operating mode is wrong. |</span>
<span class="cm">|                    -5: The selected first counter operating option is wrong|</span>
<span class="cm">|                    -6: The selected second counter operating mode is wrong.|</span>
<span class="cm">|                    -7: The selected second counter operating option is     |</span>
<span class="cm">|                        wrong.                                              |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InitCounter</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_CounterRange</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_FirstCounterModus</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_FirstCounterOption</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_SecondCounterModus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_SecondCounterOption</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*******************************/</span>
	<span class="cm">/* Test if incremental counter */</span>
	<span class="cm">/*******************************/</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
			<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">APCI1710_INCREMENTAL_COUNTER</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/**************************/</span>
		<span class="cm">/* Test the counter range */</span>
	   <span class="cm">/**************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b_CounterRange</span> <span class="o">==</span> <span class="n">APCI1710_16BIT_COUNTER</span>
			<span class="o">||</span> <span class="n">b_CounterRange</span> <span class="o">==</span> <span class="n">APCI1710_32BIT_COUNTER</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/********************************/</span>
			<span class="cm">/* Test the first counter modus */</span>
	      <span class="cm">/********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_FirstCounterModus</span> <span class="o">==</span> <span class="n">APCI1710_QUADRUPLE_MODE</span> <span class="o">||</span>
				<span class="n">b_FirstCounterModus</span> <span class="o">==</span> <span class="n">APCI1710_DOUBLE_MODE</span> <span class="o">||</span>
				<span class="n">b_FirstCounterModus</span> <span class="o">==</span> <span class="n">APCI1710_SIMPLE_MODE</span> <span class="o">||</span>
				<span class="n">b_FirstCounterModus</span> <span class="o">==</span> <span class="n">APCI1710_DIRECT_MODE</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*********************************/</span>
				<span class="cm">/* Test the first counter option */</span>
		 <span class="cm">/*********************************/</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">b_FirstCounterModus</span> <span class="o">==</span> <span class="n">APCI1710_DIRECT_MODE</span>
						<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_FirstCounterOption</span> <span class="o">==</span>
							<span class="n">APCI1710_INCREMENT</span>
							<span class="o">||</span> <span class="n">b_FirstCounterOption</span>
							<span class="o">==</span> <span class="n">APCI1710_DECREMENT</span><span class="p">))</span>
					<span class="o">||</span> <span class="p">(</span><span class="n">b_FirstCounterModus</span> <span class="o">!=</span>
						<span class="n">APCI1710_DIRECT_MODE</span>
						<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_FirstCounterOption</span> <span class="o">==</span>
							<span class="n">APCI1710_HYSTERESIS_ON</span>
							<span class="o">||</span> <span class="n">b_FirstCounterOption</span>
							<span class="o">==</span>
							<span class="n">APCI1710_HYSTERESIS_OFF</span><span class="p">)))</span>
				<span class="p">{</span>
		    <span class="cm">/**************************/</span>
					<span class="cm">/* Test if 16-bit counter */</span>
		    <span class="cm">/**************************/</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">b_CounterRange</span> <span class="o">==</span>
						<span class="n">APCI1710_16BIT_COUNTER</span><span class="p">)</span> <span class="p">{</span>
		       <span class="cm">/*********************************/</span>
						<span class="cm">/* Test the second counter modus */</span>
		       <span class="cm">/*********************************/</span>

						<span class="k">if</span> <span class="p">((</span><span class="n">b_FirstCounterModus</span> <span class="o">!=</span>
								<span class="n">APCI1710_DIRECT_MODE</span>
								<span class="o">&amp;&amp;</span>
								<span class="p">(</span><span class="n">b_SecondCounterModus</span>
									<span class="o">==</span>
									<span class="n">APCI1710_QUADRUPLE_MODE</span>
									<span class="o">||</span>
									<span class="n">b_SecondCounterModus</span>
									<span class="o">==</span>
									<span class="n">APCI1710_DOUBLE_MODE</span>
									<span class="o">||</span>
									<span class="n">b_SecondCounterModus</span>
									<span class="o">==</span>
									<span class="n">APCI1710_SIMPLE_MODE</span><span class="p">))</span>
							<span class="o">||</span> <span class="p">(</span><span class="n">b_FirstCounterModus</span>
								<span class="o">==</span>
								<span class="n">APCI1710_DIRECT_MODE</span>
								<span class="o">&amp;&amp;</span>
								<span class="n">b_SecondCounterModus</span>
								<span class="o">==</span>
								<span class="n">APCI1710_DIRECT_MODE</span><span class="p">))</span>
						<span class="p">{</span>
			  <span class="cm">/**********************************/</span>
							<span class="cm">/* Test the second counter option */</span>
			  <span class="cm">/**********************************/</span>

							<span class="k">if</span> <span class="p">((</span><span class="n">b_SecondCounterModus</span> <span class="o">==</span> <span class="n">APCI1710_DIRECT_MODE</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_SecondCounterOption</span> <span class="o">==</span> <span class="n">APCI1710_INCREMENT</span> <span class="o">||</span> <span class="n">b_SecondCounterOption</span> <span class="o">==</span> <span class="n">APCI1710_DECREMENT</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">b_SecondCounterModus</span> <span class="o">!=</span> <span class="n">APCI1710_DIRECT_MODE</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_SecondCounterOption</span> <span class="o">==</span> <span class="n">APCI1710_HYSTERESIS_ON</span> <span class="o">||</span> <span class="n">b_SecondCounterOption</span> <span class="o">==</span> <span class="n">APCI1710_HYSTERESIS_OFF</span><span class="p">)))</span> <span class="p">{</span>
								<span class="n">i_ReturnValue</span> <span class="o">=</span>
									<span class="mi">0</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			     <span class="cm">/*********************************************************/</span>
								<span class="cm">/* The selected second counter operating option is wrong */</span>
			     <span class="cm">/*********************************************************/</span>

								<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected second counter operating option is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="n">i_ReturnValue</span> <span class="o">=</span>
									<span class="o">-</span><span class="mi">7</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			  <span class="cm">/*******************************************************/</span>
							<span class="cm">/* The selected second counter operating mode is wrong */</span>
			  <span class="cm">/*******************************************************/</span>

							<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected second counter operating mode is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/********************************************************/</span>
					<span class="cm">/* The selected first counter operating option is wrong */</span>
		    <span class="cm">/********************************************************/</span>

					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected first counter operating option is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/******************************************************/</span>
				<span class="cm">/* The selected first counter operating mode is wrong */</span>
		 <span class="cm">/******************************************************/</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected first counter operating mode is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/***************************************/</span>
			<span class="cm">/* The selected counter range is wrong */</span>
	      <span class="cm">/***************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected counter range is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>

	   <span class="cm">/*************************/</span>
		<span class="cm">/* Test if a error occur */</span>
	   <span class="cm">/*************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/**************************/</span>
			<span class="cm">/* Test if 16-Bit counter */</span>
	      <span class="cm">/**************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_CounterRange</span> <span class="o">==</span> <span class="n">APCI1710_32BIT_COUNTER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister1</span> <span class="o">=</span> <span class="n">b_CounterRange</span> <span class="o">|</span>
					<span class="n">b_FirstCounterModus</span> <span class="o">|</span>
					<span class="n">b_FirstCounterOption</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister1</span> <span class="o">=</span> <span class="n">b_CounterRange</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">b_FirstCounterModus</span> <span class="o">&amp;</span> <span class="mh">0x5</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">b_FirstCounterOption</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">b_SecondCounterModus</span> <span class="o">&amp;</span> <span class="mh">0xA</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">b_SecondCounterOption</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>

		 <span class="cm">/***********************/</span>
				<span class="cm">/* Test if direct mode */</span>
		 <span class="cm">/***********************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">b_FirstCounterModus</span> <span class="o">==</span> <span class="n">APCI1710_DIRECT_MODE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister1</span> <span class="o">|</span>
						<span class="n">APCI1710_DIRECT_MODE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

	      <span class="cm">/***************************/</span>
			<span class="cm">/* Write the configuration */</span>
	      <span class="cm">/***************************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/**************************************/</span>
		<span class="cm">/* The module is not a counter module */</span>
	   <span class="cm">/**************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a counter module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_CounterAutoTest                       |</span>
<span class="cm">|                                               (unsigned char_     b_BoardHandle,    |</span>
<span class="cm">|                                                unsigned char *_   pb_TestStatus)     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : A test mode is intended for testing the component and  |</span>
<span class="cm">|                     the connected periphery. All the 8-bit counter chains  |</span>
<span class="cm">|                     are operated internally as down counters.              |</span>
<span class="cm">|                     Independently from the external signals,               |</span>
<span class="cm">|                     all the four 8-bit counter chains are decremented in   |</span>
<span class="cm">|                     parallel by each negative clock pulse edge of CLKX.    |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                       Counter auto test conclusion                         |</span>
<span class="cm">|                       ----------------------------                         |</span>
<span class="cm">|              +-----------------+-----------------------------+             |</span>
<span class="cm">|              | pb_TestStatus   |    Error description        |             |</span>
<span class="cm">|              |     mask        |                             |             |</span>
<span class="cm">|              |-----------------+-----------------------------|             |</span>
<span class="cm">|              |    0000         |     No error detected       |             |</span>
<span class="cm">|              |-----------------|-----------------------------|             |</span>
<span class="cm">|              |    0001         | Error detected of counter 0 |             |</span>
<span class="cm">|              |-----------------|-----------------------------|             |</span>
<span class="cm">|              |    0010         | Error detected of counter 1 |             |</span>
<span class="cm">|              |-----------------|-----------------------------|             |</span>
<span class="cm">|              |    0100         | Error detected of counter 2 |             |</span>
<span class="cm">|              |-----------------|-----------------------------|             |</span>
<span class="cm">|              |    1000         | Error detected of counter 3 |             |</span>
<span class="cm">|              +-----------------+-----------------------------+             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_   b_BoardHandle : Handle of board APCI-1710      |  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_TestStatus  : Auto test conclusion. See table|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_CounterAutoTest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_TestStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_LathchValue</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pb_TestStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/********************************/</span>
	<span class="cm">/* Test if counter module found */</span>
	<span class="cm">/********************************/</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
			<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">APCI1710_INCREMENTAL_COUNTER</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
			<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">APCI1710_INCREMENTAL_COUNTER</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
			<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">APCI1710_INCREMENTAL_COUNTER</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
			<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">APCI1710_INCREMENTAL_COUNTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">b_ModulCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b_ModulCpt</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">b_ModulCpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*******************************/</span>
			<span class="cm">/* Test if incremental counter */</span>
	      <span class="cm">/*******************************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulCpt</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">APCI1710_INCREMENTAL_COUNTER</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/******************/</span>
				<span class="cm">/* Start the test */</span>
		 <span class="cm">/******************/</span>

				<span class="n">outl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulCpt</span><span class="p">));</span>

		 <span class="cm">/*********************/</span>
				<span class="cm">/* Tatch the counter */</span>
		 <span class="cm">/*********************/</span>

				<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulCpt</span><span class="p">));</span>

		 <span class="cm">/************************/</span>
				<span class="cm">/* Read the latch value */</span>
		 <span class="cm">/************************/</span>

				<span class="n">dw_LathchValue</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulCpt</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">dw_LathchValue</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">!=</span>
					<span class="p">((</span><span class="n">dw_LathchValue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dw_LathchValue</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">!=</span>
					<span class="p">((</span><span class="n">dw_LathchValue</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dw_LathchValue</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">!=</span>
					<span class="p">((</span><span class="n">dw_LathchValue</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">pb_TestStatus</span> <span class="o">=</span>
						<span class="o">*</span><span class="n">pb_TestStatus</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>
						<span class="n">b_ModulCpt</span><span class="p">);</span>
				<span class="p">}</span>

		 <span class="cm">/*****************/</span>
				<span class="cm">/* Stop the test */</span>
		 <span class="cm">/*****************/</span>

				<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulCpt</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***************************/</span>
		<span class="cm">/* No counter module found */</span>
	   <span class="cm">/***************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;No counter module found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_InitIndex (unsigned char_ b_BoardHandle,       |</span>
<span class="cm">|                                                 unsigned char_ b_ModulNbr,          |</span>
<span class="cm">|                                                 unsigned char_ b_ReferenceAction,   |</span>
<span class="cm">|                                                 unsigned char_ b_IndexOperation,    |</span>
<span class="cm">|                                                 unsigned char_ b_AutoMode,          |</span>
<span class="cm">|                                                 unsigned char_ b_InterruptEnable)   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Initialise the index corresponding to the selected     |</span>
<span class="cm">|                     module (b_ModulNbr). If a INDEX flag occur, you have   |</span>
<span class="cm">|                     the possibility to clear the 32-Bit counter or to latch|</span>
<span class="cm">|                     the current 32-Bit value in to the first latch         |</span>
<span class="cm">|                     register. The b_IndexOperation parameter give the      |</span>
<span class="cm">|                     possibility to choice the INDEX action.                |</span>
<span class="cm">|                     If you have enabled the automatic mode, each INDEX     |</span>
<span class="cm">|                     action is cleared automatically, else you must read    |</span>
<span class="cm">|                     the index status (&quot;i_APCI1710_ReadIndexStatus&quot;)        |</span>
<span class="cm">|                     after each INDEX action.                               |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                               Index action                                 |</span>
<span class="cm">|                               ------------                                 |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|           +------------------------+------------------------------------+  |</span>
<span class="cm">|           |   b_IndexOperation     |         Operation                  |  |</span>
<span class="cm">|           |------------------------+------------------------------------|  |</span>
<span class="cm">|           |APCI1710_LATCH_COUNTER  | After a index signal, the counter  |  |</span>
<span class="cm">|           |                        | value (32-Bit) is latched in to    |  |</span>
<span class="cm">|           |                        | the first latch register           |  |</span>
<span class="cm">|           |------------------------|------------------------------------|  |</span>
<span class="cm">|           |APCI1710_CLEAR_COUNTER  | After a index signal, the counter  |  |</span>
<span class="cm">|           |                        | value is cleared (32-Bit)          |  |</span>
<span class="cm">|           +------------------------+------------------------------------+  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">|                     unsigned char_ b_ReferenceAction : Determine if the reference   |</span>
<span class="cm">|                                               must set or no for the       |</span>
<span class="cm">|                                               acceptance from index        |</span>
<span class="cm">|                                               APCI1710_ENABLE :            |</span>
<span class="cm">|                                                  Reference must be set for |</span>
<span class="cm">|                                                  accepted the index        |</span>
<span class="cm">|                                               APCI1710_DISABLE :           |</span>
<span class="cm">|                                                  Reference have not        |</span>
<span class="cm">|                                                  importance                |</span>
<span class="cm">|                     unsigned char_ b_IndexOperation  : Index operating mode.        |</span>
<span class="cm">|                                               See table.                   |</span>
<span class="cm">|                     unsigned char_ b_AutoMode        : Enable or disable the        |</span>
<span class="cm">|                                               automatic index reset.       |</span>
<span class="cm">|                                               APCI1710_ENABLE :            |</span>
<span class="cm">|                                                 Enable the automatic mode  |</span>
<span class="cm">|                                               APCI1710_DISABLE :           |</span>
<span class="cm">|                                                 Disable the automatic mode |</span>
<span class="cm">|                     unsigned char_ b_InterruptEnable : Enable or disable the        |</span>
<span class="cm">|                                               interrupt.                   |</span>
<span class="cm">|                                               APCI1710_ENABLE :            |</span>
<span class="cm">|                                               Enable the interrupt         |</span>
<span class="cm">|                                               APCI1710_DISABLE :           |</span>
<span class="cm">|                                               Disable the interrupt        |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4  The reference action parameter is wrong            |</span>
<span class="cm">|                     -5: The index operating mode parameter is wrong        |</span>
<span class="cm">|                     -6: The auto mode parameter is wrong                   |</span>
<span class="cm">|                     -7: Interrupt parameter is wrong                       |</span>
<span class="cm">|                     -8: Interrupt function not initialised.                |</span>
<span class="cm">|                         See function &quot;i_APCI1710_SetBoardIntRoutineX&quot;      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InitIndex</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ReferenceAction</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_IndexOperation</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_AutoMode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_InterruptEnable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/********************************/</span>
			<span class="cm">/* Test the reference parameter */</span>
	      <span class="cm">/********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_ReferenceAction</span> <span class="o">==</span> <span class="n">APCI1710_ENABLE</span> <span class="o">||</span>
				<span class="n">b_ReferenceAction</span> <span class="o">==</span> <span class="n">APCI1710_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/****************************/</span>
				<span class="cm">/* Test the index parameter */</span>
		 <span class="cm">/****************************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">b_IndexOperation</span> <span class="o">==</span>
					<span class="n">APCI1710_HIGH_EDGE_LATCH_COUNTER</span>
					<span class="o">||</span> <span class="n">b_IndexOperation</span> <span class="o">==</span>
					<span class="n">APCI1710_LOW_EDGE_LATCH_COUNTER</span>
					<span class="o">||</span> <span class="n">b_IndexOperation</span> <span class="o">==</span>
					<span class="n">APCI1710_HIGH_EDGE_CLEAR_COUNTER</span>
					<span class="o">||</span> <span class="n">b_IndexOperation</span> <span class="o">==</span>
					<span class="n">APCI1710_LOW_EDGE_CLEAR_COUNTER</span>
					<span class="o">||</span> <span class="n">b_IndexOperation</span> <span class="o">==</span>
					<span class="n">APCI1710_HIGH_EDGE_LATCH_AND_CLEAR_COUNTER</span>
					<span class="o">||</span> <span class="n">b_IndexOperation</span> <span class="o">==</span>
					<span class="n">APCI1710_LOW_EDGE_LATCH_AND_CLEAR_COUNTER</span><span class="p">)</span>
				<span class="p">{</span>
		    <span class="cm">/********************************/</span>
					<span class="cm">/* Test the auto mode parameter */</span>
		    <span class="cm">/********************************/</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">b_AutoMode</span> <span class="o">==</span> <span class="n">APCI1710_ENABLE</span> <span class="o">||</span>
						<span class="n">b_AutoMode</span> <span class="o">==</span> <span class="n">APCI1710_DISABLE</span><span class="p">)</span>
					<span class="p">{</span>
		       <span class="cm">/***************************/</span>
						<span class="cm">/* Test the interrupt mode */</span>
		       <span class="cm">/***************************/</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">b_InterruptEnable</span> <span class="o">==</span>
							<span class="n">APCI1710_ENABLE</span>
							<span class="o">||</span> <span class="n">b_InterruptEnable</span> <span class="o">==</span>
							<span class="n">APCI1710_DISABLE</span><span class="p">)</span> <span class="p">{</span>

			     <span class="cm">/************************************/</span>
							<span class="cm">/* Makte the configuration commando */</span>
			     <span class="cm">/************************************/</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">b_ReferenceAction</span> <span class="o">==</span>
								<span class="n">APCI1710_ENABLE</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister2</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister2</span>
									<span class="o">|</span>
									<span class="n">APCI1710_ENABLE_INDEX_ACTION</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister2</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister2</span>
									<span class="o">&amp;</span>
									<span class="n">APCI1710_DISABLE_INDEX_ACTION</span><span class="p">;</span>
							<span class="p">}</span>

			     <span class="cm">/****************************************/</span>
							<span class="cm">/* Test if low level latch or/and clear */</span>
			     <span class="cm">/****************************************/</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">b_IndexOperation</span> <span class="o">==</span>
								<span class="n">APCI1710_LOW_EDGE_LATCH_COUNTER</span>
								<span class="o">||</span>
								<span class="n">b_IndexOperation</span>
								<span class="o">==</span>
								<span class="n">APCI1710_LOW_EDGE_CLEAR_COUNTER</span>
								<span class="o">||</span>
								<span class="n">b_IndexOperation</span>
								<span class="o">==</span>
								<span class="n">APCI1710_LOW_EDGE_LATCH_AND_CLEAR_COUNTER</span><span class="p">)</span>
							<span class="p">{</span>
				<span class="cm">/*************************************/</span>
								<span class="cm">/* Set the index level to low (DQ26) */</span>
				<span class="cm">/*************************************/</span>

								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">|</span>
									<span class="n">APCI1710_SET_LOW_INDEX_LEVEL</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/**************************************/</span>
								<span class="cm">/* Set the index level to high (DQ26) */</span>
				<span class="cm">/**************************************/</span>

								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">&amp;</span>
									<span class="n">APCI1710_SET_HIGH_INDEX_LEVEL</span><span class="p">;</span>
							<span class="p">}</span>

			     <span class="cm">/***********************************/</span>
							<span class="cm">/* Test if latch and clear counter */</span>
			     <span class="cm">/***********************************/</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">b_IndexOperation</span> <span class="o">==</span>
								<span class="n">APCI1710_HIGH_EDGE_LATCH_AND_CLEAR_COUNTER</span>
								<span class="o">||</span>
								<span class="n">b_IndexOperation</span>
								<span class="o">==</span>
								<span class="n">APCI1710_LOW_EDGE_LATCH_AND_CLEAR_COUNTER</span><span class="p">)</span>
							<span class="p">{</span>
				<span class="cm">/***************************************/</span>
								<span class="cm">/* Set the latch and clear flag (DQ27) */</span>
				<span class="cm">/***************************************/</span>

								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">|</span>
									<span class="n">APCI1710_ENABLE_LATCH_AND_CLEAR</span><span class="p">;</span>
							<span class="p">}</span>	<span class="cm">/*  if (b_IndexOperation == APCI1710_HIGH_EDGE_LATCH_AND_CLEAR_COUNTER || b_IndexOperation == APCI1710_LOW_EDGE_LATCH_AND_CLEAR_COUNTER) */</span>
							<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*****************************************/</span>
								<span class="cm">/* Clear the latch and clear flag (DQ27) */</span>
				<span class="cm">/*****************************************/</span>

								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">&amp;</span>
									<span class="n">APCI1710_DISABLE_LATCH_AND_CLEAR</span><span class="p">;</span>

				<span class="cm">/*************************/</span>
								<span class="cm">/* Test if latch counter */</span>
				<span class="cm">/*************************/</span>

								<span class="k">if</span> <span class="p">(</span><span class="n">b_IndexOperation</span> <span class="o">==</span> <span class="n">APCI1710_HIGH_EDGE_LATCH_COUNTER</span> <span class="o">||</span> <span class="n">b_IndexOperation</span> <span class="o">==</span> <span class="n">APCI1710_LOW_EDGE_LATCH_COUNTER</span><span class="p">)</span> <span class="p">{</span>
				   <span class="cm">/*********************************/</span>
									<span class="cm">/* Enable the latch from counter */</span>
				   <span class="cm">/*********************************/</span>

									<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
										<span class="n">s_ModeRegister</span><span class="p">.</span>
										<span class="n">s_ByteModeRegister</span><span class="p">.</span>
										<span class="n">b_ModeRegister2</span>
										<span class="o">=</span>
										<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
										<span class="n">s_ModeRegister</span><span class="p">.</span>
										<span class="n">s_ByteModeRegister</span><span class="p">.</span>
										<span class="n">b_ModeRegister2</span>
										<span class="o">|</span>
										<span class="n">APCI1710_INDEX_LATCH_COUNTER</span><span class="p">;</span>
								<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				   <span class="cm">/*********************************/</span>
									<span class="cm">/* Enable the clear from counter */</span>
				   <span class="cm">/*********************************/</span>

									<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
										<span class="n">s_ModeRegister</span><span class="p">.</span>
										<span class="n">s_ByteModeRegister</span><span class="p">.</span>
										<span class="n">b_ModeRegister2</span>
										<span class="o">=</span>
										<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
										<span class="n">s_ModeRegister</span><span class="p">.</span>
										<span class="n">s_ByteModeRegister</span><span class="p">.</span>
										<span class="n">b_ModeRegister2</span>
										<span class="o">&amp;</span>
										<span class="p">(</span><span class="o">~</span><span class="n">APCI1710_INDEX_LATCH_COUNTER</span><span class="p">);</span>
								<span class="p">}</span>
							<span class="p">}</span>	<span class="cm">/*  // if (b_IndexOperation == APCI1710_HIGH_EDGE_LATCH_AND_CLEAR_COUNTER || b_IndexOperation == APCI1710_LOW_EDGE_LATCH_AND_CLEAR_COUNTER) */</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">b_AutoMode</span> <span class="o">==</span>
								<span class="n">APCI1710_DISABLE</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister2</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister2</span>
									<span class="o">|</span>
									<span class="n">APCI1710_INDEX_AUTO_MODE</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister2</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister2</span>
									<span class="o">&amp;</span>
									<span class="p">(</span><span class="o">~</span><span class="n">APCI1710_INDEX_AUTO_MODE</span><span class="p">);</span>
							<span class="p">}</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">b_InterruptEnable</span> <span class="o">==</span>
								<span class="n">APCI1710_ENABLE</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister3</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister3</span>
									<span class="o">|</span>
									<span class="n">APCI1710_ENABLE_INDEX_INT</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister3</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister3</span>
									<span class="o">&amp;</span>
									<span class="n">APCI1710_DISABLE_INDEX_INT</span><span class="p">;</span>
							<span class="p">}</span>

							<span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
								<span class="n">s_InitFlag</span><span class="p">.</span>
								<span class="n">b_IndexInit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			  <span class="cm">/********************************/</span>
							<span class="cm">/* Interrupt parameter is wrong */</span>
			  <span class="cm">/********************************/</span>
							<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Interrupt parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">7</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		       <span class="cm">/************************************/</span>
						<span class="cm">/* The auto mode parameter is wrong */</span>
		       <span class="cm">/************************************/</span>

						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The auto mode parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/***********************************************/</span>
					<span class="cm">/* The index operating mode parameter is wrong */</span>
		    <span class="cm">/***********************************************/</span>

					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The index operating mode parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*******************************************/</span>
				<span class="cm">/* The reference action parameter is wrong */</span>
		 <span class="cm">/*******************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The reference action parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_InitReference                         |</span>
<span class="cm">|                                                (unsigned char_ b_BoardHandle,       |</span>
<span class="cm">|                                                 unsigned char_ b_ModulNbr,          |</span>
<span class="cm">|                                                 unsigned char_ b_ReferenceLevel)    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Initialise the reference corresponding to the selected |</span>
<span class="cm">|                     module (b_ModulNbr).                                   |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                               Reference level                              |</span>
<span class="cm">|                               ---------------                              |</span>
<span class="cm">|             +--------------------+-------------------------+               |</span>
<span class="cm">|             | b_ReferenceLevel   |         Operation       |               |</span>
<span class="cm">|             +--------------------+-------------------------+               |</span>
<span class="cm">|             |   APCI1710_LOW     |  Reference occur if &quot;0&quot; |               |</span>
<span class="cm">|             |--------------------|-------------------------|               |</span>
<span class="cm">|             |   APCI1710_HIGH    |  Reference occur if &quot;1&quot; |               |</span>
<span class="cm">|             +--------------------+-------------------------+               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">|                     unsigned char_ b_ReferenceLevel  : Reference level.             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: The selected module number parameter is wrong      |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Reference level parameter is wrong                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InitReference</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ReferenceLevel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/**************************************/</span>
			<span class="cm">/* Test the reference level parameter */</span>
	      <span class="cm">/**************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_ReferenceLevel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">b_ReferenceLevel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">b_ReferenceLevel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister2</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister2</span> <span class="o">|</span>
						<span class="n">APCI1710_REFERENCE_HIGH</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister2</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister2</span> <span class="o">&amp;</span>
						<span class="n">APCI1710_REFERENCE_LOW</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
					<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_ReferenceInit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/**************************************/</span>
				<span class="cm">/* Reference level parameter is wrong */</span>
		 <span class="cm">/**************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Reference level parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_	i_APCI1710_InitExternalStrobe                |</span>
<span class="cm">|					(unsigned char_ b_BoardHandle,                |</span>
<span class="cm">|					 unsigned char_ b_ModulNbr,                   |</span>
<span class="cm">|					 unsigned char_ b_ExternalStrobe,             |</span>
<span class="cm">|					 unsigned char_ b_ExternalStrobeLevel)        |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Initialises the external strobe level corresponding to |</span>
<span class="cm">|		      the selected module (b_ModulNbr).                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">|		      unsigned char_ b_ExternalStrobe  : External strobe selection    |</span>
<span class="cm">|						0 : External strobe A        |</span>
<span class="cm">|						1 : External strobe B        |</span>
<span class="cm">|		      unsigned char_ b_ExternalStrobeLevel : External strobe level    |</span>
<span class="cm">|						APCI1710_LOW :               |</span>
<span class="cm">|						External latch occurs if &quot;0&quot; |</span>
<span class="cm">|						APCI1710_HIGH :              |</span>
<span class="cm">|						External latch occurs if &quot;1&quot; |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: The selected module number is wrong                |</span>
<span class="cm">|                     -3: Counter not initialised.                           |</span>
<span class="cm">|			  See function &quot;i_APCI1710_InitCounter&quot;              |</span>
<span class="cm">|                     -4: External strobe selection is wrong                 |</span>
<span class="cm">|                     -5: External strobe level parameter is wrong           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InitExternalStrobe</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ExternalStrobe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ExternalStrobeLevel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/**************************************/</span>
			<span class="cm">/* Test the external strobe selection */</span>
	      <span class="cm">/**************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_ExternalStrobe</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">b_ExternalStrobe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/******************/</span>
				<span class="cm">/* Test the level */</span>
		 <span class="cm">/******************/</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">b_ExternalStrobeLevel</span> <span class="o">==</span> <span class="n">APCI1710_HIGH</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">((</span><span class="n">b_ExternalStrobeLevel</span> <span class="o">==</span> <span class="n">APCI1710_LOW</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_BoardInfos</span><span class="p">.</span>
								<span class="n">dw_MolduleConfiguration</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
								<span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;=</span>
							<span class="mh">0x3135</span><span class="p">)))</span> <span class="p">{</span>
		    <span class="cm">/*****************/</span>
					<span class="cm">/* Set the level */</span>
		    <span class="cm">/*****************/</span>

					<span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister4</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister4</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span>
							<span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">b_ExternalStrobe</span><span class="p">)))</span> <span class="o">|</span> <span class="p">((</span><span class="n">b_ExternalStrobeLevel</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">b_ExternalStrobe</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/********************************************/</span>
					<span class="cm">/* External strobe level parameter is wrong */</span>
		    <span class="cm">/********************************************/</span>

					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;External strobe level parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>	<span class="cm">/*  if (b_ExternalStrobe == 0 || b_ExternalStrobe == 1) */</span>
			<span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/**************************************/</span>
				<span class="cm">/* External strobe selection is wrong */</span>
		 <span class="cm">/**************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;External strobe selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/*  if (b_ExternalStrobe == 0 || b_ExternalStrobe == 1) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Function Name     : _INT_ i_APCI1710_InitCompareLogic                      |</span>
<span class="cm">	   |                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">	   |                                unsigned char_   b_ModulNbr,                         |</span>
<span class="cm">	   |                                unsigned int_  ui_CompareValue)                     |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Task              : Set the 32-Bit compare value. At that moment that the  |</span>
<span class="cm">	   |                     incremental counter arrive to the compare value        |</span>
<span class="cm">	   |                     (ui_CompareValue) a interrupt is generated.            |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">	   |                     unsigned char_  b_ModulNbr       : Module number to configure   |</span>
<span class="cm">	   |                                               (0 to 3)                     |</span>
<span class="cm">	   |                     unsigned int_ ui_CompareValue   : 32-Bit compare value         |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Output Parameters : -</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Return Value      :  0: No error                                           |</span>
<span class="cm">	   |                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">	   |                     -2: No counter module found                            |</span>
<span class="cm">	   |                     -3: Counter not initialised see function               |</span>
<span class="cm">	   |                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	 */</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InitCompareLogic</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_CompareValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">outl</span><span class="p">(</span><span class="n">ui_CompareValue</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">28</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CompareLogicInit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_InitFrequencyMeasurement              |</span>
<span class="cm">|				(unsigned char_		 b_BoardHandle,              |</span>
<span class="cm">|				 unsigned char_		 b_ModulNbr,                 |</span>
<span class="cm">|				 unsigned char_		 b_PCIInputClock,            |</span>
<span class="cm">|				 unsigned char_		 b_TimingUnity,              |</span>
<span class="cm">|				 ULONG_ 	ul_TimingInterval,           |</span>
<span class="cm">|				 PULONG_       pul_RealTimingInterval)       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Sets the time for the frequency measurement.           |</span>
<span class="cm">|		      Configures the selected TOR incremental counter of the |</span>
<span class="cm">|		      selected module (b_ModulNbr). The ul_TimingInterval and|</span>
<span class="cm">|		      ul_TimingUnity determine the time base for the         |</span>
<span class="cm">|		      measurement. The pul_RealTimingInterval returns the    |</span>
<span class="cm">|		      real time value. You must call up this function before |</span>
<span class="cm">|		      you call up any other function which gives access to   |</span>
<span class="cm">|		      the frequency measurement.                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">|		      unsigned char_  b_ModulNbr	      :	Number of the module to be   |</span>
<span class="cm">|						configured (0 to 3)          |</span>
<span class="cm">|		      unsigned char_  b_PCIInputClock  :	Selection of the PCI bus     |</span>
<span class="cm">|						clock                        |</span>
<span class="cm">|						- APCI1710_30MHZ :           |</span>
<span class="cm">|						  The PC has a PCI bus clock |</span>
<span class="cm">|						  of 30 MHz                  |</span>
<span class="cm">|						- APCI1710_33MHZ :           |</span>
<span class="cm">|						  The PC has a PCI bus clock |</span>
<span class="cm">|						  of 33 MHz                  |</span>
<span class="cm">|		      unsigned char_  b_TimingUnity    : Base time unit (0 to 2)      |</span>
<span class="cm">|						  0 : ns                     |</span>
<span class="cm">|						  1 : æs                     |</span>
<span class="cm">|						  2 : ms                     |</span>
<span class="cm">|		      ULONG_ ul_TimingInterval: Base time value.             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : PULONG_ pul_RealTimingInterval : Real base time value. |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: The selected module number is wrong                |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|			  &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: The selected PCI input clock is wrong              |</span>
<span class="cm">|                     -5: Timing unity selection is wrong                    |</span>
<span class="cm">|                     -6: Base timing selection is wrong                     |</span>
<span class="cm">|		      -7: 40MHz quartz not on board                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InitFrequencyMeasurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_PCIInputClock</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_TimingUnity</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_TimingInterval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pul_RealTimingInterval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_TimerValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">d_RealTimingInterval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/**************************/</span>
			<span class="cm">/* Test the PCI bus clock */</span>
	      <span class="cm">/**************************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_30MHZ</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_33MHZ</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">))</span> <span class="p">{</span>
		 <span class="cm">/************************/</span>
				<span class="cm">/* Test the timing unit */</span>
		 <span class="cm">/************************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/**********************************/</span>
					<span class="cm">/* Test the base timing selection */</span>
		    <span class="cm">/**********************************/</span>

					<span class="k">if</span> <span class="p">(((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_30MHZ</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span>
								<span class="mi">266</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span>
								<span class="mi">8738133UL</span><span class="p">))</span>
						<span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
								<span class="n">APCI1710_30MHZ</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span>
								<span class="mi">1</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span>
								<span class="mi">8738UL</span><span class="p">))</span>
						<span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
								<span class="n">APCI1710_30MHZ</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span>
								<span class="mi">1</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span>
								<span class="mi">8UL</span><span class="p">))</span>
						<span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
								<span class="n">APCI1710_33MHZ</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span>
								<span class="mi">242</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span>
								<span class="mi">7943757UL</span><span class="p">))</span>
						<span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
								<span class="n">APCI1710_33MHZ</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span>
								<span class="mi">1</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span>
								<span class="mi">7943UL</span><span class="p">))</span>
						<span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
								<span class="n">APCI1710_33MHZ</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span>
								<span class="mi">1</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span>
								<span class="mi">7UL</span><span class="p">))</span>
						<span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
								<span class="n">APCI1710_40MHZ</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span>
								<span class="mi">200</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span>
								<span class="mi">6553500UL</span><span class="p">))</span>
						<span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
								<span class="n">APCI1710_40MHZ</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span>
								<span class="mi">1</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span>
								<span class="mi">6553UL</span><span class="p">))</span>
						<span class="o">||</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
								<span class="n">APCI1710_40MHZ</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b_TimingUnity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&gt;=</span>
								<span class="mi">1</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ul_TimingInterval</span> <span class="o">&lt;=</span>
								<span class="mi">6UL</span><span class="p">)))</span> <span class="p">{</span>
		       <span class="cm">/**********************/</span>
						<span class="cm">/* Test if 40MHz used */</span>
		       <span class="cm">/**********************/</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
							<span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="p">{</span>
			  <span class="cm">/******************************/</span>
							<span class="cm">/* Test if firmware &gt;= Rev1.5 */</span>
			  <span class="cm">/******************************/</span>

							<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x3135</span><span class="p">)</span> <span class="p">{</span>
			     <span class="cm">/*********************************/</span>
								<span class="cm">/* Test if 40MHz quartz on board */</span>
			     <span class="cm">/*********************************/</span>

								<span class="cm">/*INPDW (ps_APCI1710Variable-&gt;</span>
<span class="cm">								   s_Board [b_BoardHandle].</span>
<span class="cm">								   s_BoardInfos.</span>
<span class="cm">								   ui_Address + 36 + (64 * b_ModulNbr), &amp;dw_Status); */</span>
								<span class="n">dw_Status</span> <span class="o">=</span>
									<span class="n">inl</span>
									<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_BoardInfos</span><span class="p">.</span>
									<span class="n">ui_Address</span>
									<span class="o">+</span> <span class="mi">36</span> <span class="o">+</span>
									<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			     <span class="cm">/******************************/</span>
								<span class="cm">/* Test the quartz flag (DQ0) */</span>
			     <span class="cm">/******************************/</span>

								<span class="k">if</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*****************************/</span>
									<span class="cm">/* 40MHz quartz not on board */</span>
				<span class="cm">/*****************************/</span>

									<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;40MHz quartz not on board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
									<span class="n">i_ReturnValue</span>
										<span class="o">=</span>
										<span class="o">-</span><span class="mi">7</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			     <span class="cm">/*****************************/</span>
								<span class="cm">/* 40MHz quartz not on board */</span>
			     <span class="cm">/*****************************/</span>
								<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;40MHz quartz not on board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="n">i_ReturnValue</span> <span class="o">=</span>
									<span class="o">-</span><span class="mi">7</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>	<span class="cm">/*  if (b_PCIInputClock == APCI1710_40MHZ) */</span>

		       <span class="cm">/***************************/</span>
						<span class="cm">/* Test if not error occur */</span>
		       <span class="cm">/***************************/</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			  <span class="cm">/****************************/</span>
							<span class="cm">/* Test the INC_CPT version */</span>
			  <span class="cm">/****************************/</span>

							<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x3131</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/**********************/</span>
								<span class="cm">/* Test if 40MHz used */</span>
				<span class="cm">/**********************/</span>

								<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="p">{</span>
				   <span class="cm">/*********************************/</span>
									<span class="cm">/* Enable the 40MHz quarz (DQ30) */</span>
				   <span class="cm">/*********************************/</span>

									<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
										<span class="n">s_ModeRegister</span><span class="p">.</span>
										<span class="n">s_ByteModeRegister</span><span class="p">.</span>
										<span class="n">b_ModeRegister4</span>
										<span class="o">=</span>
										<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
										<span class="n">s_ModeRegister</span><span class="p">.</span>
										<span class="n">s_ByteModeRegister</span><span class="p">.</span>
										<span class="n">b_ModeRegister4</span>
										<span class="o">|</span>
										<span class="n">APCI1710_ENABLE_40MHZ_FREQUENCY</span><span class="p">;</span>
								<span class="p">}</span>	<span class="cm">/*  if (b_PCIInputClock == APCI1710_40MHZ) */</span>
								<span class="k">else</span> <span class="p">{</span>
				   <span class="cm">/**********************************/</span>
									<span class="cm">/* Disable the 40MHz quarz (DQ30) */</span>
				   <span class="cm">/**********************************/</span>

									<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
										<span class="n">s_ModeRegister</span><span class="p">.</span>
										<span class="n">s_ByteModeRegister</span><span class="p">.</span>
										<span class="n">b_ModeRegister4</span>
										<span class="o">=</span>
										<span class="n">devpriv</span><span class="o">-&gt;</span>
										<span class="n">s_ModuleInfo</span>
										<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
										<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
										<span class="n">s_ModeRegister</span><span class="p">.</span>
										<span class="n">s_ByteModeRegister</span><span class="p">.</span>
										<span class="n">b_ModeRegister4</span>
										<span class="o">&amp;</span>
										<span class="n">APCI1710_DISABLE_40MHZ_FREQUENCY</span><span class="p">;</span>

								<span class="p">}</span>	<span class="cm">/*  if (b_PCIInputClock == APCI1710_40MHZ) */</span>

			     <span class="cm">/********************************/</span>
								<span class="cm">/* Calculate the division fator */</span>
			     <span class="cm">/********************************/</span>

								<span class="n">fpu_begin</span><span class="p">();</span>
								<span class="k">switch</span> <span class="p">(</span><span class="n">b_TimingUnity</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/******/</span>
									<span class="cm">/* ns */</span>
				<span class="cm">/******/</span>

								<span class="k">case</span> <span class="mi">0</span>:

					<span class="cm">/******************/</span>
									<span class="cm">/* Timer 0 factor */</span>
					<span class="cm">/******************/</span>

									<span class="n">ul_TimerValue</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
										<span class="p">(</span><span class="n">ul_TimingInterval</span>
										<span class="o">*</span>
										<span class="p">(</span><span class="mf">0.00025</span> <span class="o">*</span> <span class="n">b_PCIInputClock</span><span class="p">));</span>

					<span class="cm">/*******************/</span>
									<span class="cm">/* Round the value */</span>
					<span class="cm">/*******************/</span>

									<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimingInterval</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.00025</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="p">{</span>
										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">+</span>
											<span class="mi">1</span><span class="p">;</span>
									<span class="p">}</span>

					<span class="cm">/*****************************/</span>
									<span class="cm">/* Calculate the real timing */</span>
					<span class="cm">/*****************************/</span>

									<span class="o">*</span><span class="n">pul_RealTimingInterval</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
										<span class="p">(</span><span class="n">ul_TimerValue</span>
										<span class="o">/</span>
										<span class="p">(</span><span class="mf">0.00025</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">));</span>
									<span class="n">d_RealTimingInterval</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
										<span class="n">ul_TimerValue</span>
										<span class="o">/</span>
										<span class="p">(</span><span class="mf">0.00025</span>
										<span class="o">*</span>
										<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
										<span class="n">b_PCIInputClock</span><span class="p">);</span>

									<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.00025</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="n">pul_RealTimingInterval</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="p">{</span>
										<span class="o">*</span><span class="n">pul_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="o">*</span><span class="n">pul_RealTimingInterval</span>
											<span class="o">+</span>
											<span class="mi">1</span><span class="p">;</span>
									<span class="p">}</span>

									<span class="n">ul_TimingInterval</span>
										<span class="o">=</span>
										<span class="n">ul_TimingInterval</span>
										<span class="o">-</span>
										<span class="mi">1</span><span class="p">;</span>
									<span class="n">ul_TimerValue</span>
										<span class="o">=</span>
										<span class="n">ul_TimerValue</span>
										<span class="o">-</span>
										<span class="mi">2</span><span class="p">;</span>

									<span class="k">break</span><span class="p">;</span>

				<span class="cm">/******/</span>
									<span class="cm">/* æs */</span>
				<span class="cm">/******/</span>

								<span class="k">case</span> <span class="mi">1</span>:

					<span class="cm">/******************/</span>
									<span class="cm">/* Timer 0 factor */</span>
					<span class="cm">/******************/</span>

									<span class="n">ul_TimerValue</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
										<span class="p">(</span><span class="n">ul_TimingInterval</span>
										<span class="o">*</span>
										<span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">b_PCIInputClock</span><span class="p">));</span>

					<span class="cm">/*******************/</span>
									<span class="cm">/* Round the value */</span>
					<span class="cm">/*******************/</span>

									<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimingInterval</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="p">{</span>
										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">+</span>
											<span class="mi">1</span><span class="p">;</span>
									<span class="p">}</span>

					<span class="cm">/*****************************/</span>
									<span class="cm">/* Calculate the real timing */</span>
					<span class="cm">/*****************************/</span>

									<span class="o">*</span><span class="n">pul_RealTimingInterval</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
										<span class="p">(</span><span class="n">ul_TimerValue</span>
										<span class="o">/</span>
										<span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">));</span>
									<span class="n">d_RealTimingInterval</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
										<span class="n">ul_TimerValue</span>
										<span class="o">/</span>
										<span class="p">(</span>
										<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
										<span class="mf">0.25</span>
										<span class="o">*</span>
										<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
										<span class="n">b_PCIInputClock</span><span class="p">);</span>

									<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="n">pul_RealTimingInterval</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="p">{</span>
										<span class="o">*</span><span class="n">pul_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="o">*</span><span class="n">pul_RealTimingInterval</span>
											<span class="o">+</span>
											<span class="mi">1</span><span class="p">;</span>
									<span class="p">}</span>

									<span class="n">ul_TimingInterval</span>
										<span class="o">=</span>
										<span class="n">ul_TimingInterval</span>
										<span class="o">-</span>
										<span class="mi">1</span><span class="p">;</span>
									<span class="n">ul_TimerValue</span>
										<span class="o">=</span>
										<span class="n">ul_TimerValue</span>
										<span class="o">-</span>
										<span class="mi">2</span><span class="p">;</span>

									<span class="k">break</span><span class="p">;</span>

				<span class="cm">/******/</span>
									<span class="cm">/* ms */</span>
				<span class="cm">/******/</span>

								<span class="k">case</span> <span class="mi">2</span>:

					<span class="cm">/******************/</span>
									<span class="cm">/* Timer 0 factor */</span>
					<span class="cm">/******************/</span>

									<span class="n">ul_TimerValue</span>
										<span class="o">=</span>
										<span class="n">ul_TimingInterval</span>
										<span class="o">*</span>
										<span class="p">(</span><span class="mf">250.0</span>
										<span class="o">*</span>
										<span class="n">b_PCIInputClock</span><span class="p">);</span>

					<span class="cm">/*******************/</span>
									<span class="cm">/* Round the value */</span>
					<span class="cm">/*******************/</span>

									<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimingInterval</span> <span class="o">*</span> <span class="p">(</span><span class="mf">250.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="p">{</span>
										<span class="n">ul_TimerValue</span>
											<span class="o">=</span>
											<span class="n">ul_TimerValue</span>
											<span class="o">+</span>
											<span class="mi">1</span><span class="p">;</span>
									<span class="p">}</span>

					<span class="cm">/*****************************/</span>
									<span class="cm">/* Calculate the real timing */</span>
					<span class="cm">/*****************************/</span>

									<span class="o">*</span><span class="n">pul_RealTimingInterval</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
										<span class="p">(</span><span class="n">ul_TimerValue</span>
										<span class="o">/</span>
										<span class="p">(</span><span class="mf">250.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">));</span>
									<span class="n">d_RealTimingInterval</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
										<span class="n">ul_TimerValue</span>
										<span class="o">/</span>
										<span class="p">(</span><span class="mf">250.0</span>
										<span class="o">*</span>
										<span class="p">(</span><span class="kt">double</span><span class="p">)</span>
										<span class="n">b_PCIInputClock</span><span class="p">);</span>

									<span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">ul_TimerValue</span> <span class="o">/</span> <span class="p">(</span><span class="mf">250.0</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">b_PCIInputClock</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="n">pul_RealTimingInterval</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="p">{</span>
										<span class="o">*</span><span class="n">pul_RealTimingInterval</span>
											<span class="o">=</span>
											<span class="o">*</span><span class="n">pul_RealTimingInterval</span>
											<span class="o">+</span>
											<span class="mi">1</span><span class="p">;</span>
									<span class="p">}</span>

									<span class="n">ul_TimingInterval</span>
										<span class="o">=</span>
										<span class="n">ul_TimingInterval</span>
										<span class="o">-</span>
										<span class="mi">1</span><span class="p">;</span>
									<span class="n">ul_TimerValue</span>
										<span class="o">=</span>
										<span class="n">ul_TimerValue</span>
										<span class="o">-</span>
										<span class="mi">2</span><span class="p">;</span>

									<span class="k">break</span><span class="p">;</span>
								<span class="p">}</span>

								<span class="n">fpu_end</span><span class="p">();</span>
			     <span class="cm">/*************************/</span>
								<span class="cm">/* Write the timer value */</span>
			     <span class="cm">/*************************/</span>

								<span class="n">outl</span><span class="p">(</span><span class="n">ul_TimerValue</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			     <span class="cm">/*******************************/</span>
								<span class="cm">/* Set the initialisation flag */</span>
			     <span class="cm">/*******************************/</span>

								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_InitFlag</span><span class="p">.</span>
									<span class="n">b_FrequencyMeasurementInit</span>
									<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			     <span class="cm">/***************************/</span>
								<span class="cm">/* Counter not initialised */</span>
			     <span class="cm">/***************************/</span>

								<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="n">i_ReturnValue</span> <span class="o">=</span>
									<span class="o">-</span><span class="mi">3</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>	<span class="cm">/*  if (i_ReturnValue == 0) */</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		       <span class="cm">/**********************************/</span>
						<span class="cm">/* Base timing selection is wrong */</span>
		       <span class="cm">/**********************************/</span>

						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Base timing selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/***********************************/</span>
					<span class="cm">/* Timing unity selection is wrong */</span>
		    <span class="cm">/***********************************/</span>

					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timing unity selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*****************************************/</span>
				<span class="cm">/* The selected PCI input clock is wrong */</span>
		 <span class="cm">/*****************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected PCI input clock is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*########################################################################### */</span>

							<span class="cm">/* INSN BITS */</span>
<span class="cm">/*########################################################################### */</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     :INT	i_APCI1710_InsnBitsINCCPT(struct comedi_device *dev,struct comedi_subdevice *s,</span>
<span class="cm">struct comedi_insn *insn,unsigned int *data)                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Set &amp; Clear Functions for INC_CPT                                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InsnBitsINCCPT</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_BitsType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ui_BitsType</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>	<span class="cm">/*  Save the current process task structure */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ui_BitsType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APCI1710_INCCPT_CLEARCOUNTERVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_ClearCounterValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_CLEARALLCOUNTERVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_ClearAllCounterValue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_SETINPUTFILTER</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_SetInputFilter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_LATCHCOUNTER</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_LatchCounter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_SETINDEXANDREFERENCESOURCE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_SetIndexAndReferenceSource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_SETDIGITALCHLON</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_SetDigitalChlOn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_SETDIGITALCHLOFF</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_SetDigitalChlOff</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bits Config Parameter Wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_ClearCounterValue                     |</span>
<span class="cm">|                               (unsigned char_      b_BoardHandle,                   |</span>
<span class="cm">|                                unsigned char_       b_ModulNbr)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Clear the counter value from selected module           |</span>
<span class="cm">|                     (b_ModulNbr).                                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle : Handle of board APCI-1710        |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr    : Module number to configure       |</span>
<span class="cm">|                                           (0 to 3)                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: The selected module number parameter is wrong      |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_ClearCounterValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*********************/</span>
			<span class="cm">/* Clear the counter */</span>
	      <span class="cm">/*********************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_ClearAllCounterValue                  |</span>
<span class="cm">|                               (unsigned char_      b_BoardHandle)                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Clear all counter value.                               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle : Handle of board APCI-1710        |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_ClearAllCounterValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/********************************/</span>
	<span class="cm">/* Test if counter module found */</span>
	<span class="cm">/********************************/</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
			<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">APCI1710_INCREMENTAL_COUNTER</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
			<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">APCI1710_INCREMENTAL_COUNTER</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
			<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">APCI1710_INCREMENTAL_COUNTER</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
			<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">APCI1710_INCREMENTAL_COUNTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">b_ModulCpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b_ModulCpt</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">b_ModulCpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*******************************/</span>
			<span class="cm">/* Test if incremental counter */</span>
	      <span class="cm">/*******************************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulCpt</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">APCI1710_INCREMENTAL_COUNTER</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*********************/</span>
				<span class="cm">/* Clear the counter */</span>
		 <span class="cm">/*********************/</span>

				<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulCpt</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***************************/</span>
		<span class="cm">/* No counter module found */</span>
	   <span class="cm">/***************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;No counter module found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_SetInputFilter                        |</span>
<span class="cm">|					(unsigned char_ b_BoardHandle,                |</span>
<span class="cm">|					 unsigned char_ b_Module,                     |</span>
<span class="cm">|					 unsigned char_ b_PCIInputClock,              |</span>
<span class="cm">|					 unsigned char_ b_Filter)     		     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Disable or enable the software filter from selected    |</span>
<span class="cm">|		      module (b_ModulNbr). b_Filter determine the filter time|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">|		      unsigned char_  b_ModulNbr	      :	Number of the module to be   |</span>
<span class="cm">|						configured (0 to 3)          |</span>
<span class="cm">|		      unsigned char_  b_PCIInputClock  :	Selection of the PCI bus     |</span>
<span class="cm">|						clock                        |</span>
<span class="cm">|						- APCI1710_30MHZ :           |</span>
<span class="cm">|						  The PC has a PCI bus clock |</span>
<span class="cm">|						  of 30 MHz                  |</span>
<span class="cm">|						- APCI1710_33MHZ :           |</span>
<span class="cm">|						  The PC has a PCI bus clock |</span>
<span class="cm">|						  of 33 MHz                  |</span>
<span class="cm">|						- APCI1710_40MHZ :           |</span>
<span class="cm">|						  The APCI1710 has a 40MHz    |</span>
<span class="cm">|						  quartz		     |</span>
<span class="cm">|		      unsigned char_  b_Filter	      : Filter selection             |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|				30 MHz                                       |</span>
<span class="cm">|				------                                       |</span>
<span class="cm">|					0:  Software filter not used         |</span>
<span class="cm">|					1:  Filter from 266ns  (3.750000MHz) |</span>
<span class="cm">|					2:  Filter from 400ns  (2.500000MHz) |</span>
<span class="cm">|					3:  Filter from 533ns  (1.876170MHz) |</span>
<span class="cm">|					4:  Filter from 666ns  (1.501501MHz) |</span>
<span class="cm">|					5:  Filter from 800ns  (1.250000MHz) |</span>
<span class="cm">|					6:  Filter from 933ns  (1.071800MHz) |</span>
<span class="cm">|					7:  Filter from 1066ns (0.938080MHz) |</span>
<span class="cm">|					8:  Filter from 1200ns (0.833333MHz) |</span>
<span class="cm">|					9:  Filter from 1333ns (0.750000MHz) |</span>
<span class="cm">|					10: Filter from 1466ns (0.682100MHz) |</span>
<span class="cm">|					11: Filter from 1600ns (0.625000MHz) |</span>
<span class="cm">|					12: Filter from 1733ns (0.577777MHz) |</span>
<span class="cm">|					13: Filter from 1866ns (0.535900MHz) |</span>
<span class="cm">|					14: Filter from 2000ns (0.500000MHz) |</span>
<span class="cm">|					15: Filter from 2133ns (0.468800MHz) |</span>
<span class="cm">|									     |</span>
<span class="cm">|				33 MHz                                       |</span>
<span class="cm">|				------                                       |</span>
<span class="cm">|					0:  Software filter not used         |</span>
<span class="cm">|					1:  Filter from 242ns  (4.125000MHz) |</span>
<span class="cm">|					2:  Filter from 363ns  (2.754820MHz) |</span>
<span class="cm">|					3:  Filter from 484ns  (2.066115MHz) |</span>
<span class="cm">|					4:  Filter from 605ns  (1.652892MHz) |</span>
<span class="cm">|					5:  Filter from 726ns  (1.357741MHz) |</span>
<span class="cm">|					6:  Filter from 847ns  (1.180637MHz) |</span>
<span class="cm">|					7:  Filter from 968ns  (1.033055MHz) |</span>
<span class="cm">|					8:  Filter from 1089ns (0.918273MHz) |</span>
<span class="cm">|					9:  Filter from 1210ns (0.826446MHz) |</span>
<span class="cm">|					10: Filter from 1331ns (0.751314MHz) |</span>
<span class="cm">|					11: Filter from 1452ns (0.688705MHz) |</span>
<span class="cm">|					12: Filter from 1573ns (0.635727MHz) |</span>
<span class="cm">|					13: Filter from 1694ns (0.590318MHz) |</span>
<span class="cm">|					14: Filter from 1815ns (0.550964MHz) |</span>
<span class="cm">|					15: Filter from 1936ns (0.516528MHz) |</span>
<span class="cm">|									     |</span>
<span class="cm">|				40 MHz                                       |</span>
<span class="cm">|				------                                       |</span>
<span class="cm">|					0:  Software filter not used         |</span>
<span class="cm">|					1:  Filter from 200ns  (5.000000MHz) |</span>
<span class="cm">|					2:  Filter from 300ns  (3.333333MHz) |</span>
<span class="cm">|					3:  Filter from 400ns  (2.500000MHz) |</span>
<span class="cm">|					4:  Filter from 500ns  (2.000000MHz) |</span>
<span class="cm">|					5:  Filter from 600ns  (1.666666MHz) |</span>
<span class="cm">|					6:  Filter from 700ns  (1.428500MHz) |</span>
<span class="cm">|					7:  Filter from 800ns  (1.250000MHz) |</span>
<span class="cm">|					8:  Filter from 900ns  (1.111111MHz) |</span>
<span class="cm">|					9:  Filter from 1000ns (1.000000MHz) |</span>
<span class="cm">|					10: Filter from 1100ns (0.909090MHz) |</span>
<span class="cm">|					11: Filter from 1200ns (0.833333MHz) |</span>
<span class="cm">|					12: Filter from 1300ns (0.769200MHz) |</span>
<span class="cm">|					13: Filter from 1400ns (0.714200MHz) |</span>
<span class="cm">|					14: Filter from 1500ns (0.666666MHz) |</span>
<span class="cm">|					15: Filter from 1600ns (0.625000MHz) |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: The selected module number is wrong                |</span>
<span class="cm">|                     -3: The module is not a counter module                 |</span>
<span class="cm">|					  -4: The selected PCI input clock is wrong              |</span>
<span class="cm">|					  -5: The selected filter value is wrong                 |</span>
<span class="cm">|					  -6: 40MHz quartz not on board                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_SetInputFilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_PCIInputClock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_Filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if incremental counter */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_INCREMENTAL_COUNTER</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/******************************/</span>
			<span class="cm">/* Test if firmware &gt;= Rev1.5 */</span>
	      <span class="cm">/******************************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x3135</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/**************************/</span>
				<span class="cm">/* Test the PCI bus clock */</span>
		 <span class="cm">/**************************/</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_30MHZ</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_33MHZ</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span> <span class="n">APCI1710_40MHZ</span><span class="p">))</span> <span class="p">{</span>
		    <span class="cm">/*************************/</span>
					<span class="cm">/* Test the filter value */</span>
		    <span class="cm">/*************************/</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">b_Filter</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		       <span class="cm">/**********************/</span>
						<span class="cm">/* Test if 40MHz used */</span>
		       <span class="cm">/**********************/</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
							<span class="n">APCI1710_40MHZ</span><span class="p">)</span> <span class="p">{</span>
			  <span class="cm">/*********************************/</span>
							<span class="cm">/* Test if 40MHz quartz on board */</span>
			  <span class="cm">/*********************************/</span>

							<span class="n">dw_Status</span> <span class="o">=</span>
								<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_BoardInfos</span><span class="p">.</span>
								<span class="n">ui_Address</span> <span class="o">+</span>
								<span class="mi">36</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			  <span class="cm">/******************************/</span>
							<span class="cm">/* Test the quartz flag (DQ0) */</span>
			  <span class="cm">/******************************/</span>

							<span class="k">if</span> <span class="p">((</span><span class="n">dw_Status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span>
								<span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			     <span class="cm">/*****************************/</span>
								<span class="cm">/* 40MHz quartz not on board */</span>
			     <span class="cm">/*****************************/</span>

								<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;40MHz quartz not on board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="n">i_ReturnValue</span> <span class="o">=</span>
									<span class="o">-</span><span class="mi">6</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>	<span class="cm">/*  if (b_PCIInputClock == APCI1710_40MHZ) */</span>

		       <span class="cm">/***************************/</span>
						<span class="cm">/* Test if error not occur */</span>
		       <span class="cm">/***************************/</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			  <span class="cm">/**********************/</span>
							<span class="cm">/* Test if 40MHz used */</span>
			  <span class="cm">/**********************/</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">b_PCIInputClock</span> <span class="o">==</span>
								<span class="n">APCI1710_40MHZ</span><span class="p">)</span>
							<span class="p">{</span>
			     <span class="cm">/*********************************/</span>
								<span class="cm">/* Enable the 40MHz quarz (DQ31) */</span>
			     <span class="cm">/*********************************/</span>

								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">|</span>
									<span class="n">APCI1710_ENABLE_40MHZ_FILTER</span><span class="p">;</span>

							<span class="p">}</span>	<span class="cm">/*  if (b_PCIInputClock == APCI1710_40MHZ) */</span>
							<span class="k">else</span> <span class="p">{</span>
			     <span class="cm">/**********************************/</span>
								<span class="cm">/* Disable the 40MHz quarz (DQ31) */</span>
			     <span class="cm">/**********************************/</span>

								<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">=</span>
									<span class="n">devpriv</span><span class="o">-&gt;</span>
									<span class="n">s_ModuleInfo</span>
									<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
									<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
									<span class="n">s_ModeRegister</span><span class="p">.</span>
									<span class="n">s_ByteModeRegister</span><span class="p">.</span>
									<span class="n">b_ModeRegister4</span>
									<span class="o">&amp;</span>
									<span class="n">APCI1710_DISABLE_40MHZ_FILTER</span><span class="p">;</span>

							<span class="p">}</span>	<span class="cm">/*  if (b_PCIInputClock == APCI1710_40MHZ) */</span>

			  <span class="cm">/************************/</span>
							<span class="cm">/* Set the filter value */</span>
			  <span class="cm">/************************/</span>

							<span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
								<span class="n">s_ModeRegister</span><span class="p">.</span>
								<span class="n">s_ByteModeRegister</span><span class="p">.</span>
								<span class="n">b_ModeRegister3</span>
								<span class="o">=</span>
								<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
								<span class="n">s_ModeRegister</span><span class="p">.</span>
								<span class="n">s_ByteModeRegister</span><span class="p">.</span>
								<span class="n">b_ModeRegister3</span>
								<span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span>
								<span class="p">((</span><span class="n">b_Filter</span> <span class="o">&amp;</span>
									<span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
								<span class="mi">5</span><span class="p">);</span>

							<span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
								<span class="n">s_ModeRegister</span><span class="p">.</span>
								<span class="n">s_ByteModeRegister</span><span class="p">.</span>
								<span class="n">b_ModeRegister4</span>
								<span class="o">=</span>
								<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
								<span class="n">s_ModeRegister</span><span class="p">.</span>
								<span class="n">s_ByteModeRegister</span><span class="p">.</span>
								<span class="n">b_ModeRegister4</span>
								<span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">|</span>
								<span class="p">((</span><span class="n">b_Filter</span> <span class="o">&amp;</span>
									<span class="mh">0x8</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
								<span class="mi">3</span><span class="p">);</span>

			  <span class="cm">/***************************/</span>
							<span class="cm">/* Write the configuration */</span>
			  <span class="cm">/***************************/</span>

							<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_ModuleInfo</span>
								<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
								<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
								<span class="n">s_ModeRegister</span><span class="p">.</span>
								<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span>
								<span class="n">s_BoardInfos</span><span class="p">.</span>
								<span class="n">ui_Address</span> <span class="o">+</span>
								<span class="mi">20</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
						<span class="p">}</span>	<span class="cm">/*  if (i_ReturnValue == 0) */</span>
					<span class="p">}</span>	<span class="cm">/*  if (b_Filter &lt; 16) */</span>
					<span class="k">else</span> <span class="p">{</span>
		       <span class="cm">/**************************************/</span>
						<span class="cm">/* The selected filter value is wrong */</span>
		       <span class="cm">/**************************************/</span>

						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected filter value is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
					<span class="p">}</span>	<span class="cm">/*  if (b_Filter &lt; 16) */</span>
				<span class="p">}</span>	<span class="cm">/*  if ((b_PCIInputClock == APCI1710_30MHZ) || (b_PCIInputClock == APCI1710_33MHZ) || (b_PCIInputClock == APCI1710_40MHZ)) */</span>
				<span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/*****************************************/</span>
					<span class="cm">/* The selected PCI input clock is wrong */</span>
		    <span class="cm">/*****************************************/</span>

					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected PCI input clock is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>	<span class="cm">/*  if ((b_PCIInputClock == APCI1710_30MHZ) || (b_PCIInputClock == APCI1710_33MHZ) || (b_PCIInputClock == APCI1710_40MHZ)) */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/**************************************/</span>
				<span class="cm">/* The module is not a counter module */</span>
		 <span class="cm">/**************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a counter module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/**************************************/</span>
			<span class="cm">/* The module is not a counter module */</span>
	      <span class="cm">/**************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a counter module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_LatchCounter (unsigned char_ b_BoardHandle,    |</span>
<span class="cm">|                                                    unsigned char_ b_ModulNbr,       |</span>
<span class="cm">|                                                    unsigned char_ b_LatchReg)       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Latch the courant value from selected module           |</span>
<span class="cm">|                     (b_ModulNbr) in to the selected latch register         |</span>
<span class="cm">|                     (b_LatchReg).                                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle : Handle of board APCI-1710        |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr    : Module number to configure       |</span>
<span class="cm">|                                           (0 to 3)                         |</span>
<span class="cm">|                     unsigned char_ b_LatchReg    : Selected latch register          |</span>
<span class="cm">|                               0 : for the first latch register             |</span>
<span class="cm">|                               1 : for the second latch register            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: The selected latch register parameter is wrong     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_LatchCounter</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_LatchReg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*************************************/</span>
			<span class="cm">/* Test the latch register parameter */</span>
	      <span class="cm">/*************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_LatchReg</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*********************/</span>
				<span class="cm">/* Tatch the counter */</span>
		 <span class="cm">/*********************/</span>

				<span class="n">outl</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">b_LatchReg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span>
					<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/**************************************************/</span>
				<span class="cm">/* The selected latch register parameter is wrong */</span>
		 <span class="cm">/**************************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected latch register parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_	i_APCI1710_SetIndexAndReferenceSource        |</span>
<span class="cm">|					(unsigned char_ b_BoardHandle,                |</span>
<span class="cm">|					 unsigned char_ b_ModulNbr,                   |</span>
<span class="cm">|					 unsigned char_ b_SourceSelection)            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Determine the hardware source for the index and the    |</span>
<span class="cm">|		      reference logic. Per default the index logic is        |</span>
<span class="cm">|		      connected to the difference input C and the reference  |</span>
<span class="cm">|		      logic is connected to the 24V input E                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">|		      unsigned char_ b_SourceSelection : APCI1710_SOURCE_0 :          |</span>
<span class="cm">|						The index logic is connected |</span>
<span class="cm">|						to the difference input C and|</span>
<span class="cm">|						the reference logic is       |</span>
<span class="cm">|						connected to the 24V input E.|</span>
<span class="cm">|						This is the default          |</span>
<span class="cm">|						configuration.               |</span>
<span class="cm">|						APCI1710_SOURCE_1 :          |</span>
<span class="cm">|						The reference logic is       |</span>
<span class="cm">|						connected to the difference  |</span>
<span class="cm">|						input C and the index logic  |</span>
<span class="cm">|						is connected to the 24V      |</span>
<span class="cm">|						input E                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|		      -2: The selected module number is wrong                |</span>
<span class="cm">|		      -3: The module is not a counter module.                |</span>
<span class="cm">|		      -4: The source selection is wrong                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_SetIndexAndReferenceSource</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_SourceSelection</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if incremental counter */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_INCREMENTAL_COUNTER</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/******************************/</span>
			<span class="cm">/* Test if firmware &gt;= Rev1.5 */</span>
	      <span class="cm">/******************************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x3135</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*****************************/</span>
				<span class="cm">/* Test the source selection */</span>
		 <span class="cm">/*****************************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">b_SourceSelection</span> <span class="o">==</span> <span class="n">APCI1710_SOURCE_0</span> <span class="o">||</span>
					<span class="n">b_SourceSelection</span> <span class="o">==</span> <span class="n">APCI1710_SOURCE_1</span><span class="p">)</span>
				<span class="p">{</span>
		    <span class="cm">/******************************************/</span>
					<span class="cm">/* Test if invert the index and reference */</span>
		    <span class="cm">/******************************************/</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">b_SourceSelection</span> <span class="o">==</span>
						<span class="n">APCI1710_SOURCE_1</span><span class="p">)</span> <span class="p">{</span>
		       <span class="cm">/********************************************/</span>
						<span class="cm">/* Invert index and reference source (DQ25) */</span>
		       <span class="cm">/********************************************/</span>

						<span class="n">devpriv</span><span class="o">-&gt;</span>
							<span class="n">s_ModuleInfo</span>
							<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
							<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
							<span class="n">s_ModeRegister</span><span class="p">.</span>
							<span class="n">s_ByteModeRegister</span><span class="p">.</span>
							<span class="n">b_ModeRegister4</span> <span class="o">=</span>
							<span class="n">devpriv</span><span class="o">-&gt;</span>
							<span class="n">s_ModuleInfo</span>
							<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
							<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
							<span class="n">s_ModeRegister</span><span class="p">.</span>
							<span class="n">s_ByteModeRegister</span><span class="p">.</span>
							<span class="n">b_ModeRegister4</span> <span class="o">|</span>
							<span class="n">APCI1710_INVERT_INDEX_RFERENCE</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		       <span class="cm">/****************************************/</span>
						<span class="cm">/* Set the default configuration (DQ25) */</span>
		       <span class="cm">/****************************************/</span>

						<span class="n">devpriv</span><span class="o">-&gt;</span>
							<span class="n">s_ModuleInfo</span>
							<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
							<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
							<span class="n">s_ModeRegister</span><span class="p">.</span>
							<span class="n">s_ByteModeRegister</span><span class="p">.</span>
							<span class="n">b_ModeRegister4</span> <span class="o">=</span>
							<span class="n">devpriv</span><span class="o">-&gt;</span>
							<span class="n">s_ModuleInfo</span>
							<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
							<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
							<span class="n">s_ModeRegister</span><span class="p">.</span>
							<span class="n">s_ByteModeRegister</span><span class="p">.</span>
							<span class="n">b_ModeRegister4</span> <span class="o">&amp;</span>
							<span class="n">APCI1710_DEFAULT_INDEX_RFERENCE</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>	<span class="cm">/*  if (b_SourceSelection == APCI1710_SOURCE_0 ||b_SourceSelection == APCI1710_SOURCE_1) */</span>
				<span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/*********************************/</span>
					<span class="cm">/* The source selection is wrong */</span>
		    <span class="cm">/*********************************/</span>

					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The source selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>	<span class="cm">/*  if (b_SourceSelection == APCI1710_SOURCE_0 ||b_SourceSelection == APCI1710_SOURCE_1) */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/**************************************/</span>
				<span class="cm">/* The module is not a counter module */</span>
		 <span class="cm">/**************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a counter module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/**************************************/</span>
			<span class="cm">/* The module is not a counter module */</span>
	      <span class="cm">/**************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a counter module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/***************************************/</span>
		<span class="cm">/* The selected module number is wrong */</span>
	   <span class="cm">/***************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_	i_APCI1710_SetDigitalChlOn                   |</span>
<span class="cm">|				   (unsigned char_  b_BoardHandle,                    |</span>
<span class="cm">|				    unsigned char_  b_ModulNbr)                       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Sets the digital output H Setting an output means      |</span>
<span class="cm">|		      setting an ouput high.                                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">|		      unsigned char_  b_ModulNbr	      :	Number of the module to be   |</span>
<span class="cm">|						configured (0 to 3)          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: The selected module number is wrong                |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|			  &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_SetDigitalChlOn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">s_ByteModeRegister</span><span class="p">.</span>
				<span class="n">b_ModeRegister3</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">s_ByteModeRegister</span><span class="p">.</span><span class="n">b_ModeRegister3</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">;</span>

	      <span class="cm">/*********************/</span>
			<span class="cm">/* Set the output On */</span>
	      <span class="cm">/*********************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_	i_APCI1710_SetDigitalChlOff                  |</span>
<span class="cm">|				   (unsigned char_  b_BoardHandle,                    |</span>
<span class="cm">|				    unsigned char_  b_ModulNbr)                       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Resets the digital output H. Resetting an output means |</span>
<span class="cm">|		      setting an ouput low.                                  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">|		      unsigned char_  b_ModulNbr	      :	Number of the module to be   |</span>
<span class="cm">|						configured (0 to 3)          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: The selected module number is wrong                |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|			  &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_SetDigitalChlOff</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">s_ByteModeRegister</span><span class="p">.</span>
				<span class="n">b_ModeRegister3</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">s_ByteModeRegister</span><span class="p">.</span><span class="n">b_ModeRegister3</span> <span class="o">&amp;</span> <span class="mh">0xEF</span><span class="p">;</span>

	      <span class="cm">/**********************/</span>
			<span class="cm">/* Set the output Off */</span>
	      <span class="cm">/**********************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*########################################################################### */</span>

							<span class="cm">/*  INSN WRITE */</span>
<span class="cm">/*########################################################################### */</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     :INT	i_APCI1710_InsnWriteINCCPT(struct comedi_device *dev,struct comedi_subdevice *s,</span>
<span class="cm">struct comedi_insn *insn,unsigned int *data)                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Enable Disable functions for INC_CPT                                       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">i_APCI1710_InsnWriteINCCPT</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_WriteType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ui_WriteType</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>	<span class="cm">/*  Save the current process task structure */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ui_WriteType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APCI1710_INCCPT_ENABLELATCHINTERRUPT</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_EnableLatchInterrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_DISABLELATCHINTERRUPT</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_DisableLatchInterrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_WRITE16BITCOUNTERVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_Write16BitCounterValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_WRITE32BITCOUNTERVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_Write32BitCounterValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_ENABLEINDEX</span>:
		<span class="n">i_APCI1710_EnableIndex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_DISABLEINDEX</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_DisableIndex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_ENABLECOMPARELOGIC</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_EnableCompareLogic</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_DISABLECOMPARELOGIC</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_DisableCompareLogic</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_ENABLEFREQUENCYMEASUREMENT</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_EnableFrequencyMeasurement</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_DISABLEFREQUENCYMEASUREMENT</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_DisableFrequencyMeasurement</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Write Config Parameter Wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_EnableLatchInterrupt                  |</span>
<span class="cm">|                               (unsigned char_ b_BoardHandle,                        |</span>
<span class="cm">|                                unsigned char_ b_ModulNbr)                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Enable the latch interrupt from selected module        |</span>
<span class="cm">|                     (b_ModulNbr). Each software or hardware latch occur a  |</span>
<span class="cm">|                     interrupt.                                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle : Handle of board APCI-1710        |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr    : Module number to configure       |</span>
<span class="cm">|                                           (0 to 3)                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Interrupt routine not installed see function       |</span>
<span class="cm">|                         &quot;i_APCI1710_SetBoardIntRoutine&quot;                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_EnableLatchInterrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		 <span class="cm">/********************/</span>
			<span class="cm">/* Enable interrupt */</span>
		 <span class="cm">/********************/</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">s_ByteModeRegister</span><span class="p">.</span>
				<span class="n">b_ModeRegister2</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">s_ByteModeRegister</span><span class="p">.</span>
				<span class="n">b_ModeRegister2</span> <span class="o">|</span> <span class="n">APCI1710_ENABLE_LATCH_INT</span><span class="p">;</span>

		 <span class="cm">/***************************/</span>
			<span class="cm">/* Write the configuration */</span>
		 <span class="cm">/***************************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_DisableLatchInterrupt                 |</span>
<span class="cm">|                               (unsigned char_ b_BoardHandle,                        |</span>
<span class="cm">|                                unsigned char_ b_ModulNbr)                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Disable the latch interrupt from selected module       |</span>
<span class="cm">|                     (b_ModulNbr).                                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle : Handle of board APCI-1710        |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr    : Module number to configure       |</span>
<span class="cm">|                                           (0 to 3)                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Interrupt routine not installed see function       |</span>
<span class="cm">|                         &quot;i_APCI1710_SetBoardIntRoutine&quot;                    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_DisableLatchInterrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		 <span class="cm">/***************************/</span>
			<span class="cm">/* Write the configuration */</span>
		 <span class="cm">/***************************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">dw_ModeRegister1_2_3_4</span> <span class="o">&amp;</span>
				<span class="p">((</span><span class="n">APCI1710_DISABLE_LATCH_INT</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xFF</span><span class="p">),</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
				<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		 <span class="cm">/*********************/</span>
			<span class="cm">/* Disable interrupt */</span>
		 <span class="cm">/*********************/</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">s_ByteModeRegister</span><span class="p">.</span>
				<span class="n">b_ModeRegister2</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_ModeRegister</span><span class="p">.</span>
				<span class="n">s_ByteModeRegister</span><span class="p">.</span>
				<span class="n">b_ModeRegister2</span> <span class="o">&amp;</span> <span class="n">APCI1710_DISABLE_LATCH_INT</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_Write16BitCounterValue                |</span>
<span class="cm">|                                               (unsigned char_  b_BoardHandle        |</span>
<span class="cm">|                                                unsigned char_  b_ModulNbr,          |</span>
<span class="cm">|                                                unsigned char_  b_SelectedCounter,   |</span>
<span class="cm">|                                                unsigned int_ ui_WriteValue)        |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Write a 16-Bit value (ui_WriteValue) in to the selected|</span>
<span class="cm">|                     16-Bit counter (b_SelectedCounter) from selected module|</span>
<span class="cm">|                     (b_ModulNbr).                                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                              (0 to 3)                      |</span>
<span class="cm">|                     unsigned char_ b_SelectedCounter : Selected 16-Bit counter      |</span>
<span class="cm">|                                               (0 or 1)                     |</span>
<span class="cm">|                     unsigned int_ ui_WriteValue     : 16-Bit write value           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: The selected 16-Bit counter parameter is wrong     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_Write16BitCounterValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_SelectedCounter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_WriteValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/******************************/</span>
			<span class="cm">/* Test the counter selection */</span>
	      <span class="cm">/******************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_SelectedCounter</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*******************/</span>
				<span class="cm">/* Write the value */</span>
		 <span class="cm">/*******************/</span>

				<span class="n">outl</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">ui_WriteValue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span>
							<span class="n">b_SelectedCounter</span><span class="p">)),</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">b_SelectedCounter</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/**************************************************/</span>
				<span class="cm">/* The selected 16-Bit counter parameter is wrong */</span>
		 <span class="cm">/**************************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected 16-Bit counter parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_Write32BitCounterValue                |</span>
<span class="cm">|                                               (unsigned char_   b_BoardHandle       |</span>
<span class="cm">|                                                unsigned char_   b_ModulNbr,         |</span>
<span class="cm">|                                                ULONG_ ul_WriteValue)       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Write a 32-Bit value (ui_WriteValue) in to the selected|</span>
<span class="cm">|                     module (b_ModulNbr).                                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                              (0 to 3)                      |</span>
<span class="cm">|                     ULONG_ ul_WriteValue    : 32-Bit write value           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_Write32BitCounterValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_WriteValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*******************/</span>
			<span class="cm">/* Write the value */</span>
	      <span class="cm">/*******************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="n">ul_WriteValue</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_EnableIndex (unsigned char_  b_BoardHandle,    |</span>
<span class="cm">|                                                   unsigned char_  b_ModulNbr)       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Enable the INDEX actions                               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Index not initialised see function                 |</span>
<span class="cm">|                         &quot;i_APCI1710_InitIndex&quot;                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_EnableIndex</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_InterruptLatchReg</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*****************************/</span>
			<span class="cm">/* Test if index initialised */</span>
	      <span class="cm">/*****************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_IndexInit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister2</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister2</span> <span class="o">|</span> <span class="n">APCI1710_ENABLE_INDEX</span><span class="p">;</span>

				<span class="n">ul_InterruptLatchReg</span> <span class="o">=</span>
					<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span>
					<span class="mi">24</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

				<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
					<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*************************************************************/</span>
				<span class="cm">/* Index not initialised see function &quot;i_APCI1710_InitIndex&quot; */</span>
		 <span class="cm">/*************************************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Index not initialised </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_DisableIndex (unsigned char_  b_BoardHandle,   |</span>
<span class="cm">|                                                    unsigned char_  b_ModulNbr)      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Disable the INDEX actions                              |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Index not initialised see function                 |</span>
<span class="cm">|                         &quot;i_APCI1710_InitIndex&quot;                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_DisableIndex</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*****************************/</span>
			<span class="cm">/* Test if index initialised */</span>
	      <span class="cm">/*****************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_IndexInit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister2</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister2</span> <span class="o">&amp;</span>
					<span class="n">APCI1710_DISABLE_INDEX</span><span class="p">;</span>

				<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
					<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*************************************************************/</span>
				<span class="cm">/* Index not initialised see function &quot;i_APCI1710_InitIndex&quot; */</span>
		 <span class="cm">/*************************************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Index not initialised  </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_EnableCompareLogic                    |</span>
<span class="cm">|                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">|                                unsigned char_   b_ModulNbr)                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Enable the 32-Bit compare logic. At that moment that   |</span>
<span class="cm">|                     the incremental counter arrive to the compare value a  |</span>
<span class="cm">|                     interrupt is generated.                                |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_  b_ModulNbr       : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Compare logic not initialised.                     |</span>
<span class="cm">|                         See function &quot;i_APCI1710_InitCompareLogic&quot;         |</span>
<span class="cm">|                     -5: Interrupt function not initialised.                |</span>
<span class="cm">|                         See function &quot;i_APCI1710_SetBoardIntRoutineX&quot;      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_EnableCompareLogic</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*************************************/</span>
			<span class="cm">/* Test if compare logic initialised */</span>
	      <span class="cm">/*************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CompareLogicInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister3</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister3</span> <span class="o">|</span>
					<span class="n">APCI1710_ENABLE_COMPARE_INT</span><span class="p">;</span>

		    <span class="cm">/***************************/</span>
				<span class="cm">/* Write the configuration */</span>
		    <span class="cm">/***************************/</span>

				<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
					<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*********************************/</span>
				<span class="cm">/* Compare logic not initialised */</span>
		 <span class="cm">/*********************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Compare logic not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_DisableCompareLogic                   |</span>
<span class="cm">|                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">|                                unsigned char_   b_ModulNbr)                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Disable the 32-Bit compare logic.</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_  b_ModulNbr       : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Compare logic not initialised.                     |</span>
<span class="cm">|                         See function &quot;i_APCI1710_InitCompareLogic&quot;         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_DisableCompareLogic</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*************************************/</span>
			<span class="cm">/* Test if compare logic initialised */</span>
	      <span class="cm">/*************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CompareLogicInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister3</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister3</span> <span class="o">&amp;</span>
					<span class="n">APCI1710_DISABLE_COMPARE_INT</span><span class="p">;</span>

		 <span class="cm">/***************************/</span>
				<span class="cm">/* Write the configuration */</span>
		 <span class="cm">/***************************/</span>

				<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
					<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*********************************/</span>
				<span class="cm">/* Compare logic not initialised */</span>
		 <span class="cm">/*********************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Compare logic not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Function Name     : _INT_ i_APCI1710_EnableFrequencyMeasurement            |</span>
<span class="cm">	   |                            (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">	   |                             unsigned char_   b_ModulNbr,                         |</span>
<span class="cm">	   |                             unsigned char_   b_InterruptEnable)                  |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Task              : Enables the frequency measurement function             |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">	   |                  unsigned char_  b_ModulNbr       : Number of the module to be   |</span>
<span class="cm">	   |                                            configured (0 to 3)          |</span>
<span class="cm">	   |                  unsigned char_  b_InterruptEnable: Enable or disable the        |</span>
<span class="cm">	   |                                            interrupt.                   |</span>
<span class="cm">	   |                                            APCI1710_ENABLE:             |</span>
<span class="cm">	   |                                            Enable the interrupt         |</span>
<span class="cm">	   |                                            APCI1710_DISABLE:            |</span>
<span class="cm">	   |                                            Disable the interrupt        |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Output Parameters : -                                                      |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Return Value      :  0: No error                                           |</span>
<span class="cm">	   |                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">	   |                     -2: The selected module number is wrong                |</span>
<span class="cm">	   |                     -3: Counter not initialised see function               |</span>
<span class="cm">	   |                      &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">	   |                     -4: Frequency measurement logic not initialised.       |</span>
<span class="cm">	   |                      See function &quot;i_APCI1710_InitFrequencyMeasurement&quot; |</span>
<span class="cm">	   |                     -5: Interrupt parameter is wrong                       |</span>
<span class="cm">	   |                     -6: Interrupt function not initialised.                |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	 */</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_EnableFrequencyMeasurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_InterruptEnable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/********************************************/</span>
			<span class="cm">/* Test if frequency measurement initialised */</span>
	      <span class="cm">/********************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_FrequencyMeasurementInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/***************************/</span>
				<span class="cm">/* Test the interrupt mode */</span>
		 <span class="cm">/***************************/</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">b_InterruptEnable</span> <span class="o">==</span> <span class="n">APCI1710_DISABLE</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">b_InterruptEnable</span> <span class="o">==</span> <span class="n">APCI1710_ENABLE</span><span class="p">))</span>
				<span class="p">{</span>

		       <span class="cm">/************************************/</span>
					<span class="cm">/* Enable the frequency measurement */</span>
		       <span class="cm">/************************************/</span>

					<span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister3</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister3</span> <span class="o">|</span>
						<span class="n">APCI1710_ENABLE_FREQUENCY</span><span class="p">;</span>

		       <span class="cm">/*********************************************/</span>
					<span class="cm">/* Disable or enable the frequency interrupt */</span>
		       <span class="cm">/*********************************************/</span>

					<span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister3</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">s_ByteModeRegister</span><span class="p">.</span>
						<span class="n">b_ModeRegister3</span> <span class="o">&amp;</span>
						<span class="n">APCI1710_DISABLE_FREQUENCY_INT</span><span class="p">)</span>
						<span class="o">|</span> <span class="p">(</span><span class="n">b_InterruptEnable</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

		       <span class="cm">/***************************/</span>
					<span class="cm">/* Write the configuration */</span>
		       <span class="cm">/***************************/</span>

					<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_ModeRegister</span><span class="p">.</span>
						<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
						<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
						<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

					<span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
						<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
						<span class="n">s_InitFlag</span><span class="p">.</span>
						<span class="n">b_FrequencyMeasurementEnable</span> <span class="o">=</span>
						<span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/********************************/</span>
					<span class="cm">/* Interrupt parameter is wrong */</span>
		    <span class="cm">/********************************/</span>

					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Interrupt parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/***********************************************/</span>
				<span class="cm">/* Frequency measurement logic not initialised */</span>
		 <span class="cm">/***********************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Frequency measurement logic not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Function Name     : _INT_ i_APCI1710_DisableFrequencyMeasurement           |</span>
<span class="cm">	   |                            (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">	   |                             unsigned char_   b_ModulNbr)                         |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Task              : Disables the frequency measurement function             |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">	   |                  unsigned char_  b_ModulNbr       : Number of the module to be   |</span>
<span class="cm">	   |                                            configured (0 to 3)          |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Output Parameters : -                                                      |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Return Value      :  0: No error                                           |</span>
<span class="cm">	   |                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">	   |                     -2: The selected module number is wrong                |</span>
<span class="cm">	   |                     -3: Counter not initialised see function               |</span>
<span class="cm">	   |                      &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">	   |                     -4: Frequency measurement logic not initialised.       |</span>
<span class="cm">	   |                      See function &quot;i_APCI1710_InitFrequencyMeasurement&quot; |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	 */</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_DisableFrequencyMeasurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/********************************************/</span>
			<span class="cm">/* Test if frequency measurement initialised */</span>
	      <span class="cm">/********************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_FrequencyMeasurementInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*************************************/</span>
				<span class="cm">/* Disable the frequency measurement */</span>
		 <span class="cm">/*************************************/</span>

				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister3</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister3</span> <span class="o">&amp;</span>
					<span class="n">APCI1710_DISABLE_FREQUENCY</span>
					<span class="cm">/*  Begin CG 29/06/01 CG 1100/0231 -&gt; 0701/0232 Frequence measure IRQ must be cleared */</span>
					<span class="o">&amp;</span> <span class="n">APCI1710_DISABLE_FREQUENCY_INT</span><span class="p">;</span>
				<span class="cm">/*  End CG 29/06/01 CG 1100/0231 -&gt; 0701/0232 Frequence measure IRQ must be cleared */</span>

		 <span class="cm">/***************************/</span>
				<span class="cm">/* Write the configuration */</span>
		 <span class="cm">/***************************/</span>

				<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">dw_ModeRegister1_2_3_4</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span>
					<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

		 <span class="cm">/*************************************/</span>
				<span class="cm">/* Disable the frequency measurement */</span>
		 <span class="cm">/*************************************/</span>

				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_InitFlag</span><span class="p">.</span>
					<span class="n">b_FrequencyMeasurementEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/***********************************************/</span>
				<span class="cm">/* Frequency measurement logic not initialised */</span>
		 <span class="cm">/***********************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Frequency measurement logic not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*########################################################################### */</span>

							<span class="cm">/*  INSN READ */</span>

<span class="cm">/*########################################################################### */</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     :INT	i_APCI1710_InsnWriteINCCPT(struct comedi_device *dev,struct comedi_subdevice *s,</span>
<span class="cm">struct comedi_insn *insn,unsigned int *data)                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Read and Get functions for INC_CPT                                       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">i_APCI1710_InsnReadINCCPT</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_ReadType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ui_ReadType</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>	<span class="cm">/*  Save the current process task structure */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ui_ReadType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APCI1710_INCCPT_READLATCHREGISTERSTATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_ReadLatchRegisterStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_READLATCHREGISTERVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_ReadLatchRegisterValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Latch Register Value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_READ16BITCOUNTERVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_Read16BitCounterValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_READ32BITCOUNTERVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_Read32BitCounterValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_GETINDEXSTATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_GetIndexStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_GETREFERENCESTATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_GetReferenceStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_GETUASSTATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_GetUASStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_GETCBSTATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_GetCBStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_GET16BITCBSTATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_Get16BitCBStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_GETUDSTATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_GetUDStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_GETINTERRUPTUDLATCHEDSTATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_GetInterruptUDLatchedStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_READFREQUENCYMEASUREMENT</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_ReadFrequencyMeasurement</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_INCCPT_READINTERRUPT</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">s_FIFOInterruptParameters</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span><span class="p">].</span><span class="n">b_OldModuleMask</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">s_FIFOInterruptParameters</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span><span class="p">].</span><span class="n">ul_OldInterruptMask</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">s_FIFOInterruptParameters</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span><span class="p">].</span><span class="n">ul_OldCounterLatchValue</span><span class="p">;</span>

		<span class="cm">/**************************/</span>
		<span class="cm">/* Increment the read FIFO */</span>
		<span class="cm">/***************************/</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">ui_Read</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span>
			<span class="n">ui_Read</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">APCI1710_SAVE_INTERRUPT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ReadType Parameter wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_ReadLatchRegisterStatus               |</span>
<span class="cm">|                                                   (unsigned char_   b_BoardHandle,  |</span>
<span class="cm">|                                                    unsigned char_   b_ModulNbr,     |</span>
<span class="cm">|                                                    unsigned char_   b_LatchReg,     |</span>
<span class="cm">|                                                    unsigned char *_ pb_LatchStatus)  |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Read the latch register status from selected module    |</span>
<span class="cm">|                     (b_ModulNbr) and selected latch register (b_LatchReg). |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle : Handle of board APCI-1710        |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr    : Module number to configure       |</span>
<span class="cm">|                                           (0 to 3)                         |</span>
<span class="cm">|                     unsigned char_ b_LatchReg    : Selected latch register          |</span>
<span class="cm">|                               0 : for the first latch register             |</span>
<span class="cm">|                               1 : for the second latch register            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_LatchStatus :   Latch register status.       |</span>
<span class="cm">|                                               0 : No latch occur           |</span>
<span class="cm">|                                               1 : A software latch occur   |</span>
<span class="cm">|                                               2 : A hardware latch occur   |</span>
<span class="cm">|                                               3 : A software and hardware  |</span>
<span class="cm">|                                                   latch occur              |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: The selected latch register parameter is wrong     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_ReadLatchRegisterStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_LatchReg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_LatchStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_LatchReg</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*************************************/</span>
			<span class="cm">/* Test the latch register parameter */</span>
	      <span class="cm">/*************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_LatchReg</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dw_LatchReg</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

				<span class="o">*</span><span class="n">pb_LatchStatus</span> <span class="o">=</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_LatchReg</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">b_LatchReg</span> <span class="o">*</span>
							<span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/**************************************************/</span>
				<span class="cm">/* The selected latch register parameter is wrong */</span>
		 <span class="cm">/**************************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected latch register parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_ReadLatchRegisterValue                |</span>
<span class="cm">|                                                   (unsigned char_     b_BoardHandle,|</span>
<span class="cm">|                                                    unsigned char_     b_ModulNbr,   |</span>
<span class="cm">|                                                    unsigned char_     b_LatchReg,   |</span>
<span class="cm">|                                                    PULONG_ pul_LatchValue) |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Read the latch register value from selected module     |</span>
<span class="cm">|                     (b_ModulNbr) and selected latch register (b_LatchReg). |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle : Handle of board APCI-1710        |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr    : Module number to configure       |</span>
<span class="cm">|                                           (0 to 3)                         |</span>
<span class="cm">|                     unsigned char_ b_LatchReg    : Selected latch register          |</span>
<span class="cm">|                               0 : for the first latch register             |</span>
<span class="cm">|                               1 : for the second latch register            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : PULONG_ pul_LatchValue : Latch register value          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: The selected latch register parameter is wrong     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_ReadLatchRegisterValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_LatchReg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pul_LatchValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*************************************/</span>
			<span class="cm">/* Test the latch register parameter */</span>
	      <span class="cm">/*************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_LatchReg</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">pul_LatchValue</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="p">((</span><span class="n">b_LatchReg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/**************************************************/</span>
				<span class="cm">/* The selected latch register parameter is wrong */</span>
		 <span class="cm">/**************************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected latch register parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_Read16BitCounterValue                 |</span>
<span class="cm">|                                       (unsigned char_     b_BoardHandle,            |</span>
<span class="cm">|                                        unsigned char_     b_ModulNbr,               |</span>
<span class="cm">|                                        unsigned char_     b_SelectedCounter,        |</span>
<span class="cm">|                                        unsigned int *_   pui_CounterValue)          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Latch the selected 16-Bit counter (b_SelectedCounter)  |</span>
<span class="cm">|                     from selected module (b_ModulNbr) in to the first      |</span>
<span class="cm">|                     latch register and return the latched value.           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                              (0 to 3)                      |</span>
<span class="cm">|                     unsigned char_ b_SelectedCounter : Selected 16-Bit counter      |</span>
<span class="cm">|                                               (0 or 1)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned int *_ pui_CounterValue : 16-Bit counter value         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: The selected 16-Bit counter parameter is wrong     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_Read16BitCounterValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_SelectedCounter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pui_CounterValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_LathchValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/******************************/</span>
			<span class="cm">/* Test the counter selection */</span>
	      <span class="cm">/******************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_SelectedCounter</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*********************/</span>
				<span class="cm">/* Latch the counter */</span>
		 <span class="cm">/*********************/</span>

				<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

		 <span class="cm">/************************/</span>
				<span class="cm">/* Read the latch value */</span>
		 <span class="cm">/************************/</span>

				<span class="n">dw_LathchValue</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

				<span class="o">*</span><span class="n">pui_CounterValue</span> <span class="o">=</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_LathchValue</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span>
							<span class="n">b_SelectedCounter</span><span class="p">))</span> <span class="o">&amp;</span>
					<span class="mh">0xFFFFU</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/**************************************************/</span>
				<span class="cm">/* The selected 16-Bit counter parameter is wrong */</span>
		 <span class="cm">/**************************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected 16-Bit counter parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_Read32BitCounterValue                 |</span>
<span class="cm">|                                       (unsigned char_     b_BoardHandle,            |</span>
<span class="cm">|                                        unsigned char_     b_ModulNbr,               |</span>
<span class="cm">|                                        PULONG_ pul_CounterValue)           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Latch the 32-Bit counter from selected module          |</span>
<span class="cm">|                     (b_ModulNbr) in to the first latch register and return |</span>
<span class="cm">|                     the latched value.                                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                              (0 to 3)                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : PULONG_  pul_CounterValue : 32-Bit counter value       |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_Read32BitCounterValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pul_CounterValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*********************/</span>
			<span class="cm">/* Tatch the counter */</span>
	      <span class="cm">/*********************/</span>

			<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

	      <span class="cm">/************************/</span>
			<span class="cm">/* Read the latch value */</span>
	      <span class="cm">/************************/</span>

			<span class="o">*</span><span class="n">pul_CounterValue</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_GetIndexStatus (unsigned char_   b_BoardHandle,|</span>
<span class="cm">|                                                      unsigned char_   b_ModulNbr,   |</span>
<span class="cm">|                                                      unsigned char *_ pb_IndexStatus)|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the index status                                |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_IndexStatus   : 0 : No INDEX occur           |</span>
<span class="cm">|                                               1 : A INDEX occur            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Index not initialised see function                 |</span>
<span class="cm">|                         &quot;i_APCI1710_InitIndex&quot;                             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_GetIndexStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_IndexStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*****************************/</span>
			<span class="cm">/* Test if index initialised */</span>
	      <span class="cm">/*****************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_IndexInit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

				<span class="o">*</span><span class="n">pb_IndexStatus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">dw_StatusReg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*************************************************************/</span>
				<span class="cm">/* Index not initialised see function &quot;i_APCI1710_InitIndex&quot; */</span>
		 <span class="cm">/*************************************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Index not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_GetReferenceStatus                    |</span>
<span class="cm">|                                                (unsigned char_   b_BoardHandle,     |</span>
<span class="cm">|                                                 unsigned char_   b_ModulNbr,        |</span>
<span class="cm">|                                                 unsigned char *_ pb_ReferenceStatus) |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the reference status                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_ReferenceStatus   : 0 : No REFERENCE occur   |</span>
<span class="cm">|                                                   1 : A REFERENCE occur    |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Reference not initialised see function             |</span>
<span class="cm">|                         &quot;i_APCI1710_InitReference&quot;                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_GetReferenceStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_ReferenceStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*********************************/</span>
			<span class="cm">/* Test if reference initialised */</span>
	      <span class="cm">/*********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_ReferenceInit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

				<span class="o">*</span><span class="n">pb_ReferenceStatus</span> <span class="o">=</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="o">~</span><span class="n">dw_StatusReg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/*********************************************************************/</span>
				<span class="cm">/* Reference not initialised see function &quot;i_APCI1710_InitReference&quot; */</span>
		 <span class="cm">/*********************************************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Reference not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_GetUASStatus                          |</span>
<span class="cm">|                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">|                                unsigned char_   b_ModulNbr,                         |</span>
<span class="cm">|                                unsigned char *_ pb_UASStatus)                        |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the error signal (UAS) status                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_UASStatus      : 0 : UAS is low &quot;0&quot;          |</span>
<span class="cm">|                                                1 : UAS is high &quot;1&quot;         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_GetUASStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_UASStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			<span class="o">*</span><span class="n">pb_UASStatus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_StatusReg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_GetCBStatus                           |</span>
<span class="cm">|                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">|                                unsigned char_   b_ModulNbr,                         |</span>
<span class="cm">|                                unsigned char *_ pb_CBStatus)                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the counter overflow status                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_CBStatus      : 0 : Counter no overflow      |</span>
<span class="cm">|                                               1 : Counter overflow         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_GetCBStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_CBStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			<span class="o">*</span><span class="n">pb_CBStatus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">dw_StatusReg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_Get16BitCBStatus                      |</span>
<span class="cm">|					(unsigned char_     b_BoardHandle,            |</span>
<span class="cm">|					 unsigned char_     b_ModulNbr,               |</span>
<span class="cm">|					 unsigned char *_ pb_CBStatusCounter0,         |</span>
<span class="cm">|					 unsigned char *_ pb_CBStatusCounter1)         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Returns the counter overflow (counter initialised to   |</span>
<span class="cm">|		      2*16-bit) status from selected incremental counter     |</span>
<span class="cm">|		      module                                                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_CBStatusCounter0 : 0 : No overflow occur for |</span>
<span class="cm">|						       the first 16-bit      |</span>
<span class="cm">|						       counter               |</span>
<span class="cm">|						   1 : Overflow occur for the|</span>
<span class="cm">|						       first 16-bit counter  |</span>
<span class="cm">|		      unsigned char *_ pb_CBStatusCounter1 : 0 : No overflow occur for |</span>
<span class="cm">|						       the second 16-bit     |</span>
<span class="cm">|						       counter               |</span>
<span class="cm">|						   1 : Overflow occur for the|</span>
<span class="cm">|						       second 16-bit counter |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Counter not initialised to 2*16-bit mode.          |</span>
<span class="cm">|			  See function &quot;i_APCI1710_InitCounter&quot;              |</span>
<span class="cm">|                     -5: Firmware revision error                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_Get16BitCBStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_CBStatusCounter0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_CBStatusCounter1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/*************************/</span>
			<span class="cm">/* Test if 2*16-Bit mode */</span>
	      <span class="cm">/*************************/</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_ModeRegister</span><span class="p">.</span>
					<span class="n">s_ByteModeRegister</span><span class="p">.</span>
					<span class="n">b_ModeRegister1</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*****************************/</span>
				<span class="cm">/* Test the Firmware version */</span>
		 <span class="cm">/*****************************/</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
						<span class="n">dw_MolduleConfiguration</span>
						<span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;=</span>
					<span class="mh">0x3136</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dw_StatusReg</span> <span class="o">=</span>
						<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
						<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span>
						<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

					<span class="o">*</span><span class="n">pb_CBStatusCounter1</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_StatusReg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="mi">1</span><span class="p">);</span>
					<span class="o">*</span><span class="n">pb_CBStatusCounter0</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_StatusReg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>	<span class="cm">/*  if ((ps_APCI1710Variable-&gt;s_Board [b_BoardHandle].s_BoardInfos.dw_MolduleConfiguration [b_ModulNbr] &amp; 0xFFFF) &gt;= 0x3136) */</span>
				<span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/****************************/</span>
					<span class="cm">/* Firmware revision error  */</span>
		    <span class="cm">/****************************/</span>

					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>	<span class="cm">/*  if ((ps_APCI1710Variable-&gt;s_Board [b_BoardHandle].s_BoardInfos.dw_MolduleConfiguration [b_ModulNbr] &amp; 0xFFFF) &gt;= 0x3136) */</span>
			<span class="p">}</span>	<span class="cm">/*  if ((ps_APCI1710Variable-&gt;s_Board [b_BoardHandle].s_ModuleInfo [b_ModulNbr].s_SiemensCounterInfo.s_ModeRegister.s_ByteModeRegister.b_ModeRegister1 &amp; 0x10) == 0x10) */</span>
			<span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/********************************************/</span>
				<span class="cm">/* Counter not initialised to 2*16-bit mode */</span>
				<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;                 */</span>
		 <span class="cm">/********************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/*  if ((ps_APCI1710Variable-&gt;s_Board [b_BoardHandle].s_ModuleInfo [b_ModulNbr].s_SiemensCounterInfo.s_ModeRegister.s_ByteModeRegister.b_ModeRegister1 &amp; 0x10) == 0x10) */</span>
		<span class="p">}</span>		<span class="cm">/*  if (ps_APCI1710Variable-&gt;s_Board [b_BoardHandle].s_ModuleInfo [b_ModulNbr].s_SiemensCounterInfo.s_InitFlag.b_CounterInit == 1) */</span>
		<span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>		<span class="cm">/*  if (ps_APCI1710Variable-&gt;s_Board [b_BoardHandle].s_ModuleInfo [b_ModulNbr].s_SiemensCounterInfo.s_InitFlag.b_CounterInit == 1) */</span>
	<span class="p">}</span>			<span class="cm">/*  if (b_ModulNbr &lt; 4) */</span>
	<span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/*  if (b_ModulNbr &lt; 4) */</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_GetUDStatus                           |</span>
<span class="cm">|                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">|                                unsigned char_   b_ModulNbr,                         |</span>
<span class="cm">|                                unsigned char *_ pb_UDStatus)                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the counter progress status                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_UDStatus      : 0 : Counter progress in the  |</span>
<span class="cm">|                                                   selected mode down       |</span>
<span class="cm">|                                               1 : Counter progress in the  |</span>
<span class="cm">|                                                   selected mode up         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_GetUDStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_UDStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
				<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

			<span class="o">*</span><span class="n">pb_UDStatus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_StatusReg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_ i_APCI1710_GetInterruptUDLatchedStatus           |</span>
<span class="cm">|                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">|                                unsigned char_   b_ModulNbr,                         |</span>
<span class="cm">|                                unsigned char *_ pb_UDStatus)                         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the counter progress latched status after a     |</span>
<span class="cm">|                     index interrupt occur.                                 |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_ b_BoardHandle     : Handle of board APCI-1710    |</span>
<span class="cm">|                     unsigned char_ b_ModulNbr        : Module number to configure   |</span>
<span class="cm">|                                               (0 to 3)                     |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_UDStatus      : 0 : Counter progress in the  |</span>
<span class="cm">|                                                   selected mode down       |</span>
<span class="cm">|                                               1 : Counter progress in the  |</span>
<span class="cm">|                                                   selected mode up         |</span>
<span class="cm">|                                               2 : No index interrupt occur |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :  0: No error                                           |</span>
<span class="cm">|                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">|                     -2: No counter module found                            |</span>
<span class="cm">|                     -3: Counter not initialised see function               |</span>
<span class="cm">|                         &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">|                     -4: Interrupt function not initialised.                |</span>
<span class="cm">|                         See function &quot;i_APCI1710_SetBoardIntRoutineX&quot;      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_GetInterruptUDLatchedStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_UDStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/*********************************/</span>
			<span class="cm">/* Test if index interrupt occur */</span>
		 <span class="cm">/*********************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_IndexInterruptOccur</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_IndexInterruptOccur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">dw_StatusReg</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

				<span class="o">*</span><span class="n">pb_UDStatus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_StatusReg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/****************************/</span>
				<span class="cm">/* No index interrupt occur */</span>
		    <span class="cm">/****************************/</span>

				<span class="o">*</span><span class="n">pb_UDStatus</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Function Name     : _INT_ i_APCI1710_ReadFrequencyMeasurement              |</span>
<span class="cm">	   |                            (unsigned char_            b_BoardHandle,             |</span>
<span class="cm">	   |                             unsigned char_            b_ModulNbr,                |</span>
<span class="cm">	   |                             unsigned char *_          pb_Status,                  |</span>
<span class="cm">	   |                             PULONG_        pul_ReadValue)               |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Task              : Returns the status (pb_Status) and the number of       |</span>
<span class="cm">	   |                  increments in the set time.                            |</span>
<span class="cm">	   |                  See function &quot; i_APCI1710_InitFrequencyMeasurement &quot;   |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Input Parameters  : unsigned char_  b_BoardHandle    : Handle of board APCI-1710    |</span>
<span class="cm">	   |                  unsigned char_  b_ModulNbr       : Number of the module to be   |</span>
<span class="cm">	   |                                            configured (0 to 3)          |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Output Parameters : unsigned char *_ pb_Status     : Returns the frequency        |</span>
<span class="cm">	   |                                            measurement status           |</span>
<span class="cm">	   |                                            0 : Counting cycle not       |</span>
<span class="cm">	   |                                                started.                 |</span>
<span class="cm">	   |                                            1 : Counting cycle started.  |</span>
<span class="cm">	   |                                            2 : Counting cycle stopped.  |</span>
<span class="cm">	   |                                                The measurement cycle is |</span>
<span class="cm">	   |                                                completed.               |</span>
<span class="cm">	   |                  unsigned char *_ pb_UDStatus      : 0 : Counter progress in the  |</span>
<span class="cm">	   |                                                   selected mode down       |</span>
<span class="cm">	   |                                               1 : Counter progress in the  |</span>
<span class="cm">	   |                                                   selected mode up         |</span>
<span class="cm">	   |                  PULONG_ pul_ReadValue   : Return the number of         |</span>
<span class="cm">	   |                                            increments in the defined    |</span>
<span class="cm">	   |                                            time base.                   |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Return Value      :  0: No error                                           |</span>
<span class="cm">	   |                     -1: The handle parameter of the board is wrong         |</span>
<span class="cm">	   |                     -2: The selected module number is wrong                |</span>
<span class="cm">	   |                     -3: Counter not initialised see function               |</span>
<span class="cm">	   |                      &quot;i_APCI1710_InitCounter&quot;                           |</span>
<span class="cm">	   |                     -4: Frequency measurement logic not initialised.       |</span>
<span class="cm">	   |                      See function &quot;i_APCI1710_InitFrequencyMeasurement&quot; |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	 */</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_ReadFrequencyMeasurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_Status</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_UDStatus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pul_ReadValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui_16BitValue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_StatusReg</span><span class="p">;</span>

	<span class="cm">/**************************/</span>
	<span class="cm">/* Test the module number */</span>
	<span class="cm">/**************************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*******************************/</span>
		<span class="cm">/* Test if counter initialised */</span>
	   <span class="cm">/*******************************/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
			<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
			<span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_CounterInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/********************************************/</span>
			<span class="cm">/* Test if frequency measurement initialised */</span>
	      <span class="cm">/********************************************/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
				<span class="n">s_InitFlag</span><span class="p">.</span><span class="n">b_FrequencyMeasurementInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/******************/</span>
				<span class="cm">/* Test if enable */</span>
		 <span class="cm">/******************/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
					<span class="n">s_SiemensCounterInfo</span><span class="p">.</span>
					<span class="n">s_InitFlag</span><span class="p">.</span>
					<span class="n">b_FrequencyMeasurementEnable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/*******************/</span>
					<span class="cm">/* Read the status */</span>
		    <span class="cm">/*******************/</span>

					<span class="n">dw_StatusReg</span> <span class="o">=</span>
						<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
						<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">+</span>
						<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

		    <span class="cm">/**************************/</span>
					<span class="cm">/* Test if frequency stop */</span>
		    <span class="cm">/**************************/</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">dw_StatusReg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">pb_Status</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
						<span class="o">*</span><span class="n">pb_UDStatus</span> <span class="o">=</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_StatusReg</span> <span class="o">&gt;&gt;</span>
								<span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

		       <span class="cm">/******************/</span>
						<span class="cm">/* Read the value */</span>
		       <span class="cm">/******************/</span>

						<span class="o">*</span><span class="n">pul_ReadValue</span> <span class="o">=</span>
							<span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
							<span class="n">s_BoardInfos</span><span class="p">.</span>
							<span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">28</span> <span class="o">+</span>
							<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

						<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pb_UDStatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			  <span class="cm">/*************************/</span>
							<span class="cm">/* Test the counter mode */</span>
			  <span class="cm">/*************************/</span>

							<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_SiemensCounterInfo</span><span class="p">.</span><span class="n">s_ModeRegister</span><span class="p">.</span><span class="n">s_ByteModeRegister</span><span class="p">.</span><span class="n">b_ModeRegister1</span> <span class="o">&amp;</span> <span class="n">APCI1710_16BIT_COUNTER</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_16BIT_COUNTER</span><span class="p">)</span> <span class="p">{</span>
			     <span class="cm">/****************************************/</span>
								<span class="cm">/* Test if 16-bit counter 1 pulse occur */</span>
			     <span class="cm">/****************************************/</span>

								<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pul_ReadValue</span> <span class="o">&amp;</span> <span class="mh">0xFFFFU</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">ui_16BitValue</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
										<span class="o">*</span>
										<span class="n">pul_ReadValue</span>
										<span class="o">&amp;</span>
										<span class="mh">0xFFFFU</span><span class="p">;</span>
									<span class="o">*</span><span class="n">pul_ReadValue</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="o">*</span><span class="n">pul_ReadValue</span>
										<span class="o">&amp;</span>
										<span class="mh">0xFFFF0000UL</span><span class="p">)</span>
										<span class="o">|</span>
										<span class="p">(</span><span class="mh">0xFFFFU</span>
										<span class="o">-</span>
										<span class="n">ui_16BitValue</span><span class="p">);</span>
								<span class="p">}</span>

			     <span class="cm">/****************************************/</span>
								<span class="cm">/* Test if 16-bit counter 2 pulse occur */</span>
			     <span class="cm">/****************************************/</span>

								<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pul_ReadValue</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">ui_16BitValue</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
										<span class="p">(</span>
										<span class="p">(</span><span class="o">*</span><span class="n">pul_ReadValue</span>
											<span class="o">&gt;&gt;</span>
											<span class="mi">16</span><span class="p">)</span>
										<span class="o">&amp;</span>
										<span class="mh">0xFFFFU</span><span class="p">);</span>
									<span class="o">*</span><span class="n">pul_ReadValue</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="o">*</span><span class="n">pul_ReadValue</span>
										<span class="o">&amp;</span>
										<span class="mh">0xFFFFUL</span><span class="p">)</span>
										<span class="o">|</span>
										<span class="p">(</span>
										<span class="p">(</span><span class="mh">0xFFFFU</span> <span class="o">-</span> <span class="n">ui_16BitValue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
								<span class="p">}</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pul_ReadValue</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
									<span class="o">*</span><span class="n">pul_ReadValue</span>
										<span class="o">=</span>
										<span class="mh">0xFFFFFFFFUL</span>
										<span class="o">-</span>
										<span class="o">*</span><span class="n">pul_ReadValue</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pb_UDStatus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			     <span class="cm">/****************************************/</span>
								<span class="cm">/* Test if 16-bit counter 2 pulse occur */</span>
			     <span class="cm">/****************************************/</span>

								<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pul_ReadValue</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">ui_16BitValue</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
										<span class="p">(</span>
										<span class="p">(</span><span class="o">*</span><span class="n">pul_ReadValue</span>
											<span class="o">&gt;&gt;</span>
											<span class="mi">16</span><span class="p">)</span>
										<span class="o">&amp;</span>
										<span class="mh">0xFFFFU</span><span class="p">);</span>
									<span class="o">*</span><span class="n">pul_ReadValue</span>
										<span class="o">=</span>
										<span class="p">(</span><span class="o">*</span><span class="n">pul_ReadValue</span>
										<span class="o">&amp;</span>
										<span class="mh">0xFFFFUL</span><span class="p">)</span>
										<span class="o">|</span>
										<span class="p">(</span>
										<span class="p">(</span><span class="mh">0xFFFFU</span> <span class="o">-</span> <span class="n">ui_16BitValue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
								<span class="p">}</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pb_UDStatus</span>
									<span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/****************************************/</span>
									<span class="cm">/* Test if 16-bit counter 1 pulse occur */</span>
				<span class="cm">/****************************************/</span>

									<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pul_ReadValue</span> <span class="o">&amp;</span> <span class="mh">0xFFFFU</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
										<span class="n">ui_16BitValue</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
											<span class="o">*</span>
											<span class="n">pul_ReadValue</span>
											<span class="o">&amp;</span>
											<span class="mh">0xFFFFU</span><span class="p">;</span>
										<span class="o">*</span><span class="n">pul_ReadValue</span>
											<span class="o">=</span>
											<span class="p">(</span><span class="o">*</span><span class="n">pul_ReadValue</span>
											<span class="o">&amp;</span>
											<span class="mh">0xFFFF0000UL</span><span class="p">)</span>
											<span class="o">|</span>
											<span class="p">(</span><span class="mh">0xFFFFU</span>
											<span class="o">-</span>
											<span class="n">ui_16BitValue</span><span class="p">);</span>
									<span class="p">}</span>
								<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">pb_Status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="o">*</span><span class="n">pb_UDStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">pb_Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="o">*</span><span class="n">pb_UDStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/***********************************************/</span>
				<span class="cm">/* Frequency measurement logic not initialised */</span>
		 <span class="cm">/***********************************************/</span>

				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Frequency measurement logic not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="cm">/****************************************/</span>
			<span class="cm">/* Counter not initialised see function */</span>
			<span class="cm">/* &quot;i_APCI1710_InitCounter&quot;             */</span>
	      <span class="cm">/****************************************/</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Counter not initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="cm">/*************************************************/</span>
		<span class="cm">/* The selected module number parameter is wrong */</span>
	   <span class="cm">/*************************************************/</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The selected module number parameter is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
