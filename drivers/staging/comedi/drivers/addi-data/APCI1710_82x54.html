<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › addi-data › APCI1710_82x54.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>APCI1710_82x54.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 2004,2005  ADDI-DATA GmbH for the source code of this module.</span>
<span class="cm"> *</span>
<span class="cm"> *	ADDI-DATA GmbH</span>
<span class="cm"> *	Dieselstrasse 3</span>
<span class="cm"> *	D-77833 Ottersweier</span>
<span class="cm"> *	Tel: +19(0)7223/9493-0</span>
<span class="cm"> *	Fax: +49(0)7223/9493-92</span>
<span class="cm"> *	http://www.addi-data.com</span>
<span class="cm"> *	info@addi-data.com</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm">  | Description :   APCI-1710 82X54 timer module                          |</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;APCI1710_82x54.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_     i_APCI1710_InitTimer                         |</span>
<span class="cm">|                               (unsigned char_   b_BoardHandle,                      |</span>
<span class="cm">|                                unsigned char_   b_ModulNbr,                         |</span>
<span class="cm">|                                unsigned char_   b_TimerNbr,                         |</span>
<span class="cm">|                                unsigned char_   b_TimerMode,                        |</span>
<span class="cm">|                                ULONG_ ul_ReloadValue,                      |</span>
<span class="cm">|                                unsigned char_   b_InputClockSelection,              |</span>
<span class="cm">|                                unsigned char_   b_InputClockLevel,                  |</span>
<span class="cm">|                                unsigned char_   b_OutputLevel,                      |</span>
<span class="cm">|                                unsigned char_   b_HardwareGateLevel)</span>
<span class="cm">int i_InsnConfig_InitTimer(struct comedi_device *dev,struct comedi_subdevice *s,</span>
<span class="cm">	struct comedi_insn *insn,unsigned int *data)</span>
<span class="cm">|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Configure the Timer (b_TimerNbr) operating mode        |</span>
<span class="cm">|                     (b_TimerMode) from selected module (b_ModulNbr).       |</span>
<span class="cm">|                     You must calling this function be for you call any     |</span>
<span class="cm">|                     other function witch access of the timer.              |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                       Timer mode description table                         |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|+--------+-----------------------------+--------------+--------------------+|</span>
<span class="cm">||Selected+      Mode description       +u_ReloadValue | Hardware gate input||</span>
<span class="cm">||  mode  |                             |  description |      action        ||</span>
<span class="cm">|+--------+-----------------------------+--------------+--------------------+|</span>
<span class="cm">||        |Mode 0 is typically used     |              |                    ||</span>
<span class="cm">||        |for event counting. After    |              |                    ||</span>
<span class="cm">||        |the initialisation, OUT      |              |                    ||</span>
<span class="cm">||        |is initially low, and        |              |                    ||</span>
<span class="cm">||   0    |will remain low until the    |Start counting|   Hardware gate    ||</span>
<span class="cm">||        |counter reaches zero.        |   value      |                    ||</span>
<span class="cm">||        |OUT then goes high and       |              |                    ||</span>
<span class="cm">||        |remains high until a new     |              |                    ||</span>
<span class="cm">||        |count is written. See        |              |                    ||</span>
<span class="cm">||        |&quot;i_APCI1710_WriteTimerValue&quot; |              |                    ||</span>
<span class="cm">||        |function.                    |              |                    ||</span>
<span class="cm">|+--------+-----------------------------+--------------+--------------------+|</span>
<span class="cm">||        |Mode 1 is similar to mode 0  |              |                    ||</span>
<span class="cm">||        |except for the gate input    |              |                    ||</span>
<span class="cm">||   1    |action. The gate input is not|Start counting|  Hardware trigger  ||</span>
<span class="cm">||        |used for enabled or disabled |   value      |                    ||</span>
<span class="cm">||        |the timer.                   |              |                    ||</span>
<span class="cm">||        |The gate input is used for   |              |                    ||</span>
<span class="cm">||        |triggered the timer.         |              |                    ||</span>
<span class="cm">|+--------+-----------------------------+--------------+--------------------+|</span>
<span class="cm">||        |This mode functions like a   |              |                    ||</span>
<span class="cm">||        |divide-by-ul_ReloadValue     |              |                    ||</span>
<span class="cm">||        |counter. It is typically used|              |                    ||</span>
<span class="cm">||        |to generate a real time clock|              |                    ||</span>
<span class="cm">||        |interrupt. OUT will initially|              |                    ||</span>
<span class="cm">||   2    |be high after the            |   Division   |  Hardware gate     ||</span>
<span class="cm">||        |initialisation. When the     |    factor    |                    ||</span>
<span class="cm">||        |initial count has decremented|              |                    ||</span>
<span class="cm">||        |to 1, OUT goes low for one   |              |                    ||</span>
<span class="cm">||        |CLK pule. OUT then goes high |              |                    ||</span>
<span class="cm">||        |again, the counter reloads   |              |                    ||</span>
<span class="cm">||        |the initial count            |              |                    ||</span>
<span class="cm">||        |(ul_ReloadValue) and the     |              |                    ||</span>
<span class="cm">||        |process is repeated.         |              |                    ||</span>
<span class="cm">||        |This action can generated a  |              |                    ||</span>
<span class="cm">||        |interrupt. See function      |              |                    ||</span>
<span class="cm">||        |&quot;i_APCI1710_SetBoardInt-     |              |                    ||</span>
<span class="cm">||        |RoutineX&quot;                    |              |                    ||</span>
<span class="cm">||        |and &quot;i_APCI1710_EnableTimer&quot; |              |                    ||</span>
<span class="cm">|+--------+-----------------------------+--------------+--------------------+|</span>
<span class="cm">||        |Mode 3 is typically used for |              |                    ||</span>
<span class="cm">||        |baud rate generation. This   |              |                    ||</span>
<span class="cm">||        |mode is similar to mode 2    |              |                    ||</span>
<span class="cm">||        |except for the duty cycle of |              |                    ||</span>
<span class="cm">||   3    |OUT. OUT will initially be   |  Division    |   Hardware gate    ||</span>
<span class="cm">||        |high after the initialisation|   factor     |                    ||</span>
<span class="cm">||        |When half the initial count  |              |                    ||</span>
<span class="cm">||        |(ul_ReloadValue) has expired,|              |                    ||</span>
<span class="cm">||        |OUT goes low for the         |              |                    ||</span>
<span class="cm">||        |remainder of the count. The  |              |                    ||</span>
<span class="cm">||        |mode is periodic; the        |              |                    ||</span>
<span class="cm">||        |sequence above is repeated   |              |                    ||</span>
<span class="cm">||        |indefinitely.                |              |                    ||</span>
<span class="cm">|+--------+-----------------------------+--------------+--------------------+|</span>
<span class="cm">||        |OUT will be initially high   |              |                    ||</span>
<span class="cm">||        |after the initialisation.    |              |                    ||</span>
<span class="cm">||        |When the initial count       |              |                    ||</span>
<span class="cm">||   4    |expires OUT will go low for  |Start counting|  Hardware gate     ||</span>
<span class="cm">||        |one CLK pulse and then go    |    value     |                    ||</span>
<span class="cm">||        |high again.                  |              |                    ||</span>
<span class="cm">||        |The counting sequences is    |              |                    ||</span>
<span class="cm">||        |triggered by writing a new   |              |                    ||</span>
<span class="cm">||        |value. See                   |              |                    ||</span>
<span class="cm">||        |&quot;i_APCI1710_WriteTimerValue&quot; |              |                    ||</span>
<span class="cm">||        |function. If a new count is  |              |                    ||</span>
<span class="cm">||        |written during counting,     |              |                    ||</span>
<span class="cm">||        |it will be loaded on the     |              |                    ||</span>
<span class="cm">||        |next CLK pulse               |              |                    ||</span>
<span class="cm">|+--------+-----------------------------+--------------+--------------------+|</span>
<span class="cm">||        |Mode 5 is similar to mode 4  |              |                    ||</span>
<span class="cm">||        |except for the gate input    |              |                    ||</span>
<span class="cm">||        |action. The gate input is not|              |                    ||</span>
<span class="cm">||   5    |used for enabled or disabled |Start counting|  Hardware trigger  ||</span>
<span class="cm">||        |the timer. The gate input is |    value     |                    ||</span>
<span class="cm">||        |used for triggered the timer.|              |                    ||</span>
<span class="cm">|+--------+-----------------------------+--------------+--------------------+|</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|                      Input clock selection table                           |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">|  +--------------------------------+------------------------------------+   |</span>
<span class="cm">|  |       b_InputClockSelection    |           Description              |   |</span>
<span class="cm">|  |           parameter            |                                    |   |</span>
<span class="cm">|  +--------------------------------+------------------------------------+   |</span>
<span class="cm">|  |    APCI1710_PCI_BUS_CLOCK      | For the timer input clock, the PCI |   |</span>
<span class="cm">|  |                                | bus clock / 4 is used. This PCI bus|   |</span>
<span class="cm">|  |                                | clock can be 30MHz or 33MHz. For   |   |</span>
<span class="cm">|  |                                | Timer 0 only this selection are    |   |</span>
<span class="cm">|  |                                | available.                         |   |</span>
<span class="cm">|  +--------------------------------+------------------------------------+   |</span>
<span class="cm">|  | APCI1710_ FRONT_CONNECTOR_INPUT| Of the front connector you have the|   |</span>
<span class="cm">|  |                                | possibility to inject a input clock|   |</span>
<span class="cm">|  |                                | for Timer 1 or Timer 2. The source |   |</span>
<span class="cm">|  |                                | from this clock can eat the output |   |</span>
<span class="cm">|  |                                | clock from Timer 0 or any other    |   |</span>
<span class="cm">|  |                                | clock source.                      |   |</span>
<span class="cm">|  +--------------------------------+------------------------------------+   |</span>
<span class="cm">|                                                                            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_   b_BoardHandle        : Handle of board         |</span>
<span class="cm">|                                                    APCI-1710               |</span>
<span class="cm">|                     unsigned char_   b_ModulNbr           : Module number to        |</span>
<span class="cm">|                                                    configure (0 to 3)      |</span>
<span class="cm">|                     unsigned char_   b_TimerNbr           : Timer number to         |</span>
<span class="cm">|                                                    configure (0 to 2)      |</span>
<span class="cm">|                     unsigned char_   b_TimerMode          : Timer mode selection    |</span>
<span class="cm">|                                                    (0 to 5)                |</span>
<span class="cm">|                                                    0: Interrupt on terminal|</span>
<span class="cm">|                                                       count                |</span>
<span class="cm">|                                                    1: Hardware             |</span>
<span class="cm">|                                                       retriggerable one-   |</span>
<span class="cm">|                                                       shot                 |</span>
<span class="cm">|                                                    2: Rate generator       |</span>
<span class="cm">|                                                    3: Square wave mode     |</span>
<span class="cm">|                                                    4: Software triggered   |</span>
<span class="cm">|                                                       strobe               |</span>
<span class="cm">|                                                    5: Hardware triggered   |</span>
<span class="cm">|                                                       strobe               |</span>
<span class="cm">|                                                       See timer mode       |</span>
<span class="cm">|                                                       description table.   |</span>
<span class="cm">|                     ULONG_ ul_ReloadValue         : Start counting value   |</span>
<span class="cm">|                                                     or division factor     |</span>
<span class="cm">|                                                     See timer mode         |</span>
<span class="cm">|                                                     description table.     |</span>
<span class="cm">|                     unsigned char_   b_InputClockSelection : Selection from input   |</span>
<span class="cm">|                                                     timer clock.           |</span>
<span class="cm">|                                                     See input clock        |</span>
<span class="cm">|                                                     selection table.       |</span>
<span class="cm">|                     unsigned char_   b_InputClockLevel     : Selection from input   |</span>
<span class="cm">|                                                     clock level.           |</span>
<span class="cm">|                                                     0 : Low active         |</span>
<span class="cm">|                                                         (Input inverted)   |</span>
<span class="cm">|                                                     1 : High active        |</span>
<span class="cm">|                     unsigned char_   b_OutputLevel,        : Selection from output  |</span>
<span class="cm">|                                                     clock level.           |</span>
<span class="cm">|                                                     0 : Low active         |</span>
<span class="cm">|                                                     1 : High active        |</span>
<span class="cm">|                                                         (Output inverted)  |</span>
<span class="cm">|                     unsigned char_   b_HardwareGateLevel   : Selection from         |</span>
<span class="cm">|                                                     hardware gate level.   |</span>
<span class="cm">|                                                     0 : Low active         |</span>
<span class="cm">|                                                         (Input inverted)   |</span>
<span class="cm">|                                                     1 : High active        |</span>
<span class="cm">|                                                     If you will not used   |</span>
<span class="cm">|                                                     the hardware gate set  |</span>
<span class="cm">|                                                     this value to 0.</span>
<span class="cm">|b_ModulNbr        = (unsigned char) CR_AREF(insn-&gt;chanspec);</span>
<span class="cm">	b_TimerNbr		  = (unsigned char) CR_CHAN(insn-&gt;chanspec);</span>
<span class="cm">	b_TimerMode		  = (unsigned char) data[0];</span>
<span class="cm">	ul_ReloadValue	  = (unsigned int) data[1];</span>
<span class="cm">	b_InputClockSelection	=(unsigned char) data[2];</span>
<span class="cm">	b_InputClockLevel		=(unsigned char) data[3];</span>
<span class="cm">	b_OutputLevel			=(unsigned char) data[4];</span>
<span class="cm">	b_HardwareGateLevel		=(unsigned char) data[5];</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0: No error                                            |</span>
<span class="cm">|                    -1: The handle parameter of the board is wrong          |</span>
<span class="cm">|                    -2: Module selection wrong                              |</span>
<span class="cm">|                    -3: Timer selection wrong                               |</span>
<span class="cm">|                    -4: The module is not a TIMER module                    |</span>
<span class="cm">|                    -5: Timer mode selection is wrong                       |</span>
<span class="cm">|                    -6: Input timer clock selection is wrong                |</span>
<span class="cm">|                    -7: Selection from input clock level is wrong           |</span>
<span class="cm">|                    -8: Selection from output clock level is wrong          |</span>
<span class="cm">|                    -9: Selection from hardware gate level is wrong         |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">i_APCI1710_InsnConfigInitTimer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_TimerNbr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_TimerMode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_ReloadValue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_InputClockSelection</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_InputClockLevel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_OutputLevel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_HardwareGateLevel</span><span class="p">;</span>

	<span class="cm">/* BEGIN JK 27.10.2003 : Add the possibility to use a 40 Mhz quartz */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_Test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* END JK 27.10.2003 : Add the possibility to use a 40 Mhz quartz */</span>

	<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="n">b_ModulNbr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">b_TimerNbr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">b_TimerMode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ul_ReloadValue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">b_InputClockSelection</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">b_InputClockLevel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">b_OutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">b_HardwareGateLevel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="cm">/* Test the module number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Test if 82X54 timer */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_82X54_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Test the timer number */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Test the timer mode */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">b_TimerMode</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* BEGIN JK 27.10.2003 : Add the possibility to use a 40 Mhz quartz */</span>
					<span class="cm">/* Test te imput clock selection */</span>
					<span class="cm">/*</span>
<span class="cm">					   if (((b_TimerNbr == 0) &amp;&amp; (b_InputClockSelection == 0)) ||</span>
<span class="cm">					   ((b_TimerNbr != 0) &amp;&amp; ((b_InputClockSelection == 0) || (b_InputClockSelection == 1))))</span>
<span class="cm">					 */</span>

					<span class="k">if</span> <span class="p">(((</span><span class="n">b_TimerNbr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					     <span class="p">(</span><span class="n">b_InputClockSelection</span> <span class="o">==</span> <span class="n">APCI1710_PCI_BUS_CLOCK</span><span class="p">))</span> <span class="o">||</span>
					    <span class="p">((</span><span class="n">b_TimerNbr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					     <span class="p">(</span><span class="n">b_InputClockSelection</span> <span class="o">==</span> <span class="n">APCI1710_10MHZ</span><span class="p">))</span> <span class="o">||</span>
					    <span class="p">((</span><span class="n">b_TimerNbr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					     <span class="p">((</span><span class="n">b_InputClockSelection</span> <span class="o">==</span> <span class="n">APCI1710_PCI_BUS_CLOCK</span><span class="p">)</span> <span class="o">||</span>
					      <span class="p">(</span><span class="n">b_InputClockSelection</span> <span class="o">==</span> <span class="n">APCI1710_FRONT_CONNECTOR_INPUT</span><span class="p">)</span> <span class="o">||</span>
					      <span class="p">(</span><span class="n">b_InputClockSelection</span> <span class="o">==</span> <span class="n">APCI1710_10MHZ</span><span class="p">))))</span> <span class="p">{</span>
						<span class="cm">/* BEGIN JK 27.10.2003 : Add the possibility to use a 40 Mhz quartz */</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">b_InputClockSelection</span> <span class="o">==</span> <span class="n">APCI1710_10MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						     <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFFUL</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x3131</span><span class="p">))</span> <span class="o">||</span>
						     <span class="p">(</span><span class="n">b_InputClockSelection</span> <span class="o">!=</span> <span class="n">APCI1710_10MHZ</span><span class="p">))</span> <span class="p">{</span>
							<span class="cm">/* END JK 27.10.2003 : Add the possibility to use a 40 Mhz quartz */</span>
							<span class="cm">/* Test the input clock level selection */</span>

							<span class="k">if</span> <span class="p">((</span><span class="n">b_InputClockLevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
							    <span class="p">(</span><span class="n">b_InputClockLevel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
								<span class="cm">/* Test the output clock level selection */</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">b_OutputLevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b_OutputLevel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
									<span class="cm">/* Test the hardware gate level selection */</span>
									<span class="k">if</span> <span class="p">((</span><span class="n">b_HardwareGateLevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b_HardwareGateLevel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
										<span class="cm">/* BEGIN JK 27.10.03 : Add the possibility to use a 40 Mhz quartz */</span>
										<span class="cm">/* Test if version &gt; 1.1 and clock selection = 10MHz */</span>
										<span class="k">if</span> <span class="p">((</span><span class="n">b_InputClockSelection</span> <span class="o">==</span> <span class="n">APCI1710_10MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFFUL</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x3131</span><span class="p">))</span> <span class="p">{</span>
											<span class="cm">/* Test if 40MHz quartz on board */</span>
											<span class="n">dw_Test</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">)));</span>

											<span class="n">dw_Test</span> <span class="o">=</span> <span class="p">(</span><span class="n">dw_Test</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
											<span class="n">dw_Test</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
										<span class="p">}</span>

										<span class="cm">/* Test if detection OK */</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">dw_Test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
											<span class="cm">/* END JK 27.10.03 : Add the possibility to use a 40 Mhz quartz */</span>
											<span class="cm">/* Initialisation OK */</span>
											<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_82X54Init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

											<span class="cm">/* Save the input clock selection */</span>
											<span class="n">devpriv</span><span class="o">-&gt;</span> <span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_InputClockSelection</span> <span class="o">=</span> <span class="n">b_InputClockSelection</span><span class="p">;</span>

											<span class="cm">/* Save the input clock level */</span>
											<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_InputClockLevel</span> <span class="o">=</span> <span class="o">~</span><span class="n">b_InputClockLevel</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

											<span class="cm">/* Save the output level */</span>
											<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_OutputLevel</span> <span class="o">=</span> <span class="o">~</span><span class="n">b_OutputLevel</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

											<span class="cm">/* Save the gate level */</span>
											<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_HardwareGateLevel</span> <span class="o">=</span> <span class="n">b_HardwareGateLevel</span><span class="p">;</span>

											<span class="cm">/* Set the configuration word and disable the timer */</span>
											<span class="cm">/* BEGIN JK 27.10.03 : Add the possibility to use a 40 Mhz quartz */</span>
											<span class="cm">/*</span>
<span class="cm">											   devpriv-&gt;s_ModuleInfo [b_ModulNbr].</span>
<span class="cm">											   s_82X54ModuleInfo.</span>
<span class="cm">											   s_82X54TimerInfo  [b_TimerNbr].</span>
<span class="cm">											   dw_ConfigurationWord = (unsigned int) (((b_HardwareGateLevel         &lt;&lt; 0) &amp; 0x1) |</span>
<span class="cm">											   ((b_InputClockLevel           &lt;&lt; 1) &amp; 0x2) |</span>
<span class="cm">											   (((~b_OutputLevel       &amp; 1)  &lt;&lt; 2) &amp; 0x4) |</span>
<span class="cm">											   ((b_InputClockSelection       &lt;&lt; 4) &amp; 0x10));</span>
<span class="cm">											 */</span>
											<span class="cm">/* Test if 10MHz selected */</span>
											<span class="k">if</span> <span class="p">(</span><span class="n">b_InputClockSelection</span> <span class="o">==</span> <span class="n">APCI1710_10MHZ</span><span class="p">)</span> <span class="p">{</span>
												<span class="n">b_InputClockSelection</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
											<span class="p">}</span>

											<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(((</span><span class="n">b_HardwareGateLevel</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b_InputClockLevel</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="o">~</span><span class="n">b_OutputLevel</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b_InputClockSelection</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">));</span>
											<span class="cm">/* END JK 27.10.03 : Add the possibility to use a 40 Mhz quartz */</span>
											<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

											<span class="cm">/* Initialise the 82X54 Timer */</span>
											<span class="n">outl</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">b_TimerMode</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

											<span class="cm">/* Write the reload value */</span>
											<span class="n">outl</span><span class="p">(</span><span class="n">ul_ReloadValue</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
											<span class="cm">/* BEGIN JK 27.10.03 : Add the possibility to use a 40 Mhz quartz */</span>
										<span class="p">}</span>	<span class="cm">/*  if (dw_Test == 1) */</span>
										<span class="k">else</span> <span class="p">{</span>
											<span class="cm">/* Input timer clock selection is wrong */</span>
											<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
										<span class="p">}</span>	<span class="cm">/*  if (dw_Test == 1) */</span>
										<span class="cm">/* END JK 27.10.03 : Add the possibility to use a 40 Mhz quartz */</span>
									<span class="p">}</span>	<span class="cm">/*  if ((b_HardwareGateLevel == 0) || (b_HardwareGateLevel == 1)) */</span>
									<span class="k">else</span> <span class="p">{</span>
										<span class="cm">/* Selection from hardware gate level is wrong */</span>
										<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Selection from hardware gate level is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
										<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span><span class="p">;</span>
									<span class="p">}</span>	<span class="cm">/*  if ((b_HardwareGateLevel == 0) || (b_HardwareGateLevel == 1)) */</span>
								<span class="p">}</span>	<span class="cm">/*  if ((b_OutputLevel == 0) || (b_OutputLevel == 1)) */</span>
								<span class="k">else</span> <span class="p">{</span>
									<span class="cm">/* Selection from output clock level is wrong */</span>
									<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Selection from output clock level is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
									<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span>
								<span class="p">}</span>	<span class="cm">/*  if ((b_OutputLevel == 0) || (b_OutputLevel == 1)) */</span>
							<span class="p">}</span>	<span class="cm">/*  if ((b_InputClockLevel == 0) || (b_InputClockLevel == 1)) */</span>
							<span class="k">else</span> <span class="p">{</span>
								<span class="cm">/* Selection from input clock level is wrong */</span>
								<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Selection from input clock level is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">7</span><span class="p">;</span>
							<span class="p">}</span>	<span class="cm">/*  if ((b_InputClockLevel == 0) || (b_InputClockLevel == 1)) */</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="cm">/* Input timer clock selection is wrong */</span>
							<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Input timer clock selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* Input timer clock selection is wrong */</span>
						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Input timer clock selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>	<span class="cm">/*  if ((b_TimerMode &gt;= 0) &amp;&amp; (b_TimerMode &lt;= 5)) */</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Timer mode selection is wrong */</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer mode selection is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>	<span class="cm">/*  if ((b_TimerMode &gt;= 0) &amp;&amp; (b_TimerMode &lt;= 5)) */</span>
			<span class="p">}</span>	<span class="cm">/*  if ((b_TimerNbr &gt;= 0) &amp;&amp; (b_TimerNbr &lt;= 2)) */</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Timer selection wrong */</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer selection wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/*  if ((b_TimerNbr &gt;= 0) &amp;&amp; (b_TimerNbr &lt;= 2)) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The module is not a TIMER module */</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a TIMER module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Module number error */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_     i_APCI1710_EnableTimer                       |</span>
<span class="cm">|                               (unsigned char_ b_BoardHandle,                        |</span>
<span class="cm">|                                unsigned char_ b_ModulNbr,                           |</span>
<span class="cm">|                                unsigned char_ b_TimerNbr,                           |</span>
<span class="cm">|                                unsigned char_ b_InterruptEnable)</span>
<span class="cm">int i_APCI1710_InsnWriteEnableDisableTimer(struct comedi_device *dev,struct comedi_subdevice *s,</span>
<span class="cm">	struct comedi_insn *insn,unsigned int *data)                |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Enable OR Disable the Timer (b_TimerNbr) from selected module     |</span>
<span class="cm">|                     (b_ModulNbr). You must calling the                     |</span>
<span class="cm">|                     &quot;i_APCI1710_InitTimer&quot; function be for you call this   |</span>
<span class="cm">|                     function. If you enable the timer interrupt, the timer |</span>
<span class="cm">|                     generate a interrupt after the timer value reach       |</span>
<span class="cm">|                     the zero. See function &quot;i_APCI1710_SetBoardIntRoutineX&quot;|</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_   b_BoardHandle     : Handle of board            |</span>
<span class="cm">|                                                 APCI-1710                  |</span>
<span class="cm">|                     unsigned char_   b_ModulNbr        : Selected module number     |</span>
<span class="cm">|                                                 (0 to 3)                   |</span>
<span class="cm">|                     unsigned char_   b_TimerNbr        : Timer number to enable     |</span>
<span class="cm">|                                                 (0 to 2)                   |</span>
<span class="cm">|                     unsigned char_   b_InterruptEnable : Enable or disable the      |</span>
<span class="cm">|                                                 timer interrupt.           |</span>
<span class="cm">|                                                 APCI1710_ENABLE :          |</span>
<span class="cm">|                                                 Enable the timer interrupt |</span>
<span class="cm">|                                                 APCI1710_DISABLE :         |</span>
<span class="cm">|                                                 Disable the timer interrupt|</span>
<span class="cm">i_ReturnValue=insn-&gt;n;</span>
<span class="cm">	b_ModulNbr        = (unsigned char) CR_AREF(insn-&gt;chanspec);</span>
<span class="cm">	b_TimerNbr		  = (unsigned char) CR_CHAN(insn-&gt;chanspec);</span>
<span class="cm">	b_ActionType      = (unsigned char) data[0]; /*  enable disable */</span>
<span class="o">+----------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">Output</span> <span class="n">Parameters</span> <span class="o">:</span> <span class="o">-</span>                                                      <span class="o">|</span>
<span class="o">+----------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">Return</span> <span class="n">Value</span>      <span class="o">:</span> <span class="mi">0</span><span class="o">:</span> <span class="n">No</span> <span class="n">error</span>                                            <span class="o">|</span>
<span class="o">|</span>                    <span class="o">-</span><span class="mi">1</span><span class="o">:</span> <span class="n">The</span> <span class="n">handle</span> <span class="n">parameter</span> <span class="n">of</span> <span class="n">the</span> <span class="n">board</span> <span class="n">is</span> <span class="n">wrong</span>          <span class="o">|</span>
<span class="o">|</span>                    <span class="o">-</span><span class="mi">2</span><span class="o">:</span> <span class="n">Module</span> <span class="n">selection</span> <span class="n">wrong</span>                              <span class="o">|</span>
<span class="o">|</span>                    <span class="o">-</span><span class="mi">3</span><span class="o">:</span> <span class="n">Timer</span> <span class="n">selection</span> <span class="n">wrong</span>                               <span class="o">|</span>
<span class="o">|</span>                    <span class="o">-</span><span class="mi">4</span><span class="o">:</span> <span class="n">The</span> <span class="n">module</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">TIMER</span> <span class="n">module</span>                    <span class="o">|</span>
<span class="o">|</span>                    <span class="o">-</span><span class="mi">5</span><span class="o">:</span> <span class="n">Timer</span> <span class="n">not</span> <span class="n">initialised</span> <span class="n">see</span> <span class="n">function</span>                  <span class="o">|</span>
<span class="o">|</span>                        <span class="s">&quot;i_APCI1710_InitTimer&quot;</span>                              <span class="o">|</span>
<span class="o">|</span>                    <span class="o">-</span><span class="mi">6</span><span class="o">:</span> <span class="n">Interrupt</span> <span class="n">parameter</span> <span class="n">is</span> <span class="n">wrong</span>                        <span class="o">|</span>
<span class="o">|</span>                    <span class="o">-</span><span class="mi">7</span><span class="o">:</span> <span class="n">Interrupt</span> <span class="n">function</span> <span class="n">not</span> <span class="n">initialised</span><span class="p">.</span>                 <span class="o">|</span>
<span class="o">|</span>                        <span class="n">See</span> <span class="n">function</span> <span class="s">&quot;i_APCI1710_SetBoardIntRoutineX&quot;</span>       <span class="o">|</span>
<span class="o">+----------------------------------------------------------------------------+</span>
<span class="err">*/</span>

<span class="kt">int</span> <span class="n">i_APCI1710_InsnWriteEnableDisableTimer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_DummyRead</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_TimerNbr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ActionType</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_InterruptEnable</span><span class="p">;</span>

	<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="n">b_ModulNbr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">b_TimerNbr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">b_ActionType</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/*  enable disable */</span>

	<span class="cm">/* Test the module number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Test if 82X54 timer */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_82X54_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Test the timer number */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Test if timer initialised */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_82X54Init</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">switch</span> <span class="p">(</span><span class="n">b_ActionType</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">APCI1710_ENABLE</span>:
						<span class="n">b_InterruptEnable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
						<span class="cm">/* Test the interrupt selection */</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">b_InterruptEnable</span> <span class="o">==</span> <span class="n">APCI1710_ENABLE</span><span class="p">)</span> <span class="o">||</span>
						    <span class="p">(</span><span class="n">b_InterruptEnable</span> <span class="o">==</span> <span class="n">APCI1710_DISABLE</span><span class="p">))</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">b_InterruptEnable</span> <span class="o">==</span> <span class="n">APCI1710_ENABLE</span><span class="p">)</span> <span class="p">{</span>

								<span class="n">dw_DummyRead</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

								<span class="cm">/* Enable the interrupt */</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span> <span class="o">|</span> <span class="mh">0x8</span><span class="p">;</span>

								<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">tsk_Current</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>	<span class="cm">/*  Save the current process task structure */</span>

							<span class="p">}</span>	<span class="cm">/*  if (b_InterruptEnable == APCI1710_ENABLE) */</span>
							<span class="k">else</span> <span class="p">{</span>
								<span class="cm">/* Disable the interrupt */</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span> <span class="o">&amp;</span> <span class="mh">0xF7</span><span class="p">;</span>

								<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

								<span class="cm">/* Save the interrupt flag */</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">b_InterruptMask</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">b_InterruptMask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_TimerNbr</span><span class="p">));</span>
							<span class="p">}</span>	<span class="cm">/*  if (b_InterruptEnable == APCI1710_ENABLE) */</span>

							<span class="cm">/* Test if error occur */</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="cm">/* Save the interrupt flag */</span>
								<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">b_InterruptMask</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">b_InterruptMask</span> <span class="o">|</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="n">b_InterruptEnable</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">b_TimerNbr</span><span class="p">);</span>

								<span class="cm">/* Enable the timer */</span>
								<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">44</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="cm">/* Interrupt parameter is wrong */</span>
							<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">APCI1710_DISABLE</span>:
						<span class="cm">/* Test the interrupt flag */</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">b_InterruptMask</span> <span class="o">&gt;&gt;</span> <span class="n">b_TimerNbr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* Disable the interrupt */</span>

							<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span> <span class="n">dw_ConfigurationWord</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span> <span class="o">&amp;</span> <span class="mh">0xF7</span><span class="p">;</span>

							<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">dw_ConfigurationWord</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

							<span class="cm">/* Save the interrupt flag */</span>
							<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">b_InterruptMask</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">b_InterruptMask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b_TimerNbr</span><span class="p">));</span>
						<span class="p">}</span>

						<span class="cm">/* Disable the timer */</span>
						<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">44</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>	<span class="cm">/*  Switch end */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Timer not initialised see function */</span>
					<span class="n">DPRINTK</span> <span class="p">(</span><span class="s">&quot;Timer not initialised see function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Timer selection wrong */</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer selection wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/*  if ((b_TimerNbr &gt;= 0) &amp;&amp; (b_TimerNbr &lt;= 2)) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The module is not a TIMER module */</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a TIMER module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Module number error */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_     i_APCI1710_ReadAllTimerValue                 |</span>
<span class="cm">|                                       (unsigned char_     b_BoardHandle,            |</span>
<span class="cm">|                                        unsigned char_     b_ModulNbr,               |</span>
<span class="cm">|                                        PULONG_ pul_TimerValueArray)</span>
<span class="cm">int i_APCI1710_InsnReadAllTimerValue(struct comedi_device *dev,struct comedi_subdevice *s,</span>
<span class="cm">	struct comedi_insn *insn,unsigned int *data)        |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the all timer values from selected timer        |</span>
<span class="cm">|                     module (b_ModulNbr).                                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_   b_BoardHandle     : Handle of board            |</span>
<span class="cm">|                                                 APCI-1710                  |</span>
<span class="cm">|                     unsigned char_   b_ModulNbr        : Selected module number     |</span>
<span class="cm">|                                                 (0 to 3)                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : PULONG_ pul_TimerValueArray : Timer value array.       |</span>
<span class="cm">|                           Element 0 contain the timer 0 value.             |</span>
<span class="cm">|                           Element 1 contain the timer 1 value.             |</span>
<span class="cm">|                           Element 2 contain the timer 2 value.             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0: No error                                            |</span>
<span class="cm">|                    -1: The handle parameter of the board is wrong          |</span>
<span class="cm">|                    -2: Module selection wrong                              |</span>
<span class="cm">|                    -3: The module is not a TIMER module                    |</span>
<span class="cm">|                    -4: Timer 0 not initialised see function                |</span>
<span class="cm">|                        &quot;i_APCI1710_InitTimer&quot;                              |</span>
<span class="cm">|                    -5: Timer 1 not initialised see function                |</span>
<span class="cm">|                        &quot;i_APCI1710_InitTimer&quot;                              |</span>
<span class="cm">|                    -6: Timer 2 not initialised see function                |</span>
<span class="cm">|                        &quot;i_APCI1710_InitTimer&quot;                              |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="n">i_APCI1710_InsnReadAllTimerValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="n">b_ReadType</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pul_TimerValueArray</span><span class="p">;</span>

	<span class="n">b_ModulNbr</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">b_ReadType</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">pul_TimerValueArray</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">b_ReadType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APCI1710_TIMER_READINTERRUPT</span>:

		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">s_FIFOInterruptParameters</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span><span class="p">].</span><span class="n">b_OldModuleMask</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">s_FIFOInterruptParameters</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span><span class="p">].</span><span class="n">ul_OldInterruptMask</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">s_FIFOInterruptParameters</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span><span class="p">].</span><span class="n">ul_OldCounterLatchValue</span><span class="p">;</span>

		<span class="cm">/* Increment the read FIFO */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_InterruptParameters</span><span class="p">.</span><span class="n">ui_Read</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">APCI1710_SAVE_INTERRUPT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_TIMER_READALLTIMER</span>:
		<span class="cm">/* Test the module number */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Test if 82X54 timer */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_82X54_TIMER</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Test if timer 0 iniutialised */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">b_82X54Init</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Test if timer 1 iniutialised */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">b_82X54Init</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* Test if timer 2 iniutialised */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">b_82X54Init</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* Latch all counter */</span>
							<span class="n">outl</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

							<span class="cm">/* Read the timer 0 value */</span>
							<span class="n">pul_TimerValueArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

							<span class="cm">/* Read the timer 1 value */</span>
							<span class="n">pul_TimerValueArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

							<span class="cm">/* Read the timer 2 value */</span>
							<span class="n">pul_TimerValueArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="cm">/* Timer 2 not initialised see function */</span>
							<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer 2 not initialised see function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* Timer 1 not initialised see function */</span>
						<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer 1 not initialised see function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Timer 0 not initialised see function */</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer 0 not initialised see function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* The module is not a TIMER module */</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a TIMER module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Module number error */</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>			<span class="cm">/*  End of Switch */</span>
	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     :INT i_APCI1710_InsnBitsTimer(struct comedi_device *dev,</span>
<span class="cm">struct comedi_subdevice *s,struct comedi_insn *insn,unsigned int *data)                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Read write functions for Timer                                          |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      :</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="n">i_APCI1710_InsnBitsTimer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_BitsType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b_BitsType</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">82X54&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">b_BitsType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APCI1710_TIMER_READVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_ReadTimerValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
							  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
							  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_TIMER_GETOUTPUTLEVEL</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_GetTimerOutputLevel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
							       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
							       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_TIMER_GETPROGRESSSTATUS</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_GetTimerProgressStatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
								  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
								  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APCI1710_TIMER_WRITEVALUE</span>:
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">i_APCI1710_WriteTimerValue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
							   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
							   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bits Config Parameter Wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_ReturnValue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_     i_APCI1710_ReadTimerValue                    |</span>
<span class="cm">|                                       (unsigned char_     b_BoardHandle,            |</span>
<span class="cm">|                                        unsigned char_     b_ModulNbr,               |</span>
<span class="cm">|                                        unsigned char_     b_TimerNbr,               |</span>
<span class="cm">|                                        PULONG_ pul_TimerValue)             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the timer value from selected digital timer     |</span>
<span class="cm">|                     (b_TimerNbr) from selected timer  module (b_ModulNbr). |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_   b_BoardHandle     : Handle of board            |</span>
<span class="cm">|                                                 APCI-1710                  |</span>
<span class="cm">|                     unsigned char_   b_ModulNbr        : Selected module number     |</span>
<span class="cm">|                                                 (0 to 3)                   |</span>
<span class="cm">|                     unsigned char_   b_TimerNbr        : Timer number to read       |</span>
<span class="cm">|                                                 (0 to 2)                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : PULONG_ pul_TimerValue    : Timer value                |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0: No error                                            |</span>
<span class="cm">|                    -1: The handle parameter of the board is wrong          |</span>
<span class="cm">|                    -2: Module selection wrong                              |</span>
<span class="cm">|                    -3: Timer selection wrong                               |</span>
<span class="cm">|                    -4: The module is not a TIMER module                    |</span>
<span class="cm">|                    -5: Timer not initialised see function                  |</span>
<span class="cm">|                        &quot;i_APCI1710_InitTimer&quot;                              |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="n">i_APCI1710_ReadTimerValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_TimerNbr</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pul_TimerValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Test the module number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Test if 82X54 timer */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
		     <span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span>
		     <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_82X54_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Test the timer number */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Test if timer initialised */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
				    <span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span>
				    <span class="n">s_82X54ModuleInfo</span><span class="p">.</span>
				    <span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span>
				    <span class="n">b_82X54Init</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Latch the timer value */</span>
					<span class="n">outl</span><span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">b_TimerNbr</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xD0</span><span class="p">,</span>
					     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
					     <span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span>
					     <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

					<span class="cm">/* Read the counter value */</span>
					<span class="o">*</span><span class="n">pul_TimerValue</span> <span class="o">=</span>
					    <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span>
						<span class="n">ui_Address</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
						<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Timer not initialised see function */</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer not initialised see function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Timer selection wrong */</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer selection wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/*  if ((b_TimerNbr &gt;= 0) &amp;&amp; (b_TimerNbr &lt;= 2)) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The module is not a TIMER module */</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a TIMER module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Module number error */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Function Name     : _INT_     i_APCI1710_GetTimerOutputLevel               |</span>
<span class="cm">	   |                                       (unsigned char_     b_BoardHandle,            |</span>
<span class="cm">	   |                                        unsigned char_     b_ModulNbr,               |</span>
<span class="cm">	   |                                        unsigned char_     b_TimerNbr,               |</span>
<span class="cm">	   |                                        unsigned char *_   pb_OutputLevel)            |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Task              : Return the output signal level (pb_OutputLevel) from   |</span>
<span class="cm">	   |                     selected digital timer (b_TimerNbr) from selected timer|</span>
<span class="cm">	   |                     module (b_ModulNbr).                                   |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Input Parameters  : unsigned char_   b_BoardHandle     : Handle of board            |</span>
<span class="cm">	   |                                                 APCI-1710                  |</span>
<span class="cm">	   |                     unsigned char_   b_ModulNbr        : Selected module number     |</span>
<span class="cm">	   |                                                 (0 to 3)                   |</span>
<span class="cm">	   |                     unsigned char_   b_TimerNbr        : Timer number to test       |</span>
<span class="cm">	   |                                                 (0 to 2)                   |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Output Parameters : unsigned char *_ pb_OutputLevel     : Output signal level        |</span>
<span class="cm">	   |                                                 0 : The output is low      |</span>
<span class="cm">	   |                                                 1 : The output is high     |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	   | Return Value      : 0: No error                                            |</span>
<span class="cm">	   |                    -1: The handle parameter of the board is wrong          |</span>
<span class="cm">	   |                    -2: Module selection wrong                              |</span>
<span class="cm">	   |                    -3: Timer selection wrong                               |</span>
<span class="cm">	   |                    -4: The module is not a TIMER module                    |</span>
<span class="cm">	   |                    -5: Timer not initialised see function                  |</span>
<span class="cm">	   |                        &quot;i_APCI1710_InitTimer&quot;                              |</span>
<span class="cm">	   +----------------------------------------------------------------------------+</span>
<span class="cm">	 */</span>

<span class="kt">int</span> <span class="n">i_APCI1710_GetTimerOutputLevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_TimerNbr</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_OutputLevel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_TimerStatus</span><span class="p">;</span>

	<span class="cm">/* Test the module number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Test if 82X54 timer */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_82X54_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Test the timer number */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Test if timer initialised */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_82X54Init</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Latch the timer value */</span>
					<span class="n">outl</span><span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">b_TimerNbr</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

					<span class="cm">/* Read the timer status */</span>
					<span class="n">dw_TimerStatus</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

					<span class="o">*</span><span class="n">pb_OutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(((</span><span class="n">dw_TimerStatus</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">devpriv</span><span class="o">-&gt;</span> <span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_OutputLevel</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Timer not initialised see function */</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer not initialised see function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Timer selection wrong */</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer selection wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/*  if ((b_TimerNbr &gt;= 0) &amp;&amp; (b_TimerNbr &lt;= 2)) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The module is not a TIMER module */</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a TIMER module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Module number error */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_     i_APCI1710_GetTimerProgressStatus            |</span>
<span class="cm">|                                       (unsigned char_     b_BoardHandle,            |</span>
<span class="cm">|                                        unsigned char_     b_ModulNbr,               |</span>
<span class="cm">|                                        unsigned char_     b_TimerNbr,               |</span>
<span class="cm">|                                        unsigned char *_   pb_TimerStatus)            |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Return the progress status (pb_TimerStatus) from       |</span>
<span class="cm">|                     selected digital timer (b_TimerNbr) from selected timer|</span>
<span class="cm">|                     module (b_ModulNbr).                                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_   b_BoardHandle     : Handle of board            |</span>
<span class="cm">|                                                 APCI-1710                  |</span>
<span class="cm">|                     unsigned char_   b_ModulNbr        : Selected module number     |</span>
<span class="cm">|                                                 (0 to 3)                   |</span>
<span class="cm">|                     unsigned char_   b_TimerNbr        : Timer number to test       |</span>
<span class="cm">|                                                 (0 to 2)                   |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : unsigned char *_ pb_TimerStatus     : Output signal level        |</span>
<span class="cm">|                                                 0 : Timer not in progress  |</span>
<span class="cm">|                                                 1 : Timer in progress      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0: No error                                            |</span>
<span class="cm">|                    -1: The handle parameter of the board is wrong          |</span>
<span class="cm">|                    -2: Module selection wrong                              |</span>
<span class="cm">|                    -3: Timer selection wrong                               |</span>
<span class="cm">|                    -4: The module is not a TIMER module                    |</span>
<span class="cm">|                    -5: Timer not initialised see function                  |</span>
<span class="cm">|                        &quot;i_APCI1710_InitTimer&quot;                              |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="n">i_APCI1710_GetTimerProgressStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_TimerNbr</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pb_TimerStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dw_TimerStatus</span><span class="p">;</span>

	<span class="cm">/* Test the module number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Test if 82X54 timer */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_82X54_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Test the timer number */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Test if timer initialised */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_82X54Init</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Latch the timer value */</span>
					<span class="n">outl</span><span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">b_TimerNbr</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

					<span class="cm">/* Read the timer status */</span>
					<span class="n">dw_TimerStatus</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>

					<span class="o">*</span><span class="n">pb_TimerStatus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">dw_TimerStatus</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ProgressStatus : %d&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pb_TimerStatus</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Timer not initialised see function */</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Timer selection wrong */</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/*  if ((b_TimerNbr &gt;= 0) &amp;&amp; (b_TimerNbr &lt;= 2)) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The module is not a TIMER module */</span>

			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Module number error */</span>

		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Function Name     : _INT_     i_APCI1710_WriteTimerValue                   |</span>
<span class="cm">|                                       (unsigned char_   b_BoardHandle,              |</span>
<span class="cm">|                                        unsigned char_   b_ModulNbr,                 |</span>
<span class="cm">|                                        unsigned char_   b_TimerNbr,                 |</span>
<span class="cm">|                                        ULONG_ ul_WriteValue)               |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Task              : Write the value (ul_WriteValue) into the selected timer|</span>
<span class="cm">|                     (b_TimerNbr) from selected timer module (b_ModulNbr).  |</span>
<span class="cm">|                     The action in depend of the time mode selection.       |</span>
<span class="cm">|                     See timer mode description table.                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Input Parameters  : unsigned char_   b_BoardHandle     : Handle of board            |</span>
<span class="cm">|                                                 APCI-1710                  |</span>
<span class="cm">|                     unsigned char_   b_ModulNbr        : Selected module number     |</span>
<span class="cm">|                                                 (0 to 3)                   |</span>
<span class="cm">|                     unsigned char_   b_TimerNbr        : Timer number to write      |</span>
<span class="cm">|                                                 (0 to 2)                   |</span>
<span class="cm">|                     ULONG_ ul_WriteValue      : Value to write             |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Output Parameters : -                                                      |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">| Return Value      : 0: No error                                            |</span>
<span class="cm">|                    -1: The handle parameter of the board is wrong          |</span>
<span class="cm">|                    -2: Module selection wrong                              |</span>
<span class="cm">|                    -3: Timer selection wrong                               |</span>
<span class="cm">|                    -4: The module is not a TIMER module                    |</span>
<span class="cm">|                    -5: Timer not initialised see function                  |</span>
<span class="cm">|                        &quot;i_APCI1710_InitTimer&quot;                              |</span>
<span class="cm">+----------------------------------------------------------------------------+</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="n">i_APCI1710_WriteTimerValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_ModulNbr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b_TimerNbr</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ul_WriteValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Test the module number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_ModulNbr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Test if 82X54 timer */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">dw_MolduleConfiguration</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">APCI1710_82X54_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Test the timer number */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Test if timer initialised */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_ModuleInfo</span><span class="p">[</span><span class="n">b_ModulNbr</span><span class="p">].</span><span class="n">s_82X54ModuleInfo</span><span class="p">.</span><span class="n">s_82X54TimerInfo</span><span class="p">[</span><span class="n">b_TimerNbr</span><span class="p">].</span><span class="n">b_82X54Init</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Write the value */</span>
					<span class="n">outl</span><span class="p">(</span><span class="n">ul_WriteValue</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">s_BoardInfos</span><span class="p">.</span><span class="n">ui_Address</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_TimerNbr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">b_ModulNbr</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Timer not initialised see function */</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer not initialised see function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Timer selection wrong */</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Timer selection wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/*  if ((b_TimerNbr &gt;= 0) &amp;&amp; (b_TimerNbr &lt;= 2)) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The module is not a TIMER module */</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;The module is not a TIMER module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Module number error */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Module number error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i_ReturnValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i_ReturnValue</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
