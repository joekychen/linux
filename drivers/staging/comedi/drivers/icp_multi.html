<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › icp_multi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>icp_multi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/drivers/icp_multi.c</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 1997-2002 David A. Schleef &lt;ds@schleef.org&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">Driver: icp_multi</span>
<span class="cm">Description: Inova ICP_MULTI</span>
<span class="cm">Author: Anne Smorthit &lt;anne.smorthit@sfwte.ch&gt;</span>
<span class="cm">Devices: [Inova] ICP_MULTI (icp_multi)</span>
<span class="cm">Status: works</span>

<span class="cm">The driver works for analog input and output and digital input and output.</span>
<span class="cm">It does not work with interrupts or with the counters.  Currently no support</span>
<span class="cm">for DMA.</span>

<span class="cm">It has 16 single-ended or 8 differential Analogue Input channels with 12-bit</span>
<span class="cm">resolution.  Ranges : 5V, 10V, +/-5V, +/-10V, 0..20mA and 4..20mA.  Input</span>
<span class="cm">ranges can be individually programmed for each channel.  Voltage or current</span>
<span class="cm">measurement is selected by jumper.</span>

<span class="cm">There are 4 x 12-bit Analogue Outputs.  Ranges : 5V, 10V, +/-5V, +/-10V</span>

<span class="cm">16 x Digital Inputs, 24V</span>

<span class="cm">8 x Digital Outputs, 24V, 1A</span>

<span class="cm">4 x 16-bit counters</span>

<span class="cm">Options:</span>
<span class="cm"> [0] - PCI bus number - if bus number and slot number are 0,</span>
<span class="cm">			then driver search for first unused card</span>
<span class="cm"> [1] - PCI slot number</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &quot;icp_multi.h&quot;</span>

<span class="cp">#define DEVICE_ID	0x8000	</span><span class="cm">/* Device ID */</span><span class="cp"></span>

<span class="cp">#define ICP_MULTI_EXTDEBUG</span>

<span class="cm">/*  Hardware types of the cards */</span>
<span class="cp">#define TYPE_ICP_MULTI	0</span>

<span class="cp">#define IORANGE_ICP_MULTI 	32</span>

<span class="cp">#define ICP_MULTI_ADC_CSR	0	</span><span class="cm">/* R/W: ADC command/status register */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_AI		2	</span><span class="cm">/* R:   Analogue input data */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_DAC_CSR	4	</span><span class="cm">/* R/W: DAC command/status register */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_AO		6	</span><span class="cm">/* R/W: Analogue output data */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_DI		8	</span><span class="cm">/* R/W: Digital inouts */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_DO		0x0A	</span><span class="cm">/* R/W: Digital outputs */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_INT_EN	0x0C	</span><span class="cm">/* R/W: Interrupt enable register */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_INT_STAT	0x0E	</span><span class="cm">/* R/W: Interrupt status register */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_CNTR0		0x10	</span><span class="cm">/* R/W: Counter 0 */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_CNTR1		0x12	</span><span class="cm">/* R/W: counter 1 */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_CNTR2		0x14	</span><span class="cm">/* R/W: Counter 2 */</span><span class="cp"></span>
<span class="cp">#define ICP_MULTI_CNTR3		0x16	</span><span class="cm">/* R/W: Counter 3 */</span><span class="cp"></span>

<span class="cp">#define ICP_MULTI_SIZE		0x20	</span><span class="cm">/* 32 bytes */</span><span class="cp"></span>

<span class="cm">/*  Define bits from ADC command/status register */</span>
<span class="cp">#define	ADC_ST		0x0001	</span><span class="cm">/* Start ADC */</span><span class="cp"></span>
<span class="cp">#define	ADC_BSY		0x0001	</span><span class="cm">/* ADC busy */</span><span class="cp"></span>
<span class="cp">#define ADC_BI		0x0010	</span><span class="cm">/* Bipolar input range 1 = bipolar */</span><span class="cp"></span>
<span class="cp">#define ADC_RA		0x0020	</span><span class="cm">/* Input range 0 = 5V, 1 = 10V */</span><span class="cp"></span>
<span class="cp">#define	ADC_DI		0x0040	</span><span class="cm">/* Differential input mode 1 = differential */</span><span class="cp"></span>

<span class="cm">/*  Define bits from DAC command/status register */</span>
<span class="cp">#define	DAC_ST		0x0001	</span><span class="cm">/* Start DAC */</span><span class="cp"></span>
<span class="cp">#define DAC_BSY		0x0001	</span><span class="cm">/* DAC busy */</span><span class="cp"></span>
<span class="cp">#define	DAC_BI		0x0010	</span><span class="cm">/* Bipolar input range 1 = bipolar */</span><span class="cp"></span>
<span class="cp">#define	DAC_RA		0x0020	</span><span class="cm">/* Input range 0 = 5V, 1 = 10V */</span><span class="cp"></span>

<span class="cm">/*  Define bits from interrupt enable/status registers */</span>
<span class="cp">#define	ADC_READY	0x0001	</span><span class="cm">/* A/d conversion ready interrupt */</span><span class="cp"></span>
<span class="cp">#define	DAC_READY	0x0002	</span><span class="cm">/* D/a conversion ready interrupt */</span><span class="cp"></span>
<span class="cp">#define	DOUT_ERROR	0x0004	</span><span class="cm">/* Digital output error interrupt */</span><span class="cp"></span>
<span class="cp">#define	DIN_STATUS	0x0008	</span><span class="cm">/* Digital input status change interrupt */</span><span class="cp"></span>
<span class="cp">#define	CIE0		0x0010	</span><span class="cm">/* Counter 0 overrun interrupt */</span><span class="cp"></span>
<span class="cp">#define	CIE1		0x0020	</span><span class="cm">/* Counter 1 overrun interrupt */</span><span class="cp"></span>
<span class="cp">#define	CIE2		0x0040	</span><span class="cm">/* Counter 2 overrun interrupt */</span><span class="cp"></span>
<span class="cp">#define	CIE3		0x0080	</span><span class="cm">/* Counter 3 overrun interrupt */</span><span class="cp"></span>

<span class="cm">/*  Useful definitions */</span>
<span class="cp">#define	Status_IRQ	0x00ff	</span><span class="cm">/*  All interrupts */</span><span class="cp"></span>

<span class="cm">/*  Define analogue range */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_analog</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
						       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
						       <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
						       <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
						       <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
						       <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">range_codes_analog</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">	Data &amp; Structure declarations</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_list_builded</span><span class="p">;</span>	<span class="cm">/*&gt;0 list of card is known */</span>

<span class="k">struct</span> <span class="n">boardtype</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>	<span class="cm">/*  driver name */</span>
	<span class="kt">int</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iorange</span><span class="p">;</span>		<span class="cm">/*  I/O range len */</span>
	<span class="kt">char</span> <span class="n">have_irq</span><span class="p">;</span>		<span class="cm">/*  1=card support IRQ */</span>
	<span class="kt">char</span> <span class="n">cardtype</span><span class="p">;</span>		<span class="cm">/*  0=ICP Multi */</span>
	<span class="kt">int</span> <span class="n">n_aichan</span><span class="p">;</span>		<span class="cm">/*  num of A/D chans */</span>
	<span class="kt">int</span> <span class="n">n_aichand</span><span class="p">;</span>		<span class="cm">/*  num of A/D chans in diff mode */</span>
	<span class="kt">int</span> <span class="n">n_aochan</span><span class="p">;</span>		<span class="cm">/*  num of D/A chans */</span>
	<span class="kt">int</span> <span class="n">n_dichan</span><span class="p">;</span>		<span class="cm">/*  num of DI chans */</span>
	<span class="kt">int</span> <span class="n">n_dochan</span><span class="p">;</span>		<span class="cm">/*  num of DO chans */</span>
	<span class="kt">int</span> <span class="n">n_ctrs</span><span class="p">;</span>		<span class="cm">/*  num of counters */</span>
	<span class="kt">int</span> <span class="n">ai_maxdata</span><span class="p">;</span>		<span class="cm">/*  resolution of A/D */</span>
	<span class="kt">int</span> <span class="n">ao_maxdata</span><span class="p">;</span>		<span class="cm">/*  resolution of D/A */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">rangelist_ai</span><span class="p">;</span>	<span class="cm">/*  rangelist for A/D */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rangecode</span><span class="p">;</span>	<span class="cm">/*  range codes for programming */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">rangelist_ao</span><span class="p">;</span>	<span class="cm">/*  rangelist for D/A */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">icp_multi_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>	<span class="cm">/*  pointer to card */</span>
	<span class="kt">char</span> <span class="n">valid</span><span class="p">;</span>		<span class="cm">/*  card is usable */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">io_addr</span><span class="p">;</span>		<span class="cm">/*  Pointer to mapped io address */</span>
	<span class="n">resource_size_t</span> <span class="n">phys_iobase</span><span class="p">;</span>	<span class="cm">/*  Physical io address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">AdcCmdStatus</span><span class="p">;</span>	<span class="cm">/*  ADC Command/Status register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DacCmdStatus</span><span class="p">;</span>	<span class="cm">/*  DAC Command/Status register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IntEnable</span><span class="p">;</span>	<span class="cm">/*  Interrupt Enable register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IntStatus</span><span class="p">;</span>	<span class="cm">/*  Interrupt Status register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">act_chanlist</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>	<span class="cm">/*  list of scaned channel */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">act_chanlist_len</span><span class="p">;</span>	<span class="cm">/*  len of scanlist */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">act_chanlist_pos</span><span class="p">;</span>	<span class="cm">/*  actual position in MUX list */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ai_chanlist</span><span class="p">;</span>	<span class="cm">/*  actaul chanlist */</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">ai_data</span><span class="p">;</span>		<span class="cm">/*  data buffer */</span>
	<span class="kt">short</span> <span class="n">ao_data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/*  data output buffer */</span>
	<span class="kt">short</span> <span class="n">di_data</span><span class="p">;</span>		<span class="cm">/*  Digital input data */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">do_data</span><span class="p">;</span>	<span class="cm">/*  Remember digital output data */</span>
<span class="p">};</span>

<span class="cp">#define devpriv ((struct icp_multi_private *)dev-&gt;private)</span>
<span class="cp">#define this_board ((const struct boardtype *)dev-&gt;board_ptr)</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	setup_channel_list</span>

<span class="cm">Description:</span>
<span class="cm">	This function sets the appropriate channel selection,</span>
<span class="cm">	differential input mode and range bits in the ADC Command/</span>
<span class="cm">	Status register.</span>

<span class="cm">Parameters:</span>
<span class="cm">	struct comedi_device *dev	Pointer to current service structure</span>
<span class="cm">	struct comedi_subdevice *s	Pointer to current subdevice structure</span>
<span class="cm">	unsigned int *chanlist	Pointer to packed channel list</span>
<span class="cm">	unsigned int n_chan	Number of channels to scan</span>

<span class="cm">Returns:Void</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">chanprog</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diff</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;icp multi EDBG:  setup_channel_list(...,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n_chan</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_len</span> <span class="o">=</span> <span class="n">n_chan</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Get channel */</span>
		<span class="n">chanprog</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/*  Determine if it is a differential channel (Bit 15  = 1) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chanprog</span> <span class="o">&amp;=</span> <span class="mh">0x0007</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chanprog</span> <span class="o">&amp;=</span> <span class="mh">0x000f</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*  Clear channel, range and input mode bits</span>
<span class="cm">		 *  in A/D command/status register */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdcCmdStatus</span> <span class="o">&amp;=</span> <span class="mh">0xf00f</span><span class="p">;</span>

		<span class="cm">/*  Set channel number and differential mode status bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  Set channel number, bits 9-11 &amp; mode, bit 6 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdcCmdStatus</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chanprog</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdcCmdStatus</span> <span class="o">|=</span> <span class="n">ADC_DI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/*  Set channel number, bits 8-11 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdcCmdStatus</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chanprog</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="cm">/*  Get range for current channel */</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">rangecode</span><span class="p">[</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])];</span>
		<span class="cm">/*  Set range. bits 4-5 */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdcCmdStatus</span> <span class="o">|=</span> <span class="n">range</span><span class="p">;</span>

		<span class="cm">/* Output channel, range, mode to ICP Multi */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdcCmdStatus</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_ADC_CSR</span><span class="p">);</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;GS: %2d. [%4x]=%4x %4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">chanprog</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">act_chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	icp_multi_insn_read_ai</span>

<span class="cm">Description:</span>
<span class="cm">	This function reads a single analogue input.</span>

<span class="cm">Parameters:</span>
<span class="cm">	struct comedi_device *dev	Pointer to current device structure</span>
<span class="cm">	struct comedi_subdevice *s	Pointer to current subdevice structure</span>
<span class="cm">	struct comedi_insn *insn	Pointer to current comedi instruction</span>
<span class="cm">	unsigned int *data		Pointer to analogue input data</span>

<span class="cm">Returns:int			Nmuber of instructions executed</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">icp_multi_insn_read_ai</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icp multi EDBG: BGN: icp_multi_insn_read_ai(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*  Disable A/D conversion ready interrupt */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_READY</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_EN</span><span class="p">);</span>

	<span class="cm">/*  Clear interrupt status */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span> <span class="o">|=</span> <span class="n">ADC_READY</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_STAT</span><span class="p">);</span>

	<span class="cm">/*  Set up appropriate channel, mode and range data, for specified ch */</span>
	<span class="n">setup_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icp_multi A ST=%4x IO=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_ADC_CSR</span><span class="p">),</span>
	       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_ADC_CSR</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Set start ADC bit */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdcCmdStatus</span> <span class="o">|=</span> <span class="n">ADC_ST</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdcCmdStatus</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_ADC_CSR</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdcCmdStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_ST</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icp multi B n=%d ST=%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
		       <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_ADC_CSR</span><span class="p">));</span>
<span class="cp">#endif</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icp multi C n=%d ST=%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
		       <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_ADC_CSR</span><span class="p">));</span>
<span class="cp">#endif</span>

		<span class="cm">/*  Wait for conversion to complete, or get fed up waiting */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span>
				    <span class="n">ICP_MULTI_ADC_CSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ADC_BSY</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">conv_finish</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">timeout</span> <span class="o">%</span> <span class="mi">10</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;icp multi D n=%d tm=%d ST=%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
				       <span class="n">timeout</span><span class="p">,</span>
				       <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span>
					     <span class="n">ICP_MULTI_ADC_CSR</span><span class="p">));</span>
<span class="cp">#endif</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*  If we reach here, a timeout has occurred */</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D insn timeout&quot;</span><span class="p">);</span>

		<span class="cm">/*  Disable interrupt */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_READY</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_EN</span><span class="p">);</span>

		<span class="cm">/*  Clear interrupt status */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span> <span class="o">|=</span> <span class="n">ADC_READY</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_STAT</span><span class="p">);</span>

		<span class="cm">/*  Clear data received */</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		      <span class="s">&quot;icp multi EDBG: END: icp_multi_insn_read_ai(...) n=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">n</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

<span class="nl">conv_finish:</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_AI</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Disable interrupt */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADC_READY</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_EN</span><span class="p">);</span>

	<span class="cm">/*  Clear interrupt status */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span> <span class="o">|=</span> <span class="n">ADC_READY</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_STAT</span><span class="p">);</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;icp multi EDBG: END: icp_multi_insn_read_ai(...) n=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	icp_multi_insn_write_ao</span>

<span class="cm">Description:</span>
<span class="cm">	This function writes a single analogue output.</span>

<span class="cm">Parameters:</span>
<span class="cm">	struct comedi_device *dev	Pointer to current device structure</span>
<span class="cm">	struct comedi_subdevice *s	Pointer to current subdevice structure</span>
<span class="cm">	struct comedi_insn *insn	Pointer to current comedi instruction</span>
<span class="cm">	unsigned int *data		Pointer to analogue output data</span>

<span class="cm">Returns:int			Nmuber of instructions executed</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">icp_multi_insn_write_ao</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;icp multi EDBG: BGN: icp_multi_insn_write_ao(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*  Disable D/A conversion ready interrupt */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAC_READY</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_EN</span><span class="p">);</span>

	<span class="cm">/*  Clear interrupt status */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span> <span class="o">|=</span> <span class="n">DAC_READY</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_STAT</span><span class="p">);</span>

	<span class="cm">/*  Get channel number and range */</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/*  Set up range and channel data */</span>
	<span class="cm">/*  Bit 4 = 1 : Bipolar */</span>
	<span class="cm">/*  Bit 5 = 0 : 5V */</span>
	<span class="cm">/*  Bit 5 = 1 : 10V */</span>
	<span class="cm">/*  Bits 8-9 : Channel number */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span> <span class="o">&amp;=</span> <span class="mh">0xfccf</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span> <span class="o">|=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">rangecode</span><span class="p">[</span><span class="n">range</span><span class="p">];</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_DAC_CSR</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Wait for analogue output data register to be</span>
<span class="cm">		 *  ready for new data, or get fed up waiting */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span>
				    <span class="n">ICP_MULTI_DAC_CSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DAC_BSY</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">dac_ready</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">timeout</span> <span class="o">%</span> <span class="mi">10</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;icp multi A n=%d tm=%d ST=%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
				       <span class="n">timeout</span><span class="p">,</span>
				       <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span>
					     <span class="n">ICP_MULTI_DAC_CSR</span><span class="p">));</span>
<span class="cp">#endif</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*  If we reach here, a timeout has occurred */</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;D/A insn timeout&quot;</span><span class="p">);</span>

		<span class="cm">/*  Disable interrupt */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAC_READY</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntEnable</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_EN</span><span class="p">);</span>

		<span class="cm">/*  Clear interrupt status */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span> <span class="o">|=</span> <span class="n">DAC_READY</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_STAT</span><span class="p">);</span>

		<span class="cm">/*  Clear data received */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		     <span class="s">&quot;icp multi EDBG: END: icp_multi_insn_write_ao(...) n=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">n</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

<span class="nl">dac_ready:</span>
		<span class="cm">/*  Write data to analogue output data register */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_AO</span><span class="p">);</span>

		<span class="cm">/*  Set DAC_ST bit to write the data to selected channel */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span> <span class="o">|=</span> <span class="n">DAC_ST</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span><span class="p">,</span>
		       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_DAC_CSR</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAC_ST</span><span class="p">;</span>

		<span class="cm">/*  Save analogue output data */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
	<span class="p">}</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;icp multi EDBG: END: icp_multi_insn_write_ao(...) n=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	icp_multi_insn_read_ao</span>

<span class="cm">Description:</span>
<span class="cm">	This function reads a single analogue output.</span>

<span class="cm">Parameters:</span>
<span class="cm">	struct comedi_device *dev	Pointer to current device structure</span>
<span class="cm">	struct comedi_subdevice *s	Pointer to current subdevice structure</span>
<span class="cm">	struct comedi_insn *insn	Pointer to current comedi instruction</span>
<span class="cm">	unsigned int *data		Pointer to analogue output data</span>

<span class="cm">Returns:int			Nmuber of instructions executed</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">icp_multi_insn_read_ao</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">chan</span><span class="p">;</span>

	<span class="cm">/*  Get channel number */</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/*  Read analogue outputs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	icp_multi_insn_bits_di</span>

<span class="cm">Description:</span>
<span class="cm">	This function reads the digital inputs.</span>

<span class="cm">Parameters:</span>
<span class="cm">	struct comedi_device *dev	Pointer to current device structure</span>
<span class="cm">	struct comedi_subdevice *s	Pointer to current subdevice structure</span>
<span class="cm">	struct comedi_insn *insn	Pointer to current comedi instruction</span>
<span class="cm">	unsigned int *data		Pointer to analogue output data</span>

<span class="cm">Returns:int			Nmuber of instructions executed</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">icp_multi_insn_bits_di</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_DI</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	icp_multi_insn_bits_do</span>

<span class="cm">Description:</span>
<span class="cm">	This function writes the appropriate digital outputs.</span>

<span class="cm">Parameters:</span>
<span class="cm">	struct comedi_device *dev	Pointer to current device structure</span>
<span class="cm">	struct comedi_subdevice *s	Pointer to current subdevice structure</span>
<span class="cm">	struct comedi_insn *insn	Pointer to current comedi instruction</span>
<span class="cm">	unsigned int *data		Pointer to analogue output data</span>

<span class="cm">Returns:int			Nmuber of instructions executed</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">icp_multi_insn_bits_do</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icp multi EDBG: BGN: icp_multi_insn_bits_do(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Digital outputs = %4x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="n">writew</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_DO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_DI</span><span class="p">);</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icp multi EDBG: END: icp_multi_insn_bits_do(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	icp_multi_insn_read_ctr</span>

<span class="cm">Description:</span>
<span class="cm">	This function reads the specified counter.</span>

<span class="cm">Parameters:</span>
<span class="cm">	struct comedi_device *dev	Pointer to current device structure</span>
<span class="cm">	struct comedi_subdevice *s	Pointer to current subdevice structure</span>
<span class="cm">	struct comedi_insn *insn	Pointer to current comedi instruction</span>
<span class="cm">	unsigned int *data		Pointer to counter data</span>

<span class="cm">Returns:int			Nmuber of instructions executed</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">icp_multi_insn_read_ctr</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	icp_multi_insn_write_ctr</span>

<span class="cm">Description:</span>
<span class="cm">	This function write to the specified counter.</span>

<span class="cm">Parameters:</span>
<span class="cm">	struct comedi_device *dev	Pointer to current device structure</span>
<span class="cm">	struct comedi_subdevice *s	Pointer to current subdevice structure</span>
<span class="cm">	struct comedi_insn *insn	Pointer to current comedi instruction</span>
<span class="cm">	unsigned int *data		Pointer to counter data</span>

<span class="cm">Returns:int			Nmuber of instructions executed</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">icp_multi_insn_write_ctr</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	interrupt_service_icp_multi</span>

<span class="cm">Description:</span>
<span class="cm">	This function is the interrupt service routine for all</span>
<span class="cm">	interrupts generated by the icp multi board.</span>

<span class="cm">Parameters:</span>
<span class="cm">	int irq</span>
<span class="cm">	void *d			Pointer to current device</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_service_icp_multi</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">int_no</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;icp multi EDBG: BGN: interrupt_service_icp_multi(%d,...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*  Is this interrupt from our board? */</span>
	<span class="n">int_no</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Status_IRQ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">int_no</span><span class="p">)</span>
		<span class="cm">/*  No, exit */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;icp multi EDBG: interrupt_service_icp_multi() ST: %4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_STAT</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/*  Determine which interrupt is active &amp; handle it */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">int_no</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADC_READY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC_READY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DOUT_ERROR</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIN_STATUS</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIE0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIE1</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIE2</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIE3</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;icp multi EDBG: END: interrupt_service_icp_multi(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c">==============================================================================</span>

<span class="c">Name:	check_channel_list</span>

<span class="c">Description:</span>
<span class="c">	This function checks if the channel list, provided by user</span>
<span class="c">	is built correctly</span>

<span class="c">Parameters:</span>
<span class="c">	struct comedi_device *dev	Pointer to current service structure</span>
<span class="c">	struct comedi_subdevice *s	Pointer to current subdevice structure</span>
<span class="c">	unsigned int *chanlist	Pointer to packed channel list</span>
<span class="c">	unsigned int n_chan	Number of channels to scan</span>

<span class="c">Returns:int 0 = failure</span>
<span class="c">	    1 = success</span>

<span class="c">==============================================================================</span>
<span class="c">*/</span>
<span class="c">static int check_channel_list(struct comedi_device *dev,</span>
<span class="c">			      struct comedi_subdevice *s,</span>
<span class="c">			      unsigned int *chanlist, unsigned int n_chan)</span>
<span class="c">{</span>
<span class="c">	unsigned int i;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
<span class="c">	printk(KERN_DEBUG</span>
<span class="c">	       &quot;icp multi EDBG:  check_channel_list(...,%d)\n&quot;, n_chan);</span>
<span class="cp">#endif</span>
<span class="c">	/*  Check that we at least have one channel to check */</span>
<span class="c">	if (n_chan &lt; 1) {</span>
<span class="c">		comedi_error(dev, &quot;range/channel list is empty!&quot;);</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="c">	/*  Check all channels */</span>
<span class="c">	for (i = 0; i &lt; n_chan; i++) {</span>
<span class="c">		/*  Check that channel number is &lt; maximum */</span>
<span class="c">		if (CR_AREF(chanlist[i]) == AREF_DIFF) {</span>
<span class="c">			if (CR_CHAN(chanlist[i]) &gt; this_board-&gt;n_aichand) {</span>
<span class="c">				comedi_error(dev,</span>
<span class="c">					     &quot;Incorrect differential ai ch-nr&quot;);</span>
<span class="c">				return 0;</span>
<span class="c">			}</span>
<span class="c">		} else {</span>
<span class="c">			if (CR_CHAN(chanlist[i]) &gt; this_board-&gt;n_aichan) {</span>
<span class="c">				comedi_error(dev,</span>
<span class="c">					     &quot;Incorrect ai channel number&quot;);</span>
<span class="c">				return 0;</span>
<span class="c">			}</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	return 1;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>

<span class="cm">Name:	icp_multi_reset</span>

<span class="cm">Description:</span>
<span class="cm">	This function resets the icp multi device to a &#39;safe&#39; state</span>

<span class="cm">Parameters:</span>
<span class="cm">	struct comedi_device *dev	Pointer to current service structure</span>

<span class="cm">Returns:int	0 = success</span>

<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">icp_multi_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;icp_multi EDBG: BGN: icp_multi_reset(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*  Clear INT enables and requests */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_EN</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x00ff</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_INT_STAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">)</span>
		<span class="cm">/*  Set DACs to 0..5V range and 0V output */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span> <span class="o">&amp;=</span> <span class="mh">0xfcce</span><span class="p">;</span>

			<span class="cm">/*  Set channel number */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span> <span class="o">|=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

			<span class="cm">/*  Output 0V */</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_AO</span><span class="p">);</span>

			<span class="cm">/*  Set start conversion bit */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span> <span class="o">|=</span> <span class="n">DAC_ST</span><span class="p">;</span>

			<span class="cm">/*  Output to command / status register */</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">DacCmdStatus</span><span class="p">,</span>
			       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_DAC_CSR</span><span class="p">);</span>

			<span class="cm">/*  Delay to allow DAC time to recover */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="cm">/*  Digital outputs to 0 */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">ICP_MULTI_DO</span><span class="p">);</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;icp multi EDBG: END: icp_multi_reset(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">icp_multi_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">subdev</span><span class="p">,</span> <span class="n">n_subdevices</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcilst_struct</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">io_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pci_bus</span><span class="p">,</span> <span class="n">pci_slot</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
	       <span class="s">&quot;icp_multi EDBG: BGN: icp_multi_attach(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*  Alocate private data storage space */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">icp_multi_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*  Initialise list of PCI cards in system, if not already done so */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_list_builded</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_card_list_init</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ICP</span><span class="p">,</span>
<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
				   <span class="mi">1</span>
<span class="cp">#else</span>
				   <span class="mi">0</span>
<span class="cp">#endif</span>
		    <span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
	       <span class="s">&quot;Anne&#39;s comedi%d: icp_multi: board=%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
	       <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">select_and_alloc_pci_card</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ICP</span><span class="p">,</span>
					 <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pci_card_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="o">&amp;</span><span class="n">irq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot; - Can&#39;t get configuration data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">io_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">phys_iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
	       <span class="s">&quot;, b:s:f=%d:%d:%d, io=0x%8llx </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_bus</span><span class="p">,</span> <span class="n">pci_slot</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">iobase</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ICP_MULTI_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ioremap failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;0x%08llx mapped to %p, &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">iobase</span><span class="p">,</span>
	       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">n_subdevices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_ctrs</span><span class="p">)</span>
		<span class="n">n_subdevices</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n_subdevices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">icp_multi_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">have_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">interrupt_service_icp_multi</span><span class="p">,</span>
					<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;Inova Icp Multi&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				    <span class="s">&quot;unable to allocate IRQ %u, DISABLING IT&quot;</span><span class="p">,</span>
				     <span class="n">irq</span><span class="p">);</span>
				<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Can&#39;t use IRQ */</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;, irq=%u&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;, IRQ disabled&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">subdev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_COMMON</span> <span class="o">|</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichand</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_maxdata</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">rangelist_ai</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">icp_multi_insn_read_ai</span><span class="p">;</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_COMMON</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ao_maxdata</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">rangelist_ao</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">icp_multi_insn_write_ao</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">icp_multi_insn_read_ao</span><span class="p">;</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dichan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">icp_multi_insn_bits_di</span><span class="p">;</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_dochan</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">icp_multi_insn_bits_do</span><span class="p">;</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_ctrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">subdev</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_COUNTER</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_COMMON</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_ctrs</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_ctrs</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">icp_multi_insn_read_ctr</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">icp_multi_insn_write_ctr</span><span class="p">;</span>
		<span class="n">subdev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef ICP_MULTI_EXTDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icp multi EDBG: END: icp_multi_attach(...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">icp_multi_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
			<span class="n">icp_multi_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span>
		<span class="n">pci_card_free</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">pci_list_builded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_card_list_cleanup</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ICP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">boardtype</span> <span class="n">boardtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;icp_multi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device_id</span>	<span class="o">=</span> <span class="n">DEVICE_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iorange</span>	<span class="o">=</span> <span class="n">IORANGE_ICP_MULTI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">have_irq</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cardtype</span>	<span class="o">=</span> <span class="n">TYPE_ICP_MULTI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichan</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichand</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aochan</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_dichan</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_dochan</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_ctrs</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_maxdata</span>	<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_maxdata</span>	<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rangelist_ai</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">range_analog</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rangecode</span>	<span class="o">=</span> <span class="n">range_codes_analog</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rangelist_ao</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">range_analog</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">icp_multi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;icp_multi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">icp_multi_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">icp_multi_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_names</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">boardtypes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">board_name</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">boardtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boardtype</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_driver</span><span class="p">(</span><span class="n">icp_multi_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
