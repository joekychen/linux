<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › quatech_daqp_cs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>quatech_daqp_cs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*======================================================================</span>

<span class="cm">    comedi/drivers/quatech_daqp_cs.c</span>

<span class="cm">    Quatech DAQP PCMCIA data capture cards COMEDI client driver</span>
<span class="cm">    Copyright (C) 2000, 2003 Brent Baccala &lt;baccala@freesoft.org&gt;</span>
<span class="cm">    The DAQP interface code in this file is released into the public domain.</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 1998 David A. Schleef &lt;ds@schleef.org&gt;</span>
<span class="cm">    http://www.comedi.org/</span>

<span class="cm">    quatech_daqp_cs.c 1.10</span>

<span class="cm">    Documentation for the DAQP PCMCIA cards can be found on Quatech&#39;s site:</span>

<span class="cm">		ftp://ftp.quatech.com/Manuals/daqp-208.pdf</span>

<span class="cm">    This manual is for both the DAQP-208 and the DAQP-308.</span>

<span class="cm">    What works:</span>

<span class="cm">	- A/D conversion</span>
<span class="cm">	    - 8 channels</span>
<span class="cm">	    - 4 gain ranges</span>
<span class="cm">	    - ground ref or differential</span>
<span class="cm">	    - single-shot and timed both supported</span>
<span class="cm">	- D/A conversion, single-shot</span>
<span class="cm">	- digital I/O</span>

<span class="cm">    What doesn&#39;t:</span>

<span class="cm">	- any kind of triggering - external or D/A channel 1</span>
<span class="cm">	- the card&#39;s optional expansion board</span>
<span class="cm">	- the card&#39;s timer (for anything other than A/D conversion)</span>
<span class="cm">	- D/A update modes other than immediate (i.e, timed)</span>
<span class="cm">	- fancier timing modes</span>
<span class="cm">	- setting card&#39;s FIFO buffer thresholds to anything but default</span>

<span class="cm">======================================================================*/</span>

<span class="cm">/*</span>
<span class="cm">Driver: quatech_daqp_cs</span>
<span class="cm">Description: Quatech DAQP PCMCIA data capture cards</span>
<span class="cm">Author: Brent Baccala &lt;baccala@freesoft.org&gt;</span>
<span class="cm">Status: works</span>
<span class="cm">Devices: [Quatech] DAQP-208 (daqp), DAQP-308</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/cisreg.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>

<span class="cp">#include &lt;linux/completion.h&gt;</span>

<span class="cm">/* Maximum number of separate DAQP devices we&#39;ll allow */</span>
<span class="cp">#define MAX_DEV         4</span>

<span class="k">struct</span> <span class="n">local_info_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">table_index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">board_name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">enum</span> <span class="p">{</span> <span class="n">semaphore</span><span class="p">,</span> <span class="n">buffer</span> <span class="p">}</span> <span class="n">interrupt_mode</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">completion</span> <span class="n">eos</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* A list of &quot;instances&quot; of the device. */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">dev_table</span><span class="p">[</span><span class="n">MAX_DEV</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* ... */</span>  <span class="p">};</span>

<span class="cm">/* The DAQP communicates with the system through a 16 byte I/O window. */</span>

<span class="cp">#define DAQP_FIFO_SIZE		4096</span>

<span class="cp">#define DAQP_FIFO		0</span>
<span class="cp">#define DAQP_SCANLIST		1</span>
<span class="cp">#define DAQP_CONTROL		2</span>
<span class="cp">#define DAQP_STATUS		2</span>
<span class="cp">#define DAQP_DIGITAL_IO		3</span>
<span class="cp">#define DAQP_PACER_LOW		4</span>
<span class="cp">#define DAQP_PACER_MID		5</span>
<span class="cp">#define DAQP_PACER_HIGH		6</span>
<span class="cp">#define DAQP_COMMAND		7</span>
<span class="cp">#define DAQP_DA			8</span>
<span class="cp">#define DAQP_TIMER		10</span>
<span class="cp">#define DAQP_AUX		15</span>

<span class="cp">#define DAQP_SCANLIST_DIFFERENTIAL	0x4000</span>
<span class="cp">#define DAQP_SCANLIST_GAIN(x)		((x)&lt;&lt;12)</span>
<span class="cp">#define DAQP_SCANLIST_CHANNEL(x)	((x)&lt;&lt;8)</span>
<span class="cp">#define DAQP_SCANLIST_START		0x0080</span>
<span class="cp">#define DAQP_SCANLIST_EXT_GAIN(x)	((x)&lt;&lt;4)</span>
<span class="cp">#define DAQP_SCANLIST_EXT_CHANNEL(x)	(x)</span>

<span class="cp">#define DAQP_CONTROL_PACER_100kHz	0xc0</span>
<span class="cp">#define DAQP_CONTROL_PACER_1MHz		0x80</span>
<span class="cp">#define DAQP_CONTROL_PACER_5MHz		0x40</span>
<span class="cp">#define DAQP_CONTROL_PACER_EXTERNAL	0x00</span>
<span class="cp">#define DAQP_CONTORL_EXPANSION		0x20</span>
<span class="cp">#define DAQP_CONTROL_EOS_INT_ENABLE	0x10</span>
<span class="cp">#define DAQP_CONTROL_FIFO_INT_ENABLE	0x08</span>
<span class="cp">#define DAQP_CONTROL_TRIGGER_ONESHOT	0x00</span>
<span class="cp">#define DAQP_CONTROL_TRIGGER_CONTINUOUS	0x04</span>
<span class="cp">#define DAQP_CONTROL_TRIGGER_INTERNAL	0x00</span>
<span class="cp">#define DAQP_CONTROL_TRIGGER_EXTERNAL	0x02</span>
<span class="cp">#define DAQP_CONTROL_TRIGGER_RISING	0x00</span>
<span class="cp">#define DAQP_CONTROL_TRIGGER_FALLING	0x01</span>

<span class="cp">#define DAQP_STATUS_IDLE		0x80</span>
<span class="cp">#define DAQP_STATUS_RUNNING		0x40</span>
<span class="cp">#define DAQP_STATUS_EVENTS		0x38</span>
<span class="cp">#define DAQP_STATUS_DATA_LOST		0x20</span>
<span class="cp">#define DAQP_STATUS_END_OF_SCAN		0x10</span>
<span class="cp">#define DAQP_STATUS_FIFO_THRESHOLD	0x08</span>
<span class="cp">#define DAQP_STATUS_FIFO_FULL		0x04</span>
<span class="cp">#define DAQP_STATUS_FIFO_NEARFULL	0x02</span>
<span class="cp">#define DAQP_STATUS_FIFO_EMPTY		0x01</span>

<span class="cp">#define DAQP_COMMAND_ARM		0x80</span>
<span class="cp">#define DAQP_COMMAND_RSTF		0x40</span>
<span class="cp">#define DAQP_COMMAND_RSTQ		0x20</span>
<span class="cp">#define DAQP_COMMAND_STOP		0x10</span>
<span class="cp">#define DAQP_COMMAND_LATCH		0x08</span>
<span class="cp">#define DAQP_COMMAND_100kHz		0x00</span>
<span class="cp">#define DAQP_COMMAND_50kHz		0x02</span>
<span class="cp">#define DAQP_COMMAND_25kHz		0x04</span>
<span class="cp">#define DAQP_COMMAND_FIFO_DATA		0x01</span>
<span class="cp">#define DAQP_COMMAND_FIFO_PROGRAM	0x00</span>

<span class="cp">#define DAQP_AUX_TRIGGER_TTL		0x00</span>
<span class="cp">#define DAQP_AUX_TRIGGER_ANALOG		0x80</span>
<span class="cp">#define DAQP_AUX_TRIGGER_PRETRIGGER	0x40</span>
<span class="cp">#define DAQP_AUX_TIMER_INT_ENABLE	0x20</span>
<span class="cp">#define DAQP_AUX_TIMER_RELOAD		0x00</span>
<span class="cp">#define DAQP_AUX_TIMER_PAUSE		0x08</span>
<span class="cp">#define DAQP_AUX_TIMER_GO		0x10</span>
<span class="cp">#define DAQP_AUX_TIMER_GO_EXTERNAL	0x18</span>
<span class="cp">#define DAQP_AUX_TIMER_EXTERNAL_SRC	0x04</span>
<span class="cp">#define DAQP_AUX_TIMER_INTERNAL_SRC	0x00</span>
<span class="cp">#define DAQP_AUX_DA_DIRECT		0x00</span>
<span class="cp">#define DAQP_AUX_DA_OVERFLOW		0x01</span>
<span class="cp">#define DAQP_AUX_DA_EXTERNAL		0x02</span>
<span class="cp">#define DAQP_AUX_DA_PACER		0x03</span>

<span class="cp">#define DAQP_AUX_RUNNING		0x80</span>
<span class="cp">#define DAQP_AUX_TRIGGERED		0x40</span>
<span class="cp">#define DAQP_AUX_DA_BUFFER		0x20</span>
<span class="cp">#define DAQP_AUX_TIMER_OVERFLOW		0x10</span>
<span class="cp">#define DAQP_AUX_CONVERSION		0x08</span>
<span class="cp">#define DAQP_AUX_DATA_LOST		0x04</span>
<span class="cp">#define DAQP_AUX_FIFO_NEARFULL		0x02</span>
<span class="cp">#define DAQP_AUX_FIFO_EMPTY		0x01</span>

<span class="cm">/* These range structures tell COMEDI how the sample values map to</span>
<span class="cm"> * voltages.  The A/D converter has four	.ranges = +/- 10V through</span>
<span class="cm"> * +/- 1.25V, and the D/A converter has only	.one = +/- 5V.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_daqp_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							<span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">)</span>
							<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_daqp_ao</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">)}</span> <span class="p">};</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/* comedi interface code */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">daqp_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">daqp_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">driver_daqp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;quatech_daqp_cs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">daqp_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">daqp_detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef DAQP_DEBUG</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqp_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DAQP: status %02x; aux status %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_STATUS</span><span class="p">),</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_AUX</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hex_dump</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%p:&quot;</span><span class="p">,</span> <span class="n">cptr</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">cptr</span><span class="o">++</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* Cancel a running acquisition */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>


	<span class="n">outb</span><span class="p">(</span><span class="n">DAQP_COMMAND_STOP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_COMMAND</span><span class="p">);</span>

	<span class="cm">/* flush any linguring data in FIFO - superfluous here */</span>
	<span class="cm">/* outb(DAQP_COMMAND_RSTF, dev-&gt;iobase+DAQP_COMMAND); */</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">interrupt_mode</span> <span class="o">=</span> <span class="n">semaphore</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handler</span>
<span class="cm"> *</span>
<span class="cm"> * Operates in one of two modes.  If local-&gt;interrupt_mode is</span>
<span class="cm"> * &#39;semaphore&#39;, just signal the local-&gt;eos completion and return</span>
<span class="cm"> * (one-shot mode).  Otherwise (continuous mode), read data in from</span>
<span class="cm"> * the card, transfer it to the buffer provided by the higher-level</span>
<span class="cm"> * comedi kernel module, and signal various comedi callback routines,</span>
<span class="cm"> * which run pretty quick.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">irqreturn</span> <span class="nf">daqp_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop_limit</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;daqp_interrupt(): irq %d for unknown device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;daqp_interrupt(): NULL comedi_device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;daqp_interrupt(): struct comedi_device not yet attached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;daqp_interrupt(): NULL comedi_subdevice.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">!=</span> <span class="n">local</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;daqp_interrupt(): invalid comedi_subdevice.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">interrupt_mode</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">semaphore</span>:

		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">eos</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">buffer</span>:

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_STATUS</span><span class="p">))</span>
			 <span class="o">&amp;</span> <span class="n">DAQP_STATUS_FIFO_EMPTY</span><span class="p">))</span> <span class="p">{</span>

			<span class="kt">short</span> <span class="n">data</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DAQP_STATUS_DATA_LOST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span>
				    <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;daqp: data lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">daqp_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_FIFO</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_FIFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">^=</span> <span class="mh">0x8000</span><span class="p">;</span>

			<span class="n">comedi_buf_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

			<span class="cm">/* If there&#39;s a limit, decrement it</span>
<span class="cm">			 * and stop conversion if zero</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">daqp_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">loop_limit</span><span class="o">--</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">loop_limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;loop_limit reached in daqp_interrupt()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">daqp_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_BLOCK</span><span class="p">;</span>

		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* One-shot analog data acquisition routine */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>


	<span class="cm">/* Stop any running conversion */</span>
	<span class="n">daqp_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_AUX</span><span class="p">);</span>

	<span class="cm">/* Reset scan list queue */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">DAQP_COMMAND_RSTQ</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_COMMAND</span><span class="p">);</span>

	<span class="cm">/* Program one scan list entry */</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">DAQP_SCANLIST_CHANNEL</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">))</span>
	    <span class="o">|</span> <span class="n">DAQP_SCANLIST_GAIN</span><span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">DAQP_SCANLIST_DIFFERENTIAL</span><span class="p">;</span>


	<span class="n">v</span> <span class="o">|=</span> <span class="n">DAQP_SCANLIST_START</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_SCANLIST</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_SCANLIST</span><span class="p">);</span>

	<span class="cm">/* Reset data FIFO (see page 28 of DAQP User&#39;s Manual) */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">DAQP_COMMAND_RSTF</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_COMMAND</span><span class="p">);</span>

	<span class="cm">/* Set trigger */</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">DAQP_CONTROL_TRIGGER_ONESHOT</span> <span class="o">|</span> <span class="n">DAQP_CONTROL_TRIGGER_INTERNAL</span>
	    <span class="o">|</span> <span class="n">DAQP_CONTROL_PACER_100kHz</span> <span class="o">|</span> <span class="n">DAQP_CONTROL_EOS_INT_ENABLE</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_CONTROL</span><span class="p">);</span>

	<span class="cm">/* Reset any pending interrupts (my card has a tendency to require</span>
<span class="cm">	 * require multiple reads on the status register to achieve this)</span>
<span class="cm">	 */</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">counter</span>
	       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DAQP_STATUS_EVENTS</span><span class="p">))</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;daqp: couldn&#39;t clear interrupts in status register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">eos</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">interrupt_mode</span> <span class="o">=</span> <span class="n">semaphore</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Start conversion */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">DAQP_COMMAND_ARM</span> <span class="o">|</span> <span class="n">DAQP_COMMAND_FIFO_DATA</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_COMMAND</span><span class="p">);</span>

		<span class="cm">/* Wait for interrupt service routine to unblock completion */</span>
		<span class="cm">/* Maybe could use a timeout here, but it&#39;s interruptible */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">eos</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_FIFO</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_FIFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function converts ns nanoseconds to a counter value suitable</span>
<span class="cm"> * for programming the device.  We always use the DAQP&#39;s 5 MHz clock,</span>
<span class="cm"> * which with its 24-bit counter, allows values up to 84 seconds.</span>
<span class="cm"> * Also, the function adjusts ns so that it cooresponds to the actual</span>
<span class="cm"> * time that the device will use.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_ns_to_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">round</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timer</span><span class="p">;</span>

	<span class="n">timer</span> <span class="o">=</span> <span class="o">*</span><span class="n">ns</span> <span class="o">/</span> <span class="mi">200</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">timer</span> <span class="o">*</span> <span class="mi">200</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">timer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* cmdtest tests a particular command to see if it is valid.</span>
<span class="cm"> * Using the cmdtest ioctl, a user can create a valid cmd</span>
<span class="cm"> * and then have it executed by the cmd ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * cmdtest returns 1,2,3,4 or 0, depending on which tests</span>
<span class="cm"> * the command passes.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * step 2: make sure trigger sources</span>
<span class="cm">	 * are unique and mutually compatible</span>
<span class="cm">	 */</span>

	<span class="cm">/* note that mutual compatibility is not an issue here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#define MAX_SPEED	10000	</span><span class="cm">/* 100 kHz - in nanoseconds */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span>
	    <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">MAX_SPEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">MAX_SPEED</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If both scan_begin and convert are both timer values, the only</span>
<span class="cm">	 * way that can make sense is if the scan time is the number of</span>
<span class="cm">	 * conversions times the convert time</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span>
	    <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">MAX_SPEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">MAX_SPEED</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&gt;</span> <span class="mh">0x00ffffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TRIG_NONE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">daqp_ns_to_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
		<span class="n">daqp_ns_to_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scanlist_start_on_every_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">threshold</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>


	<span class="cm">/* Stop any running conversion */</span>
	<span class="n">daqp_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_AUX</span><span class="p">);</span>

	<span class="cm">/* Reset scan list queue */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">DAQP_COMMAND_RSTQ</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_COMMAND</span><span class="p">);</span>

	<span class="cm">/* Program pacer clock</span>
<span class="cm">	 *</span>
<span class="cm">	 * There&#39;s two modes we can operate in.  If convert_src is</span>
<span class="cm">	 * TRIG_TIMER, then convert_arg specifies the time between</span>
<span class="cm">	 * each conversion, so we program the pacer clock to that</span>
<span class="cm">	 * frequency and set the SCANLIST_START bit on every scanlist</span>
<span class="cm">	 * entry.  Otherwise, convert_src is TRIG_NOW, which means</span>
<span class="cm">	 * we want the fastest possible conversions, scan_begin_src</span>
<span class="cm">	 * is TRIG_TIMER, and scan_begin_arg specifies the time between</span>
<span class="cm">	 * each scan, so we program the pacer clock to this frequency</span>
<span class="cm">	 * and only set the SCANLIST_START bit on the first entry.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">counter</span> <span class="o">=</span> <span class="n">daqp_ns_to_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
					       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">counter</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_PACER_LOW</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_PACER_MID</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_PACER_HIGH</span><span class="p">);</span>
		<span class="n">scanlist_start_on_every_entry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">counter</span> <span class="o">=</span> <span class="n">daqp_ns_to_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
					       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">counter</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_PACER_LOW</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_PACER_MID</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_PACER_HIGH</span><span class="p">);</span>
		<span class="n">scanlist_start_on_every_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Program scan list */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">chanspec</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* Program one scan list entry */</span>

		<span class="n">v</span> <span class="o">=</span> <span class="n">DAQP_SCANLIST_CHANNEL</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
		    <span class="o">|</span> <span class="n">DAQP_SCANLIST_GAIN</span><span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanspec</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">DAQP_SCANLIST_DIFFERENTIAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">scanlist_start_on_every_entry</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">DAQP_SCANLIST_START</span><span class="p">;</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_SCANLIST</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_SCANLIST</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now it&#39;s time to program the FIFO threshold, basically the</span>
<span class="cm">	 * number of samples the card will buffer before it interrupts</span>
<span class="cm">	 * the CPU.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we don&#39;t have a stop count, then use half the size of</span>
<span class="cm">	 * the FIFO (the manufacturer&#39;s recommendation).  Consider</span>
<span class="cm">	 * that the FIFO can hold 2K samples (4K bytes).  With the</span>
<span class="cm">	 * threshold set at half the FIFO size, we have a margin of</span>
<span class="cm">	 * error of 1024 samples.  At the chip&#39;s maximum sample rate</span>
<span class="cm">	 * of 100,000 Hz, the CPU would have to delay interrupt</span>
<span class="cm">	 * service for a full 10 milliseconds in order to lose data</span>
<span class="cm">	 * here (as opposed to higher up in the kernel).  I&#39;ve never</span>
<span class="cm">	 * seen it happen.  However, for slow sample rates it may</span>
<span class="cm">	 * buffer too much data and introduce too much delay for the</span>
<span class="cm">	 * user application.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we have a stop count, then things get more interesting.</span>
<span class="cm">	 * If the stop count is less than the FIFO size (actually</span>
<span class="cm">	 * three-quarters of the FIFO size - see below), we just use</span>
<span class="cm">	 * the stop count itself as the threshold, the card interrupts</span>
<span class="cm">	 * us when that many samples have been taken, and we kill the</span>
<span class="cm">	 * acquisition at that point and are done.  If the stop count</span>
<span class="cm">	 * is larger than that, then we divide it by 2 until it&#39;s less</span>
<span class="cm">	 * than three quarters of the FIFO size (we always leave the</span>
<span class="cm">	 * top quarter of the FIFO as protection against sluggish CPU</span>
<span class="cm">	 * interrupt response) and use that as the threshold.  So, if</span>
<span class="cm">	 * the stop count is 4000 samples, we divide by two twice to</span>
<span class="cm">	 * get 1000 samples, use that as the threshold, take four</span>
<span class="cm">	 * interrupts to get our 4000 samples and are done.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The algorithm could be more clever.  For example, if 81000</span>
<span class="cm">	 * samples are requested, we could set the threshold to 1500</span>
<span class="cm">	 * samples and take 54 interrupts to get 81000.  But 54 isn&#39;t</span>
<span class="cm">	 * a power of two, so this algorithm won&#39;t find that option.</span>
<span class="cm">	 * Instead, it&#39;ll set the threshold at 1266 and take 64</span>
<span class="cm">	 * interrupts to get 81024 samples, of which the last 24 will</span>
<span class="cm">	 * be discarded... but we won&#39;t get the last interrupt until</span>
<span class="cm">	 * they&#39;ve been collected.  To find the first option, the</span>
<span class="cm">	 * computer could look at the prime decomposition of the</span>
<span class="cm">	 * sample count (81000 = 3^4 * 5^3 * 2^3) and factor it into a</span>
<span class="cm">	 * threshold (1500 = 3 * 5^3 * 2^2) and an interrupt count (54</span>
<span class="cm">	 * = 3^3 * 2).  Hmmm... a one-line while loop or prime</span>
<span class="cm">	 * decomposition of integers... I&#39;ll leave it the way it is.</span>
<span class="cm">	 *</span>
<span class="cm">	 * I&#39;ll also note a mini-race condition before ignoring it in</span>
<span class="cm">	 * the code.  Let&#39;s say we&#39;re taking 4000 samples, as before.</span>
<span class="cm">	 * After 1000 samples, we get an interrupt.  But before that</span>
<span class="cm">	 * interrupt is completely serviced, another sample is taken</span>
<span class="cm">	 * and loaded into the FIFO.  Since the interrupt handler</span>
<span class="cm">	 * empties the FIFO before returning, it will read 1001 samples.</span>
<span class="cm">	 * If that happens four times, we&#39;ll end up taking 4004 samples,</span>
<span class="cm">	 * not 4000.  The interrupt handler will discard the extra four</span>
<span class="cm">	 * samples (by halting the acquisition with four samples still</span>
<span class="cm">	 * in the FIFO), but we will have to wait for them.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In short, this code works pretty well, but for either of</span>
<span class="cm">	 * the two reasons noted, might end up waiting for a few more</span>
<span class="cm">	 * samples than actually requested.  Shouldn&#39;t make too much</span>
<span class="cm">	 * of a difference.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Save away the number of conversions we should perform, and</span>
<span class="cm">	 * compute the FIFO threshold (in bytes, not samples - that&#39;s</span>
<span class="cm">	 * why we multiple local-&gt;count by 2 = sizeof(sample))</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">;</span>
		<span class="n">threshold</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">threshold</span> <span class="o">&gt;</span> <span class="n">DAQP_FIFO_SIZE</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">threshold</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">threshold</span> <span class="o">=</span> <span class="n">DAQP_FIFO_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset data FIFO (see page 28 of DAQP User&#39;s Manual) */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">DAQP_COMMAND_RSTF</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_COMMAND</span><span class="p">);</span>

	<span class="cm">/* Set FIFO threshold.  First two bytes are near-empty</span>
<span class="cm">	 * threshold, which is unused; next two bytes are near-full</span>
<span class="cm">	 * threshold.  We computed the number of bytes we want in the</span>
<span class="cm">	 * FIFO when the interrupt is generated, what the card wants</span>
<span class="cm">	 * is actually the number of available bytes left in the FIFO</span>
<span class="cm">	 * when the interrupt is to happen.</span>
<span class="cm">	 */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_FIFO</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_FIFO</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">DAQP_FIFO_SIZE</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_FIFO</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">DAQP_FIFO_SIZE</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_FIFO</span><span class="p">);</span>

	<span class="cm">/* Set trigger */</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">DAQP_CONTROL_TRIGGER_CONTINUOUS</span> <span class="o">|</span> <span class="n">DAQP_CONTROL_TRIGGER_INTERNAL</span>
	    <span class="o">|</span> <span class="n">DAQP_CONTROL_PACER_5MHz</span> <span class="o">|</span> <span class="n">DAQP_CONTROL_FIFO_INT_ENABLE</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_CONTROL</span><span class="p">);</span>

	<span class="cm">/* Reset any pending interrupts (my card has a tendency to require</span>
<span class="cm">	 * require multiple reads on the status register to achieve this)</span>
<span class="cm">	 */</span>
	<span class="n">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">counter</span>
	       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DAQP_STATUS_EVENTS</span><span class="p">))</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;daqp: couldn&#39;t clear interrupts in status register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">interrupt_mode</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="cm">/* Start conversion */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">DAQP_COMMAND_ARM</span> <span class="o">|</span> <span class="n">DAQP_COMMAND_FIFO_DATA</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_COMMAND</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Single-shot analog output routine */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_ao_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">d</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">^=</span> <span class="mh">0x0800</span><span class="p">;</span>		<span class="cm">/* Flip the sign */</span>
	<span class="n">d</span> <span class="o">|=</span> <span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="cm">/* Make sure D/A update mode is direct update */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_AUX</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_DA</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Digital input routine */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_di_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_DIGITAL_IO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Digital output routine */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_do_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAQP_DIGITAL_IO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* daqp_attach is called via comedi_config to attach a comedi device</span>
<span class="cm"> * to a /dev/comedi*.  Note that this is different from daqp_cs_attach()</span>
<span class="cm"> * which is called by the pcmcia subsystem to attach the PCMCIA card</span>
<span class="cm"> * when it is inserted.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev_table</span><span class="p">[</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MAX_DEV</span> <span class="o">||</span> <span class="o">!</span><span class="n">local</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;comedi%d: No such daqp device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Typically brittle code that I don&#39;t completely understand,</span>
<span class="cm">	 * but &quot;it works on my card&quot;.  The intent is to pull the model</span>
<span class="cm">	 * number of the card out the PCMCIA CIS and stash it away as</span>
<span class="cm">	 * the COMEDI board_name.  Looks like the third field in</span>
<span class="cm">	 * CISTPL_VERS_1 (offset 2) holds what we&#39;re looking for.  If</span>
<span class="cm">	 * it doesn&#39;t work, who cares, just leave it as &quot;DAQP&quot;.</span>
<span class="cm">	 */</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="s">&quot;DAQP&quot;</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;DAQP&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi%d: attaching daqp%d (io 0x%04lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_DIFF</span> <span class="o">|</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_daqp_ai</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">daqp_ai_insn_read</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">daqp_ai_cmdtest</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">daqp_ai_cmd</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">daqp_ai_cancel</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITEABLE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_daqp_ao</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">daqp_ao_insn_write</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DI</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">daqp_di_insn_read</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITEABLE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">daqp_do_insn_write</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqp_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to cleanup */</span>
<span class="p">}</span>

<span class="cm">/*====================================================================</span>

<span class="cm">    PCMCIA interface code</span>

<span class="cm">    The rest of the code in this file is based on dummy_cs.c v1.24</span>
<span class="cm">    from the Linux pcmcia_cs distribution v3.1.8 and is subject</span>
<span class="cm">    to the following license agreement.</span>

<span class="cm">    The remaining contents of this file are subject to the Mozilla Public</span>
<span class="cm">    License Version 1.1 (the &quot;License&quot;); you may not use this file</span>
<span class="cm">    except in compliance with the License. You may obtain a copy of</span>
<span class="cm">    the License at http://www.mozilla.org/MPL/</span>

<span class="cm">    Software distributed under the License is distributed on an &quot;AS</span>
<span class="cm">    IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or</span>
<span class="cm">    implied. See the License for the specific language governing</span>
<span class="cm">    rights and limitations under the License.</span>

<span class="cm">    The initial developer of the original code is David A. Hinds</span>
<span class="cm">    &lt;dhinds@pcmcia.sourceforge.org&gt;.  Portions created by David A. Hinds</span>
<span class="cm">    are Copyright (C) 1999 David A. Hinds.  All Rights Reserved.</span>

<span class="cm">    Alternatively, the contents of this file may be used under the</span>
<span class="cm">    terms of the GNU Public License version 2 (the &quot;GPL&quot;), in which</span>
<span class="cm">    case the provisions of the GPL are applicable instead of the</span>
<span class="cm">    above.  If you wish to allow the use of your version of this file</span>
<span class="cm">    only under the terms of the GPL and not to allow others to use</span>
<span class="cm">    your version of this file under the MPL, indicate your decision</span>
<span class="cm">    by deleting the provisions above and replace them with the notice</span>
<span class="cm">    and other provisions required by the GPL.  If you do not delete</span>
<span class="cm">    the provisions above, a recipient may use your version of this</span>
<span class="cm">    file under either the MPL or the GPL.</span>

<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">daqp_cs_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">daqp_cs_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">daqp_cs_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">daqp_cs_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">daqp_cs_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">daqp_cs_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_cs_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;daqp_cs_attach()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DEV</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;daqp_cs: no devices available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate space for private device-specific data */</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">local_info_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">table_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dev_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>

	<span class="n">daqp_cs_config</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* daqp_cs_attach */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqp_cs_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">daqp_cs_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="cm">/* Unlink device structure, and free it */</span>
	<span class="n">dev_table</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_pcmcia_config_loop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pcmcia_request_io</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqp_cs_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;daqp_cs_config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">link</span><span class="o">-&gt;</span><span class="n">config_flags</span> <span class="o">|=</span> <span class="n">CONF_ENABLE_IRQ</span> <span class="o">|</span> <span class="n">CONF_AUTO_SET_IO</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_loop_config</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">daqp_pcmcia_config_loop</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no configuration found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_irq</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">daqp_interrupt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">daqp_cs_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

<span class="p">}</span>				<span class="cm">/* daqp_cs_config */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqp_cs_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;daqp_cs_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pcmcia_disable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* daqp_cs_release */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_cs_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Mark the device as stopped, to block IO until later */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqp_cs_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*====================================================================*/</span>

<span class="cp">#ifdef MODULE</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="n">daqp_cs_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCMCIA_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mh">0x0137</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_NULL</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">,</span> <span class="n">daqp_cs_id_table</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Brent Baccala &lt;baccala@freesoft.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi driver for Quatech DAQP PCMCIA data capture cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="n">daqp_cs_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">daqp_cs_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">daqp_cs_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">daqp_cs_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">daqp_cs_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">daqp_cs_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;quatech_daqp_cs&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcmcia_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">daqp_cs_driver</span><span class="p">);</span>
	<span class="n">comedi_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_daqp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_daqp</span><span class="p">);</span>
	<span class="n">pcmcia_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">daqp_cs_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
