<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › adl_pci9111.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>adl_pci9111.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">comedi/drivers/adl_pci9111.c</span>

<span class="cm">Hardware driver for PCI9111 ADLink cards:</span>

<span class="cm">PCI-9111HR</span>

<span class="cm">Copyright (C) 2002-2005 Emmanuel Pacaud &lt;emmanuel.pacaud@univ-poitiers.fr&gt;</span>

<span class="cm">This program is free software; you can redistribute it and/or modify</span>
<span class="cm">it under the terms of the GNU General Public License as published by</span>
<span class="cm">the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">(at your option) any later version.</span>

<span class="cm">This program is distributed in the hope that it will be useful,</span>
<span class="cm">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">GNU General Public License for more details.</span>

<span class="cm">You should have received a copy of the GNU General Public License</span>
<span class="cm">along with this program; if not, write to the Free Software</span>
<span class="cm">Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">Driver: adl_pci9111</span>
<span class="cm">Description: Adlink PCI-9111HR</span>
<span class="cm">Author: Emmanuel Pacaud &lt;emmanuel.pacaud@univ-poitiers.fr&gt;</span>
<span class="cm">Devices: [ADLink] PCI-9111HR (adl_pci9111)</span>
<span class="cm">Status: experimental</span>

<span class="cm">Supports:</span>

<span class="cm">	- ai_insn read</span>
<span class="cm">	- ao_insn read/write</span>
<span class="cm">	- di_insn read</span>
<span class="cm">	- do_insn read/write</span>
<span class="cm">	- ai_do_cmd mode with the following sources:</span>

<span class="cm">	- start_src		TRIG_NOW</span>
<span class="cm">	- scan_begin_src	TRIG_FOLLOW	TRIG_TIMER	TRIG_EXT</span>
<span class="cm">	- convert_src				TRIG_TIMER	TRIG_EXT</span>
<span class="cm">	- scan_end_src		TRIG_COUNT</span>
<span class="cm">	- stop_src		TRIG_COUNT	TRIG_NONE</span>

<span class="cm">The scanned channels must be consecutive and start from 0. They must</span>
<span class="cm">all have the same range and aref.</span>

<span class="cm">Configuration options:</span>

<span class="cm">	[0] - PCI bus number (optional)</span>
<span class="cm">	[1] - PCI slot number (optional)</span>

<span class="cm">If bus/slot is not specified, the first available PCI</span>
<span class="cm">device will be used.</span>

<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">CHANGELOG:</span>

<span class="cm">2005/02/17 Extend AI streaming capabilities. Now, scan_begin_arg can be</span>
<span class="cm">a multiple of chanlist_len*convert_arg.</span>
<span class="cm">2002/02/19 Fixed the two&#39;s complement conversion in pci9111_(hr_)ai_get_data.</span>
<span class="cm">2002/02/18 Added external trigger support for analog input.</span>

<span class="cm">TODO:</span>

<span class="cm">	- Really test implemented functionality.</span>
<span class="cm">	- Add support for the PCI-9111DG with a probe routine to identify</span>
<span class="cm">	  the card type (perhaps with the help of the channel number readback</span>
<span class="cm">	  of the A/D Data register).</span>
<span class="cm">	- Add external multiplexer support.</span>

<span class="cm">*/</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;8253.h&quot;</span>
<span class="cp">#include &quot;comedi_pci.h&quot;</span>
<span class="cp">#include &quot;comedi_fc.h&quot;</span>

<span class="cp">#define PCI9111_DRIVER_NAME	&quot;adl_pci9111&quot;</span>
<span class="cp">#define PCI9111_HR_DEVICE_ID	0x9111</span>

<span class="cm">/*  TODO: Add other pci9111 board id */</span>

<span class="cp">#define PCI9111_IO_RANGE	0x0100</span>

<span class="cp">#define PCI9111_FIFO_HALF_SIZE	512</span>

<span class="cp">#define PCI9111_AI_CHANNEL_NBR			16</span>

<span class="cp">#define PCI9111_AI_RESOLUTION			12</span>
<span class="cp">#define PCI9111_AI_RESOLUTION_MASK		0x0FFF</span>
<span class="cp">#define PCI9111_AI_RESOLUTION_2_CMP_BIT		0x0800</span>

<span class="cp">#define PCI9111_HR_AI_RESOLUTION		16</span>
<span class="cp">#define PCI9111_HR_AI_RESOLUTION_MASK		0xFFFF</span>
<span class="cp">#define PCI9111_HR_AI_RESOLUTION_2_CMP_BIT	0x8000</span>

<span class="cp">#define PCI9111_AI_ACQUISITION_PERIOD_MIN_NS	10000</span>
<span class="cp">#define PCI9111_AO_CHANNEL_NBR			1</span>
<span class="cp">#define	PCI9111_AO_RESOLUTION			12</span>
<span class="cp">#define PCI9111_AO_RESOLUTION_MASK		0x0FFF</span>
<span class="cp">#define PCI9111_DI_CHANNEL_NBR			16</span>
<span class="cp">#define	PCI9111_DO_CHANNEL_NBR			16</span>
<span class="cp">#define PCI9111_DO_MASK				0xFFFF</span>

<span class="cp">#define PCI9111_RANGE_SETTING_DELAY		10</span>
<span class="cp">#define PCI9111_AI_INSTANT_READ_UDELAY_US	2</span>
<span class="cp">#define PCI9111_AI_INSTANT_READ_TIMEOUT		100</span>

<span class="cp">#define PCI9111_8254_CLOCK_PERIOD_NS		500</span>

<span class="cp">#define PCI9111_8254_COUNTER_0			0x00</span>
<span class="cp">#define PCI9111_8254_COUNTER_1			0x40</span>
<span class="cp">#define PCI9111_8254_COUNTER_2			0x80</span>
<span class="cp">#define PCI9111_8254_COUNTER_LATCH		0x00</span>
<span class="cp">#define PCI9111_8254_READ_LOAD_LSB_ONLY		0x10</span>
<span class="cp">#define PCI9111_8254_READ_LOAD_MSB_ONLY		0x20</span>
<span class="cp">#define PCI9111_8254_READ_LOAD_LSB_MSB		0x30</span>
<span class="cp">#define PCI9111_8254_MODE_0			0x00</span>
<span class="cp">#define PCI9111_8254_MODE_1			0x02</span>
<span class="cp">#define PCI9111_8254_MODE_2			0x04</span>
<span class="cp">#define PCI9111_8254_MODE_3			0x06</span>
<span class="cp">#define PCI9111_8254_MODE_4			0x08</span>
<span class="cp">#define PCI9111_8254_MODE_5			0x0A</span>
<span class="cp">#define PCI9111_8254_BINARY_COUNTER		0x00</span>
<span class="cp">#define PCI9111_8254_BCD_COUNTER		0x01</span>

<span class="cm">/* IO address map */</span>

<span class="cp">#define PCI9111_REGISTER_AD_FIFO_VALUE			0x00 </span><span class="cm">/* AD Data stored</span>
<span class="cm">								in FIFO */</span><span class="cp"></span>
<span class="cp">#define PCI9111_REGISTER_DA_OUTPUT			0x00</span>
<span class="cp">#define PCI9111_REGISTER_DIGITAL_IO			0x02</span>
<span class="cp">#define PCI9111_REGISTER_EXTENDED_IO_PORTS		0x04</span>
<span class="cp">#define PCI9111_REGISTER_AD_CHANNEL_CONTROL		0x06 </span><span class="cm">/* Channel</span>
<span class="cm">								selection */</span><span class="cp"></span>
<span class="cp">#define PCI9111_REGISTER_AD_CHANNEL_READBACK		0x06</span>
<span class="cp">#define PCI9111_REGISTER_INPUT_SIGNAL_RANGE		0x08</span>
<span class="cp">#define PCI9111_REGISTER_RANGE_STATUS_READBACK		0x08</span>
<span class="cp">#define PCI9111_REGISTER_TRIGGER_MODE_CONTROL		0x0A</span>
<span class="cp">#define PCI9111_REGISTER_AD_MODE_INTERRUPT_READBACK	0x0A</span>
<span class="cp">#define PCI9111_REGISTER_SOFTWARE_TRIGGER		0x0E</span>
<span class="cp">#define PCI9111_REGISTER_INTERRUPT_CONTROL		0x0C</span>
<span class="cp">#define PCI9111_REGISTER_8254_COUNTER_0			0x40</span>
<span class="cp">#define PCI9111_REGISTER_8254_COUNTER_1			0x42</span>
<span class="cp">#define PCI9111_REGISTER_8254_COUNTER_2			0X44</span>
<span class="cp">#define PCI9111_REGISTER_8254_CONTROL			0x46</span>
<span class="cp">#define PCI9111_REGISTER_INTERRUPT_CLEAR		0x48</span>

<span class="cp">#define PCI9111_TRIGGER_MASK				0x0F</span>
<span class="cp">#define PCI9111_PTRG_OFF				(0 &lt;&lt; 3)</span>
<span class="cp">#define PCI9111_PTRG_ON					(1 &lt;&lt; 3)</span>
<span class="cp">#define PCI9111_EITS_EXTERNAL				(1 &lt;&lt; 2)</span>
<span class="cp">#define PCI9111_EITS_INTERNAL				(0 &lt;&lt; 2)</span>
<span class="cp">#define PCI9111_TPST_SOFTWARE_TRIGGER			(0 &lt;&lt; 1)</span>
<span class="cp">#define PCI9111_TPST_TIMER_PACER			(1 &lt;&lt; 1)</span>
<span class="cp">#define PCI9111_ASCAN_ON				(1 &lt;&lt; 0)</span>
<span class="cp">#define PCI9111_ASCAN_OFF				(0 &lt;&lt; 0)</span>

<span class="cp">#define PCI9111_ISC0_SET_IRQ_ON_ENDING_OF_AD_CONVERSION (0 &lt;&lt; 0)</span>
<span class="cp">#define PCI9111_ISC0_SET_IRQ_ON_FIFO_HALF_FULL		(1 &lt;&lt; 0)</span>
<span class="cp">#define PCI9111_ISC1_SET_IRQ_ON_TIMER_TICK		(0 &lt;&lt; 1)</span>
<span class="cp">#define PCI9111_ISC1_SET_IRQ_ON_EXT_TRG			(1 &lt;&lt; 1)</span>
<span class="cp">#define PCI9111_FFEN_SET_FIFO_ENABLE			(0 &lt;&lt; 2)</span>
<span class="cp">#define PCI9111_FFEN_SET_FIFO_DISABLE			(1 &lt;&lt; 2)</span>

<span class="cp">#define PCI9111_CHANNEL_MASK				0x0F</span>

<span class="cp">#define PCI9111_RANGE_MASK				0x07</span>
<span class="cp">#define PCI9111_FIFO_EMPTY_MASK				0x10</span>
<span class="cp">#define PCI9111_FIFO_HALF_FULL_MASK			0x20</span>
<span class="cp">#define PCI9111_FIFO_FULL_MASK				0x40</span>
<span class="cp">#define PCI9111_AD_BUSY_MASK				0x80</span>

<span class="cp">#define PCI9111_IO_BASE (dev-&gt;iobase)</span>

<span class="cm">/*</span>
<span class="cm"> * Define inlined function</span>
<span class="cm"> */</span>

<span class="cp">#define pci9111_trigger_and_autoscan_get() \</span>
<span class="cp">	(inb(PCI9111_IO_BASE+PCI9111_REGISTER_AD_MODE_INTERRUPT_READBACK)&amp;0x0F)</span>

<span class="cp">#define pci9111_trigger_and_autoscan_set(flags) \</span>
<span class="cp">	outb(flags, PCI9111_IO_BASE+PCI9111_REGISTER_TRIGGER_MODE_CONTROL)</span>

<span class="cp">#define pci9111_interrupt_and_fifo_get() \</span>
<span class="cp">	((inb(PCI9111_IO_BASE+PCI9111_REGISTER_AD_MODE_INTERRUPT_READBACK) \</span>
<span class="cp">		&gt;&gt; 4) &amp; 0x03)</span>

<span class="cp">#define pci9111_interrupt_and_fifo_set(flags) \</span>
<span class="cp">	outb(flags, PCI9111_IO_BASE+PCI9111_REGISTER_INTERRUPT_CONTROL)</span>

<span class="cp">#define pci9111_interrupt_clear() \</span>
<span class="cp">	outb(0, PCI9111_IO_BASE+PCI9111_REGISTER_INTERRUPT_CLEAR)</span>

<span class="cp">#define pci9111_software_trigger() \</span>
<span class="cp">	outb(0, PCI9111_IO_BASE+PCI9111_REGISTER_SOFTWARE_TRIGGER)</span>

<span class="cp">#define pci9111_fifo_reset() do { \</span>
<span class="cp">	outb(PCI9111_FFEN_SET_FIFO_ENABLE, \</span>
<span class="cp">		PCI9111_IO_BASE+PCI9111_REGISTER_INTERRUPT_CONTROL); \</span>
<span class="cp">	outb(PCI9111_FFEN_SET_FIFO_DISABLE, \</span>
<span class="cp">		PCI9111_IO_BASE+PCI9111_REGISTER_INTERRUPT_CONTROL); \</span>
<span class="cp">	outb(PCI9111_FFEN_SET_FIFO_ENABLE, \</span>
<span class="cp">		PCI9111_IO_BASE+PCI9111_REGISTER_INTERRUPT_CONTROL); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define pci9111_is_fifo_full() \</span>
<span class="cp">	((inb(PCI9111_IO_BASE+PCI9111_REGISTER_RANGE_STATUS_READBACK)&amp; \</span>
<span class="cp">		PCI9111_FIFO_FULL_MASK) == 0)</span>

<span class="cp">#define pci9111_is_fifo_half_full() \</span>
<span class="cp">	((inb(PCI9111_IO_BASE+PCI9111_REGISTER_RANGE_STATUS_READBACK)&amp; \</span>
<span class="cp">		PCI9111_FIFO_HALF_FULL_MASK) == 0)</span>

<span class="cp">#define pci9111_is_fifo_empty() \</span>
<span class="cp">	((inb(PCI9111_IO_BASE+PCI9111_REGISTER_RANGE_STATUS_READBACK)&amp; \</span>
<span class="cp">		PCI9111_FIFO_EMPTY_MASK) == 0)</span>

<span class="cp">#define pci9111_ai_channel_set(channel) \</span>
<span class="cp">	outb((channel)&amp;PCI9111_CHANNEL_MASK, \</span>
<span class="cp">		PCI9111_IO_BASE+PCI9111_REGISTER_AD_CHANNEL_CONTROL)</span>

<span class="cp">#define pci9111_ai_channel_get() \</span>
<span class="cp">	(inb(PCI9111_IO_BASE+PCI9111_REGISTER_AD_CHANNEL_READBACK) \</span>
<span class="cp">		&amp;PCI9111_CHANNEL_MASK)</span>

<span class="cp">#define pci9111_ai_range_set(range) \</span>
<span class="cp">	outb((range)&amp;PCI9111_RANGE_MASK, \</span>
<span class="cp">		PCI9111_IO_BASE+PCI9111_REGISTER_INPUT_SIGNAL_RANGE)</span>

<span class="cp">#define pci9111_ai_range_get() \</span>
<span class="cp">	(inb(PCI9111_IO_BASE+PCI9111_REGISTER_RANGE_STATUS_READBACK) \</span>
<span class="cp">		&amp;PCI9111_RANGE_MASK)</span>

<span class="cp">#define pci9111_ai_get_data() \</span>
<span class="cp">	(((inw(PCI9111_IO_BASE+PCI9111_REGISTER_AD_FIFO_VALUE)&gt;&gt;4) \</span>
<span class="cp">		&amp;PCI9111_AI_RESOLUTION_MASK) \</span>
<span class="cp">			^ PCI9111_AI_RESOLUTION_2_CMP_BIT)</span>

<span class="cp">#define pci9111_hr_ai_get_data() \</span>
<span class="cp">	((inw(PCI9111_IO_BASE+PCI9111_REGISTER_AD_FIFO_VALUE) \</span>
<span class="cp">		&amp;PCI9111_HR_AI_RESOLUTION_MASK) \</span>
<span class="cp">			^ PCI9111_HR_AI_RESOLUTION_2_CMP_BIT)</span>

<span class="cp">#define pci9111_ao_set_data(data) \</span>
<span class="cp">	outw(data&amp;PCI9111_AO_RESOLUTION_MASK, \</span>
<span class="cp">		PCI9111_IO_BASE+PCI9111_REGISTER_DA_OUTPUT)</span>

<span class="cp">#define pci9111_di_get_bits() \</span>
<span class="cp">	inw(PCI9111_IO_BASE+PCI9111_REGISTER_DIGITAL_IO)</span>

<span class="cp">#define pci9111_do_set_bits(bits) \</span>
<span class="cp">	outw(bits, PCI9111_IO_BASE+PCI9111_REGISTER_DIGITAL_IO)</span>

<span class="cp">#define pci9111_8254_control_set(flags) \</span>
<span class="cp">	outb(flags, PCI9111_IO_BASE+PCI9111_REGISTER_8254_CONTROL)</span>

<span class="cp">#define pci9111_8254_counter_0_set(data) \</span>
<span class="cp">	do { \</span>
<span class="cp">		outb(data &amp; 0xFF, \</span>
<span class="cp">			PCI9111_IO_BASE+PCI9111_REGISTER_8254_COUNTER_0); \</span>
<span class="cp">		outb((data &gt;&gt; 8) &amp; 0xFF, \</span>
<span class="cp">			PCI9111_IO_BASE+PCI9111_REGISTER_8254_COUNTER_0); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define pci9111_8254_counter_1_set(data) \</span>
<span class="cp">	do { \</span>
<span class="cp">		outb(data &amp; 0xFF, \</span>
<span class="cp">			PCI9111_IO_BASE+PCI9111_REGISTER_8254_COUNTER_1); \</span>
<span class="cp">		outb((data &gt;&gt; 8) &amp; 0xFF, \</span>
<span class="cp">			PCI9111_IO_BASE+PCI9111_REGISTER_8254_COUNTER_1); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define pci9111_8254_counter_2_set(data) \</span>
<span class="cp">	do { \</span>
<span class="cp">		outb(data &amp; 0xFF, \</span>
<span class="cp">			PCI9111_IO_BASE+PCI9111_REGISTER_8254_COUNTER_2); \</span>
<span class="cp">		outb((data &gt;&gt; 8) &amp; 0xFF, \</span>
<span class="cp">			PCI9111_IO_BASE+PCI9111_REGISTER_8254_COUNTER_2); \</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">pci9111_hr_ai_range</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">5</span><span class="p">,</span>
	<span class="p">{</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">)</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*  */</span>
<span class="cm">/*  Board specification structure */</span>
<span class="cm">/*  */</span>

<span class="k">struct</span> <span class="n">pci9111_board</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>	<span class="cm">/*  driver name */</span>
	<span class="kt">int</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ai_channel_nbr</span><span class="p">;</span>	<span class="cm">/*  num of A/D chans */</span>
	<span class="kt">int</span> <span class="n">ao_channel_nbr</span><span class="p">;</span>	<span class="cm">/*  num of D/A chans */</span>
	<span class="kt">int</span> <span class="n">ai_resolution</span><span class="p">;</span>	<span class="cm">/*  resolution of A/D */</span>
	<span class="kt">int</span> <span class="n">ai_resolution_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ao_resolution</span><span class="p">;</span>	<span class="cm">/*  resolution of D/A */</span>
	<span class="kt">int</span> <span class="n">ao_resolution_mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">ai_range_list</span><span class="p">;</span>	<span class="cm">/*  rangelist for A/D */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">ao_range_list</span><span class="p">;</span>	<span class="cm">/*  rangelist for D/A */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_acquisition_period_min_ns</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci9111_board</span> <span class="n">pci9111_boards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci9111_hr&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">PCI9111_HR_DEVICE_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_channel_nbr</span> <span class="o">=</span> <span class="n">PCI9111_AI_CHANNEL_NBR</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_channel_nbr</span> <span class="o">=</span> <span class="n">PCI9111_AO_CHANNEL_NBR</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_resolution</span> <span class="o">=</span> <span class="n">PCI9111_HR_AI_RESOLUTION</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_resolution_mask</span> <span class="o">=</span> <span class="n">PCI9111_HR_AI_RESOLUTION_MASK</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_resolution</span> <span class="o">=</span> <span class="n">PCI9111_AO_RESOLUTION</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_resolution_mask</span> <span class="o">=</span> <span class="n">PCI9111_AO_RESOLUTION_MASK</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_range_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci9111_hr_ai_range</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_range_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar10</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_acquisition_period_min_ns</span> <span class="o">=</span> <span class="n">PCI9111_AI_ACQUISITION_PERIOD_MIN_NS</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define pci9111_board_nbr \</span>
<span class="cp">	(sizeof(pci9111_boards)/sizeof(struct pci9111_board))</span>

<span class="cm">/*  Private data structure */</span>

<span class="k">struct</span> <span class="n">pci9111_private_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_range</span><span class="p">;</span>	<span class="cm">/*  PCI6503 io range */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lcr_io_base</span><span class="p">;</span> <span class="cm">/* Local configuration register base</span>
<span class="cm">				    * address */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lcr_io_range</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">stop_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stop_is_none</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scan_delay</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chanlist_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunk_counter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunk_num_samples</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ao_readback</span><span class="p">;</span>	<span class="cm">/*  Last written analog output data */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timer_divisor_1</span><span class="p">;</span> <span class="cm">/* Divisor values for the 8254 timer</span>
<span class="cm">				       * pacer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timer_divisor_2</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">is_valid</span><span class="p">;</span>		<span class="cm">/*  Is device valid */</span>

	<span class="kt">short</span> <span class="n">ai_bounce_buffer</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">PCI9111_FIFO_HALF_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define dev_private	((struct pci9111_private_data *)dev-&gt;private)</span>

<span class="cm">/*  ------------------------------------------------------------------ */</span>
<span class="cm">/*  PLX9050 SECTION */</span>
<span class="cm">/*  ------------------------------------------------------------------ */</span>

<span class="cp">#define PLX9050_REGISTER_INTERRUPT_CONTROL 0x4c</span>

<span class="cp">#define PLX9050_LINTI1_ENABLE		(1 &lt;&lt; 0)</span>
<span class="cp">#define PLX9050_LINTI1_ACTIVE_HIGH	(1 &lt;&lt; 1)</span>
<span class="cp">#define PLX9050_LINTI1_STATUS		(1 &lt;&lt; 2)</span>
<span class="cp">#define PLX9050_LINTI2_ENABLE		(1 &lt;&lt; 3)</span>
<span class="cp">#define PLX9050_LINTI2_ACTIVE_HIGH	(1 &lt;&lt; 4)</span>
<span class="cp">#define PLX9050_LINTI2_STATUS		(1 &lt;&lt; 5)</span>
<span class="cp">#define PLX9050_PCI_INTERRUPT_ENABLE	(1 &lt;&lt; 6)</span>
<span class="cp">#define PLX9050_SOFTWARE_INTERRUPT	(1 &lt;&lt; 7)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">plx9050_interrupt_control</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_base</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">LINTi1_enable</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">LINTi1_active_high</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">LINTi2_enable</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">LINTi2_active_high</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">interrupt_enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">LINTi1_enable</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PLX9050_LINTI1_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LINTi1_active_high</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PLX9050_LINTI1_ACTIVE_HIGH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LINTi2_enable</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PLX9050_LINTI2_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LINTi2_active_high</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PLX9050_LINTI2_ACTIVE_HIGH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_enable</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PLX9050_PCI_INTERRUPT_ENABLE</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">io_base</span> <span class="o">+</span> <span class="n">PLX9050_REGISTER_INTERRUPT_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*  ------------------------------------------------------------------ */</span>
<span class="cm">/*  MISCELLANEOUS SECTION */</span>
<span class="cm">/*  ------------------------------------------------------------------ */</span>

<span class="cm">/*  8254 timer */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9111_timer_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci9111_8254_control_set</span><span class="p">(</span><span class="n">PCI9111_8254_COUNTER_0</span> <span class="o">|</span>
				 <span class="n">PCI9111_8254_READ_LOAD_LSB_MSB</span> <span class="o">|</span>
				 <span class="n">PCI9111_8254_MODE_0</span> <span class="o">|</span>
				 <span class="n">PCI9111_8254_BINARY_COUNTER</span><span class="p">);</span>

	<span class="n">pci9111_8254_control_set</span><span class="p">(</span><span class="n">PCI9111_8254_COUNTER_1</span> <span class="o">|</span>
				 <span class="n">PCI9111_8254_READ_LOAD_LSB_MSB</span> <span class="o">|</span>
				 <span class="n">PCI9111_8254_MODE_2</span> <span class="o">|</span>
				 <span class="n">PCI9111_8254_BINARY_COUNTER</span><span class="p">);</span>

	<span class="n">pci9111_8254_control_set</span><span class="p">(</span><span class="n">PCI9111_8254_COUNTER_2</span> <span class="o">|</span>
				 <span class="n">PCI9111_8254_READ_LOAD_LSB_MSB</span> <span class="o">|</span>
				 <span class="n">PCI9111_8254_MODE_2</span> <span class="o">|</span>
				 <span class="n">PCI9111_8254_BINARY_COUNTER</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">pci9111_8254_counter_2_set</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_2</span><span class="p">);</span>
	<span class="n">pci9111_8254_counter_1_set</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">pci9111_trigger_sources</span> <span class="p">{</span>
	<span class="n">software</span><span class="p">,</span>
	<span class="n">timer_pacer</span><span class="p">,</span>
	<span class="n">external</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9111_trigger_source_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">pci9111_trigger_sources</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">pci9111_trigger_and_autoscan_get</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x09</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">software</span>:
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PCI9111_EITS_INTERNAL</span> <span class="o">|</span> <span class="n">PCI9111_TPST_SOFTWARE_TRIGGER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">timer_pacer</span>:
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PCI9111_EITS_INTERNAL</span> <span class="o">|</span> <span class="n">PCI9111_TPST_TIMER_PACER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">external</span>:
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PCI9111_EITS_EXTERNAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci9111_trigger_and_autoscan_set</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9111_pretrigger_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pretrigger</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">pci9111_trigger_and_autoscan_get</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pretrigger</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PCI9111_PTRG_ON</span><span class="p">;</span>

	<span class="n">pci9111_trigger_and_autoscan_set</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9111_autoscan_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">autoscan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">pci9111_trigger_and_autoscan_get</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">autoscan</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PCI9111_ASCAN_ON</span><span class="p">;</span>

	<span class="n">pci9111_trigger_and_autoscan_set</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">pci9111_ISC0_sources</span> <span class="p">{</span>
	<span class="n">irq_on_eoc</span><span class="p">,</span>
	<span class="n">irq_on_fifo_half_full</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pci9111_ISC1_sources</span> <span class="p">{</span>
	<span class="n">irq_on_timer_tick</span><span class="p">,</span>
	<span class="n">irq_on_external_trigger</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9111_interrupt_source_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">pci9111_ISC0_sources</span> <span class="n">irq_0_source</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">pci9111_ISC1_sources</span> <span class="n">irq_1_source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">pci9111_interrupt_and_fifo_get</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_0_source</span> <span class="o">==</span> <span class="n">irq_on_fifo_half_full</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PCI9111_ISC0_SET_IRQ_ON_FIFO_HALF_FULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_1_source</span> <span class="o">==</span> <span class="n">irq_on_external_trigger</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PCI9111_ISC1_SET_IRQ_ON_EXT_TRG</span><span class="p">;</span>

	<span class="n">pci9111_interrupt_and_fifo_set</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*  ------------------------------------------------------------------ */</span>
<span class="cm">/*  HARDWARE TRIGGERED ANALOG INPUT SECTION */</span>
<span class="cm">/*  ------------------------------------------------------------------ */</span>

<span class="cm">/*  Cancel analog input autoscan */</span>

<span class="cp">#undef AI_DO_CMD_DEBUG</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9111_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  Disable interrupts */</span>

	<span class="n">plx9050_interrupt_control</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">lcr_io_base</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				  <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">pci9111_trigger_source_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">software</span><span class="p">);</span>

	<span class="n">pci9111_autoscan_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">pci9111_fifo_reset</span><span class="p">();</span>

<span class="cp">#ifdef AI_DO_CMD_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: ai_cancel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Test analog input command */</span>

<span class="cp">#define pci9111_check_trigger_src(src, flags)	do {			\</span>
<span class="cp">		tmp = src;						\</span>
<span class="cp">		src &amp;= flags;						\</span>
<span class="cp">		if (!src || tmp != src)					\</span>
<span class="cp">			error++;					\</span>
<span class="cp">	} while (false);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci9111_ai_do_cmd_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">range</span><span class="p">,</span> <span class="n">reference</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci9111_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci9111_board</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span><span class="p">;</span>

	<span class="cm">/*  Step 1 : check if trigger are trivialy valid */</span>

	<span class="n">pci9111_check_trigger_src</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">,</span> <span class="n">TRIG_NOW</span><span class="p">);</span>
	<span class="n">pci9111_check_trigger_src</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">,</span>
				  <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_FOLLOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">);</span>
	<span class="n">pci9111_check_trigger_src</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">,</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">);</span>
	<span class="n">pci9111_check_trigger_src</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">,</span> <span class="n">TRIG_COUNT</span><span class="p">);</span>
	<span class="n">pci9111_check_trigger_src</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">,</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*  step 2 : make sure trigger sources are unique and mutually</span>
<span class="cm">	 *  compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">))</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">))</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)))</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)))</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span><span class="p">))</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*  Step 3 : make sure arguments are trivialy compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_channel_nbr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_channel_nbr</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_acquisition_period_min_ns</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_acquisition_period_min_ns</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_acquisition_period_min_ns</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_acquisition_period_min_ns</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/*  Step 4 : fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
		<span class="n">i8253_cascade_ns_to_timer_2div</span><span class="p">(</span><span class="n">PCI9111_8254_CLOCK_PERIOD_NS</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_1</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_2</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">),</span>
					       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
			<span class="n">error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  There&#39;s only one timer on this card, so the scan_begin timer must */</span>
	<span class="cm">/*  be a multiple of chanlist_len*convert_arg */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scan_begin_min</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scan_factor</span><span class="p">;</span>

		<span class="n">scan_begin_min</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="n">scan_begin_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scan_begin_min</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scan_factor</span> <span class="o">=</span>
				    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">/</span> <span class="n">scan_begin_min</span><span class="p">;</span>
				<span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">scan_factor</span> <span class="o">*</span> <span class="n">scan_begin_min</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="n">scan_begin_arg</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">scan_begin_arg</span><span class="p">;</span>
					<span class="n">error</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">scan_begin_min</span><span class="p">;</span>
				<span class="n">error</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*  Step 5 : check channel list */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">reference</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						     <span class="s">&quot;entries in chanlist must be consecutive &quot;</span>
						     <span class="s">&quot;channels,counting upwards from 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">error</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">range</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						     <span class="s">&quot;entries in chanlist must all have the same gain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">error</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">reference</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						     <span class="s">&quot;entries in chanlist must all have the same reference</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">error</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span>
			     <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_channel_nbr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;channel number is out of limits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">error</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*  Analog input command */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9111_ai_do_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">subdevice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">async_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;no irq assigned for PCI9111, cannot do hardware conversion&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  Set channel scan limit */</span>
	<span class="cm">/*  PCI9111 allows only scanning from channel 0 to channel n */</span>
	<span class="cm">/*  TODO: handle the case of an external multiplexer */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci9111_ai_channel_set</span><span class="p">((</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pci9111_autoscan_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci9111_ai_channel_set</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="n">pci9111_autoscan_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*  Set gain */</span>
	<span class="cm">/*  This is the same gain on every channel */</span>

	<span class="n">pci9111_ai_range_set</span><span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="cm">/* Set counter */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_COUNT</span>:
		<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_counter</span> <span class="o">=</span>
		    <span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">*</span> <span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_is_none</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TRIG_NONE</span>:
		<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_is_none</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid stop trigger&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Set timer pacer */</span>

	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">scan_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
		<span class="n">i8253_cascade_ns_to_timer_2div</span><span class="p">(</span><span class="n">PCI9111_8254_CLOCK_PERIOD_NS</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_1</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_2</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">),</span>
					       <span class="n">async_cmd</span><span class="o">-&gt;</span>
					       <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
<span class="cp">#ifdef AI_DO_CMD_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: divisors = %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_1</span><span class="p">,</span>
		       <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_2</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">pci9111_trigger_source_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">software</span><span class="p">);</span>
		<span class="n">pci9111_timer_set</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci9111_fifo_reset</span><span class="p">();</span>
		<span class="n">pci9111_interrupt_source_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">irq_on_fifo_half_full</span><span class="p">,</span>
					     <span class="n">irq_on_timer_tick</span><span class="p">);</span>
		<span class="n">pci9111_trigger_source_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">timer_pacer</span><span class="p">);</span>
		<span class="n">plx9050_interrupt_control</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">lcr_io_base</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
					  <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">scan_delay</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">/</span>
				 <span class="p">(</span><span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span>
				  <span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TRIG_EXT</span>:

		<span class="n">pci9111_trigger_source_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">external</span><span class="p">);</span>
		<span class="n">pci9111_fifo_reset</span><span class="p">();</span>
		<span class="n">pci9111_interrupt_source_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">irq_on_fifo_half_full</span><span class="p">,</span>
					     <span class="n">irq_on_timer_tick</span><span class="p">);</span>
		<span class="n">plx9050_interrupt_control</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">lcr_io_base</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
					  <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid convert trigger&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_counter</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">scan_delay</span><span class="p">);</span>
	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="n">async_cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_num_samples</span> <span class="o">=</span>
	    <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">scan_delay</span><span class="p">);</span>

<span class="cp">#ifdef AI_DO_CMD_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: start interruptions!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: trigger source = %2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci9111_trigger_and_autoscan_get</span><span class="p">());</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: irq source     = %2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci9111_interrupt_and_fifo_get</span><span class="p">());</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: ai_do_cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: stop counter   = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_counter</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: scan delay     = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">scan_delay</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: chanlist_len   = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: chunk num samples = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_num_samples</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9111_ai_munge</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_chan_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resolution</span> <span class="o">=</span>
	    <span class="p">((</span><span class="k">struct</span> <span class="n">pci9111_board</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_resolution</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">==</span> <span class="n">PCI9111_HR_AI_RESOLUTION</span><span class="p">)</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI9111_HR_AI_RESOLUTION_MASK</span><span class="p">)</span> <span class="o">^</span>
			    <span class="n">PCI9111_HR_AI_RESOLUTION_2_CMP_BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCI9111_AI_RESOLUTION_MASK</span><span class="p">)</span> <span class="o">^</span>
			    <span class="n">PCI9111_AI_RESOLUTION_2_CMP_BIT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*  ------------------------------------------------------------------ */</span>
<span class="cm">/*  INTERRUPT SECTION */</span>
<span class="cm">/*  ------------------------------------------------------------------ */</span>

<span class="cp">#undef INTERRUPT_DEBUG</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pci9111_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">p_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">intcsr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Ignore interrupt before device fully attached. */</span>
		<span class="cm">/*  Might not even have allocated subdevices yet! */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">async</span> <span class="o">=</span> <span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="cm">/*  Check if we are source of interrupt */</span>
	<span class="n">intcsr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">lcr_io_base</span> <span class="o">+</span>
		     <span class="n">PLX9050_REGISTER_INTERRUPT_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">intcsr</span> <span class="o">&amp;</span> <span class="n">PLX9050_PCI_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	      <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">intcsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PLX9050_LINTI1_ENABLE</span> <span class="o">|</span> <span class="n">PLX9050_LINTI1_STATUS</span><span class="p">))</span>
		   <span class="o">==</span> <span class="p">(</span><span class="n">PLX9050_LINTI1_ENABLE</span> <span class="o">|</span> <span class="n">PLX9050_LINTI1_STATUS</span><span class="p">))</span>
		  <span class="o">||</span> <span class="p">((</span><span class="n">intcsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PLX9050_LINTI2_ENABLE</span> <span class="o">|</span> <span class="n">PLX9050_LINTI2_STATUS</span><span class="p">))</span>
		      <span class="o">==</span> <span class="p">(</span><span class="n">PLX9050_LINTI2_ENABLE</span> <span class="o">|</span> <span class="n">PLX9050_LINTI2_STATUS</span><span class="p">)))))</span> <span class="p">{</span>
		<span class="cm">/*  Not the source of the interrupt. */</span>
		<span class="cm">/*  (N.B. not using PLX9050_SOFTWARE_INTERRUPT) */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">intcsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PLX9050_LINTI1_ENABLE</span> <span class="o">|</span> <span class="n">PLX9050_LINTI1_STATUS</span><span class="p">))</span> <span class="o">==</span>
	    <span class="p">(</span><span class="n">PLX9050_LINTI1_ENABLE</span> <span class="o">|</span> <span class="n">PLX9050_LINTI1_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  Interrupt comes from fifo_half-full signal */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci9111_is_fifo_full</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot; fifo overflow&quot;</span><span class="p">);</span>
			<span class="n">pci9111_interrupt_clear</span><span class="p">();</span>
			<span class="n">pci9111_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">subdevice</span><span class="p">);</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
			<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">subdevice</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci9111_is_fifo_half_full</span><span class="p">())</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_samples</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef INTERRUPT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: fifo is half full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="n">num_samples</span> <span class="o">=</span>
			    <span class="n">PCI9111_FIFO_HALF_SIZE</span> <span class="o">&gt;</span>
			    <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_counter</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev_private</span><span class="o">-&gt;</span>
			    <span class="n">stop_is_none</span> <span class="o">?</span> <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_counter</span> <span class="o">:</span>
			    <span class="n">PCI9111_FIFO_HALF_SIZE</span><span class="p">;</span>
			<span class="n">insw</span><span class="p">(</span><span class="n">PCI9111_IO_BASE</span> <span class="o">+</span> <span class="n">PCI9111_REGISTER_AD_FIFO_VALUE</span><span class="p">,</span>
			     <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">ai_bounce_buffer</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">scan_delay</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bytes_written</span> <span class="o">=</span>
				    <span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">subdevice</span><span class="p">,</span>
							      <span class="n">dev_private</span><span class="o">-&gt;</span>
							      <span class="n">ai_bounce_buffer</span><span class="p">,</span>
							      <span class="n">num_samples</span> <span class="o">*</span>
							      <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">to_read</span><span class="p">;</span>

				<span class="k">while</span> <span class="p">(</span><span class="n">position</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_counter</span> <span class="o">&lt;</span>
					    <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">to_read</span> <span class="o">=</span>
						    <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">-</span>
						    <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_counter</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">to_read</span> <span class="o">&gt;</span>
						    <span class="n">num_samples</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span>
							<span class="n">to_read</span> <span class="o">=</span>
							    <span class="n">num_samples</span> <span class="o">-</span>
							    <span class="n">position</span><span class="p">;</span>

						<span class="n">bytes_written</span> <span class="o">+=</span>
						    <span class="n">cfc_write_array_to_buffer</span>
						    <span class="p">(</span><span class="n">subdevice</span><span class="p">,</span>
						     <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">ai_bounce_buffer</span>
						     <span class="o">+</span> <span class="n">position</span><span class="p">,</span>
						     <span class="n">to_read</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">));</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">to_read</span> <span class="o">=</span>
						    <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_num_samples</span>
						    <span class="o">-</span>
						    <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_counter</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">to_read</span> <span class="o">&gt;</span>
						    <span class="n">num_samples</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span>
							<span class="n">to_read</span> <span class="o">=</span>
							    <span class="n">num_samples</span> <span class="o">-</span>
							    <span class="n">position</span><span class="p">;</span>

						<span class="n">bytes_written</span> <span class="o">+=</span>
						    <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="o">*</span> <span class="n">to_read</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">position</span> <span class="o">+=</span> <span class="n">to_read</span><span class="p">;</span>
					<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_counter</span> <span class="o">+=</span> <span class="n">to_read</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_counter</span> <span class="o">&gt;=</span>
					    <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_num_samples</span><span class="p">)</span>
						<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">chunk_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_counter</span> <span class="o">-=</span>
			    <span class="n">bytes_written</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">stop_is_none</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">pci9111_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">subdevice</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Very important, otherwise another interrupt request will be inserted</span>
<span class="cm">	 * and will cause driver hangs on processing interrupt event. */</span>

	<span class="n">pci9111_interrupt_clear</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">subdevice</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  ------------------------------------------------------------------ */</span>
<span class="cm">/*  INSTANT ANALOG INPUT OUTPUT SECTION */</span>
<span class="cm">/*  ------------------------------------------------------------------ */</span>

<span class="cm">/*  analog instant input */</span>

<span class="cp">#undef AI_INSN_DEBUG</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9111_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">subdevice</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">resolution</span> <span class="o">=</span>
	    <span class="p">((</span><span class="k">struct</span> <span class="n">pci9111_board</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ai_resolution</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef AI_INSN_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: ai_insn set c/r/n = %2x/%2x/%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">CR_CHAN</span><span class="p">((</span><span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
	       <span class="n">CR_RANGE</span><span class="p">((</span><span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">pci9111_ai_channel_set</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">((</span><span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pci9111_ai_range_get</span><span class="p">())</span> <span class="o">!=</span> <span class="n">CR_RANGE</span><span class="p">((</span><span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="n">pci9111_ai_range_set</span><span class="p">(</span><span class="n">CR_RANGE</span><span class="p">((</span><span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="n">pci9111_fifo_reset</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci9111_software_trigger</span><span class="p">();</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">PCI9111_AI_INSTANT_READ_TIMEOUT</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci9111_is_fifo_empty</span><span class="p">())</span>
				<span class="k">goto</span> <span class="n">conversion_done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D read timeout&quot;</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pci9111_fifo_reset</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

<span class="nl">conversion_done:</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">==</span> <span class="n">PCI9111_HR_AI_RESOLUTION</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci9111_hr_ai_get_data</span><span class="p">();</span>
		<span class="k">else</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci9111_ai_get_data</span><span class="p">();</span>
	<span class="p">}</span>

<span class="cp">#ifdef AI_INSN_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot;: ai_insn get c/r/t = %2x/%2x/%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci9111_ai_channel_get</span><span class="p">(),</span>
	       <span class="n">pci9111_ai_range_get</span><span class="p">(),</span> <span class="n">pci9111_trigger_and_autoscan_get</span><span class="p">());</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Analog instant output */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci9111_ao_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci9111_ao_set_data</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">ao_readback</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Analog output readback */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9111_ao_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">ao_readback</span> <span class="o">&amp;</span> <span class="n">PCI9111_AO_RESOLUTION_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  ------------------------------------------------------------------ */</span>
<span class="cm">/*  DIGITAL INPUT OUTPUT SECTION */</span>
<span class="cm">/*  ------------------------------------------------------------------ */</span>

<span class="cm">/*  Digital inputs */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9111_di_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">subdevice</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">pci9111_di_get_bits</span><span class="p">();</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Digital outputs */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9111_do_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">subdevice</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="cm">/*  Only set bits that have been masked */</span>
	<span class="cm">/*  data[0] = mask */</span>
	<span class="cm">/*  data[1] = bit state */</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">PCI9111_DO_MASK</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">pci9111_do_set_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  ------------------------------------------------------------------ */</span>
<span class="cm">/*  INITIALISATION SECTION */</span>
<span class="cm">/*  ------------------------------------------------------------------ */</span>

<span class="cm">/*  Reset device */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9111_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  Set trigger source to software */</span>

	<span class="n">plx9050_interrupt_control</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">lcr_io_base</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				  <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">pci9111_trigger_source_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">software</span><span class="p">);</span>
	<span class="n">pci9111_pretrigger_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">pci9111_autoscan_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/*  Reset 8254 chip */</span>

	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">timer_divisor_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci9111_timer_set</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Attach */</span>
<span class="cm">/*       - Register PCI device */</span>
<span class="cm">/*       - Declare device driver capability */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9111_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">subdevice</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_base</span><span class="p">,</span> <span class="n">io_range</span><span class="p">,</span> <span class="n">lcr_io_base</span><span class="p">,</span> <span class="n">lcr_io_range</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci9111_board</span> <span class="o">*</span><span class="n">board</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci9111_private_data</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="cm">/*  Probe the device to determine what device in the series it is. */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: &quot;</span> <span class="n">PCI9111_DRIVER_NAME</span> <span class="s">&quot; driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">pci_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_ADLINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pci9111_board_nbr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pci9111_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_id</span> <span class="o">==</span>
				    <span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* was a particular bus/slot</span>
<span class="cm">					 * requested? */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					    <span class="o">||</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* are we on the wrong</span>
<span class="cm">						 * bus/slot? */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span>
						    <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
						    <span class="o">||</span>
						    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span>
						    <span class="o">!=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">=</span> <span class="n">pci9111_boards</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">board</span> <span class="o">=</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">pci9111_board</span> <span class="o">*</span><span class="p">)</span>
					    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span><span class="p">;</span>
					<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">pci_device</span> <span class="o">=</span> <span class="n">pci_device</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		<span class="s">&quot;comedi%d: no supported board found! (req. bus/slot : %d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">found:</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: found %s (b:s:f=%d:%d:%d) , irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
	       <span class="n">pci9111_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
	       <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
	       <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/*  TODO: Warn about non-tested boards. */</span>

	<span class="cm">/*  Read local configuration register base address</span>
<span class="cm">	 *  [PCI_BASE_ADDRESS #1]. */</span>

	<span class="n">lcr_io_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lcr_io_range</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci_device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">printk</span>
	    <span class="p">(</span><span class="s">&quot;comedi%d: local configuration registers at address 0x%4lx [0x%4lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">lcr_io_base</span><span class="p">,</span> <span class="n">lcr_io_range</span><span class="p">);</span>

	<span class="cm">/*  Enable PCI device and request regions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comedi_pci_enable</span><span class="p">(</span><span class="n">pci_device</span><span class="p">,</span> <span class="n">PCI9111_DRIVER_NAME</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;comedi%d: Failed to enable PCI device and request regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  Read PCI6308 register base address [PCI_BASE_ADDRESS #2]. */</span>

	<span class="n">io_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_device</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">io_range</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci_device</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: 6503 registers at address 0x%4lx [0x%4lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">io_base</span><span class="p">,</span> <span class="n">io_range</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">io_base</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">io_range</span> <span class="o">=</span> <span class="n">io_range</span><span class="p">;</span>
	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">is_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">lcr_io_base</span> <span class="o">=</span> <span class="n">lcr_io_base</span><span class="p">;</span>
	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">lcr_io_range</span> <span class="o">=</span> <span class="n">lcr_io_range</span><span class="p">;</span>

	<span class="n">pci9111_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*  Irq setup */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pci9111_interrupt</span><span class="p">,</span>
				<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">PCI9111_DRIVER_NAME</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;comedi%d: unable to allocate irq  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci_device</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/*  TODO: Add external multiplexer setup (according to option[2]). */</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">subdevice</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">subdevice</span><span class="p">;</span>

	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_COMMON</span> <span class="o">|</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>

	<span class="cm">/*  TODO: Add external multiplexer data */</span>
	<span class="cm">/*     if (devpriv-&gt;usemux) { subdevice-&gt;n_chan = devpriv-&gt;usemux; } */</span>
	<span class="cm">/*     else { subdevice-&gt;n_chan = this_board-&gt;n_aichan; } */</span>

	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_channel_nbr</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_resolution_mask</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_channel_nbr</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ai_range_list</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">pci9111_ai_cancel</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pci9111_ai_insn_read</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">pci9111_ai_do_cmd_test</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">pci9111_ai_do_cmd</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">munge</span> <span class="o">=</span> <span class="n">pci9111_ai_munge</span><span class="p">;</span>

	<span class="n">subdevice</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_COMMON</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ao_channel_nbr</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ao_resolution_mask</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ao_channel_nbr</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">ao_range_list</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">pci9111_ao_insn_write</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pci9111_ao_insn_read</span><span class="p">;</span>

	<span class="n">subdevice</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DI</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">PCI9111_DI_CHANNEL_NBR</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">pci9111_di_insn_bits</span><span class="p">;</span>

	<span class="n">subdevice</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DO</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">PCI9111_DO_CHANNEL_NBR</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
	<span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">pci9111_do_insn_bits</span><span class="p">;</span>

	<span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">is_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9111_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">is_valid</span><span class="p">)</span>
			<span class="n">pci9111_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_private</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">pci_device</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
			<span class="n">comedi_pci_disable</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">pci_device</span><span class="p">);</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev_private</span><span class="o">-&gt;</span><span class="n">pci_device</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">adl_pci9111_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;adl_pci9111&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">pci9111_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">pci9111_detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pci9111_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adl_pci9111_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">pci9111_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci9111_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ADLINK</span><span class="p">,</span> <span class="n">PCI9111_HR_DEVICE_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* { PCI_DEVICE(PCI_VENDOR_ID_ADLINK, PCI9111_HG_DEVICE_ID) }, */</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci9111_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">adl_pci9111_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;adl_pci9111&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pci9111_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pci9111_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pci9111_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_pci_driver</span><span class="p">(</span><span class="n">adl_pci9111_driver</span><span class="p">,</span> <span class="n">adl_pci9111_pci_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
