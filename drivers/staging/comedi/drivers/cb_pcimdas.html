<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › cb_pcimdas.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cb_pcimdas.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/drivers/cb_pcimdas.c</span>
<span class="cm">    Comedi driver for Computer Boards PCIM-DAS1602/16</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 2000 David A. Schleef &lt;ds@schleef.org&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">Driver: cb_pcimdas</span>
<span class="cm">Description: Measurement Computing PCI Migration series boards</span>
<span class="cm">Devices: [ComputerBoards] PCIM-DAS1602/16 (cb_pcimdas)</span>
<span class="cm">Author: Richard Bytheway</span>
<span class="cm">Updated: Wed, 13 Nov 2002 12:34:56 +0000</span>
<span class="cm">Status: experimental</span>

<span class="cm">Written to support the PCIM-DAS1602/16 on a 2.4 series kernel.</span>

<span class="cm">Configuration Options:</span>
<span class="cm">    [0] - PCI bus number</span>
<span class="cm">    [1] - PCI slot number</span>

<span class="cm">Developed from cb_pcidas and skel by Richard Bytheway (mocelet@sucs.org).</span>
<span class="cm">Only supports DIO, AO and simple AI in it&#39;s present form.</span>
<span class="cm">No interrupts, multi channel or FIFO AI, although the card looks like it could support this.</span>
<span class="cm">See http://www.mccdaq.com/PDFs/Manuals/pcim-das1602-16.pdf for more details.</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;comedi_pci.h&quot;</span>
<span class="cp">#include &quot;plx9052.h&quot;</span>
<span class="cp">#include &quot;8255.h&quot;</span>

<span class="cm">/* #define CBPCIMDAS_DEBUG */</span>
<span class="cp">#undef CBPCIMDAS_DEBUG</span>

<span class="cp">#define PCI_VENDOR_ID_COMPUTERBOARDS	0x1307</span>

<span class="cm">/* Registers for the PCIM-DAS1602/16 */</span>

<span class="cm">/* sizes of io regions (bytes) */</span>
<span class="cp">#define BADR0_SIZE 2		</span><span class="cm">/* ?? */</span><span class="cp"></span>
<span class="cp">#define BADR1_SIZE 4</span>
<span class="cp">#define BADR2_SIZE 6</span>
<span class="cp">#define BADR3_SIZE 16</span>
<span class="cp">#define BADR4_SIZE 4</span>

<span class="cm">/* DAC Offsets */</span>
<span class="cp">#define ADC_TRIG 0</span>
<span class="cp">#define DAC0_OFFSET 2</span>
<span class="cp">#define DAC1_OFFSET 4</span>

<span class="cm">/* AI and Counter Constants */</span>
<span class="cp">#define MUX_LIMITS 0</span>
<span class="cp">#define MAIN_CONN_DIO 1</span>
<span class="cp">#define ADC_STAT 2</span>
<span class="cp">#define ADC_CONV_STAT 3</span>
<span class="cp">#define ADC_INT 4</span>
<span class="cp">#define ADC_PACER 5</span>
<span class="cp">#define BURST_MODE 6</span>
<span class="cp">#define PROG_GAIN 7</span>
<span class="cp">#define CLK8254_1_DATA 8</span>
<span class="cp">#define CLK8254_2_DATA 9</span>
<span class="cp">#define CLK8254_3_DATA 10</span>
<span class="cp">#define CLK8254_CONTROL 11</span>
<span class="cp">#define USER_COUNTER 12</span>
<span class="cp">#define RESID_COUNT_H 13</span>
<span class="cp">#define RESID_COUNT_L 14</span>

<span class="cm">/* Board description */</span>
<span class="k">struct</span> <span class="n">cb_pcimdas_board</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ai_se_chans</span><span class="p">;</span>	<span class="cm">/*  Inputs in single-ended mode */</span>
	<span class="kt">int</span> <span class="n">ai_diff_chans</span><span class="p">;</span>	<span class="cm">/*  Inputs in differential mode */</span>
	<span class="kt">int</span> <span class="n">ai_bits</span><span class="p">;</span>		<span class="cm">/*  analog input resolution */</span>
	<span class="kt">int</span> <span class="n">ai_speed</span><span class="p">;</span>		<span class="cm">/*  fastest conversion period in ns */</span>
	<span class="kt">int</span> <span class="n">ao_nchan</span><span class="p">;</span>		<span class="cm">/*  number of analog out channels */</span>
	<span class="kt">int</span> <span class="n">ao_bits</span><span class="p">;</span>		<span class="cm">/*  analogue output resolution */</span>
	<span class="kt">int</span> <span class="n">has_ao_fifo</span><span class="p">;</span>	<span class="cm">/*  analog output has fifo */</span>
	<span class="kt">int</span> <span class="n">ao_scan_speed</span><span class="p">;</span>	<span class="cm">/*  analog output speed for 1602 series (for a scan, not conversion) */</span>
	<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">;</span>		<span class="cm">/*  number of samples fifo can hold */</span>
	<span class="kt">int</span> <span class="n">dio_bits</span><span class="p">;</span>		<span class="cm">/*  number of dio bits */</span>
	<span class="kt">int</span> <span class="n">has_dio</span><span class="p">;</span>		<span class="cm">/*  has DIO */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">ranges</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cb_pcimdas_board</span> <span class="n">cb_pcimdas_boards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PCIM-DAS1602/16&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x56</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_se_chans</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_diff_chans</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>	<span class="cm">/* ?? */</span>
	 <span class="p">.</span><span class="n">ao_nchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_ao_fifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* ?? */</span>
	 <span class="p">.</span><span class="n">ao_scan_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	 <span class="cm">/* ?? */</span>
	 <span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">dio_bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">has_dio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cm">/*	.ranges = &amp;cb_pcimdas_ranges, */</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define N_BOARDS 1		</span><span class="cm">/*  Max number of boards supported */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Useful for shorthand access to the particular board structure</span>
<span class="cm"> */</span>
<span class="cp">#define thisboard ((const struct cb_pcimdas_board *)dev-&gt;board_ptr)</span>

<span class="cm">/*</span>
<span class="cm"> * this structure is for data unique to this hardware driver.  If</span>
<span class="cm"> * several hardware drivers keep similar information in this structure,</span>
<span class="cm"> * feel free to suggest moving the variable to the struct comedi_device</span>
<span class="cm"> * struct.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cb_pcimdas_private</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/*  would be useful for a PCI device */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="cm">/* base addresses */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BADR0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BADR1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BADR2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BADR3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BADR4</span><span class="p">;</span>

	<span class="cm">/* Used for AO readback */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_readback</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/*  Used for DIO */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">port_a</span><span class="p">;</span>	<span class="cm">/*  copy of BADR4+0 */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">port_b</span><span class="p">;</span>	<span class="cm">/*  copy of BADR4+1 */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">port_c</span><span class="p">;</span>	<span class="cm">/*  copy of BADR4+2 */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">dio_mode</span><span class="p">;</span>	<span class="cm">/*  copy of BADR4+3 */</span>

<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * most drivers define the following macro to make it easy to</span>
<span class="cm"> * access the private structure.</span>
<span class="cm"> */</span>
<span class="cp">#define devpriv ((struct cb_pcimdas_private *)dev-&gt;private)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cb_pcimdas_ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cb_pcimdas_ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cb_pcimdas_ao_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Attach is called by the Comedi core to configure the driver</span>
<span class="cm"> * for a particular board.  If you specified a board_name array</span>
<span class="cm"> * in the driver structure, dev-&gt;board_ptr contains that</span>
<span class="cm"> * address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cb_pcimdas_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="cm">/* int i; */</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate the private structure area.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cb_pcimdas_private</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Probe the device to determine what device in the series it is.</span>
<span class="cm"> */</span>

	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">pcidev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  is it not a computer boards card? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*  loop through cards supported by this driver */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">N_BOARDS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cb_pcimdas_boards</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">device_id</span> <span class="o">!=</span>
			    <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*  was a particular bus/slot requested? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/*  are we on the wrong bus/slot? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">=</span> <span class="n">cb_pcimdas_boards</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;No supported ComputerBoards/MeasurementComputing card found on requested position</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">found:</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;Found %s on bus %i, slot %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cb_pcimdas_boards</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>

	<span class="cm">/*  Warn about non-tested features */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x56</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;THIS CARD IS UNSUPPORTED.</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;PLEASE REPORT USAGE TO &lt;mocelet@sucs.org&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comedi_pci_enable</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;cb_pcimdas&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;Failed to enable PCI device and request regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR0</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR1</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR2</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR3</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR4</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;devpriv-&gt;BADR0 = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR0</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;devpriv-&gt;BADR1 = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR1</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;devpriv-&gt;BADR2 = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR2</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;devpriv-&gt;BADR3 = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR3</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;devpriv-&gt;BADR4 = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR4</span><span class="p">);</span>

<span class="cm">/* Dont support IRQ yet */</span>
<span class="cm">/*  get irq */</span>
<span class="cm">/* if(request_irq(devpriv-&gt;pci_dev-&gt;irq, cb_pcimdas_interrupt, IRQF_SHARED, &quot;cb_pcimdas&quot;, dev )) */</span>
<span class="cm">/* { */</span>
<span class="cm">/* printk(&quot; unable to allocate irq %u\n&quot;, devpriv-&gt;pci_dev-&gt;irq); */</span>
<span class="cm">/* return -EINVAL; */</span>
<span class="cm">/* } */</span>
<span class="cm">/* dev-&gt;irq = devpriv-&gt;pci_dev-&gt;irq; */</span>

	<span class="cm">/* Initialize dev-&gt;board_name */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate the subdevice structures.  alloc_subdevice() is a</span>
<span class="cm"> * convenient macro defined in comedidev.h.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* dev-&gt;read_subdev=s; */</span>
	<span class="cm">/*  analog input subdevice */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_se_chans</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/*  This is the maximum chanlist length that */</span>
	<span class="cm">/*  the board can handle */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">cb_pcimdas_ai_rinsn</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*  analog output subdevice */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_nchan</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_bits</span><span class="p">;</span>
	<span class="cm">/* ranges are hardware settable, but not software readable. */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cb_pcimdas_ao_winsn</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cb_pcimdas_ao_rinsn</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* digital i/o subdevice */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">has_dio</span><span class="p">)</span>
		<span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cb_pcimdas_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR0</span><span class="p">)</span>
				<span class="n">comedi_pci_disable</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * &quot;instructions&quot; read/write data in &quot;one-shot&quot; or &quot;software-triggered&quot;</span>
<span class="cm"> * mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cb_pcimdas_ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">busy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">chanlims</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxchans</span><span class="p">;</span>

	<span class="cm">/*  only support sw initiated reads from a single channel */</span>

	<span class="cm">/* check channel number */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* differential mode */</span>
		<span class="n">maxchans</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_diff_chans</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">maxchans</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_se_chans</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">maxchans</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>	<span class="cm">/* *** Wrong error code. Fixme. */</span>

	<span class="cm">/* configure for sw initiated read */</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR3</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* only reset if needed. */</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0xfd</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR3</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR3</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* set bursting off, conversions on */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR3</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* set range to 10V. UP/BP is controlled by a switch on the board */</span>

	<span class="cm">/*</span>
<span class="cm">	 * write channel limits to multiplexer, set Low (bits 0-3) and</span>
<span class="cm">	 * High (bits 4-7) channels to chan.</span>
<span class="cm">	 */</span>
	<span class="n">chanlims</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">|</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">chanlims</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR3</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* convert n samples */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* trigger conversion */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR2</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#define TIMEOUT 1000		</span><span class="cm">/* typically takes 5 loops on a lightly loaded Pentium 100MHz, */</span><span class="cp"></span>
		<span class="cm">/* this is likely to be 100 loops on a 2GHz machine, so set 1000 as the limit. */</span>

		<span class="cm">/* wait for conversion to end */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">busy</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">busy</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* read data */</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR2</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* mangle the data as necessary */</span>
		<span class="cm">/* d ^= 1&lt;&lt;(thisboard-&gt;ai_bits-1); // 16 bit data from ADC, so no mangle needed. */</span>

		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return the number of samples read/written */</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cb_pcimdas_ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* Writing a list of values to an AO channel is probably not</span>
<span class="cm">	 * very useful, but that&#39;s how the interface is defined. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR2</span> <span class="o">+</span> <span class="n">DAC0_OFFSET</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">BADR2</span> <span class="o">+</span> <span class="n">DAC1_OFFSET</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* return the number of samples read/written */</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* AO subdevices should have a read insn as well as a write insn.</span>
<span class="cm"> * Usually this means copying a value stored in devpriv. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cb_pcimdas_ao_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">cb_pcimdas_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;cb_pcimdas&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">cb_pcimdas_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">cb_pcimdas_detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cb_pcimdas_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb_pcimdas_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">cb_pcimdas_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">cb_pcimdas_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">cb_pcimdas_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cb_pcimdas_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cb_pcimdas&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">cb_pcimdas_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">cb_pcimdas_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cb_pcimdas_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_pci_driver</span><span class="p">(</span><span class="n">cb_pcimdas_driver</span><span class="p">,</span> <span class="n">cb_pcimdas_pci_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
